<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>MAD Catalog Selector</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <style>
    body { font-family: Arial, sans-serif; background:#f6f7f9; }
    .card { transition: .15s transform; }
    .card:hover { transform: scale(1.02); }
    .chip { white-space: nowrap; }
  </style>
</head>

<body class="p-4 bg-gray-100">
  <div class="max-w-7xl mx-auto">

    <!-- Header -->
    <div class="flex items-center justify-between mb-4">
      <h1 class="text-2xl font-bold">MAD Catalog Selector</h1>
      <button class="bg-black text-white px-4 py-2 rounded-lg" onclick="toggleLang()">Ø¹Ø±Ø¨ÙŠ / ×¢×‘×¨×™×ª</button>
    </div>

    <!-- Load box -->
    <div class="bg-white rounded-xl shadow p-4 mb-4">
      <div class="grid grid-cols-1 md:grid-cols-3 gap-3 items-end">
        <div>
          <label class="block text-sm font-semibold mb-1">RSS filename (same folder)</label>
          <input id="rssPath" class="w-full border rounded-lg p-2" value="products.rss" />
          <p class="text-xs text-gray-500 mt-1">Ù„Ø§Ø²Ù… ÙŠÙƒÙˆÙ† Ø§Ù„Ù…Ù„Ù Ø¨Ù†ÙØ³ Ù…Ø¬Ù„Ø¯ Ø§Ù„Ù€ HTML</p>
        </div>

        <div>
          <label class="block text-sm font-semibold mb-1">WhatsApp Sender Number</label>
          <input id="waNumber" class="w-full border rounded-lg p-2" value="972524033442" />
          <p class="text-xs text-gray-500 mt-1">Ø¨Ø¯ÙˆÙ† + (Ù…Ø«Ø§Ù„: 9725xxxxxxx)</p>
        </div>

        <div class="flex gap-2">
          <button class="w-full bg-blue-600 text-white py-2 rounded-lg" onclick="loadRSS()">Load RSS</button>
          <button class="w-full bg-gray-200 py-2 rounded-lg" onclick="clearSelection()">Clear</button>
        </div>
      </div>

      <!-- Status -->
      <div class="mt-3 text-sm">
        <span class="font-semibold">Status:</span>
        <span id="status" class="text-gray-600">Waiting...</span>
      </div>
    </div>

    <!-- Controls -->
    <div class="bg-white rounded-xl shadow p-4 mb-4">
      <div class="flex flex-col md:flex-row gap-3 md:items-center md:justify-between">
        <div class="w-full md:w-96">
          <label class="block text-sm font-semibold mb-1">Ø¨Ø­Ø«</label>
          <input id="search" class="w-full border rounded-lg p-2" placeholder="Ø§Ø¨Ø­Ø« Ø¨Ø§Ù„Ø§Ø³Ù… / Ø§Ù„ÙƒÙˆØ¯..." oninput="applyFilters()">
        </div>

        <div class="text-sm text-gray-600">
          <span class="font-semibold">Products:</span> <span id="countAll">0</span>
          <span class="mx-2">|</span>
          <span class="font-semibold">Selected:</span> <span id="countSel">0</span>
        </div>

        <div class="flex gap-2">
          <button class="bg-green-600 text-white px-4 py-2 rounded-lg" onclick="sendSelected()">Ø¥Ø±Ø³Ø§Ù„ Ø§Ù„Ù…Ù†ØªØ¬Ø§Øª</button>
          <button class="bg-black text-white px-4 py-2 rounded-lg" onclick="sendCategory()">Ø¥Ø±Ø³Ø§Ù„ Ø§Ù„ÙƒØ§ØªÙŠØ¬ÙˆØ±ÙŠ</button>
        </div>
      </div>
    </div>

    <!-- Categories -->
    <div id="categories" class="flex flex-wrap gap-2 mb-3"></div>

    <!-- Products -->
    <div id="products" class="grid grid-cols-2 md:grid-cols-4 lg:grid-cols-5 gap-4"></div>

  </div>

<script>
  // ===== State =====
  let PRODUCTS = [];
  let FILTERED = [];
  let SELECTED = new Set();
  let CURRENT_CATEGORY = "ALL";
  let LANG = "ar";

  const statusEl = () => document.getElementById("status");

  // ===== Namespace-safe reader (works with g:xxx even if prefix changes) =====
  function getTextByLocalName(parent, localName){
    const nodes = parent.getElementsByTagName("*");
    const target = localName.toLowerCase();
    for (let i = 0; i < nodes.length; i++){
      const ln = (nodes[i].localName || "").toLowerCase();
      if (ln === target) return (nodes[i].textContent || "").trim();
    }
    return "";
  }

  // ===== Robust RSS load =====
  async function loadRSS(){
    const path = (document.getElementById("rssPath").value || "products.rss").trim();
    statusEl().textContent = "Loading RSS...";

    try {
      const res = await fetch(path, { cache: "no-store" });

      // show content-type for debugging
      const ct = res.headers.get("content-type") || "unknown";
      if(!res.ok) throw new Error("HTTP " + res.status);

      const text = await res.text();

      // Parse as XML explicitly (more reliable)
      const parser = new DOMParser();
      const xml = parser.parseFromString(text, "application/xml");

      // detect parse errors
      const parseError = xml.getElementsByTagName("parsererror");
      if(parseError && parseError.length){
        console.error(parseError[0].textContent);
        statusEl().textContent = `Parse error (Content-Type: ${ct})`;
        alert("RSS ÙˆØµÙ„ØŒ Ù„ÙƒÙ† ÙÙŠ Ù…Ø´ÙƒÙ„Ø© Parsing XML.\n\nØ§ÙØªØ­ Console Ù„Ù…Ø²ÙŠØ¯ Ù…Ù† Ø§Ù„ØªÙØ§ØµÙŠÙ„.");
        return;
      }

      const items = Array.from(xml.getElementsByTagName("item"));
      if(items.length === 0){
        statusEl().textContent = `Loaded but no <item> found (Content-Type: ${ct})`;
        alert("ØªÙ… ØªØ­Ù…ÙŠÙ„ RSS Ù„ÙƒÙ† Ù…Ø§ Ù„Ù‚ÙŠÙ†Ø§ <item>.\n\n1) ØªØ£ÙƒØ¯ Ø¥Ù† Ø§Ù„Ù…Ù„Ù RSS ÙØ¹Ù„Ø§Ù‹ ÙÙŠÙ‡ Ù…Ù†ØªØ¬Ø§Øª.\n2) Ø£Ùˆ Ø£Ù†Ù‡ Ù„ÙŠØ³ HTML.\n\n(ØªÙ… ØªØ³Ø¬ÙŠÙ„ Ø§Ù„ØªÙØ§ØµÙŠÙ„ ÙÙŠ Console)");
        console.log("RSS raw text (first 800 chars):", text.slice(0,800));
        return;
      }

      PRODUCTS = items.map(item => ({
        id: getTextByLocalName(item, "id"),
        title: getTextByLocalName(item, "title"),
        image: getTextByLocalName(item, "image_link"),
        link: getTextByLocalName(item, "link"),
        category: getTextByLocalName(item, "product_type") || "Uncategorized"
      })).filter(p => p.id && p.title);

      SELECTED = new Set();
      CURRENT_CATEGORY = "ALL";

      document.getElementById("countAll").textContent = PRODUCTS.length;
      document.getElementById("countSel").textContent = "0";

      statusEl().textContent = `OK âœ… Loaded ${PRODUCTS.length} products (Content-Type: ${ct})`;

      renderCategories();
      applyFilters();

    } catch (e) {
      console.error(e);
      statusEl().textContent = "Failed to fetch RSS âŒ";
      alert("Ù…Ø´ Ù‚Ø§Ø¯Ø± ÙŠÙ‚Ø±Ø£ RSS.\n\nØªØ£ÙƒØ¯ Ø¥Ù† products.rss Ø¨Ù†ÙØ³ Ø§Ù„Ù…Ø¬Ù„Ø¯.\nÙˆØªØ£ÙƒØ¯ Ø¥Ù† Ø§Ù„Ø±Ø§Ø¨Ø· ÙŠÙØªØ­:\n" + location.origin + "/" + (document.getElementById("rssPath").value||"products.rss") + "\n\nError: " + e.message);
    }
  }

  // ===== Category translation =====
  function translateCategory(cat){
    if(LANG === "ar"){
      if(cat.includes("×’×‘×¨×™×")) return "Ø¹Ø·ÙˆØ± Ø±Ø¬Ø§Ù„";
      if(cat.includes("× ×©×™×")) return "Ø¹Ø·ÙˆØ± Ù†Ø³Ø§Ø¡";
      if(cat.includes("××‘×¦×¢×™×")) return "Ø¹Ø±ÙˆØ¶";
      if(cat.includes("× ×™×©×”") || cat.includes("× ×™×©")) return "Ù†ÙŠØ´";
      if(cat.includes("×¡×œ×§×˜×™×‘")) return "Ø³ÙŠÙ„ÙŠÙƒØªÙ";
      return cat;
    }
    return cat; // Hebrew: keep original
  }

  // ===== Categories render =====
  function renderCategories(){
    const container = document.getElementById("categories");
    container.innerHTML = "";

    const cats = Array.from(new Set(PRODUCTS.map(p => p.category))).sort((a,b)=>a.localeCompare(b));

    container.appendChild(makeCatBtn("ALL", LANG==="ar" ? "ÙƒÙ„ Ø§Ù„Ù…Ù†ØªØ¬Ø§Øª" : "×›×œ ×”××•×¦×¨×™×"));
    cats.forEach(cat => container.appendChild(makeCatBtn(cat, translateCategory(cat))));

    highlightCategory();
  }

  function makeCatBtn(cat, label){
    const b = document.createElement("button");
    b.className = "chip px-4 py-2 rounded-full bg-gray-200";
    b.textContent = label;
    b.dataset.cat = cat;
    b.onclick = () => { CURRENT_CATEGORY = cat; applyFilters(); highlightCategory(); };
    return b;
  }

  function highlightCategory(){
    document.querySelectorAll("#categories button").forEach(b => {
      const active = b.dataset.cat === CURRENT_CATEGORY;
      b.className = "chip px-4 py-2 rounded-full " + (active ? "bg-black text-white" : "bg-gray-200");
    });
  }

  // ===== Filtering =====
  function applyFilters(){
    const q = (document.getElementById("search").value || "").trim().toLowerCase();

    FILTERED = PRODUCTS.filter(p => {
      const catOk = CURRENT_CATEGORY === "ALL" ? true : (p.category === CURRENT_CATEGORY);
      const qOk = !q ? true : (p.title.toLowerCase().includes(q) || p.id.toLowerCase().includes(q));
      return catOk && qOk;
    });

    renderProducts(FILTERED);
  }

  // ===== Products render =====
  function renderProducts(list){
    const container = document.getElementById("products");
    container.innerHTML = "";

    list.forEach(p => {
      const selected = SELECTED.has(p.id);

      const card = document.createElement("div");
      card.className = "card bg-white rounded-xl shadow p-2 cursor-pointer border";
      card.innerHTML = `
        <div class="relative">
          <img src="${escapeHtml(p.image)}" class="w-full h-36 object-contain bg-gray-50 rounded-lg" />
          <div class="absolute top-2 left-2 px-2 py-1 text-xs rounded bg-white/90 border">${escapeHtml(p.id)}</div>
          ${selected ? `<div class="absolute top-2 right-2 px-2 py-1 text-xs rounded bg-green-600 text-white">âœ“</div>` : ""}
        </div>
        <div class="mt-2 text-center font-semibold text-sm">${escapeHtml(p.title)}</div>
        <div class="mt-1 text-center text-xs text-gray-500">${escapeHtml(translateCategory(p.category))}</div>
      `;

      card.onclick = () => {
        if(SELECTED.has(p.id)) SELECTED.delete(p.id);
        else SELECTED.add(p.id);

        document.getElementById("countSel").textContent = SELECTED.size;
        renderProducts(FILTERED);
      };

      container.appendChild(card);
    });
  }

  function clearSelection(){
    SELECTED = new Set();
    document.getElementById("countSel").textContent = "0";
    renderProducts(FILTERED);
  }

  // ===== WhatsApp send =====
  function sendSelected(){
    if(SELECTED.size === 0) return alert(LANG==="ar" ? "Ø§Ø®ØªØ± Ù…Ù†ØªØ¬Ø§Øª Ø£ÙˆÙ„Ø§Ù‹" : "×‘×—×¨ ××•×¦×¨×™× ×§×•×“×");

    const chosen = PRODUCTS.filter(p => SELECTED.has(p.id));
    let msg = (LANG==="ar" ? "ğŸ› Ø§Ù„Ù…Ù†ØªØ¬Ø§Øª Ø§Ù„Ù…Ø®ØªØ§Ø±Ø©:\n\n" : "ğŸ› ×”××•×¦×¨×™× ×©× ×‘×—×¨×•:\n\n");

    chosen.forEach(p => {
      msg += `${p.title}\n${p.link}\n\n`;
    });

    openWhatsApp(msg);
  }

  function sendCategory(){
    if(CURRENT_CATEGORY === "ALL") return alert(LANG==="ar" ? "Ø§Ø®ØªØ± ÙƒØ§ØªÙŠØ¬ÙˆØ±ÙŠ Ø£ÙˆÙ„Ø§Ù‹" : "×‘×—×¨ ×§×˜×’×•×¨×™×” ×§×•×“×");

    const chosen = PRODUCTS.filter(p => p.category === CURRENT_CATEGORY);
    const catName = translateCategory(CURRENT_CATEGORY);

    let msg = (LANG==="ar")
      ? `ğŸ§¾ ÙƒØ§ØªÙŠØ¬ÙˆØ±ÙŠ: ${catName}\n\n`
      : `ğŸ§¾ ×§×˜×’×•×¨×™×”: ${catName}\n\n`;

    chosen.forEach(p => {
      msg += `${p.title}\n${p.link}\n\n`;
    });

    openWhatsApp(msg);
  }

  function openWhatsApp(text){
    const number = (document.getElementById("waNumber").value || "").trim().replace(/\D/g,"");
    if(!number) return alert("Ø­Ø· Ø±Ù‚Ù… ÙˆØ§ØªØ³Ø§Ø¨ ØµØ­ÙŠØ­ (Ø¨Ø¯ÙˆÙ† +)");

    const url = `https://wa.me/${number}?text=${encodeURIComponent(text)}`;
    window.open(url, "_blank");
  }

  // ===== Language toggle =====
  function toggleLang(){
    LANG = (LANG === "ar") ? "he" : "ar";
    document.documentElement.lang = (LANG === "ar") ? "ar" : "he";
    document.documentElement.dir = (LANG === "ar") ? "rtl" : "ltr";
    renderCategories();
    applyFilters();
  }

  // ===== Utils =====
  function escapeHtml(s){
    return (s||"").replace(/[&<>"']/g, m => ({ "&":"&amp;","<":"&lt;",">":"&gt;",'"':"&quot;","'":"&#039;" }[m]));
  }

  // Optional: auto-load on open
  // window.addEventListener("load", loadRSS);
</script>
</body>
</html>
