<!doctype html>
<html lang="ar" dir="rtl">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>MAD | Ø§Ø®ØªÙŠØ§Ø± Ù…Ù†ØªØ¬Ø§Øª ÙˆØ¥Ø±Ø³Ø§Ù„ ÙˆØ§ØªØ³Ø§Ø¨</title>

  <!-- Tailwind -->
  <script src="https://cdn.tailwindcss.com"></script>

  <!-- Font -->
  <link href="https://fonts.googleapis.com/css2?family=Cairo:wght@400;700;900&display=swap" rel="stylesheet">

  <style>
    body { font-family: "Cairo", sans-serif; }
    .card:hover { transform: translateY(-2px); }
  </style>
</head>

<body class="bg-zinc-100 text-zinc-900">
  <div class="max-w-7xl mx-auto p-4 md:p-6">
    <!-- Header -->
    <div class="rounded-2xl bg-black text-white p-5 md:p-6 flex flex-col md:flex-row md:items-center md:justify-between gap-4">
      <div>
        <div class="text-sm text-zinc-300">MAD Parfumeur â€¢ Staff Catalog Helper</div>
        <h1 class="text-2xl md:text-3xl font-black">Ø§Ø®ØªÙŠØ§Ø± Ù…Ù†ØªØ¬Ø§Øª + Ø¥Ø±Ø³Ø§Ù„ Ø¹Ø¨Ø± ÙˆØ§ØªØ³Ø§Ø¨</h1>
        <p class="text-zinc-300 mt-1">Ø­Ø¯Ø¯ Ø§Ù„Ù…Ù†ØªØ¬Ø§Øª Ø§Ù„Ù„ÙŠ Ø¨Ø¯Ùƒ ØªØ¨Ø¹Ø«Ù‡Ø§ Ù„Ù„Ø²Ø¨ÙˆÙ†ØŒ ÙˆØ¨ÙƒØ¨Ø³Ø© Ø²Ø± Ø¨ØªØ·Ù„Ø¹ Ø±Ø³Ø§Ù„Ø© ÙˆØ§ØªØ³Ø§Ø¨ Ø¬Ø§Ù‡Ø²Ø©.</p>
      </div>

      <div class="flex gap-2 w-full md:w-auto">
        <input id="search" type="text" placeholder="Ø§Ø¨Ø­Ø« Ø¨Ø§Ù„Ø§Ø³Ù…..." class="w-full md:w-72 rounded-xl px-4 py-3 text-black" />
        <button id="refreshBtn" class="rounded-xl bg-white text-black px-4 py-3 font-bold">ØªØ­Ø¯ÙŠØ«</button>
      </div>
    </div>

    <!-- Status -->
    <div id="status" class="mt-4 text-sm text-zinc-600"></div>

    <!-- Filters -->
    <div class="mt-4 flex flex-wrap gap-2" id="filters"></div>

    <!-- Grid -->
    <div class="mt-4 grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 xl:grid-cols-4 gap-4" id="grid"></div>
  </div>

  <!-- Sticky Cart -->
  <div class="fixed bottom-4 left-4 right-4 max-w-7xl mx-auto">
    <div class="rounded-2xl bg-white shadow-lg border border-zinc-200 p-4 flex flex-col md:flex-row md:items-center md:justify-between gap-3">
      <div class="flex items-center justify-between md:justify-start gap-3">
        <div class="font-black">Ø§Ù„Ù…Ø­Ø¯Ø¯:</div>
        <div id="selectedCount" class="px-3 py-1 rounded-full bg-zinc-100 font-bold">0</div>
        <button id="clearBtn" class="text-sm font-bold text-red-600 hover:underline">ØªÙØ±ÙŠØº</button>
      </div>

      <div class="flex flex-col md:flex-row gap-2 w-full md:w-auto">
        <input id="customerName" type="text" placeholder="Ø§Ø³Ù… Ø§Ù„Ø²Ø¨ÙˆÙ† (Ø§Ø®ØªÙŠØ§Ø±ÙŠ)" class="w-full md:w-56 rounded-xl px-4 py-3 border border-zinc-200" />
        <input id="waPhone" type="text" placeholder="ÙˆØ§ØªØ³Ø§Ø¨ Ø§Ù„Ø²Ø¨ÙˆÙ† (Ù…Ø«Ø§Ù„: 9725xxxxxxx)" class="w-full md:w-64 rounded-xl px-4 py-3 border border-zinc-200" />
        <button id="sendBtn" class="rounded-xl bg-black text-white px-5 py-3 font-black w-full md:w-auto">
          Ø¥Ø±Ø³Ø§Ù„ ÙˆØ§ØªØ³Ø§Ø¨
        </button>
      </div>
    </div>
  </div>

<script>
/** =========================
 *  CONFIG
 *  ========================= */
const RSS_URL = "https://madperfume.co.il/?app=product.rss";

// ÙˆØ³ÙŠØ· Ù„ØªØ¬Ø§ÙˆØ² CORS (Ø¨Ø¯ÙˆÙ† Ø¨Ø§Ùƒ-Ø¥Ù†Ø¯)
const ALLORIGINS_RAW = (url) => `https://api.allorigins.win/raw?url=${encodeURIComponent(url)}`;

// Ø±Ù‚Ù… ÙˆØ§ØªØ³Ø§Ø¨ ÙØ±ÙŠÙ‚Ùƒ/Ø§Ù„Ø´Ø±ÙƒØ© Ù„Ùˆ Ø¨Ø¯Ùƒ Ø¥Ø±Ø³Ø§Ù„ Ø¯Ø§Ø®Ù„ÙŠ (Ø§Ø®ØªÙŠØ§Ø±ÙŠ)
// Ø¥Ø°Ø§ Ø¨Ø¯Ùƒ ÙØªØ­ ÙˆØ§ØªØ³Ø§Ø¨ Ù„Ù„Ø²Ø¨ÙˆÙ† Ù†ÙØ³Ù‡ (Ø§Ù„Ø±Ù‚Ù… Ø§Ù„Ù„ÙŠ Ø¨ØªØ¯Ø®Ù„Ù‡ ØªØ­Øª)ØŒ Ø®Ù„Ù‘ÙŠ Ù‡Ø°Ø§ ÙØ§Ø¶ÙŠ.
const WHATSAPP_PHONE_FALLBACK = ""; // Ù…Ø«Ø§Ù„: "972524033442"

/** =========================
 *  STATE
 *  ========================= */
let products = [];
let categories = new Set(["Ø§Ù„ÙƒÙ„"]);
let activeCategory = "Ø§Ù„ÙƒÙ„";
let searchTerm = "";
let selected = new Map(); // key: link, value: product

const elGrid = document.getElementById("grid");
const elFilters = document.getElementById("filters");
const elStatus = document.getElementById("status");
const elSearch = document.getElementById("search");
const elRefreshBtn = document.getElementById("refreshBtn");
const elSelectedCount = document.getElementById("selectedCount");
const elClearBtn = document.getElementById("clearBtn");
const elSendBtn = document.getElementById("sendBtn");
const elCustomerName = document.getElementById("customerName");
const elWaPhone = document.getElementById("waPhone");

/** =========================
 *  HELPERS
 *  ========================= */
function setStatus(msg, isError=false) {
  elStatus.innerHTML = `<span class="${isError ? 'text-red-600 font-bold' : ''}">${msg}</span>`;
}

function normalizeText(s) {
  return (s || "").toString().toLowerCase().trim();
}

function parseRSS(xmlText) {
  const parser = new DOMParser();
  const xml = parser.parseFromString(xmlText, "text/xml");

  // Try both RSS <item> and Atom <entry>
  const items = [...xml.querySelectorAll("item")];
  const entries = items.length ? items : [...xml.querySelectorAll("entry")];

  const out = entries.map((node) => {
    // Title
    const title =
      node.querySelector("title")?.textContent?.trim() ||
      node.querySelector("name")?.textContent?.trim() ||
      "Untitled";

    // Link (RSS/Atom variations)
    let link = node.querySelector("link")?.textContent?.trim() || "";
    if (!link) {
      const atomLink = node.querySelector('link[rel="alternate"]')?.getAttribute("href");
      if (atomLink) link = atomLink;
      const href = node.querySelector("link")?.getAttribute?.("href");
      if (href) link = href;
    }

    // Image: try enclosure/media:content/content:encoded
    let image = "";
    const enclosure = node.querySelector("enclosure");
    if (enclosure && enclosure.getAttribute("url")) image = enclosure.getAttribute("url");

    if (!image) {
      const media = node.querySelector("media\\:content, content");
      if (media && media.getAttribute("url")) image = media.getAttribute("url");
    }

    if (!image) {
      const encoded = node.querySelector("content\\:encoded, encoded, content")?.textContent || "";
      const match = encoded.match(/<img[^>]+src=["']([^"']+)["']/i);
      if (match && match[1]) image = match[1];
    }

    // Categories: RSS <category>
    const cats = [...node.querySelectorAll("category")].map(c => c.textContent.trim()).filter(Boolean);

    // Description
    const desc =
      node.querySelector("description")?.textContent?.trim() ||
      node.querySelector("summary")?.textContent?.trim() ||
      "";

    return { title, link, image, categories: cats, desc };
  }).filter(p => p.link); // keep only items with link

  return out;
}

function renderFilters() {
  const cats = Array.from(categories);
  elFilters.innerHTML = cats.map(cat => {
    const active = cat === activeCategory;
    return `
      <button data-cat="${cat}"
        class="px-4 py-2 rounded-full border text-sm font-bold transition
        ${active ? 'bg-black text-white border-black' : 'bg-white text-black border-zinc-200 hover:bg-zinc-50'}">
        ${cat}
      </button>
    `;
  }).join("");

  elFilters.querySelectorAll("button").forEach(btn => {
    btn.addEventListener("click", () => {
      activeCategory = btn.getAttribute("data-cat");
      renderFilters();
      renderGrid();
    });
  });
}

function isInActiveCategory(p) {
  if (activeCategory === "Ø§Ù„ÙƒÙ„") return true;
  return (p.categories || []).some(c => normalizeText(c) === normalizeText(activeCategory));
}

function matchesSearch(p) {
  if (!searchTerm) return true;
  const hay = normalizeText(`${p.title} ${p.desc} ${(p.categories||[]).join(" ")}`);
  return hay.includes(searchTerm);
}

function renderGrid() {
  const list = products.filter(p => isInActiveCategory(p) && matchesSearch(p));
  if (!list.length) {
    elGrid.innerHTML = `
      <div class="col-span-full rounded-2xl bg-white border border-zinc-200 p-6">
        <div class="font-black text-lg">Ù„Ø§ ÙŠÙˆØ¬Ø¯ Ù†ØªØ§Ø¦Ø¬</div>
        <div class="text-zinc-600 mt-1">ØºÙŠÙ‘Ø± Ø§Ù„Ø¨Ø­Ø« Ø£Ùˆ Ø§Ø®ØªØ± ØªØµÙ†ÙŠÙ Ù…Ø®ØªÙ„Ù.</div>
      </div>
    `;
    return;
  }

  elGrid.innerHTML = list.map(p => {
    const checked = selected.has(p.link);
    return `
      <div class="card rounded-2xl bg-white border border-zinc-200 shadow-sm p-3 transition">
        <div class="rounded-xl overflow-hidden bg-zinc-100 aspect-[4/3] flex items-center justify-center">
          ${p.image
            ? `<img src="${p.image}" alt="${p.title}" class="w-full h-full object-cover" loading="lazy">`
            : `<div class="text-zinc-500 text-sm">No image</div>`
          }
        </div>

        <div class="mt-3">
          <div class="font-black leading-snug line-clamp-2">${p.title}</div>
          <div class="text-xs text-zinc-500 mt-1 line-clamp-2">${(p.categories||[]).slice(0,3).join(" â€¢ ")}</div>

          <div class="mt-3 flex gap-2">
            <a href="${p.link}" target="_blank"
               class="flex-1 text-center rounded-xl border border-zinc-200 px-3 py-2 text-sm font-bold hover:bg-zinc-50">
              ÙØªØ­ Ø§Ù„Ù…Ù†ØªØ¬
            </a>
            <button data-link="${p.link}" class="toggleBtn flex-1 rounded-xl px-3 py-2 text-sm font-black
              ${checked ? 'bg-black text-white' : 'bg-zinc-100 text-black hover:bg-zinc-200'}">
              ${checked ? 'Ù…ÙØ­Ø¯Ø¯ âœ“' : 'ØªØ­Ø¯ÙŠØ¯'}
            </button>
          </div>
        </div>
      </div>
    `;
  }).join("");

  elGrid.querySelectorAll(".toggleBtn").forEach(btn => {
    btn.addEventListener("click", () => {
      const link = btn.getAttribute("data-link");
      const p = products.find(x => x.link === link);
      if (!p) return;

      if (selected.has(link)) selected.delete(link);
      else selected.set(link, p);

      updateSelectedUI();
      renderGrid();
    });
  });
}

function updateSelectedUI() {
  elSelectedCount.textContent = selected.size.toString();
}

function buildWhatsAppText() {
  const name = (elCustomerName.value || "").trim();
  const chosen = Array.from(selected.values());

  let msg = "";
  if (name) msg += `Ù…Ø±Ø­Ø¨Ø§Ù‹ ${name} ğŸ‘‹\n`;
  msg += `Ù‡Ø°Ù‡ Ø§Ù„Ù…Ù†ØªØ¬Ø§Øª Ø§Ù„Ù…Ù‚ØªØ±Ø­Ø© Ù…Ù† MAD:\n\n`;

  chosen.forEach((p, i) => {
    msg += `${i+1}) ${p.title}\n${p.link}\n\n`;
  });

  msg += `Ø¥Ø°Ø§ Ø­Ø§Ø¨Ø¨ØŒ Ø§Ø­ÙƒÙŠÙ„ÙŠ ÙƒÙ… Ù‚Ø·Ø¹Ø© Ø¨Ø¯Ùƒ + Ø¹Ù†ÙˆØ§Ù†Ùƒ Ù„Ù„ØªÙˆØµÙŠÙ„ âœ…`;
  return msg;
}

function openWhatsApp() {
  const chosen = Array.from(selected.values());
  if (!chosen.length) {
    alert("Ø­Ø¯Ø¯ Ù…Ù†ØªØ¬Ø§Øª Ø£ÙˆÙ„Ø§Ù‹.");
    return;
  }

  const customerPhone = (elWaPhone.value || "").trim().replace(/[^\d]/g, "");
  const phone = customerPhone || WHATSAPP_PHONE_FALLBACK;

  // Ù„Ùˆ Ø¨Ø¯Ùƒ â€œÙ…Ø´Ø§Ø±ÙƒØ©â€ ÙÙ‚Ø· (Ø¨Ø¯ÙˆÙ† Ø±Ù‚Ù…)ØŒ Ù…Ù…ÙƒÙ† ØªØ³ØªØ®Ø¯Ù… wa.me/?text=...
  const text = encodeURIComponent(buildWhatsAppText());

  const url = phone
    ? `https://wa.me/${phone}?text=${text}`
    : `https://wa.me/?text=${text}`;

  window.open(url, "_blank");
}

async function loadRSS() {
  setStatus("Ø¬Ø§Ø±ÙŠ ØªØ­Ù…ÙŠÙ„ Ø§Ù„ÙƒØªØ§Ù„ÙˆØ¬...");
  products = [];
  categories = new Set(["Ø§Ù„ÙƒÙ„"]);
  activeCategory = "Ø§Ù„ÙƒÙ„";
  selected.clear();
  updateSelectedUI();
  elGrid.innerHTML = "";

  try {
    // fetch via CORS proxy
    const res = await fetch(ALLORIGINS_RAW(RSS_URL), { cache: "no-store" });
    if (!res.ok) throw new Error(`HTTP ${res.status}`);
    const xmlText = await res.text();

    const parsed = parseRSS(xmlText);
    products = parsed;

    // collect categories
    parsed.forEach(p => (p.categories||[]).forEach(c => categories.add(c)));

    renderFilters();
    renderGrid();

    setStatus(`ØªÙ… ØªØ­Ù…ÙŠÙ„ ${products.length} Ù…Ù†ØªØ¬ âœ…`);
    if (!products.length) {
      setStatus("Ø§Ù„Ù€ RSS Ø±Ø¬Ù‘Ø¹ 0 Ù…Ù†ØªØ¬Ø§Øª. Ø§ÙØªØ­ Console ÙˆØ´ÙˆÙ Ø´ÙƒÙ„ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª.", true);
      console.log("RSS RAW:", xmlText);
    }
  } catch (e) {
    console.error(e);
    setStatus(
      "ÙØ´Ù„ ØªØ­Ù…ÙŠÙ„ RSS Ø¨Ø³Ø¨Ø¨ CORS Ø£Ùˆ Ø´ÙƒÙ„ Ø§Ù„Ù€ RSS Ù…Ø®ØªÙ„Ù. Ø§ÙØªØ­ Console Ù„Ù„Ù…Ø²ÙŠØ¯. " +
      "Ø¥Ø°Ø§ Ø¨Ø¯ÙƒØŒ Ø¨Ù†Ø¹Ù…Ù„ Ø¨Ø¯ÙŠÙ„: JSON feed Ø£Ùˆ Ù…Ù„Ù products.json Ø¹Ù„Ù‰ GitHub.",
      true
    );
  }
}

/** =========================
 *  EVENTS
 *  ========================= */
elSearch.addEventListener("input", (e) => {
  searchTerm = normalizeText(e.target.value);
  renderGrid();
});
elRefreshBtn.addEventListener("click", loadRSS);
elClearBtn.addEventListener("click", () => {
  selected.clear();
  updateSelectedUI();
  renderGrid();
});
elSendBtn.addEventListener("click", openWhatsApp);

// Auto-load
loadRSS();
</script>
</body>
</html>
