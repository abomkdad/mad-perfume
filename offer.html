<!DOCTYPE html>
<html lang="he">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width,initial-scale=1.0">
<title>MAD PARFUMEUR | Official Branch Page</title>

<link href="https://fonts.googleapis.com/css2?family=Cinzel:wght@700&family=Assistant:wght@400;700&display=swap" rel="stylesheet">
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">

<script>
!function(f,b,e,v,n,t,s){if(f.fbq)return;n=f.fbq=function(){n.callMethod?
n.callMethod.apply(n,arguments):n.queue.push(arguments)};
if(!f._fbq)f._fbq=n;n.push=n;n.loaded=!0;n.version='2.0';
n.queue=[];t=b.createElement(e);t.async=!0;
t.src=v;s=b.getElementsByTagName(e)[0];
s.parentNode.insertBefore(t,s)}(window,document,'script',
'https://connect.facebook.net/en_US/fbevents.js');
fbq('init','1072283127290819'); fbq('track', 'PageView');
</script>

<style>
:root{ --gold:#D4AF37; --black:#000; --card:#111; --white:#fff; --wa:#25D366; --live-red:#ff0000; }
*{box-sizing:border-box; margin:0; padding:0}
body{background:#000; color:#fff; font-family:'Assistant', sans-serif; opacity:0; transition: opacity 0.5s;}

/* Header */
header{
    position: relative; text-align:center; padding: 50px 20px;
    background: linear-gradient(rgba(0,0,0,0.7), rgba(0,0,0,0.8)), url('header.jpg') center/cover;
    border-bottom: 2px solid var(--gold);
}
.logo-img { max-width: 180px; margin-bottom: 15px; filter: drop-shadow(0 0 10px rgba(0,0,0,0.5)); }
.branch-name{font-size:1.8rem; font-weight:700; text-shadow: 2px 2px 8px #000;}

/* Live Staff Section */
.duty-container { display: flex; flex-direction: column; align-items: center; margin: 25px 0; }
.staff-wrapper { position: relative; width: 90px; height: 90px; }
.staff-img { width: 100%; height: 100%; border-radius: 50%; border: 2px solid var(--gold); object-fit: cover; box-shadow: 0 0 20px rgba(212, 175, 55, 0.4); }
.live-indicator {
    position: absolute; bottom: 5px; right: 5px; background: var(--live-red); color: #fff;
    font-size: 10px; font-weight: 900; padding: 2px 8px; border-radius: 4px;
    display: flex; align-items: center; gap: 4px; border: 2px solid #000;
}
.pulse-dot { width: 6px; height: 6px; background: #fff; border-radius: 50%; animation: blink 1.2s infinite; }
@keyframes blink { 0% { opacity: 1; } 50% { opacity: 0.3; } 100% { opacity: 1; } }
.duty-btn { background: var(--wa); color: #fff; text-decoration: none; padding: 10px 22px; border-radius: 50px; font-weight: 700; display: flex; align-items: center; gap: 8px; transition: 0.3s; margin-top: 12px; }

/* Filter Tabs */
.cats-wrapper { position: sticky; top: 0; background: rgba(0,0,0,0.92); z-index: 100; border-bottom: 1px solid #222; backdrop-filter: blur(10px); }
.cats{display:flex; gap:10px; overflow-x:auto; padding:12px; scrollbar-width:none;}
.cats::-webkit-scrollbar{display:none}
.cats button{ background: #111; color: #ccc; border: 1px solid #333; padding: 10px 24px; border-radius: 50px; cursor: pointer; white-space: nowrap; transition: 0.3s; }
.cats button.active{background: var(--gold); color: #000; border-color: var(--gold); font-weight: 700;}

/* Grid */
.grid{display:grid; grid-template-columns:repeat(2,1fr); gap:12px; padding:15px}
@media(min-width:768px){.grid{grid-template-columns:repeat(4,1fr); gap:20px}}
.card{background:#111; border:1px solid #222; border-radius:10px; overflow:hidden;}
.img img{width:100%; aspect-ratio:1/1; object-fit:cover; opacity:0; transition:.5s}
.img img.loaded{opacity:1}
.info{padding:15px; text-align:center}
.price{color:var(--gold); font-weight:700; margin:10px 0; font-size: 1.2rem}
.wa-btn{background:var(--wa); color:#fff; text-decoration:none; padding:12px; font-weight:700; border-radius:8px; display:block;}

/* Popup Design */
#popup-sale { position: fixed; inset: 0; background: rgba(0,0,0,0.95); display: none; align-items: center; justify-content: center; z-index: 10000; padding: 20px; }
.sale-box { width: 100%; max-width: 400px; background: #000; border: 2px solid var(--gold); border-radius: 15px; overflow: hidden; position: relative; }
.close-sale { position: absolute; top: 10px; right: 15px; font-size: 2.5rem; color: #fff; cursor: pointer; z-index: 10; background: rgba(0,0,0,0.3); border-radius: 50%; width: 45px; height: 45px; display: flex; align-items: center; justify-content: center; }
.countdown-bar { background: var(--gold); color: #000; padding: 12px; text-align: center; font-weight: 900; font-size: 1.6rem; font-family: 'Cinzel', serif; }
.wa-order-btn { display: block; background: var(--wa); color: #fff; text-align: center; padding: 20px; text-decoration: none; font-weight: 900; font-size: 1.3rem; }

/* Floating Widget */
#reopen-sale {
    position: fixed; bottom: 20px; left: 20px; width: 60px; height: 60px;
    background: var(--gold); border-radius: 50%; display: none;
    align-items: center; justify-content: center; z-index: 999;
    cursor: pointer; box-shadow: 0 4px 15px rgba(212, 175, 55, 0.4);
    animation: bounce 2s infinite;
}
@keyframes bounce { 0%, 20%, 50%, 80%, 100% {transform: translateY(0);} 40% {transform: translateY(-10px);} 60% {transform: translateY(-5px);} }
.sale-badge { position: absolute; top: -5px; right: -5px; background: var(--live-red); color: white; font-size: 10px; padding: 2px 8px; border-radius: 10px; font-weight: bold; border: 1px solid #000; }
</style>
</head>

<body dir="rtl">

<header>
    <img src="logo.png" alt="MAD" class="logo-img">
    <div id="br-name" class="branch-name"></div>
    <div id="br-hours" style="font-size:0.9rem; margin:5px 0 15px; opacity:0.8;"></div>
    <div id="br-status"></div>
    <div class="duty-container">
        <div class="staff-wrapper">
            <img src="https://madperfume.ps/upload/01-2026/page/6966930e9af7f.png" class="staff-img">
            <div class="live-indicator"><div class="pulse-dot"></div> LIVE</div>
        </div>
        <a id="duty-link" class="duty-btn" target="_blank"><i class="fab fa-whatsapp"></i> <span id="duty-text"></span></a>
    </div>
    <div id="br-social" style="display:flex; justify-content:center; gap:18px; margin-top:15px"></div>
</header>

<div class="cats-wrapper"><nav id="cats" class="cats"></nav></div>
<main id="grid" class="grid"></main>

<div id="popup-sale">
    <div class="sale-box">
        <span class="close-sale" onclick="closeSale()">&times;</span>
        <img src="sale.png" style="width:100%; display:block" alt="Daily Sale">
        <div id="sale-timer" class="countdown-bar">00:00:00</div>
        <a id="sale-wa-link" class="wa-order-btn" target="_blank"></a>
    </div>
</div>

<div id="reopen-sale" onclick="openSale()">
    <i class="fas fa-gift" style="color:#000; font-size:1.5rem"></i>
    <span id="widget-text" class="sale-badge"></span>
</div>

<script>
/** Configuration **/
const params = new URLSearchParams(window.location.search);
const branchID = parseInt(params.get('branch')) || 1; 
const lang = navigator.language.startsWith('ar') ? 'ar' : 'he';

const TXT = {
    he: { open:'פתוח עכשיו', closed:'סגור כעת', all:'הכל', order:'הזמנה', msg:'היי, אני מעוניין ב: ', offer:'קבלת ההטבה', duty:'המנהל בתורנות', badge:'מבצע' },
    ar: { open:'مفتوح الآن', closed:'مغلق حالياً', all:'الكل', order:'طلب', msg:'مرحباً، أنا مهتم بـ: ', offer:'احصل على العرض', duty:'الموظف المناوب', badge:'عرض اليوم' }
};

let STATE = { branch: null, products: [] };
let timerInterval;

async function start() {
    try {
        const [bj, pc] = await Promise.all([
            fetch('branches.json').then(r => r.json()),
            fetch('products.csv').then(r => r.text())
        ]);
        STATE.branch = bj.branches.find(b => b.id === branchID) || bj.branches[0];
        parseCSV(pc);
        renderUI();
        initDailySale();
    } catch (e) { console.error(e); }
}

function lead(action, label) {
    if(window.fbq) fbq('track', 'Lead', { branch: branchID, action, label });
}

function parseCSV(text) {
    const lines = text.split('\n');
    for(let i=1; i<lines.length; i++){
        const c = lines[i].split(/,(?=(?:(?:[^"]*"){2})*[^"]*$)/);
        if(!c[1]) continue;
        STATE.products.push({ title: c[1].replace(/"/g,'').trim(), img: c[4], price: c[10].replace('ILS', '').trim() + ' ₪', cat: c[11] });
    }
}

function renderUI() {
    const b = STATE.branch; const t = TXT[lang];
    document.getElementById('br-name').textContent = b[`name_${lang}`];
    document.getElementById('br-hours').textContent = b.hours;
    document.getElementById('duty-text').textContent = t.duty;
    document.getElementById('duty-link').href = `https://wa.me/${b.phone}?text=${encodeURIComponent(t.duty)}`;
    document.getElementById('widget-text').textContent = t.badge;
    
    // Status Logic
    const now = new Date();
    const d = ['sun','mon','tue','wed','thu','fri','sat'][now.getDay()];
    const mins = now.getHours()*60 + now.getMinutes();
    const isOpen = b.schedule[d]?.some(r => {
        const s = r[0].split(':'), e = r[1].split(':');
        return mins >= (+s[0]*60 + +s[1]) && mins < (+e[0]*60 + +e[1]);
    });
    document.getElementById('br-status').innerHTML = `<span class="status ${isOpen?'open':'closed'}" style="color:${isOpen?'#25D366':'#ff0000'}; font-weight:bold;">● ${isOpen?t.open:t.closed}</span>`;

    // Socials - سحب الروابط من كائن social بما في ذلك Waze
    const socialEl = document.getElementById('br-social'); socialEl.innerHTML = '';
    const icons = { 
        tiktok:'fa-brands fa-tiktok', 
        instagram:'fa-brands fa-instagram', 
        facebook:'fa-brands fa-facebook', 
        waze:'fa-brands fa-waze', 
        email:'fa-solid fa-envelope', 
        youtube:'fa-brands fa-youtube' 
    };

    if(b.social) {
        Object.entries(b.social).forEach(([k, v]) => {
            if(v && icons[k]){
                const a = document.createElement('a'); 
                a.href = k==='email' ? 'mailto:'+v : v; 
                a.target="_blank";
                a.innerHTML = `<i class="${icons[k]}" style="color:white; font-size:1.5rem"></i>`;
                a.onclick = () => lead('Social_Click', k);
                socialEl.appendChild(a);
            }
        });
    }

    renderCats(); renderGrid('all');
    document.body.style.opacity = "1";
}

function renderCats() {
    const t = TXT[lang];
    const cats = [t.all, ...new Set(STATE.products.map(p => p.cat))].filter(Boolean);
    const nav = document.getElementById('cats'); nav.innerHTML = '';
    cats.forEach(c => {
        const btn = document.createElement('button'); btn.textContent = c; btn.className = c === t.all ? 'active' : '';
        btn.onclick = (e) => {
            document.querySelectorAll('.cats button').forEach(b => b.classList.remove('active'));
            e.target.classList.add('active'); renderGrid(c === t.all ? 'all' : c);
        };
        nav.appendChild(btn);
    });
}

function renderGrid(f) {
    const g = document.getElementById('grid'); g.innerHTML = ''; const t = TXT[lang];
    const list = f === 'all' ? STATE.products : STATE.products.filter(p => p.cat === f);
    const obs = new IntersectionObserver(es => {
        es.forEach(e => { if(e.isIntersecting){ e.target.src = e.target.dataset.src; e.target.onload = () => e.target.classList.add('loaded'); } });
    });
    list.forEach(p => {
        const d = document.createElement('div'); d.className = 'card';
        d.innerHTML = `<div class="img"><img data-src="${p.img}"></div>
            <div class="info"><div style="font-size:0.85rem; height:2.5em; overflow:hidden;">${p.title}</div><div class="price">${p.price}</div>
            <a class="wa-btn" target="_blank" href="https://wa.me/${STATE.branch.phone}?text=${encodeURIComponent(t.msg+p.title)}" onclick="lead('Product_Order', '${p.title}')">${t.order}</a></div>`;
        g.appendChild(d); obs.observe(d.querySelector('img'));
    });
}

/** Popup & Widget Logic **/
function openSale() {
    document.getElementById('popup-sale').style.display = 'flex';
    document.getElementById('reopen-sale').style.display = 'none';
    startTimer();
}

function closeSale() {
    document.getElementById('popup-sale').style.display = 'none';
    document.getElementById('reopen-sale').style.display = 'flex';
    localStorage.setItem('mad_sale_' + new Date().toDateString(), 'seen');
    clearInterval(timerInterval);
}

function startTimer() {
    clearInterval(timerInterval);
    timerInterval = setInterval(() => {
        const diff = new Date().setHours(23, 59, 59) - new Date();
        if (diff <= 0) { 
            closeSale(); 
            document.getElementById('reopen-sale').style.display = 'none';
            clearInterval(timerInterval);
            return;
        }
        const h = Math.floor(diff/3600000).toString().padStart(2,'0');
        const m = Math.floor((diff%3600000)/60000).toString().padStart(2,'0');
        const s = Math.floor((diff%60000)/1000).toString().padStart(2,'0');
        document.getElementById('sale-timer').textContent = `${h}:${m}:${s}`;
    }, 1000);
}

function initDailySale() {
    const saleKey = 'mad_sale_' + new Date().toDateString();
    const t = TXT[lang];
    
    // WhatsApp Message Logic
    const whatsappMsg = lang === 'ar' 
        ? 'مرحباً، أريد الحصول على عرض اليوم الخاص بفرع ' + STATE.branch.name_ar 
        : 'שלום, אשמח לקבל את ההטבה היומית של סניף ' + STATE.branch.name_he;

    const saleLink = document.getElementById('sale-wa-link');
    saleLink.textContent = t.offer;
    saleLink.href = `https://wa.me/${STATE.branch.phone}?text=${encodeURIComponent(whatsappMsg)}`;
    saleLink.onclick = () => lead('Daily_Offer_Click', STATE.branch.name_ar);

    if (localStorage.getItem(saleKey)) {
        document.getElementById('reopen-sale').style.display = 'flex';
    } else {
        setTimeout(openSale, 3000);
    }
}

start();
</script>
</body>
</html>
