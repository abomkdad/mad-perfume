<!DOCTYPE html>
<html lang="he" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>MAD PARFUMEUR | Luxury Fragrance</title>
    
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link href="https://fonts.googleapis.com/css2?family=Cinzel:wght@700&family=Assistant:wght@300;400;700&display=swap" rel="stylesheet">

    <style>
        :root {
            --gold: #D4AF37;
            --black: #000000;
            --dark-grey: #111111;
            --white: #ffffff;
            --whatsapp: #25D366;
            --transition: all 0.3s cubic-bezier(0.25, 0.8, 0.25, 1);
        }

        * { box-sizing: border-box; margin: 0; padding: 0; }
        body { 
            background-color: var(--black); 
            color: var(--white); 
            font-family: 'Assistant', sans-serif;
            overflow-x: hidden;
            -webkit-font-smoothing: antialiased;
            opacity: 0;
            transition: opacity 0.5s ease;
        }

        .container { max-width: 1200px; margin: 0 auto; padding: 0 15px; }

        /* Header */
        header { padding: 40px 0 20px; text-align: center; border-bottom: 1px solid rgba(212, 175, 55, 0.2); }
        .logo { font-family: 'Cinzel', serif; color: var(--gold); font-size: 2.5rem; letter-spacing: 5px; text-transform: uppercase; margin-bottom: 5px; }
        .branch-title { font-size: 1.3rem; font-weight: 300; margin-bottom: 15px; }

        /* Status Badge */
        .status-badge {
            display: inline-block; padding: 5px 15px; border-radius: 50px;
            font-size: 0.8rem; font-weight: 700; text-transform: uppercase;
        }
        .status-open { background: rgba(37, 211, 102, 0.1); color: var(--whatsapp); border: 1px solid var(--whatsapp); }
        .status-closed { background: rgba(255, 77, 77, 0.1); color: #ff4d4d; border: 1px solid #ff4d4d; }

        /* Social Icons */
        .social-bar { display: flex; justify-content: center; gap: 20px; margin-top: 20px; }
        .social-bar a { color: var(--white); font-size: 1.5rem; transition: var(--transition); opacity: 0.8; }
        .social-bar a:hover { color: var(--gold); transform: translateY(-3px); opacity: 1; }

        /* Navigation / Filters */
        .filter-nav {
            position: sticky; top: 0; background: var(--black); z-index: 100;
            padding: 15px 0; border-bottom: 1px solid #222; overflow-x: auto;
            scrollbar-width: none;
        }
        .filter-nav::-webkit-scrollbar { display: none; }
        .filter-flex { display: flex; gap: 10px; justify-content: center; min-width: max-content; padding: 0 15px; }
        .filter-btn {
            background: #1a1a1a; color: var(--white); border: 1px solid #333;
            padding: 8px 22px; border-radius: 4px; cursor: pointer; white-space: nowrap;
            font-size: 0.9rem; transition: var(--transition);
        }
        .filter-btn.active { background: var(--gold); color: var(--black); border-color: var(--gold); font-weight: 700; }

        /* Product Grid */
        .products-grid { display: grid; grid-template-columns: repeat(2, 1fr); gap: 15px; padding: 30px 0 80px; }
        @media (min-width: 768px) { .products-grid { grid-template-columns: repeat(4, 1fr); gap: 25px; } }
        
        .p-card { background: var(--dark-grey); border: 1px solid #222; display: flex; flex-direction: column; transition: var(--transition); }
        .p-card:hover { border-color: var(--gold); }
        .p-img-box { width: 100%; aspect-ratio: 1/1; background: #000; overflow: hidden; position: relative; }
        .p-img-box img { width: 100%; height: 100%; object-fit: cover; opacity: 0; transition: opacity 0.4s; }
        .p-img-box img.loaded { opacity: 1; }

        .p-info { padding: 15px; text-align: center; flex-grow: 1; display: flex; flex-direction: column; }
        .p-title { font-family: 'Cinzel', serif; font-size: 1rem; margin-bottom: 10px; min-height: 2.8em; line-height: 1.4; }
        .p-price { color: var(--gold); font-weight: 700; font-size: 1.3rem; margin-bottom: 15px; }
        .p-wa-btn {
            background: var(--whatsapp); color: #fff; text-decoration: none;
            padding: 12px; border-radius: 4px; font-weight: 700; display: flex;
            align-items: center; justify-content: center; gap: 8px; font-size: 0.9rem;
        }

        /* Daily Offer Popup */
        #offer-popup { position: fixed; inset: 0; background: rgba(0,0,0,0.9); z-index: 2000; display: none; align-items: center; justify-content: center; padding: 20px; }
        .popup-box { width: 100%; max-width: 450px; background: #000; border: 1px solid var(--gold); position: relative; animation: popIn 0.4s ease; }
        @keyframes popIn { from { transform: scale(0.9); opacity: 0; } to { transform: scale(1); opacity: 1; } }
        .popup-close { position: absolute; top: -45px; right: 0; color: #fff; font-size: 2.5rem; cursor: pointer; }
        .popup-img { width: 100%; aspect-ratio: 1/1; object-fit: cover; display: block; }
        .popup-timer { background: var(--gold); color: #000; padding: 12px; text-align: center; font-weight: 900; font-size: 1.2rem; }
        .popup-cta { display: block; background: var(--whatsapp); color: #fff; text-align: center; padding: 20px; text-decoration: none; font-weight: 900; font-size: 1.3rem; }

        /* Loader */
        #loader { position: fixed; inset: 0; background: #000; z-index: 3000; display: flex; align-items: center; justify-content: center; font-family: 'Cinzel', serif; color: var(--gold); font-size: 2rem; }
    </style>
</head>
<body dir="rtl">

<div id="loader">MAD PARFUMEUR</div>

<header>
    <div class="container">
        <h1 class="logo">MAD PARFUMEUR</h1>
        <div id="br-display-name" class="branch-title"></div>
        <div id="br-status-badge"></div>
        <div id="br-socials" class="social-bar"></div>
    </div>
</header>

<div class="filter-nav">
    <div class="container">
        <div id="filter-tabs" class="filter-flex"></div>
    </div>
</div>

<main class="container">
    <div id="products-grid" class="products-grid"></div>
</main>

<div id="offer-popup">
    <div class="popup-box">
        <span class="popup-close" onclick="closePopup()">&times;</span>
        <img src="sale.png" class="popup-img" alt="Special Offer">
        <div id="timer" class="popup-timer">00:00:00</div>
        <a href="#" id="popup-wa-link" class="popup-cta">CLAIM OFFER</a>
    </div>
</div>

<script>
    const App = {
        branchId: new URLSearchParams(window.location.search).get('branch') || '1',
        lang: navigator.language.startsWith('ar') ? 'ar' : 'he',
        data: null,
        products: [],
        i18n: {
            he: { dir: 'ltr', open: 'פתוח עכשיו', closed: 'סגור כעת', all: 'הכל', order: 'הזמנה ב-WhatsApp', msg: 'היי، אני מעוניין ב: ' },
            ar: { dir: 'rtl', open: 'مفتوح الآن', closed: 'مغلق حالياً', all: 'الكل', order: 'طلب عبر واتساب', msg: 'مرحباً، أنا مهتم بـ: ' }
        }
    };

    /** Tracking Engine */
    function trackLead(action, title = '') {
        const payload = { branch_id: App.branchId, action_label: action, item_title: title };
        console.log('[Lead Event]:', payload);
        if (window.fbq) fbq('track', 'Lead', payload);
        if (window.ttq) ttq.track('SubmitForm', { contents: [{ content_name: action, content_id: title }] });
    }

    /** Normalize Phone for WhatsApp */
    function normWA(num) {
        let clean = num.replace(/\D/g, '');
        if (clean.startsWith('05')) clean = '972' + clean.substring(1);
        return clean;
    }

    /** Robust CSV Parser */
    function parseCSV(text) {
        const lines = text.split(/\r?\n/).filter(l => l.trim());
        const headers = lines[0].split(',').map(h => h.trim());
        return lines.slice(1).map(line => {
            const values = line.split(/,(?=(?:(?:[^"]*"){2})*[^"]*$)/);
            let obj = {};
            headers.forEach((h, i) => {
                let val = values[i] ? values[i].replace(/^"|"$/g, '').trim() : "";
                obj[h] = val;
            });
            return obj;
        });
    }

    /** UI Rendering */
    function renderGrid(filter = 'all') {
        const grid = document.getElementById('products-grid');
        grid.innerHTML = '';
        const t = App.i18n[App.lang];
        
        const list = filter === 'all' ? App.products : App.products.filter(p => p['Category (g:product_type)'] === filter);
        const frag = document.createDocumentFragment();

        list.forEach(p => {
            const waUrl = `https://wa.me/${normWA(App.data.phone)}?text=${encodeURIComponent(t.msg + p.Title)}`;
            const card = document.createElement('div');
            card.className = 'p-card';
            card.innerHTML = `
                <div class="p-img-box"><img data-src="${p.Image}" alt="${p.Title}"></div>
                <div class="p-info">
                    <div class="p-title">${p.Title}</div>
                    <div class="p-price">${p.Price}</div>
                    <a href="${waUrl}" target="_blank" class="p-wa-btn" onclick="trackLead('WA_Click', '${p.Title}')">
                        <i class="fab fa-whatsapp"></i> ${t.order}
                    </a>
                </div>`;
            frag.appendChild(card);
        });
        grid.appendChild(frag);

        const obs = new IntersectionObserver(entries => {
            entries.forEach(en => {
                if (en.isIntersecting) {
                    const img = en.target;
                    img.src = img.dataset.src;
                    img.onload = () => img.classList.add('loaded');
                    obs.unobserve(img);
                }
            });
        }, { rootMargin: '100px' });
        grid.querySelectorAll('img').forEach(i => obs.observe(i));
    }

    async function init() {
        try {
            const [bRes, pRes] = await Promise.all([fetch('test.json'), fetch('products.csv')]);
            const bJson = await bRes.json();
            App.data = bJson.branches.find(b => b.id == App.branchId) || bJson.branches[0];
            App.products = parseCSV(await pRes.text());

            // Set Direction & Lang
            const ui = App.i18n[App.lang];
            document.body.dir = ui.dir;
            document.documentElement.lang = App.lang;

            // Header Info
            document.getElementById('br-display-name').textContent = App.data[`name_${App.lang}`];
            
            // Socials
            const socMap = { tiktok:'fa-tiktok', instagram:'fa-instagram', facebook:'fa-facebook', snapchat:'fa-snapchat', youtube:'fa-youtube', email:'fa-envelope', waze:'fa-waze' };
            document.getElementById('br-socials').innerHTML = Object.entries(App.data.social)
                .map(([k,v]) => v ? `<a href="${v}" target="_blank" onclick="trackLead('Social_Click', '${k}')"><i class="fab ${socMap[k]||'fa-link'}"></i></a>` : '').join('');

            // Status Logic
            const now = new Date();
            const day = ['sun','mon','tue','wed','thu','fri','sat'][now.getDay()];
            const sched = App.data.schedule[day];
            const currentM = now.getHours() * 60 + now.getMinutes();
            const isOpen = sched && sched.some(r => {
                const [sH, sM] = r[0].split(':').map(Number);
                const [eH, eM] = r[1].split(':').map(Number);
                return currentM >= (sH*60+sM) && currentM < (eH*60+eM);
            });
            document.getElementById('br-status-badge').innerHTML = `<span class="status-badge ${isOpen?'status-open':'status-closed'}">${isOpen?ui.open:ui.closed}</span>`;

            // Filters
            const cats = [ui.all, ...new Set(App.products.map(p => p['Category (g:product_type)']))].filter(Boolean);
            const nav = document.getElementById('filter-tabs');
            cats.forEach(c => {
                const btn = document.createElement('button');
                btn.className = 'filter-btn' + (c === ui.all ? ' active' : '');
                btn.textContent = c;
                btn.onclick = (e) => {
                    document.querySelectorAll('.filter-btn').forEach(b => b.classList.remove('active'));
                    btn.classList.add('active');
                    renderGrid(c === ui.all ? 'all' : c);
                };
                nav.appendChild(btn);
            });

            renderGrid();
            initPopup();

            document.getElementById('loader').style.display = 'none';
            document.body.style.opacity = '1';
        } catch (e) { console.error('Bootstrap Error:', e); }
    }

    function initPopup() {
        if (localStorage.getItem('mad_pop_' + new Date().toDateString())) return;
        setTimeout(() => {
            document.getElementById('offer-popup').style.display = 'flex';
            document.getElementById('popup-wa-link').href = `https://wa.me/${normWA(App.data.phone)}?text=DailyOffer`;
            document.getElementById('popup-wa-link').onclick = () => trackLead('Popup_CTA_Click');
            
            const timerInt = setInterval(() => {
                const diff = new Date().setHours(23,59,59) - new Date();
                if (diff <= 0) { closePopup(); clearInterval(timerInt); }
                const h = Math.floor(diff/3600000).toString().padStart(2,'0');
                const m = Math.floor((diff%3600000)/60000).toString().padStart(2,'0');
                const s = Math.floor((diff%60000)/1000).toString().padStart(2,'0');
                document.getElementById('timer').textContent = `${h}:${m}:${s}`;
            }, 1000);
        }, 3000);
    }

    window.closePopup = () => {
        document.getElementById('offer-popup').style.display = 'none';
        localStorage.setItem('mad_pop_' + new Date().toDateString(), '1');
    };

    window.onload = init;
</script>
</body>
</html>
``` [cite: 1, 2, 3]
