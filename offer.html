<!DOCTYPE html>
<html lang="he">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width,initial-scale=1.0">
<title>MAD PARFUMEUR</title>

<!-- Fonts -->
<link href="https://fonts.googleapis.com/css2?family=Cinzel:wght@700&family=Assistant:wght@400;700&display=swap" rel="stylesheet">
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">

<!-- Meta Pixel -->
<script>
!function(f,b,e,v,n,t,s){if(f.fbq)return;n=f.fbq=function(){n.callMethod?
n.callMethod.apply(n,arguments):n.queue.push(arguments)};
if(!f._fbq)f._fbq=n;n.push=n;n.loaded=!0;n.version='2.0';
n.queue=[];t=b.createElement(e);t.async=!0;
t.src=v;s=b.getElementsByTagName(e)[0];
s.parentNode.insertBefore(t,s)}(window,document,'script',
'https://connect.facebook.net/en_US/fbevents.js');
fbq('init','1072283127290819'); fbq('track','PageView');
</script>

<!-- TikTok Pixel -->
<script>
!function (w, d, t) {
  w.TiktokAnalyticsObject=t;
  var ttq=w[t]=w[t]||[];
  ttq.methods=["page","track"];
  ttq.setAndDefer=function(t,e){
    t[e]=function(){
      t.push([e].concat(Array.prototype.slice.call(arguments,0)))
    }
  };
  for(var i=0;i<ttq.methods.length;i++){
    ttq.setAndDefer(ttq,ttq.methods[i]);
  }
  ttq.load=function(e){
    var i=d.createElement("script");
    i.async=!0;
    i.src="https://analytics.tiktok.com/i18n/pixel/events.js?sdkid="+e;
    var s=d.getElementsByTagName("script")[0];
    s.parentNode.insertBefore(i,s);
  };
  ttq.load("D2D02JBC77U4ENLN9SBG");
  ttq.page();
}(window, document, 'ttq');
</script>

<style>
:root{
--gold:#D4AF37;--black:#000;--card:#111;
--white:#fff;--wa:#25D366;
}
*{box-sizing:border-box;margin:0;padding:0}
body{background:#000;color:#fff;font-family:'Assistant',sans-serif}
header{text-align:center;padding:30px;border-bottom:1px solid #222}
.logo{font-family:'Cinzel';color:var(--gold);font-size:2.2rem;letter-spacing:4px}
.branch{margin-top:8px;font-size:1.2rem}
.status{display:inline-block;margin-top:8px;padding:4px 14px;border-radius:20px;font-size:.8rem;font-weight:700}
.open{color:#25D366;border:1px solid #25D366}
.closed{color:#ff4d4d;border:1px solid #ff4d4d}

.cats{display:flex;gap:8px;overflow-x:auto;padding:10px;border-bottom:1px solid #222}
.cats button{background:#111;color:#fff;border:1px solid #333;
padding:6px 16px;border-radius:4px;cursor:pointer}
.cats button.active{background:var(--gold);color:#000}

.grid{display:grid;grid-template-columns:repeat(2,1fr);gap:10px;padding:15px}
@media(min-width:768px){.grid{grid-template-columns:repeat(4,1fr)}}

.card{background:#111;border:1px solid #222;display:flex;flex-direction:column}
.img{aspect-ratio:1/1;overflow:hidden}
.img img{width:100%;height:100%;object-fit:cover;opacity:0;transition:.3s}
.img img.loaded{opacity:1}
.info{text-align:center;padding:12px}
.name{font-family:'Cinzel';font-size:.9rem;height:2.6em;overflow:hidden}
.price{color:var(--gold);margin:8px 0;font-weight:700}
.wa{background:var(--wa);color:#fff;text-decoration:none;
padding:10px;font-weight:700;border-radius:4px;display:block}

#popup{position:fixed;inset:0;background:rgba(0,0,0,.9);
display:none;align-items:center;justify-content:center;z-index:999}
.pbox{width:90%;max-width:400px;border:1px solid var(--gold)}
.pclose{position:absolute;top:-40px;right:0;font-size:2rem;cursor:pointer}
.ptimer{background:var(--gold);color:#000;font-weight:900;padding:10px;text-align:center}
.pwa{display:block;background:var(--wa);color:#fff;
padding:15px;text-align:center;font-weight:900;text-decoration:none}
</style>
</head>

<body>

<header>
  <div class="logo">MAD PARFUMEUR</div>
  <div id="branch" class="branch"></div>
  <div id="status"></div>
</header>

<nav id="cats" class="cats"></nav>
<main id="grid" class="grid"></main>

<div id="popup">
  <div class="pbox">
    <span class="pclose" onclick="closePop()">×</span>
    <img src="sale.png" style="width:100%">
    <div id="timer" class="ptimer">00:00:00</div>
    <a id="pwa" class="pwa" target="_blank">CLAIM OFFER</a>
  </div>
</div>

<script>
const qs=new URLSearchParams(location.search);
const branchID=qs.get('branch')||'1';
const lang=navigator.language.startsWith('ar')?'ar':'he';
document.documentElement.dir=lang==='ar'?'rtl':'ltr';

const TXT={
he:{open:'פתוח',closed:'סגור',all:'הכל',order:'הזמנה',msg:'היי, אני מעוניין ב: '},
ar:{open:'مفتوح',closed:'مغلق',all:'الكل',order:'طلب',msg:'مرحباً، أنا مهتم بـ: '}
};

let STATE={branch:null,products:[]};

function lead(action,label){
if(window.fbq)fbq('track','Lead',{branch:branchID,action,label});
if(window.ttq)ttq.track('SubmitForm',{branch:branchID,action,label});
}

async function start(){
const [bj,pc]=await Promise.all([
fetch('test.json').then(r=>r.json()),
fetch('products.csv').then(r=>r.text())
]);

STATE.branch=bj.branches.find(b=>b.id==branchID);
parseCSV(pc);
renderHeader();
renderCats();
renderGrid('all');
initPopup();
}

function parseCSV(text){
const lines=text.split('\n');
for(let i=1;i<lines.length;i++){
const c=lines[i].split(/,(?=(?:(?:[^"]*"){2})*[^"]*$)/);
if(!c[1])continue;
STATE.products.push({
title:c[1].replace(/"/g,''),
img:c[4],
price:c[10],
cat:c[11]
});
}
}

function renderHeader(){
const t=TXT[lang];
document.getElementById('branch').textContent=STATE.branch[`name_${lang}`];
const now=new Date();
const d=['sun','mon','tue','wed','thu','fri','sat'][now.getDay()];
const mins=now.getHours()*60+now.getMinutes();
const open=STATE.branch.schedule[d]?.some(r=>{
const a=r[0].split(':'),b=r[1].split(':');
return mins>=(+a[0]*60+ +a[1])&&mins<=(+b[0]*60+ +b[1]);
});
document.getElementById('status').innerHTML=
`<span class="status ${open?'open':'closed'}">${open?t.open:t.closed}</span>`;
}

function renderCats(){
const t=TXT[lang];
const cats=[t.all,...new Set(STATE.products.map(p=>p.cat))].filter(Boolean);
const el=document.getElementById('cats');
cats.forEach(c=>{
const b=document.createElement('button');
b.textContent=c;
b.className=c===t.all?'active':'';
b.onclick=()=>{
document.querySelectorAll('.cats button').forEach(x=>x.classList.remove('active'));
b.classList.add('active');
renderGrid(c===t.all?'all':c);
};
el.appendChild(b);
});
}

function renderGrid(f){
const g=document.getElementById('grid');
g.innerHTML='';
const t=TXT[lang];
const list=f==='all'?STATE.products:STATE.products.filter(p=>p.cat===f);
const obs=new IntersectionObserver(es=>{
es.forEach(e=>{
if(e.isIntersecting){
const i=e.target;i.src=i.dataset.src;
i.onload=()=>i.classList.add('loaded');
obs.unobserve(i);
}
});
});
list.forEach(p=>{
const d=document.createElement('div');
d.className='card';
d.innerHTML=`
<div class="img"><img data-src="${p.img}"></div>
<div class="info">
<div class="name">${p.title}</div>
<div class="price">${p.price}</div>
<a class="wa" target="_blank"
href="https://wa.me/${STATE.branch.phone}?text=${encodeURIComponent(t.msg+p.title)}"
onclick="lead('whatsapp','${p.title}')">${t.order}</a>
</div>`;
g.appendChild(d);
obs.observe(d.querySelector('img'));
});
}

function initPopup(){
const key='mad_pop_'+new Date().toDateString();
if(localStorage.getItem(key))return;
setTimeout(()=>{
document.getElementById('popup').style.display='flex';
document.getElementById('pwa').href=
`https://wa.me/${STATE.branch.phone}?text=Offer`;
setInterval(()=>{
const d=new Date().setHours(23,59,59)-new Date();
const h=Math.floor(d/3600000).toString().padStart(2,'0');
const m=Math.floor((d%3600000)/60000).toString().padStart(2,'0');
const s=Math.floor((d%60000)/1000).toString().padStart(2,'0');
document.getElementById('timer').textContent=`${h}:${m}:${s}`;
},1000);
},2000);
}

function closePop(){
document.getElementById('popup').style.display='none';
localStorage.setItem('mad_pop_'+new Date().toDateString(),'1');
lead('popup_close','daily_offer');
}

start();
</script>

</body>
</html>
