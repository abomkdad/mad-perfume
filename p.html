export default async (request: Request) => {
  const url = new URL(request.url);
  const code = (url.searchParams.get("code") || "").trim();
  const to = (url.searchParams.get("to") || "972524033442").trim();

  if (!code) {
    return new Response("Missing code", { status: 400 });
  }

  // رابط ملف CSV عندك (بنفس الدومين)
  const csvUrl = new URL("/p.csv", url.origin).toString();

  const res = await fetch(csvUrl, { headers: { "cache-control": "no-cache" } });
  if (!res.ok) return new Response("Cannot load p.csv", { status: 500 });

  const csv = await res.text();

  // CSV parser بسيط (يدعم quotes)
  function parseCSV(text: string): string[][] {
    const rows: string[][] = [];
    let row: string[] = [];
    let cur = "";
    let inQ = false;

    for (let i = 0; i < text.length; i++) {
      const ch = text[i];
      const next = text[i + 1];

      if (ch === '"' && inQ && next === '"') { cur += '"'; i++; continue; }
      if (ch === '"') { inQ = !inQ; continue; }

      if (ch === "," && !inQ) { row.push(cur); cur = ""; continue; }

      if ((ch === "\n" || ch === "\r") && !inQ) {
        if (cur.length || row.length) { row.push(cur); rows.push(row); }
        cur = ""; row = [];
        continue;
      }

      cur += ch;
    }
    if (cur.length || row.length) { row.push(cur); rows.push(row); }
    return rows;
  }

  const rows = parseCSV(csv).filter(r => r.some(c => (c || "").trim() !== ""));
  const headers = (rows.shift() || []).map(h => (h || "").trim());

  const idx = (name: string) => headers.indexOf(name);

  const I_CODE = idx("PRODUCT CODE");
  const I_LINK = idx("LINK");
  const I_IMG  = idx("IMAGE_LINK");
  const I_NAME = idx("FRAG_MATCH_NAME");
  const I_DESC_AR = idx("DESC_AR");
  const I_DESC_HE = idx("DESC_HE");

  const norm = (s: any) => String(s ?? "").trim();

  const found = rows.find(r => norm(r[I_CODE]).toLowerCase() === code.toLowerCase());
  if (!found) return new Response("Product not found", { status: 404 });

  const pCode = norm(found[I_CODE]);
  const pLink = norm(found[I_LINK]) || `${url.origin}/`;
  let pImg = norm(found[I_IMG]) || `${url.origin}/assets/hero/logo2.webp`;
  const pName = norm(found[I_NAME]) || pCode;

  // حاول يرجع للصورة الأصلية بدل -450px إن وجدت
  pImg = pImg.replace(/-450px(\.(png|jpg|jpeg|webp))$/i, ".$2");

  // وصف قصير (اختر عربي/عبري حسب متصفح البوت: غالبًا en — فخليه عربي افتراضي)
  const desc = norm(found[I_DESC_AR]) || norm(found[I_DESC_HE]) || "MAD Parfumeur";

  // صفحة العرض الحقيقية للزبون (بعد ما البوت يقرأ OG)
  const redirectTo = `${url.origin}/p2.html?code=${encodeURIComponent(pCode)}&to=${encodeURIComponent(to)}`;

  // HTML مع OG tags + تحويل تلقائي للزبون
  const html = `<!doctype html>
<html lang="ar" dir="rtl">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>${escapeHtml(pName)} | MAD</title>

  <meta property="og:type" content="website" />
  <meta property="og:title" content="${escapeHtml(pName)}" />
  <meta property="og:description" content="${escapeHtml(desc)}" />
  <meta property="og:image" content="${escapeHtml(pImg)}" />
  <meta property="og:url" content="${escapeHtml(pLink)}" />

  <meta name="twitter:card" content="summary_large_image" />
  <meta name="twitter:title" content="${escapeHtml(pName)}" />
  <meta name="twitter:description" content="${escapeHtml(desc)}" />
  <meta name="twitter:image" content="${escapeHtml(pImg)}" />

  <meta http-equiv="refresh" content="0; url=${escapeHtml(redirectTo)}" />
</head>
<body>
  <a href="${escapeHtml(redirectTo)}">Continue</a>
</body>
</html>`;

  return new Response(html, {
    headers: {
      "content-type": "text/html; charset=utf-8",
      // خليه caching قليل عشان يتحدّث بسرعة
      "cache-control": "public, max-age=60"
    }
  });
};

function escapeHtml(s: string) {
  return s
    .replaceAll("&", "&amp;")
    .replaceAll("<", "&lt;")
    .replaceAll(">", "&gt;")
    .replaceAll('"', "&quot;")
    .replaceAll("'", "&#39;");
}
