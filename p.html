<!doctype html>
<html lang="ar" dir="rtl">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover" />
  <title>MAD | Ø·Ù„Ø¨ Ø§Ù„Ù…Ù†ØªØ¬</title>

  <!-- WhatsApp / Social preview (Ø§Ø®ØªÙŠØ§Ø±ÙŠ) -->
  <meta property="og:title" content="MAD Parfumeur" />
  <meta property="og:description" content="Ø§Ø·Ù„Ø¨ Ø¨Ø³Ù‡ÙˆÙ„Ø© Ø¹Ø¨Ø± ÙˆØ§ØªØ³Ø§Ø¨" />
  <meta property="og:image" content="https://www.mad-parfumeur.com/assets/hero/logo2.webp" />

  <style>
    :root{--bg:#0b0d10;--card:#121620;--muted:#aab3c2;--text:#f2f5fb;--gold:#C5A059;}
    *{box-sizing:border-box}
    body{
      margin:0; font-family: system-ui,-apple-system,Segoe UI,Roboto,Arial;
      background: radial-gradient(1200px 700px at 50% -200px, rgba(197,160,89,.25), transparent 60%),
                  linear-gradient(180deg, #07090c, var(--bg));
      color:var(--text);
      min-height:100vh;
      padding:18px;
      -webkit-tap-highlight-color: transparent;
    }
    .wrap{max-width:1100px;margin:0 auto}
    .top{display:flex;align-items:center;justify-content:space-between;gap:12px;margin-bottom:14px}
    .brand{display:flex;align-items:center;gap:10px;font-weight:900}
    .dot{width:10px;height:10px;border-radius:999px;background:var(--gold);box-shadow:0 0 18px rgba(197,160,89,.7)}
    .pill{color:#0b0d10;background:linear-gradient(90deg,#f6e27a,#c5a059);padding:8px 12px;border-radius:999px;font-weight:800;font-size:13px}

    .card{
      background: rgba(18,22,32,.92);
      border:1px solid rgba(255,255,255,.08);
      border-radius:22px;
      box-shadow:0 16px 50px rgba(0,0,0,.45);
      overflow:hidden;
    }
    .grid{display:grid;grid-template-columns: 1.05fr .95fr;gap:0}
    @media (max-width:950px){ .grid{grid-template-columns:1fr} }

    .imgBox{background:#0a0c10;display:flex;align-items:center;justify-content:center;padding:14px}
    .imgBox img{
      width:100%;
      max-width:520px;
      height:auto;
      border-radius:18px;
      border:1px solid rgba(255,255,255,.10);
      background:#0a0c10;
      image-rendering:auto;
      display:block;
    }

    .info{padding:18px 18px 22px}
    h1{margin:0 0 10px;font-size:22px;line-height:1.25}
    .meta{color:var(--muted);font-weight:700;margin-bottom:10px}
    .desc{
      color:#e9eef9;opacity:.92;line-height:1.8;
      background: rgba(255,255,255,.04);
      border:1px solid rgba(255,255,255,.06);
      padding:12px;border-radius:16px;white-space:pre-wrap;
    }

    .form{
      margin-top:14px;
      background: rgba(255,255,255,.03);
      border:1px solid rgba(255,255,255,.06);
      border-radius:18px;
      padding:12px;
    }
    .row{display:grid;grid-template-columns:1fr 1fr;gap:10px}
    @media (max-width:650px){ .row{grid-template-columns:1fr} }
    label{font-size:12px;color:var(--muted);font-weight:700}
    input, textarea{
      width:100%;
      background: rgba(255,255,255,.06);
      border:1px solid rgba(255,255,255,.10);
      color:var(--text);
      border-radius:14px;
      padding:11px 12px;
      outline:none;
      font-size:14px;
    }
    textarea{min-height:90px;resize:vertical}

    .actions{display:flex;gap:10px;flex-wrap:wrap;margin-top:12px}
    .btn{
      appearance:none;border:0;cursor:pointer;
      padding:12px 14px;border-radius:14px;
      font-weight:900;font-size:15px;
      text-decoration:none;display:inline-flex;align-items:center;justify-content:center;gap:8px;
      min-width:170px;
      transition:transform .08s ease, opacity .08s ease;
      user-select:none;
    }
    .btn:active{transform:scale(.98)}
    .b1{background:linear-gradient(90deg,#f6e27a,#c5a059);color:#0b0d10}
    .b2{background:rgba(255,255,255,.10);color:var(--text);border:1px solid rgba(255,255,255,.12)}
    .b3{background:rgba(255,255,255,.06);color:var(--muted);border:1px solid rgba(255,255,255,.10)}
    .small{margin-top:10px;font-size:12px;color:var(--muted);line-height:1.6}
    .err{padding:16px;border-radius:16px;background:rgba(255,0,0,.08);border:1px solid rgba(255,0,0,.18); color:#ffd9d9}
    code{background:rgba(255,255,255,.08);padding:2px 6px;border-radius:10px}

    /* Cart */
    .cartBar{
      position:sticky; top:10px; z-index:20;
      display:flex; align-items:center; justify-content:space-between;
      gap:10px; margin-bottom:10px;
      padding:10px 12px;
      border-radius:16px;
      border:1px solid rgba(255,255,255,.08);
      background: rgba(10,12,16,.55);
      backdrop-filter: blur(10px);
    }
    .cartCount{
      display:inline-flex; align-items:center; gap:8px;
      font-weight:900; color:#0b0d10;
      background: linear-gradient(90deg,#f6e27a,#c5a059);
      padding:8px 10px; border-radius:999px;
      font-size:13px;
    }
    .cartBtn{
      background: rgba(255,255,255,.10);
      border:1px solid rgba(255,255,255,.12);
      color: var(--text);
      padding:10px 12px;
      border-radius:14px;
      font-weight:900;
      cursor:pointer;
    }
    .modal{
      position:fixed; inset:0;
      background: rgba(0,0,0,.55);
      display:none; align-items:flex-end; justify-content:center;
      z-index:99;
    }
    .modal.open{display:flex}
    .sheet{
      width:100%;
      max-width:700px;
      border-radius:22px 22px 0 0;
      background: rgba(18,22,32,.96);
      border:1px solid rgba(255,255,255,.10);
      box-shadow:0 -16px 60px rgba(0,0,0,.5);
      overflow:hidden;
      max-height:82vh;
      display:flex;
      flex-direction:column;
    }
    .sheetHead{
      padding:12px 14px;
      display:flex; align-items:center; justify-content:space-between;
      border-bottom:1px solid rgba(255,255,255,.08);
    }
    .sheetTitle{font-weight:900}
    .xBtn{
      background: rgba(255,255,255,.10);
      border:1px solid rgba(255,255,255,.12);
      color:#fff;
      border-radius:12px;
      padding:8px 10px;
      cursor:pointer;
      font-weight:900;
    }
    .sheetBody{padding:12px 14px; overflow:auto}
    .item{
      display:flex; gap:10px; align-items:center;
      padding:10px;
      border-radius:16px;
      background: rgba(255,255,255,.04);
      border:1px solid rgba(255,255,255,.06);
      margin-bottom:10px;
    }
    .thumb{
      width:64px; height:64px; border-radius:14px;
      border:1px solid rgba(255,255,255,.10);
      background:#0a0c10;
      object-fit:cover;
      flex:0 0 auto;
    }
    .itemMain{flex:1}
    .itemCode{font-weight:900}
    .itemMeta{color:var(--muted);font-weight:700;font-size:12px;margin-top:2px}
    .qtyRow{display:flex; gap:6px; align-items:center; margin-top:8px}
    .qBtn{
      width:34px; height:34px; border-radius:12px;
      background: rgba(255,255,255,.10);
      border:1px solid rgba(255,255,255,.12);
      color:#fff; font-weight:900; cursor:pointer;
    }
    .qVal{
      min-width:44px; text-align:center; font-weight:900;
      background: rgba(255,255,255,.06);
      border:1px solid rgba(255,255,255,.10);
      padding:7px 10px;
      border-radius:12px;
    }
    .delBtn{
      background: rgba(255,0,0,.10);
      border:1px solid rgba(255,0,0,.25);
      color:#ffd9d9;
      border-radius:12px;
      padding:8px 10px;
      font-weight:900;
      cursor:pointer;
    }
    .sheetFoot{
      padding:12px 14px;
      border-top:1px solid rgba(255,255,255,.08);
      display:flex; gap:10px; flex-wrap:wrap; justify-content:space-between; align-items:center;
    }
    .mutedSmall{color:var(--muted);font-size:12px;font-weight:700}
  </style>
</head>

<body>
  <div class="wrap">

    <div class="cartBar">
      <div class="brand"><span class="dot"></span> MAD Parfumeur</div>
      <div style="display:flex;gap:10px;align-items:center">
        <div class="cartCount" id="cartCount">ğŸ›’ Ø§Ù„Ø³Ù„Ø©: 0</div>
        <button class="cartBtn" id="openCart">ÙØªØ­ Ø§Ù„Ø³Ù„Ø©</button>
      </div>
    </div>

    <div class="top">
      <div class="pill" id="pill">Product</div>
      <div style="display:flex;gap:10px;align-items:center">
        <a class="btn b3" id="goHome" href="https://www.mad-parfumeur.com" target="_blank" rel="noopener" style="min-width:auto">Ø§Ù„Ù…ÙˆÙ‚Ø¹</a>
      </div>
    </div>

    <div class="card" id="card">
      <div class="grid">
        <div class="imgBox">
          <img id="img" alt="MAD Product" src="https://www.mad-parfumeur.com/assets/hero/logo2.webp" />
        </div>

        <div class="info">
          <h1 id="title">Ø¬Ø§Ø±Ù ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ù…Ù†ØªØ¬â€¦</h1>
          <div class="meta" id="meta"></div>
          <div class="desc" id="desc">...</div>

          <div class="form">
            <div class="row">
              <div>
                <label>Ø§Ù„ÙƒÙ…ÙŠØ©</label>
                <input id="qty" type="number" min="1" value="1" />
              </div>
              <div>
                <label>Ø§Ù„Ø§Ø³Ù…</label>
                <input id="name" type="text" placeholder="Ø§Ø³Ù…Ùƒ" />
              </div>
              <div>
                <label>Ø±Ù‚Ù… Ø§Ù„Ù‡Ø§ØªÙ</label>
                <input id="phone" type="tel" placeholder="05xxxxxxxx" />
              </div>
              <div>
                <label>Ø§Ù„Ù…Ø¯ÙŠÙ†Ø©</label>
                <input id="city" type="text" placeholder="Ù…Ø«Ø§Ù„: Ø£Ù… Ø§Ù„ÙØ­Ù…" />
              </div>
              <div style="grid-column:1/-1">
                <label>Ø¹Ù†ÙˆØ§Ù† Ø§Ù„ØªÙˆØµÙŠÙ„</label>
                <input id="address" type="text" placeholder="Ø§Ù„Ø´Ø§Ø±Ø¹ + Ø±Ù‚Ù… Ø§Ù„Ø¨ÙŠØª + ØªÙØ§ØµÙŠÙ„" />
              </div>
              <div style="grid-column:1/-1">
                <label>Ù…Ù„Ø§Ø­Ø¸Ø§Øª (Ø§Ø®ØªÙŠØ§Ø±ÙŠ)</label>
                <textarea id="notes" placeholder="Ù…Ø«Ø§Ù„: ÙˆÙ‚Øª Ù…Ù†Ø§Ø³Ø¨ Ù„Ù„ØªÙˆØ§ØµÙ„ / Ù…Ù„Ø§Ø­Ø¸Ø© Ù„Ù„Ù…ÙˆØµÙ„"></textarea>
              </div>
            </div>

            <div class="actions">
              <button class="btn b2" id="btnAdd" type="button">â• Ø£Ø¶Ù Ù„Ù„Ø³Ù„Ø©</button>
              <a class="btn b1" id="btnWA" href="#" target="_blank" rel="noopener">âœ… Ø¥ÙƒÙ…Ø§Ù„ Ø§Ù„Ø·Ù„Ø¨ Ø¹Ù„Ù‰ ÙˆØ§ØªØ³Ø§Ø¨</a>
              <a class="btn b3" id="btnView" href="#" target="_blank" rel="noopener" style="min-width:auto">Ø´Ø§Ù‡Ø¯ Ø§Ù„Ù…Ù†ØªØ¬</a>
            </div>

            <div class="small">
              âœ… Ø§Ø¶ØºØ· "Ø£Ø¶Ù Ù„Ù„Ø³Ù„Ø©" (Ø­ØªÙ‰ Ù„Ùˆ 5 Ø¹Ø·ÙˆØ±)ØŒ ÙˆØ¨Ø§Ù„Ø¢Ø®Ø± "Ø¥ÙƒÙ…Ø§Ù„ Ø§Ù„Ø·Ù„Ø¨ Ø¹Ù„Ù‰ ÙˆØ§ØªØ³Ø§Ø¨" ÙŠØ±Ø³Ù„ Ø§Ù„Ø³Ù„Ø© ÙƒØ§Ù…Ù„Ø© Ø¬Ø§Ù‡Ø²Ø©.
            </div>
          </div>

        </div>
      </div>
    </div>

    <div style="height:12px"></div>
    <div class="small">
      Ù…Ø«Ø§Ù„ Ø±Ø§Ø¨Ø· Ø§Ù„ØµÙØ­Ø©:
      <code>p.html?code=W.181&to=972524033442</code>
    </div>
  </div>

  <!-- Cart Modal -->
  <div class="modal" id="cartModal" aria-hidden="true">
    <div class="sheet" role="dialog" aria-modal="true">
      <div class="sheetHead">
        <div class="sheetTitle">ğŸ›’ Ø§Ù„Ø³Ù„Ø©</div>
        <button class="xBtn" id="closeCart">Ø¥ØºÙ„Ø§Ù‚</button>
      </div>
      <div class="sheetBody" id="cartBody"></div>
      <div class="sheetFoot">
        <div class="mutedSmall" id="cartSummary">0 Ù…Ù†ØªØ¬</div>
        <div style="display:flex;gap:10px;flex-wrap:wrap">
          <button class="btn b3" id="clearCart" type="button" style="min-width:auto">Ù…Ø³Ø­ Ø§Ù„Ø³Ù„Ø©</button>
          <a class="btn b1" id="btnWAFromCart" href="#" target="_blank" rel="noopener" style="min-width:auto">âœ… Ø¥Ø±Ø³Ø§Ù„ Ø§Ù„Ø³Ù„Ø© Ø¹Ù„Ù‰ ÙˆØ§ØªØ³Ø§Ø¨</a>
        </div>
      </div>
    </div>
  </div>

<script>
  const CSV_URL = "p.csv";               // Ù„Ø§Ø²Ù… ÙŠÙƒÙˆÙ† Ø¨Ù†ÙØ³ Ù…ÙƒØ§Ù† p.html
  const DEFAULT_WA_TO = "972524033442";  // Ø±Ù‚Ù… Ø§Ù„ÙˆØ§ØªØ³Ø§Ø¨ Ø§Ù„Ø§ÙØªØ±Ø§Ø¶ÙŠ

  // ØµÙˆØ±Ùƒ Ø§Ù„Ø¹Ø§Ù„ÙŠØ© Ø¹Ù„Ù‰ Ù…ÙˆÙ‚Ø¹Ùƒ (ØºÙŠØ±Ù‡ Ø¥Ø°Ø§ Ø¨Ø¯Ùƒ)
  // Ù„Ø§Ø²Ù… ÙŠÙƒÙˆÙ† Ø¹Ù†Ø¯Ùƒ: /img/W.181.webp  ... Ø¨Ù†ÙØ³ Ø§Ø³Ù… Ø§Ù„ÙƒÙˆØ¯
  const HIGH_IMG_BASE = "https://www.mad-parfumeur.com/img/";

  function qs(name){
    const u = new URL(location.href);
    return (u.searchParams.get(name) || "").trim();
  }
  function normalizePhone(p){
    return String(p||"").replace(/[^\d]/g,"");
  }

  // CSV parser ÙŠØ¯Ø¹Ù… Ø§Ù„Ø§Ù‚ØªØ¨Ø§Ø³Ø§Øª
  function parseCSV(text){
    const rows = [];
    let row = [], cur = "", inQ = false;
    for(let i=0;i<text.length;i++){
      const ch = text[i];
      const next = text[i+1];

      if(ch === '"' && inQ && next === '"'){ cur += '"'; i++; continue; }
      if(ch === '"'){ inQ = !inQ; continue; }

      if(ch === ',' && !inQ){ row.push(cur); cur = ""; continue; }
      if((ch === '\n' || ch === '\r') && !inQ){
        if(cur.length || row.length){ row.push(cur); rows.push(row); }
        cur = ""; row = [];
        continue;
      }
      cur += ch;
    }
    if(cur.length || row.length){ row.push(cur); rows.push(row); }
    return rows;
  }

  function idxOf(headers, name){
    const i = headers.indexOf(name);
    return i >= 0 ? i : -1;
  }
  function val(r, i){
    if(i < 0) return "";
    return (r[i] ?? "").toString().trim();
  }
  function safe(v){
    return (v||"").toString().trim();
  }

  // Cart (localStorage)
  const CART_KEY = "MAD_CART_V1";

  function getCart(){
    try { return JSON.parse(localStorage.getItem(CART_KEY) || "[]"); }
    catch(e){ return []; }
  }
  function setCart(items){
    localStorage.setItem(CART_KEY, JSON.stringify(items));
  }
  function cartCount(){
    const c = getCart();
    return c.reduce((sum, it) => sum + (parseInt(it.qty||1,10) || 1), 0);
  }
  function updateCartBadge(){
    document.getElementById("cartCount").textContent = `ğŸ›’ Ø§Ù„Ø³Ù„Ø©: ${cartCount()}`;
  }

  // Build WhatsApp message from cart + customer fields
  function buildWAFromCart(waTo){
    const items = getCart();
    const name = safe(document.getElementById("name")?.value);
    const phone = safe(document.getElementById("phone")?.value);
    const city = safe(document.getElementById("city")?.value);
    const address = safe(document.getElementById("address")?.value);
    const notes = safe(document.getElementById("notes")?.value);

    let msg = `Ø·Ù„Ø¨ Ø¬Ø¯ÙŠØ¯ âœ…\n\n`;

    if(items.length){
      msg += `Ø§Ù„Ø³Ù„Ø©:\n`;
      items.forEach((it, idx) => {
        msg += `${idx+1}) ${it.code} Ã— ${it.qty}`;
        if(it.price) msg += ` â€” ${it.price}â‚ª`;
        msg += `\n`;
        if(it.link) msg += `   ${it.link}\n`;
      });
      msg += `\n`;
    } else {
      msg += `Ø§Ù„Ø³Ù„Ø© ÙØ§Ø±ØºØ©.\n\n`;
    }

    msg += `Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ø²Ø¨ÙˆÙ†:\n`;
    if(name) msg += `Ø§Ù„Ø§Ø³Ù…: ${name}\n`;
    if(phone) msg += `Ø§Ù„Ù‡Ø§ØªÙ: ${phone}\n`;
    if(city) msg += `Ø§Ù„Ù…Ø¯ÙŠÙ†Ø©: ${city}\n`;
    if(address) msg += `Ø§Ù„Ø¹Ù†ÙˆØ§Ù†: ${address}\n`;
    if(notes) msg += `Ù…Ù„Ø§Ø­Ø¸Ø§Øª: ${notes}\n`;

    return `https://wa.me/${waTo}?text=${encodeURIComponent(msg.trim())}`;
  }

  function openCart(){
    renderCart();
    document.getElementById("cartModal").classList.add("open");
  }
  function closeCart(){
    document.getElementById("cartModal").classList.remove("open");
  }

  function renderCart(){
    const body = document.getElementById("cartBody");
    const items = getCart();

    body.innerHTML = "";
    if(!items.length){
      body.innerHTML = `<div class="small">Ø§Ù„Ø³Ù„Ø© ÙØ§Ø¶ÙŠØ©. Ø§Ø¶ØºØ· "Ø£Ø¶Ù Ù„Ù„Ø³Ù„Ø©" Ù…Ù† ØµÙØ­Ø© Ø£ÙŠ Ù…Ù†ØªØ¬.</div>`;
      document.getElementById("cartSummary").textContent = `0 Ù…Ù†ØªØ¬`;
      updateCartBadge();
      const waTo = normalizePhone(qs("to") || DEFAULT_WA_TO);
      document.getElementById("btnWAFromCart").href = buildWAFromCart(waTo);
      return;
    }

    let totalQty = 0;
    items.forEach((it, index) => {
      totalQty += (parseInt(it.qty||1,10) || 1);

      const row = document.createElement("div");
      row.className = "item";

      const img = document.createElement("img");
      img.className = "thumb";
      img.alt = it.code;
      img.src = it.img || "https://www.mad-parfumeur.com/assets/hero/logo2.webp";

      const main = document.createElement("div");
      main.className = "itemMain";

      const code = document.createElement("div");
      code.className = "itemCode";
      code.textContent = it.code;

      const meta = document.createElement("div");
      meta.className = "itemMeta";
      meta.textContent = [it.type, it.price ? (it.price + "â‚ª") : ""].filter(Boolean).join(" â€¢ ");

      const qtyRow = document.createElement("div");
      qtyRow.className = "qtyRow";

      const minus = document.createElement("button");
      minus.className = "qBtn";
      minus.textContent = "âˆ’";
      minus.onclick = () => {
        const c = getCart();
        c[index].qty = Math.max(1, (parseInt(c[index].qty||1,10)||1) - 1);
        setCart(c); renderCart();
      };

      const qv = document.createElement("div");
      qv.className = "qVal";
      qv.textContent = it.qty;

      const plus = document.createElement("button");
      plus.className = "qBtn";
      plus.textContent = "+";
      plus.onclick = () => {
        const c = getCart();
        c[index].qty = (parseInt(c[index].qty||1,10)||1) + 1;
        setCart(c); renderCart();
      };

      const del = document.createElement("button");
      del.className = "delBtn";
      del.textContent = "Ø­Ø°Ù";
      del.onclick = () => {
        const c = getCart();
        c.splice(index, 1);
        setCart(c); renderCart();
      };

      qtyRow.appendChild(minus);
      qtyRow.appendChild(qv);
      qtyRow.appendChild(plus);

      main.appendChild(code);
      main.appendChild(meta);
      main.appendChild(qtyRow);

      row.appendChild(img);
      row.appendChild(main);
      row.appendChild(del);

      body.appendChild(row);
    });

    document.getElementById("cartSummary").textContent = `${items.length} Ù…Ù†ØªØ¬ â€¢ Ù…Ø¬Ù…ÙˆØ¹ Ø§Ù„ÙƒÙ…ÙŠØ©: ${totalQty}`;
    updateCartBadge();

    const waTo = normalizePhone(qs("to") || DEFAULT_WA_TO);
    document.getElementById("btnWAFromCart").href = buildWAFromCart(waTo);
  }

  async function load(){
    const codeParam = qs("code");
    const waTo = normalizePhone(qs("to") || DEFAULT_WA_TO);

    updateCartBadge();

    document.getElementById("openCart").onclick = openCart;
    document.getElementById("closeCart").onclick = closeCart;
    document.getElementById("cartModal").addEventListener("click", (e)=>{
      if(e.target.id === "cartModal") closeCart();
    });
    document.getElementById("clearCart").onclick = ()=>{
      setCart([]);
      renderCart();
      updateCartBadge();
    };

    // WA from main button always sends cart (not only single product)
    const refreshWAButtons = ()=>{
      document.getElementById("btnWA").href = buildWAFromCart(waTo);
      document.getElementById("btnWAFromCart").href = buildWAFromCart(waTo);
    };

    ["name","phone","city","address","notes"].forEach(id=>{
      const el = document.getElementById(id);
      if(!el) return;
      el.addEventListener("input", refreshWAButtons);
      el.addEventListener("change", refreshWAButtons);
    });

    refreshWAButtons();

    if(!codeParam){
      document.getElementById("card").innerHTML =
        `<div class="err">Ù„Ø§Ø²Ù… ØªØ­Ø· ÙƒÙˆØ¯ Ø§Ù„Ù…Ù†ØªØ¬ Ø¨Ø§Ù„Ø±Ø§Ø¨Ø· Ù…Ø«Ù„: <code>p.html?code=W.181</code></div>`;
      return;
    }

    document.getElementById("pill").textContent = `Code: ${codeParam}`;

    const res = await fetch(CSV_URL + "?v=" + Date.now(), {cache:"no-store"});
    if(!res.ok){
      document.getElementById("card").innerHTML =
        `<div class="err">Ù…Ø´ Ù‚Ø§Ø¯Ø± Ø£ÙØªØ­ <code>${CSV_URL}</code> â€” ØªØ£ÙƒØ¯ Ø¥Ù†Ù‡ Ù…ÙˆØ¬ÙˆØ¯ Ø¨Ø¬Ø°Ø± Ø§Ù„Ù…ÙˆÙ‚Ø¹.</div>`;
      return;
    }

    const text = await res.text();
    const rows = parseCSV(text).filter(r => r.some(c => String(c||"").trim() !== ""));
    const headers = rows.shift().map(h => String(h||"").trim());

    const I_CODE  = idxOf(headers, "PRODUCT CODE");
    const I_LINK  = idxOf(headers, "LINK");
    const I_DESC  = idxOf(headers, "DESC_AR");
    const I_PRICE = idxOf(headers, "PRICE");
    const I_TYPE  = idxOf(headers, "PRODUCT TYPE");
    const I_NAME  = idxOf(headers, "FRAG_MATCH_NAME");
    const I_IMG   = idxOf(headers, "IMAGE_LINK"); // Ø§Ø­ØªÙŠØ§Ø·ÙŠ ÙÙ‚Ø·

    const data = rows.filter(r => safe(val(r, I_CODE)) !== "");
    const found = data.find(r => safe(val(r, I_CODE)).toLowerCase() === codeParam.toLowerCase());

    if(!found){
      document.getElementById("card").innerHTML =
        `<div class="err">Ù…Ø´ Ù„Ø§Ù‚ÙŠ Ø§Ù„Ù…Ù†ØªØ¬: <code>${codeParam}</code><br>ØªØ£ÙƒØ¯ Ø¥Ù† Ø§Ù„ÙƒÙˆØ¯ Ù…ÙˆØ¬ÙˆØ¯ Ø¨Ø§Ù„Ù€ p.csv.</div>`;
      return;
    }

    const pCode = safe(val(found, I_CODE));
    const pLink = safe(val(found, I_LINK));
    const pDesc = safe(val(found, I_DESC)) || "Ø§Ø¶ØºØ· Ø£Ø¶Ù Ù„Ù„Ø³Ù„Ø© Ø£Ùˆ Ø£ÙƒÙ…Ù„ Ø§Ù„Ø·Ù„Ø¨ Ø¹Ù„Ù‰ ÙˆØ§ØªØ³Ø§Ø¨.";
    const pPrice= safe(val(found, I_PRICE));
    const pType = safe(val(found, I_TYPE));
    const pName = safe(val(found, I_NAME));
    const pImgCsv = safe(val(found, I_IMG));

    document.title = `${pCode} | MAD`;
    document.getElementById("title").textContent = pName ? `${pCode} â€” ${pName}` : pCode;
    document.getElementById("meta").textContent =
      [pType, pPrice ? (pPrice + "â‚ª") : ""].filter(Boolean).join(" â€¢ ");
    document.getElementById("desc").textContent = pDesc;

    // âœ… Ø§Ù„ØµÙˆØ±Ø© Ø§Ù„Ø¹Ø§Ù„ÙŠØ©: Ù…Ù† Ù…ÙˆÙ‚Ø¹Ùƒ Ø­Ø³Ø¨ Ø§Ù„ÙƒÙˆØ¯
    // Ù…Ø«Ø§Ù„: https://www.mad-parfumeur.com/img/W.181.webp
    const highImg = HIGH_IMG_BASE + encodeURIComponent(pCode) + ".webp";

    // fallback: Ø¥Ø°Ø§ Ù…Ø§ Ù„Ù‚Ø§Ù‡Ø§ØŒ ÙŠØ¬Ø±Ø¨ IMAGE_LINK Ù…Ù† CSV
    const imgEl = document.getElementById("img");
    imgEl.src = highImg;
    imgEl.onerror = () => {
      imgEl.onerror = null;
      imgEl.src = pImgCsv || "https://www.mad-parfumeur.com/assets/hero/logo2.webp";
    };

    document.getElementById("btnView").href = pLink || "https://madperfume.co.il/";

    // Add to cart
    document.getElementById("btnAdd").onclick = ()=>{
      const qty = Math.max(1, parseInt(document.getElementById("qty").value || "1", 10));
      const cart = getCart();

      const existing = cart.find(it => (it.code||"").toLowerCase() === pCode.toLowerCase());
      const item = {
        code: pCode,
        qty: qty,
        price: pPrice,
        type: pType,
        link: pLink,
        img: highImg
      };

      if(existing){
        existing.qty = (parseInt(existing.qty||1,10)||1) + qty;
      } else {
        cart.push(item);
      }

      setCart(cart);
      updateCartBadge();
      renderCart();
      // ØªØ­Ø¯ÙŠØ« Ø±ÙˆØ§Ø¨Ø· WA
      document.getElementById("btnWA").href = buildWAFromCart(waTo);
      document.getElementById("btnWAFromCart").href = buildWAFromCart(waTo);
      openCart();
    };

    // ØªØ­Ø¯ÙŠØ« Ø±ÙˆØ§Ø¨Ø· ÙˆØ§ØªØ³Ø§Ø¨ Ø£ÙˆÙ„ Ø¨Ø£ÙˆÙ„
    document.getElementById("qty").addEventListener("input", refreshWAButtons);
    document.getElementById("qty").addEventListener("change", refreshWAButtons);

    refreshWAButtons();
  }

  load().catch(err=>{
    document.getElementById("card").innerHTML = `<div class="err">Ø®Ø·Ø£: ${String(err.message||err)}</div>`;
  });
</script>
</body>
</html>
