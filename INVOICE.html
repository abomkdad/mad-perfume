<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Enterprise Commercial Invoice - Pro Stamp & Currency</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2pdf.js/0.10.1/html2pdf.bundle.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    
    <style>
        body { font-family: 'Helvetica Neue', 'Helvetica', Arial, sans-serif; color: #222; background-color: #eef2f5; margin: 0; padding: 20px; }
        
        .controls { max-width: 900px; margin: 0 auto 20px auto; background: #fff; padding: 15px; border-radius: 8px; box-shadow: 0 4px 10px rgba(0,0,0,0.08); display: flex; flex-wrap: wrap; gap: 10px; align-items: center; }
        .controls button, .controls label.file-btn { background-color: #004080; color: white; border: none; padding: 10px 15px; border-radius: 4px; cursor: pointer; font-size: 14px; transition: 0.3s; font-weight: bold; }
        .controls button:hover, .controls label.file-btn:hover { background-color: #00264d; }
        .controls input[type="file"] { display: none; }
        .controls .lang-toggle { background-color: #218838; }
        .controls .lang-toggle:hover { background-color: #1e7e34; }
        .controls .add-col-btn { background-color: #fd7e14; }
        .controls .add-col-btn:hover { background-color: #e86e04; }

        /* ÿ¥ÿ±Ÿäÿ∑ ÿ™ÿ≠ÿ¨ŸäŸÖ ÿßŸÑÿÆÿ™ŸÖ */
        .stamp-resizer { display: none; align-items: center; gap: 10px; background: #f8f9fa; padding: 5px 15px; border-radius: 5px; border: 1px solid #ccc;}
        .stamp-resizer input { cursor: pointer; }

        .invoice-box { max-width: 900px; margin: auto; padding: 40px; background-color: #fff; box-shadow: 0 0 15px rgba(0, 0, 0, 0.1); }
        .header { display: flex; justify-content: space-between; margin-bottom: 30px; border-bottom: 3px solid #004080; padding-bottom: 20px; }
        .header h1 { margin: 0; font-size: 32px; color: #004080; letter-spacing: 1px;}
        .invoice-details p { margin: 5px 0; text-align: right; font-size: 15px;}
        .company-info { display: flex; justify-content: space-between; margin-bottom: 30px; }
        .company-info div { width: 48%; }
        .company-info h3 { border-bottom: 2px solid #eee; padding-bottom: 5px; color: #444; text-transform: uppercase; font-size: 16px;}
        .company-info p { margin: 5px 0; font-size: 14px; color: #333;}
        
        table { width: 100%; border-collapse: collapse; margin-bottom: 20px; }
        table th, table td { padding: 12px 10px; border: 1px solid #ddd; text-align: left; font-size: 14px; }
        table th { background-color: #f8f9fa; color: #333; font-weight: bold; }
        .right { text-align: right; }
        
        td[contenteditable="true"], th[contenteditable="true"], span[contenteditable="true"] { outline: none; transition: background 0.2s; }
        td[contenteditable="true"]:hover, th[contenteditable="true"]:hover, span[contenteditable="true"]:hover { background-color: #f1f8ff; border-bottom: 1px dashed #004080; }
        
        .totals-wrapper { display: flex; justify-content: space-between; margin-top: 30px; margin-bottom: 20px; page-break-inside: avoid; align-items: center;}
        
        /* ŸÖÿ±ÿ®ÿπ ÿßŸÑÿÆÿ™ŸÖ */
        .stamp-box { width: 40%; text-align: center; min-height: 120px; border: 2px dashed #bbb; display: flex; align-items: center; justify-content: center; position: relative;}
        .stamp-box img { width: 150px; /* ÿßŸÑÿ≠ÿ¨ŸÖ ÿßŸÑÿßŸÅÿ™ÿ±ÿßÿ∂Ÿä */ max-width: 100%; object-fit: contain; display: none; }
        
        .totals { width: 45%; }
        .totals table { border: none; }
        .totals table td, .totals table th { border: none; border-bottom: 1px solid #eee; padding: 10px;}
        .totals table tr:last-child th, .totals table tr:last-child td { border-bottom: 3px solid #004080; font-weight: bold; font-size: 18px; color: #004080; background: #f8f9fa;}
        
        .bank-details { padding: 20px; background-color: #f8f9fa; border-left: 5px solid #004080; page-break-inside: avoid;}
        .bank-details p { margin: 5px 0; font-size: 14px; color: #444;}

        .delete-btn { color: #dc3545; cursor: pointer; font-weight: bold; border: none; background: none; font-size: 16px;}

        @media print {
            .controls, .delete-btn, .no-print { display: none !important; }
            body { background-color: #fff; padding: 0; }
            .invoice-box { box-shadow: none; padding: 0; border: none; max-width: 100%;}
            .stamp-box { border: none; }
            .stamp-text { display: none; }
            .totals table tr:last-child td { background: transparent !important; }
        }

        thead { display: table-header-group; }
        tfoot { display: table-footer-group; }
        tr { page-break-inside: avoid; page-break-after: auto; }
        td { page-break-inside: avoid; page-break-after: auto; }
    </style>
</head>
<body>

<div class="controls no-print">
    <button onclick="addRow()">+ Add Row / ÿ≥ÿ∑ÿ± ÿ¨ÿØŸäÿØ</button>
    <button class="add-col-btn" onclick="addColumn()">+ Add Column / ÿ•ÿ∂ÿßŸÅÿ© ÿπŸÖŸàÿØ</button>
    
    <label class="file-btn">
        Import Raw Excel / ÿßÿ≥ÿ™Ÿäÿ±ÿßÿØ ÿßŸÑŸÖŸÑŸÅ
        <input type="file" id="excelUpload" accept=".xlsx, .xls, .csv" onchange="importExcel(event)">
    </label>
    
    <label class="file-btn">
        Add Stamp / ÿ•ÿ∂ÿßŸÅÿ© ÿÆÿ™ŸÖ
        <input type="file" id="stampUpload" accept="image/*" onchange="addStamp(event)">
    </label>

    <div class="stamp-resizer" id="stamp-resizer-container">
        <label style="font-size: 13px; font-weight: bold;">Stamp Size:</label>
        <input type="range" id="stamp-slider" min="50" max="350" value="150" oninput="resizeStamp(this.value)">
    </div>

    <button class="lang-toggle" onclick="toggleLanguage()">üáπüá∑ / üá¨üáß Language</button>
    <button onclick="exportPDF()" style="background-color: #dc3545; margin-left: auto; font-size: 15px;">üìÑ Export Enterprise PDF</button>
</div>

<div class="invoice-box" id="invoice">
    <div class="header">
        <div>
            <h1 id="lbl-title">COMMERCIAL INVOICE</h1>
        </div>
        <div class="invoice-details">
            <p><strong id="lbl-inv-no">Invoice No:</strong> <span contenteditable="true">UGR2026000000001</span></p>
            <p><strong id="lbl-date">Date:</strong> <span contenteditable="true">11.02.2026</span></p>
            <p><strong id="lbl-currency">Currency:</strong> <span contenteditable="true">USD ($)</span></p>
        </div>
    </div>

    <div class="company-info">
        <div>
            <h3 id="lbl-seller">Seller</h3>
            <p><strong contenteditable="true">UGUR SAHIN TEKSTIL ITHALAT IHRACAT LTD STI</strong></p>
            <p contenteditable="true">Basaksehir Mah. Toros Cad.</p>
            <p contenteditable="true">Arterium AVC No 1 /81</p>
            <p contenteditable="true">Basaksehir / Istanbul - Turkey</p>
            <p><strong id="lbl-tax">Tax No:</strong> <span contenteditable="true">8860874431</span></p>
        </div>
        <div>
            <h3 id="lbl-buyer">Buyer</h3>
            <p><strong contenteditable="true">MAD PERFUME LTD</strong></p>
            <p contenteditable="true">Almadena 80</p>
            <p contenteditable="true">Um Alfahem - Israel</p>
            <p><strong id="lbl-vat">VAT:</strong> <span contenteditable="true">515456093</span></p>
            <p><strong id="lbl-tel">Tel:</strong> <span contenteditable="true">00972525105889</span></p>
        </div>
    </div>

    <table id="invoice-table">
        <thead id="table-head">
            <tr>
                <th contenteditable="true">Description of Goods</th>
                <th contenteditable="true" class="right">Unit</th>
                <th contenteditable="true" class="right">Quantity</th>
                <th contenteditable="true" class="right">Unit Price</th>
                <th contenteditable="true" class="right">Amount (USD)</th>
                <th class="no-print">‚úñ</th>
            </tr>
        </thead>
        <tbody id="table-body">
            </tbody>
    </table>

    <div class="totals-wrapper">
        <div class="stamp-box" id="stamp-container">
            <span class="stamp-text no-print" style="color:#999; font-weight:bold;">Click to Upload Stamp / Signature</span>
            <img id="stamp-img" src="" alt="Stamp">
        </div>
        <div class="totals">
            <table>
                <tr>
                    <th id="lbl-total-qty">Total Quantity:</th>
                    <td class="right"><span id="total-qty">0</span></td>
                </tr>
                <tr>
                    <th id="lbl-total-amount">Total Amount:</th>
                    <td class="right"><strong style="color: #004080; font-size: 20px;" id="total-amount">$ 0.00</strong></td>
                </tr>
            </table>
        </div>
    </div>

    <div class="bank-details">
        <h4 id="lbl-bank-title" style="margin-top:0; color:#004080; font-size:16px;">Bank Details</h4>
        <p><strong id="lbl-bank-name">Bank Name:</strong> <span contenteditable="true">T√úRKƒ∞YE EMLAK KATILIM BANKASI</span></p>
        <p><strong id="lbl-branch">Branch:</strong> <span contenteditable="true">MERTER</span></p>
    </div>
</div>

<script>
    window.onload = () => { addRow(); };

    // ŸÅŸÑÿ™ÿ±ÿ© ÿßŸÑÿ£ÿ±ŸÇÿßŸÖ ŸÑÿ∂ŸÖÿßŸÜ ÿ≠ÿ≥ÿßÿ®Ÿáÿß ÿ≠ÿ™Ÿâ ŸÑŸà ŸÉÿ™ÿ® ÿßŸÑŸÖÿ≥ÿ™ÿÆÿØŸÖ $ ÿ£Ÿà ŸÅŸàÿßÿµŸÑ
    function parseNumber(str) {
        if (!str) return 0;
        let numStr = String(str).replace(/[^0-9.-]+/g, ""); // Ÿäÿ≠ÿ∞ŸÅ ŸÉŸÑ ÿ¥Ÿäÿ° ÿπÿØÿß ÿßŸÑÿ£ÿ±ŸÇÿßŸÖ ŸàÿßŸÑŸÜŸÇÿßÿ∑
        return parseFloat(numStr) || 0;
    }

    function addRow() {
        const tbody = document.getElementById("table-body");
        const headers = document.querySelectorAll("#table-head th");
        const tr = document.createElement("tr");
        
        let html = "";
        for (let i = 0; i < headers.length - 1; i++) {
            let headerText = headers[i].innerText.toUpperCase();
            let cls = "right";
            let onInput = "";
            let defVal = "-";

            if (headerText.includes("QTY") || headerText.includes("QUANTITY")) {
                cls += " qty-cell"; onInput = `oninput="calculateRow(this)"`; defVal = "0";
            } else if (headerText.includes("PRICE")) {
                cls += " price-cell"; onInput = `oninput="calculateRow(this)"`; defVal = "$ 0.00";
            } else if (headerText.includes("AMOUNT") || headerText.includes("TOTAL")) {
                cls += " amount-cell"; defVal = "$ 0.00";
            } else if (i === 0 || headerText.includes("DESC")) {
                cls = ""; defVal = "New Item";
            }

            html += `<td contenteditable="true" class="${cls}" ${onInput}>${defVal}</td>`;
        }

        html += `<td class="no-print"><button class="delete-btn" onclick="deleteRow(this)">‚úñ</button></td>`;
        tr.innerHTML = html;
        tbody.appendChild(tr);
        calculateTotals();
    }

    function addColumn() {
        const colName = prompt("ÿ£ÿØÿÆŸÑ ÿßÿ≥ŸÖ ÿßŸÑÿπŸÖŸàÿØ ÿßŸÑÿ¨ÿØŸäÿØ:", "New Column");
        if (!colName) return;

        const theadTr = document.querySelector("#table-head tr");
        const newTh = document.createElement("th");
        newTh.innerText = colName;
        newTh.contentEditable = "true";
        newTh.className = "right";
        theadTr.insertBefore(newTh, theadTr.children[theadTr.children.length - 1]);

        document.querySelectorAll("#table-body tr").forEach(tr => {
            const newTd = document.createElement("td");
            newTd.contentEditable = "true";
            newTd.className = "right";
            newTd.innerText = "-";
            tr.insertBefore(newTd, tr.children[tr.children.length - 1]);
        });
    }

    function deleteRow(btn) { btn.closest("tr").remove(); calculateTotals(); }

    function calculateRow(element) {
        const tr = element.closest("tr");
        const qtyEl = tr.querySelector(".qty-cell");
        const priceEl = tr.querySelector(".price-cell");
        const amountEl = tr.querySelector(".amount-cell");

        if (qtyEl && priceEl && amountEl) {
            const qty = parseNumber(qtyEl.innerText);
            const price = parseNumber(priceEl.innerText);
            // ÿ•ÿ∂ÿßŸÅÿ© ÿ±ŸÖÿ≤ ÿßŸÑÿØŸàŸÑÿßÿ± $ ŸÑŸÑÿ≥ÿ∑ÿ±
            amountEl.innerText = "$ " + (qty * price).toLocaleString(undefined, {minimumFractionDigits: 2, maximumFractionDigits: 2});
        }
        calculateTotals();
    }

    function calculateTotals() {
        let totalQty = 0, totalAmount = 0;
        document.querySelectorAll("#table-body tr").forEach(tr => {
            const qtyEl = tr.querySelector(".qty-cell");
            const amountEl = tr.querySelector(".amount-cell");
            
            if (qtyEl) totalQty += parseNumber(qtyEl.innerText);
            if (amountEl) totalAmount += parseNumber(amountEl.innerText);
        });
        
        document.getElementById("total-qty").innerText = totalQty.toLocaleString();
        // ÿ•ÿ∂ÿßŸÅÿ© ÿ±ŸÖÿ≤ ÿßŸÑÿØŸàŸÑÿßÿ± $ ŸÑŸÑŸÖÿ¨ŸÖŸàÿπ ÿßŸÑŸÉŸÑŸä
        document.getElementById("total-amount").innerText = "$ " + totalAmount.toLocaleString(undefined, {minimumFractionDigits: 2, maximumFractionDigits: 2});
    }

    function importExcel(event) {
        const file = event.target.files[0];
        if (!file) return;
        const reader = new FileReader();
        reader.onload = function(e) {
            const data = new Uint8Array(e.target.result);
            const workbook = XLSX.read(data, {type: 'array'});
            const firstSheet = workbook.Sheets[workbook.SheetNames[0]];
            const jsonData = XLSX.utils.sheet_to_json(firstSheet, {header: 1, defval: ""});
            
            let headerRowIndex = -1;
            for (let i = 0; i < Math.min(30, jsonData.length); i++) {
                let row = jsonData[i];
                if (row) {
                    let nonEmptyCells = row.filter(cell => String(cell).trim() !== "").length;
                    if (nonEmptyCells > 1) { 
                        headerRowIndex = i;
                        break;
                    }
                }
            }

            if (headerRowIndex === -1) {
                alert("Ÿäÿ®ÿØŸà ÿ£ŸÜ ÿßŸÑŸÖŸÑŸÅ ŸÅÿßÿ±ÿ∫ ÿ£Ÿà ŸÑÿß Ÿäÿ≠ÿ™ŸàŸä ÿπŸÑŸâ ÿ£ÿπŸÖÿØÿ© Ÿàÿßÿ∂ÿ≠ÿ©.");
                return;
            }

            let headers = jsonData[headerRowIndex];
            let validCols = [];
            headers.forEach((h, index) => {
                let hStr = String(h).trim();
                if (hStr === "" && index < headers.length) hStr = "Col " + (index + 1);
                if (hStr !== "") validCols.push({ index: index, name: hStr });
            });

            let theadHTML = "";
            validCols.forEach((col, i) => {
                theadHTML += `<th contenteditable="true" class="${i===0 ? '' : 'right'}">${col.name}</th>`;
            });
            theadHTML += `<th class="no-print">‚úñ</th>`;
            document.querySelector("#table-head").innerHTML = `<tr>${theadHTML}</tr>`;

            const tbody = document.getElementById("table-body");
            tbody.innerHTML = "";

            for (let i = headerRowIndex + 1; i < jsonData.length; i++) {
                let row = jsonData[i];
                if (!row || row.join("").trim() === "") continue;

                const tr = document.createElement("tr");
                let trHTML = "";
                
                validCols.forEach((col, index) => {
                    let cellValue = row[col.index] || "";
                    let upperName = col.name.toUpperCase();
                    let cls = index === 0 ? "" : "right"; 
                    let onInput = "";

                    if (upperName.includes("QTY") || upperName.includes("QUANTITY")) {
                        cls += " qty-cell"; onInput = `oninput="calculateRow(this)"`;
                    } else if (upperName.includes("PRICE")) {
                        cls += " price-cell"; onInput = `oninput="calculateRow(this)"`;
                        if(cellValue && !String(cellValue).includes('$')) cellValue = "$ " + parseNumber(cellValue).toFixed(2);
                    } else if (upperName.includes("AMOUNT") || upperName.includes("TOTAL")) {
                        cls += " amount-cell";
                        if(cellValue && !String(cellValue).includes('$')) cellValue = "$ " + parseNumber(cellValue).toFixed(2);
                    }

                    trHTML += `<td contenteditable="true" class="${cls}" ${onInput}>${cellValue}</td>`;
                });

                trHTML += `<td class="no-print"><button class="delete-btn" onclick="deleteRow(this)">‚úñ</button></td>`;
                tr.innerHTML = trHTML;
                tbody.appendChild(tr);
            }

            calculateTotals();
        };
        reader.readAsArrayBuffer(file);
    }

    // Ÿàÿ∏ÿßÿ¶ŸÅ ÿßŸÑÿÆÿ™ŸÖ ŸàÿßŸÑÿ™ÿ≠ÿ¨ŸäŸÖ
    function addStamp(event) {
        const file = event.target.files[0];
        if (file) {
            const reader = new FileReader();
            reader.onload = function(e) {
                document.getElementById('stamp-img').src = e.target.result;
                document.getElementById('stamp-img').style.display = 'block';
                document.querySelector('.stamp-text').style.display = 'none';
                
                // ÿ•ÿ∏Ÿáÿßÿ± ÿ¥ÿ±Ÿäÿ∑ ÿßŸÑÿ™ÿ≠ÿ¨ŸäŸÖ ÿ®ÿπÿØ ÿ±ŸÅÿπ ÿßŸÑÿÆÿ™ŸÖ
                document.getElementById('stamp-resizer-container').style.display = 'flex';
            }
            reader.readAsDataURL(file);
        }
    }

    function resizeStamp(size) {
        document.getElementById('stamp-img').style.width = size + "px";
    }

    function exportPDF() {
        const element = document.getElementById('invoice');
        const opt = {
            margin:       [0.5, 0.5, 0.8, 0.5],
            filename:     'Commercial_Invoice.pdf',
            image:        { type: 'jpeg', quality: 1 },
            html2canvas:  { scale: 2, useCORS: true },
            jsPDF:        { unit: 'in', format: 'A4', orientation: 'portrait' },
            pagebreak:    { mode: ['avoid-all', 'css', 'legacy'] }
        };
        
        document.querySelectorAll('.no-print').forEach(el => el.style.display = 'none');
        
        html2pdf().set(opt).from(element).toPdf().get('pdf').then(function (pdf) {
            const totalPages = pdf.internal.getNumberOfPages();
            const pageWidth = pdf.internal.pageSize.getWidth();
            const pageHeight = pdf.internal.pageSize.getHeight();
            
            for (let i = 1; i <= totalPages; i++) {
                pdf.setPage(i);
                pdf.setFontSize(10);
                pdf.setTextColor(120);
                pdf.setDrawColor(200);
                pdf.setLineWidth(0.01);
                pdf.line(0.5, pageHeight - 0.6, pageWidth - 0.5, pageHeight - 0.6);
                
                const text = `Page ${i} of ${totalPages}`;
                const textWidth = pdf.getStringUnitWidth(text) * pdf.internal.getFontSize() / pdf.internal.scaleFactor;
                pdf.text(text, pageWidth - textWidth - 0.5, pageHeight - 0.4);
                pdf.text("UGUR SAHIN TEKSTIL LTD STI", 0.5, pageHeight - 0.4);
            }
        }).save().then(() => {
            document.querySelectorAll('.no-print').forEach(el => el.style.display = '');
        });
    }

    const translations = {
        en: { title: "COMMERCIAL INVOICE", invNo: "Invoice No:", date: "Date:", currency: "Currency:", seller: "Seller", buyer: "Buyer", tax: "Tax No:", vat: "VAT:", tel: "Tel:", totalQty: "Total Quantity:", totalAmount: "Total Amount:", bankTitle: "Bank Details", bankName: "Bank Name:", branch: "Branch:" },
        tr: { title: "Tƒ∞CARƒ∞ FATURA", invNo: "Fatura No:", date: "Tarih:", currency: "Para Birimi:", seller: "Satƒ±cƒ±", buyer: "Alƒ±cƒ±", tax: "Vergi No:", vat: "KDV No:", tel: "Tel:", totalQty: "Toplam Miktar:", totalAmount: "Toplam Tutar:", bankTitle: "Banka Bilgileri", bankName: "Banka Adƒ±:", branch: "≈ûube:" }
    };

    let currentLang = 'en';
    function toggleLanguage() {
        currentLang = currentLang === 'en' ? 'tr' : 'en';
        const t = translations[currentLang];
        document.getElementById("lbl-title").innerText = t.title;
        document.getElementById("lbl-inv-no").innerText = t.invNo;
        document.getElementById("lbl-date").innerText = t.date;
        document.getElementById("lbl-currency").innerText = t.currency;
        document.getElementById("lbl-seller").innerText = t.seller;
        document.getElementById("lbl-buyer").innerText = t.buyer;
        document.getElementById("lbl-tax").innerText = t.tax;
        document.getElementById("lbl-vat").innerText = t.vat;
        document.getElementById("lbl-tel").innerText = t.tel;
        document.getElementById("lbl-total-qty").innerText = t.totalQty;
        document.getElementById("lbl-total-amount").innerHTML = `<strong style="color: #004080; font-size: 20px;">$ ${parseNumber(document.getElementById("total-amount").innerText).toLocaleString(undefined, {minimumFractionDigits: 2, maximumFractionDigits: 2})}</strong>`;
        document.getElementById("lbl-bank-title").innerText = t.bankTitle;
        document.getElementById("lbl-bank-name").innerText = t.bankName;
        document.getElementById("lbl-branch").innerText = t.branch;
    }
</script>

</body>
</html>
