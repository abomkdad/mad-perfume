<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>MAD Builder V54 - FINAL âœ… (Images + Pixels + E.164 Fix)</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <script src="https://unpkg.com/lucide@latest" defer></script>
  <script src="https://unpkg.com/alpinejs@3.x.x/dist/cdn.min.js" defer></script>
  <style>
    @import url('https://fonts.googleapis.com/css2?family=Amiri:wght@400;700&family=Cairo:wght@200..1000&family=Tajawal:wght@200..900&display=swap');
    [x-cloak]{display:none!important}
    body{font-family:'Cairo',sans-serif;background:#e2e8f0;height:100vh;overflow:hidden}
    .app-layout{display:flex;height:100vh;flex-direction:row-reverse}
    .editor-sidebar{width:400px;background:#fff;border-left:1px solid #cbd5e1;overflow-y:auto;padding:15px;flex-shrink:0;box-shadow:-5px 0 15px rgba(0,0,0,.05)}
    .preview-area{flex:1;background:#f1f5f9;display:flex;flex-direction:column;align-items:center;justify-content:center;position:relative}
    .iphone{width:375px;height:750px;background:#000;border-radius:40px;border:12px solid #2d2d2d;overflow:hidden;position:relative;box-shadow:0 25px 50px -12px rgba(0,0,0,.5);background-color:#fff;transition:transform .2s}
    .iphone iframe{width:100%;height:100%;border:none;background:#fff}
    .section-box{background:#f8fafc;border:1px solid #e2e8f0;border-radius:8px;padding:10px;margin-bottom:10px}
    .section-title{font-weight:900;font-size:.8rem;color:#475569;margin-bottom:5px;display:block}
    input,textarea,select{width:100%;padding:6px;border:1px solid #cbd5e1;border-radius:6px;font-size:11px;outline:none;transition:.2s}
    input:focus{border-color:#3b82f6;box-shadow:0 0 0 2px rgba(59,130,246,.1)}
    .btn-grid{display:grid;grid-template-columns:repeat(3,1fr);gap:5px}
    .btn-add{background:#fff;border:1px solid #cbd5e1;padding:8px;border-radius:6px;font-size:10px;font-weight:bold;cursor:pointer;display:flex;align-items:center;justify-content:center;gap:3px;transition:.2s}
    .btn-add:hover{background:#f1f5f9;border-color:#94a3b8}
    .btn-action{width:100%;padding:10px;border-radius:8px;font-weight:800;margin-top:5px;cursor:pointer;text-align:center;font-size:.9rem}
    .zoom-controls{position:fixed;bottom:20px;left:50%;transform:translateX(-50%);background:rgba(0,0,0,.8);padding:5px 15px;border-radius:99px;display:flex;gap:10px;color:#fff;z-index:50;align-items:center;font-size:12px}
  </style>
</head>
<body>

<div class="app-layout" x-data="builderApp()" x-init="init()" x-cloak>
  <aside class="editor-sidebar">
    <h1 class="text-xl font-black mb-4 text-center text-slate-800">
      MAD BUILDER <span class="text-blue-600">V54 FINAL</span>
    </h1>

    <div class="flex bg-slate-100 p-1 rounded-lg mb-4">
      <button @click="editLang='ar'; update()" :class="editLang==='ar'?'bg-white shadow text-black':'text-gray-500'" class="flex-1 py-1.5 rounded text-xs font-bold transition">Ø¹Ø±Ø¨ÙŠ</button>
      <button @click="editLang='he'; update()" :class="editLang==='he'?'bg-white shadow text-black':'text-gray-500'" class="flex-1 py-1.5 rounded text-xs font-bold transition">×¢×‘×¨×™×ª</button>
    </div>

    <div class="section-box border-green-200 bg-green-50/50">
      <span class="section-title text-green-700">ğŸ’° Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª Ø§Ù„Ù…Ù†ØªØ¬ (VSA)</span>
      <div class="flex gap-2">
        <input type="text" x-model="config.productName" @input="update()" placeholder="Ø§Ø³Ù… Ø§Ù„Ù…Ù†ØªØ¬ (Content ID)">
        <input type="number" x-model="config.price" @input="update()" placeholder="Ø§Ù„Ø³Ø¹Ø±" class="w-1/3">
      </div>
    </div>

    <div class="section-box border-blue-200 bg-blue-50/50">
      <span class="section-title text-blue-700">ğŸ”— Ø§Ù„Ø±Ø¨Ø· ÙˆØ§Ù„Ù…Ø¯ÙŠØ±</span>
      <input type="text" x-model="config.sheetUrl" class="mb-2 font-mono" placeholder="Script URL" @input="update()">
      <input type="text" x-model="config.adminPhone" class="text-center font-bold" placeholder="Ø±Ù‚Ù… Ø§Ù„Ù…Ø¯ÙŠØ±" @input="update()">
      <p class="text-[10px] text-gray-500 mt-2">ÙŠÙØ¶Ù„ Ø±Ù‚Ù… Ø¯ÙˆÙ„ÙŠ: 9725xxxxxxx / 9705xxxxxxx</p>
    </div>

    <div class="section-box bg-slate-50 border-slate-300">
      <span class="section-title">ğŸ“Š Ø§Ù„Ø¨ÙŠÙƒØ³Ù„ (Ø­Ù…Ø§ÙŠØ© Ù‚ØµÙˆÙ‰ ğŸ›¡ï¸)</span>
      <div class="flex flex-col gap-2">
        <input type="text" x-model="config.fbPixel" placeholder="FB Pixel ID" @input="update()">
        <input type="text" x-model="config.ttPixel" placeholder="TikTok Pixel ID" @input="update()">
        <input type="text" x-model="config.snapPixel" placeholder="Snapchat Pixel ID" @input="update()">
      </div>
      <p class="text-[9px] text-gray-500 mt-1">Ù…Ù†Ø¹ Ø§Ù„ØªÙƒØ±Ø§Ø± + ØªØ­Ø³ÙŠÙ† Ø§Ù„Ù…Ø·Ø§Ø¨Ù‚Ø© Ø¨Ø§Ù„Ù‡Ø§ØªÙ (E.164) âœ…</p>
    </div>

    <div class="section-box">
      <span class="section-title">ğŸ¨ Ø§Ù„Ù…Ø¸Ù‡Ø±</span>
      <div class="flex gap-2 mb-2 items-center">
        <input type="color" x-model="config.bgColor" @input="update()" class="h-8 w-8 rounded cursor-pointer p-0 border-0">
        <input type="text" x-model="config.logoUrl" @input="update()" placeholder="Ø±Ø§Ø¨Ø· Ø§Ù„Ø´Ø¹Ø§Ø±">
      </div>
      <input type="text" x-model="config.heroTitle[editLang]" @input="update()" placeholder="Ø§Ù„Ø¹Ù†ÙˆØ§Ù† Ø§Ù„Ø±Ø¦ÙŠØ³ÙŠ">
    </div>

    <div class="section-box">
      <span class="section-title">Ø§Ù„Ù…Ø­ØªÙˆÙ‰</span>

      <div class="space-y-2 mb-4">
        <template x-for="(block, index) in blocks" :key="block.id">
          <div class="bg-white border p-2 rounded relative group">
            <button @click="removeBlock(index)" class="absolute top-1 left-1 text-red-500 font-bold px-1 opacity-0 group-hover:opacity-100 transition">Ã—</button>

            <div class="flex justify-between mb-1 pl-6">
              <span class="text-[9px] bg-slate-100 px-2 rounded font-bold text-slate-500 uppercase" x-text="block.type"></span>
              <div class="flex gap-1">
                <button @click="moveBlock(index, -1)" class="text-xs text-gray-400 hover:text-black">â†‘</button>
                <button @click="moveBlock(index, 1)" class="text-xs text-gray-400 hover:text-black">â†“</button>
              </div>
            </div>

            <template x-if="block.type === 'text'">
              <div>
                <div class="flex flex-wrap gap-1 mb-1">
                  <input type="color" x-model="block.style.color" @input="update()" class="w-5 h-5 p-0 border-0 rounded cursor-pointer">
                  <select x-model="block.style.font" @change="update()" class="w-16">
                    <option value="Cairo">Cairo</option>
                    <option value="Tajawal">Tajawal</option>
                  </select>
                  <select x-model="block.style.size" @change="update()" class="w-16">
                    <option value="text-sm">S</option><option value="text-lg">M</option><option value="text-2xl">L</option><option value="text-4xl">XL</option>
                  </select>
                  <select x-model="block.align" @change="update()" class="w-14">
                    <option value="center">C</option><option value="right">R</option>
                  </select>
                </div>
                <textarea x-model="block.content[editLang]" @input="update()" class="h-14"></textarea>
              </div>
            </template>

            <template x-if="block.type === 'offers_slider'">
              <div>
                <input type="text" x-model="block.title[editLang]" @input="update()" class="mb-2" placeholder="Ø¹Ù†ÙˆØ§Ù† Ø§Ù„Ù‚Ø³Ù…">
                <div class="flex gap-2 mb-2">
                  <select x-model="block.aspect" @change="update()" class="w-1/2 text-[10px]">
                    <option value="portrait">Ø·ÙˆÙ„ÙŠ</option>
                    <option value="square">Ù…Ø±Ø¨Ø¹</option>
                    <option value="landscape">Ø¹Ø±ÙŠØ¶</option>
                  </select>
                  <select x-model="block.fit" @change="update()" class="w-1/2 text-[10px]">
                    <option value="contain">Ø§Ø­ØªÙˆØ§Ø¡</option>
                    <option value="cover">Ù…Ù„Ø¡</option>
                  </select>
                </div>
                <template x-for="(offer, oIdx) in block.items" :key="oIdx">
                  <div class="bg-slate-50 p-1 mb-1 border flex gap-1 items-center">
                    <input x-model="offer.title[editLang]" @input="update()" class="flex-1" placeholder="Ø§Ø³Ù…">
                    <input x-model="offer.price" @input="update()" class="w-12 text-center" placeholder="Ø³Ø¹Ø±">
                    <input x-model="offer.img" @input="update()" class="w-1/3" placeholder="ØµÙˆØ±Ø©">
                    <button @click="block.items.splice(oIdx, 1); update()" class="text-red-500 font-bold px-1">x</button>
                  </div>
                </template>
                <button @click="block.items.push({img:'', title:{ar:'Ø¬Ø¯ÙŠØ¯',he:'×—×“×©'}, price:'100', link:'#'}); update()" class="w-full text-[10px] text-blue-600 bg-blue-50 py-1 rounded">+ Ø¥Ø¶Ø§ÙØ© Ø¹Ø±Ø¶</button>
              </div>
            </template>

            <template x-if="block.type === 'urgency_box'">
              <div class="flex gap-1">
                <input type="number" x-model="block.visitors" @input="update()" placeholder="Ø§Ù„Ø²ÙˆØ§Ø± (600)">
                <input type="number" x-model="block.left" @input="update()" placeholder="Ø¨Ø§Ù‚ÙŠ (8)">
                <input type="number" x-model="block.timerMinutes" @input="update()" placeholder="Ø¯Ù‚Ø§Ø¦Ù‚ (15)">
              </div>
            </template>

            <template x-if="block.type === 'form'">
              <div>
                <label>Ù†Øµ Ø²Ø± Ø§Ù„ØªØ£ÙƒÙŠØ¯</label>
                <input type="text" x-model="block.btnText[editLang]" @input="update()" class="text-center font-bold text-pink-600 border-pink-200">
              </div>
            </template>

            <!-- âœ… Image/Video/Iframe bind to url -->
            <template x-if="['image','video','iframe'].includes(block.type)">
              <textarea
                x-model="block.url"
                @input="update()"
                class="h-16 font-mono text-[10px]"
                :placeholder="block.type==='image' ? 'Ø±Ø§Ø¨Ø· Ø§Ù„ØµÙˆØ±Ø© (URL)' : (block.type==='video' ? 'Ø±Ø§Ø¨Ø· Ø§Ù„ÙÙŠØ¯ÙŠÙˆ (URL)' : 'Ø±Ø§Ø¨Ø· iframe (URL)')"
              ></textarea>
            </template>

            <template x-if="block.type==='embed'">
              <textarea x-model="block.content[editLang]" @input="update()" class="h-16 font-mono text-[10px]" placeholder="Ø¶Ø¹ ÙƒÙˆØ¯ HTML Ù‡Ù†Ø§"></textarea>
            </template>

            <template x-if="block.type === 'interactive_rating'">
              <input type="text" x-model="block.content[editLang]" @input="update()" placeholder="Ø¹Ù†ÙˆØ§Ù† Ø§Ù„Ø³Ø¤Ø§Ù„">
            </template>

            <template x-if="block.type === 'comparison'">
              <div>
                <div class="space-y-1 max-h-40 overflow-y-auto">
                  <template x-for="(row, rIdx) in block.items" :key="rIdx">
                    <div class="bg-slate-50 p-1 border rounded relative flex gap-1">
                      <input x-model="row.mad[editLang]" @input="update()" class="w-1/2 text-[9px]" placeholder="MAD">
                      <input x-model="row.other[editLang]" @input="update()" class="w-1/2 text-[9px]" placeholder="Other">
                      <button @click="block.items.splice(rIdx, 1); update()" class="text-red-500 font-bold text-[10px]">x</button>
                    </div>
                  </template>
                </div>
                <button @click="block.items.push({mad:{ar:'', he:''}, other:{ar:'', he:''}}); update()" class="text-[10px] text-blue-600 font-bold mt-1">+ Ø¥Ø¶Ø§ÙØ© Ø³Ø·Ø±</button>
              </div>
            </template>

            <template x-if="block.type === 'fragrantica'">
              <div class="flex gap-1">
                <select x-model="block.stars" @change="update()"><option value="5">5</option><option value="4">4</option></select>
                <input x-model="block.score" @input="update()" placeholder="Score">
                <input x-model="block.url" @input="update()" placeholder="Ø±Ø§Ø¨Ø· Fragrantica" class="font-mono">
              </div>
            </template>

            <template x-if="block.type === 'faq'">
              <div>
                <div class="space-y-1 max-h-40 overflow-y-auto">
                  <template x-for="(qa, i) in block.items" :key="i">
                    <div class="bg-slate-50 p-1 border rounded relative">
                      <button @click="block.items.splice(i, 1); update()" class="absolute top-1 left-1 text-red-500 text-[10px]">x</button>
                      <input x-model="qa.q[editLang]" @input="update()" class="w-full mb-1 text-[10px] font-bold" placeholder="Ø§Ù„Ø³Ø¤Ø§Ù„">
                      <textarea x-model="qa.a[editLang]" @input="update()" class="w-full h-8 text-[10px]" placeholder="Ø§Ù„Ø¬ÙˆØ§Ø¨"></textarea>
                    </div>
                  </template>
                </div>
                <button @click="block.items.push({q:{ar:'',he:''}, a:{ar:'',he:''}}); update()" class="w-full text-[10px] text-purple-600 bg-purple-50 py-1 rounded mt-1">+ Ø³Ø¤Ø§Ù„</button>
              </div>
            </template>

            <template x-if="block.type === 'gallery'">
              <div>
                <div class="flex gap-2 mb-2">
                  <select x-model="block.aspect" @change="update()" class="w-1/2 text-[10px]">
                    <option value="portrait">Ø·ÙˆÙ„ÙŠ</option>
                    <option value="square">Ù…Ø±Ø¨Ø¹</option>
                    <option value="landscape">Ø¹Ø±ÙŠØ¶</option>
                  </select>
                  <select x-model="block.fit" @change="update()" class="w-1/2 text-[10px]">
                    <option value="cover">Ù…Ù„Ø¡</option>
                    <option value="contain">Ø§Ø­ØªÙˆØ§Ø¡</option>
                  </select>
                </div>

                <div class="space-y-1 max-h-40 overflow-y-auto pr-1">
                  <template x-for="(img, idx) in (block.images||[])" :key="idx">
                    <div class="flex gap-1 mb-1">
                      <input type="text" x-model="block.images[idx]" @input="update()" placeholder="Ø±Ø§Ø¨Ø· Ø§Ù„ØµÙˆØ±Ø©..." class="w-full text-[10px]">
                      <button @click="block.images.splice(idx, 1); update()" class="text-red-500 font-bold text-xs px-1">x</button>
                    </div>
                  </template>
                </div>

                <button
                  @click="if((block.images||[]).length < 10){ block.images.push('https://via.placeholder.com/400x600'); update() } else { alert('Ø§Ù„Ø­Ø¯ Ø§Ù„Ø£Ù‚ØµÙ‰ 10 ØµÙˆØ±') }"
                  class="w-full text-[10px] text-sky-600 bg-sky-50 py-1 rounded mt-1"
                >+ Ø¥Ø¶Ø§ÙØ© ØµÙˆØ±Ø© (Ø­ØªÙ‰ 10)</button>
              </div>
            </template>

          </div>
        </template>
      </div>

      <div class="btn-grid">
        <button class="btn-add border-sky-500 bg-sky-100 text-sky-900 font-bold" @click="addBlock('gallery')">ğŸ“¸ ØµÙˆØ±</button>
        <button class="btn-add" @click="addBlock('text')">ğŸ“ Ù†Øµ</button>
        <button class="btn-add" @click="addBlock('image')">ğŸ–¼ï¸ ØµÙˆØ±Ø©</button>
        <button class="btn-add" @click="addBlock('video')">ğŸ¬ ÙÙŠØ¯ÙŠÙˆ</button>
        <button class="btn-add" @click="addBlock('iframe')">ğŸ§© Iframe</button>
        <button class="btn-add" @click="addBlock('form')">ğŸ“‹ ÙÙˆØ±Ù…</button>
        <button class="btn-add" @click="addBlock('offers_slider')">ğŸ›’ Ø³Ù„Ø§ÙŠØ¯Ø±</button>
        <button class="btn-add border-purple-500 bg-purple-100 text-purple-900 font-bold" @click="addBlock('faq')">â“ FAQ (6)</button>
        <button class="btn-add" @click="addBlock('urgency_box')">ğŸ”¥ Ø¶ØºØ·</button>
        <button class="btn-add" @click="addBlock('interactive_rating')">â­ ØªÙ‚ÙŠÙŠÙ…</button>
        <button class="btn-add" @click="addBlock('sales_pop')">ğŸ”” Ø¥Ø´Ø¹Ø§Ø±</button>
        <button class="btn-add border-amber-500 bg-amber-100 text-amber-900 font-bold" @click="addBlock('comparison')">âš–ï¸ Ù…Ù‚Ø§Ø±Ù†Ø© (6)</button>
        <button class="btn-add" @click="addBlock('fragrantica')">â­ Ø¢Ø±Ø§Ø¡</button>
        <button class="btn-add" @click="addBlock('embed')">ğŸ’» ÙƒÙˆØ¯</button>
      </div>
    </div>

    <button class="btn-action bg-black text-white" @click="downloadHTML()">ğŸ’¾ ØªØ­Ù…ÙŠÙ„ (Download)</button>
    <button class="btn-action bg-gray-600 text-white" @click="copyCode()">ğŸ“‹ Ù†Ø³Ø® (Copy)</button>
  </aside>

  <main class="preview-area">
    <div class="zoom-controls">
      <button @click="zoom=Math.max(0.3, zoom-0.1)">-</button>
      <span x-text="Math.round(zoom*100)+'%'"></span>
      <button @click="zoom=Math.min(1.2, zoom+0.1)">+</button>
      <button @click="update()" class="border-r border-white/30 pr-2 mr-2">ğŸ”„</button>
    </div>
    <div class="iphone" :style="`transform: scale(${zoom})`">
      <iframe id="preview-frame"></iframe>
    </div>
  </main>
</div>

<script>
function builderApp() {
  return {
    editLang: 'ar',
    zoom: 0.85,
    timeout: null,

    config: {
      bgColor: '#96701d',
      logoUrl: 'https://madperfume.ps/upload/01-2026/page/6977cf82b87ef.png',
      heroTitle: { ar: 'Ø£Ù‚ÙˆÙ‰ Ø§Ù„Ø¹Ø±ÙˆØ¶ Ø§Ù„Ø­ØµØ±ÙŠØ©', he: '×”××‘×¦×¢×™× ×”×—××™×' },
      productName: 'exotic oud',
      price: '400',
      adminPhone: '972525105889',
      sheetUrl: 'https://script.google.com/macros/s/AKfycbw7m6OCcTnH6CILpTo2TVRZIXXy5cui-zhKsCq3k491yaun5Hd5b_QECTjCrpCytkndDg/exec',
      fbPixel: '1072283127290819',
      ttPixel: 'D2D02JBC77U4ENLN9SBG',
      snapPixel: 'b143822e-1c3c-40ff-93f7-edadee74e626'
    },

    blocks: [
      { id: 1, type: 'text', content: { ar: 'ØªÙˆØµÙŠÙ„ Ù„Ø¬Ù…ÙŠØ¹ Ø§Ù„Ù…Ù†Ø§Ø·Ù‚', he: '××©×œ×•×— ×—×™× ×' }, align: 'center', style: { color: '#ffffff', size: 'text-lg', font: 'Cairo' } },
      { id: 1769632356116, type: 'urgency_box', sold: '860', left: '96', visitors: '735', timerMinutes: 44 },
      { id: 2, type: 'form', content: { ar: 'Ø§Ø·Ù„Ø¨ Ø§Ù„Ø¢Ù†', he: '×”×–××Ÿ ×¢×›×©×™×•' }, btnText: { ar: 'ØªØ£ÙƒÙŠØ¯ Ø§Ù„Ø·Ù„Ø¨', he: '×©×œ×— ×”×–×× ×”' }, align: 'center' }
    ],

    init() {
      // migrate old blocks that used content instead of url
      try {
        (this.blocks||[]).forEach(b=>{
          if((b.type==='image'||b.type==='video'||b.type==='iframe') && !b.url){
            if(typeof b.content==='string') b.url=b.content;
            else if(b.content && (b.content.ar||b.content.he)) b.url = b.content.ar || b.content.he;
          }
          if(b.type==='gallery' && !Array.isArray(b.images)) b.images=[];
          if(b.type==='offers_slider' && !Array.isArray(b.items)) b.items=[];
        });
      } catch(e){}

      setTimeout(()=> this.update(), 200);
      if (window.innerHeight < 900) this.zoom = 0.7;
    },

    update() {
      clearTimeout(this.timeout);
      this.timeout = setTimeout(() => {
        const frame = document.getElementById('preview-frame');
        if (frame) frame.srcdoc = this.generateFinalHTML(false);
      }, 250);
    },

    addBlock(type) {
      let block = { id: Date.now(), type, content: { ar: '', he: '' }, url: '', link: '#', align: 'center', style: { color: '#000', size: 'text-base', font: 'Cairo' } };

      if (type === 'form') block.btnText = { ar: 'ØªØ£ÙƒÙŠØ¯', he: '××™×©×•×¨' };

      if (type === 'offers_slider') {
        block.title = { ar: 'Ø¹Ø±ÙˆØ¶ Ø£Ø®Ø±Ù‰', he: '×¢×•×“ ××•×¦×¨×™×' };
        block.items = [];
        block.fit = 'contain';
        block.aspect = 'portrait';
      }

      if (type === 'gallery') {
        block.images = ['https://via.placeholder.com/400x600', 'https://via.placeholder.com/400x600/eee'];
        block.aspect = 'portrait';
        block.fit = 'cover';
      }

      if (type === 'urgency_box') { block.visitors = '600'; block.left = '8'; block.timerMinutes = 15; }
      if (type === 'interactive_rating') { block.content = { ar: 'Ù…Ø§ Ø±Ø£ÙŠÙƒØŸ', he: '××” ×“×¢×ª×š?' }; }
      if (type === 'sales_pop') { block.content = { ar: 'Ù…ÙØ¹Ù„', he: 'ON' }; }

      if (type === 'faq') {
        block.items = [
          { q: { ar: 'Ù‡Ù„ Ø§Ù„Ø¹Ø·ÙˆØ± Ø£ØµÙ„ÙŠØ©ØŸ', he: '×”×× ×”×‘×©××™× ××§×•×¨×™×™×?' }, a: { ar: 'Ù†Ø¹Ù…ØŒ Ø¬Ù…ÙŠØ¹ Ø¹Ø·ÙˆØ±Ù†Ø§ Ø£ØµÙ„ÙŠØ© 100% ÙˆÙ…ØµØ§Ø¯Ù‚ Ø¹Ù„ÙŠÙ‡Ø§.', he: '×›×Ÿ, ×›×œ ×”×‘×©××™× ×©×œ× ×• ××§×•×¨×™×™× ×‘-100% ×•×××•×©×¨×™×.' } },
          { q: { ar: 'ÙƒÙ… Ù…Ø¯Ø© Ø§Ù„ØªÙˆØµÙŠÙ„ØŸ', he: '××” ×–××Ÿ ×”××©×œ×•×—?' }, a: { ar: 'Ø§Ù„ØªÙˆØµÙŠÙ„ ÙŠØªÙ… Ø®Ù„Ø§Ù„ 1-3 Ø£ÙŠØ§Ù… Ø¹Ù…Ù„.', he: '×”××©×œ×•×— ××ª×‘×¦×¢ ×ª×•×š 1-3 ×™××™ ×¢×¡×§×™×.' } },
          { q: { ar: 'Ù‡Ù„ ÙŠÙ…ÙƒÙ† Ø§Ù„Ø¯ÙØ¹ Ø¹Ù†Ø¯ Ø§Ù„Ø§Ø³ØªÙ„Ø§Ù…ØŸ', he: '××¤×©×¨ ×œ×©×œ× ×‘×§×‘×œ×”?' }, a: { ar: 'Ù†Ø¹Ù…ØŒ Ù†ÙˆÙØ± Ø®Ø¯Ù…Ø© Ø§Ù„Ø¯ÙØ¹ Ø¹Ù†Ø¯ Ø§Ù„Ø§Ø³ØªÙ„Ø§Ù… (Ø§Ù„ÙƒØ§Ø´).', he: '×›×Ÿ, ×× ×• ××¦×™×¢×™× ×ª×©×œ×•× ×‘××–×•××Ÿ ×‘×¢×ª ×”××¡×™×¨×”.' } },
          { q: { ar: 'Ù‡Ù„ Ø§Ù„Ø±Ø§Ø¦Ø­Ø© Ø«Ø§Ø¨ØªØ©ØŸ', he: '×”×× ×”×¨×™×— ×¢××™×“?' }, a: { ar: 'Ù†Ø¹Ù…ØŒ ØªØ±ÙƒÙŠØ² Ø§Ù„Ø¹Ø·ÙˆØ± Ø¹Ø§Ù„ÙŠ Ù„Ø¶Ù…Ø§Ù† Ø§Ù„Ø«Ø¨Ø§Øª.', he: '×›×Ÿ, ×¨×™×›×•×– ×”×‘×©××™× ×’×‘×•×” ×œ×”×‘×˜×—×ª ×¢××™×“×•×ª.' } },
          { q: { ar: 'Ù…Ø§Ø°Ø§ Ù„Ùˆ Ù„Ù… ÙŠØ¹Ø¬Ø¨Ù†ÙŠ Ø§Ù„Ø¹Ø·Ø±ØŸ', he: '××” ×× ×œ× ××”×‘×ª×™?' }, a: { ar: 'ÙŠÙ…ÙƒÙ†Ùƒ Ø§Ù„ØªÙˆØ§ØµÙ„ Ù…Ø¹Ù†Ø§ Ù„Ø³ÙŠØ§Ø³Ø© Ø§Ù„Ø§Ø³ØªØ¨Ø¯Ø§Ù„.', he: '× ×™×ª×Ÿ ×œ×™×¦×•×¨ ×§×©×¨ ×œ××“×™× ×™×•×ª ×”×—×œ×¤×”.' } },
          { q: { ar: 'Ù‡Ù„ Ù„Ø¯ÙŠÙƒÙ… ÙØ±ÙˆØ¹ØŸ', he: '×™×© ×œ×›× ×¡× ×™×¤×™×?' }, a: { ar: 'Ù†Ø¹Ù…ØŒ Ù„Ø¯ÙŠÙ†Ø§ Ø¹Ø¯Ø© ÙØ±ÙˆØ¹.', he: '×›×Ÿ, ×™×© ×œ× ×• ××¡×¤×¨ ×¡× ×™×¤×™×.' } }
        ];
      }

      if (type === 'comparison') {
        block.items = [
          { mad: { ar: 'Ù…Ù†ØªØ¬Ø§Øª Ø£ØµÙ„ÙŠØ© ÙˆÙ‡ÙˆÙŠØ© ÙˆØ§Ø¶Ø­Ø©', he: '××•×¦×¨×™× ××§×•×¨×™×™× ×•×–×”×•×ª ×‘×¨×•×¨×”' }, other: { ar: 'Ù…Ù†ØªØ¬Ø§Øª Ù…Ø¬Ù‡ÙˆÙ„Ø© Ø§Ù„Ù…ØµØ¯Ø±', he: '××•×¦×¨×™× ×××§×•×¨ ×œ× ×™×“×•×¢' } },
          { mad: { ar: 'Ø«Ø¨Ø§Øª Ø¹Ø§Ù„ÙŠ ÙŠØ¯ÙˆÙ… Ø·ÙˆÙŠÙ„Ø§Ù‹', he: '×¢××™×“×•×ª ×’×‘×•×”×” ×œ××•×¨×š ×–××Ÿ' }, other: { ar: 'Ø±Ø§Ø¦Ø­Ø© ØªØ®ØªÙÙŠ Ø¨Ø³Ø±Ø¹Ø©', he: '×¨×™×— ×©× ×¢×œ× ××”×¨' } },
          { mad: { ar: 'Ù…ÙƒÙˆÙ†Ø§Øª Ø¢Ù…Ù†Ø© ÙˆÙ…Ø¹ØªÙ…Ø¯Ø© (IFRA)', he: '×¨×›×™×‘×™× ×‘×˜×•×—×™× ×•×××•×©×¨×™× (IFRA)' }, other: { ar: 'Ù…ÙƒÙˆÙ†Ø§Øª Ø±Ø®ÙŠØµØ© Ù‚Ø¯ ØªØ³Ø¨Ø¨ Ø­Ø³Ø§Ø³ÙŠØ©', he: '×¨×›×™×‘×™× ×–×•×œ×™× ×©×¢×œ×•×œ×™× ×œ×’×¨×•× ×œ××œ×¨×’×™×”' } },
          { mad: { ar: 'ØªØºÙ„ÙŠÙ ÙØ§Ø®Ø± ÙŠÙ„ÙŠÙ‚ Ø¨Ùƒ', he: '××¨×™×–×” ×™×•×§×¨×ª×™×ª ×©××ª××™××” ×œ×š' }, other: { ar: 'ØªØºÙ„ÙŠÙ Ø¹Ø´ÙˆØ§Ø¦ÙŠ ÙˆØ¨Ø³ÙŠØ·', he: '××¨×™×–×” ×¤×©×•×˜×” ×•××§×¨××™×ª' } },
          { mad: { ar: 'Ø¶Ù…Ø§Ù† Ø§Ø³ØªØ±Ø¬Ø§Ø¹ Ø­Ù‚ÙŠÙ‚ÙŠ', he: '××—×¨×™×•×ª ×”×—×–×¨ ×××™×ª×™×ª' }, other: { ar: 'Ù„Ø§ ÙŠÙˆØ¬Ø¯ Ø¶Ù…Ø§Ù†', he: '××™×Ÿ ××—×¨×™×•×ª' } },
          { mad: { ar: 'Ø®Ø¯Ù…Ø© Ø¹Ù…Ù„Ø§Ø¡ ÙˆÙØ±ÙˆØ¹ Ù…Ø¹ØªÙ…Ø¯Ø©', he: '×©×™×¨×•×ª ×œ×§×•×—×•×ª ×•×¡× ×™×¤×™× ××•×¨×©×™×' }, other: { ar: 'Ù…ØªØ§Ø¬Ø± ÙˆÙ‡Ù…ÙŠØ© Ø¨Ù„Ø§ Ø¯Ø¹Ù…', he: '×—× ×•×™×•×ª ×¤×™×§×˜×™×‘×™×•×ª ×œ×œ× ×ª××™×›×”' } }
        ];
      }

      if (type === 'fragrantica') {
        block.stars = 5;
        block.score = '4.9/5';
        block.url = 'https://www.fragrantica.com/designers/Mad-Parfumeur.html';
        block.content = { ar: 'ØªÙ‚ÙŠÙŠÙ…Ø§Øª Ù…Ù…ØªØ§Ø²Ø©', he: '×‘×™×§×•×¨×•×ª ××¦×•×™× ×•×ª' };
      }

      this.blocks.push(block);
      this.update();
    },

    removeBlock(i) { this.blocks.splice(i, 1); this.update(); },

    moveBlock(i, d) {
      const ni = i + d;
      if (ni >= 0 && ni < this.blocks.length) {
        [this.blocks[i], this.blocks[ni]] = [this.blocks[ni], this.blocks[i]];
        this.update();
      }
    },

    async copyCode() {
      try {
        await navigator.clipboard.writeText(this.generateFinalHTML(true));
        alert('âœ… Copied!');
      } catch (e) { alert('Error copying'); }
    },

    downloadHTML() {
      const link = document.createElement('a');
      link.href = URL.createObjectURL(new Blob([this.generateFinalHTML(true)], { type: 'text/html' }));
      link.download = 'MAD-Page-V54.html';
      link.click();
    },

    generateFinalHTML(isDownload) {
      // âœ… hide admin phone from Meta auto matching (send via base64 only)
      const ADMIN_B64 = btoa(String(this.config.adminPhone || '').replace(/\D/g,''));
      const cJ = JSON.stringify({ ...this.config, adminPhoneB64: ADMIN_B64, adminPhone: '' }).replace(/</g, '\\u003c');

      const bJ = JSON.stringify(this.blocks).replace(/</g, '\\u003c');
      const PROD_NAME = (this.config.productName || '').replace(/'/g, "\\'");
      const PRICE_VAL = this.config.price || '0';
      const iL = isDownload ? null : `'${this.editLang}'`;

      const PIXEL_CODE = `
      window._mad_px_fired = false;

      function formatPhoneE164(p) {
        if (!p) return '';
        let s = String(p).trim();
        if (!s) return '';
        let digits = s.replace(/[^0-9]/g, '');
        if (!digits) return '';

        if (digits.startsWith('00')) digits = digits.slice(2);

        // IL local: 05XXXXXXXX (10) -> +9725XXXXXXXX
        if (digits.startsWith('05') && digits.length === 10) digits = '972' + digits.slice(1);

        // PS local: 059XXXXXXX / 056XXXXXXX (10) -> +97059XXXXXXX / +97056XXXXXXX
        if ((digits.startsWith('059') || digits.startsWith('056')) && digits.length === 10) digits = '970' + digits.slice(1);

        if (digits.startsWith('972') || digits.startsWith('970')) {
          if (digits.length < 11) return '';
          return '+' + digits;
        }

        if (digits.length >= 11 && digits.length <= 15) return '+' + digits;

        return '';
      }

      function loadPixels() {
        if (window._mad_px_fired) return;
        window._mad_px_fired = true;

        // FB
        if ('${this.config.fbPixel}') {
          !function(f,b,e,v,n,t,s){if(f.fbq)return;n=f.fbq=function(){n.callMethod?n.callMethod.apply(n,arguments):n.queue.push(arguments)};
          if(!f._fbq)n=f.fbq;n.push=n;n.loaded=!0;n.version='2.0';n.queue=[];t=b.createElement(e);t.async=!0;t.src=v;
          s=b.getElementsByTagName(e)[0];s.parentNode.insertBefore(t,s)}(window,document,'script','https://connect.facebook.net/en_US/fbevents.js');
          fbq('init','${this.config.fbPixel}');
          fbq('track','PageView');
        }

        // TikTok
        if ('${this.config.ttPixel}') {
          !function (w, d, t) { w.TiktokAnalyticsObject=t; var ttq=w[t]=w[t]||[];
          ttq.methods=["page","track","identify","instances","debug","on","off","once","ready","alias","group","enableCookie","disableCookie","holdConsent","revokeConsent","grantConsent"];
          ttq.setAndDefer=function(t,e){t[e]=function(){t.push([e].concat(Array.prototype.slice.call(arguments,0)))}}; for(var i=0;i<ttq.methods.length;i++)ttq.setAndDefer(ttq,ttq.methods[i]);
          ttq.load=function(e,n){ var r="https://analytics.tiktok.com/i18n/pixel/events.js"; ttq._i=ttq._i||{}; ttq._i[e]=[]; ttq._i[e]._u=r;
          ttq._t=ttq._t||{}; ttq._t[e]=+new Date; ttq._o=ttq._o||{}; ttq._o[e]=n||{};
          n=document.createElement("script"); n.type="text/javascript"; n.async=!0; n.src=r+"?sdkid="+e+"&lib="+t;
          e=document.getElementsByTagName("script")[0]; e.parentNode.insertBefore(n,e) };
          ttq.load('${this.config.ttPixel}'); ttq.page(); }(window, document, 'ttq');
        }

        // Snap
        if ('${this.config.snapPixel}') {
          (function(e,t,n){if(e.snaptr)return;var a=e.snaptr=function(){a.handleRequest?a.handleRequest.apply(a,arguments):a.queue.push(arguments)};
          a.queue=[];var s='script';var r=t.createElement(s);r.async=!0;r.src=n;var u=t.getElementsByTagName(s)[0];
          u.parentNode.insertBefore(r,u)})(window,document,'https://sc-static.net/scevent.min.js');
          snaptr('init','${this.config.snapPixel}');
          snaptr('track','PAGE_VIEW');
        }
      }`;

      return `<!DOCTYPE html>
<html x-data="app()" x-init="init(${iL})" :lang="lang" :dir="lang==='he'?'ltr':'rtl'">
<head>
<meta charset="UTF-8"><meta name="viewport" content="width=device-width, initial-scale=1.0">
<script src="https://cdn.tailwindcss.com"><\/script>
<script src="https://unpkg.com/lucide@latest" defer><\/script>
<script src="https://unpkg.com/alpinejs@3.x.x/dist/cdn.min.js" defer><\/script>
<link href="https://fonts.googleapis.com/css2?family=Amiri:wght@400;700&family=Aref+Ruqaa:wght@400;700&family=Cairo:wght@200..1000&family=Rakkas&family=Tajawal:wght@200..900&display=swap" rel="stylesheet">
<script>${PIXEL_CODE}<\/script>
<style>
body { background: ${this.config.bgColor}; font-family: 'Cairo', sans-serif; overflow-x: hidden; min-height: 100vh; }
.inp { width: 100%; padding: 15px; background: #f8fafc; border: 1px solid #ddd; border-radius: 12px; margin-bottom: 10px; font-weight: bold; }
.btn-main { background: #000; color: #fff; width: 100%; padding: 18px; border-radius: 14px; font-weight: 900; font-size: 1.2rem; box-shadow: 0 4px 14px rgba(0,0,0,0.2); position: relative; overflow: hidden; animation: pulse 2s infinite; }
@keyframes pulse { 0% { transform: scale(1); } 50% { transform: scale(1.02); } 100% { transform: scale(1); } }
.mad-radio-box { border: 2px solid #e5e7eb; border-radius: 12px; padding: 12px; text-align: center; cursor: pointer; background: white; transition: 0.2s; }
input:checked + .mad-radio-box { border-color: #10b981; background: #f0fdf4; color: #047857; transform: scale(1.02); }
.sales-pop { animation: slideIn 0.5s ease-out forwards; }
@keyframes slideIn { from { transform: translateY(100px); opacity: 0; } to { transform: translateY(0); opacity: 1; } }
.rec { border-color: #10b981; position: relative; }
.rec::after { content:'â˜…'; position:absolute; top:-8px; right:-8px; background:#10b981; color:white; border-radius:50%; width:20px; height:20px; font-size:10px; display:flex; align-items:center; justify-content:center; }
.progress-container { margin-bottom: 15px; }
.progress-text { display: flex; justify-content: space-between; font-size: 0.75rem; font-weight: bold; margin-bottom: 5px; opacity: 0.7; color:white; }
.progress-track { height: 6px; background: rgba(255,255,255,0.3); border-radius: 99px; overflow: hidden; }
.progress-fill { height: 100%; background: #10b981; width: 85%; }
.no-scrollbar::-webkit-scrollbar { display: none; }
.no-scrollbar { -ms-overflow-style: none; scrollbar-width: none; }
</style>
</head>
<body class="pb-20">

<nav class="p-4 flex justify-center bg-white/40 backdrop-blur sticky top-0 z-50">
  <img src="${this.config.logoUrl}" class="h-10 object-contain" referrerpolicy="no-referrer">
</nav>

<header class="text-center py-8 px-4">
  <h1 class="text-3xl font-black text-white" x-text="c.heroTitle[lang]"></h1>
</header>

<main class="max-w-md mx-auto px-4">
  <template x-for="b in blocks" :key="b.id">
    <div class="my-4" :class="'text-'+(b.align||'center')">

      <template x-if="b.type==='text'">
        <p class="whitespace-pre-wrap leading-relaxed" :class="[b.style?.size||'text-base']"
           :style="{color:b.style?.color||'#000', fontFamily:b.style?.font}" x-text="b.content?.[lang] || ''"></p>
      </template>

      <!-- âœ… IMAGE robust -->
      <template x-if="b.type==='image'">
        <div x-data="{err:false}">
          <img :src="(b.url || (b.content && (b.content[lang]||b.content.ar||b.content.he)) || '')"
               @error="err=true"
               x-show="!err"
               class="rounded-xl w-full shadow-sm"
               loading="lazy"
               referrerpolicy="no-referrer">
          <div x-show="err" class="text-xs font-bold bg-white/80 rounded-xl p-3 text-center">
            Ø§Ù„ØµÙˆØ±Ø© ØºÙŠØ± Ù…ØªØ§Ø­Ø© â€” ØªØ£ÙƒØ¯ Ø£Ù† Ø§Ù„Ø±Ø§Ø¨Ø· ÙŠØ¨Ø¯Ø£ Ø¨Ù€ https
          </div>
        </div>
      </template>

      <template x-if="b.type==='video'">
        <video :src="(b.url || '')" controls class="rounded-xl w-full shadow-sm"></video>
      </template>

      <template x-if="b.type==='iframe'">
        <div class="rounded-xl overflow-hidden shadow-sm aspect-video bg-white">
          <iframe :src="(b.url || '')" class="w-full h-full" frameborder="0" allowfullscreen></iframe>
        </div>
      </template>

      <template x-if="b.type==='embed'"><div x-html="b.content?.[lang] || ''"></div></template>

      <template x-if="b.type==='gallery'">
        <div class="relative w-full rounded-xl overflow-hidden shadow-lg"
             :class="(b.aspect === 'portrait' ? 'aspect-[3/4]' : (b.aspect === 'square' ? 'aspect-square' : 'aspect-video'))"
             x-data="{ curr: 0, total: (b.images||[]).length }"
             x-init="if(total>1){ setInterval(() => { curr = (curr + 1) % total }, 3000) }">
          <template x-for="(img, i) in (b.images||[])" :key="i">
            <img :src="img" x-show="curr === i"
                 x-transition:enter="transition ease-out duration-500"
                 x-transition:enter-start="opacity-0"
                 x-transition:enter-end="opacity-100"
                 x-transition:leave="transition ease-in duration-300"
                 x-transition:leave-start="opacity-100"
                 x-transition:leave-end="opacity-0"
                 class="absolute inset-0 w-full h-full"
                 :class="(b.fit === 'contain' ? 'object-contain' : 'object-cover')"
                 referrerpolicy="no-referrer">
          </template>

          <div class="absolute bottom-2 flex gap-1 justify-center w-full z-10" x-show="total>1">
            <template x-for="(img, i) in (b.images||[])" :key="i">
              <div class="w-2 h-2 rounded-full transition-all" :class="curr===i ? 'bg-white w-4' : 'bg-white/50'"></div>
            </template>
          </div>
        </div>
      </template>

      <template x-if="b.type==='offers_slider'">
        <div class="mt-4">
          <h3 class="text-lg font-bold mb-2 px-2 text-white" x-text="b.title?.[lang] || ''"></h3>
          <div class="flex overflow-x-auto gap-3 pb-4 px-2 no-scrollbar">
            <template x-for="(item, idx) in (b.items||[])" :key="idx">
              <a :href="item.link || '#'" class="min-w-[180px] w-[180px] bg-white rounded-xl shadow-lg border border-gray-100 overflow-hidden flex flex-col no-underline transition transform active:scale-95">
                <div class="w-full bg-white flex items-center justify-center overflow-hidden relative"
                     :class="(b.aspect === 'portrait' ? 'h-64' : (b.aspect === 'landscape' ? 'h-32' : 'h-40'))">
                  <img :src="item.img || ''" class="w-full h-full"
                       :class="(b.fit === 'contain' ? 'object-contain p-2' : 'object-cover')"
                       referrerpolicy="no-referrer">
                </div>
                <div class="p-2 pt-1 text-center h-auto">
                  <h4 class="text-xs font-bold text-gray-800 mb-1" x-text="item.title?.[lang] || ''"></h4>
                  <p class="text-sm font-black text-red-600 mb-2" x-text="(item.price||'') + (lang==='he'?' â‚ª':' Ø´ÙŠÙƒÙ„')"></p>
                  <div class="w-full bg-black text-white text-[10px] font-bold py-1.5 rounded-lg" x-text="lang==='he'?'×”×•×¡×£ ×œ×¡×œ':'Ø£Ø¶Ù Ù„Ù„Ø³Ù„Ø©'"></div>
                </div>
              </a>
            </template>
          </div>
        </div>
      </template>

      <template x-if="b.type==='faq'">
        <div class="bg-white rounded-2xl p-4 shadow-sm text-right space-y-2">
          <h3 class="font-black mb-2 text-black" x-text="lang==='he'?'×©××œ×•×ª × ×¤×•×¦×•×ª':'Ø§Ù„Ø£Ø³Ø¦Ù„Ø© Ø§Ù„Ù…ØªÙƒØ±Ø±Ø©'"></h3>
          <template x-for="(qa, i) in (b.items||[])" :key="i">
            <div class="border-b pb-2 last:border-0" x-data="{open:false}">
              <button @click="open=!open" class="w-full flex justify-between font-bold text-sm text-black">
                <span x-text="qa.q?.[lang] || ''"></span>
                <span x-text="open?'-':'+'"></span>
              </button>
              <p x-show="open" class="text-xs text-gray-600 mt-1" x-text="qa.a?.[lang] || ''"></p>
            </div>
          </template>
        </div>
      </template>

      <template x-if="b.type==='urgency_box'">
        <div x-data="{ v: parseInt(b.visitors||600), s: parseInt(b.left||8) }"
             x-init="setInterval(()=>{v+=Math.floor(Math.random()*5)-2}, 3000); setInterval(()=>{if(s>2)s--}, 9000)"
             class="bg-red-50 border border-red-100 rounded-xl p-4 shadow-sm mb-4">
          <div class="flex justify-between items-center mb-2">
            <span class="text-[10px] bg-red-600 text-white px-2 py-1 rounded animate-pulse">ğŸ”¥ HOT</span>
            <div class="font-mono font-bold text-red-600" x-text="timer"></div>
          </div>
          <div class="flex items-center gap-2 text-xs text-gray-600 mb-2"><span>ğŸ‘ï¸</span><span x-text="v"></span> <span x-text="lang==='he'?'×¦×•×¤×™×':'Ø²ÙˆØ§Ø±'"></span></div>
          <div class="text-xs text-gray-600">âš¡ <span x-text="lang==='he'?'× ×•×ª×¨×•':'Ø¨Ù‚ÙŠ'"></span> <span class="font-bold text-red-600" x-text="s"></span></div>
          <div class="w-full bg-gray-200 rounded-full h-1.5 mt-2"><div class="bg-red-500 h-full rounded-full transition-all duration-1000" :style="'width: '+(s*10)+'%'"></div></div>
        </div>
      </template>

      <template x-if="b.type==='interactive_rating'">
        <div class="bg-white border-2 border-yellow-100 rounded-xl p-6 text-center" x-data="{r:0}">
          <h3 class="font-bold mb-2 text-black" x-text="b.content?.[lang] || ''"></h3>
          <div class="flex justify-center gap-2 text-3xl text-gray-200">
            <template x-for="i in 5" :key="i"><button @click="r=i" :class="i<=r?'text-yellow-400':''">â˜…</button></template>
          </div>
          <p x-show="r>0" class="text-green-600 text-xs font-bold mt-2 animate-bounce" x-text="lang==='he'?'×ª×•×“×”! (5/5)':'Ø´ÙƒØ±Ø§Ù‹ Ù„Ùƒ! (5/5)'"></p>
        </div>
      </template>

      <template x-if="b.type==='comparison'">
        <div class="space-y-2 mt-4 text-right">
          <template x-for="(row, idx) in (b.items||[])" :key="idx">
            <div class="grid grid-cols-2 gap-1 rounded-xl overflow-hidden border border-black/5 shadow-sm">
              <div class="bg-gray-50 p-4 border-r border-black/5"><span class="text-[8px] font-black text-amber-600 block mb-1">MAD</span><p class="text-[11px] font-bold leading-tight text-black" x-text="row.mad?.[lang] || ''"></p></div>
              <div class="bg-white p-4 text-gray-400 text-right"><span class="text-[8px] font-black text-gray-300 block mb-1">OTHERS</span><p class="text-[11px]" x-text="row.other?.[lang] || ''"></p></div>
            </div>
          </template>
        </div>
      </template>

      <template x-if="b.type==='fragrantica'">
        <a :href="b.url || '#'" target="_blank" class="block w-full max-w-[320px] bg-[#3f5a31] text-white p-5 rounded-[24px] shadow-xl relative overflow-hidden mx-auto no-underline text-right">
          <div class="flex justify-between items-center mb-3">
            <span class="text-[10px] font-black uppercase tracking-widest text-white/60">Reviews</span>
            <div class="flex text-amber-400 gap-0.5">
              <template x-for="i in parseInt(b.stars || 5)" :key="i">
                <svg xmlns="http://www.w3.org/2000/svg" width="14" height="14" viewBox="0 0 24 24" fill="currentColor" stroke="none"><polygon points="12 2 15.09 8.26 22 9.27 17 14.14 18.18 21.02 12 17.77 5.82 21.02 7 14.14 2 9.27 8.91 8.26 12 2"/></svg>
              </template>
            </div>
          </div>
          <div class="flex items-end gap-2"><span class="text-4xl font-black" x-text="b.score || '4.9 / 5'"></span><span class="text-xs opacity-60 mb-1">Rating</span></div>
          <p class="text-[10px] font-bold mt-2 text-white/80" x-text="b.content?.[lang] || ''"></p>
        </a>
      </template>

      <template x-if="b.type==='form'">
        <div class="bg-white p-6 rounded-[24px] shadow-sm text-right border-2 border-gray-100" id="order">
          <div class="progress-container">
            <div class="progress-text">
              <span x-text="lang==='he'?'×¤×¨×˜×™ ××©×œ×•×—':'Ù…Ø¹Ù„ÙˆÙ…Ø§Øª Ø§Ù„Ø´Ø­Ù†'"></span>
              <span x-text="lang==='he'?'×©×œ×‘ ××—×¨×•×Ÿ':'Ø§Ù„Ø®Ø·ÙˆØ© Ø§Ù„Ø£Ø®ÙŠØ±Ø©'"></span>
            </div>
            <div class="progress-track"><div class="progress-fill"></div></div>
          </div>

          <h2 class="text-xl font-black text-center mb-4 text-black" x-text="b.content?.[lang] || (lang==='he'?'×”×–×× ×”':'Ø§Ø·Ù„Ø¨ Ø§Ù„Ø¢Ù†')"></h2>

          <form @submit.prevent="submitForm">
            <!-- âœ… AddToCart on name typing -->
            <input type="text" x-model="f.name" @input="trackCart" class="inp" :placeholder="lang==='he'?'×©×':'Ø§Ù„Ø§Ø³Ù…'" required>

            <!-- âœ… phone normalized on blur, but doesn't break submit -->
            <input
              type="tel"
              inputmode="tel"
              x-model="f.phone"
              @blur="f.phone = formatPhoneE164(f.phone) || f.phone"
              dir="ltr"
              class="inp text-right"
              :placeholder="lang==='he'?'×˜×œ×¤×•×Ÿ':'Ø§Ù„Ù‡Ø§ØªÙ'"
              required
            >

            <input type="text" x-model="f.address" class="inp" :placeholder="lang==='he'?'×›×ª×•×‘×ª':'Ø§Ù„Ø¹Ù†ÙˆØ§Ù†'" required>

            <div class="grid grid-cols-2 gap-3 mb-4">
              <label class="cursor-pointer"><input type="radio" x-model="f.payment" value="Cash" class="hidden"><div class="mad-radio-box rec"><span x-text="lang==='he'?'××–×•××Ÿ ğŸ’µ':'Ù†Ù‚Ø¯ ğŸ’µ'"></span></div></label>
              <label class="cursor-pointer"><input type="radio" x-model="f.payment" value="Visa" class="hidden"><div class="mad-radio-box"><span x-text="lang==='he'?'××©×¨××™ ğŸ’³':'ÙÙŠØ²Ø§ ğŸ’³'"></span></div></label>
            </div>

            <div class="grid grid-cols-2 gap-3 mb-6">
              <label class="cursor-pointer"><input type="radio" x-model="f.process" value="Direct" class="hidden"><div class="mad-radio-box rec"><span x-text="lang==='he'?'×©×œ×— ×”×–×× ×”':'Ø§Ø±Ø³Ù„ Ø§Ù„Ø·Ù„Ø¨'"></span><div class="text-[9px] text-blue-600">ğŸš€</div></div></label>
              <label class="cursor-pointer"><input type="radio" x-model="f.process" value="Contact" class="hidden"><div class="mad-radio-box"><span x-text="lang==='he'?'×¦×•×¨ ×§×©×¨':'ØªÙˆØ§ØµÙ„ Ù…Ø¹ÙŠ'"></span></div></label>
            </div>

            <button type="submit" class="btn-main" :disabled="loading" x-text="loading?'...':(b.btnText?.[lang] || 'Order Now')"></button>
          </form>
        </div>
      </template>

    </div>
  </template>
</main>

<div x-show="pop.show" class="fixed bottom-4 left-4 right-4 bg-white p-3 rounded-xl shadow-2xl z-40 sales-pop flex items-center gap-3" style="display:none">
  <div class="bg-green-100 p-2 rounded-full">ğŸ›ï¸</div>
  <div>
    <p class="text-xs font-bold" x-text="pop.msg"></p>
    <p class="text-[10px] text-gray-500">Just now</p>
  </div>
</div>

<div x-show="sending" class="fixed inset-0 bg-black/80 flex items-center justify-center z-50" style="display:none">
  <div class="text-center p-7 bg-white text-black rounded-3xl max-w-sm mx-4">
    <div class="text-5xl mb-3 animate-pulse">ğŸ“¨</div>
    <h3 class="text-xl font-black" x-text="lang==='he'?'×©×•×œ×—×™× ××ª ×”×”×–×× ×”':'ÙŠØªÙ… Ø¥Ø±Ø³Ø§Ù„ Ø§Ù„Ø·Ù„Ø¨'"></h3>
    <p class="text-sm mt-2 font-bold opacity-80" x-text="lang==='he'?'××œ ×ª×¡×’×•×¨ ××ª ×”××¡×š â€” ×ª×§×‘×œ ×”×•×“×¢×ª ×•×•××˜×¡××¤':'Ù„Ø§ ØªØºÙ„Ù‚ Ø§Ù„Ø´Ø§Ø´Ø© â€” Ø³ØªØµÙ„Ùƒ Ø±Ø³Ø§Ù„Ø© ÙˆØ§ØªØ³Ø§Ø¨'"></p>
  </div>
</div>

<div x-show="submitted" class="fixed inset-0 bg-black/90 flex items-center justify-center text-white z-50" style="display:none">
  <div class="text-center p-8 bg-white text-black rounded-3xl">
    <div class="text-6xl mb-4">âœ…</div>
    <h3 class="text-2xl font-black" x-text="lang==='he'?'×”×¦×œ×—×”!':'Success!'"></h3>
    <button @click="submitted=false" class="mt-6 w-full bg-black text-white py-3 rounded-xl" x-text="lang==='he'?'×¡×’×•×¨':'Close'"></button>
  </div>
</div>

<script>
function app() {
  return {
    lang: 'ar',
    loading: false,
    sending: false,
    submitted: false,
    pop: { show: false, msg: '' },

    cartFired: false,

    blocks: ${bJ},
    c: ${cJ},
    f: { name: '', phone: '', address: '', payment: 'Cash', process: 'Direct' },

    time: ${JSON.parse(bJ).find(b => b.type === 'urgency_box')?.timerMinutes * 60 || 900},
    get timer() { const m=Math.floor(this.time/60); const s=this.time%60; return \`\${m}:\${s<10?'0':''}\${s}\`; },

    init(l) {
      this.lang = l || (navigator.language.startsWith('he') ? 'he' : 'ar');
      setInterval(() => { if (this.time > 0) this.time--; }, 1000);

      if ((this.blocks||[]).some(b => b.type === 'sales_pop')) {
        setInterval(() => {
          const names = ['Ahmed','Sara','Mohamed','Noor']; const cities = ['Jerusalem','Haifa','Nazareth'];
          this.pop.msg = \`\${names[Math.floor(Math.random()*names.length)]} from \${cities[Math.floor(Math.random()*cities.length)]} purchased\`;
          this.pop.show = true; setTimeout(() => this.pop.show = false, 4000);
        }, 15000);
      }

      // lazy pixels
      setTimeout(() => { if(!window.mad_pixels_loaded){ window.mad_pixels_loaded = true; loadPixels(); } }, 2000);
      document.addEventListener('touchstart', () => { if(!window.mad_pixels_loaded){ window.mad_pixels_loaded = true; loadPixels(); } }, { once:true });
    },

    ensurePixelsNow() {
      if (!window.mad_pixels_loaded) {
        window.mad_pixels_loaded = true;
        loadPixels();
      }
    },

    // âœ… AddToCart fires when user starts typing name (phone optional)
    trackCart() {
      if (this.cartFired) return;

      const name = (this.f.name || '').trim();
      if (!name) return;

      this.cartFired = true;
      this.ensurePixelsNow();

      const e164 = formatPhoneE164(this.f.phone);        // +972...
      const ttPhone = e164 ? e164.replace('+','') : '';  // 972...

      // Facebook (only send phone if valid)
      if (window.fbq && this.c.fbPixel) {
        const am = { fn: name };
        if (e164) am.ph = e164;
        fbq('init', this.c.fbPixel, am);

        fbq('track', 'AddToCart', {
          content_name: '${PROD_NAME}',
          content_ids: ['${PROD_NAME}'],
          content_type: 'product',
          value: ${PRICE_VAL},
          currency: 'ILS'
        });
      }

      // TikTok
      if (window.ttq && this.c.ttPixel) {
        if (ttPhone) ttq.identify({ phone_number: ttPhone, name: name });
        ttq.track('AddToCart', {
          content_name: '${PROD_NAME}',
          content_id: '${PROD_NAME}',
          content_type: 'product',
          value: ${PRICE_VAL},
          currency: 'ILS'
        });
      }

      // Snap
      if (window.snaptr && this.c.snapPixel) {
        if (e164) snaptr('init', this.c.snapPixel, { user_phone_number: e164 });
        snaptr('track', 'ADD_CART', {
          price: ${PRICE_VAL},
          currency: 'ILS',
          item_ids: ['${PROD_NAME}'],
          item_category: '${PROD_NAME}'
        });
      }
    },

    async submitForm() {
      this.loading = true;
      this.sending = true;

      this.ensurePixelsNow();

      const e164 = formatPhoneE164(this.f.phone);
      const name = (this.f.name || '').trim();
      const ttPhone = e164 ? e164.replace('+','') : '';

      // FB Purchase
      if (window.fbq && this.c.fbPixel) {
        const am = { fn: name };
        if (e164) am.ph = e164;
        fbq('init', this.c.fbPixel, am);

        fbq('track', 'Purchase', {
          value: ${PRICE_VAL},
          currency: 'ILS',
          content_ids: ['${PROD_NAME}'],
          content_type: 'product'
        });
      }

      // TikTok
      if (window.ttq && this.c.ttPixel) {
        if (ttPhone) ttq.identify({ phone_number: ttPhone, name: name });
        ttq.track('CompletePayment', {
          value: ${PRICE_VAL},
          currency: 'ILS',
          content_id: '${PROD_NAME}',
          content_type: 'product'
        });
      }

      // Snap Purchase
      if (window.snaptr && this.c.snapPixel) {
        if (e164) snaptr('init', this.c.snapPixel, { user_phone_number: e164 });
        snaptr('track', 'PURCHASE', {
          currency: 'ILS',
          price: ${PRICE_VAL},
          item_ids: ['${PROD_NAME}'],
          transaction_id: Date.now()
        });
      }

      await new Promise(r => setTimeout(r, 700));

      const fd = new FormData();
      Object.keys(this.f).forEach(k => fd.append(k, this.f[k]));
      fd.append('lang', this.lang);
      fd.append('offer', '${PROD_NAME}');
      fd.append('price', '${PRICE_VAL}');

      // âœ… admin phone from base64 (not visible to Meta)
      fd.append('admin_phone', (this.c.adminPhoneB64 ? atob(this.c.adminPhoneB64) : ''));

      try {
        await fetch(this.c.sheetUrl, { method: 'POST', body: fd, mode: 'no-cors' });
        this.sending = false;
        this.submitted = true;
      } catch (e) {
        this.sending = false;
        alert('Error');
      } finally {
        this.loading = false;
      }
    }
  }
}
<\/script>

</body>
</html>`
