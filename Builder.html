<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>MAD Builder V53 - Pixel Precision ğŸ›¡ï¸ (Final Fix)</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <script src="https://unpkg.com/lucide@latest" defer></script>
  <script src="https://unpkg.com/alpinejs@3.x.x/dist/cdn.min.js" defer></script>
  <style>
    @import url('https://fonts.googleapis.com/css2?family=Amiri:wght@400;700&family=Cairo:wght@200..1000&family=Tajawal:wght@200..900&display=swap');
    [x-cloak]{display:none!important}
    body{font-family:'Cairo',sans-serif;background:#e2e8f0;height:100vh;overflow:hidden}
    .app-layout{display:flex;height:100vh;flex-direction:row-reverse}
    .editor-sidebar{width:400px;background:#fff;border-left:1px solid #cbd5e1;overflow-y:auto;padding:15px;flex-shrink:0;box-shadow:-5px 0 15px rgba(0,0,0,.05)}
    .preview-area{flex:1;background:#f1f5f9;display:flex;flex-direction:column;align-items:center;justify-content:center;position:relative}
    .iphone{width:375px;height:750px;background:#000;border-radius:40px;border:12px solid #2d2d2d;overflow:hidden;position:relative;box-shadow:0 25px 50px -12px rgba(0,0,0,.5);background-color:#fff;transition:transform .2s}
    .iphone iframe{width:100%;height:100%;border:none;background:#fff}
    .section-box{background:#f8fafc;border:1px solid #e2e8f0;border-radius:8px;padding:10px;margin-bottom:10px}
    .section-title{font-weight:900;font-size:.8rem;color:#475569;margin-bottom:5px;display:block}
    input,textarea,select{width:100%;padding:6px;border:1px solid #cbd5e1;border-radius:6px;font-size:11px;outline:none;transition:.2s}
    input:focus{border-color:#3b82f6;box-shadow:0 0 0 2px rgba(59,130,246,.1)}
    .btn-grid{display:grid;grid-template-columns:repeat(3,1fr);gap:5px}
    .btn-add{background:#fff;border:1px solid #cbd5e1;padding:8px;border-radius:6px;font-size:10px;font-weight:bold;cursor:pointer;display:flex;align-items:center;justify-content:center;gap:3px;transition:.2s}
    .btn-add:hover{background:#f1f5f9;border-color:#94a3b8}
    .btn-action{width:100%;padding:10px;border-radius:8px;font-weight:800;margin-top:5px;cursor:pointer;text-align:center;font-size:.9rem}
    .zoom-controls{position:fixed;bottom:20px;left:50%;transform:translateX(-50%);background:rgba(0,0,0,.8);padding:5px 15px;border-radius:99px;display:flex;gap:10px;color:#fff;z-index:50;align-items:center;font-size:12px}
  </style>
</head>
<body>

<div class="app-layout" x-data="builderApp()" x-init="init()" x-cloak>
  <aside class="editor-sidebar">
    <h1 class="text-xl font-black mb-4 text-center text-slate-800">
      MAD BUILDER <span class="text-blue-600">V53 GUARD</span>
    </h1>

    <div class="flex bg-slate-100 p-1 rounded-lg mb-4">
      <button @click="editLang='ar'; update()" :class="editLang==='ar'?'bg-white shadow text-black':'text-gray-500'" class="flex-1 py-1.5 rounded text-xs font-bold transition">Ø¹Ø±Ø¨ÙŠ</button>
      <button @click="editLang='he'; update()" :class="editLang==='he'?'bg-white shadow text-black':'text-gray-500'" class="flex-1 py-1.5 rounded text-xs font-bold transition">×¢×‘×¨×™×ª</button>
    </div>

    <div class="section-box border-green-200 bg-green-50/50">
      <span class="section-title text-green-700">ğŸ’° Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª Ø§Ù„Ù…Ù†ØªØ¬ (VSA)</span>
      <div class="flex gap-2">
        <input type="text" x-model="config.productName" @input="update()" placeholder="Ø§Ø³Ù… Ø§Ù„Ù…Ù†ØªØ¬ (Content ID)">
        <input type="number" x-model="config.price" @input="update()" placeholder="Ø§Ù„Ø³Ø¹Ø±" class="w-1/3">
      </div>
    </div>

    <div class="section-box border-blue-200 bg-blue-50/50">
      <span class="section-title text-blue-700">ğŸ”— Ø§Ù„Ø±Ø¨Ø· ÙˆØ§Ù„Ù…Ø¯ÙŠØ±</span>
      <input type="text" x-model="config.sheetUrl" class="mb-2 font-mono" placeholder="Script URL" @input="update()">
      <input type="text" x-model="config.adminPhone" class="text-center font-bold" placeholder="Ø±Ù‚Ù… Ø§Ù„Ù…Ø¯ÙŠØ±" @input="update()">
    </div>

    <div class="section-box bg-slate-50 border-slate-300">
      <span class="section-title">ğŸ“Š Ø§Ù„Ø¨ÙŠÙƒØ³Ù„ (Ø­Ù…Ø§ÙŠØ© Ù‚ØµÙˆÙ‰ ğŸ›¡ï¸)</span>
      <div class="flex flex-col gap-2">
        <input type="text" x-model="config.fbPixel" placeholder="FB Pixel ID" @input="update()">
        <input type="text" x-model="config.ttPixel" placeholder="TikTok Pixel ID" @input="update()">
        <input type="text" x-model="config.snapPixel" placeholder="Snapchat Pixel ID" @input="update()">
      </div>
      <p class="text-[9px] text-gray-500 mt-1">ØªØ­Ø¯ÙŠØ« E.164 Ø§Ù„ØªÙ„Ù‚Ø§Ø¦ÙŠ Ù…ÙØ¹Ù„ âœ…</p>
    </div>

    <div class="section-box">
      <span class="section-title">ğŸ¨ Ø§Ù„Ù…Ø¸Ù‡Ø±</span>
      <div class="flex gap-2 mb-2 items-center">
        <input type="color" x-model="config.bgColor" @input="update()" class="h-8 w-8 rounded cursor-pointer p-0 border-0">
        <input type="text" x-model="config.logoUrl" @input="update()" placeholder="Ø±Ø§Ø¨Ø· Ø§Ù„Ø´Ø¹Ø§Ø±">
      </div>
      <input type="text" x-model="config.heroTitle[editLang]" @input="update()" placeholder="Ø§Ù„Ø¹Ù†ÙˆØ§Ù† Ø§Ù„Ø±Ø¦ÙŠØ³ÙŠ">
    </div>

    <div class="section-box">
      <span class="section-title">Ø§Ù„Ù…Ø­ØªÙˆÙ‰</span>
      <div class="space-y-2 mb-4">
        <template x-for="(block, index) in blocks" :key="block.id">
          <div class="bg-white border p-2 rounded relative group">
            <button @click="removeBlock(index)" class="absolute top-1 left-1 text-red-500 font-bold px-1 opacity-0 group-hover:opacity-100 transition">Ã—</button>
            <div class="flex justify-between mb-1 pl-6">
              <span class="text-[9px] bg-slate-100 px-2 rounded font-bold text-slate-500 uppercase" x-text="block.type"></span>
              <div class="flex gap-1">
                <button @click="moveBlock(index, -1)" class="text-xs text-gray-400 hover:text-black">â†‘</button>
                <button @click="moveBlock(index, 1)" class="text-xs text-gray-400 hover:text-black">â†“</button>
              </div>
            </div>

            <template x-if="block.type === 'text'">
              <div>
                <div class="flex flex-wrap gap-1 mb-1">
                  <input type="color" x-model="block.style.color" @input="update()" class="w-5 h-5 p-0 border-0 rounded cursor-pointer">
                  <select x-model="block.style.size" @change="update()" class="w-16">
                    <option value="text-sm">S</option><option value="text-lg">M</option><option value="text-2xl">L</option><option value="text-4xl">XL</option>
                  </select>
                </div>
                <textarea x-model="block.content[editLang]" @input="update()" class="h-14"></textarea>
              </div>
            </template>

            <template x-if="['image','video','iframe'].includes(block.type)">
              <textarea x-model="block.url" @input="update()" class="h-14 font-mono text-[10px]" :placeholder="'Ø±Ø§Ø¨Ø· ' + block.type"></textarea>
            </template>

            <template x-if="block.type === 'form'">
              <input type="text" x-model="block.btnText[editLang]" @input="update()" class="text-center font-bold text-pink-600">
            </template>
            
            <template x-if="block.type === 'gallery'">
              <div class="space-y-1">
                <template x-for="(img, idx) in block.images">
                  <div class="flex gap-1">
                    <input type="text" x-model="block.images[idx]" @input="update()" class="text-[9px]">
                    <button @click="block.images.splice(idx,1); update()" class="text-red-500 text-xs">x</button>
                  </div>
                </template>
                <button @click="block.images.push(''); update()" class="w-full text-[9px] bg-sky-50">+ ØµÙˆØ±Ø©</button>
              </div>
            </template>
          </div>
        </template>
      </div>

      <div class="btn-grid">
        <button class="btn-add border-sky-500 bg-sky-50" @click="addBlock('gallery')">ğŸ“¸ Ø¬Ø§Ù„ÙŠØ±ÙŠ</button>
        <button class="btn-add" @click="addBlock('text')">ğŸ“ Ù†Øµ</button>
        <button class="btn-add" @click="addBlock('image')">ğŸ–¼ï¸ ØµÙˆØ±Ø©</button>
        <button class="btn-add" @click="addBlock('form')">ğŸ“‹ ÙÙˆØ±Ù…</button>
        <button class="btn-add" @click="addBlock('offers_slider')">ğŸ›’ Ø³Ù„Ø§ÙŠØ¯Ø±</button>
        <button class="btn-add" @click="addBlock('urgency_box')">ğŸ”¥ Ø¶ØºØ·</button>
      </div>
    </div>

    <button class="btn-action bg-black text-white" @click="downloadHTML()">ğŸ’¾ ØªØ­Ù…ÙŠÙ„ (Download)</button>
    <button class="btn-action bg-gray-600 text-white" @click="copyCode()">ğŸ“‹ Ù†Ø³Ø® (Copy)</button>
  </aside>

  <main class="preview-area">
    <div class="zoom-controls">
      <button @click="zoom=Math.max(0.3, zoom-0.1)">-</button>
      <span x-text="Math.round(zoom*100)+'%'"></span>
      <button @click="zoom=Math.min(1.2, zoom+0.1)">+</button>
      <button @click="update()" class="border-r border-white/30 pr-2 mr-2">ğŸ”„</button>
    </div>
    <div class="iphone" :style="`transform: scale(${zoom})`">
      <iframe id="preview-frame"></iframe>
    </div>
  </main>
</div>

<script>
function builderApp() {
  return {
    editLang: 'ar',
    zoom: 0.85,
    timeout: null,
    config: {
      bgColor: '#96701d',
      logoUrl: 'https://madperfume.ps/upload/01-2026/page/6977cf82b87ef.png',
      heroTitle: { ar: 'Ø£Ù‚ÙˆÙ‰ Ø§Ù„Ø¹Ø±ÙˆØ¶ Ø§Ù„Ø­ØµØ±ÙŠØ©', he: '×”××‘×¦×¢×™× ×”×—××™×' },
      productName: 'Exotic Oud',
      price: '400',
      adminPhone: '972525105889',
      sheetUrl: '',
      fbPixel: '',
      ttPixel: '',
      snapPixel: ''
    },
    blocks: [
      { id: 1, type: 'text', content: { ar: 'ØªÙˆØµÙŠÙ„ Ù„Ø¬Ù…ÙŠØ¹ Ø§Ù„Ù…Ù†Ø§Ø·Ù‚', he: '××©×œ×•×— ×—×™× ×' }, align: 'center', style: { color: '#ffffff', size: 'text-lg', font: 'Cairo' } },
      { id: 2, type: 'form', content: { ar: 'Ø§Ø·Ù„Ø¨ Ø§Ù„Ø¢Ù†', he: '×”×–××Ÿ ×¢×›×©×™×•' }, btnText: { ar: 'ØªØ£ÙƒÙŠØ¯ Ø§Ù„Ø·Ù„Ø¨', he: '×©×œ×— ×”×–×× ×”' }, align: 'center' }
    ],
    init() { 
        setTimeout(()=>this.update(), 500); 
    },
    update() {
      clearTimeout(this.timeout);
      this.timeout = setTimeout(() => {
        const frame = document.getElementById('preview-frame');
        if (frame) frame.srcdoc = this.generateFinalHTML(false);
      }, 300);
    },
    addBlock(type) {
      let b = { id: Date.now(), type, content:{ar:'Ø¬Ø¯ÙŠØ¯', he:'×—×“×©'}, url:'', align:'center', style:{color:'#000', size:'text-base', font:'Cairo'} };
      if(type==='gallery') b.images = [''];
      if(type==='form') b.btnText = {ar:'Ø¥Ø±Ø³Ø§Ù„', he:'×©×œ×—'};
      this.blocks.push(b);
      this.update();
    },
    removeBlock(i) { this.blocks.splice(i,1); this.update(); },
    moveBlock(i, d) {
      const ni = i + d;
      if (ni >= 0 && ni < this.blocks.length) {
        [this.blocks[i], this.blocks[ni]] = [this.blocks[ni], this.blocks[i]];
        this.update();
      }
    },
    downloadHTML() {
      const blob = new Blob([this.generateFinalHTML(true)], { type: 'text/html' });
      const link = document.createElement('a');
      link.href = URL.createObjectURL(blob);
      link.download = 'MAD-Landing.html';
      link.click();
    },
    copyCode() {
      navigator.clipboard.writeText(this.generateFinalHTML(true));
      alert('ØªÙ… Ø§Ù„Ù†Ø³Ø®!');
    },
    generateFinalHTML(isDownload) {
      const bJ = JSON.stringify(this.blocks).replace(/</g, '\\u003c');
      const cJ = JSON.stringify(this.config).replace(/</g, '\\u003c');
      const iL = isDownload ? null : `'${this.editLang}'`;
      
      return `<!DOCTYPE html>
<html x-data="app()" x-init="init(${iL})" :lang="lang" :dir="lang==='he'?'ltr':'rtl'">
<head>
<meta charset="UTF-8"><meta name="viewport" content="width=device-width, initial-scale=1.0">
<script src="https://cdn.tailwindcss.com"><\/script>
<script src="https://unpkg.com/alpinejs@3.x.x/dist/cdn.min.js" defer><\/script>
<link href="https://fonts.googleapis.com/css2?family=Cairo:wght@400;900&display=swap" rel="stylesheet">
<style>
  body { background: ${this.config.bgColor}; font-family: 'Cairo', sans-serif; }
  .inp { width: 100%; padding: 15px; background: #fff; border: 1px solid #ddd; border-radius: 12px; margin-bottom: 10px; text-align: right; }
  .btn-main { background: #000; color: #fff; width: 100%; padding: 18px; border-radius: 12px; font-weight: 900; animation: pulse 2s infinite; }
  @keyframes pulse { 0%, 100% { transform: scale(1); } 50% { transform: scale(1.03); } }
</style>
<script>
// E.164 Universal Formatter
function formatPhone(p) {
    if(!p) return '';
    let d = String(p).replace(/[^0-9]/g, '');
    if(d.startsWith('05') && d.length === 10) d = '972' + d.slice(1);
    if(d.startsWith('00')) d = d.slice(2);
    return d; // Returns digits only (TT compatible)
}

function loadPixels() {
    if(window._px_fired) return; window._px_fired = true;
    if('${this.config.fbPixel}') {
        !function(f,b,e,v,n,t,s){if(f.fbq)return;n=f.fbq=function(){n.callMethod?n.callMethod.apply(n,arguments):n.queue.push(arguments)};if(!f._fbq)n=f.fbq;n.push=n;n.loaded=!0;n.version='2.0';n.queue=[];t=b.createElement(e);t.async=!0;t.src=v;s=b.getElementsByTagName(e)[0];s.parentNode.insertBefore(t,s)}(window,document,'script','https://connect.facebook.net/en_US/fbevents.js');
        fbq('init','${this.config.fbPixel}'); fbq('track','PageView');
    }
    if('${this.config.ttPixel}') {
        !function(w,d,t){w.TiktokAnalyticsObject=t;var ttq=w[t]=w[t]||[];ttq.methods=["page","track","identify","instances","debug","on","off","once","ready","alias","group","enableCookie","disableCookie","holdConsent","revokeConsent","grantConsent"];ttq.setAndDefer=function(t,e){t[e]=function(){t.push([e].concat(Array.prototype.slice.call(arguments,0)))}};for(var i=0;i<ttq.methods.length;i++)ttq.setAndDefer(ttq,ttq.methods[i]);ttq.load=function(e,n){var r="https://analytics.tiktok.com/i18n/pixel/events.js";ttq._i=ttq._i||{};ttq._i[e]=[];ttq._i[e]._u=r;ttq._t=ttq._t||{};ttq._t[e]=+new Date;ttq._o=ttq._o||{};ttq._o[e]=n||{};var o=document.createElement("script");o.type="text/javascript";o.async=!0;o.src=r+"?sdkid="+e+"&lib="+t;var a=document.getElementsByTagName("script")[0];a.parentNode.insertBefore(o,a)};ttq.load('${this.config.ttPixel}');ttq.page();}(window,document,'ttq');
    }
}
<\/script>
</head>
<body class="pb-20">
  <nav class="p-4 flex justify-center sticky top-0 bg-white/30 backdrop-blur z-50">
    <img src="${this.config.logoUrl}" class="h-10 object-contain">
  </nav>

  <main class="max-w-md mx-auto px-4 mt-6">
    <template x-for="b in blocks">
      <div class="my-4">
        <template x-if="b.type==='text'">
          <p class="whitespace-pre-wrap" :class="b.style.size" :style="{color:b.style.color}" x-text="b.content[lang]"></p>
        </template>
        
        <template x-if="b.type==='image'"><img :src="b.url" class="rounded-xl w-full shadow-lg"></template>

        <template x-if="b.type==='form'">
          <div class="bg-white p-6 rounded-2xl shadow-xl">
            <h2 class="text-xl font-black text-center mb-4" x-text="b.content[lang]"></h2>
            <form @submit.prevent="submit">
              <input type="text" x-model="f.name" @input="track('AddToCart')" class="inp" :placeholder="lang==='he'?'×©× ××œ×':'Ø§Ù„Ø§Ø³Ù… Ø§Ù„ÙƒØ§Ù…Ù„'" required>
              <input type="tel" x-model="f.phone" @input="track('AddToCart')" class="inp" :placeholder="lang==='he'?'×˜×œ×¤×•×Ÿ':'Ø±Ù‚Ù… Ø§Ù„Ù‡Ø§ØªÙ'" dir="ltr" required>
              <input type="text" x-model="f.address" class="inp" :placeholder="lang==='he'?'×›×ª×•×‘×ª':'Ø§Ù„Ø¹Ù†ÙˆØ§Ù†'" required>
              <button type="submit" class="btn-main" :disabled="loading" x-text="loading?'...':b.btnText[lang]"></button>
            </form>
          </div>
        </template>
      </div>
    </template>
  </main>

  <div x-show="sending" class="fixed inset-0 bg-black/80 flex items-center justify-center z-[100]" style="display:none">
    <div class="bg-white p-8 rounded-3xl text-center mx-4">
        <div class="text-4xl mb-2 animate-bounce">ğŸ“¨</div>
        <p class="font-bold" x-text="lang==='he'?'×©×•×œ×— ×”×–×× ×”...':'Ø¬Ø§Ø±ÙŠ Ø¥Ø±Ø³Ø§Ù„ Ø§Ù„Ø·Ù„Ø¨...'"></p>
    </div>
  </div>

<script>
function app() {
  return {
    lang: 'ar',
    loading: false, sending: false,
    fired: false,
    blocks: ${bJ}, c: ${cJ},
    f: { name: '', phone: '', address: '' },
    init(l) {
      this.lang = l || (navigator.language.startsWith('he') ? 'he' : 'ar');
      setTimeout(loadPixels, 2000);
    },
    track(event) {
        let phoneDigits = formatPhone(this.f.phone);
        // Strict Check: Only fire if name exists AND phone is exactly 12 digits (972...)
        if(phoneDigits.length < 12) return; 
        if(this.fired && event === 'AddToCart') return;
        
        if(event === 'AddToCart') this.fired = true;
        loadPixels();

        if(window.fbq) fbq('track', event, { value: ${PRICE_VAL}, currency: 'ILS' });
        if(window.ttq) {
            ttq.identify({ phone_number: phoneDigits });
            ttq.track(event === 'AddToCart' ? 'AddToCart' : 'CompletePayment', {
                content_id: '${PROD_NAME}', value: ${PRICE_VAL}, currency: 'ILS'
            });
        }
    },
    async submit() {
        this.loading = true; this.sending = true;
        this.track('CompletePayment');
        
        let fd = new FormData();
        Object.keys(this.f).forEach(k => fd.append(k, this.f[k]));
        fd.append('offer', '${PROD_NAME}');
        fd.append('price', '${PRICE_VAL}');
        fd.append('admin_phone', '${this.config.adminPhone}');

        try {
            await fetch(this.c.sheetUrl, { method: 'POST', body: fd, mode: 'no-cors' });
            this.sending = false;
            alert(this.lang==='he' ? '×”×–×× ×” ×”×ª×§×‘Ù„Ù‡!' : 'ØªÙ… Ø§Ø³ØªÙ„Ø§Ù… Ø·Ù„Ø¨Ùƒ!');
        } catch(e) { 
            this.sending = false; alert('Error'); 
        } finally { 
            this.loading = false; 
        }
    }
  }
}
<\/script>
</body>
</html>`;
    }
  }
}
</script>
</body>
</html>
