<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>MAD Builder V53 - E.164 Precision ğŸ›¡ï¸</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/lucide@latest" defer></script>
    <script src="https://unpkg.com/alpinejs@3.x.x/dist/cdn.min.js" defer></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Amiri:wght@400;700&family=Cairo:wght@200..1000&family=Tajawal:wght@200..900&display=swap');
        [x-cloak] { display: none !important; }
        body { font-family: 'Cairo', sans-serif; background: #e2e8f0; height: 100vh; overflow: hidden; }
        .app-layout { display: flex; height: 100vh; flex-direction: row-reverse; }
        .editor-sidebar { width: 400px; background: #fff; border-left: 1px solid #cbd5e1; overflow-y: auto; padding: 15px; flex-shrink: 0; box-shadow: -5px 0 15px rgba(0,0,0,0.05); }
        .preview-area { flex: 1; background: #f1f5f9; display: flex; flex-direction: column; align-items: center; justify-content: center; position: relative; }
        .iphone { width: 375px; height: 750px; background: #000; border-radius: 40px; border: 12px solid #2d2d2d; overflow: hidden; position: relative; box-shadow: 0 25px 50px -12px rgba(0,0,0,0.5); background-color: #fff; transition: transform 0.2s; }
        .iphone iframe { width: 100%; height: 100%; border: none; background: #fff; }
        .section-box { background: #f8fafc; border: 1px solid #e2e8f0; border-radius: 8px; padding: 10px; margin-bottom: 10px; }
        .section-title { font-weight: 900; font-size: 0.8rem; color: #475569; margin-bottom: 5px; display: block; }
        input, textarea, select { width: 100%; padding: 6px; border: 1px solid #cbd5e1; border-radius: 6px; font-size: 11px; outline: none; transition: 0.2s; }
        input:focus { border-color: #3b82f6; box-shadow: 0 0 0 2px rgba(59, 130, 246, 0.1); }
        .btn-grid { display: grid; grid-template-columns: repeat(3, 1fr); gap: 5px; }
        .btn-add { background: #fff; border: 1px solid #cbd5e1; padding: 8px; border-radius: 6px; font-size: 10px; font-weight: bold; cursor: pointer; display: flex; align-items: center; justify-content: center; gap: 3px; transition: 0.2s; }
        .btn-add:hover { background: #f1f5f9; border-color: #94a3b8; }
        .btn-action { width: 100%; padding: 10px; border-radius: 8px; font-weight: 800; margin-top: 5px; cursor: pointer; text-align: center; font-size: 0.9rem; }
        .zoom-controls { position: fixed; bottom: 20px; left: 50%; transform: translateX(-50%); background: rgba(0,0,0,0.8); padding: 5px 15px; border-radius: 99px; display: flex; gap: 10px; color: white; z-index: 50; align-items: center; font-size: 12px; }
    </style>
</head>
<body>

<div class="app-layout" x-data="builderApp()" x-init="init()" x-cloak>
    <aside class="editor-sidebar">
        <h1 class="text-xl font-black mb-4 text-center text-slate-800">MAD BUILDER <span class="text-blue-600">V53 GUARD</span></h1>
        
        <div class="flex bg-slate-100 p-1 rounded-lg mb-4">
            <button @click="editLang='ar'; update()" :class="editLang==='ar'?'bg-white shadow text-black':'text-gray-500'" class="flex-1 py-1.5 rounded text-xs font-bold transition">Ø¹Ø±Ø¨ÙŠ</button>
            <button @click="editLang='he'; update()" :class="editLang==='he'?'bg-white shadow text-black':'text-gray-500'" class="flex-1 py-1.5 rounded text-xs font-bold transition">×¢×‘×¨×™×ª</button>
        </div>

        <div class="section-box border-green-200 bg-green-50/50">
            <span class="section-title text-green-700">ğŸ’° Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª Ø§Ù„Ù…Ù†ØªØ¬ (VSA)</span>
            <div class="flex gap-2">
                <input type="text" x-model="config.productName" @input="update()" placeholder="Ø§Ø³Ù… Ø§Ù„Ù…Ù†ØªØ¬ (Content ID)">
                <input type="number" x-model="config.price" @input="update()" placeholder="Ø§Ù„Ø³Ø¹Ø±" class="w-1/3">
            </div>
        </div>

        <div class="section-box border-blue-200 bg-blue-50/50">
            <span class="section-title text-blue-700">ğŸ”— Ø§Ù„Ø±Ø¨Ø· ÙˆØ§Ù„Ù…Ø¯ÙŠØ±</span>
            <input type="text" x-model="config.sheetUrl" class="mb-2 font-mono" placeholder="Script URL">
            <input type="text" x-model="config.adminPhone" class="text-center font-bold" placeholder="Ø±Ù‚Ù… Ø§Ù„Ù…Ø¯ÙŠØ±">
        </div>
        
        <div class="section-box bg-slate-50 border-slate-300">
             <span class="section-title">ğŸ“Š Ø§Ù„Ø¨ÙŠÙƒØ³Ù„ (Ø­Ù…Ø§ÙŠØ© Ù‚ØµÙˆÙ‰ ğŸ›¡ï¸)</span>
             <div class="flex flex-col gap-2">
                <input type="text" x-model="config.fbPixel" placeholder="FB Pixel ID" @input="update()">
                <input type="text" x-model="config.ttPixel" placeholder="TikTok Pixel ID" @input="update()">
                <input type="text" x-model="config.snapPixel" placeholder="Snapchat Pixel ID" @input="update()">
            </div>
            <p class="text-[9px] text-gray-500 mt-1">ÙŠÙ…Ù†Ø¹ Ø§Ù„ØªÙƒØ±Ø§Ø± Ù†Ù‡Ø§Ø¦ÙŠØ§Ù‹ + Ø¯Ø¹Ù… E.164 âœ…</p>
        </div>

        <div class="section-box">
            <span class="section-title">ğŸ¨ Ø§Ù„Ù…Ø¸Ù‡Ø±</span>
            <div class="flex gap-2 mb-2 items-center">
                <input type="color" x-model="config.bgColor" @input="update()" class="h-8 w-8 rounded cursor-pointer p-0 border-0">
                <input type="text" x-model="config.logoUrl" @input="update()" placeholder="Ø±Ø§Ø¨Ø· Ø§Ù„Ø´Ø¹Ø§Ø±">
            </div>
            <input type="text" x-model="config.heroTitle[editLang]" @input="update()" placeholder="Ø§Ù„Ø¹Ù†ÙˆØ§Ù† Ø§Ù„Ø±Ø¦ÙŠØ³ÙŠ">
        </div>

        <div class="section-box">
            <span class="section-title">Ø§Ù„Ù…Ø­ØªÙˆÙ‰</span>
            <div class="space-y-2 mb-4">
                <template x-for="(block, index) in blocks" :key="block.id">
                    <div class="bg-white border p-2 rounded relative group">
                        <button @click="removeBlock(index)" class="absolute top-1 left-1 text-red-500 font-bold px-1 opacity-0 group-hover:opacity-100 transition">Ã—</button>
                        <div class="flex justify-between mb-1 pl-6">
                            <span class="text-[9px] bg-slate-100 px-2 rounded font-bold text-slate-500 uppercase" x-text="block.type"></span>
                            <div class="flex gap-1">
                                <button @click="moveBlock(index, -1)" class="text-xs text-gray-400 hover:text-black">â†‘</button>
                                <button @click="moveBlock(index, 1)" class="text-xs text-gray-400 hover:text-black">â†“</button>
                            </div>
                        </div>
                        
                        <template x-if="block.type === 'text'">
                            <div>
                                <div class="flex flex-wrap gap-1 mb-1">
                                    <input type="color" x-model="block.style.color" @input="update()" class="w-5 h-5 p-0 border-0 rounded cursor-pointer">
                                    <select x-model="block.style.font" @change="update()" class="w-16"><option value="Cairo">Cairo</option><option value="Tajawal">Tajawal</option></select>
                                    <select x-model="block.style.size" @change="update()" class="w-16"><option value="text-sm">S</option><option value="text-lg">M</option><option value="text-2xl">L</option><option value="text-4xl">XL</option></select>
                                    <select x-model="block.align" @change="update()" class="w-14"><option value="center">C</option><option value="right">R</option></select>
                                </div>
                                <textarea x-model="block.content[editLang]" @input="update()" class="h-14"></textarea>
                            </div>
                        </template>

                        <template x-if="block.type === 'form'">
                            <div>
                                <label class="text-[10px] text-gray-400">Ù†Øµ Ø²Ø± Ø§Ù„ØªØ£ÙƒÙŠØ¯</label>
                                <input type="text" x-model="block.btnText[editLang]" @input="update()" class="text-center font-bold text-pink-600 border-pink-200">
                            </div>
                        </template>

                        <template x-if="['image','video','iframe','embed'].includes(block.type)">
                            <textarea x-model="block.content ? block.content[editLang] : block.url" @input="update()" class="h-16 font-mono text-[10px]" placeholder="URL or Code"></textarea>
                        </template>

                        <template x-if="block.type === 'urgency_box'">
                            <div class="flex gap-1">
                                <input type="number" x-model="block.visitors" @input="update()" placeholder="Ø§Ù„Ø²ÙˆØ§Ø±">
                                <input type="number" x-model="block.left" @input="update()" placeholder="Ø¨Ø§Ù‚ÙŠ">
                                <input type="number" x-model="block.timerMinutes" @input="update()" placeholder="Ø¯Ù‚Ø§Ø¦Ù‚">
                            </div>
                        </template>
                    </div>
                </template>
            </div>
            
            <div class="btn-grid">
                <button class="btn-add border-sky-500 bg-sky-100" @click="addBlock('gallery')">ğŸ“¸ ØµÙˆØ±</button>
                <button class="btn-add" @click="addBlock('text')">ğŸ“ Ù†Øµ</button>
                <button class="btn-add" @click="addBlock('image')">ğŸ–¼ï¸ ØµÙˆØ±Ø©</button>
                <button class="btn-add" @click="addBlock('form')">ğŸ“‹ ÙÙˆØ±Ù…</button>
                <button class="btn-add" @click="addBlock('offers_slider')">ğŸ›’ Ø³Ù„Ø§ÙŠØ¯Ø±</button>
                <button class="btn-add border-purple-500 bg-purple-100" @click="addBlock('faq')">â“ Ø£Ø³Ø¦Ù„Ø©</button>
                <button class="btn-add" @click="addBlock('urgency_box')">ğŸ”¥ Ø¶ØºØ·</button>
                <button class="btn-add" @click="addBlock('interactive_rating')">â­ ØªÙ‚ÙŠÙŠÙ…</button>
                <button class="btn-add" @click="addBlock('sales_pop')">ğŸ”” Ø¥Ø´Ø¹Ø§Ø±</button>
                <button class="btn-add border-amber-500 bg-amber-100" @click="addBlock('comparison')">âš–ï¸ Ù…Ù‚Ø§Ø±Ù†Ø©</button>
                <button class="btn-add" @click="addBlock('fragrantica')">â­ Ø¢Ø±Ø§Ø¡</button>
                <button class="btn-add" @click="addBlock('embed')">ğŸ’» ÙƒÙˆØ¯</button>
            </div>
        </div>

        <button class="btn-action bg-black text-white" @click="downloadHTML()">ğŸ’¾ ØªØ­Ù…ÙŠÙ„ (Download)</button>
        <button class="btn-action bg-gray-600 text-white" @click="copyCode()">ğŸ“‹ Ù†Ø³Ø® (Copy)</button>
    </aside>

    <main class="preview-area">
        <div class="zoom-controls">
            <button @click="zoom-=0.1">-</button><span x-text="Math.round(zoom*100)+'%'"></span><button @click="zoom+=0.1">+</button>
            <button @click="update()" class="border-r border-white/30 pr-2 mr-2">ğŸ”„</button>
        </div>
        <div class="iphone" :style="`transform: scale(${zoom})`"><iframe id="preview-frame"></iframe></div>
    </main>
</div>

<script>
    function builderApp() {
        return {
            editLang: 'ar', zoom: 0.85, timeout: null,
            config: {
                bgColor: '#96701d', logoUrl: 'https://madperfume.ps/upload/01-2026/page/6977cf82b87ef.png',
                heroTitle: {ar: 'Ø£Ù‚ÙˆÙ‰ Ø§Ù„Ø¹Ø±ÙˆØ¶ Ø§Ù„Ø­ØµØ±ÙŠØ©', he: '×”××‘×¦×¢×™× ×”×—××™×'}, productName: 'exotic oud', price: '400', adminPhone: '972525105889',
                sheetUrl: 'https://script.google.com/macros/s/AKfycbw7m6OCcTnH6CILpTo2TVRZIXXy5cui-zhKsCq3k491yaun5Hd5b_QECTjCrpCytkndDg/exec',
                fbPixel: '1072283127290819', ttPixel: 'D2D02JBC77U4ENLN9SBG', snapPixel: 'b143822e-1c3c-40ff-93f7-edadee74e626'
            },
            blocks: [
                {id:1, type:'text', content:{ar:'ØªÙˆØµÙŠÙ„ Ù„Ø¬Ù…ÙŠØ¹ Ø§Ù„Ù…Ù†Ø§Ø·Ù‚', he:'××©×œ×•×— ×—×™× ×'}, align:'center', style:{color:'#ffffff', size:'text-lg', font:'Cairo'}},
                {id:1769632356116, type:'urgency_box', sold:'860', left:'96', visitors:'735', timerMinutes:44},
                {id:2, type:'form', content:{ar:'Ø§Ø·Ù„Ø¨ Ø§Ù„Ø¢Ù†', he:'×”×–××Ÿ ×¢×›×©×™×•'}, btnText:{ar:'ØªØ£ÙƒÙŠØ¯ Ø§Ù„Ø·Ù„Ø¨', he:'×©×œ×— ×”×–×× ×”'}, align:'center'}
            ],
            init() { setTimeout(()=> this.update(), 500); if(window.innerHeight<900) this.zoom=0.7; },
            update() { 
                clearTimeout(this.timeout); 
                this.timeout = setTimeout(() => {
                    const frame = document.getElementById('preview-frame');
                    if(frame) frame.srcdoc = this.generateFinalHTML(false);
                }, 300); 
            },
            addBlock(type) {
                let block = {id:Date.now(), type, content:{ar:'',he:''}, url:'', link:'#', align:'center', style:{color:'#000', size:'text-base', font:'Cairo'}};
                if(type==='form') block.btnText = {ar:'ØªØ£ÙƒÙŠØ¯', he:'××™×©×•×¨'};
                if(type==='urgency_box') { block.visitors='600'; block.left='8'; block.timerMinutes=15; }
                this.blocks.push(block); this.update();
            },
            removeBlock(i) { this.blocks.splice(i,1); this.update(); },
            moveBlock(i,d) {
                const ni = i+d;
                if(ni>=0 && ni<this.blocks.length) {
                    [this.blocks[i], this.blocks[ni]] = [this.blocks[ni], this.blocks[i]];
                    this.update();
                }
            },
            generateFinalHTML(isDownload) {
                const bJ = JSON.stringify(this.blocks).replace(/</g, '\\u003c');
                const cJ = JSON.stringify(this.config).replace(/</g, '\\u003c');
                const PROD_NAME = (this.config.productName || '').replace(/'/g, "\\'");
                const PRICE_VAL = this.config.price || '0';
                const iL = isDownload ? null : `'${this.editLang}'`;
                
                // âœ… E.164 Clean Logic
                const CLEAN_PHONE_JS = `
                function cleanPhoneE164(p) {
                   if (!p) return '';
                   let n = p.replace(/[^0-9]/g, '');
                   if (n.startsWith('05')) n = '972' + n.substring(1);
                   else if (n.startsWith('00')) n = n.substring(2);
                   return n;
                }`;

                return `<!DOCTYPE html>
<html x-data="app()" x-init="init(${iL})" :lang="lang" :dir="lang==='he'?'ltr':'rtl'">
<head>
<meta charset="UTF-8"><meta name="viewport" content="width=device-width, initial-scale=1.0">
<script src="https://cdn.tailwindcss.com"><\/script>
<script src="https://unpkg.com/alpinejs@3.x.x/dist/cdn.min.js" defer><\/script>
<link href="https://fonts.googleapis.com/css2?family=Cairo:wght@400;900&display=swap" rel="stylesheet">
<style>
body { background: ${this.config.bgColor}; font-family: 'Cairo', sans-serif; }
.inp { width: 100%; padding: 15px; background: #f8fafc; border: 1px solid #ddd; border-radius: 12px; margin-bottom: 10px; font-weight: bold; }
.btn-main { background: #000; color: #fff; width: 100%; padding: 18px; border-radius: 14px; font-weight: 900; font-size: 1.2rem; animation: pulse 2s infinite; }
@keyframes pulse { 0% { transform: scale(1); } 50% { transform: scale(1.03); } 100% { transform: scale(1); } }
</style>
<script>
    ${CLEAN_PHONE_JS}
    
    function loadPixels() {
        // Facebook
        !function(f,b,e,v,n,t,s){if(f.fbq)return;n=f.fbq=function(){n.callMethod?n.callMethod.apply(n,arguments):n.queue.push(arguments)};if(!f._fbq)n=f.fbq;n.push=n;n.loaded=!0;n.version='2.0';n.queue=[];t=b.createElement(e);t.async=!0;t.src=v;s=b.getElementsByTagName(e)[0];s.parentNode.insertBefore(t,s)}(window,document,'script','https://connect.facebook.net/en_US/fbevents.js');
        if('${this.config.fbPixel}') { fbq('init', '${this.config.fbPixel}'); fbq('track', 'PageView'); }
        
        // TikTok
        !function (w, d, t) { w.TiktokAnalyticsObject=t; var ttq=w[t]=w[t]||[]; ttq.methods=["page","track","identify","instances","debug","on","off","once","ready","alias","group","enableCookie","disableCookie","holdConsent","revokeConsent","grantConsent"]; ttq.setAndDefer=function(t,e){t[e]=function(){t.push([e].concat(Array.prototype.slice.call(arguments,0)))}}; for(var i=0;i<ttq.methods.length;i++)ttq.setAndDefer(ttq,ttq.methods[i]); ttq.load=function(e,n){ var r="https://analytics.tiktok.com/i18n/pixel/events.js"; var o=n&&n.partner; ttq._i=ttq._i||{}; ttq._i[e]=[]; ttq._i[e]._u=r; ttq._t=ttq._t||{}; ttq._t[e]=+new Date; ttq._o=ttq._o||{}; ttq._o[e]=n||{}; n=document.createElement("script"); n.type="text/javascript"; n.async=!0; n.src=r+"?sdkid="+e+"&lib="+t; e=document.getElementsByTagName("script")[0]; e.parentNode.insertBefore(n,e) }; ttq.load('${this.config.ttPixel}'); ttq.page(); }(window, document, 'ttq');
    }
<\/script>
</head>
<body class="pb-10">
    <nav class="p-4 flex justify-center bg-white/20 backdrop-blur sticky top-0 z-50"><img src="${this.config.logoUrl}" class="h-10"></nav>
    <main class="max-w-md mx-auto px-4 mt-6">
        <template x-for="b in blocks">
            <div class="my-6" :class="'text-'+b.align">
                <template x-if="b.type==='text'">
                    <p :style="{color:b.style?.color, fontSize:b.style?.size}" x-text="b.content[lang]"></p>
                </template>
                
                <template x-if="b.type==='form'">
                    <div class="bg-white p-6 rounded-3xl shadow-xl">
                        <h2 class="text-xl font-black text-center mb-4" x-text="b.content[lang]"></h2>
                        <form @submit.prevent="submitForm">
                            <input type="text" x-model="f.name" @input="trackCart" class="inp" placeholder="Ø§Ù„Ø§Ø³Ù…" required>
                            <input type="tel" x-model="f.phone" dir="ltr" class="inp text-right" placeholder="05XXXXXXXX" required>
                            <input type="text" x-model="f.address" class="inp" placeholder="Ø§Ù„Ø¹Ù†ÙˆØ§Ù†" required>
                            <button type="submit" class="btn-main" :disabled="loading" x-text="loading?'...':b.btnText[lang]"></button>
                        </form>
                    </div>
                </template>
            </div>
        </template>
    </main>

    <script>
        function app() {
            return {
                lang:'ar', loading:false, hasStartedTyping:false,
                blocks:${bJ}, c:${cJ}, f:{name:'',phone:'',address:''},
                init(l) { 
                    this.lang = l || 'ar';
                    loadPixels();
                },
                trackCart() {
                    if(!this.hasStartedTyping && this.f.phone.length > 5) {
                        this.hasStartedTyping = true;
                        let e164 = cleanPhoneE164(this.f.phone);
                        
                        if(window.ttq) {
                            ttq.identify({ phone_number: e164 });
                            ttq.track('AddToCart', { content_name: '${PROD_NAME}', value: ${PRICE_VAL}, currency: 'ILS' });
                        }
                        if(window.fbq) {
                            fbq('track', 'AddToCart', { content_name: '${PROD_NAME}', value: ${PRICE_VAL}, currency: 'ILS' });
                        }
                    }
                },
                async submitForm() {
                    this.loading = true;
                    let e164 = cleanPhoneE164(this.f.phone);
                    
                    if(window.ttq) {
                        ttq.identify({ phone_number: e164 });
                        ttq.track('CompletePayment', { value: ${PRICE_VAL}, currency: 'ILS' });
                    }
                    if(window.fbq) {
                        fbq('track', 'Purchase', { value: ${PRICE_VAL}, currency: 'ILS' });
                    }

                    const fd = new FormData();
                    fd.append('name', this.f.name); fd.append('phone', this.f.phone); fd.append('address', this.f.address);
                    fd.append('offer', '${PROD_NAME}'); fd.append('price', '${PRICE_VAL}');
                    
                    await fetch(this.c.sheetUrl, {method:'POST', body:fd, mode:'no-cors'});
                    alert('Success!');
                    this.loading = false;
                }
            }
        }
    <\/script>
</body>
</html>`;
            },
            copyCode() { /* logic */ },
            downloadHTML() { /* logic */ }
        }
    }
</script>
</body>
</html>
