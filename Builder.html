<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>MAD Builder V53 - Pixel Precision üõ°Ô∏è</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/lucide@latest" defer></script>
    <script src="https://unpkg.com/alpinejs@3.x.x/dist/cdn.min.js" defer></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Amiri:wght@400;700&family=Cairo:wght@200..1000&family=Tajawal:wght@200..900&display=swap');
        [x-cloak] { display: none !important; }
        body { font-family: 'Cairo', sans-serif; background: #e2e8f0; height: 100vh; overflow: hidden; }
        .app-layout { display: flex; height: 100vh; flex-direction: row-reverse; }
        .editor-sidebar { width: 400px; background: #fff; border-left: 1px solid #cbd5e1; overflow-y: auto; padding: 15px; flex-shrink: 0; box-shadow: -5px 0 15px rgba(0,0,0,0.05); }
        .preview-area { flex: 1; background: #f1f5f9; display: flex; flex-direction: column; align-items: center; justify-content: center; position: relative; }
        .iphone { width: 375px; height: 750px; background: #000; border-radius: 40px; border: 12px solid #2d2d2d; overflow: hidden; position: relative; box-shadow: 0 25px 50px -12px rgba(0,0,0,0.5); background-color: #fff; transition: transform 0.2s; }
        .iphone iframe { width: 100%; height: 100%; border: none; background: #fff; }
        .section-box { background: #f8fafc; border: 1px solid #e2e8f0; border-radius: 8px; padding: 10px; margin-bottom: 10px; }
        .section-title { font-weight: 900; font-size: 0.8rem; color: #475569; margin-bottom: 5px; display: block; }
        input, textarea, select { width: 100%; padding: 6px; border: 1px solid #cbd5e1; border-radius: 6px; font-size: 11px; outline: none; transition: 0.2s; }
        input:focus { border-color: #3b82f6; box-shadow: 0 0 0 2px rgba(59, 130, 246, 0.1); }
        .btn-grid { display: grid; grid-template-columns: repeat(3, 1fr); gap: 5px; }
        .btn-add { background: #fff; border: 1px solid #cbd5e1; padding: 8px; border-radius: 6px; font-size: 10px; font-weight: bold; cursor: pointer; display: flex; align-items: center; justify-content: center; gap: 3px; transition: 0.2s; }
        .btn-add:hover { background: #f1f5f9; border-color: #94a3b8; }
        .btn-action { width: 100%; padding: 10px; border-radius: 8px; font-weight: 800; margin-top: 5px; cursor: pointer; text-align: center; font-size: 0.9rem; }
        .zoom-controls { position: fixed; bottom: 20px; left: 50%; transform: translateX(-50%); background: rgba(0,0,0,0.8); padding: 5px 15px; border-radius: 99px; display: flex; gap: 10px; color: white; z-index: 50; align-items: center; font-size: 12px; }
    </style>
</head>
<body>

<div class="app-layout" x-data="builderApp()" x-init="init()" x-cloak>
    <aside class="editor-sidebar">
        <h1 class="text-xl font-black mb-4 text-center text-slate-800">MAD BUILDER <span class="text-blue-600">V53 GUARD</span></h1>
        
        <div class="flex bg-slate-100 p-1 rounded-lg mb-4">
            <button @click="editLang='ar'; update()" :class="editLang==='ar'?'bg-white shadow text-black':'text-gray-500'" class="flex-1 py-1.5 rounded text-xs font-bold transition">ÿπÿ±ÿ®Ÿä</button>
            <button @click="editLang='he'; update()" :class="editLang==='he'?'bg-white shadow text-black':'text-gray-500'" class="flex-1 py-1.5 rounded text-xs font-bold transition">◊¢◊ë◊®◊ô◊™</button>
        </div>

        <div class="section-box border-green-200 bg-green-50/50">
            <span class="section-title text-green-700">üí∞ ÿ•ÿπÿØÿßÿØÿßÿ™ ÿßŸÑŸÖŸÜÿ™ÿ¨ (VSA)</span>
            <div class="flex gap-2">
                <input type="text" x-model="config.productName" @input="update()" placeholder="ÿßÿ≥ŸÖ ÿßŸÑŸÖŸÜÿ™ÿ¨ (Content ID)">
                <input type="number" x-model="config.price" @input="update()" placeholder="ÿßŸÑÿ≥ÿπÿ±" class="w-1/3">
            </div>
        </div>

        <div class="section-box border-blue-200 bg-blue-50/50">
            <span class="section-title text-blue-700">üîó ÿßŸÑÿ±ÿ®ÿ∑ ŸàÿßŸÑŸÖÿØŸäÿ±</span>
            <input type="text" x-model="config.sheetUrl" class="mb-2 font-mono" placeholder="Script URL">
            <input type="text" x-model="config.adminPhone" class="text-center font-bold" placeholder="ÿ±ŸÇŸÖ ÿßŸÑŸÖÿØŸäÿ±">
        </div>
        
        <div class="section-box bg-slate-50 border-slate-300">
             <span class="section-title">üìä ÿßŸÑÿ®ŸäŸÉÿ≥ŸÑ (ÿ≠ŸÖÿßŸäÿ© ŸÇÿµŸàŸâ üõ°Ô∏è)</span>
             <div class="flex flex-col gap-2">
                <input type="text" x-model="config.fbPixel" placeholder="FB Pixel ID" @input="update()">
                <input type="text" x-model="config.ttPixel" placeholder="TikTok Pixel ID" @input="update()">
                <input type="text" x-model="config.snapPixel" placeholder="Snapchat Pixel ID" @input="update()">
            </div>
            <p class="text-[9px] text-gray-500 mt-1">ŸäŸÖŸÜÿπ ÿßŸÑÿ™ŸÉÿ±ÿßÿ± ŸÜŸáÿßÿ¶ŸäÿßŸã + ŸäÿØÿπŸÖ VSA ‚úÖ</p>
        </div>

        <div class="section-box">
            <span class="section-title">üé® ÿßŸÑŸÖÿ∏Ÿáÿ±</span>
            <div class="flex gap-2 mb-2 items-center">
                <input type="color" x-model="config.bgColor" @input="update()" class="h-8 w-8 rounded cursor-pointer p-0 border-0">
                <input type="text" x-model="config.logoUrl" @input="update()" placeholder="ÿ±ÿßÿ®ÿ∑ ÿßŸÑÿ¥ÿπÿßÿ±">
            </div>
            <input type="text" x-model="config.heroTitle[editLang]" @input="update()" placeholder="ÿßŸÑÿπŸÜŸàÿßŸÜ ÿßŸÑÿ±ÿ¶Ÿäÿ≥Ÿä">
        </div>

        <div class="section-box">
            <span class="section-title">ÿßŸÑŸÖÿ≠ÿ™ŸàŸâ</span>
            <div class="space-y-2 mb-4">
                <template x-for="(block, index) in blocks" :key="block.id">
                    <div class="bg-white border p-2 rounded relative group">
                        <button @click="removeBlock(index)" class="absolute top-1 left-1 text-red-500 font-bold px-1 opacity-0 group-hover:opacity-100 transition">√ó</button>
                        <div class="flex justify-between mb-1 pl-6">
                            <span class="text-[9px] bg-slate-100 px-2 rounded font-bold text-slate-500 uppercase" x-text="block.type"></span>
                            <div class="flex gap-1">
                                <button @click="moveBlock(index, -1)" class="text-xs text-gray-400 hover:text-black">‚Üë</button>
                                <button @click="moveBlock(index, 1)" class="text-xs text-gray-400 hover:text-black">‚Üì</button>
                            </div>
                        </div>
                        
                        <template x-if="block.type === 'text'">
                            <div>
                                <div class="flex flex-wrap gap-1 mb-1">
                                    <input type="color" x-model="block.style.color" @input="update()" class="w-5 h-5 p-0 border-0 rounded cursor-pointer">
                                    <select x-model="block.style.font" @change="update()" class="w-16"><option value="Cairo">Cairo</option><option value="Tajawal">Tajawal</option></select>
                                    <select x-model="block.style.size" @change="update()" class="w-16"><option value="text-sm">S</option><option value="text-lg">M</option><option value="text-2xl">L</option><option value="text-4xl">XL</option></select>
                                    <select x-model="block.align" @change="update()" class="w-14"><option value="center">C</option><option value="right">R</option></select>
                                </div>
                                <textarea x-model="block.content[editLang]" @input="update()" class="h-14"></textarea>
                            </div>
                        </template>

                        <template x-if="block.type === 'offers_slider'">
                            <div>
                                <input type="text" x-model="block.title[editLang]" @input="update()" class="mb-2" placeholder="ÿπŸÜŸàÿßŸÜ ÿßŸÑŸÇÿ≥ŸÖ">
                                <div class="flex gap-2 mb-2">
                                    <select x-model="block.aspect" @change="update()" class="w-1/2 text-[10px]"><option value="portrait">ÿ∑ŸàŸÑŸä</option><option value="square">ŸÖÿ±ÿ®ÿπ</option><option value="landscape">ÿπÿ±Ÿäÿ∂</option></select>
                                    <select x-model="block.fit" @change="update()" class="w-1/2 text-[10px]"><option value="contain">ÿßÿ≠ÿ™Ÿàÿßÿ°</option><option value="cover">ŸÖŸÑÿ°</option></select>
                                </div>
                                <template x-for="(offer, oIdx) in block.items">
                                    <div class="bg-slate-50 p-1 mb-1 border flex gap-1 items-center">
                                        <input x-model="offer.title[editLang]" @input="update()" class="flex-1" placeholder="ÿßÿ≥ŸÖ">
                                        <input x-model="offer.price" @input="update()" class="w-12 text-center" placeholder="ÿ≥ÿπÿ±">
                                        <input x-model="offer.img" @input="update()" class="w-1/3" placeholder="ÿµŸàÿ±ÿ©">
                                        <button @click="block.items.splice(oIdx, 1); update()" class="text-red-500 font-bold px-1">x</button>
                                    </div>
                                </template>
                                <button @click="block.items.push({img:'', title:{ar:'ÿ¨ÿØŸäÿØ',he:'◊ó◊ì◊©'}, price:'100', link:'#'}); update()" class="w-full text-[10px] text-blue-600 bg-blue-50 py-1 rounded">+ ÿ•ÿ∂ÿßŸÅÿ© ÿπÿ±ÿ∂</button>
                            </div>
                        </template>

                        <template x-if="block.type === 'urgency_box'">
                            <div class="flex gap-1">
                                <input type="number" x-model="block.visitors" @input="update()" placeholder="ÿßŸÑÿ≤Ÿàÿßÿ± (600)">
                                <input type="number" x-model="block.left" @input="update()" placeholder="ÿ®ÿßŸÇŸä (8)">
                                <input type="number" x-model="block.timerMinutes" @input="update()" placeholder="ÿØŸÇÿßÿ¶ŸÇ (15)">
                            </div>
                        </template>

                        <template x-if="block.type === 'form'">
                            <div>
                                <label>ŸÜÿµ ÿ≤ÿ± ÿßŸÑÿ™ÿ£ŸÉŸäÿØ</label>
                                <input type="text" x-model="block.btnText[editLang]" @input="update()" class="text-center font-bold text-pink-600 border-pink-200">
                            </div>
                        </template>

                        <template x-if="['image','video','iframe','embed'].includes(block.type)">
                            <textarea x-model="block.content ? block.content[editLang] : block.url" @input="update()" class="h-16 font-mono text-[10px]" placeholder="URL or Code"></textarea>
                        </template>
                         <template x-if="block.type === 'interactive_rating'">
                            <input type="text" x-model="block.content[editLang]" @input="update()" placeholder="ÿπŸÜŸàÿßŸÜ ÿßŸÑÿ≥ÿ§ÿßŸÑ">
                        </template>
                        
                        <template x-if="block.type === 'comparison'">
                            <div>
                                <div class="space-y-1 max-h-40 overflow-y-auto">
                                    <template x-for="(row, rIdx) in block.items">
                                        <div class="bg-slate-50 p-1 border rounded relative flex gap-1">
                                            <input x-model="row.mad[editLang]" @input="update()" class="w-1/2 text-[9px]" placeholder="MAD">
                                            <input x-model="row.other[editLang]" @input="update()" class="w-1/2 text-[9px]" placeholder="Other">
                                            <button @click="block.items.splice(rIdx, 1); update()" class="text-red-500 font-bold text-[10px]">x</button>
                                        </div>
                                    </template>
                                </div>
                                <button @click="block.items.push({mad:{ar:'', he:''}, other:{ar:'', he:''}}); update()" class="text-[10px] text-blue-600 font-bold mt-1">+ ÿ•ÿ∂ÿßŸÅÿ© ÿ≥ÿ∑ÿ±</button>
                            </div>
                        </template>
                        
                        <template x-if="block.type === 'fragrantica'">
                            <div class="flex gap-1">
                                <select x-model="block.stars" @change="update()"><option value="5">5</option><option value="4">4</option></select>
                                <input x-model="block.score" @input="update()" placeholder="Score">
                            </div>
                        </template>
                        
                        <template x-if="block.type === 'faq'">
                            <div>
                                <div class="space-y-1 max-h-40 overflow-y-auto">
                                    <template x-for="(qa, i) in block.items">
                                        <div class="bg-slate-50 p-1 border rounded relative">
                                            <button @click="block.items.splice(i, 1); update()" class="absolute top-1 left-1 text-red-500 text-[10px]">x</button>
                                            <input x-model="qa.q[editLang]" @input="update()" class="w-full mb-1 text-[10px] font-bold" placeholder="ÿßŸÑÿ≥ÿ§ÿßŸÑ">
                                            <textarea x-model="qa.a[editLang]" @input="update()" class="w-full h-8 text-[10px]" placeholder="ÿßŸÑÿ¨Ÿàÿßÿ®"></textarea>
                                        </div>
                                    </template>
                                </div>
                                <button @click="block.items.push({q:{ar:'',he:''}, a:{ar:'',he:''}}); update()" class="w-full text-[10px] text-purple-600 bg-purple-50 py-1 rounded mt-1">+ ÿ≥ÿ§ÿßŸÑ</button>
                            </div>
                        </template>
                        
                        <template x-if="block.type === 'gallery'">
                            <div>
                                <div class="flex gap-2 mb-2">
                                    <select x-model="block.aspect" @change="update()" class="w-1/2 text-[10px]"><option value="portrait">ÿ∑ŸàŸÑŸä</option><option value="square">ŸÖÿ±ÿ®ÿπ</option><option value="landscape">ÿπÿ±Ÿäÿ∂</option></select>
                                    <select x-model="block.fit" @change="update()" class="w-1/2 text-[10px]"><option value="cover">ŸÖŸÑÿ°</option><option value="contain">ÿßÿ≠ÿ™Ÿàÿßÿ°</option></select>
                                </div>
                                <div class="space-y-1 max-h-40 overflow-y-auto pr-1">
                                    <template x-for="(img, idx) in block.images">
                                        <div class="flex gap-1 mb-1">
                                            <input type="text" x-model="block.images[idx]" @input="update()" placeholder="ÿ±ÿßÿ®ÿ∑ ÿßŸÑÿµŸàÿ±ÿ©..." class="w-full text-[10px]">
                                            <button @click="block.images.splice(idx, 1); update()" class="text-red-500 font-bold text-xs px-1">x</button>
                                        </div>
                                    </template>
                                </div>
                                <button @click="block.images.push('https://via.placeholder.com/400x600'); update()" class="w-full text-[10px] text-sky-600 bg-sky-50 py-1 rounded mt-1">+ ÿ•ÿ∂ÿßŸÅÿ© ÿµŸàÿ±ÿ©</button>
                            </div>
                        </template>
                    </div>
                </template>
            </div>
            
            <div class="btn-grid">
                <button class="btn-add border-sky-500 bg-sky-100 text-sky-900 font-bold" @click="addBlock('gallery')">üì∏ ÿµŸàÿ±</button>
                <button class="btn-add" @click="addBlock('text')">üìù ŸÜÿµ</button>
                <button class="btn-add" @click="addBlock('image')">üñºÔ∏è ÿµŸàÿ±ÿ©</button>
                <button class="btn-add" @click="addBlock('form')">üìã ŸÅŸàÿ±ŸÖ</button>
                <button class="btn-add" @click="addBlock('offers_slider')">üõí ÿ≥ŸÑÿßŸäÿØÿ±</button>
                <button class="btn-add border-purple-500 bg-purple-100 text-purple-900 font-bold" @click="addBlock('faq')">‚ùì ÿ£ÿ≥ÿ¶ŸÑÿ© (6)</button>
                <button class="btn-add" @click="addBlock('urgency_box')">üî• ÿ∂ÿ∫ÿ∑</button>
                <button class="btn-add" @click="addBlock('interactive_rating')">‚≠ê ÿ™ŸÇŸäŸäŸÖ</button>
                <button class="btn-add" @click="addBlock('sales_pop')">üîî ÿ•ÿ¥ÿπÿßÿ±</button>
                <button class="btn-add border-amber-500 bg-amber-100 text-amber-900 font-bold" @click="addBlock('comparison')">‚öñÔ∏è ŸÖŸÇÿßÿ±ŸÜÿ© (6)</button>
                <button class="btn-add" @click="addBlock('fragrantica')">‚≠ê ÿ¢ÿ±ÿßÿ°</button>
                <button class="btn-add" @click="addBlock('embed')">üíª ŸÉŸàÿØ</button>
            </div>
        </div>

        <button class="btn-action bg-black text-white" @click="downloadHTML()">üíæ ÿ™ÿ≠ŸÖŸäŸÑ (Download)</button>
        <button class="btn-action bg-gray-600 text-white" @click="copyCode()">üìã ŸÜÿ≥ÿÆ (Copy)</button>
    </aside>

    <main class="preview-area">
        <div class="zoom-controls">
            <button @click="zoom-=0.1">-</button><span x-text="Math.round(zoom*100)+'%'"></span><button @click="zoom+=0.1">+</button>
            <button @click="update()" class="border-r border-white/30 pr-2 mr-2">üîÑ</button>
        </div>
        <div class="iphone" :style="`transform: scale(${zoom})`"><iframe id="preview-frame"></iframe></div>
    </main>
</div>

<script>
    function builderApp() {
        return {
            editLang: 'ar', zoom: 0.85, timeout: null,
            config: {
                bgColor: '#96701d', logoUrl: 'https://madperfume.ps/upload/01-2026/page/6977cf82b87ef.png',
                heroTitle: {ar: 'ÿ£ŸÇŸàŸâ ÿßŸÑÿπÿ±Ÿàÿ∂ ÿßŸÑÿ≠ÿµÿ±Ÿäÿ©', he: '◊î◊û◊ë◊¶◊¢◊ô◊ù ◊î◊ó◊û◊ô◊ù'}, productName: 'exotic oud', price: '400', adminPhone: '972525105889',
                sheetUrl: 'https://script.google.com/macros/s/AKfycbw7m6OCcTnH6CILpTo2TVRZIXXy5cui-zhKsCq3k491yaun5Hd5b_QECTjCrpCytkndDg/exec',
                fbPixel: '1072283127290819', ttPixel: 'D2D02JBC77U4ENLN9SBG', snapPixel: 'b143822e-1c3c-40ff-93f7-edadee74e626'
            },
            blocks: [
                {id:1, type:'text', content:{ar:'ÿ™ŸàÿµŸäŸÑ ŸÑÿ¨ŸÖŸäÿπ ÿßŸÑŸÖŸÜÿßÿ∑ŸÇ', he:'◊û◊©◊ú◊ï◊ó ◊ó◊ô◊†◊ù'}, align:'center', style:{color:'#ffffff', size:'text-lg', font:'Cairo'}},
                {id:1769632356116, type:'urgency_box', sold:'860', left:'96', visitors:'735', timerMinutes:44},
                {id:2, type:'form', content:{ar:'ÿßÿ∑ŸÑÿ® ÿßŸÑÿ¢ŸÜ', he:'◊î◊ñ◊û◊ü ◊¢◊õ◊©◊ô◊ï'}, btnText:{ar:'ÿ™ÿ£ŸÉŸäÿØ ÿßŸÑÿ∑ŸÑÿ®', he:'◊©◊ú◊ó ◊î◊ñ◊û◊†◊î'}, align:'center'}
            ],
            init() { setTimeout(()=> this.update(), 500); if(window.innerHeight<900) this.zoom=0.7; },
            update() { 
                clearTimeout(this.timeout); 
                this.timeout = setTimeout(() => {
                    const frame = document.getElementById('preview-frame');
                    if(frame) frame.srcdoc = this.generateFinalHTML(false);
                }, 300); 
            },
            addBlock(type) {
                let block = {id:Date.now(), type, content:{ar:'',he:''}, url:'', link:'#', align:'center', style:{color:'#000', size:'text-base', font:'Cairo'}};
                if(type==='form') block.btnText = {ar:'ÿ™ÿ£ŸÉŸäÿØ', he:'◊ê◊ô◊©◊ï◊®'};
                if(type==='offers_slider') { 
                    block.title={ar:'ÿπÿ±Ÿàÿ∂ ÿ£ÿÆÿ±Ÿâ',he:'◊¢◊ï◊ì ◊û◊ï◊¶◊®◊ô◊ù'}; 
                    block.items=[]; 
                    block.fit = 'contain'; 
                    block.aspect = 'portrait'; 
                }
                if(type==='gallery') { 
                    block.images=['https://via.placeholder.com/400x600', 'https://via.placeholder.com/400x600/eee']; 
                    block.aspect = 'portrait'; 
                    block.fit = 'cover'; 
                }
                if(type==='urgency_box') { block.visitors='600'; block.left='8'; block.timerMinutes=15; }
                if(type==='interactive_rating') { block.content={ar:'ŸÖÿß ÿ±ÿ£ŸäŸÉÿü', he:'◊û◊î ◊ì◊¢◊™◊ö?'}; }
                if(type==='sales_pop') { block.content={ar:'ŸÖŸÅÿπŸÑ', he:'ON'}; }
                
                // Auto-fill Logic
                if(type==='faq') { 
                    block.items=[
                        {q:{ar:'ŸáŸÑ ÿßŸÑÿπÿ∑Ÿàÿ± ÿ£ÿµŸÑŸäÿ©ÿü', he:'◊î◊ê◊ù ◊î◊ë◊©◊û◊ô◊ù ◊û◊ß◊ï◊®◊ô◊ô◊ù?'}, a:{ar:'ŸÜÿπŸÖÿå ÿ¨ŸÖŸäÿπ ÿπÿ∑Ÿàÿ±ŸÜÿß ÿ£ÿµŸÑŸäÿ© 100% ŸàŸÖÿµÿßÿØŸÇ ÿπŸÑŸäŸáÿß.', he:'◊õ◊ü, ◊õ◊ú ◊î◊ë◊©◊û◊ô◊ù ◊©◊ú◊†◊ï ◊û◊ß◊ï◊®◊ô◊ô◊ù ◊ë-100% ◊ï◊û◊ê◊ï◊©◊®◊ô◊ù.'}},
                        {q:{ar:'ŸÉŸÖ ŸÖÿØÿ© ÿßŸÑÿ™ŸàÿµŸäŸÑÿü', he:'◊û◊î ◊ñ◊û◊ü ◊î◊û◊©◊ú◊ï◊ó?'}, a:{ar:'ÿßŸÑÿ™ŸàÿµŸäŸÑ Ÿäÿ™ŸÖ ÿÆŸÑÿßŸÑ 1-3 ÿ£ŸäÿßŸÖ ÿπŸÖŸÑ.', he:'◊î◊û◊©◊ú◊ï◊ó ◊û◊™◊ë◊¶◊¢ ◊™◊ï◊ö 1-3 ◊ô◊û◊ô ◊¢◊°◊ß◊ô◊ù.'}},
                        {q:{ar:'ŸáŸÑ ŸäŸÖŸÉŸÜ ÿßŸÑÿØŸÅÿπ ÿπŸÜÿØ ÿßŸÑÿßÿ≥ÿ™ŸÑÿßŸÖÿü', he:'◊ê◊§◊©◊® ◊ú◊©◊ú◊ù ◊ë◊ß◊ë◊ú◊î?'}, a:{ar:'ŸÜÿπŸÖÿå ŸÜŸàŸÅÿ± ÿÆÿØŸÖÿ© ÿßŸÑÿØŸÅÿπ ÿπŸÜÿØ ÿßŸÑÿßÿ≥ÿ™ŸÑÿßŸÖ (ÿßŸÑŸÉÿßÿ¥).', he:'◊õ◊ü, ◊ê◊†◊ï ◊û◊¶◊ô◊¢◊ô◊ù ◊©◊ô◊®◊ï◊™ ◊™◊©◊ú◊ï◊ù ◊ë◊û◊ñ◊ï◊û◊ü ◊ë◊¢◊™ ◊î◊û◊°◊ô◊®◊î.'}},
                        {q:{ar:'ŸáŸÑ ÿßŸÑÿ±ÿßÿ¶ÿ≠ÿ© ÿ´ÿßÿ®ÿ™ÿ©ÿü', he:'◊î◊ê◊ù ◊î◊®◊ô◊ó ◊¢◊û◊ô◊ì?'}, a:{ar:'ŸÜÿπŸÖÿå ÿ™ÿ±ŸÉŸäÿ≤ ÿßŸÑÿπÿ∑Ÿàÿ± ÿπÿßŸÑŸä ŸÑÿ∂ŸÖÿßŸÜ ÿßŸÑÿ´ÿ®ÿßÿ™.', he:'◊õ◊ü, ◊®◊ô◊õ◊ï◊ñ ◊î◊ë◊©◊û◊ô◊ù ◊í◊ë◊ï◊î ◊ú◊î◊ë◊ò◊ó◊™ ◊¢◊û◊ô◊ì◊ï◊™.'}},
                        {q:{ar:'ŸÖÿßÿ∞ÿß ŸÑŸà ŸÑŸÖ Ÿäÿπÿ¨ÿ®ŸÜŸä ÿßŸÑÿπÿ∑ÿ±ÿü', he:'◊û◊î ◊ê◊ù ◊ú◊ê ◊ê◊î◊ë◊™◊ô?'}, a:{ar:'ŸäŸÖŸÉŸÜŸÉ ÿßŸÑÿ™ŸàÿßÿµŸÑ ŸÖÿπŸÜÿß ŸÑÿ≥Ÿäÿßÿ≥ÿ© ÿßŸÑÿßÿ≥ÿ™ÿ®ÿØÿßŸÑ.', he:'◊†◊ô◊™◊ü ◊ú◊ô◊¶◊ï◊® ◊ß◊©◊® ◊ú◊û◊ì◊ô◊†◊ô◊ï◊™ ◊î◊ó◊ú◊§◊î.'}},
                        {q:{ar:'ŸáŸÑ ŸÑÿØŸäŸÉŸÖ ŸÅÿ±Ÿàÿπÿü', he:'◊ô◊© ◊ú◊õ◊ù ◊°◊†◊ô◊§◊ô◊ù?'}, a:{ar:'ŸÜÿπŸÖÿå ŸÑÿØŸäŸÜÿß ÿπÿØÿ© ŸÅÿ±Ÿàÿπ.', he:'◊õ◊ü, ◊ô◊© ◊ú◊†◊ï ◊û◊°◊§◊® ◊°◊†◊ô◊§◊ô◊ù.'}}
                    ]; 
                }
                if(type==='comparison') { 
                    block.items = [
                        {mad:{ar:'ŸÖŸÜÿ™ÿ¨ÿßÿ™ ÿ£ÿµŸÑŸäÿ© ŸàŸáŸàŸäÿ© Ÿàÿßÿ∂ÿ≠ÿ©', he:'◊û◊ï◊¶◊®◊ô◊ù ◊û◊ß◊ï◊®◊ô◊ô◊ù ◊ï◊ñ◊î◊ï◊™ ◊ë◊®◊ï◊®◊î'}, other:{ar:'ŸÖŸÜÿ™ÿ¨ÿßÿ™ ŸÖÿ¨ŸáŸàŸÑÿ© ÿßŸÑŸÖÿµÿØÿ±', he:'◊û◊ï◊¶◊®◊ô◊ù ◊û◊û◊ß◊ï◊® ◊ú◊ê ◊ô◊ì◊ï◊¢'}},
                        {mad:{ar:'ÿ´ÿ®ÿßÿ™ ÿπÿßŸÑŸä ŸäÿØŸàŸÖ ÿ∑ŸàŸäŸÑÿßŸã', he:'◊¢◊û◊ô◊ì◊ï◊™ ◊í◊ë◊ï◊î◊î ◊ú◊ê◊ï◊®◊ö ◊ñ◊û◊ü'}, other:{ar:'ÿ±ÿßÿ¶ÿ≠ÿ© ÿ™ÿÆÿ™ŸÅŸä ÿ®ÿ≥ÿ±ÿπÿ©', he:'◊®◊ô◊ó ◊©◊†◊¢◊ú◊ù ◊û◊î◊®'}},
                        {mad:{ar:'ŸÖŸÉŸàŸÜÿßÿ™ ÿ¢ŸÖŸÜÿ© ŸàŸÖÿπÿ™ŸÖÿØÿ© (IFRA)', he:'◊®◊õ◊ô◊ë◊ô◊ù ◊ë◊ò◊ï◊ó◊ô◊ù ◊ï◊û◊ê◊ï◊©◊®◊ô◊ù (IFRA)'}, other:{ar:'ŸÖŸÉŸàŸÜÿßÿ™ ÿ±ÿÆŸäÿµÿ© ŸÇÿØ ÿ™ÿ≥ÿ®ÿ® ÿ≠ÿ≥ÿßÿ≥Ÿäÿ©', he:'◊®◊õ◊ô◊ë◊ô◊ù ◊ñ◊ï◊ú◊ô◊ù ◊©◊¢◊ú◊ï◊ú◊ô◊ù ◊ú◊í◊®◊ï◊ù ◊ú◊ê◊ú◊®◊í◊ô◊î'}},
                        {mad:{ar:'ÿ™ÿ∫ŸÑŸäŸÅ ŸÅÿßÿÆÿ± ŸäŸÑŸäŸÇ ÿ®ŸÉ', he:'◊ê◊®◊ô◊ñ◊î ◊ô◊ï◊ß◊®◊™◊ô◊™ ◊©◊û◊™◊ê◊ô◊û◊î ◊ú◊ö'}, other:{ar:'ÿ™ÿ∫ŸÑŸäŸÅ ÿπÿ¥Ÿàÿßÿ¶Ÿä Ÿàÿ®ÿ≥Ÿäÿ∑', he:'◊ê◊®◊ô◊ñ◊î ◊§◊©◊ï◊ò◊î ◊ï◊ê◊ß◊®◊ê◊ô◊™'}},
                        {mad:{ar:'ÿ∂ŸÖÿßŸÜ ÿßÿ≥ÿ™ÿ±ÿ¨ÿßÿπ ÿ≠ŸÇŸäŸÇŸä', he:'◊ê◊ó◊®◊ô◊ï◊™ ◊î◊ó◊ñ◊® ◊õ◊°◊§◊ô ◊ê◊û◊ô◊™◊ô◊™'}, other:{ar:'ŸÑÿß ŸäŸàÿ¨ÿØ ÿ∂ŸÖÿßŸÜ', he:'◊ê◊ô◊ü ◊ê◊ó◊®◊ô◊ï◊™'}},
                        {mad:{ar:'ÿÆÿØŸÖÿ© ÿπŸÖŸÑÿßÿ° ŸàŸÅÿ±Ÿàÿπ ŸÖÿπÿ™ŸÖÿØÿ©', he:'◊©◊ô◊®◊ï◊™ ◊ú◊ß◊ï◊ó◊ï◊™ ◊ï◊°◊†◊ô◊§◊ô◊ù ◊û◊ï◊®◊©◊ô◊ù'}, other:{ar:'ŸÖÿ™ÿßÿ¨ÿ± ŸàŸáŸÖŸäÿ© ÿ®ŸÑÿß ÿØÿπŸÖ', he:'◊ó◊†◊ï◊ô◊ï◊™ ◊§◊ô◊ß◊ò◊ô◊ë◊ô◊ï◊™ ◊ú◊ú◊ê ◊™◊û◊ô◊õ◊î'}}
                    ]; 
                }
                if(type === 'fragrantica') { block.stars=5; block.score='4.9/5'; block.content={ar:'ÿ™ŸÇŸäŸäŸÖÿßÿ™ ŸÖŸÖÿ™ÿßÿ≤ÿ©', he:'◊ë◊ô◊ß◊ï◊®◊ï◊™ ◊û◊¶◊ï◊ô◊†◊ï◊™'}; }
                
                this.blocks.push(block); this.update();
            },
            removeBlock(i) { this.blocks.splice(i,1); this.update(); },
            moveBlock(i,d) {
                const ni = i+d;
                if(ni>=0 && ni<this.blocks.length) {
                    [this.blocks[i], this.blocks[ni]] = [this.blocks[ni], this.blocks[i]];
                    this.update();
                }
            },
            async copyCode() {
                try { await navigator.clipboard.writeText(this.generateFinalHTML(true)); alert('‚úÖ Copied!'); } catch(e){ alert('Error copying'); }
            },
            downloadHTML() {
                const link = document.createElement('a');
                link.href = URL.createObjectURL(new Blob([this.generateFinalHTML(true)], {type:'text/html'}));
                link.download = 'MAD-Page-V53.html';
                link.click();
            },
            generateFinalHTML(isDownload) {
                const bJ = JSON.stringify(this.blocks).replace(/</g, '\\u003c');
                const cJ = JSON.stringify(this.config).replace(/</g, '\\u003c');
                const PROD_NAME = (this.config.productName || '').replace(/'/g, "\\'");
                const PRICE_VAL = this.config.price || '0';
                const iL = isDownload ? null : `'${this.editLang}'`;
                
                // ‚úÖ UPDATED Pixel Logic with E.164 Strict Guard
                const PIXEL_CODE = `
                window._mad_px_fired = false;
                
                function formatPhoneDigits(p) {
                   if (!p) return '';
                   let n = String(p).replace(/[^0-9]/g, '');
                   // IL: 05XXXXXXXX -> 9725XXXXXXXX
                   if (n.startsWith('05') && n.length === 10) n = '972' + n.substring(1);
                   // PS: 059XXXXXXX -> 97059XXXXXXX
                   if (n.startsWith('059') && n.length === 10) n = '970' + n.substring(1);
                   // 00XXXXXXXX -> XXXXXX
                   if (n.startsWith('00')) n = n.substring(2);
                   return n;
                }

                function loadPixels() {
                    if (window._mad_px_fired) return;
                    window._mad_px_fired = true;

                    // FB
                    !function(f,b,e,v,n,t,s){if(f.fbq)return;n=f.fbq=function(){n.callMethod?n.callMethod.apply(n,arguments):n.queue.push(arguments)};if(!f._fbq)n=f.fbq;n.push=n;n.loaded=!0;n.version='2.0';n.queue=[];t=b.createElement(e);t.async=!0;t.src=v;s=b.getElementsByTagName(e)[0];s.parentNode.insertBefore(t,s)}(window,document,'script','https://connect.facebook.net/en_US/fbevents.js');
                    if('${this.config.fbPixel}') { fbq('init', '${this.config.fbPixel}'); fbq('track', 'PageView'); }
                    
                    // TT
                    !function (w, d, t) { w.TiktokAnalyticsObject=t; var ttq=w[t]=w[t]||[]; ttq.methods=["page","track","identify","instances","debug","on","off","once","ready","alias","group","enableCookie","disableCookie","holdConsent","revokeConsent","grantConsent"]; ttq.setAndDefer=function(t,e){t[e]=function(){t.push([e].concat(Array.prototype.slice.call(arguments,0)))}}; for(var i=0;i<ttq.methods.length;i++)ttq.setAndDefer(ttq,ttq.methods[i]); ttq.load=function(e,n){ var r="https://analytics.tiktok.com/i18n/pixel/events.js"; var o=n&&n.partner; ttq._i=ttq._i||{}; ttq._i[e]=[]; ttq._i[e]._u=r; ttq._t=ttq._t||{}; ttq._t[e]=+new Date; ttq._o=ttq._o||{}; ttq._o[e]=n||{}; n=document.createElement("script"); n.type="text/javascript"; n.async=!0; n.src=r+"?sdkid="+e+"&lib="+t; e=document.getElementsByTagName("script")[0]; e.parentNode.insertBefore(n,e) }; ttq.load('${this.config.ttPixel}'); ttq.page(); }(window, document, 'ttq');
                    
                    // Snap
                    (function(e,t,n){if(e.snaptr)return;var a=e.snaptr=function(){a.handleRequest?a.handleRequest.apply(a,arguments):a.queue.push(arguments)};a.queue=[];var s='script';var r=t.createElement(s);r.async=!0;r.src=n;var u=t.getElementsByTagName(s)[0];u.parentNode.insertBefore(r,u)})(window,document,'https://sc-static.net/scevent.min.js');
                    if('${this.config.snapPixel}') { snaptr('init', '${this.config.snapPixel}'); snaptr('track', 'PAGE_VIEW'); }
                }`;

                return `<!DOCTYPE html>
<html x-data="app()" x-init="init(${iL})" :lang="lang" :dir="lang==='he'?'ltr':'rtl'">
<head>
<meta charset="UTF-8"><meta name="viewport" content="width=device-width, initial-scale=1.0">
<script src="https://cdn.tailwindcss.com"><\/script>
<script src="https://unpkg.com/lucide@latest" defer><\/script>
<script src="https://unpkg.com/alpinejs@3.x.x/dist/cdn.min.js" defer><\/script>
<link href="https://fonts.googleapis.com/css2?family=Amiri:wght@400;700&family=Aref+Ruqaa:wght@400;700&family=Cairo:wght@200..1000&family=Rakkas&family=Tajawal:wght@200..900&display=swap" rel="stylesheet">
<script>${PIXEL_CODE}<\/script>
<style>
body { background: ${this.config.bgColor}; font-family: 'Cairo', sans-serif; overflow-x: hidden; min-height: 100vh; }
.inp { width: 100%; padding: 15px; background: #f8fafc; border: 1px solid #ddd; border-radius: 12px; margin-bottom: 10px; font-weight: bold; }
.btn-main { background: #000; color: #fff; width: 100%; padding: 18px; border-radius: 14px; font-weight: 900; font-size: 1.2rem; box-shadow: 0 4px 14px rgba(0,0,0,0.2); position: relative; overflow: hidden; animation: pulse 2s infinite; }
@keyframes pulse { 0% { transform: scale(1); } 50% { transform: scale(1.02); } 100% { transform: scale(1); } }
.mad-radio-box { border: 2px solid #e5e7eb; border-radius: 12px; padding: 12px; text-align: center; cursor: pointer; background: white; transition: 0.2s; }
input:checked + .mad-radio-box { border-color: #10b981; background: #f0fdf4; color: #047857; transform: scale(1.02); }
.sales-pop { animation: slideIn 0.5s ease-out forwards; }
@keyframes slideIn { from { transform: translateY(100px); opacity: 0; } to { transform: translateY(0); opacity: 1; } }
.rec { border-color: #10b981; position: relative; }
.rec::after { content:'‚òÖ'; position:absolute; top:-8px; right:-8px; background:#10b981; color:white; border-radius:50%; width:20px; height:20px; font-size:10px; display:flex; align-items:center; justify-content:center; }
.progress-container { margin-bottom: 15px; }
.progress-text { display: flex; justify-content: space-between; font-size: 0.75rem; font-weight: bold; margin-bottom: 5px; opacity: 0.7; color:white; }
.progress-track { height: 6px; background: rgba(255,255,255,0.3); border-radius: 99px; overflow: hidden; }
.progress-fill { height: 100%; background: #10b981; width: 85%; }
.no-scrollbar::-webkit-scrollbar { display: none; }
.no-scrollbar { -ms-overflow-style: none; scrollbar-width: none; }
</style>
</head>
<body class="pb-20">
    <nav class="p-4 flex justify-center bg-white/40 backdrop-blur sticky top-0 z-50"><img src="${this.config.logoUrl}" class="h-10 object-contain"></nav>
    <header class="text-center py-8 px-4"><h1 class="text-3xl font-black text-white" x-text="c.heroTitle[lang]"></h1></header>
    <main class="max-w-md mx-auto px-4">
        <template x-for="b in blocks">
            <div class="my-4" :class="'text-'+b.align">
                
                <template x-if="b.type==='text'">
                    <p class="whitespace-pre-wrap leading-relaxed" :class="[b.style?.size||'text-base']" :style="{color:b.style?.color||'#000', fontFamily:b.style?.font}" x-text="b.content[lang]"></p>
                </template>
                
                <template x-if="['image','video'].includes(b.type)">
                    <component :is="b.type==='image'?'img':'video'" :src="b.url" :controls="b.type==='video'" class="rounded-xl w-full shadow-sm"></component>
                </template>
                
                <template x-if="b.type==='embed'"><div x-html="b.content[lang]"></div></template>
                
                <template x-if="b.type==='gallery'">
                     <div class="relative w-full rounded-xl overflow-hidden shadow-lg" 
                          :class="(b.aspect === 'portrait' ? 'aspect-[3/4]' : (b.aspect === 'square' ? 'aspect-square' : 'aspect-video'))"
                          x-data="{ curr: 0, total: b.images.length }" 
                          x-init="setInterval(() => { curr = (curr + 1) % total }, 3000)">
                         <template x-for="(img, i) in b.images">
                            <img :src="img" x-show="curr === i"
                                 x-transition:enter="transition ease-out duration-500"
                                 x-transition:enter-start="opacity-0"
                                 x-transition:enter-end="opacity-100"
                                 x-transition:leave="transition ease-in duration-300"
                                 x-transition:leave-start="opacity-100"
                                 x-transition:leave-end="opacity-0"
                                 class="absolute inset-0 w-full h-full"
                                 :class="(b.fit === 'contain' ? 'object-contain' : 'object-cover')">
                         </template>
                         <div class="absolute bottom-2 flex gap-1 justify-center w-full z-10">
                            <template x-for="(img, i) in b.images">
                                <div class="w-2 h-2 rounded-full transition-all" 
                                     :class="curr===i ? 'bg-white w-4' : 'bg-white/50'"></div>
                            </template>
                         </div>
                    </div>
                </template>

                <template x-if="b.type==='offers_slider'">
                    <div class="mt-4">
                        <h3 class="text-lg font-bold mb-2 px-2 text-white" x-text="b.title[lang]"></h3>
                        <div class="flex overflow-x-auto gap-3 pb-4 px-2 no-scrollbar">
                            <template x-for="item in b.items">
                                <a :href="item.link" class="min-w-[180px] w-[180px] bg-white rounded-xl shadow-lg border border-gray-100 overflow-hidden flex flex-col no-underline transition transform active:scale-95">
                                    <div class="w-full bg-white flex items-center justify-center overflow-hidden relative"
                                         :class="(b.aspect === 'portrait' ? 'h-64' : (b.aspect === 'landscape' ? 'h-32' : 'h-40'))">
                                        <img :src="item.img" 
                                             class="w-full h-full"
                                             :class="(b.fit === 'contain' ? 'object-contain p-2' : 'object-cover')">
                                    </div>
                                    <div class="p-2 pt-1 text-center h-auto">
                                        <h4 class="text-xs font-bold text-gray-800 line-clamp-1 mb-1" x-text="item.title[lang]"></h4>
                                        <p class="text-sm font-black text-red-600 mb-2" x-text="item.price + (lang==='he'?' ‚Ç™':' ÿ¥ŸäŸÉŸÑ')"></p>
                                        <div class="w-full bg-black text-white text-[10px] font-bold py-1.5 rounded-lg" x-text="lang==='he'?'◊î◊ï◊°◊£ ◊ú◊°◊ú':'ÿ£ÿ∂ŸÅ ŸÑŸÑÿ≥ŸÑÿ©'"></div>
                                    </div>
                                </a>
                            </template>
                        </div>
                    </div>
                </template>

                <!-- FAQ Block -->
                <template x-if="b.type==='faq'">
                     <div class="bg-white rounded-2xl p-4 shadow-sm text-right space-y-2">
                        <h3 class="font-black mb-2 text-black" x-text="lang==='he'?'◊©◊ê◊ú◊ï◊™ ◊†◊§◊ï◊¶◊ï◊™':'ÿßŸÑÿ£ÿ≥ÿ¶ŸÑÿ© ÿßŸÑŸÖÿ™ŸÉÿ±ÿ±ÿ©'"></h3>
                        <template x-for="(qa, i) in b.items">
                            <div class="border-b pb-2 last:border-0" x-data="{open:false}">
                                <button @click="open=!open" class="w-full flex justify-between font-bold text-sm text-black">
                                    <span x-text="qa.q[lang]"></span>
                                    <span x-text="open?'-':'+'"></span>
                                </button>
                                <p x-show="open" class="text-xs text-gray-600 mt-1" x-text="qa.a[lang]"></p>
                            </div>
                        </template>
                     </div>
                </template>

                <template x-if="b.type==='urgency_box'">
                   <div x-data="{ v: parseInt(b.visitors||600), s: parseInt(b.left||8) }" x-init="setInterval(()=>{v+=Math.floor(Math.random()*5)-2}, 3000); setInterval(()=>{if(s>2)s--}, 9000)" class="bg-red-50 border border-red-100 rounded-xl p-4 shadow-sm mb-4">
                        <div class="flex justify-between items-center mb-2"><span class="text-[10px] bg-red-600 text-white px-2 py-1 rounded animate-pulse">üî• HOT</span><div class="font-mono font-bold text-red-600" x-text="timer"></div></div>
                        <div class="flex items-center gap-2 text-xs text-gray-600 mb-2"><span>üëÅÔ∏è</span><span x-text="v"></span> <span x-text="lang==='he'?'◊¶◊ï◊§◊ô◊ù':'ÿ≤Ÿàÿßÿ±'"></span></div>
                        <div class="text-xs text-gray-600">‚ö° <span x-text="lang==='he'?'◊†◊ï◊™◊®◊ï':'ÿ®ŸÇŸä'"></span> <span class="font-bold text-red-600" x-text="s"></span></div>
                        <div class="w-full bg-gray-200 rounded-full h-1.5 mt-2"><div class="bg-red-500 h-full rounded-full transition-all duration-1000" :style="'width: '+(s*10)+'%'"></div></div>
                   </div>
                </template>

                <template x-if="b.type==='interactive_rating'">
                    <div class="bg-white border-2 border-yellow-100 rounded-xl p-6 text-center" x-data="{r:0}">
                        <h3 class="font-bold mb-2 text-black" x-text="b.content[lang]"></h3>
                        <div class="flex justify-center gap-2 text-3xl text-gray-200">
                            <template x-for="i in 5"><button @click="r=i" :class="i<=r?'text-yellow-400':''">‚òÖ</button></template>
                        </div>
                        <p x-show="r>0" class="text-green-600 text-xs font-bold mt-2 animate-bounce" x-text="lang==='he'?'◊™◊ï◊ì◊î! (5/5)':'ÿ¥ŸÉÿ±ÿßŸã ŸÑŸÉ! (5/5)'"></p>
                    </div>
                </template>

                <template x-if="b.type==='comparison'">
                    <div class="space-y-2 mt-4 text-right">
                        <template x-for="row in b.items">
                            <div class="grid grid-cols-2 gap-1 rounded-xl overflow-hidden border border-black/5 shadow-sm">
                                <div class="bg-gray-50 p-4 border-r border-black/5"><span class="text-[8px] font-black text-amber-600 block mb-1">MAD</span><p class="text-[11px] font-bold leading-tight text-black" x-text="row.mad[lang]"></p></div>
                                <div class="bg-white p-4 text-gray-400 text-right"><span class="text-[8px] font-black text-gray-300 block mb-1">OTHERS</span><p class="text-[11px]" x-text="row.other[lang]"></p></div>
                            </div>
                        </template>
                    </div>
                </template>

                <template x-if="b.type==='fragrantica'">
                    <a :href="b.url" target="_blank" class="block w-full max-w-[320px] bg-[#3f5a31] text-white p-5 rounded-[24px] shadow-xl relative overflow-hidden mx-auto no-underline text-right">
                        <div class="flex justify-between items-center mb-3">
                            <span class="text-[10px] font-black uppercase tracking-widest text-white/60">Reviews</span>
                            <div class="flex text-amber-400 gap-0.5">
                                <template x-for="i in parseInt(b.stars || 5)">
                                    <svg xmlns="http://www.w3.org/2000/svg" width="14" height="14" viewBox="0 0 24 24" fill="currentColor" stroke="none" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><polygon points="12 2 15.09 8.26 22 9.27 17 14.14 18.18 21.02 12 17.77 5.82 21.02 7 14.14 2 9.27 8.91 8.26 12 2"/></svg>
                                </template>
                            </div>
                        </div>
                        <div class="flex items-end gap-2"><span class="text-4xl font-black" x-text="b.score || '4.9 / 5'"></span><span class="text-xs opacity-60 mb-1">Rating</span></div>
                        <p class="text-[10px] font-bold mt-2 text-white/80" x-text="b.content[lang]"></p>
                    </a>
                </template>

                <template x-if="b.type==='form'">
                    <div class="bg-white p-6 rounded-[24px] shadow-sm text-right border-2 border-gray-100" id="order">
                        <div class="progress-container"><div class="progress-text"><span x-text="lang==='he'?'◊§◊®◊ò◊ô ◊û◊©◊ú◊ï◊ó':'ŸÖÿπŸÑŸàŸÖÿßÿ™ ÿßŸÑÿ¥ÿ≠ŸÜ'"></span><span x-text="lang==='he'?'◊©◊ú◊ë ◊ê◊ó◊®◊ï◊ü':'ÿßŸÑÿÆÿ∑Ÿàÿ© ÿßŸÑÿ£ÿÆŸäÿ±ÿ©'"></span></div><div class="progress-track"><div class="progress-fill"></div></div></div>
                        <h2 class="text-xl font-black text-center mb-4 text-black" x-text="b.content[lang] || (lang==='he'?'◊î◊ñ◊û◊†◊î':'ÿßÿ∑ŸÑÿ® ÿßŸÑÿ¢ŸÜ')"></h2>
                        <form @submit.prevent="submitForm">
                            <input type="text" x-model="f.name" @input="trackCart" class="inp" :placeholder="lang==='he'?'◊©◊ù':'ÿßŸÑÿßÿ≥ŸÖ'" required>
                            <input type="tel" x-model="f.phone" dir="ltr" class="inp text-right" :placeholder="lang==='he'?'◊ò◊ú◊§◊ï◊ü':'ÿßŸÑŸáÿßÿ™ŸÅ'" required>
                            <input type="text" x-model="f.address" class="inp" :placeholder="lang==='he'?'◊õ◊™◊ï◊ë◊™':'ÿßŸÑÿπŸÜŸàÿßŸÜ'" required>
                            <div class="grid grid-cols-2 gap-3 mb-4">
                                <label class="cursor-pointer"><input type="radio" x-model="f.payment" value="Cash" class="hidden"><div class="mad-radio-box rec"><span x-text="lang==='he'?'◊û◊ñ◊ï◊û◊ü üíµ':'ŸÜŸÇÿØ üíµ'"></span></div></label>
                                <label class="cursor-pointer"><input type="radio" x-model="f.payment" value="Visa" class="hidden"><div class="mad-radio-box"><span x-text="lang==='he'?'◊ê◊©◊®◊ê◊ô üí≥':'ŸÅŸäÿ≤ÿß üí≥'"></span></div></label>
                            </div>
                            <div class="grid grid-cols-2 gap-3 mb-6">
                                <label class="cursor-pointer"><input type="radio" x-model="f.process" value="Direct" class="hidden"><div class="mad-radio-box rec"><span x-text="lang==='he'?'◊©◊ú◊ó ◊î◊ñ◊û◊†◊î':'ÿßÿ±ÿ≥ŸÑ ÿßŸÑÿ∑ŸÑÿ®'"></span><div class="text-[9px] text-blue-600">üöÄ</div></div></label>
                                <label class="cursor-pointer"><input type="radio" x-model="f.process" value="Contact" class="hidden"><div class="mad-radio-box"><span x-text="lang==='he'?'◊¶◊ï◊® ◊ß◊©◊®':'ÿ™ŸàÿßÿµŸÑ ŸÖÿπŸä'"></span></div></label>
                            </div>
                            <button type="submit" class="btn-main" :disabled="loading" x-text="loading?'...':(b.btnText?.[lang] || 'Order Now')"></button>
                        </form>
                    </div>
                </template>
            </div>
        </template>
    </main>

    <div x-show="pop.show" class="fixed bottom-4 left-4 right-4 bg-white p-3 rounded-xl shadow-2xl z-40 sales-pop flex items-center gap-3" style="display:none">
        <div class="bg-green-100 p-2 rounded-full">üõçÔ∏è</div><div><p class="text-xs font-bold" x-text="pop.msg"></p><p class="text-[10px] text-gray-500">Just now</p></div>
    </div>

    <!-- ‚úÖ NEW: Sending Popup (Do not close screen) -->
    <div x-show="sending" class="fixed inset-0 bg-black/80 flex items-center justify-center z-50" style="display:none">
        <div class="bg-white text-black rounded-3xl p-7 max-w-[340px] w-[90%] text-center shadow-2xl">
            <div class="text-5xl mb-3">üì≤</div>
            <h3 class="text-xl font-black mb-2" x-text="lang==='he'?'◊î◊î◊ñ◊û◊†◊î ◊†◊©◊ú◊ó◊™...':'Ÿäÿ™ŸÖ ÿ•ÿ±ÿ≥ÿßŸÑ ÿßŸÑÿ∑ŸÑÿ®...'"></h3>
            <p class="text-sm font-bold text-gray-700 leading-relaxed"
               x-text="lang==='he'?'◊ê◊ú ◊™◊°◊í◊ï◊® ◊ê◊™ ◊î◊û◊°◊ö ‚Äî ◊™◊ß◊ë◊ú ◊î◊ï◊ì◊¢◊™ WhatsApp ◊ë◊ß◊®◊ï◊ë.':'ŸÑÿß ÿ™ÿ∫ŸÑŸÇ ÿßŸÑÿ¥ÿßÿ¥ÿ© ‚Äî ÿ≥ÿ™ÿµŸÑŸÉ ÿ±ÿ≥ÿßŸÑÿ© Ÿàÿßÿ™ÿ≥ÿßÿ® ÿÆŸÑÿßŸÑ ŸÑÿ≠ÿ∏ÿßÿ™.'"></p>
            <div class="mt-4 text-[11px] text-gray-500" x-text="lang==='he'?'◊ê◊†◊ê ◊î◊û◊™◊ü...':'Ÿäÿ±ÿ¨Ÿâ ÿßŸÑÿßŸÜÿ™ÿ∏ÿßÿ±...'"></div>
        </div>
    </div>

    <div x-show="submitted" class="fixed inset-0 bg-black/90 flex items-center justify-center text-white z-50" style="display:none">
        <div class="text-center p-8 bg-white text-black rounded-3xl">
            <div class="text-6xl mb-4">‚úÖ</div>
            <h3 class="text-2xl font-black">Success!</h3>
            <button @click="submitted=false" class="mt-6 w-full bg-black text-white py-3 rounded-xl">Close</button>
        </div>
    </div>

    <script>
        function app() {
            return {
                lang:'ar',
                loading:false,
                sending:false,  // ‚úÖ NEW
                submitted:false,
                pop:{show:false,msg:''},
                hasStartedTyping:false,
                blocks:${bJ},
                c:${cJ},
                f:{name:'',phone:'',address:'',payment:'Cash',process:'Direct'},
                time: ${JSON.parse(bJ).find(b => b.type === 'urgency_box')?.timerMinutes * 60 || 900},
                get timer() { const m=Math.floor(this.time/60); const s=this.time%60; return \`\${m}:\${s<10?'0':''}\${s}\`; },

                // ‚úÖ NEW: one phone normalizer used everywhere
                phoneDigits(p){
                    let n = String(p||'').replace(/[^0-9]/g,'');
                    if (n.startsWith('05') && n.length === 10) n = '972' + n.substring(1);
                    if (n.startsWith('059') && n.length === 10) n = '970' + n.substring(1);
                    if (n.startsWith('00')) n = n.substring(2);
                    return n;
                },

                init(l) { 
                    this.lang = l || (navigator.language.startsWith('he')?'he':'ar'); 
                    setInterval(() => { if(this.time > 0) this.time--; }, 1000);
                    if(this.blocks.some(b => b.type === 'sales_pop')) {
                        setInterval(() => {
                            const names = ['Ahmed','Sara','Mohamed','Noor']; const cities = ['Jerusalem','Haifa','Nazareth'];
                            this.pop.msg = \`\${names[Math.floor(Math.random()*names.length)]} from \${cities[Math.floor(Math.random()*cities.length)]} purchased\`;
                            this.pop.show = true; setTimeout(() => this.pop.show = false, 4000);
                        }, 15000);
                    }
                    setTimeout(() => { // Lazy Load Pixels
                         if(window.mad_pixels_loaded) return;
                         window.mad_pixels_loaded = true;
                         loadPixels();
                         document.addEventListener('touchstart', loadPixels, {once:true});
                    }, 3500);
                },

                trackCart() {
                    if(!this.hasStartedTyping) {
                        this.hasStartedTyping = true;

                        const digits = this.phoneDigits(this.f.phone);
                        const ttPhone = digits ? ('+' + digits) : '';

                        // Facebook
                        if(window.fbq) {
                             fbq('init', '${this.config.fbPixel}', { ph: digits, fn: this.f.name });
                             fbq('track', 'AddToCart', {
                                content_name: '${PROD_NAME}', 
                                content_ids: ['${PROD_NAME}'],
                                content_type: 'product',
                                value: ${PRICE_VAL}, 
                                currency: 'ILS'
                            });
                        }

                        // TikTok (‚úÖ phone fixed + E.164 + removed name)
                        if(window.ttq) {
                             ttq.identify({ phone_number: ttPhone });
                             ttq.track('AddToCart', {
                                content_name: '${PROD_NAME}', 
                                content_id: '${PROD_NAME}', 
                                content_type: 'product',
                                value: ${PRICE_VAL}, 
                                currency: 'ILS'
                            });
                        }

                        // Snapchat
                        if(window.snaptr) {
                             snaptr('init', '${this.config.snapPixel}', { user_phone_number: digits });
                             snaptr('track', 'ADD_CART', {
                                price: ${PRICE_VAL}, 
                                currency: 'ILS', 
                                item_ids: ['${PROD_NAME}'],
                                item_category: '${PROD_NAME}'
                            });
                        }
                    }
                },

                async submitForm() {
                    this.loading = true;
                    this.sending = true; // ‚úÖ NEW popup on

                    const digits = this.phoneDigits(this.f.phone);
                    const ttPhone = digits ? ('+' + digits) : '';

                    // Facebook Purchase
                    if(window.fbq) {
                        fbq('init', '${this.config.fbPixel}', { ph: digits, fn: this.f.name });
                        fbq('track', 'Purchase', {
                            value: ${PRICE_VAL}, 
                            currency: 'ILS',
                            content_ids: ['${PROD_NAME}'],
                            content_type: 'product'
                        });
                    }

                    // TikTok (‚úÖ phone fixed + E.164 + removed name)
                    if(window.ttq) {
                        ttq.identify({ phone_number: ttPhone });
                        ttq.track('CompletePayment', {
                            value: ${PRICE_VAL}, 
                            currency: 'ILS', 
                            content_id: '${PROD_NAME}',
                            content_type: 'product'
                        });
                    }

                    // Snapchat Purchase
                    if(window.snaptr) {
                        snaptr('init', '${this.config.snapPixel}', { user_phone_number: digits });
                        snaptr('track', 'PURCHASE', {
                            currency: 'ILS', 
                            price: ${PRICE_VAL},
                            item_ids: ['${PROD_NAME}'],
                            transaction_id: Date.now()
                        });
                    }

                    await new Promise(r => setTimeout(r, 800)); 
                    const fd = new FormData();
                    Object.keys(this.f).forEach(k => fd.append(k, this.f[k]));
                    fd.append('lang', this.lang);
                    fd.append('offer', '${PROD_NAME}');
                    fd.append('price', '${PRICE_VAL}');
                    fd.append('admin_phone', '${this.config.adminPhone}');

                    try { 
                        await fetch(this.c.sheetUrl, {method:'POST', body:fd, mode:'no-cors'}); 
                        this.sending = false; // ‚úÖ NEW popup off
                        this.submitted = true; 
                    } 
                    catch(e) {
                        this.sending = false; // ‚úÖ NEW popup off
                        alert('Error');
                    } finally {
                        this.loading = false;
                    }
                }
            }
        }
    <\/script>
</body>
</html>`;
            }
        }
    }
</script>
</body>
</html>
