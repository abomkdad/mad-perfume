<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>MAD Builder V33 - Fixed Complete âœ…</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/lucide@latest" defer></script>
    <script src="https://unpkg.com/alpinejs@3.x.x/dist/cdn.min.js" defer></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Amiri:wght@400;700&family=Aref+Ruqaa:wght@400;700&family=Cairo:wght@200..1000&family=Rakkas&family=Tajawal:wght@200..900&display=swap');
        [x-cloak] { display: none !important; }
        body { font-family: 'Cairo', sans-serif; background: #f3f4f6; color: #111; height: 100vh; overflow: hidden; }
        .app-layout { display: flex; height: 100vh; flex-direction: row-reverse; }
        .editor-sidebar { width: 450px; background: #fff; border-left: 1px solid #e5e7eb; overflow-y: auto; padding: 20px; z-index: 10; flex-shrink: 0; }
        .preview-area { flex: 1; background: #cbd5e1; display: flex; flex-direction: column; align-items: center; overflow-y: auto; padding: 40px 0; position: relative; }
        .iphone-wrapper { transition: transform 0.2s ease; transform-origin: top center; margin-bottom: 50px; }
        .iphone { width: 375px; height: 800px; background: #000; border-radius: 40px; border: 12px solid #1a1a1a; overflow: hidden; position: relative; box-shadow: 0 30px 60px rgba(0,0,0,0.4); background-color: #fff; }
        .iphone iframe { width: 100%; height: 100%; border: none; background: #fff; }
        .section-box { background: #f9fafb; border: 1px solid #e5e7eb; border-radius: 12px; padding: 15px; margin-bottom: 15px; }
        label { font-size: 11px; font-weight: 700; display: block; margin-bottom: 4px; color: #4b5563; }
        input, textarea, select { width: 100%; padding: 8px; border: 1px solid #d1d5db; border-radius: 6px; font-size: 12px; margin-bottom: 8px; outline: none; }
        .btn-add { background: #fff; border: 1px solid #ddd; padding: 8px; border-radius: 6px; font-size: 11px; font-weight: bold; cursor: pointer; transition: 0.2s; display: flex; align-items: center; justify-content: center; gap: 4px; }
        .btn-add:hover { background: #f3f4f6; border-color: #000; }
        .btn-download { background: #000; color: #fff; width: 100%; padding: 15px; border-radius: 10px; font-weight: 800; margin-top: 10px; cursor: pointer; display: flex; justify-content: center; align-items: center; gap: 8px; }
        .btn-copy { background: #4b5563; color: #fff; width: 100%; padding: 15px; border-radius: 10px; font-weight: 800; margin-top: 10px; cursor: pointer; display: flex; justify-content: center; align-items: center; gap: 8px; transition: 0.2s; }
        .btn-copy:hover { background: #374151; }
        .sub-item { border-top: 1px dashed #eee; padding-top: 8px; margin-top: 8px; }
        .zoom-controls { position: fixed; bottom: 20px; left: 50%; transform: translateX(-50%); background: rgba(0,0,0,0.8); padding: 8px 16px; border-radius: 99px; display: flex; gap: 10px; color: white; z-index: 50; align-items: center; }
        .zoom-btn { cursor: pointer; padding: 4px; } .zoom-btn:hover { color: #ddd; }
        .color-dot { width: 20px; height: 20px; border-radius: 50%; cursor: pointer; border: 1px solid #ddd; }
        .color-dot:hover { transform: scale(1.1); }
    </style>
</head>
<body>

<div class="app-layout" x-data="builderApp()" x-init="init()" x-cloak>
    <aside class="editor-sidebar">
        <h1 class="text-xl font-black mb-6 text-center">MAD BUILDER <span class="text-blue-600">V33 FIXED</span> ğŸ›’</h1>
        
        <div class="flex bg-gray-100 p-1 rounded-lg mb-4">
            <button @click="setEditLang('ar')" :class="editLang==='ar'?'bg-black text-white':''" class="flex-1 py-2 rounded-md text-xs font-bold transition">Ø¹Ø±Ø¨ÙŠ</button>
            <button @click="setEditLang('he')" :class="editLang==='he'?'bg-black text-white':''" class="flex-1 py-2 rounded-md text-xs font-bold transition">×¢×‘×¨×™×ª</button>
        </div>

        <div class="section-box border-green-200 bg-green-50/50">
            <h2 class="font-bold text-xs mb-2 text-green-700">ğŸ’° Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª Ø§Ù„Ø³Ø¹Ø±</h2>
            <label>Ø§Ø³Ù… Ø§Ù„Ù…Ù†ØªØ¬</label>
            <input type="text" x-model="config.productName" class="font-bold" @input="updatePreviewDebounced()">
            <label>Ø§Ù„Ø³Ø¹Ø± (Ø´ÙŠÙƒÙ„)</label>
            <input type="number" x-model="config.price" class="font-bold text-center" @input="updatePreviewDebounced()">
        </div>

        <div class="section-box border-blue-200 bg-blue-50/50">
            <h2 class="font-bold text-xs mb-2 text-blue-700">âš™ï¸ Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª Ø§Ù„Ø±Ø¨Ø·</h2>
            <label>Ø±Ø§Ø¨Ø· Ø§Ù„Ø³ÙƒØ±Ø¨Øª</label>
            <!-- FIX: ÙƒØ§Ù† Ù„Ø§ ÙŠØ­Ø¯Ø« Ø§Ù„Ù…Ø¹Ø§ÙŠÙ†Ø© Ø¹Ù†Ø¯ ØªØºÙŠÙŠØ± Ø§Ù„Ø±Ø§Ø¨Ø· -->
            <input type="text" x-model="config.sheetUrl" @input="updatePreviewDebounced()" class="text-xs font-mono mb-2 bg-white">
            <label class="text-indigo-700 font-black">ğŸ“ Ø±Ù‚Ù… Ø§Ù„Ù…Ø¯ÙŠØ±</label>
            <!-- FIX: ÙƒØ§Ù† Ù„Ø§ ÙŠØ­Ø¯Ø« Ø§Ù„Ù…Ø¹Ø§ÙŠÙ†Ø© Ø¹Ù†Ø¯ ØªØºÙŠÙŠØ± Ø§Ù„Ø±Ù‚Ù… -->
            <input type="text" x-model="config.adminPhone" @input="updatePreviewDebounced()" class="text-center font-bold border-indigo-300 bg-indigo-50">
             <div class="grid grid-cols-3 gap-1 mt-2">
                <div><label>FB</label><input type="text" x-model="config.fbPixel" @input="updatePreviewDebounced()"></div>
                <div><label>TikTok</label><input type="text" x-model="config.ttPixel" @input="updatePreviewDebounced()"></div>
                <div><label>Snap</label><input type="text" x-model="config.snapPixel" @input="updatePreviewDebounced()"></div>
            </div>
            <p class="text-[9px] text-gray-500 mt-2">âœ¨ Ù…Ù„Ø§Ø­Ø¸Ø©: Ø§Ù„Ø¨ÙŠÙƒØ³Ù„Ø§Øª Ø³ÙŠØªÙ… ØªØ­Ù…ÙŠÙ„Ù‡Ø§ Ø¨Ø¹Ø¯ 3.5 Ø«Ø§Ù†ÙŠØ© Ù„Ù„Ø³Ø±Ø¹Ø©.</p>
        </div>

        <div class="section-box">
            <h2 class="font-bold text-xs mb-2">ğŸ¨ Ø§Ù„Ù…Ø¸Ù‡Ø± Ø§Ù„Ø¹Ø§Ù…</h2>
            <div class="flex gap-2 items-center">
                <input type="color" x-model="config.bgColor" @input="updatePreviewDebounced()" class="h-10 w-10 p-0 border rounded cursor-pointer">
                <input type="text" x-model="config.bgColor" @input="updatePreviewDebounced()" class="text-xs font-mono w-full" placeholder="#ffffff">
            </div>
            <label class="mt-2">Ø±Ø§Ø¨Ø· Ø§Ù„Ø´Ø¹Ø§Ø±</label>
            <input type="text" x-model="config.logoUrl" @input="updatePreviewDebounced()">
            <label>Ø§Ù„Ø¹Ù†ÙˆØ§Ù† Ø§Ù„Ø±Ø¦ÙŠØ³ÙŠ</label>
            <input type="text" x-model="config.heroTitle[editLang]" @input="updatePreviewDebounced()">
        </div>

        <div class="section-box">
            <h2 class="font-bold text-xs mb-2">Ù…Ø­ØªÙˆÙ‰ Ø§Ù„ØµÙØ­Ø©</h2>
            <div class="space-y-2 mb-4">
                <template x-for="(block, index) in blocks" :key="block.id">
                    <div class="bg-white border p-3 rounded-lg relative shadow-sm">
                        <button @click="removeBlock(index)" class="absolute top-2 left-2 text-red-500 font-bold hover:bg-red-50 rounded px-1">Ã—</button>
                        <div class="flex justify-between mb-2 pl-6">
                            <span class="text-[10px] bg-gray-100 px-2 rounded uppercase font-bold text-gray-400" x-text="block.type"></span>
                            <div class="flex gap-1">
                                <button @click="moveBlock(index, -1)" class="p-1">â†‘</button>
                                <button @click="moveBlock(index, 1)" class="p-1">â†“</button>
                            </div>
                        </div>
                        
                        <!-- Offers Slider Editor -->
                        <template x-if="block.type === 'offers_slider'">
                            <div>
                                <label class="text-blue-600 font-bold">Ø¹Ù†ÙˆØ§Ù† Ø§Ù„Ù‚Ø³Ù…</label>
                                <input type="text" x-model="block.title[editLang]" @input="updatePreviewDebounced()" class="w-full text-xs p-1 border rounded mb-2">
                                
                                <div class="space-y-2 max-h-60 overflow-y-auto pr-1">
                                    <template x-for="(offer, oIdx) in block.items" :key="oIdx">
                                        <div class="bg-gray-50 p-2 rounded border border-gray-200 relative">
                                            <button @click="block.items.splice(oIdx, 1); updatePreviewDebounced()" class="absolute top-1 left-1 text-red-500 text-[10px] font-bold">x</button>
                                            <input type="text" x-model="offer.img" @input="updatePreviewDebounced()" placeholder="Ø±Ø§Ø¨Ø· Ø§Ù„ØµÙˆØ±Ø©" class="w-full text-[10px] mb-1 border rounded p-1">
                                            <div class="flex gap-1">
                                                <input type="text" x-model="offer.title[editLang]" @input="updatePreviewDebounced()" placeholder="Ø§Ø³Ù… Ø§Ù„Ù…Ù†ØªØ¬" class="flex-1 text-[10px] border rounded p-1">
                                                <input type="text" x-model="offer.price" @input="updatePreviewDebounced()" placeholder="Ø§Ù„Ø³Ø¹Ø±" class="w-12 text-[10px] border rounded p-1 text-center">
                                            </div>
                                            <input type="text" x-model="offer.link" @input="updatePreviewDebounced()" placeholder="Ø±Ø§Ø¨Ø· Ø§Ù„ØµÙØ­Ø© (Link)" class="w-full text-[10px] mt-1 border rounded p-1">
                                        </div>
                                    </template>
                                </div>
                                <button @click="block.items.push({img:'', title:{ar:'Ù…Ù†ØªØ¬ Ø¬Ø¯ÙŠØ¯', he:'××•×¦×¨ ×—×“×©'}, price:'100', link:'#'}); updatePreviewDebounced()" class="mt-2 text-[10px] text-blue-600 font-bold w-full border border-blue-200 rounded p-1 hover:bg-blue-50">+ Ø¥Ø¶Ø§ÙØ© Ø¹Ø±Ø¶ Ø¢Ø®Ø±</button>
                            </div>
                        </template>

                        <!-- Interactive Rating -->
                        <template x-if="block.type === 'interactive_rating'">
                            <div>
                                <label class="text-yellow-600 font-bold">ØªÙ‚ÙŠÙŠÙ… ØªÙØ§Ø¹Ù„ÙŠ</label>
                                <input type="text" x-model="block.content[editLang]" @input="updatePreviewDebounced()" class="w-full text-xs p-1 border rounded mt-1" placeholder="Ø¹Ù†ÙˆØ§Ù† Ø§Ù„ØªÙ‚ÙŠÙŠÙ…">
                            </div>
                        </template>

                        <!-- Text Editor -->
                        <template x-if="block.type === 'text'">
                            <div class="space-y-2">
                                <div class="flex flex-wrap gap-2 items-center bg-gray-50 p-2 rounded border border-gray-200">
                                    <div class="flex items-center gap-1">
                                        <input type="color" x-model="block.style.color" @input="updatePreviewDebounced()" class="w-6 h-6 p-0 border-0 rounded cursor-pointer">
                                        <div class="flex gap-1">
                                            <div @click="block.style.color='#000000'; updatePreviewDebounced()" class="color-dot bg-black"></div>
                                            <div @click="block.style.color='#dc2626'; updatePreviewDebounced()" class="color-dot bg-red-600"></div>
                                            <div @click="block.style.color='#d97706'; updatePreviewDebounced()" class="color-dot bg-amber-600"></div>
                                        </div>
                                    </div>
                                    <select x-model="block.style.font" @change="updatePreviewDebounced()" class="text-[10px] p-1 border rounded h-8 bg-white"><option value="Cairo">Cairo</option><option value="Tajawal">Tajawal</option></select>
                                    <select x-model="block.style.size" @change="updatePreviewDebounced()" class="text-[10px] p-1 border rounded h-8 bg-white"><option value="text-sm">S</option><option value="text-lg">L</option><option value="text-2xl">XL</option></select>
                                    <select x-model="block.align" @change="updatePreviewDebounced()" class="text-[10px] p-1 border rounded h-8 bg-white w-16"><option value="center">ÙˆØ³Ø·</option><option value="right">ÙŠÙ…ÙŠÙ†</option></select>
                                </div>
                                <textarea x-model="block.content[editLang]" @input="updatePreviewDebounced()" class="mt-2 h-20 w-full border p-2 rounded text-xs"></textarea>
                            </div>
                        </template>

                        <!-- Urgency Box Editor -->
                        <template x-if="block.type === 'urgency_box'">
                            <div>
                                <div class="bg-red-50 p-2 rounded mb-2 border border-red-100">
                                    <!-- FIX: Ø¥Ø¶Ø§ÙØ© Ø­Ù‚Ù„ sold Ù„Ø£Ù†Ù‡ ÙƒØ§Ù† Ù…ÙˆØ¬ÙˆØ¯ Ø¨Ø§Ù„Ø¨Ù„ÙˆÙƒ Ø¨Ø¯ÙˆÙ† Ù…Ø­Ø±Ø± -->
                                    <label class="text-[9px]">Ø§Ù„Ù…Ø¨ÙŠØ¹Ø§Øª Ø§Ù„ÙŠÙˆÙ… (Sold)</label>
                                    <input type="number" x-model="block.sold" @input="updatePreviewDebounced()" class="w-full text-center font-bold">

                                    <div class="flex gap-2 mb-1 mt-2">
                                        <div class="flex-1"><label class="text-[9px]">Ø§Ù„Ø²ÙˆØ§Ø±</label><input type="number" x-model="block.visitors" @input="updatePreviewDebounced()" class="w-full text-center font-bold"></div>
                                        <div class="flex-1"><label class="text-[9px]">Ø§Ù„Ù‚Ø·Ø¹</label><input type="number" x-model="block.left" @input="updatePreviewDebounced()" class="w-full text-center font-bold text-red-600"></div>
                                    </div>
                                    <label class="text-[9px]">Ø§Ù„Ø¯Ù‚Ø§Ø¦Ù‚</label><input type="number" x-model="block.timerMinutes" @input="updatePreviewDebounced()" class="w-full">
                                </div>
                            </div>
                        </template>

                        <template x-if="['image','video','iframe'].includes(block.type)">
                            <input type="text" x-model="block.url" @input="updatePreviewDebounced()" placeholder="URL" class="mt-2 w-full border p-1 rounded text-xs">
                        </template>

                        <template x-if="block.type === 'form'">
                            <div>
                                <label>Ù†Øµ Ø²Ø± Ø§Ù„ØªØ£ÙƒÙŠØ¯</label>
                                <input type="text" x-model="block.btnText[editLang]" @input="updatePreviewDebounced()" class="mt-1 w-full border border-pink-200 p-1 rounded text-xs font-bold text-center">
                            </div>
                        </template>
                        
                        <template x-if="['button','emoji'].includes(block.type)">
                             <textarea x-model="block.content[editLang]" @input="updatePreviewDebounced()" class="mt-2 h-14 w-full border p-1 rounded text-xs"></textarea>
                             <input x-show="block.type==='button'" type="text" x-model="block.link" @input="updatePreviewDebounced()" placeholder="Link" class="mt-1 w-full border p-1 rounded text-xs">
                        </template>

                        <template x-if="block.type === 'embed'">
                            <textarea x-model="block.content[editLang]" @input="updatePreviewDebounced()" class="mt-2 h-24 w-full border p-2 rounded text-xs font-mono text-left bg-gray-50" dir="ltr"></textarea>
                        </template>

                        <template x-if="block.type === 'comparison'">
                            <div class="mt-2 space-y-2">
                                <button @click="block.items.push({mad:{ar:'', he:''}, other:{ar:'', he:''}}); updatePreviewDebounced()" class="text-[10px] text-blue-600 font-bold">+ Ø¥Ø¶Ø§ÙØ© Ø³Ø·Ø±</button>

                                <!-- FIX: ÙƒØ§Ù† ÙŠÙ…ÙƒÙ† Ø¥Ø¶Ø§ÙØ© Ø³Ø·Ø± Ù„ÙƒÙ† Ø¨Ø¯ÙˆÙ† Ù…Ø­Ø±Ø± Ù„Ù„Ù†ØµÙˆØµ -->
                                <div class="space-y-2 max-h-64 overflow-y-auto pr-1 mt-2">
                                    <template x-for="(row, rIdx) in block.items" :key="rIdx">
                                        <div class="bg-gray-50 p-2 rounded border border-gray-200 relative">
                                            <button @click="block.items.splice(rIdx,1); updatePreviewDebounced()" class="absolute top-1 left-1 text-red-500 text-[10px] font-bold">x</button>

                                            <label class="text-[9px] text-amber-600 font-black">MAD</label>
                                            <textarea x-model="row.mad[editLang]" @input="updatePreviewDebounced()" class="h-12 w-full border p-1 rounded text-[10px]"></textarea>

                                            <label class="text-[9px] text-gray-400 font-black">OTHERS</label>
                                            <textarea x-model="row.other[editLang]" @input="updatePreviewDebounced()" class="h-12 w-full border p-1 rounded text-[10px]"></textarea>
                                        </div>
                                    </template>
                                </div>
                            </div>
                        </template>

                        <template x-if="block.type === 'fragrantica'">
                            <div>
                                <!-- FIX: Ø¥Ø¶Ø§ÙØ© Ø±Ø§Ø¨Ø· Ù„Ø£Ù† Ø§Ù„ÙƒØ±Øª ÙŠØ¹ØªÙ…Ø¯ Ø¹Ù„Ù‰ b.url ÙˆÙƒØ§Ù† ÙØ§Ø±Øº Ø¨Ø¯ÙˆÙ† Ù…Ø­Ø±Ø± -->
                                <label>Ø§Ù„Ø±Ø§Ø¨Ø· (Fragrantica)</label>
                                <input type="text" x-model="block.url" @input="updatePreviewDebounced()" class="w-full text-xs" placeholder="https://...">
                                <label>Ø§Ù„Ù†Ø¬ÙˆÙ…</label>
                                <select x-model="block.stars" @change="updatePreviewDebounced()" class="w-full text-xs"><option value="5">5</option><option value="4">4</option></select>
                                <input type="text" x-model="block.score" @input="updatePreviewDebounced()" class="w-full mt-1 text-xs" placeholder="Score">
                                <label class="mt-1">Ø§Ù„Ù†Øµ</label>
                                <input type="text" x-model="block.content[editLang]" @input="updatePreviewDebounced()" class="w-full mt-1 text-xs" placeholder="ØªÙ‚ÙŠÙŠÙ…Ø§Øª Ù…Ù…ØªØ§Ø²Ø©">
                            </div>
                        </template>
                    </div>
                </template>
            </div>
            
            <div class="grid grid-cols-2 gap-2">
                <button class="btn-add border-blue-500 bg-blue-100 text-blue-900 font-bold" @click="addBlock('offers_slider')">ğŸ›’ Ø´Ø±ÙŠØ· Ø§Ù„Ø¹Ø±ÙˆØ¶</button>
                <button class="btn-add border-yellow-500 bg-yellow-100 text-yellow-900 font-bold" @click="addBlock('interactive_rating')">â­ ØªÙ‚ÙŠÙŠÙ… ØªÙØ§Ø¹Ù„ÙŠ</button>
                <button class="btn-add border-red-500 bg-red-100 text-red-900 font-bold shadow-sm" @click="addBlock('urgency_box')">ğŸ”¥ Ø¹Ø¯Ø§Ø¯ + Ø¶ØºØ·</button>
                <button class="btn-add" @click="addBlock('form')">ğŸ“‹ ÙÙˆØ±Ù…</button>
                <button class="btn-add" @click="addBlock('text')">ğŸ“ Ù†Øµ</button>
                <button class="btn-add" @click="addBlock('image')">ğŸ–¼ï¸ ØµÙˆØ±Ø©</button>
                <button class="btn-add" @click="addBlock('video')">ğŸ¥ ÙÙŠØ¯ÙŠÙˆ</button>
                <button class="btn-add" @click="addBlock('iso')">ğŸ›¡ï¸ ISO</button>
                <button class="btn-add border-amber-500 bg-amber-100 text-amber-900 font-bold" @click="addBlock('comparison')">âš–ï¸ Ù…Ù‚Ø§Ø±Ù†Ø© ÙƒØ§Ù…Ù„Ø©</button>
                <button class="btn-add" @click="addBlock('fragrantica')">â­ ÙØ±Ø§Ø¬Ø±Ø§Ù†ØªÙŠÙƒØ§</button>
                <button class="btn-add" @click="addBlock('button')">ğŸ”— Ø²Ø±</button>
                <button class="btn-add" @click="addBlock('sales_pop')">ğŸ”” Ø¥Ø´Ø¹Ø§Ø±Ø§Øª</button>
                <button class="btn-add" @click="addBlock('embed')">ğŸ’» ÙƒÙˆØ¯</button>
            </div>
        </div>

        <button class="btn-download" @click="downloadHTML()">ğŸ’¾ ØªØ­Ù…ÙŠÙ„ Ø§Ù„ØµÙØ­Ø©</button>
        <button class="btn-copy" @click="copyCode()">ğŸ“‹ Ù†Ø³Ø® Ø§Ù„ÙƒÙˆØ¯</button>
    </aside>

    <main class="preview-area">
        <div class="zoom-controls">
            <button @click="zoomOut()" class="zoom-btn"><i data-lucide="minus" class="w-4"></i></button>
            <span class="text-xs font-bold w-8 text-center" x-text="Math.round(zoom*100) + '%'"></span>
            <button @click="zoomIn()" class="zoom-btn"><i data-lucide="plus" class="w-4"></i></button>
            <button @click="updatePreview()" class="zoom-btn border-r border-white/20 pr-2 mr-2"><i data-lucide="refresh-cw" class="w-4"></i></button>
        </div>
        <div class="iphone-wrapper" :style="`transform: scale(${zoom})`">
            <div class="iphone"><iframe id="preview-frame"></iframe></div>
        </div>
    </main>
</div>

<script>
    function builderApp() {
        return {
            editLang: 'ar',
            zoom: 0.85,
            previewTimeout: null,
            config: {
                bgColor: '#f7e8e8',
                logoUrl: 'https://madperfume.ps/upload/01-2026/page/6977cf82b87ef.png',
                heroTitle: {ar: 'Ø£Ù‚ÙˆÙ‰ Ø§Ù„Ø¹Ø±ÙˆØ¶ Ø§Ù„Ø­ØµØ±ÙŠØ©', he: '×”××‘×¦×¢×™× ×”×‘×œ×¢×“×™×™× ×‘×™×•×ª×¨'},
                productName: 'MAD Offer',
                price: '150',
                adminPhone: '972525105889',
                sheetUrl: 'https://script.google.com/macros/s/AKfycbw7m6OCcTnH6CILpTo2TVRZIXXy5cui-zhKsCq3k491yaun5Hd5b_QECTjCrpCytkndDg/exec',
                fbPixel: '1072283127290819', ttPixel: 'D2D02JBC77U4ENLN9SBG', snapPixel: 'b143822e-1c3c-40ff-93f7-edadee74e626'
            },
            blocks: [
                {id:1, type:'text', content:{ar:'Ø£Ù‡Ù„Ø§Ù‹ Ø¨Ùƒ', he:'×‘×¨×•×›×™× ×”×‘××™×'}, align:'center', style:{color:'#000000', size:'text-lg', font:'Cairo', weight:'font-black'}},
                {id:2, type:'urgency_box', sold:'650', left:'8', visitors:'600', timerMinutes:15},
                {id:3, type:'form', content:{ar:'Ø§Ø·Ù„Ø¨ Ø§Ù„Ø¢Ù†', he:'×”×–×× ×” ××”×™×¨×”'}, btnText:{ar:'ØªØ£ÙƒÙŠØ¯ Ø§Ù„Ø·Ù„Ø¨', he:'×©×œ×— ×”×–×× ×”'}, align:'center'}
            ],
            
            init() { setTimeout(()=> { if(window.lucide) lucide.createIcons(); this.updatePreview(); }, 500); if(window.innerHeight < 900) this.zoom = 0.7; },
            setEditLang(l) { this.editLang = l; this.updatePreview(); },
            updatePreviewDebounced() { clearTimeout(this.previewTimeout); this.previewTimeout = setTimeout(()=> this.updatePreview(), 400); },
            zoomIn() { if(this.zoom < 1.2) this.zoom += 0.05; },
            zoomOut() { if(this.zoom > 0.4) this.zoom -= 0.05; },

            addBlock(type) {
                let content = {ar:'', he:''};
                let style = {}; 
                let btnText = {ar:'', he:''};
                let items = [];
                let stars = 5;
                let score = '4.9 / 5';
                let sold = '600';
                let left = '8';
                let visitors = '550';
                let timerMinutes = 15;
                let title = {ar:'Ø¹Ø±ÙˆØ¶ Ø£Ø®Ø±Ù‰ Ù‚Ø¯ ØªØ¹Ø¬Ø¨Ùƒ', he:'××•×¦×¨×™× × ×•×¡×¤×™× ×©××•×œ×™ ×ª××”×‘'};

                // Set default style for text
                if(type === 'text') style = { color: '#000000', size: 'text-lg', font: 'Cairo', weight: 'font-black' };
                else style = { color: '#000000', size: 'text-base', font: 'Cairo', weight: 'normal' };

                if(type === 'stock') content = {ar:'âš ï¸ ØªÙ†Ø¨ÙŠÙ‡: Ø§Ù„ÙƒÙ…ÙŠØ© ØªÙ†ÙØ° Ø¨Ø³Ø±Ø¹Ø©!', he:'âš ï¸ ×©×™××• ×œ×‘: ×”××œ××™ ××•×–×œ!'};
                if(type === 'sales_pop') content = {ar:'Ù…ÙØ¹Ù„', he:'××•×¤×¢×œ'};
                if(type === 'form') { content = {ar:'Ø§Ø·Ù„Ø¨ Ø§Ù„Ø¢Ù†', he:'×”×–×× ×” ××”×™×¨×”'}; btnText = {ar:'ØªØ£ÙƒÙŠØ¯ Ø§Ù„Ø·Ù„Ø¨', he:'×©×œ×— ×”×–×× ×”'}; }
                
                if(type === 'comparison') {
                    items = [
                        {mad:{ar:'Ø¨ØµÙ…Ø© Ø£Ù…Ø§Ù† 100% ÙˆÙ…ØµØ§Ø¯Ù‚ Ù…Ù† IFRA', he:'×‘×˜×•×— ×‘-100% ×•×××•×©×¨ ×¢"×™ IFRA'}, other:{ar:'Ø²ÙŠÙˆØª ÙƒÙŠÙ…ÙŠØ§Ø¦ÙŠØ© Ù…Ø¬Ù‡ÙˆÙ„Ø© Ø§Ù„Ù…ØµØ¯Ø±', he:'×©×× ×™× ×××§×•×¨ ×œ× ×™×“×•×¢'}},
                        {mad:{ar:'ØªØ·Ø§Ø¨Ù‚ Ø¬Ø²ÙŠØ¦ÙŠ ÙˆØªØ±ÙƒÙŠØ² Ù†ÙŠØ´ Ø­Ù‚ÙŠÙ‚ÙŠ', he:'×”×ª×××” ××•×œ×§×•×œ×¨×™×ª ×•×¨×™×›×•×– × ×™×©×”'}, other:{ar:'Ø®Ù„Ø· ÙŠØ¯ÙˆÙŠ Ø¹Ø´ÙˆØ§Ø¦ÙŠ ÙŠØªÙÙƒÙƒ ÙÙˆØ±Ø§Ù‹', he:'×¢×¨×‘×•×‘ ×™×“× ×™ ××§×¨××™'}},
                        {mad:{ar:'Ø«Ø¨Ø§Øª ÙØ§Ø¦Ù‚ ÙŠØªØ¬Ø§ÙˆØ² 24 Ø³Ø§Ø¹Ø©', he:'×¢××™×“×•×ª ××¢×œ 24 ×©×¢×•×ª'}, other:{ar:'ÙŠØ®ØªÙÙŠ Ø¨Ø¹Ø¯ Ø£Ù‚Ù„ Ù…Ù† Ø³Ø§Ø¹Ø©', he:'× ×¢×œ× ××”×¨'}},
                        {mad:{ar:'Ù„Ø§ ÙŠØ³Ø¨Ø¨ Ø§Ù„Ø­Ø³Ø§Ø³ÙŠØ© Ø£Ùˆ Ø§Ù„ØµØ¯Ø§Ø¹', he:'×œ× ×’×•×¨× ×œ××œ×¨×’×™×•×ª ××• ×›××‘×™ ×¨××©'}, other:{ar:'Ù…Ø°ÙŠØ¨Ø§Øª ÙƒÙŠÙ…ÙŠØ§Ø¦ÙŠØ© Ø¶Ø§Ø±Ø©', he:'×××¡×™× ×›×™××™×™× ××–×™×§×™×'}},
                        {mad:{ar:'Ø®Ø¯Ù…Ø© Ø²Ø¨Ø§Ø¦Ù† Ùˆ41 ÙØ±Ø¹ ÙÙŠ Ø§Ù„Ø¨Ù„Ø§Ø¯', he:'×©×™×¨×•×ª ×œ×§×•×—×•×ª ×•-41 ×¡× ×™×¤×™× ×‘××¨×¥'}, other:{ar:'Ù…ØªØ§Ø¬Ø± Ø£ÙˆÙ†Ù„Ø§ÙŠÙ† Ø¨Ù„Ø§ Ø¹Ù†ÙˆØ§Ù†', he:'×—× ×•×™×•×ª ××•× ×œ×™×™×Ÿ ×œ×œ× ×›×ª×•×‘×ª'}},
                        {mad:{ar:'ØªØ¹ØªÙŠÙ‚ ÙˆØªØµÙÙŠØ© Ù…Ø®Ø¨Ø±ÙŠØ© Ø£ÙˆØ±ÙˆØ¨ÙŠØ©', he:'×™×™×©×•×Ÿ ×•×¡×™× ×•×Ÿ ××¢×‘×“×ª×™ ××™×¨×•×¤××™'}, other:{ar:'Ø²ÙŠÙˆØª ØªØ¬Ø§Ø±ÙŠØ© Ø±Ø®ÙŠØµØ©', he:'×©×× ×™× ××¡×—×¨×™×™× ×–×•×œ×™×'}},
                        {mad:{ar:'Ù…ØµØ§Ø¯Ù‚Ø§Øª Ø§Ù„Ø£ÙŠØ²Ùˆ ÙˆÙˆØ²Ø§Ø±Ø© Ø§Ù„ØµØ­Ø©', he:'××™×©×•×¨ ×ª×§×Ÿ ISO ×•××©×¨×“ ×”×‘×¨×™××•×ª'}, other:{ar:'ØºÙŠØ± Ù…ÙØ­ÙˆØµ ÙˆÙ…Ù‚Ù„Ø¯', he:'×œ× × ×‘×“×§ '}}
                    ];
                }
                
                if(type === 'offers_slider') {
                    items = [
                        {img:'https://www.mad-parfumeur.com/assets/hero/4.webp', title:{ar:'Ø¹Ø·Ø± Ø§Ù„Ù…Ø³Ùƒ', he:'×‘×•×©× ×××¡×§'}, price:'120', link:'#'},
                        {img:'https://www.mad-parfumeur.com/assets/hero/4.webp', title:{ar:'Ø¹Ø·Ø± Ø§Ù„Ø¹ÙˆØ¯', he:'×‘×•×©× ×¢×•×“'}, price:'150', link:'#'},
                        {img:'https://www.mad-parfumeur.com/assets/hero/4.webp', title:{ar:'Ø¨ÙƒØ¬ Ø§Ù„Ø¹ÙŠØ¯', he:'×××¨×– ×—×’'}, price:'200', link:'#'}
                    ];
                }

                if(type === 'fragrantica') content = {ar:'ØªÙ‚ÙŠÙŠÙ…Ø§Øª Ù…Ù…ØªØ§Ø²Ø©', he:'×‘×™×§×•×¨×•×ª ××¦×•×™× ×•×ª'};
                if(type === 'interactive_rating') content = {ar:'Ù…Ø§ Ù‡Ùˆ ØªÙ‚ÙŠÙŠÙ…Ùƒ Ù„Ù…Ù†ØªØ¬Ø§ØªÙ†Ø§ØŸ', he:'××™×š ××ª× ××“×¨×’×™× ××ª ×”××•×¦×¨×™× ×©×œ× ×•ØŸ'};

                this.blocks.push({id:Date.now(), type, content, btnText, url:'', link:'#order', align:'center', items, score, stars, style, sold, left, visitors, timerMinutes, title});
                this.updatePreview();
            },
            removeBlock(i) { this.blocks.splice(i,1); this.updatePreview(); },
            moveBlock(i, d) {
                const ni = i + d;
                if (ni < 0 || ni >= this.blocks.length) return;
                [this.blocks[i], this.blocks[ni]] = [this.blocks[ni], this.blocks[i]];
                this.updatePreview();
            },
            updatePreview() {
                const frame = document.getElementById('preview-frame');
                if(frame) frame.srcdoc = this.generateFinalHTML(false);
            },
            async copyCode() {
                const code = this.generateFinalHTML(true);
                try { await navigator.clipboard.writeText(code); alert('âœ… ØªÙ… Ø§Ù„Ù†Ø³Ø®!'); } 
                catch(err) { const ta = document.createElement('textarea'); ta.value = code; document.body.appendChild(ta); ta.select(); document.execCommand('copy'); document.body.removeChild(ta); alert('âœ… ØªÙ… Ø§Ù„Ù†Ø³Ø®!'); }
            },
            generateFinalHTML(isDownload) {
                const bJ = JSON.stringify(this.blocks).replace(/</g, '\\u003c');
                const cJ = JSON.stringify(this.config).replace(/</g, '\\u003c');
                const PRICE_VAL = this.config.price || '0';
                const PROD_NAME = (this.config.productName || 'MAD Offer').replace(/'/g, "\\'");
                const ADMIN_PHONE_VAL = this.config.adminPhone || '';
                const iL = isDownload ? null : `'${this.editLang}'`;

                return `<!DOCTYPE html>
<html x-data="app()" x-init="init(${iL})" :lang="lang" :dir="lang==='he'?'ltr':'rtl'">
<head>
<meta charset="UTF-8"><meta name="viewport" content="width=device-width, initial-scale=1.0">
<script src="https://cdn.tailwindcss.com"><\/script>
<script src="https://unpkg.com/lucide@latest" defer><\/script>
<script src="https://unpkg.com/alpinejs@3.x.x/dist/cdn.min.js" defer><\/script>
<link href="https://fonts.googleapis.com/css2?family=Amiri:wght@400;700&family=Aref+Ruqaa:wght@400;700&family=Cairo:wght@200..1000&family=Rakkas&family=Tajawal:wght@200..900&display=swap" rel="stylesheet">
<style>
body { background: ${this.config.bgColor}; font-family: 'Cairo', sans-serif; overflow-x: hidden; min-height: 100vh; }
.inp { width: 100%; padding: 15px; background: #f8fafc; border: 1px solid #ddd; border-radius: 12px; margin-bottom: 10px; font-weight: bold; }
.btn-main { 
    background: #000; color: #fff; width: 100%; padding: 18px; border-radius: 14px; font-weight: 900; font-size: 1.2rem;
    box-shadow: 0 4px 14px rgba(0,0,0,0.2); position: relative; overflow: hidden;
    animation: pulse 2s infinite;
}
@keyframes pulse { 0% { transform: scale(1); box-shadow: 0 0 0 0 rgba(0, 0, 0, 0.7); } 70% { transform: scale(1.02); box-shadow: 0 0 0 10px rgba(0, 0, 0, 0); } 100% { transform: scale(1); box-shadow: 0 0 0 0 rgba(0, 0, 0, 0); } }
@keyframes loadingBar { 0% { width: 0%; } 80% { width: 90%; } 100% { width: 100%; } }
.progress-container { margin-bottom: 15px; }
.progress-text { display: flex; justify-content: space-between; font-size: 0.75rem; font-weight: bold; margin-bottom: 5px; opacity: 0.7; }
.progress-track { height: 6px; background: #e5e7eb; border-radius: 99px; overflow: hidden; }
.progress-fill { height: 100%; background: #10b981; width: 85%; }
.mad-radio-box { border: 2px solid #e5e7eb; border-radius: 12px; padding: 12px; text-align: center; cursor: pointer; transition: all 0.2s ease; background: white; color: #4b5563; font-weight: 700; }
input[type="radio"]:checked + .mad-radio-box { border-color: #10b981; background: #f0fdf4; color: #047857; transform: scale(1.02); box-shadow: 0 4px 12px rgba(16, 185, 129, 0.2); }
.mad-radio-box.recommended { border-color: #10b981; position: relative; }
.mad-radio-box.recommended::after { content: 'â˜…'; position: absolute; top: -8px; right: -8px; background: #10b981; color: white; border-radius: 50%; width: 20px; height: 20px; font-size: 10px; display: flex; align-items: center; justify-content: center; }
.sales-pop { animation: slideIn 0.5s ease-out forwards; }
@keyframes slideIn { from { transform: translateY(100px); opacity: 0; } to { transform: translateY(0); opacity: 1; } }
/* Hide scrollbar for Chrome, Safari and Opera */
.no-scrollbar::-webkit-scrollbar { display: none; }
/* Hide scrollbar for IE, Edge and Firefox */
.no-scrollbar { -ms-overflow-style: none;  scrollbar-width: none; }
.page-block { content-visibility: auto; contain-intrinsic-size: 0 400px; }
</style>
</head>
<body class="pb-20">
    <nav class="p-4 flex justify-center bg-white/40 backdrop-blur sticky top-0 z-50"><img src="${this.config.logoUrl}" class="h-10 object-contain"></nav>
    <header class="text-center py-8 px-4"><h1 class="text-3xl font-black" x-text="c.heroTitle[lang]"></h1></header>
    
    <main class="max-w-md mx-auto px-4">
        <template x-for="(b, idx) in blocks">
            <div class="my-6 page-block" :class="b.align==='center'?'text-center':(b.align==='left'?'text-left':'text-right')">
                <template x-if="b.type==='text'">
                    <p class="whitespace-pre-wrap leading-relaxed" :class="[b.style?.size || 'text-lg', b.style?.weight || 'font-bold']" :style="{ color: b.style?.color || '#000', fontFamily: (b.style?.font || 'Cairo') + ', sans-serif' }" x-text="b.content[lang]"></p>
                </template>
                
                <!-- Offers Slider (Horizontal Scroll) -->
                <template x-if="b.type==='offers_slider'">
                    <div class="mt-4">
                        <h3 class="text-lg font-bold mb-3 px-2 text-right" x-text="b.title[lang]"></h3>
                        <div class="flex overflow-x-auto snap-x snap-mandatory gap-3 pb-4 no-scrollbar pr-2 pl-2">
                            <template x-for="item in b.items">
                                <a :href="item.link" class="min-w-[140px] w-[140px] snap-center bg-white rounded-xl shadow-lg border border-gray-100 p-2 flex flex-col no-underline transition transform active:scale-95">
                                    <img :src="item.img" class="w-full aspect-square object-cover rounded-lg mb-2 bg-gray-100">
                                    <h4 class="text-xs font-bold text-gray-800 line-clamp-2 h-8 leading-tight mb-1" x-text="item.title[lang]"></h4>
                                    <div class="mt-auto">
                                        <p class="text-sm font-black text-red-600 mb-2" x-text="item.price + (lang==='he'?' â‚ª':' Ø´ÙŠÙƒÙ„')"></p>
                                        <div class="w-full bg-black text-white text-[10px] font-bold py-1.5 rounded text-center" x-text="lang==='he'?'×”×•×¡×£ ×œ×¡×œ':'Ø£Ø¶Ù Ù„Ù„Ø³Ù„Ø©'"></div>
                                    </div>
                                </a>
                            </template>
                        </div>
                    </div>
                </template>

                <!-- Interactive Rating Block (SVG Stars) -->
                <template x-if="b.type==='interactive_rating'">
                    <div class="bg-white border-2 border-yellow-100 rounded-xl p-6 shadow-sm text-center">
                         <h3 class="text-lg font-bold mb-3" x-text="b.content[lang]"></h3>
                         <div x-data="{ rated: false, stars: 0, hover: 0, count: Math.floor(Math.random() * 5000) + 12000 }" class="flex flex-col items-center">
                             <div class="flex gap-2 mb-2" x-show="!rated" @mouseleave="hover=0">
                                <template x-for="i in 5">
                                    <button 
                                        @click="rated=true; stars=i" 
                                        @mouseover="hover=i"
                                        class="transition-all duration-200 transform hover:scale-110"
                                    >
                                        <svg xmlns="http://www.w3.org/2000/svg" width="36" height="36" viewBox="0 0 24 24" :fill="(i <= (hover || stars)) ? '#FACC15' : 'none'" :stroke="(i <= (hover || stars)) ? 'none' : '#D1D5DB'" stroke-width="2"><polygon points="12 2 15.09 8.26 22 9.27 17 14.14 18.18 21.02 12 17.77 5.82 21.02 7 14.14 2 9.27 8.91 8.26 12 2"/></svg>
                                    </button>
                                </template>
                             </div>
                             <div x-show="rated" class="text-green-600 font-bold animate-bounce mt-2" x-transition>
                                 <p class="text-3xl mb-2">ğŸ‰</p>
                                 <p class="text-sm">
                                    <span x-text="lang==='he'?'×ª×•×“×” ×¢×œ ×”×“×™×¨×•×’!':'Ø´ÙƒØ±Ø§Ù‹ Ø¹Ù„Ù‰ ØªÙ‚ÙŠÙŠÙ…Ùƒ!'"></span>
                                    <span class="font-black" x-text="'(' + stars + '/5)'"></span>
                                 </p>
                                 <p class="text-xs text-gray-500 mt-1" x-text="lang==='he' ? '×”×¦×˜×¨×¤×ª ×œ-' + count.toLocaleString() + ' ×œ×§×•×—×•×ª ××¨×•×¦×™×' : 'Ø§Ù†Ø¶Ù…Ù…Øª Ø¥Ù„Ù‰ ' + count.toLocaleString() + ' Ø¹Ù…ÙŠÙ„ Ø³Ø¹ÙŠØ¯'"></p>
                             </div>
                         </div>
                    </div>
                </template>

                <template x-if="b.type==='urgency_box'">
                   <div x-data="{ v: parseInt(b.visitors || 600), s: parseInt(b.left || 8) }" x-init="setInterval(()=>{v+=Math.floor(Math.random()*5)-2}, 3000); setInterval(()=>{if(s>2)s--}, 9000)" class="bg-gradient-to-r from-red-50 to-orange-50 border border-red-100 rounded-2xl p-5 shadow-sm mb-4 relative overflow-hidden">
                        <div class="absolute top-0 left-0 w-1 h-full bg-red-500"></div>
                        <div class="flex items-center justify-center gap-2 text-gray-500 text-xs mb-3 font-bold"><span class="w-2 h-2 bg-green-500 rounded-full animate-pulse"></span><span x-text="v"></span><span x-text="lang==='he'?'×¦×•×¤×™× ×‘××•×¦×¨ ×–×” ×›×¢×ª':'ÙŠØªØµÙØ­ÙˆÙ† Ù‡Ø°Ø§ Ø§Ù„Ø¹Ø±Ø¶ Ø§Ù„Ø¢Ù†'"></span></div>
                        <div class="flex justify-between items-center mb-3"><span class="text-[10px] font-black bg-red-600 text-white px-2 py-1 rounded animate-pulse" x-text="lang==='he'?'ğŸ”¥ ×‘×™×§×•×© ×’×‘×•×”':'ğŸ”¥ Ø·Ù„Ø¨ Ù…Ø±ØªÙØ¹'"></span><div class="text-lg font-mono font-black text-red-600 bg-white px-2 rounded border border-red-100 shadow-sm" x-text="timer"></div></div>
                        <h3 class="text-sm font-bold text-gray-800 mb-1"><span x-text="lang==='he'?'× ××›×¨ ××¢×œ ':'ØªÙ… Ø´Ø±Ø§Ø¡ Ù‡Ø°Ø§ Ø§Ù„Ø¹Ø±Ø¶ '"></span><span class="text-red-600 text-lg" x-text="b.sold"></span><span x-text="lang==='he'?' ×¤×¢××™× ×”×™×•×':' Ù…Ø±Ø© Ø§Ù„ÙŠÙˆÙ…'"></span></h3>
                         <div class="flex items-center gap-2 text-xs text-gray-600 mb-2"><span>âš¡</span><span x-text="lang==='he'?'× ×•×ª×¨×• ':'Ø¨Ù‚ÙŠ '"></span><span class="font-black text-red-600 text-base" x-text="s"></span><span x-text="lang==='he'?' ×™×—×™×“×•×ª ×‘×œ×‘×“!':' Ù‚Ø·Ø¹ ÙÙ‚Ø·!'"></span></div>
                        <div class="w-full bg-gray-200 rounded-full h-2 overflow-hidden"><div class="bg-gradient-to-r from-red-500 to-orange-500 h-full rounded-full transition-all duration-1000" :style="'width: ' + (s*10) + '%'"></div></div>
                   </div>
                </template>

                <template x-if="b.type==='stock'">
                    <div class="bg-red-50 border border-red-200 rounded-xl p-4 shadow-sm animate-pulse">
                        <p class="text-red-600 font-black text-sm mb-2" x-text="b.content[lang]"></p>
                        <div class="w-full bg-red-200 rounded-full h-2.5"><div class="bg-red-600 h-2.5 rounded-full" style="width: 15%"></div></div>
                    </div>
                </template>

                <template x-if="b.type==='image'"><img :src="b.url" class="rounded-2xl mx-auto shadow-lg w-full" :loading="idx===0?'eager':'lazy'"></template>
                <template x-if="b.type==='video'"><video :src="b.url" controls class="w-full rounded-2xl shadow-lg" playsinline preload="none"></video></template>
                <template x-if="b.type==='iframe'"><iframe :src="b.url" class="w-full h-96 rounded-xl border-none shadow-sm" loading="lazy"></iframe></template>
                <template x-if="b.type==='button'"><a :href="b.link" class="btn-main block text-center no-underline" x-text="b.content[lang]"></a></template>
                
                <template x-if="b.type==='fragrantica'">
                    <a :href="b.url" target="_blank" class="block w-full max-w-[320px] bg-[#3f5a31] text-white p-5 rounded-[24px] shadow-xl relative overflow-hidden mx-auto no-underline text-right">
                        <div class="flex justify-between items-center mb-3">
                            <span class="text-[10px] font-black uppercase tracking-widest text-white/60">Reviews</span>
                            <div class="flex text-amber-400 gap-0.5">
                                <template x-for="i in parseInt(b.stars || 5)">
                                    <svg xmlns="http://www.w3.org/2000/svg" width="14" height="14" viewBox="0 0 24 24" fill="currentColor" stroke="none" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><polygon points="12 2 15.09 8.26 22 9.27 17 14.14 18.18 21.02 12 17.77 5.82 21.02 7 14.14 2 9.27 8.91 8.26 12 2"/></svg>
                                </template>
                            </div>
                        </div>
                        <div class="flex items-end gap-2"><span class="text-4xl font-black" x-text="b.score || '4.9 / 5'"></span><span class="text-xs opacity-60 mb-1">Rating</span></div>
                        <p class="text-[10px] font-bold mt-2 text-white/80" x-text="b.content[lang]"></p>
                    </a>
                </template>

                <template x-if="b.type==='embed'"><div x-html="b.content[lang]"></div></template>
                <template x-if="b.type==='iso'">
                    <div class="grid grid-cols-3 gap-3 w-full max-w-sm mx-auto mt-4">
                        <div class="bg-white border border-black/5 p-3 rounded-2xl text-center shadow-sm relative overflow-hidden group">
                           <div class="absolute inset-0 bg-amber-50 opacity-0 group-hover:opacity-100 transition-opacity"></div>
                           <div class="w-10 h-10 rounded-full bg-amber-100 flex items-center justify-center mx-auto mb-1 text-amber-600 relative z-10"><svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M12 22s8-4 8-10V5l-8-3-8 3v7c0 6 8 10 8 10z"></path></svg></div>
                           <p class="text-[8px] font-bold uppercase relative z-10">ISO 9001</p>
                        </div>
                        <div class="bg-white border border-black/5 p-3 rounded-2xl text-center shadow-sm relative overflow-hidden group">
                           <div class="absolute inset-0 bg-amber-50 opacity-0 group-hover:opacity-100 transition-opacity"></div>
                           <div class="w-10 h-10 rounded-full bg-amber-100 flex items-center justify-content-center mx-auto mb-1 text-amber-600 relative z-10"><svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M9 12l2 2 4-4"></path><circle cx="12" cy="12" r="10"></circle></svg></div>
                           <p class="text-[8px] font-bold uppercase relative z-10">IFRA Safe</p>
                        </div>
                        <div class="bg-white border border-black/5 p-3 rounded-2xl text-center shadow-sm relative overflow-hidden group">
                           <div class="absolute inset-0 bg-amber-50 opacity-0 group-hover:opacity-100 transition-opacity"></div>
                           <div class="w-10 h-10 rounded-full bg-amber-100 flex items-center justify-center mx-auto mb-1 text-amber-600 relative z-10"><svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M22 12h-4l-3 9L9 3l-3 9H2"></path></svg></div>
                           <p class="text-[8px] font-bold uppercase relative z-10">Health OK</p>
                        </div>
                    </div>
                </template>
                <template x-if="b.type==='comparison'">
                    <div class="space-y-2 mt-4 text-right">
                        <template x-for="row in b.items">
                            <div class="grid grid-cols-2 gap-1 rounded-xl overflow-hidden border border-black/5 shadow-sm">
                                <div class="bg-gray-50 p-4 border-r border-black/5"><span class="text-[8px] font-black text-amber-600 block mb-1">MAD</span><p class="text-[11px] font-bold leading-tight" x-text="row.mad[lang]"></p></div>
                                <div class="bg-white p-4 text-gray-400 text-right"><span class="text-[8px] font-black text-gray-300 block mb-1">OTHERS</span><p class="text-[11px]" x-text="row.other[lang]"></p></div>
                            </div>
                        </template>
                    </div>
                </template>
                <template x-if="b.type==='form'">
                    <div class="bg-white p-6 rounded-[24px] shadow-sm text-right border-2 border-gray-100" id="order">
                        <div class="progress-container"><div class="progress-text"><span x-text="lang==='he'?'×¤×¨×˜×™ ××©×œ×•×—':'Ù…Ø¹Ù„ÙˆÙ…Ø§Øª Ø§Ù„Ø´Ø­Ù†'"></span><span x-text="lang==='he'?'×©×œ×‘ ××—×¨×•×Ÿ':'Ø§Ù„Ø®Ø·ÙˆØ© Ø§Ù„Ø£Ø®ÙŠØ±Ø©'"></span></div><div class="progress-track"><div class="progress-fill"></div></div></div>
                        <h2 class="text-xl font-black text-center mb-4" x-text="b.content[lang] || (lang==='he'?'×”×–×× ×”':'Ø§Ø·Ù„Ø¨ Ø§Ù„Ø¢Ù†')"></h2>
                        <form @submit.prevent="submitForm">
                            <!-- FIX: ØªØ´ØºÙŠÙ„ trackInput ÙØ¹Ù„ÙŠØ§Ù‹ Ø¹Ù†Ø¯ Ø¨Ø¯Ø¡ Ø§Ù„ÙƒØªØ§Ø¨Ø© (AddToCart) -->
                            <input type="text" x-model="f.name" @input="trackInput()" class="inp" :placeholder="lang==='he'?'×©× ××œ×':'Ø§Ù„Ø§Ø³Ù…'" required>
                            <input type="tel" x-model="f.phone" class="inp" :placeholder="lang==='he'?'×˜×œ×¤×•×Ÿ':'Ø§Ù„Ù‡Ø§ØªÙ'" required>
                            <input type="text" x-model="f.address" class="inp" :placeholder="lang==='he'?'×›×ª×•×‘×ª':'Ø§Ù„Ø¹Ù†ÙˆØ§Ù†'" required>
                            <div class="grid grid-cols-2 gap-3 mb-4">
                                <label class="cursor-pointer group">
                                    <input type="radio" x-model="f.payment" value="Cash" class="hidden">
                                    <div class="mad-radio-box recommended">
                                        <span x-text="lang==='he'?'××–×•××Ÿ ğŸ’µ':'Ù†Ù‚Ø¯ ğŸ’µ'"></span>
                                        <div class="text-[9px] text-green-600 font-normal" x-text="lang==='he'?'××•××œ×¥':'Ù…ÙˆØµÙ‰ Ø¨Ù‡'"></div>
                                    </div>
                                </label>
                                <label class="cursor-pointer group">
                                    <input type="radio" x-model="f.payment" value="Visa" class="hidden">
                                    <div class="mad-radio-box"><span x-text="lang==='he'?'××©×¨××™ ğŸ’³':'ÙÙŠØ²Ø§ ğŸ’³'"></span></div>
                                </label>
                            </div>
                            <div class="grid grid-cols-2 gap-3 mb-6">
                                <label class="cursor-pointer group">
                                    <input type="radio" x-model="f.process" value="Direct" class="hidden">
                                    <div class="mad-radio-box recommended">
                                        <span class="text-xs" x-text="lang==='he'?'×©×œ×— ×”×–×× ×”':'Ø§Ø±Ø³Ù„ Ø§Ù„Ø·Ù„Ø¨'"></span>
                                        <div class="text-[9px] text-blue-600 font-normal">ğŸš€ Ø£Ø³Ø±Ø¹</div>
                                    </div>
                                </label>
                                <label class="cursor-pointer group">
                                    <input type="radio" x-model="f.process" value="Contact" class="hidden">
                                    <div class="mad-radio-box"><span class="text-xs" x-text="lang==='he'?'×¦×•×¨ ×§×©×¨':'ØªÙˆØ§ØµÙ„ Ù…Ø¹ÙŠ'"></span></div>
                                </label>
                            </div>
                            <button type="submit" class="btn-main transform active:scale-95 transition-transform" :disabled="loading" x-text="loading?'...':(b.btnText && b.btnText[lang] ? b.btnText[lang] : (lang==='he'?'×©×œ×— ×”×–×× ×”':'ØªØ£ÙƒÙŠØ¯ Ø§Ù„Ø·Ù„Ø¨'))"></button>
                        </form>
                    </div>
                </template>
            </div>
        </template>
    </main>
    
    <div x-show="pop.show" class="fixed bottom-4 left-4 right-4 bg-white p-3 rounded-xl shadow-2xl border border-gray-100 z-40 sales-pop flex items-center gap-3" style="display:none">
        <div class="bg-green-100 p-2 rounded-full"><span class="text-xl">ğŸ›ï¸</span></div>
        <div><p class="text-xs font-bold" x-text="pop.msg"></p><p class="text-[10px] text-gray-500">Ù…Ù†Ø° Ø¯Ù‚ÙŠÙ‚ØªÙŠÙ†</p></div>
    </div>

    <div x-show="loading" class="fixed inset-0 z-50 bg-black/90 flex flex-col items-center justify-center text-white" x-transition.opacity><div class="text-5xl mb-4 animate-bounce">ğŸš€</div><h2 class="text-xl font-bold mb-4" x-text="lang==='he'?'×©×•×œ×— ×”×–×× ×”...':'Ø¬Ø§Ø±ÙŠ Ø¥Ø±Ø³Ø§Ù„ Ø§Ù„Ø·Ù„Ø¨...'"></h2><div class="w-64 h-2 bg-gray-800 rounded-full overflow-hidden"><div class="h-full bg-green-500 transition-all duration-[3000ms] ease-out w-full" :style="loading ? 'width: 100%' : 'width: 0%'"></div></div><p class="text-xs text-gray-400 mt-2" x-text="lang==='he'?'×× × ×”××ª×Ÿ, ×œ× ×œ×¡×’×•×¨ ××ª ×”×“×£':'ÙŠØ±Ø¬Ù‰ Ø§Ù„Ø§Ù†ØªØ¸Ø§Ø± Ù‚Ù„ÙŠÙ„Ø§Ù‹...'"></p></div>
    <div x-show="submitted" class="fixed inset-0 bg-black/95 z-50 flex items-center justify-center text-center text-white" style="display:none" x-transition><div class="bg-white text-black p-10 rounded-3xl max-w-xs shadow-2xl transform scale-100 transition-transform"><div class="text-6xl mb-4">âœ…</div><h3 class="text-2xl font-black mb-2" x-text="lang==='he'?'×”×”×–×× ×” ×”×ª×§×‘×œ×”!':'ØªÙ… Ø§Ø³ØªÙ„Ø§Ù… Ø·Ù„Ø¨Ùƒ!'"></h3><p class="font-bold text-gray-600 mb-6" x-text="lang==='he'?'× ×™×¦×•×¨ ××™×ª×š ×§×©×¨ ×‘×”×§×“×':'Ø³Ù†ØªÙˆØ§ØµÙ„ Ù…Ø¹Ùƒ Ù‚Ø±ÙŠØ¨Ø§Ù‹ Ù„ØªØ£ÙƒÙŠØ¯ Ø§Ù„ØªÙØ§ØµÙŠÙ„'"></p><button @click="submitted=false" class="w-full bg-black text-white py-4 rounded-xl font-bold hover:bg-gray-900 transition">Close</button></div></div>
    
    <!-- Optimized Pixel Loading for Speed âš¡ -->
    <script>
        function loadPixels() {
            // FB
            !function(f,b,e,v,n,t,s){if(f.fbq)return;n=f.fbq=function(){n.callMethod?n.callMethod.apply(n,arguments):n.queue.push(arguments)};if(!f._fbq)n=f.fbq;n.push=n;n.loaded=!0;n.version='2.0';n.queue=[];t=b.createElement(e);t.async=!0;t.src=v;s=b.getElementsByTagName(e)[0];s.parentNode.insertBefore(t,s)}(window, document,'script','https://connect.facebook.net/en_US/fbevents.js');
            fbq('init', '${this.config.fbPixel}'); fbq('track', 'PageView');
            
            // TT
            !function (w, d, t) { w.TiktokAnalyticsObject=t; var ttq=w[t]=w[t]||[]; ttq.methods=["page","track","identify","instances","debug","on","off","once","ready","alias","group","enableCookie","disableCookie","holdConsent","revokeConsent","grantConsent"]; ttq.setAndDefer=function(t,e){t[e]=function(){t.push([e].concat(Array.prototype.slice.call(arguments,0)))}}; for(var i=0;i<ttq.methods.length;i++)ttq.setAndDefer(ttq,ttq.methods[i]); ttq.load=function(e,n){ var r="https://analytics.tiktok.com/i18n/pixel/events.js"; var o=n&&n.partner; ttq._i=ttq._i||{}; ttq._i[e]=[]; ttq._i[e]._u=r; ttq._t=ttq._t||{}; ttq._t[e]=+new Date; ttq._o=ttq._o||{}; ttq._o[e]=n||{}; n=document.createElement("script"); n.type="text/javascript"; n.async=!0; n.src=r+"?sdkid="+e+"&lib="+t; e=document.getElementsByTagName("script")[0]; e.parentNode.insertBefore(n,e) }; ttq.load('${this.config.ttPixel}'); ttq.page(); }(window, document, 'ttq');
            
            // Snap
            (function(e,t,n){if(e.snaptr)return;var a=e.snaptr=function(){a.handleRequest?a.handleRequest.apply(a,arguments):a.queue.push(arguments)};a.queue=[];var s='script';var r=t.createElement(s);r.async=!0;r.src=n;var u=t.getElementsByTagName(s)[0];u.parentNode.insertBefore(r,u)})(window,document,'https://sc-static.net/scevent.min.js');
            snaptr('init', '${this.config.snapPixel}'); snaptr('track', 'PAGE_VIEW');
        }

        function app() {
            return {
                lang: 'ar', loading: false, submitted: false, pop: {show:false, msg:''}, hasStartedTyping: false,
                blocks: ${bJ}, c: ${cJ}, f: {name:'', phone:'', address:'', payment:'Cash', process:'Direct'},
                // Timer Logic
                time: ${JSON.parse(bJ).find(b => b.type === 'urgency_box')?.timerMinutes * 60 || 900},
                get timer() { const m=Math.floor(this.time/60); const s=this.time%60; return \`\${m}:\${s<10?'0':''}\${s}\`; },
                
                init(l) { 
                    this.lang = l || (navigator.language.startsWith('he')?'he':'ar'); 
                    if(this.blocks.some(b => b.type === 'sales_pop')) {
                        setInterval(() => {
                            const names = this.lang === 'he' ? ['××—××“','×©×¨×”','××•×—××“','× ×•×¨','×¢×•××¨'] : ['Ø£Ø­Ù…Ø¯','Ø³Ø§Ø±Ø©','Ù…Ø­Ù…Ø¯','Ù†ÙˆØ±','Ø¹Ù…Ø±'];
                            const cities = this.lang === 'he' ? ['×™×¨×•×©×œ×™×','×—×™×¤×”','× ×¦×¨×ª','×ª×œ ××‘×™×‘'] : ['Ø§Ù„Ù‚Ø¯Ø³','Ø­ÙŠÙØ§','Ø§Ù„Ù†Ø§ØµØ±Ø©','ÙŠØ§ÙØ§'];
                            const name = names[Math.floor(Math.random() * names.length)];
                            const city = cities[Math.floor(Math.random() * cities.length)];
                            this.pop.msg = this.lang === 'he' ? \`\${name} ×\${city} ×§× ×” ×¢×›×©×™×•\` : \`\${name} Ù…Ù† \${city} Ø§Ø´ØªØ±Ù‰ Ø§Ù„Ø¢Ù†\`;
                            this.pop.show = true;
                            setTimeout(() => this.pop.show = false, 4000);
                        }, 15000);
                    }
                    setInterval(() => { if(this.time > 0) this.time--; }, 1000);

                    // Load Pixels Delayed for Speed
                    setTimeout(loadPixels, 3500);
                },
                trackInput() {
                    if(!this.hasStartedTyping && this.f.name.length > 2) {
                        this.hasStartedTyping = true;
                        const p = { content_name: '${PROD_NAME}', value: ${PRICE_VAL}, currency: 'ILS' };
                        // Ensure objects exist before tracking
                        if(window.fbq) fbq('track', 'AddToCart', p);
                        if(window.ttq) ttq.track('AddToCart', p);
                        if(window.snaptr) snaptr('track', 'ADD_CART', p);
                    }
                },
                async submitForm() {
                    this.loading = true;
                    await new Promise(r => setTimeout(r, 800));
                    const fd = new FormData();
                    Object.keys(this.f).forEach(k => fd.append(k, this.f[k]));
                    fd.append('lang', this.lang);
                    fd.append('offer', '${PROD_NAME}');
                    fd.append('price', '${PRICE_VAL}');
                    fd.append('admin_phone', '${ADMIN_PHONE_VAL}');
                    try {
                        if(window.fbq) fbq('track', 'Purchase', {value: ${PRICE_VAL}, currency: 'ILS', content_name: '${PROD_NAME}'});
                        if(window.ttq) ttq.track('CompletePayment', {value: ${PRICE_VAL}, currency: 'ILS', content_name: '${PROD_NAME}'});
                        if(window.snaptr) snaptr('track', 'PURCHASE', {currency: 'ILS', price: ${PRICE_VAL}});

                        await fetch(this.c.sheetUrl, { method: 'POST', body: fd, mode: 'no-cors' });
                        await new Promise(r => setTimeout(r, 1500));
                        this.loading = false;
                        this.submitted = true;
                        this.f = {name:'', phone:'', address:'', payment:'Cash', process:'Direct'};
                    } catch(e) { this.loading = false; alert('Error'); }
                }
            }
        }
    <\/script>
</body>
</html>`;
            },

            downloadHTML() {
                const code = this.generateFinalHTML(true);
                const blob = new Blob([code], { type: "text/html" });
                const a = document.createElement("a");
                a.href = URL.createObjectURL(blob);
                a.download = "mad-page.html";
                document.body.appendChild(a);
                a.click();
                document.body.removeChild(a);
                URL.revokeObjectURL(a.href);
            }
        }
    }
</script>

</body>
</html>
