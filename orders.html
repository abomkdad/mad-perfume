<!doctype html>
<html lang="ar" dir="rtl">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1,maximum-scale=1,user-scalable=no"/>
  <title>MAD Manager</title>
  <script src="https://cdn.jsdelivr.net/npm/jsbarcode@3.11.5/dist/JsBarcode.all.min.js"></script>
  <style>
    :root{--bg:#0b1220;--card:#111c33;--muted:#9aa7bf;--line:#203152;--ok:#10b981;--warn:#f59e0b;--bad:#ef4444;--blue:#3b82f6;}
    body{margin:0;background:var(--bg);color:#fff;font-family:system-ui,-apple-system,Segoe UI,Tahoma; padding-bottom:90px;}
    header{position:sticky;top:0;background:rgba(17,28,51,.95);backdrop-filter:blur(10px);padding:14px;border-bottom:1px solid var(--line);z-index:9}
    h1{margin:0;font-size:16px}
    .row{display:flex;gap:8px;align-items:center;margin-top:10px}
    input,select,textarea{width:100%;box-sizing:border-box;border:1px solid var(--line);background:#0f172a;color:#fff;border-radius:12px;padding:12px;font-size:14px;outline:none}
    textarea{min-height:72px;resize:vertical}
    .wrap{max-width:520px;margin:0 auto;padding:12px}
    .card{background:var(--card);border:1px solid var(--line);border-radius:18px;padding:12px;margin:12px 0}
    .tag{font-size:11px;color:#fff;background:#1f2e52;border:1px solid var(--line);padding:4px 8px;border-radius:999px}
    .title{display:flex;justify-content:space-between;align-items:center;gap:8px}
    .name{font-weight:900;font-size:16px}
    .mini{color:var(--muted);font-size:12px;margin-top:6px}
    .grid{display:grid;grid-template-columns:1fr 1fr;gap:8px;margin-top:10px}
    .btns{display:grid;grid-template-columns:1fr 1fr;gap:8px;margin-top:10px}
    .btn{border:none;border-radius:14px;padding:14px 10px;font-weight:900;cursor:pointer}
    .bblue{background:var(--blue);color:#fff}
    .bgreen{background:var(--ok);color:#052014}
    .borange{background:var(--warn);color:#2a1700}
    .bred{background:var(--bad);color:#2a0000}
    .bgray{background:#1b2a4b;color:#cfe0ff;border:1px solid var(--line)}
    .sectionTitle{margin:14px 0 8px;color:#cfe0ff;font-weight:900}
    .pill{display:flex;gap:8px;flex-wrap:wrap;margin-top:10px}
    .pill span{background:#0f172a;border:1px solid var(--line);padding:6px 10px;border-radius:999px;font-size:12px;color:#cfe0ff}
    /* modal */
    .modal{position:fixed;inset:0;display:none;align-items:flex-end;justify-content:center;background:rgba(0,0,0,.55);z-index:99}
    .modal.show{display:flex}
    .sheet{width:min(520px,100%);background:#0f172a;border:1px solid var(--line);border-radius:18px 18px 0 0;padding:14px}
    .mhead{display:flex;justify-content:space-between;align-items:center}
    .close{background:#1b2a4b;border:1px solid var(--line);color:#fff;border-radius:12px;padding:10px 12px;cursor:pointer}
    .copyBtn{background:#1b2a4b;border:1px solid var(--line);color:#fff;border-radius:12px;padding:10px 12px;cursor:pointer;font-weight:800}
    .field{background:#0b1220;border:1px solid var(--line);border-radius:14px;padding:10px;margin-top:8px}
    .field b{display:block;font-size:12px;color:#cfe0ff;margin-bottom:6px}
    .field code{display:block;direction:ltr;text-align:left;color:#fff;white-space:pre-wrap;word-break:break-word}
    .barWrap{background:#fff;border-radius:14px;padding:10px;margin-top:10px}
    .barWrap small{display:block;color:#000;margin-top:6px;font-weight:800}
    /* login */
    .lock{position:fixed;inset:0;background:rgba(0,0,0,.75);display:flex;align-items:center;justify-content:center;z-index:9999}
    .lockbox{width:min(420px,92%);background:#0f172a;border:1px solid var(--line);border-radius:18px;padding:16px}
    .lockbox h2{margin:0 0 10px;font-size:16px}
    .lockbox p{margin:0 0 12px;color:var(--muted);font-size:12px}
  </style>
</head>
<body>

<!-- LOGIN -->
<div class="lock" id="lock">
  <div class="lockbox">
    <h2>ğŸ”’ Ø¯Ø®ÙˆÙ„ Ø§Ù„Ù…Ø¯ÙŠØ±</h2>
    <p>ÙƒÙ„Ù…Ø© Ø§Ù„Ø³Ø± Ù…Ø·Ù„ÙˆØ¨Ø© Ù„Ø­Ù…Ø§ÙŠØ© Ø§Ù„Ù†Ø¸Ø§Ù….</p>
    <input id="pw" placeholder="ÙƒÙ„Ù…Ø© Ø§Ù„Ø³Ø±" type="password" />
    <div class="btns">
      <button class="btn bblue" onclick="login()">Ø¯Ø®ÙˆÙ„</button>
      <button class="btn bgray" onclick="document.getElementById('pw').value=''">Ù…Ø³Ø­</button>
    </div>
  </div>
</div>

<header>
  <div class="wrap">
    <div class="title">
      <h1>ğŸ‘‘ MAD Manager</h1>
      <div class="row" style="margin:0">
        <button class="btn bgray" onclick="sync()">âŸ² ØªØ­Ø¯ÙŠØ«</button>
        <button class="btn bred" onclick="logout()">Ø®Ø±ÙˆØ¬</button>
      </div>
    </div>

    <div class="row">
      <input id="q" placeholder="Ø§Ø¨Ø­Ø« Ø§Ø³Ù…/Ù‡Ø§ØªÙ/ÙƒÙˆØ¯/Ø±Ù‚Ù… Ø·Ù„Ø¨..." oninput="render()" />
    </div>

    <div class="pill">
      <span>Ø¬Ø¯ÙŠØ¯: <b id="cNew">0</b></span>
      <span>Ø¨Ø§Ù„ØªØ¬Ù‡ÙŠØ²: <b id="cApp">0</b></span>
      <span>Ø¬Ø§Ù‡Ø²: <b id="cReady">0</b></span>
    </div>
  </div>
</header>

<div class="wrap">
  <div class="sectionTitle">ğŸŸ¡ Ø·Ù„Ø¨Ø§Øª Ø¬Ø¯ÙŠØ¯Ø© (ØºÙŠØ± Ù…Ø¹ØªÙ…Ø¯Ø©)</div>
  <div id="listNew"></div>

  <div class="sectionTitle">ğŸ”µ ØªÙ… Ø¥Ø±Ø³Ø§Ù„Ù‡Ø§ Ù„Ù„ØªØ¬Ù‡ÙŠØ²</div>
  <div id="listApp"></div>

  <div class="sectionTitle">ğŸŸ¢ Ø·Ù„Ø¨Ø§Øª Ø¬Ø§Ù‡Ø²Ø©</div>
  <div id="listReady"></div>

  <div class="sectionTitle">â• Ø¥Ø¶Ø§ÙØ© Ø·Ù„Ø¨ Ø¬Ø¯ÙŠØ¯</div>
  <div class="card">
    <div class="grid">
      <input id="in_name" placeholder="Ø§Ø³Ù… Ø§Ù„Ø²Ø¨ÙˆÙ†" />
      <input id="in_phone" placeholder="Ø§Ù„Ù‡Ø§ØªÙ" />
      <input id="in_city" placeholder="Ø§Ù„Ù…Ø¯ÙŠÙ†Ø©/Ø§Ù„Ø¹Ù†ÙˆØ§Ù†" />
      <input id="in_offer" placeholder="Ø§Ù„Ø·Ù„Ø¨ (Ø£ÙƒÙˆØ§Ø¯)" />
      <input id="in_price" placeholder="Ø§Ù„Ø³Ø¹Ø± â‚ª" value="150" />
      <select id="in_pay">
        <option value="cash">Ù†Ù‚Ø¯Ù‹Ø§</option>
        <option value="paid">Ù…Ø¯ÙÙˆØ¹</option>
      </select>
    </div>
    <textarea id="in_notes" placeholder="Ù…Ù„Ø§Ø­Ø¸Ø§Øª..."></textarea>
    <div class="btns">
      <button class="btn bblue" onclick="addOrder()">âœ… Ø­ÙØ¸ Ø§Ù„Ø·Ù„Ø¨</button>
      <button class="btn bgray" onclick="clearAdd()">ğŸ§¹ Ù…Ø³Ø­</button>
    </div>
  </div>
</div>

<!-- High Express Modal -->
<div class="modal" id="hxModal">
  <div class="sheet">
    <div class="mhead">
      <b>ğŸ“¦ High Express (Ù†Ø³Ø® Ø¬Ø§Ù‡Ø² + Ø¨Ø§Ø±ÙƒÙˆØ¯)</b>
      <button class="close" onclick="closeHX()">Ø¥ØºÙ„Ø§Ù‚ âœ•</button>
    </div>
    <div id="hxBody"></div>
  </div>
</div>

<script>
  // âœ… SETTINGS (everything in place)
  const APP_PASSWORD = "12345678";
  const SCRIPT_URL = "https://script.google.com/macros/s/AKfycbw2QxGHOxMv7_uNbMulwO60IHOcKj16rbBJRfoltkwcdb2Bg4zrVjyMt_lf9KgnyyXl/exec";
  const DRIVE_FOLDER_URL = "https://drive.google.com/drive/folders/1d4GG2rOcXkw8w0LG0wg4XFnFPDJh8Ls3?usp=sharing";

  let orders = [];
  const DELIVERY_OPTIONS = ["", "High Express", "Marwah Delivery", "Lama Delivery", "Areen Delivery"];

  // ===== LOGIN =====
  function login(){
    const v = document.getElementById("pw").value;
    if(v === APP_PASSWORD){
      localStorage.setItem("mad_auth","1");
      document.getElementById("lock").style.display="none";
      sync();
    }else{
      alert("ÙƒÙ„Ù…Ø© Ø§Ù„Ø³Ø± Ø®Ø·Ø£");
    }
  }
  function logout(){
    localStorage.removeItem("mad_auth");
    location.reload();
  }
  (function boot(){
    if(localStorage.getItem("mad_auth")==="1"){
      document.getElementById("lock").style.display="none";
      sync();
    }
  })();

  function isHebrewText(s){ return /[\u0590-\u05FF]/.test(s||""); }
  function isArabicText(s){ return /[\u0600-\u06FF]/.test(s||""); }
  function normStatus(s){ return String(s||"").toLowerCase(); }

  function isCanceled(s){ return /canceled|Ù…Ù„Øº|Ø¥Ù„ØºØ§Ø¡|×‘×•×˜×œ/.test(normStatus(s)); }
  function isDelivered(s){ return /delivered|ØªÙ…\s*Ø§Ù„ØªØ³Ù„ÙŠÙ…|× ××¡×¨/.test(normStatus(s)); }
  function isReady(s){ return /××•×›×Ÿ|ready|Ø¬Ø§Ù‡Ø²/.test(normStatus(s)); }
  function isApproved(s){
    const t = normStatus(s);
    return /approved|×××•×©×¨|Ø§Ø¹ØªÙ…Ø§Ø¯|ØªÙ…\s*Ø§Ø±Ø³Ø§Ù„\s*Ù‡Ø°Ø§\s*Ø§Ù„Ø·Ù„Ø¨\s*Ù„Ù„ØªØ¬Ù‡ÙŠØ²|Ù‚ÙŠØ¯\s*Ø§Ù„ØªØ¬Ù‡ÙŠØ²/.test(t);
  }
  function isNewOrder(s){
    const t = normStatus(s).trim();
    if(!t) return true;
    return /new|processing|Ù‚ÙŠØ¯ Ø§Ù„Ù…Ø¹Ø§Ù„Ø¬Ø©|×—×“×©/.test(t) && !isApproved(t) && !isReady(t) && !isDelivered(t);
  }

  function extractPrice(offer, notes){
    const t = (offer||"") + " " + (notes||"");
    let m = t.match(/â‚ª\s*([0-9]{2,6})/); if(m) return m[1];
    m = t.match(/=\s*â‚ª\s*([0-9]{2,6})/); if(m) return m[1];
    m = t.match(/Price:\s*([0-9]{2,6})/i); if(m) return m[1];
    return "150";
  }
  function offerNoPrice(offer){
    return String(offer||"").replace(/\s*=\s*â‚ª?\s*\d{2,6}\s*$/,"").trim();
  }
  function toWaPhone(p){
    const d = String(p||"").replace(/\D/g,"");
    if(d.startsWith("0") && d.length>=9) return ("972"+d.slice(1));
    return d;
  }
  function toLocalIL(phone){
    const p = String(phone||"").replace(/\D/g,"");
    if(p.startsWith("972") && p.length===12) return "0"+p.slice(3);
    if(p.startsWith("970") && p.length===12) return "0"+p.slice(3);
    return phone||"";
  }

  async function sync(){
    try{
      const r = await fetch(`${SCRIPT_URL}?action=get&t=${Date.now()}`);
      const d = await r.json();
      orders = Array.isArray(d)? d : [];
      render();
    }catch(e){ console.log(e); }
  }

  function esc(s){ return String(s||"").replace(/&/g,"&amp;").replace(/</g,"&lt;").replace(/>/g,"&gt;").replace(/"/g,"&quot;"); }

  function render(){
    const q = (document.getElementById("q").value||"").toLowerCase();
    const data = [...orders].reverse().filter(o=>{
      const s = `${o.name||""} ${o.phone||""} ${o.offer||""} ${o.orderId||""} ${o.notes||""}`.toLowerCase();
      return s.includes(q);
    });

    const newList = data.filter(o=>{
      const s = o.status||"";
      return isNewOrder(s) && !isCanceled(s);
    });
    const appList = data.filter(o=>{
      const s = o.status||"";
      return isApproved(s) && !isReady(s) && !isDelivered(s) && !isCanceled(s);
    });
    const readyList = data.filter(o=>{
      const s = o.status||"";
      return isReady(s) && !isDelivered(s) && !isCanceled(s);
    });

    document.getElementById("cNew").innerText = newList.length;
    document.getElementById("cApp").innerText = appList.length;
    document.getElementById("cReady").innerText = readyList.length;

    document.getElementById("listNew").innerHTML = newList.map(card).join("");
    document.getElementById("listApp").innerHTML = appList.map(card).join("");
    document.getElementById("listReady").innerHTML = readyList.map(card).join("");
  }

  function getDeliveryFromStatus(status){
    const s = String(status||"");
    const m = s.match(/\(××©×œ×•×—:\s*([^)]+)\)/);
    return m ? m[1].trim() : "";
  }

  function card(o){
    const row = o.rowIndex;
    const price = extractPrice(o.offer, o.notes);
    const offerPure = offerNoPrice(o.offer);
    const tracking = (String(o.notes||"").match(/Tracking:\s*([^|]+)/i)||[])[1]?.trim() || "";

    return `
      <div class="card">
        <div class="title">
          <div>
            <div class="name">${esc(o.name||"")}</div>
            <div class="mini">ğŸ“ ${esc(o.phone||"-")} â€¢ ğŸ§¾ ${esc(o.orderId||"")}</div>
          </div>
          <span class="tag">${esc(o.status||"New")}</span>
        </div>

        <div class="grid">
          <input id="name_${row}" value="${esc(o.name||"")}" placeholder="Ø§Ù„Ø§Ø³Ù…" />
          <input id="phone_${row}" value="${esc(o.phone||"")}" placeholder="Ø§Ù„Ù‡Ø§ØªÙ" />
          <input id="city_${row}" value="${esc(o.city||"")}" placeholder="Ø§Ù„Ù…Ø¯ÙŠÙ†Ø©/Ø§Ù„Ø¹Ù†ÙˆØ§Ù†" />
          <input id="offer_${row}" value="${esc(offerPure)}" placeholder="Ø§Ù„Ø·Ù„Ø¨ (Ø£ÙƒÙˆØ§Ø¯)" />
          <input id="price_${row}" value="${esc(price)}" placeholder="Ø§Ù„Ø³Ø¹Ø± â‚ª" />
          <select id="del_${row}">
            ${DELIVERY_OPTIONS.map(x=>`<option value="${esc(x)}" ${String(getDeliveryFromStatus(o.status))===x?"selected":""}>${x===""?"-- Ø´Ø±ÙƒØ© Ø§Ù„ØªÙˆØµÙŠÙ„ --":x}</option>`).join("")}
          </select>
        </div>

        <div class="grid">
          <input id="tracking_${row}" value="${esc(tracking)}" placeholder="Tracking (Ø§Ø®ØªÙŠØ§Ø±ÙŠ)" />
          <button class="btn bgray" onclick="window.open('${DRIVE_FOLDER_URL}','_blank')">ğŸ“ Ù…Ù„ÙØ§Øª (Drive)</button>
        </div>

        <textarea id="notes_${row}" placeholder="Ù…Ù„Ø§Ø­Ø¸Ø§Øª...">${esc(o.notes||"")}</textarea>

        <div class="btns">
          <button class="btn bblue" onclick="saveOrder(${row},'${esc(o.orderId||"")}')">ğŸ’¾ Ø­ÙØ¸ Ø§Ù„ØªØ¹Ø¯ÙŠÙ„</button>
          <button class="btn bgreen" onclick="sendToPrep(${row},'${esc(o.orderId||"")}')">âœ… Ø¥Ø±Ø³Ø§Ù„ Ù„Ù„ØªØ¬Ù‡ÙŠØ²</button>
        </div>

        <div class="btns">
          <button class="btn borange" onclick="confirmCustomer(${row},'${esc(o.orderId||"")}')">ğŸ“© ØªØ£ÙƒÙŠØ¯ Ù„Ù„Ø¹Ù…ÙŠÙ„</button>
          <button class="btn bred" onclick="setStatus(${row},'${esc(o.orderId||"")}','Canceled âŒ')">âŒ Ø¥Ù„ØºØ§Ø¡</button>
        </div>

        <div class="btns">
          <button class="btn bgray" onclick="openHighExpress(${row},'${esc(o.orderId||"")}')">ğŸ“¦ High Express (Ù†Ø³Ø® + Ø¨Ø§Ø±ÙƒÙˆØ¯)</button>
          <button class="btn bgray" onclick="setStatus(${row},'${esc(o.orderId||"")}','Delivered âœ…')">âœ… ØªØ³Ù„ÙŠÙ… Ù„Ù„Ù…Ù†Ø¯ÙˆØ¨</button>
        </div>
      </div>
    `;
  }

  async function saveOrder(row, orderId){
    const name = document.getElementById(`name_${row}`).value.trim();
    const phone = document.getElementById(`phone_${row}`).value.trim();
    const city = document.getElementById(`city_${row}`).value.trim();
    const offer = document.getElementById(`offer_${row}`).value.trim();
    const price = document.getElementById(`price_${row}`).value.trim();
    const notes = document.getElementById(`notes_${row}`).value.trim();
    const tracking = document.getElementById(`tracking_${row}`).value.trim();

    const qs = new URLSearchParams({
      action:"updateOrder",
      row:String(row),
      orderId:orderId,
      name, phone, city,
      offer, price,
      notes, tracking
    });

    await fetch(`${SCRIPT_URL}?${qs.toString()}`);
    await sync();
  }

  async function setStatus(row, orderId, status){
    const qs = new URLSearchParams({action:"updateStatus", row:String(row), orderId:orderId, status:status});
    await fetch(`${SCRIPT_URL}?${qs.toString()}`);
    await sync();
  }

  async function sendToPrep(row, orderId){
    const del = document.getElementById(`del_${row}`).value || "";
    if(!del) return alert("Ø§Ø®ØªØ§Ø± Ø´Ø±ÙƒØ© Ø§Ù„ØªÙˆØµÙŠÙ„ Ø£ÙˆÙ„Ø§Ù‹");
    const status = `Approved âœ… (××©×œ×•×—: ${del}) - ØªÙ… Ø§Ø±Ø³Ø§Ù„ Ù‡Ø°Ø§ Ø§Ù„Ø·Ù„Ø¨ Ù„Ù„ØªØ¬Ù‡ÙŠØ²`;
    await setStatus(row, orderId, status);
  }

  function confirmCustomer(row, orderId){
    const name = document.getElementById(`name_${row}`).value.trim();
    const phone = document.getElementById(`phone_${row}`).value.trim();
    const city = document.getElementById(`city_${row}`).value.trim();
    const offer = document.getElementById(`offer_${row}`).value.trim();
    const price = document.getElementById(`price_${row}`).value.trim() || "150";

    const he = isHebrewText(name) || /\bhe\b/i.test(offer);

    let msg = `*MAD Parfumeur* ğŸ–¤\nÙ…Ø±Ø­Ø¨Ø§Ù‹ *${name}*ØŒ\nØªÙ… ØªØ£ÙƒÙŠØ¯ Ø·Ù„Ø¨Ùƒ Ø±Ù‚Ù… *${orderId}*.\nğŸ“¦ Ø§Ù„Ù…Ù†ØªØ¬: ${offer}\nğŸ’° Ø§Ù„Ø¥Ø¬Ù…Ø§Ù„ÙŠ: â‚ª${price}\nğŸ“ Ø§Ù„Ø¹Ù†ÙˆØ§Ù†: ${city}\nØ³Ù†Ù‚ÙˆÙ… Ø¨Ø§Ù„ØªØ¬Ù‡ÙŠØ² ÙˆØ§Ù„Ø´Ø­Ù† Ù‚Ø±ÙŠØ¨Ø§Ù‹.\nØ®Ø¯Ù…Ø© Ø§Ù„Ø¹Ù…Ù„Ø§Ø¡: *9935*`;
    if(he){
      msg = `*MAD Parfumeur* ğŸ–¤\n×©×œ×•× *${name}*,\n×”×–×× ×ª×š ××•×©×¨×”. ××¡×¤×¨ ×”×–×× ×”: *${orderId}*\nğŸ“¦ ××•×¦×¨: ${offer}\nğŸ’° ×¡×”\"×›: â‚ª${price}\nğŸ“ ×›×ª×•×‘×ª: ${city}\n× ×¢×“×›×Ÿ ×‘×¨×’×¢ ×©×”××©×œ×•×— ×™×•×¦×.\n×©×™×¨×•×ª ×œ×§×•×—×•×ª: *9935*`;
    }

    const wa = toWaPhone(phone);
    window.open(`https://wa.me/${wa}?text=${encodeURIComponent(msg)}`,'_blank');
  }

  async function addOrder(){
    const name = document.getElementById("in_name").value.trim();
    const phone = document.getElementById("in_phone").value.trim();
    const city = document.getElementById("in_city").value.trim();
    const offer = document.getElementById("in_offer").value.trim();
    const price = document.getElementById("in_price").value.trim() || "150";
    const pay = document.getElementById("in_pay").value;
    const notes = document.getElementById("in_notes").value.trim();

    if(!name || !phone || !offer) return alert("Ø§Ù…Ù„Ø£ Ø§Ù„Ø§Ø³Ù… + Ø§Ù„Ù‡Ø§ØªÙ + Ø§Ù„Ø·Ù„Ø¨");

    const payload = {
      name, phone, address: city,
      offer, price,
      payment: pay,
      process: "Direct",
      notes,
      status: "New",
      source: "Manager"
    };

    await fetch(SCRIPT_URL, {method:"POST", mode:"no-cors", body: JSON.stringify(payload)});
    clearAdd();
    await sync();
  }

  function clearAdd(){
    ["in_name","in_phone","in_city","in_offer","in_notes"].forEach(id=>document.getElementById(id).value="");
    document.getElementById("in_price").value="150";
  }

  // ===== High Express modal =====
  function openHighExpress(row, orderId){
    const name = document.getElementById(`name_${row}`).value.trim();
    const phone = document.getElementById(`phone_${row}`).value.trim();
    const city = document.getElementById(`city_${row}`).value.trim();
    const offer = document.getElementById(`offer_${row}`).value.trim();
    const price = document.getElementById(`price_${row}`).value.trim() || "150";
    const notes = document.getElementById(`notes_${row}`).value.trim();

    const localPhone = toLocalIL(toWaPhone(phone));
    const reference = orderId || localPhone;

    const packContent = offer;
    const note = `MAD Order: ${reference} | ${notes}`.trim();

    const body = `
      ${hxField("Ø±Ù‚Ù… Ø§Ù„Ù…Ø³ØªÙ„Ù…", localPhone, true)}
      ${hxField("Ø§Ø³Ù… Ø§Ù„Ù…Ø³ØªÙ„Ù…", name, true)}
      ${hxField("Ø¹Ù†ÙˆØ§Ù† ØªÙØµÙŠÙ„ÙŠ", city, true)}
      ${hxField("Ø§Ù„Ø±Ù‚Ù… Ø§Ù„Ù…Ø±Ø¬Ø¹ÙŠ (Ø§Ù…Ø³Ø­ Ø¨Ø§Ø±ÙƒÙˆØ¯)", reference, true)}
      ${hxField("Ø§Ù„Ù…Ø¨Ù„Øº Ø´Ø§Ù…Ù„ Ø§Ù„ØªÙˆØµÙŠÙ„", price, true)}
      ${hxField("Ù…Ø­ØªÙˆÙ‰ Ø§Ù„Ø·Ø±Ø¯", packContent, true)}
      ${hxField("Ù…Ù„Ø§Ø­Ø¸Ø©", note, true)}

      <div class="barWrap">
        <svg id="hx_bar"></svg>
        <small>Ø§Ù…Ø³Ø­ Ø§Ù„Ø¨Ø§Ø±ÙƒÙˆØ¯ Ø¯Ø§Ø®Ù„ High Express (Ø§Ù„Ø±Ù‚Ù… Ø§Ù„Ù…Ø±Ø¬Ø¹ÙŠ)</small>
      </div>

      <div class="btns" style="margin-top:10px">
        <button class="btn bblue" onclick="copyAllHX()">ğŸ“‹ Ù†Ø³Ø® Ø§Ù„ÙƒÙ„ Ù…Ø±Ø© ÙˆØ§Ø­Ø¯Ø©</button>
        <button class="btn bgray" onclick="closeHX()">Ø¥ØºÙ„Ø§Ù‚</button>
      </div>
    `;

    document.getElementById("hxBody").innerHTML = body;
    document.getElementById("hxModal").classList.add("show");

    setTimeout(()=>{
      try{ JsBarcode("#hx_bar", reference, {format:"CODE128", width:2.2, height:70, displayValue:true, fontSize:16}); }catch(e){}
    }, 50);

    window.__HX_ALL__ = [
      `Ø±Ù‚Ù… Ø§Ù„Ù…Ø³ØªÙ„Ù…: ${localPhone}`,
      `Ø§Ø³Ù… Ø§Ù„Ù…Ø³ØªÙ„Ù…: ${name}`,
      `Ø¹Ù†ÙˆØ§Ù† ØªÙØµÙŠÙ„ÙŠ: ${city}`,
      `Ø§Ù„Ø±Ù‚Ù… Ø§Ù„Ù…Ø±Ø¬Ø¹ÙŠ: ${reference}`,
      `Ø§Ù„Ù…Ø¨Ù„Øº Ø´Ø§Ù…Ù„ Ø§Ù„ØªÙˆØµÙŠÙ„: ${price}`,
      `Ù…Ø­ØªÙˆÙ‰ Ø§Ù„Ø·Ø±Ø¯: ${packContent}`,
      `Ù…Ù„Ø§Ø­Ø¸Ø©: ${note}`
    ].join("\n");
  }

  function hxField(label, value, canCopy){
    const v = String(value||"-");
    return `
      <div class="field">
        <b>${label}</b>
        <code>${esc(v)}</code>
        ${canCopy ? `<div class="row"><button class="copyBtn" onclick="copyText('${esc(v)}')">Ù†Ø³Ø®</button></div>` : ``}
      </div>
    `;
  }

  function closeHX(){ document.getElementById("hxModal").classList.remove("show"); }

  async function copyText(t){
    const text = decodeHtml(t);
    try{ await navigator.clipboard.writeText(text); alert("âœ… ØªÙ… Ø§Ù„Ù†Ø³Ø®"); }
    catch(e){ fallbackCopy(text); }
  }

  async function copyAllHX(){
    const text = window.__HX_ALL__ || "";
    try{ await navigator.clipboard.writeText(text); alert("âœ… ØªÙ… Ù†Ø³Ø® ÙƒÙ„ Ø¨ÙŠØ§Ù†Ø§Øª High Express"); }
    catch(e){ fallbackCopy(text); }
  }

  function fallbackCopy(text){
    const ta = document.createElement("textarea");
    ta.value = text; document.body.appendChild(ta);
    ta.select(); document.execCommand("copy");
    document.body.removeChild(ta);
    alert("âœ… ØªÙ… Ø§Ù„Ù†Ø³Ø®");
  }

  function decodeHtml(s){
    return String(s||"")
      .replace(/&quot;/g,'"')
      .replace(/&lt;/g,"<")
      .replace(/&gt;/g,">")
      .replace(/&amp;/g,"&");
  }

  // auto refresh
  setInterval(sync, 25000);
</script>
</body>
</html>
