<!doctype html>
<html lang="ar" dir="rtl">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width,initial-scale=1"/>
  <title>MAD Manager | Ø§Ù„Ø¥ØµØ¯Ø§Ø± Ø§Ù„Ù…Ø·ÙˆØ±</title>

  <script src="https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf.min.js"></script>

  <style>
    :root{
      --bg:#060914;
      --card1:rgba(255,255,255,.10);
      --card2:rgba(255,255,255,.06);
      --border:rgba(255,255,255,.12);
      --muted:rgba(255,255,255,.72);
      --green:#16a34a;
      --blue:#2563eb;
      --orange:#f59e0b;
      --red:#dc2626;
      --gray:rgba(255,255,255,.12);
      --pink:#db2777;
      --cyan:#06b6d4;
      --violet:#7c3aed;
    }
    body{margin:0;font-family:system-ui,Segoe UI,Tahoma,Arial;background:var(--bg);color:#fff}
    
    /* ØªØ­Ø³ÙŠÙ†Ø§Øª Ø§Ù„Ø·Ø¨Ø§Ø¹Ø© */
    @media print {
      .top, .actions, .subactions, button, select, #q, .tabs, .modal-ignore { display: none !important; }
      body { background: white; color: black; }
      .card { border: 2px solid #000; page-break-inside: avoid; margin: 10px; box-shadow: none; background: #fff; color: #000; }
      .field { border: 1px solid #ccc; background: #f9f9f9 !important; color: #000; }
      .label { color: #333; }
      input { color: #000 !important; background: transparent !important; border: none !important; }
    }

    .top{ position:sticky;top:0;z-index:50; background:rgba(6,9,20,.92);backdrop-filter:blur(10px); border-bottom:1px solid var(--border); padding:14px; }
    .wrap{max-width:1200px;margin:0 auto;padding:16px}
    .row{display:flex;gap:10px;flex-wrap:wrap;align-items:center}
    .title{font-weight:1000;font-size:18px}
    .tag{ padding:7px 11px;border-radius:999px; background:rgba(255,255,255,.10); border:1px solid rgba(255,255,255,.10); font-weight:1000; }
    input,select,textarea{ font:inherit;border-radius:14px;border:1px solid var(--border); background:rgba(255,255,255,.06);color:#fff;padding:12px 12px;outline:none; width: 100%; box-sizing: border-box; }
    .btn{padding:12px 14px;border-radius:14px;font-weight:1100; border:none; cursor:pointer; color:#fff; display:inline-block; text-align:center;}
    .bgray{background:var(--gray)} .bgreen{background:var(--green)} .bblue{background:var(--blue)}
    .borange{background:var(--orange);color:#111} .bred{background:var(--red)} .bviolet{background:var(--violet)}
    .tabs{display:flex;gap:10px;margin-top:10px}
    .tab{ padding:10px 12px;border-radius:999px; border:1px solid rgba(255,255,255,.14); background:rgba(255,255,255,.08); font-weight:1000; cursor:pointer; }
    .tab.active{background:rgba(37,99,235,.30);border-color:rgba(37,99,235,.65)}
    .card{ background:linear-gradient(180deg,var(--card1),var(--card2)); border:1px solid var(--border); border-radius:20px; padding:16px; margin:14px 0; box-shadow:0 14px 50px rgba(0,0,0,.35); }
    .grid{display:grid;grid-template-columns:1fr 1fr;gap:10px;margin-top:12px}
    @media(max-width:820px){.grid{grid-template-columns:1fr}}
    .field{ background:rgba(255,255,255,.06); border:1px solid rgba(255,255,255,.12); border-radius:16px; padding:10px; }
    .label{opacity:.85;font-weight:1000;margin-bottom:6px; font-size:13px}
    .actions{display:grid;grid-template-columns:1fr 1fr;gap:10px;margin-top:14px}
    .hugeBtn{padding:18px 16px;border-radius:18px;font-size:18px;font-weight:1200}
    .modal{position:fixed;inset:0;background:rgba(0,0,0,.8);display:none;align-items:center;justify-content:center;z-index:999}
    .modal.show{display:flex}
    .modal .box{width:min(900px,95vw);max-height:90vh;overflow:auto;background:#0f172a;border-radius:24px;padding:20px;border:1px solid var(--border)}
  </style>
</head>
<body>

<script>
const SCRIPT_URL = "https://script.google.com/macros/s/AKfycbyLjLFa8AaH82Ip7m747WC-KSUUEaU_M70S0I9Mda14XbnmcuEfZ7pBnF_zzJYZuXmZ/exec";
const DASH_KEY   = "12345678"; 

pdfjsLib.GlobalWorkerOptions.workerSrc = "https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf.worker.min.js";
</script>

<div class="top">
  <div class="wrap">
    <div class="row">
      <div class="title">MAD Manager âœ…</div>
      <span class="tag" id="stat">ØªØ­Ù…ÙŠÙ„...</span>
      <button class="btn bgray" onclick="load()">ØªØ­Ø¯ÙŠØ« â†»</button>
      <button class="btn bviolet" onclick="openSmartNew()">â• Ø¥Ø¶Ø§ÙØ© Ø·Ù„Ø¨ Ø°ÙƒÙŠ</button>
      <input id="q" placeholder="Ø¨Ø­Ø« Ø¨Ø§Ø³Ù…ØŒ Ø±Ù‚Ù…ØŒ Ù…Ø¯ÙŠÙ†Ø©..." style="flex:1" oninput="render()"/>
      <select id="filter" style="width:auto" onchange="render()">
        <option value="NEW">Ø·Ù„Ø¨Ø§Øª Ø¬Ø¯ÙŠØ¯Ø©</option>
        <option value="PREP">Ù‚ÙŠØ¯ Ø§Ù„ØªØ¬Ù‡ÙŠØ²</option>
        <option value="READY">Ø¬Ø§Ù‡Ø²Ø©</option>
        <option value="ALL">Ø§Ù„ÙƒÙ„</option>
      </select>
    </div>
  </div>
</div>

<div class="wrap">
  <div id="quickView"></div>
</div>

<div class="modal" id="modal">
  <div class="box">
    <div class="row" style="justify-content:space-between; margin-bottom:15px">
      <div class="title" id="modalTitle"></div>
      <button class="btn bgray" onclick="closeModal()">Ø¥ØºÙ„Ø§Ù‚ âœ–</button>
    </div>
    <div id="modalBody"></div>
  </div>
</div>

<script>
let orders = [];

async function load(){
  try {
    const res = await fetch(`${SCRIPT_URL}?action=get&_=${Date.now()}`);
    orders = await res.json();
    document.getElementById("stat").textContent = `Ø·Ù„Ø¨Ø§Øª: ${orders.length}`;
    render();
  } catch(e) { document.getElementById("stat").textContent = "Ø®Ø·Ø£ Ø§ØªØµØ§Ù„"; }
}

function smartParse(txt){
  // ØªÙ†Ø¸ÙŠÙ Ø§Ù„Ù†Øµ ÙˆØªØ¬Ø§ÙˆØ² Ø§Ù„Ø±Ù…ÙˆØ² ÙÙŠ Ø£Ø±Ù‚Ø§Ù… Ø§Ù„Ù‡ÙˆØ§ØªÙ
  const cleanTxt = txt.replace(/\u200f|\u200e/g,"").replace(/[-()]/g,"");
  
  // 1. Ø§Ø³ØªØ®Ø±Ø§Ø¬ Ø§Ù„Ù‡Ø§ØªÙ (ØªØ¬Ø§ÙˆØ² Ø§Ù„Ø®Ø·ÙˆØ· ÙˆØ§Ù„Ø±Ù…ÙˆØ²)
  const phoneMatch = cleanTxt.match(/(\+?972\d{9}|05\d{8}|0?59\d{7,8})/);
  let phone = phoneMatch ? phoneMatch[1].replace(/\D/g,'') : "";

  // 2. Ø§Ø³ØªØ®Ø±Ø§Ø¬ Ø§Ù„Ø³Ø¹Ø±
  let price = "";
  const priceMatch = cleanTxt.match(/(\d{2,4})\s*(â‚ª|Ø´ÙŠÙƒÙ„|NIS|ILS)/i) || cleanTxt.match(/(â‚ª|Ø´ÙŠÙƒÙ„)\s*(\d{2,4})/);
  price = priceMatch ? (priceMatch[1].match(/\d/) ? priceMatch[1] : priceMatch[2]) : "";

  // 3. Ø·Ø±ÙŠÙ‚Ø© Ø§Ù„Ø¯ÙØ¹ (Ø¯Ø§Ø¦Ù…Ø§Ù‹ Ø¹Ø±Ø¨ÙŠ)
  let payment = "Cash"; 
  if(/Ù…Ø¯ÙÙˆØ¹|Ø±Ø§Ø¨Ø·|paid|×§×™×©×•×¨|××©×¨××™/i.test(cleanTxt)) payment = "Paid";
  
  // 4. Ø§Ø³ØªØ®Ø±Ø§Ø¬ Ø§Ø³Ù… Ø§Ù„Ø¨Ù„Ø¯ (Ø£ÙˆÙ„ ÙƒÙ„Ù…Ø© Ø¨Ø¹Ø¯ "Ø§Ù„Ø¹Ù†ÙˆØ§Ù†" Ø£Ùˆ "Ù…Ø¯ÙŠÙ†Ø©")
  let country = "Ø¥Ø³Ø±Ø§Ø¦ÙŠÙ„"; // Ø§ÙØªØ±Ø§Ø¶ÙŠ
  if(/Ø¶ÙØ©|palestine|westbank|Ø±Ø§Ù… Ø§Ù„Ù„Ù‡|Ù†Ø§Ø¨Ù„Ø³/i.test(cleanTxt)) country = "ÙÙ„Ø³Ø·ÙŠÙ†";

  // 5. Ø§Ø³ØªØ®Ø±Ø§Ø¬ Ø§Ù„Ø£ÙƒÙˆØ§Ø¯ (C-Codes)
  const codes = cleanTxt.match(/[A-Za-z]{1,2}\d{2,3}/g);
  let offer = codes ? codes.join(" ") : "";

  return { 
    name: cleanTxt.split("\n")[0].substring(0,20), 
    phone, 
    offer, 
    price, 
    payment: payment === "Paid" ? "Ù…Ø¯ÙÙˆØ¹" : "Ù†Ù‚Ø¯Ø§Ù‹", 
    country,
    addr: cleanTxt.match(/(?:Ø§Ù„Ø¹Ù†ÙˆØ§Ù†|address|×›×ª×•×‘×ª)[:\s]+([^\n|]+)/i)?.[1]?.trim() || ""
  };
}

function render(){
  const q = document.getElementById("q").value.toLowerCase();
  const f = document.getElementById("filter").value;
  const container = document.getElementById("quickView");
  
  let filtered = orders.filter(o => {
    const matchQ = JSON.stringify(o).toLowerCase().includes(q);
    const st = (o.status || "").toUpperCase();
    if(f === "NEW") return matchQ && (st.includes("NEW") || st === "");
    if(f === "PREP") return matchQ && st.includes("PREP");
    if(f === "READY") return matchQ && st.includes("READY");
    return matchQ;
  });

  container.innerHTML = filtered.reverse().map(o => `
    <div class="card">
      <div class="row" style="justify-content:space-between">
        <div class="title">ğŸ“¦ Ø·Ù„Ø¨ #${o.orderId || o.rowIndex}</div>
        <div class="tag">${o.status || "Ø¬Ø¯ÙŠØ¯"}</div>
      </div>
      <div class="grid">
        <div class="field"><div class="label">Ø§Ù„Ø§Ø³Ù…</div><input id="n_${o.rowIndex}" value="${o.name||''}"></div>
        <div class="field"><div class="label">Ø§Ù„Ù‡Ø§ØªÙ</div><input id="p_${o.rowIndex}" value="${o.phone||''}"></div>
        <div class="field"><div class="label">Ø§Ù„Ø·Ù„Ø¨</div><input id="o_${o.rowIndex}" value="${o.offer||''}"></div>
        <div class="field"><div class="label">Ø§Ù„Ø³Ø¹Ø±</div><input id="pr_${o.rowIndex}" value="${o.price||''}"></div>
        <div class="field">
            <div class="label">Ø§Ù„Ø¯ÙØ¹</div>
            <select id="pay_${o.rowIndex}">
                <option value="Ù†Ù‚Ø¯Ø§Ù‹" ${o.payment === 'Ù†Ù‚Ø¯Ø§Ù‹'?'selected':''}>Ù†Ù‚Ø¯Ø§Ù‹ / ××–×•××Ÿ</option>
                <option value="Ù…Ø¯ÙÙˆØ¹" ${o.payment === 'Ù…Ø¯ÙÙˆØ¹'?'selected':''}>Ù…Ø¯ÙÙˆØ¹ / ×©×•×œ×</option>
            </select>
        </div>
        <div class="field"><div class="label">Ø§Ù„Ø¹Ù†ÙˆØ§Ù†</div><input id="ad_${o.rowIndex}" value="${o.addr||o.city||''}"></div>
      </div>
      <div class="actions">
        <button class="btn bgreen" onclick="saveOrder(${o.rowIndex})">ğŸ’¾ Ø­ÙØ¸ Ø§Ù„ØªØ¹Ø¯ÙŠÙ„Ø§Øª</button>
        <button class="btn bblue" onclick="window.print()">ğŸ–¨ï¸ Ø·Ø¨Ø§Ø¹Ø© Ø§Ù„ÙØ§ØªÙˆØ±Ø©</button>
      </div>
    </div>
  `).join("");
}

async function saveOrder(row){
  const data = {
    action: "updateOrder",
    key: DASH_KEY,
    row: row,
    name: document.getElementById(`n_${row}`).value,
    phone: document.getElementById(`p_${row}`).value,
    offer: document.getElementById(`o_${row}`).value,
    price: document.getElementById(`pr_${row}`).value,
    payment: document.getElementById(`pay_${row}`).value,
    addr: document.getElementById(`ad_${row}`).value
  };
  
  const url = `${SCRIPT_URL}?` + new URLSearchParams(data).toString();
  await fetch(url);
  alert("ØªÙ… Ø§Ù„Ø­ÙØ¸ Ø¨Ù†Ø¬Ø§Ø­ âœ…");
  load();
}

function openSmartNew(){
  document.getElementById("modalTitle").textContent = "Ø¥Ø¶Ø§ÙØ© Ø·Ù„Ø¨ Ø¬Ø¯ÙŠØ¯ (ØªØ­Ù„ÙŠÙ„ Ø°ÙƒÙŠ)";
  document.getElementById("modalBody").innerHTML = `
    <textarea id="rawInput" style="height:150px" placeholder="Ø§Ù„ØµÙ‚ Ù†Øµ ÙˆØ§ØªØ³Ø§Ø¨ Ù‡Ù†Ø§..."></textarea>
    <button class="btn bviolet" style="width:100%;margin-top:10px" onclick="analyzeNew()">ğŸ§  ØªØ­Ù„ÙŠÙ„ Ø§Ù„Ù†Øµ Ø§Ù„Ø¢Ù†</button>
    <div id="parsedResult"></div>
  `;
  document.getElementById("modal").classList.add("show");
}

function analyzeNew(){
  const raw = document.getElementById("rawInput").value;
  const p = smartParse(raw);
  document.getElementById("parsedResult").innerHTML = `
    <div class="grid" style="margin-top:15px">
        <div class="field"><div class="label">Ø§Ù„Ø§Ø³Ù…</div><input id="new_name" value="${p.name}"></div>
        <div class="field"><div class="label">Ø§Ù„Ù‡Ø§ØªÙ</div><input id="new_phone" value="${p.phone}"></div>
        <div class="field"><div class="label">Ø§Ù„Ø·Ù„Ø¨</div><input id="new_offer" value="${p.offer}"></div>
        <div class="field"><div class="label">Ø§Ù„Ø³Ø¹Ø±</div><input id="new_price" value="${p.price}"></div>
        <div class="field"><div class="label">Ø§Ù„Ø¯ÙØ¹</div><input id="new_pay" value="${p.payment}"></div>
        <div class="field"><div class="label">Ø§Ù„Ø¨Ù„Ø¯</div><input id="new_country" value="${p.country}"></div>
    </div>
    <button class="btn bgreen" style="width:100%;margin-top:15px;padding:20px" onclick="submitNew()">âœ… ØªØ£ÙƒÙŠØ¯ ÙˆØ­ÙØ¸ Ø§Ù„Ø·Ù„Ø¨ ÙÙŠ Ø§Ù„Ø´ÙŠØª</button>
  `;
}

async function submitNew(){
    // ÙƒÙˆØ¯ Ø§Ù„Ø¥Ø±Ø³Ø§Ù„ Ù„Ù„Ø³ÙŠØ±ÙØ± (POST)
    const body = {
        name: document.getElementById("new_name").value,
        phone: document.getElementById("new_phone").value,
        offer: document.getElementById("new_offer").value,
        price: document.getElementById("new_price").value,
        payment: document.getElementById("new_pay").value,
        address: document.getElementById("new_country").value,
        status: "Approved âœ…"
    };
    
    await fetch(SCRIPT_URL, {
        method: "POST",
        body: JSON.stringify(body)
    });
    alert("ØªÙ…Øª Ø§Ù„Ø¥Ø¶Ø§ÙØ© Ø¨Ù†Ø¬Ø§Ø­!");
    closeModal();
    load();
}

function closeModal(){ document.getElementById("modal").classList.remove("show"); }

load(); // ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ø¹Ù†Ø¯ Ø§Ù„ÙØªØ­
</script>

</body>
</html>
