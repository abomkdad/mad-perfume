<!doctype html>
<html lang="ar" dir="rtl">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width,initial-scale=1"/>
  <title>MAD Manager</title>

  <!-- PDF.js -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf.min.js"></script>

  <style>
    :root{
      --bg:#060914;
      --card1:rgba(255,255,255,.10);
      --card2:rgba(255,255,255,.06);
      --border:rgba(255,255,255,.12);
      --muted:rgba(255,255,255,.72);
      --green:#16a34a;
      --blue:#2563eb;
      --orange:#f59e0b;
      --red:#dc2626;
      --gray:rgba(255,255,255,.12);
      --pink:#db2777;
      --cyan:#06b6d4;
      --violet:#7c3aed;
    }
    body{margin:0;font-family:system-ui,Segoe UI,Tahoma,Arial;background:var(--bg);color:#fff}
    .top{
      position:sticky;top:0;z-index:50;
      background:rgba(6,9,20,.92);backdrop-filter:blur(10px);
      border-bottom:1px solid var(--border);
      padding:14px;
    }
    .wrap{max-width:1200px;margin:0 auto;padding:16px}
    .row{display:flex;gap:10px;flex-wrap:wrap;align-items:center}
    .title{font-weight:1000;font-size:18px}
    .tag{
      padding:7px 11px;border-radius:999px;
      background:rgba(255,255,255,.10);
      border:1px solid rgba(255,255,255,.10);
      font-weight:1000;
    }
    input,select,textarea{
      font:inherit;border-radius:14px;border:1px solid var(--border);
      background:rgba(255,255,255,.06);color:#fff;padding:12px 12px;outline:none
    }
    select{appearance:none}
    textarea{min-height:110px;resize:vertical}
    button{font:inherit;border:none;cursor:pointer}
    .btn{padding:12px 14px;border-radius:14px;font-weight:1100}
    .bgray{background:var(--gray)}
    .bgreen{background:var(--green)}
    .bblue{background:var(--blue)}
    .borange{background:var(--orange);color:#111}
    .bred{background:var(--red)}
    .bpink{background:var(--pink)}
    .bcyan{background:var(--cyan);color:#001018}
    .bviolet{background:var(--violet)}
    .tabs{display:flex;gap:10px;flex-wrap:wrap;margin-top:10px}
    .tab{
      padding:10px 12px;border-radius:999px;
      border:1px solid rgba(255,255,255,.14);
      background:rgba(255,255,255,.08);
      font-weight:1000;opacity:.95
    }
    .tab.active{background:rgba(37,99,235,.30);border-color:rgba(37,99,235,.65)}
    .split{display:grid;grid-template-columns: 1.2fr .8fr;gap:14px}
    @media(max-width:980px){.split{grid-template-columns:1fr}}
    .card{
      background:linear-gradient(180deg,var(--card1),var(--card2));
      border:1px solid var(--border);
      border-radius:20px;
      padding:16px;
      margin:14px 0;
      box-shadow:0 14px 50px rgba(0,0,0,.35);
    }
    .head{display:flex;justify-content:space-between;gap:10px;flex-wrap:wrap;align-items:center;margin-bottom:10px}
    .oid{font-size:18px;font-weight:1000}
    .status{font-weight:1000;background:rgba(255,255,255,.10);border:1px solid rgba(255,255,255,.10);padding:8px 12px;border-radius:999px}
    .badges{display:flex;gap:8px;flex-wrap:wrap;margin-top:8px}
    .badge{
      padding:6px 10px;border-radius:999px;font-weight:1000;
      border:1px solid rgba(255,255,255,.14);
      background:rgba(255,255,255,.08);
    }
    .badge.ok{background:rgba(22,163,74,.18);border-color:rgba(22,163,74,.35)}
    .badge.no{background:rgba(220,38,38,.16);border-color:rgba(220,38,38,.35)}
    .badge.info{background:rgba(6,182,212,.18);border-color:rgba(6,182,212,.35)}
    .badge.warn{background:rgba(245,158,11,.16);border-color:rgba(245,158,11,.35)}
    .badge.vio{background:rgba(124,58,237,.16);border-color:rgba(124,58,237,.35)}
    .grid{display:grid;grid-template-columns:1fr 1fr;gap:10px;margin-top:12px}
    @media(max-width:820px){.grid{grid-template-columns:1fr}}
    .field{
      background:rgba(255,255,255,.06);
      border:1px solid rgba(255,255,255,.12);
      border-radius:16px;
      padding:10px;
    }
    .label{opacity:.85;font-weight:1000;margin-bottom:6px}
    .mono{font-family:ui-monospace,SFMono-Regular,Menlo,Monaco,Consolas,"Liberation Mono","Courier New",monospace}
    .actions{display:grid;grid-template-columns:1fr 1fr;gap:10px;margin-top:14px}
    @media(max-width:820px){.actions{grid-template-columns:1fr}}
    .hugeBtn{padding:18px 16px;border-radius:18px;font-size:18px;font-weight:1200}
    .subactions{display:flex;gap:10px;flex-wrap:wrap;margin-top:10px}
    .small{font-size:12px;opacity:.8}
    .muted{opacity:.82;color:var(--muted)}
    .empty{
      padding:24px;border:1px dashed rgba(255,255,255,.18);
      border-radius:18px;text-align:center;opacity:.88;margin-top:16px
    }
    table{width:100%;border-collapse:separate;border-spacing:0 10px}
    th{font-size:12px;opacity:.8;text-align:right;padding:0 10px}
    td{
      background:rgba(255,255,255,.06);
      border:1px solid rgba(255,255,255,.12);
      padding:10px;border-left:none;border-right:none
    }
    tr td:first-child{border-top-right-radius:14px;border-bottom-right-radius:14px;border-right:1px solid rgba(255,255,255,.12)}
    tr td:last-child{border-top-left-radius:14px;border-bottom-left-radius:14px;border-left:1px solid rgba(255,255,255,.12)}
    .rowBtn{padding:8px 10px;border-radius:12px;font-weight:1100;background:rgba(37,99,235,.22);border:1px solid rgba(37,99,235,.45); color:#fff}
    .dangerBtn{padding:8px 10px;border-radius:12px;font-weight:1100;background:rgba(220,38,38,.22);border:1px solid rgba(220,38,38,.45); color:#fff}
    .okBtn{padding:8px 10px;border-radius:12px;font-weight:1100;background:rgba(22,163,74,.18);border:1px solid rgba(22,163,74,.45); color:#fff}
    .vioBtn{padding:8px 10px;border-radius:12px;font-weight:1100;background:rgba(124,58,237,.18);border:1px solid rgba(124,58,237,.55); color:#fff}

    .modal{position:fixed;inset:0;background:rgba(0,0,0,.55);display:none;align-items:center;justify-content:center;z-index:999}
    .modal .box{width:min(980px,92vw);max-height:90vh;overflow:auto;background:rgba(8,12,26,.96);border:1px solid rgba(255,255,255,.12);border-radius:18px;padding:16px}
    .modal.show{display:flex}

    .hr{height:1px;background:rgba(255,255,255,.10);margin:12px 0}
    .two{display:grid;grid-template-columns:1fr 1fr;gap:10px}
    @media(max-width:820px){.two{grid-template-columns:1fr}}
    .hint{padding:10px 12px;border-radius:14px;border:1px solid rgba(255,255,255,.14);background:rgba(255,255,255,.06)}
  </style>
</head>
<body>

<!-- =========================
   Ø¹Ø¯Ù‘Ù„ ÙÙ‚Ø· Ù‡Ø°Ù‡ Ø§Ù„Ù‚ÙŠÙ…
========================= -->
<script>
const SCRIPT_URL = "https://script.google.com/macros/s/AKfycbyLjLFa8AaH82Ip7m747WC-KSUUEaU_M70S0I9Mda14XbnmcuEfZ7pBnF_zzJYZuXmZ/exec";
const DASH_KEY   = "12345678"; // Ù„Ù„Ø¹Ù…Ù„ÙŠØ§Øª

pdfjsLib.GlobalWorkerOptions.workerSrc =
  "https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf.worker.min.js";
</script>

<div class="top">
  <div class="wrap">
    <div class="row">
      <div class="title">Ù†Ø³Ø®Ø© Ø§Ù„Ù…Ø¯ÙŠØ± âœ… (PDF + Smart Parse) â€” Improved</div>
      <span class="tag" id="stat">...</span>
      <span class="small muted" id="conn"></span>

      <button class="btn bgray" onclick="manualRefresh()">ØªØ­Ø¯ÙŠØ« â†»</button>
      <button class="btn bviolet" onclick="openSmartNew()">â• Ø¥Ø¶Ø§ÙØ© Ø·Ù„Ø¨ (Ù†Øµ/ PDF)</button>

      <button class="btn bblue" id="modeBtn" onclick="toggleMode()">Ø§Ù„ÙˆØ§Ø¬Ù‡Ø©: Ø³Ø±ÙŠØ¹Ø© âš¡</button>

      <input id="q" placeholder="Ø¨Ø­Ø«: Ø§Ø³Ù… / Ø±Ù‚Ù… / ÙƒÙˆØ¯ / OrderId / Ù…Ø¯ÙŠÙ†Ø©" style="flex:1;min-width:280px" oninput="renderDebounced()"/>

      <select id="filter" onchange="render()">
        <option value="NEW" selected>Ø·Ù„Ø¨Ø§Øª Ø¬Ø¯ÙŠØ¯Ø© (ØºÙŠØ± Ù…Ø¹ØªÙ…Ø¯Ø©)</option>
        <option value="INBOX">ÙˆØ§ØªØ³Ø§Ø¨ Inbox (Ø±Ø³Ø§Ø¦Ù„/PDF)</option>
        <option value="PREP">ØªÙ… Ø¥Ø±Ø³Ø§Ù„ Ù„Ù„ØªØ¬Ù‡ÙŠØ²</option>
        <option value="READY">Ø¬Ø§Ù‡Ø²Ø©</option>
        <option value="ALL">Ø§Ù„ÙƒÙ„</option>
      </select>

      <button class="btn bblue" onclick="enableNotify()">ØªÙØ¹ÙŠÙ„ Ø¥Ø´Ø¹Ø§Ø± Ø§Ù„Ù…ØªØµÙØ­</button>
      <span class="small" id="notifyState"></span>
    </div>

    <div class="tabs">
      <button class="tab active" id="tabQuick" onclick="setTab('quick')">âš¡ Ø¹Ù…Ù„ Ø³Ø±ÙŠØ¹</button>
      <button class="tab" id="tabPro" onclick="setTab('pro')">ğŸ§  Ù…ØªØ·ÙˆÙ‘Ø± Ø¬Ø¯Ù‹Ø§</button>
      <span class="small muted">Ø§Ø±ÙØ¹ PDF Ø£Ùˆ Ø§Ù„ØµÙ‚ Ù†Øµ ÙˆØ§ØªØ³Ø§Ø¨ â†’ ØªØ­Ù„ÙŠÙ„ ØªÙ„Ù‚Ø§Ø¦ÙŠ â†’ ØªØ¹Ø¯ÙŠÙ„ â†’ Ø­ÙØ¸ â†’ Ø§Ø¹ØªÙ…Ø§Ø¯.</span>
    </div>

    <div class="row" style="margin-top:10px" id="countsRow"></div>
  </div>
</div>

<div class="wrap">
  <div id="quickView"></div>
  <div id="proView" style="display:none"></div>
</div>

<div class="modal" id="modal">
  <div class="box">
    <div class="row" style="justify-content:space-between">
      <div class="title" id="modalTitle">...</div>
      <button class="btn bgray" onclick="closeModal()">Ø¥ØºÙ„Ø§Ù‚ âœ–</button>
    </div>
    <div id="modalBody" style="margin-top:12px"></div>
  </div>
</div>

<script>
/* ================= State ================= */
let orders = [];
let mode = localStorage.getItem("mad_manager_mode") || "quick";
let tab  = localStorage.getItem("mad_manager_tab")  || "quick";
let firstLoad = true;
let lastNewKey = "";
let renderTimer = null;

/* ================= Constants ================= */
const PAYMENT_OPTIONS = [
  {value:"Cash",     label:"Ù†Ù‚Ø¯Ø§Ù‹ / ××–×•××Ÿ"},
  {value:"Paid",     label:"Ù…Ø¯ÙÙˆØ¹ / ×©×•×œ×"},
  {value:"PaidLink", label:"Ù…Ø¯ÙÙˆØ¹ Ø¨Ø§Ù„Ø±Ø§Ø¨Ø· / ×©×•×œ× ×‘×§×™×©×•×¨"}
];
const SOURCE_OPTIONS = [
  {value:"WhatsApp",            label:"ÙˆØ§ØªØ³Ø§Ø¨"},
  {value:"WhatsApp-Sheet",      label:"ÙˆØ§ØªØ³Ø§Ø¨ (Ø´ÙŠØª)"},
  {value:"Site-HE-Paid",        label:"Ù…ÙˆÙ‚Ø¹ Ø¹Ø¨Ø±ÙŠ (Ù…Ø¯ÙÙˆØ¹)"},
  {value:"Site-HE-COD",         label:"Ù…ÙˆÙ‚Ø¹ Ø¹Ø¨Ø±ÙŠ (Ù†Ù‚Ø¯Ø§Ù‹)"},
  {value:"Site-AR-Paid",        label:"Ù…ÙˆÙ‚Ø¹ Ø¹Ø±Ø¨ÙŠ (Ù…Ø¯ÙÙˆØ¹)"},
  {value:"Site-AR-COD",         label:"Ù…ÙˆÙ‚Ø¹ Ø¹Ø±Ø¨ÙŠ (Ù†Ù‚Ø¯Ø§Ù‹)"},
  {value:"TikTok",              label:"ØªÙŠÙƒ ØªÙˆÙƒ"},
  {value:"Facebook",            label:"ÙÙŠØ³"},
  {value:"Manual",              label:"ÙŠØ¯ÙˆÙŠ"}
];

/* ================= Boot ================= */
start();

async function start(){
  applyTab();
  setModeButton();
  updateNotifyUi();

  window.addEventListener("keydown",(e)=>{
    if(e.key === "Escape") closeModal();
  });

  await load();
  setInterval(load, 10000);
}

/* ================= UI Tab/Mode ================= */
function setTab(t){
  tab = t;
  localStorage.setItem("mad_manager_tab", tab);
  applyTab();
  render();
}
function applyTab(){
  document.getElementById("tabQuick").classList.toggle("active", tab==="quick");
  document.getElementById("tabPro").classList.toggle("active", tab==="pro");
  document.getElementById("quickView").style.display = (tab==="quick") ? "block" : "none";
  document.getElementById("proView").style.display   = (tab==="pro") ? "block" : "none";
}
function toggleMode(){
  mode = (mode === "quick") ? "pro" : "quick";
  localStorage.setItem("mad_manager_mode", mode);
  setModeButton();
  setTab(mode === "quick" ? "quick" : "pro");
}
function setModeButton(){
  document.getElementById("modeBtn").textContent = (mode==="quick") ? "Ø§Ù„ÙˆØ§Ø¬Ù‡Ø©: Ø³Ø±ÙŠØ¹Ø© âš¡" : "Ø§Ù„ÙˆØ§Ø¬Ù‡Ø©: Ù…ØªØ·ÙˆÙ‘Ø±Ø© ğŸ§ ";
}
function manualRefresh(){ load(true); }

function renderDebounced(){
  clearTimeout(renderTimer);
  renderTimer = setTimeout(render, 120);
}

/* ================= Helpers ================= */
function esc(s){ return String(s??"").replace(/[&<>"']/g,m=>({ "&":"&amp;","<":"&lt;",">":"&gt;",'"':"&quot;","'":"&#39;" }[m])); }
function toLower(s){ return String(s??"").toLowerCase(); }
function waLink(phone){
  const p = String(phone??"").replace(/[^\d]/g,"");
  if(!p) return "#";
  return `https://wa.me/${p}`;
}
function getVal(id){ return (document.getElementById(id)?.value ?? "").trim(); }
function findByRow(row){ return orders.find(x => Number(x.rowIndex) === Number(row)); }
function badge(text, kind="info"){ return `<span class="badge ${kind}">${esc(text)}</span>`; }
function extractCityLocal(addr){
  const s = String(addr??"").trim();
  if(!s) return "-";
  return s.split(/[\s,]+/)[0] || "-";
}
function isHebrewText(s){ return /[\u0590-\u05FF]/.test(String(s??"")); }

/* ================= Status/Flags ================= */
function isInbox(o){
  const offer = toLower(o.offer);
  const notes = toLower(o.notes);
  const src   = toLower(o.source);

  // âœ… Ø£Ù‚ÙˆÙ‰: Ù„Ùˆ notes ÙÙŠÙ‡Ø§ WA_INBOX Ø­ØªÙ‰ Ù„Ùˆ source ÙØ§Ø¶ÙŠ
  if(notes.includes("wa_inbox")) return true;

  // Ø§Ù„Ù‚Ø¯ÙŠÙ…:
  return (src.includes("whatsapp") || src.includes("wa")) && (notes.includes("wa_inbox") || offer.includes("whatsapp"));
}
function isNewUnapproved(o){
  const st = toLower(o.status);
  if(isInbox(o) && st.includes("new")) return true;
  return st === "" || st.includes("new") || st.includes("processing") || st.includes("pending");
}
function isPrep(o){
  const st = toLower(o.status);
  return st.includes("approved") || st.includes("sent to prep") || st.includes("prep") || st.includes("ØªÙ… Ø§Ø±Ø³Ø§Ù„ Ù„Ù„ØªØ¬Ù‡ÙŠØ²");
}
function isReady(o){
  const st = toLower(o.status);
  return st.includes("ready") || st.includes("Ù…Ø¬Ù‡Ø²") || st.includes("××•×›×Ÿ");
}
function isCancelled(o){
  const st = toLower(o.status);
  return st.includes("cancel") || st.includes("Ù…Ù„ØºÙŠ") || st.includes("Ø¥Ù„ØºØ§Ø¡");
}
function flagCustSent(o){
  const s = (toLower(o.notes) + " " + toLower(o.status));
  return s.includes("flag:cust_sent") || s.includes("ØªÙ… Ø§Ø±Ø³Ø§Ù„ Ù„Ù„Ø¹Ù…ÙŠÙ„") || s.includes("cust:âœ…");
}
function flagPrepSent(o){
  const s = (toLower(o.notes) + " " + toLower(o.status));
  return s.includes("flag:prep_sent") || s.includes("sent to prep") || s.includes("approved") || s.includes("ØªÙ… Ø§Ø±Ø³Ø§Ù„ Ù„Ù„ØªØ¬Ù‡ÙŠØ²");
}

function selectHtml(id, options, current){
  const cur = String(current??"").trim();
  return `
    <select id="${id}">
      <option value="" ${cur===""?"selected":""}>â€” Ø§Ø®ØªÙŠØ§Ø±ÙŠ â€”</option>
      ${options.map(o => `<option value="${esc(o.value)}" ${o.value===cur?"selected":""}>${esc(o.label)}</option>`).join("")}
    </select>
  `;
}

/* ================= Smart Parse ================= */
function normalizePhoneLocal(p){
  if(!p) return "";
  let d = String(p).replace(/[^\d]/g,"");
  if(d.startsWith("00")) d = d.slice(2);
  if(d.startsWith("9720")) d = "972" + d.slice(4);
  if(d.startsWith("059") && d.length >= 10) return "970" + d.slice(1);
  if(d.startsWith("05") && d.length >= 10) return "972" + d.slice(1);
  if(d.startsWith("972") || d.startsWith("970")) return d;
  if(d.length === 10 && d.startsWith("0")) return "972" + d.slice(1);
  if(d.length === 9 && d.startsWith("5")) return "972" + d;
  if(d.length === 9 && d.startsWith("59")) return "970" + d;
  return d;
}

function smartParse(txt){
  const t0 = String(txt??"").replace(/\u200f|\u200e/g,"").replace(/\n+/g," ").trim();
  const t  = t0.replace(/[|]+/g," | ");

  const phoneMatch = t.match(/(\+?972\d{9}|\b05\d{8}\b|\b0?59\d{7,8}\b)/);
  let phone = phoneMatch ? phoneMatch[1] : "";
  phone = normalizePhoneLocal(phone);

  let price = "";
  const m1 = t.match(/â‚ª\s*(\d{2,5})/);
  if(m1) price = m1[1];
  const m2 = t.match(/\b(\d{2,5})\s*(?:â‚ª|Ø´ÙŠÙƒÙ„|shekel|nis|ils)\b/i);
  if(!price && m2) price = m2[1];

  // fallback Ø¢Ø®Ø± Ø±Ù‚Ù… 2-5 (Ù„ÙƒÙ† ØªØ¬Ù†Ù‘Ø¨ Ø£Ù†Ù‡ ÙŠÙƒÙˆÙ† Ø¬Ø²Ø¡ Ù…Ù† Ø±Ù‚Ù… Ø·ÙˆÙŠÙ„)
  if(!price){
    const nums = t.match(/\b\d{2,5}\b/g);
    if(nums && nums.length) price = nums[nums.length-1];
  }

  let payment = "";
  if(/Ù…Ø¯ÙÙˆØ¹ Ø¨Ø§Ù„Ø±Ø§Ø¨Ø·|paid link|×‘×§×™×©×•×¨/i.test(t)) payment = "PaidLink";
  else if(/Ù…Ø¯ÙÙˆØ¹|paid|××©×¨××™|×›×¨×˜×™×¡|×‘×›×¨×˜×™×¡|credit/i.test(t)) payment = "Paid";
  else if(/Ù†Ù‚Ø¯|cash|××–×•××Ÿ/i.test(t)) payment = "Cash";

  let delivery = "";
  if(/High\s*Express/i.test(t)) delivery = "High Express";
  else if(/Marwah/i.test(t)) delivery = "Marwah Delivery";
  else if(/Lama/i.test(t)) delivery = "Lama Delivery";
  else if(/Areen/i.test(t)) delivery = "Areen Delivery";

  const tokens = t.replace(/[:,]/g," ").split(/\s+/).filter(Boolean);
  const codes = tokens.filter(x => /^[A-Za-z]{1,3}\d{2,4}$/i.test(x) || x.toLowerCase()==="he" || x.toLowerCase()==="ar");
  let offer = codes.length ? codes.join(" ") : "";

  let addr = "";
  const addrHe = t.match(/(?:×›×ª×•×‘×ª|â€×›×ª×•×‘×ª|address)\s*[:ï¼š]\s*([^|]+?)(?=(\s{2,}|$|ğŸš€|×¡×˜×˜×•×¡|status))/i);
  if(addrHe) addr = addrHe[1].trim();
  const addrAr = t.match(/(?:Ø§Ù„Ø¹Ù†ÙˆØ§Ù†|Ø¹Ù†ÙˆØ§Ù†)\s*[:ï¼š]\s*([^|]+?)(?=(\s{2,}|$|ğŸšš|Ø´Ø±ÙƒØ©|Ø§Ù„Ø¯ÙØ¹|Ø§Ù„Ø¥Ø¬Ø±Ø§Ø¡))/i);
  if(!addr && addrAr) addr = addrAr[1].trim();

  let name = "";
  let city = "";
  if(phoneMatch){
    const before = t.slice(0, phoneMatch.index).trim();
    const parts = before.split(/\s+/).filter(Boolean);
    name = parts[0] || "";
    city = parts.slice(1).join(" ") || "";
  }
  if(!addr) addr = city || "";

  let proc = "";
  if(/direct|Ø¯ÙˆÙ† ØªÙˆØ§ØµÙ„|Ø¨Ø¯ÙˆÙ† ØªÙˆØ§ØµÙ„|×œ×œ× ×§×©×¨/i.test(t)) proc = "Direct";
  if(/call|Ø§ØªØµØ§Ù„|ØªÙˆØ§ØµÙ„|×˜×œ×¤×•×Ÿ/i.test(t)) proc = proc || "Call";

  if(!offer){
    const prodHe = t.match(/(?:×”××•×¦×¨|××•×¦×¨)\s*[:ï¼š]\s*([^|]+?)(?=(\s{2,}|$|ğŸ’³|×©×™×˜×ª|×¡×˜×˜×•×¡|ğŸš€))/i);
    if(prodHe) offer = prodHe[1].trim();
    const prodAr = t.match(/(?:Ø§Ù„Ù…Ù†ØªØ¬|Ø§Ù„Ø¹Ø·Ø±)\s*[:ï¼š]\s*([^|]+?)(?=(\s{2,}|$|ğŸ’°|Ø§Ù„Ø¯ÙØ¹|ğŸ“|Ø§Ù„Ø¹Ù†ÙˆØ§Ù†))/i);
    if(!offer && prodAr) offer = prodAr[1].trim();
  }

  return { name, phone, offer, price, payment, proc, addr, delivery, raw:t0 };
}

function getRawFromNotes(o){
  const notes = String(o.notes??"");
  const m = notes.match(/RAW\s*:\s*(.+)$/i);
  if(m) return m[1].trim();
  if(/WA_INBOX/i.test(notes)){
    const parts = notes.split("|").map(x=>x.trim()).filter(Boolean);
    if(parts.length) return parts[parts.length-1];
  }
  return notes;
}

/* ================= Normalize Orders ================= */
function normalizeOrder(x){
  const o = { ...x };

  o.rowIndex = Number(o.rowIndex ?? o.row ?? o.Row ?? 0);
  o.orderId  = String(o.orderId ?? o.OrderId ?? o.id ?? "").trim();
  o.name     = String(o.name ?? o.customerName ?? "").trim();
  o.phone    = normalizePhoneLocal(o.phone ?? o.Phone ?? "");
  o.offer    = String(o.offer ?? o.product ?? "").trim();
  o.price    = String(o.price ?? o.total ?? "").trim();
  o.payment  = String(o.payment ?? o.pay ?? "").trim();
  o.proc     = String(o.proc ?? o.process ?? "").trim();
  o.addr     = String(o.addr ?? o.address ?? "").trim();
  o.city     = String(o.city ?? "").trim();
  o.source   = String(o.source ?? "").trim();
  o.delivery = String(o.delivery ?? o.shipper ?? "").trim();
  o.status   = String(o.status ?? "").trim();
  o.notes    = String(o.notes ?? "").trim();

  if(!o.city && o.addr) o.city = extractCityLocal(o.addr);

  // âœ… Smart suggestion: Ø®ØµÙˆØµÙ‹Ø§ Ù„Ù„Ù€ Inbox
  const raw = getRawFromNotes(o);
  const shouldSuggest = isInbox(o) || ((!o.phone || !o.offer) && raw && raw.length > 5);
  o._suggest = shouldSuggest ? smartParse(raw) : null;

  return o;
}

/* ================= Load ================= */
async function load(forced=false){
  const conn = document.getElementById("conn");
  try{
    conn.textContent = "ğŸ”„ Ø§ØªØµØ§Ù„...";
    const res = await fetch(`${SCRIPT_URL}?action=get&_=${Date.now()}`);
    const data = await res.json();

    let arr = [];
    if(Array.isArray(data)) arr = data;
    else if(Array.isArray(data.data)) arr = data.data;
    else if(Array.isArray(data.orders)) arr = data.orders;
    else arr = [];

    orders = arr.map(normalizeOrder).filter(o => o.rowIndex);

    localStorage.setItem("mad_manager_cache", JSON.stringify(orders));
    conn.textContent = "ğŸŸ¢ Ù…ØªØµÙ„";

    updateTopCounts();
    document.getElementById("stat").textContent = `ÙƒÙ„ Ø§Ù„Ø³Ø¬Ù„Ø§Øª: ${orders.length}`;
    render();
    pingNewOrders();
  }catch(e){
    conn.textContent = "ğŸ”´ ØºÙŠØ± Ù…ØªØµÙ„ (Cache)";
    // fallback cache
    if(!forced){
      try{
        const cached = JSON.parse(localStorage.getItem("mad_manager_cache")||"[]");
        if(Array.isArray(cached) && cached.length){
          orders = cached.map(normalizeOrder);
          updateTopCounts();
          document.getElementById("stat").textContent = `ÙƒÙ„ Ø§Ù„Ø³Ø¬Ù„Ø§Øª: ${orders.length} (Cache)`;
          render();
        }else{
          document.getElementById("stat").textContent = "Ø®Ø·Ø£ Ø§ØªØµØ§Ù„";
        }
      }catch(_){
        document.getElementById("stat").textContent = "Ø®Ø·Ø£ Ø§ØªØµØ§Ù„";
      }
    }else{
      document.getElementById("stat").textContent = "Ø®Ø·Ø£ Ø§ØªØµØ§Ù„";
    }
  }
}

function updateTopCounts(){
  const total = orders.filter(o=>!isCancelled(o)).length;
  const cNew  = orders.filter(o=>!isCancelled(o) && isNewUnapproved(o) && !isPrep(o) && !isReady(o)).length;
  const cIn   = orders.filter(o=>!isCancelled(o) && isInbox(o)).length;
  const cPrep = orders.filter(o=>!isCancelled(o) && isPrep(o) && !isReady(o)).length;
  const cRdy  = orders.filter(o=>!isCancelled(o) && isReady(o)).length;

  document.getElementById("countsRow").innerHTML = `
    ${badge("NEW: "+cNew, "warn")}
    ${badge("INBOX: "+cIn, "vio")}
    ${badge("PREP: "+cPrep, "info")}
    ${badge("READY: "+cRdy, "ok")}
    ${badge("TOTAL: "+total, "info")}
  `;
}

/* ================= PDF Extract ================= */
async function extractTextFromPdfFile(file){
  const maxMB = 8;
  if(file.size > maxMB*1024*1024) throw new Error("PDF ÙƒØ¨ÙŠØ± Ø¬Ø¯Ù‹Ø§");
  const buf = await file.arrayBuffer();
  const pdf = await pdfjsLib.getDocument({data: buf}).promise;
  let full = "";
  for(let p=1; p<=pdf.numPages; p++){
    const page = await pdf.getPage(p);
    const tc = await page.getTextContent();
    const line = tc.items.map(it => it.str).join(" ");
    full += line + "\n";
  }
  return full.trim();
}

/* ================= Render ================= */
function render(){
  if(tab === "quick") renderQuick();
  else renderPro();
}

function filtered(){
  const q = toLower(document.getElementById("q").value.trim());
  const f = document.getElementById("filter").value;

  let arr = orders.slice();

  arr = arr.filter(o=>{
    if(isCancelled(o)) return false;

    if(f==="NEW")   return isNewUnapproved(o) && !isPrep(o) && !isReady(o);
    if(f==="INBOX") return isInbox(o);
    if(f==="PREP")  return isPrep(o) && !isReady(o);
    if(f==="READY") return isReady(o);
    return true;
  });

  if(q){
    arr = arr.filter(o=>{
      const blob = toLower(`${o.orderId} ${o.name} ${o.phone} ${o.offer} ${o.city} ${o.addr} ${o.notes} ${o.status} ${o.source} ${o.delivery}`);
      return blob.includes(q);
    });
  }

  arr.sort((a,b)=>(b.rowIndex||0)-(a.rowIndex||0));
  return arr;
}

/* ================= Quick View ================= */
function renderQuick(){
  const list = document.getElementById("quickView");
  const arr = filtered();

  if(!arr.length){
    list.innerHTML = `<div class="empty">Ù„Ø§ ÙŠÙˆØ¬Ø¯ Ù†ØªØ§Ø¦Ø¬ Ø­Ø³Ø¨ Ø§Ù„ÙÙ„ØªØ± Ø§Ù„Ø­Ø§Ù„ÙŠ âœ…</div>`;
    return;
  }

  list.innerHTML = arr.map(o => quickCard(o)).join("");
}

function quickCard(o){
  const custOk = flagCustSent(o);
  const prepOk = flagPrepSent(o);
  const inbox  = isInbox(o);

  // âœ… suggested (Ù„Ø§ ØªØ­ÙØ¸ ØªÙ„Ù‚Ø§Ø¦ÙŠ)
  const s = o._suggest || {};
  const useSuggest = (k)=> (String(o[k]||"").trim() ? o[k] : (s[k]||""));

  const name  = useSuggest("name");
  const phone = useSuggest("phone");
  const offer = useSuggest("offer");
  const price = useSuggest("price");
  const pay   = useSuggest("payment");
  const proc  = useSuggest("proc") || "Direct";
  const addr  = useSuggest("addr") || o.addr || o.city || "";
  const del   = useSuggest("delivery");
  const src   = o.source || "";
  const suggestUsed = (o._suggest && (
    (!o.phone && s.phone) || (!o.offer && s.offer) || (!o.price && s.price) || (!o.name && s.name)
  ));

  return `
    <div class="card" id="c${o.rowIndex}">
      <div class="head">
        <div class="oid">ğŸ§¾ ${esc(o.orderId)} <span class="small">#${o.rowIndex}</span></div>
        <div class="status">${esc(o.status||"")}</div>
      </div>

      <div class="badges">
        ${badge(prepOk ? "âœ… ØªÙ… Ø¥Ø±Ø³Ø§Ù„ Ù„Ù„ØªØ¬Ù‡ÙŠØ²" : "âŒ ØºÙŠØ± Ù…ÙØ±Ø³Ù„ Ù„Ù„ØªØ¬Ù‡ÙŠØ²", prepOk?"ok":"no")}
        ${badge(custOk ? "âœ… ØªÙ… Ø¥Ø±Ø³Ø§Ù„ Ù„Ù„Ø¹Ù…ÙŠÙ„" : "âŒ Ù„Ù… ÙŠØªÙ… Ø¥Ø±Ø³Ø§Ù„ Ù„Ù„Ø¹Ù…ÙŠÙ„", custOk?"ok":"no")}
        ${inbox ? badge("ğŸ“© WA_INBOX", "warn") : ""}
        ${suggestUsed ? badge("ğŸ§  Ø§Ù‚ØªØ±Ø§Ø­ ØªÙ„Ù‚Ø§Ø¦ÙŠ (ØºÙŠØ± Ù…Ø­ÙÙˆØ¸)", "vio") : ""}
        ${src ? badge("ğŸŒ " + src, "info") : ""}
      </div>

      <div class="grid">
        ${fieldInput("Ø§Ù„Ø§Ø³Ù…", `name_${o.rowIndex}`, name||"")}
        ${fieldInput("Ø§Ù„Ù‡Ø§ØªÙ", `phone_${o.rowIndex}`, phone||"", true)}
        ${fieldInput("Ø§Ù„Ø·Ù„Ø¨ (C)", `offer_${o.rowIndex}`, offer||"", true)}
        ${fieldInput("Ø§Ù„Ø³Ø¹Ø±", `price_${o.rowIndex}`, price||"", true)}

        <div class="field">
          <div class="label">Ø·Ø±ÙŠÙ‚Ø© Ø§Ù„Ø¯ÙØ¹</div>
          ${selectHtml(`payment_${o.rowIndex}`, PAYMENT_OPTIONS, pay||o.payment||"")}
        </div>

        ${fieldInput("Ø§Ù„Ø¥Ø¬Ø±Ø§Ø¡", `proc_${o.rowIndex}`, proc)}
        ${fieldInput("Ø§Ù„Ø¹Ù†ÙˆØ§Ù†", `addr_${o.rowIndex}`, addr)}

        <div class="field">
          <div class="label">Ù…ØµØ¯Ø± Ø§Ù„Ø·Ù„Ø¨ (Ø§Ø®ØªÙŠØ§Ø±ÙŠ)</div>
          ${selectHtml(`source_${o.rowIndex}`, SOURCE_OPTIONS, src)}
        </div>

        ${fieldInput("Ø´Ø±ÙƒØ© Ø§Ù„ØªÙˆØµÙŠÙ„", `delivery_${o.rowIndex}`, del||o.delivery||"")}

        <div class="field" style="grid-column:1/-1">
          <div class="label">Ù…Ù„Ø§Ø­Ø¸Ø§Øª (ØªØ¸Ù‡Ø± ÙƒØ§Ù…Ù„Ø©)</div>
          <div class="muted" style="white-space:pre-wrap;word-break:break-word">${esc(o.notes||"")}</div>
        </div>
      </div>

      <div class="actions">
        <button class="btn bgreen hugeBtn" onclick="approveToPrepQuick(${o.rowIndex})">âœ… Ø­ÙØ¸ + Ø§Ø¹ØªÙ…Ø§Ø¯ + Ø¥Ø±Ø³Ø§Ù„ Ù„Ù„ØªØ¬Ù‡ÙŠØ²</button>
        <button class="btn bblue hugeBtn" onclick="sendConfirm(${o.rowIndex})">ğŸ“© ØªØ£ÙƒÙŠØ¯ Ù„Ù„Ø¹Ù…ÙŠÙ„</button>
      </div>

      <div class="subactions">
        <button class="btn bviolet" onclick="smartFillFromNotes(${o.rowIndex})">ğŸ§  ØªØ­Ù„ÙŠÙ„ (Ù…Ù† Notes)</button>
        <button class="btn bviolet" onclick="openPdfForRow(${o.rowIndex})">ğŸ“„ Ø¥Ø¶Ø§ÙØ© PDF</button>
        <button class="btn borange" onclick="saveQuick(${o.rowIndex})">ğŸ’¾ Ø­ÙØ¸ Ø§Ù„ØªØ¹Ø¯ÙŠÙ„</button>
        <a class="btn bcyan" href="${waLink(phone||o.phone)}" target="_blank" style="text-decoration:none;display:inline-block">ğŸ’¬ ÙØªØ­ ÙˆØ§ØªØ³Ø§Ø¨</a>
        <button class="btn bgray" onclick="markReadyQuick(${o.rowIndex})">âœ… Ø¬Ø§Ù‡Ø²</button>
        <button class="btn bred" onclick="cancelOrder(${o.rowIndex})">ğŸ›‘ Ø¥Ù„ØºØ§Ø¡</button>
        <button class="btn bgray" onclick="copySummary(${o.rowIndex})">ğŸ“‹ Ù†Ø³Ø®</button>
      </div>

      <div class="small muted" style="margin-top:10px">
        Ù„Ùˆ Ù‡Ø°Ø§ Ø³Ø¬Ù„ ÙˆØ§ØªØ³Ø§Ø¨ Inbox: Ø§Ø¶ØºØ· â€œğŸ§  ØªØ­Ù„ÙŠÙ„â€ Ø£Ùˆ â€œğŸ“„ PDFâ€ Ø«Ù… â€œğŸ’¾ Ø­ÙØ¸â€ Ø«Ù… â€œâœ… Ø­ÙØ¸ + Ø§Ø¹ØªÙ…Ø§Ø¯â€.
      </div>
    </div>
  `;
}

function fieldInput(label, id, value, mono=false){
  return `
    <div class="field">
      <div class="label">${esc(label)}</div>
      <input id="${id}" value="${esc(value)}" class="${mono?'mono':''}" />
    </div>
  `;
}

/* ================= Pro View ================= */
function renderPro(){
  const host = document.getElementById("proView");
  const arr = filtered();

  const bulkHtml = `
    <div class="card">
      <div class="head">
        <div class="title">ğŸ§  Ø£Ø¯ÙˆØ§Øª Ù…ØªØ·ÙˆØ±Ø© (Bulk)</div>
        <div class="small muted">Ø­Ø¯Ø¯ Ø¹Ø¯Ø© Ø·Ù„Ø¨Ø§Øª Ø«Ù… Ù†ÙÙ‘Ø° Ø¥Ø¬Ø±Ø§Ø¡ ÙˆØ§Ø­Ø¯ Ø¹Ù„ÙŠÙ‡Ù…</div>
      </div>
      <div class="row">
        <button class="btn bgray" onclick="selectAll(true)">ØªØ­Ø¯ÙŠØ¯ Ø§Ù„ÙƒÙ„</button>
        <button class="btn bgray" onclick="selectAll(false)">Ø¥Ù„ØºØ§Ø¡ Ø§Ù„ØªØ­Ø¯ÙŠØ¯</button>

        <select id="bulkStatus" style="min-width:260px">
          <option value="Approved âœ… (Sent to Prep) | FLAG:PREP_SENT">Ø§Ø¹ØªÙ…Ø§Ø¯ + Ø¥Ø±Ø³Ø§Ù„ Ù„Ù„ØªØ¬Ù‡ÙŠØ²</option>
          <option value="READY âœ… (××•×›×Ÿ / Ù…Ø¬Ù‡Ø²)">Ø¬Ø§Ù‡Ø²</option>
          <option value="CANCELLED âŒ">Ø¥Ù„ØºØ§Ø¡</option>
        </select>
        <button class="btn bblue" onclick="bulkUpdateStatus()">ØªØ­Ø¯ÙŠØ« Ø§Ù„Ø­Ø§Ù„Ø© Ù„Ù„Ø·Ù„Ø¨Ø§Øª Ø§Ù„Ù…Ø­Ø¯Ø¯Ø©</button>

        <button class="btn bblue" onclick="bulkSendConfirm()">ØªØ£ÙƒÙŠØ¯ Ù„Ù„Ø¹Ù…ÙŠÙ„ (Ù„Ù„Ù…Ø­Ø¯Ø¯)</button>
      </div>
      <div class="small muted" style="margin-top:10px">
        Ø§ÙØªØ­ Ø£ÙŠ Ø·Ù„Ø¨ ÙˆØ§Ø¶ØºØ· â€œØªØ­Ù„ÙŠÙ„â€ Ø£Ùˆ â€œPDFâ€ Ù„Ù…Ù„Ø¡ Ø§Ù„Ø­Ù‚ÙˆÙ„ Ø«Ù… â€œØ­ÙØ¸ + Ø§Ø¹ØªÙ…Ø§Ø¯â€.
      </div>
    </div>
  `;

  if(!arr.length){
    host.innerHTML = bulkHtml + `<div class="empty">Ù„Ø§ ÙŠÙˆØ¬Ø¯ Ù†ØªØ§Ø¦Ø¬ Ø­Ø³Ø¨ Ø§Ù„ÙÙ„ØªØ± Ø§Ù„Ø­Ø§Ù„ÙŠ âœ…</div>`;
    return;
  }

  const table = `
    <div class="card">
      <div class="head">
        <div class="title">Ø¬Ø¯ÙˆÙ„ Ø§Ù„Ø·Ù„Ø¨Ø§Øª</div>
        <div class="small muted">Ø§Ø¶ØºØ· "ÙØªØ­" Ù„Ù„ØªØ¹Ø¯ÙŠÙ„ Ø§Ù„ÙƒØ§Ù…Ù„</div>
      </div>

      <table>
        <thead>
          <tr>
            <th>âœ“</th>
            <th>OrderId</th>
            <th>Ø§Ù„Ø§Ø³Ù…</th>
            <th>Ø§Ù„Ù‡Ø§ØªÙ</th>
            <th>Ø§Ù„Ø·Ù„Ø¨</th>
            <th>â‚ª</th>
            <th>Ø§Ù„Ø­Ø§Ù„Ø©</th>
            <th>Ø§Ù„Ù…ØµØ¯Ø±</th>
            <th>Ø£ÙˆØ§Ù…Ø±</th>
          </tr>
        </thead>
        <tbody>
          ${arr.map(o=>proRow(o)).join("")}
        </tbody>
      </table>
    </div>
  `;

  host.innerHTML = bulkHtml + table;
}

function proRow(o){
  const price = o.price || "";
  return `
    <tr>
      <td><input type="checkbox" class="sel" data-row="${o.rowIndex}"></td>
      <td class="mono">${esc(o.orderId)}</td>
      <td>${esc(o.name||"")}</td>
      <td class="mono">${esc(o.phone||"")}</td>
      <td class="mono">${esc(o.offer||"")}</td>
      <td class="mono">${esc(price)}</td>
      <td>${esc(o.status||"")}</td>
      <td>${esc(o.source||"")}</td>
      <td>
        <button class="rowBtn" onclick="openEditor(${o.rowIndex}, false)">ÙØªØ­</button>
        <button class="vioBtn" onclick="openEditor(${o.rowIndex}, true)">ØªØ­Ù„ÙŠÙ„</button>
        <button class="vioBtn" onclick="openPdfForRow(${o.rowIndex})">PDF</button>
        <button class="okBtn" onclick="setStatus(${o.rowIndex}, 'Approved âœ… (Sent to Prep) | FLAG:PREP_SENT')">Ø¥Ø±Ø³Ø§Ù„ Ù„Ù„ØªØ¬Ù‡ÙŠØ²</button>
        <button class="rowBtn" onclick="sendConfirm(${o.rowIndex})">ØªØ£ÙƒÙŠØ¯</button>
        <button class="dangerBtn" onclick="cancelOrder(${o.rowIndex})">Ø¥Ù„ØºØ§Ø¡</button>
      </td>
    </tr>
  `;
}

/* ================= API Helpers ================= */
async function apiUpdateOrder(payload, opts={silent:false}){
  const url = `${SCRIPT_URL}?` + new URLSearchParams(payload).toString();
  const res = await fetch(url);
  const j = await res.json().catch(()=>({}));
  if(j.result !== "SUCCESS"){
    if(!opts.silent) alert("âŒ ÙØ´Ù„ Ø§Ù„Ø­ÙØ¸: " + (j.message||""));
    return {ok:false, data:j};
  }
  return {ok:true, data:j};
}

async function apiUpdateStatus(row, status, opts={silent:false}){
  const url = `${SCRIPT_URL}?action=updateStatus&key=${encodeURIComponent(DASH_KEY)}&row=${row}&status=${encodeURIComponent(status)}`;
  const res = await fetch(url);
  const j = await res.json().catch(()=>({}));
  if(j.result !== "SUCCESS"){
    if(!opts.silent) alert("âŒ ÙØ´Ù„: " + (j.message||""));
    return {ok:false, data:j};
  }
  return {ok:true, data:j};
}

/* ================= Quick Save / Validate ================= */
function validateQuickRow(row){
  const phone = getVal(`phone_${row}`);
  const offer = getVal(`offer_${row}`);
  if(!phone){
    alert("âŒ Ù„Ø§Ø²Ù… Ø±Ù‚Ù… Ù‡Ø§ØªÙ");
    document.getElementById(`phone_${row}`)?.focus();
    return false;
  }
  if(!offer){
    alert("âŒ Ù„Ø§Ø²Ù… Ø§Ù„Ø·Ù„Ø¨ (Ø§Ù„ÙƒÙˆØ¯/Ø§Ù„Ø¹Ø·Ø±)");
    document.getElementById(`offer_${row}`)?.focus();
    return false;
  }
  return true;
}

async function saveQuick(row, silent=false){
  const addr = getVal(`addr_${row}`);
  const source = getVal(`source_${row}`);
  const payment = getVal(`payment_${row}`);
  const delivery = getVal(`delivery_${row}`);

  const extra = [
    source ? `SOURCE_UI:${source}` : "",
    delivery ? `DELIVERY_UI:${delivery}` : ""
  ].filter(Boolean).join(" | ");

  const payload = {
    action:"updateOrder",
    key:DASH_KEY,
    row,
    name: getVal(`name_${row}`),
    phone: getVal(`phone_${row}`),
    offer: getVal(`offer_${row}`),
    price: getVal(`price_${row}`),
    payment: payment,
    proc: getVal(`proc_${row}`),
    addr: addr,
    city: extractCityLocal(addr),
    source: source,
    delivery: delivery,
    extraNotes: extra
  };

  const r = await apiUpdateOrder(payload, {silent});
  if(r.ok && !silent) alert("âœ… ØªÙ… Ø§Ù„Ø­ÙØ¸");
  if(r.ok) await load();
  return r.ok;
}

/* âœ… NEW: approve from quick = save then status */
async function approveToPrepQuick(row){
  if(!validateQuickRow(row)) return;
  if(!confirm("ØªØ£ÙƒÙŠØ¯: Ø­ÙØ¸ Ø§Ù„ØªØ¹Ø¯ÙŠÙ„Ø§Øª Ø«Ù… Ø§Ø¹ØªÙ…Ø§Ø¯ ÙˆØ¥Ø±Ø³Ø§Ù„ Ù„Ù„ØªØ¬Ù‡ÙŠØ²ØŸ")) return;

  const ok = await saveQuick(row, true);
  if(!ok){ alert("âŒ Ù„Ù… ÙŠØªÙ… Ø§Ù„Ø­ÙØ¸"); return; }

  const status = "Approved âœ… (Sent to Prep) | FLAG:PREP_SENT";
  const st = await apiUpdateStatus(row, status, {silent:true});
  if(!st.ok){ alert("âŒ ÙØ´Ù„ ØªØ­Ø¯ÙŠØ« Ø§Ù„Ø­Ø§Ù„Ø©"); return; }

  alert("âœ… ØªÙ… Ø§Ù„Ø­ÙØ¸ + Ø§Ù„Ø§Ø¹ØªÙ…Ø§Ø¯ + Ø§Ù„Ø¥Ø±Ø³Ø§Ù„ Ù„Ù„ØªØ¬Ù‡ÙŠØ²");
  await load();
}

async function markReadyQuick(row){
  if(!confirm("ØªØ£ÙƒÙŠØ¯: ÙˆØ¶Ø¹ Ø§Ù„Ø­Ø§Ù„Ø© Ø¬Ø§Ù‡Ø²ØŸ")) return;
  const status = "READY âœ… (××•×›×Ÿ / Ù…Ø¬Ù‡Ø²)";
  const st = await apiUpdateStatus(row, status, {silent:true});
  if(!st.ok) alert("âŒ ÙØ´Ù„ ØªØ­Ø¯ÙŠØ« Ø§Ù„Ø­Ø§Ù„Ø©");
  else { alert("âœ… ØªÙ… ØªØ­Ø¯ÙŠØ« Ø§Ù„Ø­Ø§Ù„Ø©"); await load(); }
}

async function cancelOrder(row){
  if(!confirm("ØªØ£ÙƒÙŠØ¯: Ø¥Ù„ØºØ§Ø¡ Ø§Ù„Ø·Ù„Ø¨ØŸ")) return;
  const status = "CANCELLED âŒ";
  const st = await apiUpdateStatus(row, status, {silent:true});
  if(!st.ok) alert("âŒ ÙØ´Ù„ ØªØ­Ø¯ÙŠØ« Ø§Ù„Ø­Ø§Ù„Ø©");
  else { alert("âœ… ØªÙ… ØªØ­Ø¯ÙŠØ« Ø§Ù„Ø­Ø§Ù„Ø©"); await load(); }
}

async function setStatus(row, status){
  // Ø²Ø± Ø¬Ø§Ù‡Ø² Ø¯Ø§Ø®Ù„ Ø§Ù„Ù…ÙˆØ¯Ø§Ù„/Ø¬Ø¯ÙˆÙ„
  const st = await apiUpdateStatus(row, status, {silent:false});
  if(st.ok){ alert("âœ… ØªÙ… ØªØ­Ø¯ÙŠØ« Ø§Ù„Ø­Ø§Ù„Ø©"); await load(); }
}

/* ================= Confirm customer ================= */
function buildCustomerConfirmMessage(o){
  const name = o.name || "Ø¹Ù…ÙŠÙ„Ù†Ø§";
  const offer = o.offer || "";
  const price = o.price ? `â‚ª${o.price}` : "";
  const payment = o.payment || "";
  const addr = o.addr || o.city || "";
  const orderId = o.orderId || "";
  const days = "3";

  const he = isHebrewText(name) || isHebrewText(addr) || / he\b/i.test(String(o.offer||""));
  if(he){
    const payTxt = payment==="PaidLink" ? "×©×•×œ× ×‘×§×™×©×•×¨" : (payment==="Paid" ? "×©×•×œ×" : (payment==="Cash" ? "××–×•××Ÿ" : payment));
    return (
      `×©×œ×•× ${name} ğŸ‘‹\n`+
      `×ª×•×“×” ×©×”×–×× ×ª ×-MAD Parfumeur ğŸ–¤\n\n`+
      `ğŸ“¦ ××•×¦×¨: ${offer}\n`+
      `ğŸ’° ×¡×›×•×: ${price}\n`+
      `ğŸ’³ ×ª×©×œ×•×: ${payTxt}\n`+
      `ğŸ“ ×›×ª×•×‘×ª: ${addr}\n`+
      `ğŸ§¾ ×”×–×× ×”: ${orderId}\n\n`+
      `×”×”×–×× ×” ×ª×˜×•×¤×œ ×•×ª×™×©×œ×— ×ª×•×š ${days} ×™××™ ×¢×¡×§×™×.\n`+
      `×œ×©×™×¨×•×ª ×œ×§×•×—×•×ª: 9935`
    );
  }

  const payTxt = payment==="PaidLink" ? "Ù…Ø¯ÙÙˆØ¹ Ø¨Ø§Ù„Ø±Ø§Ø¨Ø·" : (payment==="Paid" ? "Ù…Ø¯ÙÙˆØ¹" : (payment==="Cash" ? "Ù†Ù‚Ø¯Ø§Ù‹" : payment));
  return (
    `Ø£Ù‡Ù„Ø§Ù‹ Ø¨Ùƒ ${name} ÙÙŠ Ø¹Ø§Ù„Ù… MAD Parfumeur ğŸ–¤\n`+
    `ØªÙ… ØªØ£ÙƒÙŠØ¯ Ø·Ù„Ø¨Ùƒ Ø¨Ù†Ø¬Ø§Ø­ âœ…\n\n`+
    `ğŸ“¦ Ø§Ù„Ø·Ù„Ø¨: ${offer}\n`+
    `ğŸ’° Ø§Ù„Ø³Ø¹Ø±: ${price}\n`+
    `ğŸ’³ Ø§Ù„Ø¯ÙØ¹: ${payTxt}\n`+
    `ğŸ“ Ø§Ù„Ø¹Ù†ÙˆØ§Ù†: ${addr}\n`+
    `ğŸ§¾ Ø±Ù‚Ù… Ø§Ù„Ø·Ù„Ø¨: ${orderId}\n\n`+
    `Ø³Ù†Ù‚ÙˆÙ… Ø¨ØªØ¬Ù‡ÙŠØ² Ø´Ø­Ù†ØªÙƒ ÙˆØ¥Ø±Ø³Ø§Ù„Ù‡Ø§ Ø®Ù„Ø§Ù„ ${days} Ø£ÙŠØ§Ù… Ø¹Ù…Ù„.\n`+
    `ğŸ“ Ø®Ø¯Ù…Ø© Ø§Ù„Ø¹Ù…Ù„Ø§Ø¡: 9935`
  );
}

async function sendConfirm(row){
  const o = findByRow(row);
  if(!o){ alert("âŒ Ù„Ù… ÙŠØªÙ… Ø§Ù„Ø¹Ø«ÙˆØ± Ø¹Ù„Ù‰ Ø§Ù„Ø·Ù„Ø¨"); return; }
  if(!o.phone){ alert("âŒ Ù„Ø§Ø²Ù… Ø±Ù‚Ù… Ù‡Ø§ØªÙ Ù‚Ø¨Ù„ Ø§Ù„Ø¥Ø±Ø³Ø§Ù„"); return; }
  if(!confirm("Ø¥Ø±Ø³Ø§Ù„ Ø±Ø³Ø§Ù„Ø© ØªØ£ÙƒÙŠØ¯ Ù…Ø­ØªØ±Ù…Ø© Ù„Ù„Ø¹Ù…ÙŠÙ„ØŸ")) return;

  // try endpoint if exists
  try{
    const url = `${SCRIPT_URL}?action=sendCustomerConfirm&key=${encodeURIComponent(DASH_KEY)}&row=${row}`;
    const res = await fetch(url);
    const j = await res.json().catch(()=>null);
    if(j && j.result === "SUCCESS"){
      await appendFlagToNotes(row, "FLAG:CUST_SENT | ØªÙ… Ø§Ø±Ø³Ø§Ù„ Ù„Ù„Ø¹Ù…ÙŠÙ„ âœ…");
      alert("âœ… ØªÙ… Ø¥Ø±Ø³Ø§Ù„ Ø§Ù„ØªØ£ÙƒÙŠØ¯ (API)");
      await load();
      return;
    }
  }catch(e){}

  const msg = buildCustomerConfirmMessage(o);
  const link = waLink(o.phone) + "?text=" + encodeURIComponent(msg);
  window.open(link, "_blank");

  await appendFlagToNotes(row, "FLAG:CUST_SENT | ØªÙ… Ø§Ø±Ø³Ø§Ù„ Ù„Ù„Ø¹Ù…ÙŠÙ„ âœ…");
  alert("âœ… ØªÙ… ÙØªØ­ ÙˆØ§ØªØ³Ø§Ø¨ Ø¨Ø±Ø³Ø§Ù„Ø© Ø¬Ø§Ù‡Ø²Ø©");
  await load();
}

async function appendFlagToNotes(row, flagText){
  try{
    const o = findByRow(row);
    if(!o) return;

    const addr = o.addr || o.city || "";
    const payload = {
      action:"updateOrder",
      key:DASH_KEY,
      row,
      name: o.name || "",
      phone: o.phone || "",
      offer: o.offer || "",
      price: o.price || "",
      payment: o.payment || "",
      proc: o.proc || "",
      addr: addr,
      city: o.city || extractCityLocal(addr),
      source: o.source || "",
      delivery: o.delivery || "",
      extraNotes: flagText
    };
    await apiUpdateOrder(payload, {silent:true});
  }catch(e){}
}

function copySummary(row){
  const o = findByRow(row);
  if(!o){ alert("âŒ Ù„Ù… ÙŠØªÙ… Ø§Ù„Ø¹Ø«ÙˆØ± Ø¹Ù„Ù‰ Ø§Ù„Ø·Ù„Ø¨"); return; }

  const txt =
    `OrderId: ${o.orderId}\n`+
    `Name: ${o.name}\n`+
    `Phone: ${o.phone}\n`+
    `Offer: ${o.offer}\n`+
    `Price: ${o.price||""}\n`+
    `Payment: ${o.payment||""}\n`+
    `Proc: ${o.proc||""}\n`+
    `Addr: ${o.addr||o.city||""}\n`+
    `Delivery: ${o.delivery||""}\n`+
    `Source: ${o.source||""}\n`+
    `Status: ${o.status||""}`;

  navigator.clipboard.writeText(txt).then(()=> alert("âœ… ØªÙ… Ø§Ù„Ù†Ø³Ø®")).catch(()=> prompt("Ø§Ù†Ø³Ø®:", txt));
}

/* ================= Smart Fill (From Notes) ================= */
function smartFillFromNotes(row){
  const o = findByRow(row);
  if(!o){ alert("âŒ Ù„Ù… ÙŠØªÙ… Ø§Ù„Ø¹Ø«ÙˆØ±"); return; }

  const raw = getRawFromNotes(o);
  const parsed = smartParse(raw);

  if(!parsed || (!parsed.phone && !parsed.offer && !parsed.price && !parsed.name)){
    alert("âŒ Ù„Ù… ÙŠØªÙ… Ø§Ù„ØªØ¹Ø±Ù Ø¹Ù„Ù‰ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ù…Ù† Notes");
    return;
  }

  const set = (id, v)=>{
    const el = document.getElementById(id);
    if(el && v) el.value = v;
  };

  set(`name_${row}`, parsed.name || o.name || "");
  set(`phone_${row}`, parsed.phone || o.phone || "");
  set(`offer_${row}`, parsed.offer || o.offer || "");
  set(`price_${row}`, parsed.price || o.price || "");
  if(parsed.payment) set(`payment_${row}`, parsed.payment);
  set(`proc_${row}`, parsed.proc || o.proc || "Direct");
  set(`addr_${row}`, parsed.addr || (o.addr||o.city||""));
  set(`delivery_${row}`, parsed.delivery || o.delivery || "");

  alert("âœ… ØªÙ… Ø§Ù„ØªØ­Ù„ÙŠÙ„ ÙˆØªØ¹Ø¨Ø¦Ø© Ø§Ù„Ø­Ù‚ÙˆÙ„ (ØºÙŠØ± Ù…Ø­ÙÙˆØ¸)");
}

/* ================= PDF for existing row ================= */
function openPdfForRow(row){
  const o = findByRow(row);
  if(!o){ alert("âŒ Ù„Ù… ÙŠØªÙ… Ø§Ù„Ø¹Ø«ÙˆØ±"); return; }

  document.getElementById("modalTitle").textContent = `ğŸ“„ Ø¥Ø¶Ø§ÙØ© PDF â€” ${o.orderId} (#${row})`;
  document.getElementById("modalBody").innerHTML = `
    <div class="card" style="margin:0">
      <div class="hint">
        Ø§Ø±ÙØ¹ PDF (Ø·Ù„Ø¨ Ù…ÙˆÙ‚Ø¹) â†’ Ø³ÙŠØªÙ… Ø§Ø³ØªØ®Ø±Ø§Ø¬ Ø§Ù„Ù†Øµ ÙˆØªØ­Ù„ÙŠÙ„Ù‡ ÙˆØªØ¹Ø¨Ø¦Ø© Ø§Ù„Ø­Ù‚ÙˆÙ„ ÙÙŠ Ø§Ù„ÙƒØ±Øª Ù…Ø¨Ø§Ø´Ø±Ø©.
      </div>
      <div class="row" style="margin-top:10px">
        <input id="pdf_file" type="file" accept="application/pdf"/>
        <button class="btn bviolet" onclick="pdfParseToRow(${row})">ğŸ§  ØªØ­Ù„ÙŠÙ„ PDF</button>
        <button class="btn bgray" onclick="closeModal()">Ø¥ØºÙ„Ø§Ù‚</button>
      </div>
      <div class="hr"></div>
      <div class="field">
        <div class="label">Ø§Ù„Ù†Øµ Ø§Ù„Ù…Ø³ØªØ®Ø±Ø¬ Ù…Ù† PDF</div>
        <textarea id="pdf_text" placeholder="Ø³ÙŠØ¸Ù‡Ø± Ù‡Ù†Ø§ Ø§Ù„Ù†Øµ Ø¨Ø¹Ø¯ Ø§Ù„ØªØ­Ù„ÙŠÙ„..."></textarea>
      </div>
      <div class="small muted">Ø¨Ø¹Ø¯ Ø§Ù„ØªØ­Ù„ÙŠÙ„: Ø§Ø±Ø¬Ø¹ Ù„Ù„ÙƒØ±Øª ÙˆØ§Ø¶ØºØ· â€œğŸ’¾ Ø­ÙØ¸â€ Ø«Ù… â€œâœ… Ø­ÙØ¸ + Ø§Ø¹ØªÙ…Ø§Ø¯â€.</div>
    </div>
  `;
  document.getElementById("modal").classList.add("show");
}

async function pdfParseToRow(row){
  const f = document.getElementById("pdf_file").files[0];
  if(!f){ alert("Ø§Ø®ØªØ± Ù…Ù„Ù PDF"); return; }

  try{
    const text = await extractTextFromPdfFile(f);
    document.getElementById("pdf_text").value = text;

    const parsed = smartParse(text);

    const set = (id, v)=>{
      const el = document.getElementById(id);
      if(el && v) el.value = v;
    };

    set(`name_${row}`, parsed.name || getVal(`name_${row}`));
    set(`phone_${row}`, parsed.phone || getVal(`phone_${row}`));
    set(`offer_${row}`, parsed.offer || getVal(`offer_${row}`));
    set(`price_${row}`, parsed.price || getVal(`price_${row}`));
    if(parsed.payment) set(`payment_${row}`, parsed.payment);
    set(`proc_${row}`, parsed.proc || getVal(`proc_${row}`) || "Direct");
    set(`addr_${row}`, parsed.addr || getVal(`addr_${row}`));
    set(`delivery_${row}`, parsed.delivery || getVal(`delivery_${row}`));

    alert("âœ… ØªÙ… ØªØ­Ù„ÙŠÙ„ PDF ÙˆØªØ¹Ø¨Ø¦Ø© Ø§Ù„Ø­Ù‚ÙˆÙ„ (ØºÙŠØ± Ù…Ø­ÙÙˆØ¸) â€” Ø§Ù„Ø¢Ù† Ø§Ø­ÙØ¸");
  }catch(e){
    alert("âŒ ÙØ´Ù„ ØªØ­Ù„ÙŠÙ„ PDF");
  }
}

/* ================= Pro editor modal ================= */
function openEditor(row, autoParse){
  const o = findByRow(row);
  if(!o){ alert("âŒ Ù„Ù… ÙŠØªÙ… Ø§Ù„Ø¹Ø«ÙˆØ±"); return; }

  document.getElementById("modalTitle").textContent = `ØªØ¹Ø¯ÙŠÙ„ Ù…ØªÙ‚Ø¯Ù‘Ù… â€” ${o.orderId} (#${row})`;
  document.getElementById("modalBody").innerHTML = `
    <div class="split">
      <div class="card" style="margin:0">
        <div class="head">
          <div class="oid">ğŸ§¾ ${esc(o.orderId)} <span class="small">#${row}</span></div>
          <div class="status">${esc(o.status||"")}</div>
        </div>

        <div class="two">
          <button class="btn bviolet" onclick="modalSmartParse(${row})">ğŸ§  ØªØ­Ù„ÙŠÙ„ (Ù…Ù† Ø§Ù„Ù†Øµ)</button>
          <button class="btn bviolet" onclick="modalPdfParse(${row})">ğŸ“„ ØªØ­Ù„ÙŠÙ„ PDF</button>
        </div>

        <div class="two" style="margin-top:10px">
          <button class="btn borange" onclick="modalSave(${row}, false)">ğŸ’¾ Ø­ÙØ¸ Ø§Ù„ØªØ¹Ø¯ÙŠÙ„</button>
          <button class="btn bgreen" onclick="modalSaveAndApprove(${row})">âœ… Ø­ÙØ¸ + Ø§Ø¹ØªÙ…Ø§Ø¯ Ù„Ù„ØªØ¬Ù‡ÙŠØ²</button>
        </div>

        <div class="two" style="margin-top:10px">
          <button class="btn bblue" onclick="sendConfirm(${row})">ğŸ“© ØªØ£ÙƒÙŠØ¯ Ù„Ù„Ø¹Ù…ÙŠÙ„</button>
          <button class="btn bgray" onclick="modalSetReady(${row})">âœ… Ø¬Ø§Ù‡Ø²</button>
        </div>

        <div class="hr"></div>

        <div class="grid">
          ${fieldInput("Ø§Ù„Ø§Ø³Ù…", `m_name`, o.name||"")}
          ${fieldInput("Ø§Ù„Ù‡Ø§ØªÙ", `m_phone`, o.phone||"", true)}
          ${fieldInput("Ø§Ù„Ù…Ø¯ÙŠÙ†Ø©", `m_city`, o.city||"")}
          ${fieldInput("Ø§Ù„Ø¹Ù†ÙˆØ§Ù†", `m_addr`, (o.addr||o.city||""))}
          ${fieldInput("Ø§Ù„Ø·Ù„Ø¨ (C)", `m_offer`, o.offer||"", true)}
          ${fieldInput("Ø§Ù„Ø³Ø¹Ø±", `m_price`, (o.price||""), true)}

          <div class="field">
            <div class="label">Ø·Ø±ÙŠÙ‚Ø© Ø§Ù„Ø¯ÙØ¹</div>
            ${selectHtml(`m_payment`, PAYMENT_OPTIONS, (o.payment||""))}
          </div>

          ${fieldInput("Ø§Ù„Ø¥Ø¬Ø±Ø§Ø¡", `m_proc`, (o.proc||"Direct"))}

          <div class="field">
            <div class="label">Ù…ØµØ¯Ø± Ø§Ù„Ø·Ù„Ø¨ (Ø§Ø®ØªÙŠØ§Ø±ÙŠ)</div>
            ${selectHtml(`m_source`, SOURCE_OPTIONS, (o.source||""))}
          </div>

          ${fieldInput("Ø´Ø±ÙƒØ© Ø§Ù„ØªÙˆØµÙŠÙ„", `m_delivery`, (o.delivery||""))}

          <div class="field" style="grid-column:1/-1">
            <div class="label">Ù†Øµ ÙˆØ§ØªØ³Ø§Ø¨ / Ù†Øµ PDF (Ù„Ù„ØªØ­Ù„ÙŠÙ„)</div>
            <textarea id="m_raw" placeholder="Ø§Ù„ØµÙ‚ Ø§Ù„Ù†Øµ Ù‡Ù†Ø§..."></textarea>
            <div class="row" style="margin-top:10px">
              <input id="m_pdf_file" type="file" accept="application/pdf"/>
              <span class="small muted">Ø§Ø±ÙØ¹ PDF Ø«Ù… Ø§Ø¶ØºØ· â€œğŸ“„ ØªØ­Ù„ÙŠÙ„ PDFâ€.</span>
            </div>
          </div>

          <div class="field" style="grid-column:1/-1">
            <div class="label">Ù…Ù„Ø§Ø­Ø¸Ø§Øª Ø¥Ø¶Ø§ÙÙŠØ© (ØªÙ†Ø¶Ø§Ù Ø¹Ù„Ù‰ Notes)</div>
            <textarea id="m_extraNotes" placeholder="Ù…Ø«Ø§Ù„: Ù…Ù„Ø§Ø­Ø¸Ø© Ù„Ù„Ù…ÙˆØ¸Ù / Ù…Ù„Ø§Ø­Ø¸Ø© Ù„Ù„Ù…Ø¯ÙŠØ±"></textarea>
          </div>

          <div class="field" style="grid-column:1/-1">
            <div class="label">Notes Ø§Ù„Ø­Ø§Ù„ÙŠØ©</div>
            <div class="muted" style="white-space:pre-wrap;word-break:break-word">${esc(o.notes||"")}</div>
          </div>
        </div>

        <div class="subactions">
          <a class="btn bcyan" href="${waLink(o.phone)}" target="_blank" style="text-decoration:none;display:inline-block">ğŸ’¬ ÙØªØ­ ÙˆØ§ØªØ³Ø§Ø¨</a>
          <button class="btn bred" onclick="cancelOrder(${row})">ğŸ›‘ Ø¥Ù„ØºØ§Ø¡</button>
          <button class="btn bgray" onclick="copySummary(${row})">ğŸ“‹ Ù†Ø³Ø®</button>
        </div>
      </div>

      <div class="card" style="margin:0">
        <div class="head">
          <div class="title">Ø­Ø§Ù„Ø§Øª Ø¬Ø§Ù‡Ø²Ø© (Preset)</div>
        </div>

        <div class="row" style="flex-direction:column;align-items:stretch">
          <button class="btn bblue" onclick="setStatus(${row}, 'NEW')">NEW</button>
          <button class="btn bgreen" onclick="setStatus(${row}, 'Approved âœ… (Sent to Prep) | FLAG:PREP_SENT')">Approved âœ…</button>
          <button class="btn bgray" onclick="setStatus(${row}, 'In Prep â³')">In Prep â³</button>
          <button class="btn bgreen" onclick="setStatus(${row}, 'READY âœ… (××•×›×Ÿ / Ù…Ø¬Ù‡Ø²)')">READY âœ…</button>
          <button class="btn borange" onclick="setStatus(${row}, 'Delivery Requested ğŸšš')">Delivery Requested ğŸšš</button>
          <button class="btn bred" onclick="setStatus(${row}, 'CANCELLED âŒ')">CANCELLED âŒ</button>
        </div>

        <div class="small muted" style="margin-top:12px">
          Ø§Ù„ØµÙ‚ Ø§Ù„Ù†Øµ Ø£Ùˆ Ø§Ø±ÙØ¹ PDF Ø«Ù… â€œØªØ­Ù„ÙŠÙ„â€ â†’ â€œØ­ÙØ¸â€ â†’ â€œØ­ÙØ¸ + Ø§Ø¹ØªÙ…Ø§Ø¯â€.
        </div>
      </div>
    </div>
  `;
  document.getElementById("modal").classList.add("show");

  // âœ… ØªØ¹Ø¨Ø¦Ø© textarea Ø¨Ø¯ÙˆÙ† ØªØ´ÙˆÙŠÙ‡ esc()
  const raw = getRawFromNotes(o);
  const ta = document.getElementById("m_raw");
  if(ta) ta.value = raw;

  if(autoParse){
    setTimeout(()=>modalSmartParse(row), 50);
  }
}

function closeModal(){ document.getElementById("modal").classList.remove("show"); }

function modalSmartParse(row){
  const raw = getVal("m_raw");
  const parsed = smartParse(raw);

  const set = (id, v)=>{
    const el = document.getElementById(id);
    if(el && v) el.value = v;
  };

  set("m_name", parsed.name);
  set("m_phone", parsed.phone);
  set("m_offer", parsed.offer);
  set("m_price", parsed.price);
  if(parsed.payment) set("m_payment", parsed.payment);
  set("m_proc", parsed.proc || "Direct");
  set("m_addr", parsed.addr);
  set("m_delivery", parsed.delivery);

  if(!getVal("m_city") && parsed.addr){
    document.getElementById("m_city").value = extractCityLocal(parsed.addr);
  }

  alert("âœ… ØªÙ… Ø§Ù„ØªØ­Ù„ÙŠÙ„ ÙˆØªØ¹Ø¨Ø¦Ø© Ø§Ù„Ø­Ù‚ÙˆÙ„ (ØºÙŠØ± Ù…Ø­ÙÙˆØ¸)");
}

async function modalPdfParse(row){
  const f = document.getElementById("m_pdf_file").files[0];
  if(!f){ alert("Ø§Ø®ØªØ± Ù…Ù„Ù PDF"); return; }
  try{
    const text = await extractTextFromPdfFile(f);
    document.getElementById("m_raw").value = text;
    modalSmartParse(row);
  }catch(e){
    alert("âŒ ÙØ´Ù„ ØªØ­Ù„ÙŠÙ„ PDF");
  }
}

async function modalSave(row, silent){
  const addr = getVal("m_addr");
  const source = getVal("m_source");
  const delivery = getVal("m_delivery");

  const extra = [
    getVal("m_extraNotes"),
    source ? `SOURCE_UI:${source}` : "",
    delivery ? `DELIVERY_UI:${delivery}` : ""
  ].filter(Boolean).join(" | ");

  const payload = {
    action:"updateOrder",
    key:DASH_KEY,
    row,
    name: getVal("m_name"),
    phone: getVal("m_phone"),
    city:  getVal("m_city") || extractCityLocal(addr),
    addr:  addr,
    offer: getVal("m_offer"),
    price: getVal("m_price"),
    payment: getVal("m_payment"),
    proc: getVal("m_proc"),
    source: source,
    delivery: delivery,
    extraNotes: extra
  };

  if(!payload.phone){ alert("âŒ Ù„Ø§Ø²Ù… Ø±Ù‚Ù… Ù‡Ø§ØªÙ"); return false; }
  if(!payload.offer){ alert("âŒ Ù„Ø§Ø²Ù… Ø§Ù„Ø·Ù„Ø¨"); return false; }

  const r = await apiUpdateOrder(payload, {silent:!!silent});
  if(r.ok && !silent) alert("âœ… ØªÙ… Ø§Ù„Ø­ÙØ¸");
  if(r.ok) await load();
  return r.ok;
}

async function modalSaveAndApprove(row){
  if(!confirm("ØªØ£ÙƒÙŠØ¯: Ø­ÙØ¸ Ø§Ù„ØªØ¹Ø¯ÙŠÙ„ Ø«Ù… Ø§Ø¹ØªÙ…Ø§Ø¯ Ù„Ù„ØªØ¬Ù‡ÙŠØ²ØŸ")) return;
  const ok = await modalSave(row, true);
  if(!ok){ alert("âŒ Ù„Ù… ÙŠØªÙ… Ø§Ù„Ø­ÙØ¸"); return; }

  const status = "Approved âœ… (Sent to Prep) | FLAG:PREP_SENT";
  const st = await apiUpdateStatus(row, status, {silent:true});
  if(!st.ok){ alert("âŒ ÙØ´Ù„ ØªØ­Ø¯ÙŠØ« Ø§Ù„Ø­Ø§Ù„Ø©"); return; }

  alert("âœ… ØªÙ… Ø§Ù„Ø­ÙØ¸ + Ø§Ù„Ø§Ø¹ØªÙ…Ø§Ø¯ Ù„Ù„ØªØ¬Ù‡ÙŠØ²");
  await load();
}

async function modalSetReady(row){
  if(!confirm("ØªØ£ÙƒÙŠØ¯: ÙˆØ¶Ø¹ Ø§Ù„Ø­Ø§Ù„Ø© Ø¬Ø§Ù‡Ø²ØŸ")) return;
  const status = "READY âœ… (××•×›×Ÿ / Ù…Ø¬Ù‡Ø²)";
  const st = await apiUpdateStatus(row, status, {silent:true});
  if(!st.ok) alert("âŒ ÙØ´Ù„ ØªØ­Ø¯ÙŠØ« Ø§Ù„Ø­Ø§Ù„Ø©");
  else { alert("âœ… ØªÙ… ØªØ­Ø¯ÙŠØ« Ø§Ù„Ø­Ø§Ù„Ø©"); await load(); }
}

/* ================= Smart New Order ================= */
function openSmartNew(){
  document.getElementById("modalTitle").textContent = "â• Ø¥Ø¶Ø§ÙØ© Ø·Ù„Ø¨ (Ù†Øµ/ PDF) â€” Smart Parse";
  document.getElementById("modalBody").innerHTML = `
    <div class="card" style="margin:0">
      <div class="hint">Ø§Ù„ØµÙ‚ Ù†Øµ ÙˆØ§ØªØ³Ø§Ø¨ Ø£Ùˆ Ø§Ø±ÙØ¹ PDF Ù…Ù† Ù…ÙˆÙ‚Ø¹Ùƒ â€” Ø«Ù… ØªØ­Ù„ÙŠÙ„ â€” Ø«Ù… Ø­ÙØ¸.</div>

      <div class="row" style="margin-top:10px">
        <button class="btn bviolet" onclick="sn_parse()">ğŸ§  ØªØ­Ù„ÙŠÙ„ Ø§Ù„Ù†Øµ</button>
        <button class="btn bviolet" onclick="sn_pdf()">ğŸ“„ ØªØ­Ù„ÙŠÙ„ PDF</button>
        <button class="btn bgreen" onclick="sn_save()">âœ… Ø­ÙØ¸ ÙƒØ·Ù„Ø¨ (Ø¬Ø§Ù‡Ø² Ù„Ù„ØªØ¬Ù‡ÙŠØ²)</button>
        <button class="btn bgray" onclick="sn_fillExample()">ğŸ¯ Ù…Ø«Ø§Ù„</button>
      </div>

      <div class="row" style="margin-top:10px">
        <input id="sn_pdf_file" type="file" accept="application/pdf"/>
        <span class="small muted">Ø§Ø±ÙØ¹ PDF Ø«Ù… Ø§Ø¶ØºØ· â€œğŸ“„ ØªØ­Ù„ÙŠÙ„ PDFâ€.</span>
      </div>

      <div class="hr"></div>

      <div class="field">
        <div class="label">Ø§Ù„Ù†Øµ</div>
        <textarea id="sn_raw" placeholder="Ù…Ø«Ø§Ù„: Ù…Ø­Ù…Ø¯ Ø§Ù„Ù‚Ø¯Ø³ 0525105889 W183 X102 P104 L102 A115 he 500 Ù…Ø¯ÙÙˆØ¹ High Express"></textarea>
      </div>

      <div class="hr"></div>

      <div class="grid">
        ${fieldInput("Ø§Ù„Ø§Ø³Ù…", "sn_name", "")}
        ${fieldInput("Ø§Ù„Ù‡Ø§ØªÙ", "sn_phone", "", true)}
        ${fieldInput("Ø§Ù„Ø·Ù„Ø¨ (C)", "sn_offer", "", true)}
        ${fieldInput("Ø§Ù„Ø³Ø¹Ø±", "sn_price", "", true)}

        <div class="field">
          <div class="label">Ø·Ø±ÙŠÙ‚Ø© Ø§Ù„Ø¯ÙØ¹</div>
          ${selectHtml("sn_payment", PAYMENT_OPTIONS, "")}
        </div>

        ${fieldInput("Ø§Ù„Ø¥Ø¬Ø±Ø§Ø¡", "sn_proc", "Direct")}
        ${fieldInput("Ø§Ù„Ø¹Ù†ÙˆØ§Ù†", "sn_addr", "")}

        <div class="field">
          <div class="label">Ù…ØµØ¯Ø± Ø§Ù„Ø·Ù„Ø¨ (Ø§Ø®ØªÙŠØ§Ø±ÙŠ)</div>
          ${selectHtml("sn_source", SOURCE_OPTIONS, "Manual")}
        </div>

        ${fieldInput("Ø´Ø±ÙƒØ© Ø§Ù„ØªÙˆØµÙŠÙ„", "sn_delivery", "")}
      </div>

      <div class="small muted" style="margin-top:10px">
        Ø§Ù„Ø­ÙØ¸ ÙŠØªÙ… Ø¹Ø¨Ø± POST Ø¥Ù„Ù‰ Ø§Ù„Ø³ÙƒØ±Ø¨Øª.
      </div>
    </div>
  `;
  document.getElementById("modal").classList.add("show");
}

function sn_fillExample(){
  document.getElementById("sn_raw").value = "Ù…Ø­Ù…Ø¯ Ø§Ù„Ù‚Ø¯Ø³ 0525105889 W183 X102 P104 L102 A115 he 500 Ù…Ø¯ÙÙˆØ¹ High Express";
}

function sn_parse(){
  const raw = getVal("sn_raw");
  const p = smartParse(raw);
  const set = (id,v)=>{ const el=document.getElementById(id); if(el) el.value = v||""; };
  set("sn_name", p.name);
  set("sn_phone", p.phone);
  set("sn_offer", p.offer);
  set("sn_price", p.price);
  if(p.payment) set("sn_payment", p.payment);
  set("sn_proc", p.proc || "Direct");
  set("sn_addr", p.addr);
  set("sn_delivery", p.delivery);
  alert("âœ… ØªÙ… Ø§Ù„ØªØ­Ù„ÙŠÙ„ (ØºÙŠØ± Ù…Ø­ÙÙˆØ¸)");
}

async function sn_pdf(){
  const f = document.getElementById("sn_pdf_file").files[0];
  if(!f){ alert("Ø§Ø®ØªØ± Ù…Ù„Ù PDF"); return; }
  try{
    const text = await extractTextFromPdfFile(f);
    document.getElementById("sn_raw").value = text;
    sn_parse();
  }catch(e){
    alert("âŒ ÙØ´Ù„ ØªØ­Ù„ÙŠÙ„ PDF");
  }
}

async function sn_save(){
  const name = getVal("sn_name") || "Customer";
  const phone = getVal("sn_phone");
  const offer = getVal("sn_offer") || "Manual-Order";
  const price = getVal("sn_price") || "";
  const payment = getVal("sn_payment") || "";
  const proc = getVal("sn_proc") || "Direct";
  const addr = getVal("sn_addr") || "-";
  const delivery = getVal("sn_delivery") || "";
  const source = getVal("sn_source") || "Manual";

  if(!phone){
    alert("âŒ Ù„Ø§Ø²Ù… Ø±Ù‚Ù… Ù‡Ø§ØªÙ");
    return;
  }

  const body = {
    name,
    phone,
    offer,
    price,
    payment,
    process: proc,
    address: addr,
    source: source,
    status: "Approved âœ… (Sent to Prep) | FLAG:PREP_SENT",
    extraNotes: delivery ? ("Delivery: " + delivery) : ""
  };

  try{
    const res = await fetch(SCRIPT_URL, {
      method:"POST",
      headers:{ "Content-Type":"application/json" },
      body: JSON.stringify(body)
    });
    const j = await res.json().catch(()=>({}));
    if(j.result !== "SUCCESS"){
      alert("âŒ ÙØ´Ù„ Ø§Ù„Ø­ÙØ¸: " + (j.message||""));
      return;
    }
    alert("âœ… ØªÙ… Ø­ÙØ¸ Ø§Ù„Ø·Ù„Ø¨: " + (j.message||""));
    closeModal();
    await load();
  }catch(e){
    alert("âŒ Ø®Ø·Ø£ Ø§ØªØµØ§Ù„");
  }
}

/* ================= Bulk ================= */
function selectedRows(){
  return Array.from(document.querySelectorAll(".sel"))
    .filter(x=>x.checked)
    .map(x=>Number(x.getAttribute("data-row")));
}
function selectAll(on){ document.querySelectorAll(".sel").forEach(x=>x.checked = !!on); }

async function bulkUpdateStatus(){
  const rows = selectedRows();
  if(!rows.length){ alert("Ø­Ø¯Ø¯ Ø·Ù„Ø¨Ø§Øª Ø£ÙˆÙ„Ø§Ù‹"); return; }
  const status = document.getElementById("bulkStatus").value;
  if(!confirm(`ØªØ·Ø¨ÙŠÙ‚ Ø§Ù„Ø­Ø§Ù„Ø© "${status}" Ø¹Ù„Ù‰ ${rows.length} Ø·Ù„Ø¨ØŸ`)) return;

  let ok = 0;
  for(const r of rows){
    const st = await apiUpdateStatus(r, status, {silent:true});
    if(st.ok) ok++;
  }
  alert(`âœ… ØªÙ… ØªØ­Ø¯ÙŠØ« ${ok}/${rows.length}`);
  await load();
}

async function bulkSendConfirm(){
  const rows = selectedRows();
  if(!rows.length){ alert("Ø­Ø¯Ø¯ Ø·Ù„Ø¨Ø§Øª Ø£ÙˆÙ„Ø§Ù‹"); return; }
  if(!confirm(`Ø¥Ø±Ø³Ø§Ù„ ØªØ£ÙƒÙŠØ¯ Ù„Ù„Ø¹Ù…ÙŠÙ„ Ù„Ù€ ${rows.length} Ø·Ù„Ø¨ØŸ`)) return;

  for(const r of rows){
    await sendConfirm(r);
  }
  await load();
}

/* ================= Notifications ================= */
function updateNotifyUi(){
  if(!("Notification" in window)){
    document.getElementById("notifyState").textContent = "Ù…ØªØµÙØ­Ùƒ Ù„Ø§ ÙŠØ¯Ø¹Ù… Ø¥Ø´Ø¹Ø§Ø±Ø§Øª";
    return;
  }
  const p = Notification.permission;
  document.getElementById("notifyState").textContent =
    (p==="granted") ? "âœ… Ø§Ù„Ø¥Ø´Ø¹Ø§Ø±Ø§Øª Ù…ÙØ¹Ù‘Ù„Ø©" :
    (p==="denied") ? "âŒ Ø§Ù„Ø¥Ø´Ø¹Ø§Ø±Ø§Øª Ù…Ø±ÙÙˆØ¶Ø©" :
    "âšª Ø§Ù„Ø¥Ø´Ø¹Ø§Ø±Ø§Øª ØºÙŠØ± Ù…ÙØ¹Ù‘Ù„Ø©";
}

function enableNotify(){
  if(!("Notification" in window)){
    document.getElementById("notifyState").textContent = "Ù…ØªØµÙØ­Ùƒ Ù„Ø§ ÙŠØ¯Ø¹Ù… Ø¥Ø´Ø¹Ø§Ø±Ø§Øª";
    return;
  }
  Notification.requestPermission().then(()=> updateNotifyUi());
}

/* ================= New Orders Ping ================= */
function pingNewOrders(){
  const newOnes = orders.filter(o => isNewUnapproved(o) && !isPrep(o) && !isReady(o) && !isCancelled(o));
  newOnes.sort((a,b)=>(b.rowIndex||0)-(a.rowIndex||0));
  const newest = newOnes[0] ? `${newOnes[0].orderId}_${newOnes[0].rowIndex}` : "";

  if(firstLoad){
    lastNewKey = newest;
    firstLoad = false;
    return;
  }

  if(newest && newest !== lastNewKey){
    lastNewKey = newest;

    try{
      const ctx = new (window.AudioContext||window.webkitAudioContext)();
      const o = ctx.createOscillator();
      const g = ctx.createGain();
      o.type="sine"; o.frequency.value=880; g.gain.value=0.08;
      o.connect(g); g.connect(ctx.destination);
      o.start(); setTimeout(()=>{o.stop();ctx.close();},180);
    }catch(e){}

    if("Notification" in window && Notification.permission === "granted"){
      new Notification("MAD Manager", { body: "Ø·Ù„Ø¨ Ø¬Ø¯ÙŠØ¯ ØºÙŠØ± Ù…Ø¹ØªÙ…Ø¯ Ø¯Ø®Ù„ Ø§Ù„Ù†Ø¸Ø§Ù… âœ…" });
    }

    document.title = "ğŸŸ¢ Ø·Ù„Ø¨ Ø¬Ø¯ÙŠØ¯ - MAD Manager";
    setTimeout(()=> document.title = "MAD Manager", 5000);
  }
}
</script>

</body>
</html>
