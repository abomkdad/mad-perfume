<!doctype html>
<html lang="ar" dir="rtl">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width,initial-scale=1"/>
  <title>MAD Manager</title>
  <style>
    :root{
      --bg:#060914;
      --card1:rgba(255,255,255,.10);
      --card2:rgba(255,255,255,.06);
      --border:rgba(255,255,255,.12);
      --muted:rgba(255,255,255,.72);
      --green:#16a34a;
      --blue:#2563eb;
      --orange:#f59e0b;
      --red:#dc2626;
      --gray:rgba(255,255,255,.12);
      --pink:#db2777;
      --cyan:#06b6d4;
      --violet:#7c3aed;
    }
    body{margin:0;font-family:system-ui,Segoe UI,Tahoma,Arial;background:var(--bg);color:#fff}
    .top{
      position:sticky;top:0;z-index:50;
      background:rgba(6,9,20,.92);backdrop-filter:blur(10px);
      border-bottom:1px solid var(--border);
      padding:14px;
    }
    .wrap{max-width:1200px;margin:0 auto;padding:16px}
    .row{display:flex;gap:10px;flex-wrap:wrap;align-items:center}
    .title{font-weight:1000;font-size:18px}
    .tag{
      padding:7px 11px;border-radius:999px;
      background:rgba(255,255,255,.10);
      border:1px solid rgba(255,255,255,.10);
      font-weight:1000;
    }
    input,select,textarea{
      font:inherit;border-radius:14px;border:1px solid var(--border);
      background:rgba(255,255,255,.06);color:#fff;padding:12px 12px;outline:none
    }
    textarea{min-height:110px;resize:vertical}
    button{font:inherit;border:none;cursor:pointer}
    .btn{padding:12px 14px;border-radius:14px;font-weight:1100}
    .bgray{background:var(--gray)}
    .bgreen{background:var(--green)}
    .bblue{background:var(--blue)}
    .borange{background:var(--orange);color:#111}
    .bred{background:var(--red)}
    .bpink{background:var(--pink)}
    .bcyan{background:var(--cyan);color:#001018}
    .bviolet{background:var(--violet)}
    .tabs{display:flex;gap:10px;flex-wrap:wrap;margin-top:10px}
    .tab{
      padding:10px 12px;border-radius:999px;
      border:1px solid rgba(255,255,255,.14);
      background:rgba(255,255,255,.08);
      font-weight:1000;opacity:.95
    }
    .tab.active{background:rgba(37,99,235,.30);border-color:rgba(37,99,235,.65)}
    .split{display:grid;grid-template-columns: 1.2fr .8fr;gap:14px}
    @media(max-width:980px){.split{grid-template-columns:1fr}}
    .card{
      background:linear-gradient(180deg,var(--card1),var(--card2));
      border:1px solid var(--border);
      border-radius:20px;
      padding:16px;
      margin:14px 0;
      box-shadow:0 14px 50px rgba(0,0,0,.35);
    }
    .head{display:flex;justify-content:space-between;gap:10px;flex-wrap:wrap;align-items:center;margin-bottom:10px}
    .oid{font-size:18px;font-weight:1000}
    .status{font-weight:1000;background:rgba(255,255,255,.10);border:1px solid rgba(255,255,255,.10);padding:8px 12px;border-radius:999px}
    .badges{display:flex;gap:8px;flex-wrap:wrap;margin-top:8px}
    .badge{
      padding:6px 10px;border-radius:999px;font-weight:1000;
      border:1px solid rgba(255,255,255,.14);
      background:rgba(255,255,255,.08);
    }
    .badge.ok{background:rgba(22,163,74,.18);border-color:rgba(22,163,74,.35)}
    .badge.no{background:rgba(220,38,38,.16);border-color:rgba(220,38,38,.35)}
    .badge.info{background:rgba(6,182,212,.18);border-color:rgba(6,182,212,.35)}
    .badge.warn{background:rgba(245,158,11,.16);border-color:rgba(245,158,11,.35)}
    .grid{display:grid;grid-template-columns:1fr 1fr;gap:10px;margin-top:12px}
    @media(max-width:820px){.grid{grid-template-columns:1fr}}
    .field{
      background:rgba(255,255,255,.06);
      border:1px solid rgba(255,255,255,.12);
      border-radius:16px;
      padding:10px;
    }
    .label{opacity:.85;font-weight:1000;margin-bottom:6px}
    .mono{font-family:ui-monospace,SFMono-Regular,Menlo,Monaco,Consolas,"Liberation Mono","Courier New",monospace}
    .actions{display:grid;grid-template-columns:1fr 1fr;gap:10px;margin-top:14px}
    @media(max-width:820px){.actions{grid-template-columns:1fr}}
    .hugeBtn{padding:18px 16px;border-radius:18px;font-size:18px;font-weight:1200}
    .subactions{display:flex;gap:10px;flex-wrap:wrap;margin-top:10px}
    .small{font-size:12px;opacity:.8}
    .muted{opacity:.82;color:var(--muted)}
    .empty{
      padding:24px;border:1px dashed rgba(255,255,255,.18);
      border-radius:18px;text-align:center;opacity:.88;margin-top:16px
    }
    table{width:100%;border-collapse:separate;border-spacing:0 10px}
    th{font-size:12px;opacity:.8;text-align:right;padding:0 10px}
    td{
      background:rgba(255,255,255,.06);
      border:1px solid rgba(255,255,255,.12);
      padding:10px;border-left:none;border-right:none
    }
    tr td:first-child{border-top-right-radius:14px;border-bottom-right-radius:14px;border-right:1px solid rgba(255,255,255,.12)}
    tr td:last-child{border-top-left-radius:14px;border-bottom-left-radius:14px;border-left:1px solid rgba(255,255,255,.12)}
    .rowBtn{padding:8px 10px;border-radius:12px;font-weight:1100;background:rgba(37,99,235,.22);border:1px solid rgba(37,99,235,.45); color:#fff}
    .dangerBtn{padding:8px 10px;border-radius:12px;font-weight:1100;background:rgba(220,38,38,.22);border:1px solid rgba(220,38,38,.45); color:#fff}
    .okBtn{padding:8px 10px;border-radius:12px;font-weight:1100;background:rgba(22,163,74,.18);border:1px solid rgba(22,163,74,.45); color:#fff}
    .vioBtn{padding:8px 10px;border-radius:12px;font-weight:1100;background:rgba(124,58,237,.18);border:1px solid rgba(124,58,237,.55); color:#fff}

    .modal{position:fixed;inset:0;background:rgba(0,0,0,.55);display:none;align-items:center;justify-content:center;z-index:999}
    .modal .box{width:min(980px,92vw);max-height:90vh;overflow:auto;background:rgba(8,12,26,.96);border:1px solid rgba(255,255,255,.12);border-radius:18px;padding:16px}
    .modal.show{display:flex}

    .hr{height:1px;background:rgba(255,255,255,.10);margin:12px 0}
    .two{display:grid;grid-template-columns:1fr 1fr;gap:10px}
    @media(max-width:820px){.two{grid-template-columns:1fr}}
  </style>
</head>
<body>

<!-- =========================
   Ø¹Ø¯Ù‘Ù„ ÙÙ‚Ø· Ù‡Ø°Ù‡ Ø§Ù„Ù‚ÙŠÙ…
========================= -->
<script>
const SCRIPT_URL = "https://script.google.com/macros/s/AKfycbyLjLFa8AaH82Ip7m747WC-KSUUEaU_M70S0I9Mda14XbnmcuEfZ7pBnF_zzJYZuXmZ/exec";
const DASH_KEY   = "12345678"; // Ù„Ù„Ø¹Ù…Ù„ÙŠØ§Øª (Ø¨Ø¯ÙˆÙ† Ø¨Ø§Ø³ÙˆØ±Ø¯ Ù„Ù„Ù…Ø³ØªØ®Ø¯Ù…)
</script>

<div class="top">
  <div class="wrap">
    <div class="row">
      <div class="title">Ù†Ø³Ø®Ø© Ø§Ù„Ù…Ø¯ÙŠØ± âœ… (Smart Parse)</div>
      <span class="tag" id="stat">...</span>

      <button class="btn bgray" onclick="manualRefresh()">ØªØ­Ø¯ÙŠØ« â†»</button>
      <button class="btn bviolet" onclick="openSmartNew()">â• Ø¥Ø¶Ø§ÙØ© Ø·Ù„Ø¨ Ù…Ù† Ù†Øµ ÙˆØ§ØªØ³Ø§Ø¨</button>

      <button class="btn bblue" id="modeBtn" onclick="toggleMode()">Ø§Ù„ÙˆØ§Ø¬Ù‡Ø©: Ø³Ø±ÙŠØ¹Ø© âš¡</button>

      <input id="q" placeholder="Ø¨Ø­Ø«: Ø§Ø³Ù… / Ø±Ù‚Ù… / ÙƒÙˆØ¯ / OrderId / Ù…Ø¯ÙŠÙ†Ø©" style="flex:1;min-width:280px" oninput="render()"/>

      <select id="filter" onchange="render()">
        <option value="NEW" selected>Ø·Ù„Ø¨Ø§Øª Ø¬Ø¯ÙŠØ¯Ø© (ØºÙŠØ± Ù…Ø¹ØªÙ…Ø¯Ø©)</option>
        <option value="INBOX">ÙˆØ§ØªØ³Ø§Ø¨ Inbox (Ø±Ø³Ø§Ø¦Ù„/PDF)</option>
        <option value="PREP">ØªÙ… Ø¥Ø±Ø³Ø§Ù„ Ù„Ù„ØªØ¬Ù‡ÙŠØ²</option>
        <option value="READY">Ø¬Ø§Ù‡Ø²Ø©</option>
        <option value="ALL">Ø§Ù„ÙƒÙ„</option>
      </select>

      <button class="btn bblue" onclick="enableNotify()">ØªÙØ¹ÙŠÙ„ Ø¥Ø´Ø¹Ø§Ø± Ø§Ù„Ù…ØªØµÙØ­</button>
      <span class="small" id="notifyState"></span>
    </div>

    <div class="tabs">
      <button class="tab active" id="tabQuick" onclick="setTab('quick')">âš¡ Ø¹Ù…Ù„ Ø³Ø±ÙŠØ¹</button>
      <button class="tab" id="tabPro" onclick="setTab('pro')">ğŸ§  Ù…ØªØ·ÙˆÙ‘Ø± Ø¬Ø¯Ù‹Ø§</button>
      <span class="small muted">Smart Parse: Ø­Ù„Ù‘Ù„ Ø±Ø³Ø§Ù„Ø© ÙˆØ§ØªØ³Ø§Ø¨ ØªÙ„Ù‚Ø§Ø¦ÙŠÙ‹Ø§ ÙˆØ¹Ø¨Ù‘ÙŠ Ø§Ù„Ø­Ù‚ÙˆÙ„.</span>
    </div>
  </div>
</div>

<div class="wrap">
  <div id="quickView"></div>
  <div id="proView" style="display:none"></div>
</div>

<!-- Modal (Pro editor) -->
<div class="modal" id="modal">
  <div class="box">
    <div class="row" style="justify-content:space-between">
      <div class="title" id="modalTitle">...</div>
      <button class="btn bgray" onclick="closeModal()">Ø¥ØºÙ„Ø§Ù‚ âœ–</button>
    </div>
    <div id="modalBody" style="margin-top:12px"></div>
  </div>
</div>

<script>
let orders = [];
let mode = localStorage.getItem("mad_manager_mode") || "quick";
let tab  = localStorage.getItem("mad_manager_tab")  || "quick";
let firstLoad = true;
let lastNewKey = "";

start();

async function start(){
  applyTab();
  setModeButton();
  await load();
  setInterval(load, 10000);
}

function setTab(t){
  tab = t;
  localStorage.setItem("mad_manager_tab", tab);
  applyTab();
  render();
}
function applyTab(){
  document.getElementById("tabQuick").classList.toggle("active", tab==="quick");
  document.getElementById("tabPro").classList.toggle("active", tab==="pro");
  document.getElementById("quickView").style.display = (tab==="quick") ? "block" : "none";
  document.getElementById("proView").style.display   = (tab==="pro") ? "block" : "none";
}
function toggleMode(){
  mode = (mode === "quick") ? "pro" : "quick";
  localStorage.setItem("mad_manager_mode", mode);
  setModeButton();
  setTab(mode === "quick" ? "quick" : "pro");
}
function setModeButton(){
  document.getElementById("modeBtn").textContent = (mode==="quick") ? "Ø§Ù„ÙˆØ§Ø¬Ù‡Ø©: Ø³Ø±ÙŠØ¹Ø© âš¡" : "Ø§Ù„ÙˆØ§Ø¬Ù‡Ø©: Ù…ØªØ·ÙˆÙ‘Ø±Ø© ğŸ§ ";
}
function manualRefresh(){ load(); }

async function load(){
  try{
    const res = await fetch(`${SCRIPT_URL}?action=get&_=${Date.now()}`);
    const data = await res.json();
    orders = Array.isArray(data) ? data : [];
    document.getElementById("stat").textContent = `ÙƒÙ„ Ø§Ù„Ø³Ø¬Ù„Ø§Øª: ${orders.length}`;
    render();
    pingNewOrders();
  }catch(e){
    document.getElementById("stat").textContent = "Ø®Ø·Ø£ Ø§ØªØµØ§Ù„";
  }
}

/* ================= Helpers ================= */
function esc(s){ return String(s||"").replace(/[&<>"']/g,m=>({ "&":"&amp;","<":"&lt;",">":"&gt;",'"':"&quot;","'":"&#39;" }[m])); }
function toLower(s){ return String(s||"").toLowerCase(); }
function cleanPhone(s){ return String(s||"").replace(/[^\d+]/g,"").trim(); }

function isInbox(o){
  const offer = toLower(o.offer);
  const notes = toLower(o.notes);
  const src = toLower(o.source);
  return src.includes("whatsapp") && (notes.includes("wa_inbox") || offer.includes("whatsapp"));
}
function isNewUnapproved(o){
  const st = toLower(o.status);
  if(isInbox(o) && st.includes("new")) return true;
  return st === "" || st.includes("new") || st.includes("processing") || st.includes("pending");
}
function isPrep(o){
  const st = toLower(o.status);
  return st.includes("approved") || st.includes("sent to prep") || st.includes("prep") || st.includes("ØªÙ… Ø§Ø±Ø³Ø§Ù„ Ù„Ù„ØªØ¬Ù‡ÙŠØ²");
}
function isReady(o){
  const st = toLower(o.status);
  return st.includes("ready") || st.includes("Ù…Ø¬Ù‡Ø²") || st.includes("××•×›×Ÿ");
}
function isCancelled(o){
  const st = toLower(o.status);
  return st.includes("cancel") || st.includes("Ù…Ù„ØºÙŠ") || st.includes("Ø¥Ù„ØºØ§Ø¡");
}
function flagCustSent(o){
  const s = (toLower(o.notes) + " " + toLower(o.status));
  return s.includes("flag:cust_sent") || s.includes("ØªÙ… Ø§Ø±Ø³Ø§Ù„ Ù„Ù„Ø¹Ù…ÙŠÙ„") || s.includes("cust:âœ…");
}
function flagPrepSent(o){
  const s = (toLower(o.notes) + " " + toLower(o.status));
  return s.includes("flag:prep_sent") || s.includes("sent to prep") || s.includes("approved") || s.includes("ØªÙ… Ø§Ø±Ø³Ø§Ù„ Ù„Ù„ØªØ¬Ù‡ÙŠØ²");
}
function waLink(phone){
  const p = String(phone||"").replace(/[^\d]/g,"");
  if(!p) return "#";
  return `https://wa.me/${p}`;
}
function getVal(id){ return (document.getElementById(id)?.value || "").trim(); }
function findByRow(row){ return orders.find(x => Number(x.rowIndex) === Number(row)); }
function badge(text, kind="info"){ return `<span class="badge ${kind}">${esc(text)}</span>`; }
function extractCityLocal(addr){
  const s = String(addr||"").trim();
  if(!s) return "-";
  return s.split(/[\s,]+/)[0] || "-";
}

/* ================= Smart Parse (Client) ================= */
/**
 * ÙŠÙ‚Ø¨Ù„ Ù†ØµÙˆØµ Ù…Ø±Ù†Ø© Ù…Ø«Ù„:
 * "Ù…Ø­Ù…Ø¯ Ø§Ù„Ù‚Ø¯Ø³ 0525105889 W183 X102 P104 L102 A115 he 500 Ù…Ø¯ÙÙˆØ¹ High Express"
 * Ø£Ùˆ:
 * "ğŸŒŸ ×©×œ×•× ... ×”××•×¦×¨: W183 X102 ... 500 â‚ª ... ×›×ª×•×‘×ª: ..."
 */
function smartParse(txt){
  const t0 = String(txt||"").replace(/\u200f|\u200e/g,"").replace(/\n+/g," ").trim();
  const t = t0.replace(/[|]+/g," | "); // ÙŠØ³Ø§Ø¹Ø¯ Ø¨Ø§Ù„Ù€ Notes

  // phone
  const phoneMatch = t.match(/(\+?972\d{9}|\b05\d{8}\b|\b0?59\d{7,8}\b)/);
  let phone = phoneMatch ? phoneMatch[1] : "";
  phone = normalizePhoneLocal(phone);

  // price
  let price = "";
  const m1 = t.match(/â‚ª\s*(\d{2,5})/);
  if(m1) price = m1[1];
  const m2 = t.match(/\b(\d{2,5})\s*(?:â‚ª|Ø´ÙŠÙƒÙ„|shekel|nis|ils)\b/i);
  if(!price && m2) price = m2[1];
  if(!price){
    const tailNum = t.match(/\b(\d{2,5})\b(?!.*\b(\d{2,5})\b)/);
    if(tailNum) price = tailNum[1];
  }

  // payment
  let payment = "";
  if(/Ù…Ø¯ÙÙˆØ¹|paid|××©×¨××™|×›×¨×˜×™×¡|×‘×›×¨×˜×™×¡|credit/i.test(t)) payment = "Paid";
  else if(/Ù†Ù‚Ø¯|cash|××–×•××Ÿ/i.test(t)) payment = "Cash";

  // delivery
  let delivery = "";
  if(/High\s*Express/i.test(t)) delivery = "High Express";
  else if(/Marwah/i.test(t)) delivery = "Marwah Delivery";
  else if(/Lama/i.test(t)) delivery = "Lama Delivery";
  else if(/Areen/i.test(t)) delivery = "Areen Delivery";

  // offer codes
  const tokens = t.replace(/[:,]/g," ").split(/\s+/).filter(Boolean);
  const codes = tokens.filter(x => /^[A-Za-z]{1,3}\d{2,4}$/i.test(x) || x.toLowerCase()==="he" || x.toLowerCase()==="ar");
  let offer = codes.length ? codes.join(" ") : "";

  // address
  let addr = "";
  const addrHe = t.match(/(?:×›×ª×•×‘×ª|â€×›×ª×•×‘×ª|address)\s*[:ï¼š]\s*([^|]+?)(?=(\s{2,}|$|ğŸš€|×¡×˜×˜×•×¡|status))/i);
  if(addrHe) addr = addrHe[1].trim();
  const addrAr = t.match(/(?:Ø§Ù„Ø¹Ù†ÙˆØ§Ù†|Ø¹Ù†ÙˆØ§Ù†)\s*[:ï¼š]\s*([^|]+?)(?=(\s{2,}|$|ğŸšš|Ø´Ø±ÙƒØ©|Ø§Ù„Ø¯ÙØ¹|Ø§Ù„Ø¥Ø¬Ø±Ø§Ø¡))/i);
  if(!addr && addrAr) addr = addrAr[1].trim();

  // if no addr from keywords, use "city" detected before phone
  let name = "";
  let city = "";
  if(phoneMatch){
    const before = t.slice(0, phoneMatch.index).trim();
    const parts = before.split(/\s+/).filter(Boolean);
    name = parts[0] || "";
    city = parts.slice(1).join(" ") || "";
  }

  if(!addr) addr = city || "";

  // proc
  let proc = "";
  if(/direct|Ø¯ÙˆÙ† ØªÙˆØ§ØµÙ„|Ø¨Ø¯ÙˆÙ† ØªÙˆØ§ØµÙ„|×œ×œ× ×§×©×¨/i.test(t)) proc = "Direct";
  if(/call|Ø§ØªØµØ§Ù„|ØªÙˆØ§ØµÙ„|×˜×œ×¤×•×Ÿ/i.test(t)) proc = proc || "Call";

  // if offer still empty, try "Ø§Ù„Ù…Ø¨Ù„Øº" style or "Ø§Ù„Ù…×•×¦×¨"
  if(!offer){
    const prodHe = t.match(/(?:×”××•×¦×¨|××•×¦×¨)\s*[:ï¼š]\s*([^|]+?)(?=(\s{2,}|$|ğŸ’³|×©×™×˜×ª|×¡×˜×˜×•×¡|ğŸš€))/i);
    if(prodHe) offer = prodHe[1].trim();
    const prodAr = t.match(/(?:Ø§Ù„Ù…Ù†ØªØ¬|Ø§Ù„Ø¹Ø·Ø±)\s*[:ï¼š]\s*([^|]+?)(?=(\s{2,}|$|ğŸ’°|Ø§Ù„Ø¯ÙØ¹|ğŸ“|Ø§Ù„Ø¹Ù†ÙˆØ§Ù†))/i);
    if(!offer && prodAr) offer = prodAr[1].trim();
  }

  return { name, phone, offer, price, payment, proc, addr, delivery, raw:t0 };
}

function normalizePhoneLocal(p){
  if(!p) return "";
  let d = String(p).replace(/[^\d]/g,"");
  if(d.startsWith("00")) d = d.slice(2);
  if(d.startsWith("9720")) d = "972" + d.slice(4);
  if(d.startsWith("059") && d.length >= 10) return "970" + d.slice(1);
  if(d.startsWith("05") && d.length >= 10) return "972" + d.slice(1);
  if(d.startsWith("972") || d.startsWith("970")) return d;
  if(d.length === 10 && d.startsWith("0")) return "972" + d.slice(1);
  if(d.length === 9 && d.startsWith("5")) return "972" + d;
  if(d.length === 9 && d.startsWith("59")) return "970" + d;
  return d;
}

function getRawFromNotes(o){
  const notes = String(o.notes||"");
  // ÙŠØ­Ø§ÙˆÙ„ ÙŠØ·Ù„Ø¹ RAW Ù…Ù† Notes (Ø¥Ù† ÙˆØ¬Ø¯)
  const m = notes.match(/RAW\s*:\s*(.+)$/i);
  if(m) return m[1].trim();
  // Ø¥Ø°Ø§ Notes ÙÙŠÙ‡Ø§ WA_INBOX | ... | Ø§Ù„Ù†Øµ Ø¨Ø¹Ø¯ Ø¢Ø®Ø± |
  if(/WA_INBOX/i.test(notes)){
    const parts = notes.split("|").map(x=>x.trim()).filter(Boolean);
    if(parts.length) return parts[parts.length-1];
  }
  return notes;
}

/* ================= Render ================= */
function render(){
  if(tab === "quick") renderQuick();
  else renderPro();
}

function filtered(){
  const q = toLower(document.getElementById("q").value.trim());
  const f = document.getElementById("filter").value;

  let arr = orders.slice();

  arr = arr.filter(o=>{
    if(!o.name) return false;
    if(isCancelled(o)) return false;
    if(f==="NEW") return isNewUnapproved(o) && !isPrep(o) && !isReady(o);
    if(f==="INBOX") return isInbox(o);
    if(f==="PREP") return isPrep(o) && !isReady(o);
    if(f==="READY") return isReady(o);
    return true;
  });

  if(q){
    arr = arr.filter(o=>{
      const blob = toLower(`${o.orderId} ${o.name} ${o.phone} ${o.offer} ${o.city} ${o.notes} ${o.status} ${o.source}`);
      return blob.includes(q);
    });
  }

  arr.sort((a,b)=>(b.rowIndex||0)-(a.rowIndex||0));
  return arr;
}

/* ================= Quick View ================= */
function renderQuick(){
  const list = document.getElementById("quickView");
  const arr = filtered();

  if(!arr.length){
    list.innerHTML = `<div class="empty">Ù„Ø§ ÙŠÙˆØ¬Ø¯ Ù†ØªØ§Ø¦Ø¬ Ø­Ø³Ø¨ Ø§Ù„ÙÙ„ØªØ± Ø§Ù„Ø­Ø§Ù„ÙŠ âœ…</div>`;
    return;
  }

  list.innerHTML = arr.map(o => quickCard(o)).join("");
}

function quickCard(o){
  const custOk = flagCustSent(o);
  const prepOk = flagPrepSent(o);

  const addr = o.addr || o.city || "";
  const price = o.price || "";
  const pay = o.payment || "";
  const proc = o.proc || "";
  const del = o.delivery || "";

  const inbox = isInbox(o);

  return `
    <div class="card" id="c${o.rowIndex}">
      <div class="head">
        <div class="oid">ğŸ§¾ ${esc(o.orderId)} <span class="small">#${o.rowIndex}</span></div>
        <div class="status">${esc(o.status||"")}</div>
      </div>

      <div class="badges">
        ${badge(prepOk ? "âœ… ØªÙ… Ø¥Ø±Ø³Ø§Ù„ Ù„Ù„ØªØ¬Ù‡ÙŠØ²" : "âŒ ØºÙŠØ± Ù…ÙØ±Ø³Ù„ Ù„Ù„ØªØ¬Ù‡ÙŠØ²", prepOk?"ok":"no")}
        ${badge(custOk ? "âœ… ØªÙ… Ø¥Ø±Ø³Ø§Ù„ Ù„Ù„Ø¹Ù…ÙŠÙ„" : "âŒ Ù„Ù… ÙŠØªÙ… Ø¥Ø±Ø³Ø§Ù„ Ù„Ù„Ø¹Ù…ÙŠÙ„", custOk?"ok":"no")}
        ${inbox ? badge("ğŸ“© WA_INBOX", "warn") : ""}
        ${o.source ? badge("ğŸŒ " + o.source, "info") : ""}
      </div>

      <div class="grid">
        ${fieldInput("Ø§Ù„Ø§Ø³Ù…", `name_${o.rowIndex}`, o.name||"")}
        ${fieldInput("Ø§Ù„Ù‡Ø§ØªÙ", `phone_${o.rowIndex}`, o.phone||"", true)}
        ${fieldInput("Ø§Ù„Ø·Ù„Ø¨ (C)", `offer_${o.rowIndex}`, o.offer||"", true)}
        ${fieldInput("Ø§Ù„Ø³Ø¹Ø±", `price_${o.rowIndex}`, price, true)}
        ${fieldInput("Ø§Ù„Ø¯ÙØ¹", `payment_${o.rowIndex}`, pay)}
        ${fieldInput("Ø§Ù„Ø¥Ø¬Ø±Ø§Ø¡", `proc_${o.rowIndex}`, proc)}
        ${fieldInput("Ø§Ù„Ø¹Ù†ÙˆØ§Ù†", `addr_${o.rowIndex}`, addr)}
        ${fieldInput("Ø´Ø±ÙƒØ© Ø§Ù„ØªÙˆØµÙŠÙ„", `delivery_${o.rowIndex}`, del)}
        <div class="field" style="grid-column:1/-1">
          <div class="label">Ù…Ù„Ø§Ø­Ø¸Ø§Øª (ØªØ¸Ù‡Ø± ÙƒØ§Ù…Ù„Ø©)</div>
          <div class="muted" style="white-space:pre-wrap;word-break:break-word">${esc(o.notes||"")}</div>
        </div>
      </div>

      <div class="actions">
        <button class="btn bgreen hugeBtn" onclick="approveToPrep(${o.rowIndex})">âœ… Ø§Ø¹ØªÙ…Ø§Ø¯ + Ø¥Ø±Ø³Ø§Ù„ Ù„Ù„ØªØ¬Ù‡ÙŠØ²</button>
        <button class="btn bblue hugeBtn" onclick="sendConfirm(${o.rowIndex})">ğŸ“© ØªØ£ÙƒÙŠØ¯ Ù„Ù„Ø¹Ù…ÙŠÙ„</button>
      </div>

      <div class="subactions">
        <button class="btn bviolet" onclick="smartFillFromNotes(${o.rowIndex})">ğŸ§  ØªØ­Ù„ÙŠÙ„ ØªÙ„Ù‚Ø§Ø¦ÙŠ (Ù…Ù† Notes)</button>
        <button class="btn borange" onclick="saveQuick(${o.rowIndex})">ğŸ’¾ Ø­ÙØ¸ Ø§Ù„ØªØ¹Ø¯ÙŠÙ„</button>
        <a class="btn bcyan" href="${waLink(o.phone)}" target="_blank" style="text-decoration:none;display:inline-block">ğŸ’¬ ÙØªØ­ ÙˆØ§ØªØ³Ø§Ø¨</a>
        <button class="btn bgray" onclick="markReady(${o.rowIndex})">âœ… Ø¬Ø§Ù‡Ø²</button>
        <button class="btn bred" onclick="cancelOrder(${o.rowIndex})">ğŸ›‘ Ø¥Ù„ØºØ§Ø¡</button>
        <button class="btn bgray" onclick="copySummary(${o.rowIndex})">ğŸ“‹ Ù†Ø³Ø®</button>
      </div>

      <div class="small muted" style="margin-top:10px">
        Ø¥Ø°Ø§ Ù‡Ø°Ø§ Ø³Ø¬Ù„ ÙˆØ§ØªØ³Ø§Ø¨ Inbox: Ø§Ø¶ØºØ· â€œğŸ§  ØªØ­Ù„ÙŠÙ„ ØªÙ„Ù‚Ø§Ø¦ÙŠâ€ Ø«Ù… â€œğŸ’¾ Ø­ÙØ¸â€ Ø«Ù… â€œâœ… Ø§Ø¹ØªÙ…Ø§Ø¯ + Ø¥Ø±Ø³Ø§Ù„ Ù„Ù„ØªØ¬Ù‡ÙŠØ²â€.
      </div>
    </div>
  `;
}

function fieldInput(label, id, value, mono=false){
  return `
    <div class="field">
      <div class="label">${esc(label)}</div>
      <input id="${id}" value="${esc(value)}" class="${mono?'mono':''}" />
    </div>
  `;
}

/* ================= Pro View ================= */
function renderPro(){
  const host = document.getElementById("proView");
  const arr = filtered();

  const bulkHtml = `
    <div class="card">
      <div class="head">
        <div class="title">ğŸ§  Ø£Ø¯ÙˆØ§Øª Ù…ØªØ·ÙˆØ±Ø© (Bulk)</div>
        <div class="small muted">Ø­Ø¯Ø¯ Ø¹Ø¯Ø© Ø·Ù„Ø¨Ø§Øª Ø«Ù… Ù†ÙÙ‘Ø° Ø¥Ø¬Ø±Ø§Ø¡ ÙˆØ§Ø­Ø¯ Ø¹Ù„ÙŠÙ‡Ù…</div>
      </div>
      <div class="row">
        <button class="btn bgray" onclick="selectAll(true)">ØªØ­Ø¯ÙŠØ¯ Ø§Ù„ÙƒÙ„</button>
        <button class="btn bgray" onclick="selectAll(false)">Ø¥Ù„ØºØ§Ø¡ Ø§Ù„ØªØ­Ø¯ÙŠØ¯</button>

        <select id="bulkStatus" style="min-width:240px">
          <option value="Approved âœ… (Sent to Prep)">Ø§Ø¹ØªÙ…Ø§Ø¯ + Ø¥Ø±Ø³Ø§Ù„ Ù„Ù„ØªØ¬Ù‡ÙŠØ²</option>
          <option value="READY âœ… (××•×›×Ÿ / Ù…Ø¬Ù‡Ø²)">Ø¬Ø§Ù‡Ø²</option>
          <option value="CANCELLED âŒ">Ø¥Ù„ØºØ§Ø¡</option>
        </select>
        <button class="btn bblue" onclick="bulkUpdateStatus()">ØªØ­Ø¯ÙŠØ« Ø§Ù„Ø­Ø§Ù„Ø© Ù„Ù„Ø·Ù„Ø¨Ø§Øª Ø§Ù„Ù…Ø­Ø¯Ø¯Ø©</button>

        <button class="btn bblue" onclick="bulkSendConfirm()">ØªØ£ÙƒÙŠØ¯ Ù„Ù„Ø¹Ù…ÙŠÙ„ (Ù„Ù„Ù…Ø­Ø¯Ø¯)</button>
      </div>
      <div class="small muted" style="margin-top:10px">
        Smart Parse: Ø§ÙØªØ­ Ø£ÙŠ Ø·Ù„Ø¨ ÙˆØ§Ø¶ØºØ· â€œØªØ­Ù„ÙŠÙ„ ØªÙ„Ù‚Ø§Ø¦ÙŠâ€ Ù„Ù…Ù„Ø¡ Ø§Ù„Ø­Ù‚ÙˆÙ„ Ù…Ù† Ø§Ù„Ø±Ø³Ø§Ù„Ø©.
      </div>
    </div>
  `;

  if(!arr.length){
    host.innerHTML = bulkHtml + `<div class="empty">Ù„Ø§ ÙŠÙˆØ¬Ø¯ Ù†ØªØ§Ø¦Ø¬ Ø­Ø³Ø¨ Ø§Ù„ÙÙ„ØªØ± Ø§Ù„Ø­Ø§Ù„ÙŠ âœ…</div>`;
    return;
  }

  const table = `
    <div class="card">
      <div class="head">
        <div class="title">Ø¬Ø¯ÙˆÙ„ Ø§Ù„Ø·Ù„Ø¨Ø§Øª</div>
        <div class="small muted">Ø§Ø¶ØºØ· "ÙØªØ­" Ù„ÙØªØ­ Ù„ÙˆØ­Ø© Ø§Ù„ØªØ¹Ø¯ÙŠÙ„ Ø§Ù„ÙƒØ§Ù…Ù„Ø©</div>
      </div>

      <table>
        <thead>
          <tr>
            <th>âœ“</th>
            <th>OrderId</th>
            <th>Ø§Ù„Ø§Ø³Ù…</th>
            <th>Ø§Ù„Ù‡Ø§ØªÙ</th>
            <th>Ø§Ù„Ø·Ù„Ø¨</th>
            <th>â‚ª</th>
            <th>Ø§Ù„Ø­Ø§Ù„Ø©</th>
            <th>Ø§Ù„Ù…ØµØ¯Ø±</th>
            <th>Ø£ÙˆØ§Ù…Ø±</th>
          </tr>
        </thead>
        <tbody>
          ${arr.map(o=>proRow(o)).join("")}
        </tbody>
      </table>
    </div>
  `;

  host.innerHTML = bulkHtml + table;
}

function proRow(o){
  const price = o.price || "";
  return `
    <tr>
      <td><input type="checkbox" class="sel" data-row="${o.rowIndex}"></td>
      <td class="mono">${esc(o.orderId)}</td>
      <td>${esc(o.name||"")}</td>
      <td class="mono">${esc(o.phone||"")}</td>
      <td class="mono">${esc(o.offer||"")}</td>
      <td class="mono">${esc(price)}</td>
      <td>${esc(o.status||"")}</td>
      <td>${esc(o.source||"")}</td>
      <td>
        <button class="rowBtn" onclick="openEditor(${o.rowIndex})">ÙØªØ­</button>
        <button class="vioBtn" onclick="smartFillFromNotes(${o.rowIndex});openEditor(${o.rowIndex})">ØªØ­Ù„ÙŠÙ„</button>
        <button class="okBtn" onclick="approveToPrep(${o.rowIndex})">Ø¥Ø±Ø³Ø§Ù„ Ù„Ù„ØªØ¬Ù‡ÙŠØ²</button>
        <button class="rowBtn" onclick="sendConfirm(${o.rowIndex})">ØªØ£ÙƒÙŠØ¯</button>
        <button class="dangerBtn" onclick="cancelOrder(${o.rowIndex})">Ø¥Ù„ØºØ§Ø¡</button>
      </td>
    </tr>
  `;
}

/* ================= Actions (shared) ================= */
async function saveQuick(row){
  const addr = getVal(`addr_${row}`);
  const payload = {
    action:"updateOrder",
    key:DASH_KEY,
    row,
    name: getVal(`name_${row}`),
    phone: getVal(`phone_${row}`),
    offer: getVal(`offer_${row}`),
    price: getVal(`price_${row}`),
    payment: getVal(`payment_${row}`),
    proc: getVal(`proc_${row}`),
    addr: addr,
    delivery: getVal(`delivery_${row}`),
    city: extractCityLocal(addr),
    extraNotes: "" // Ø§ØªØ±ÙƒÙ‡Ø§ ÙØ§Ø¶ÙŠØ© Ù‡Ù†Ø§
  };

  const url = `${SCRIPT_URL}?` + new URLSearchParams(payload).toString();
  const res = await fetch(url);
  const j = await res.json().catch(()=>({}));
  if(j.result !== "SUCCESS") alert("âŒ ÙØ´Ù„ Ø§Ù„Ø­ÙØ¸: " + (j.message||""));
  else { alert("âœ… ØªÙ… Ø§Ù„Ø­ÙØ¸"); await load(); }
}

async function approveToPrep(row){
  if(!confirm("ØªØ£ÙƒÙŠØ¯: Ø§Ø¹ØªÙ…Ø§Ø¯ Ø§Ù„Ø·Ù„Ø¨ ÙˆØ¥Ø±Ø³Ø§Ù„Ù‡ Ù„Ù„ØªØ¬Ù‡ÙŠØ²ØŸ")) return;
  const status = "Approved âœ… (Sent to Prep) | FLAG:PREP_SENT";
  await setStatus(row, status);
}

async function markReady(row){
  if(!confirm("ØªØ£ÙƒÙŠØ¯: ÙˆØ¶Ø¹ Ø§Ù„Ø­Ø§Ù„Ø© Ø¬Ø§Ù‡Ø²ØŸ")) return;
  const status = "READY âœ… (××•×›×Ÿ / Ù…Ø¬Ù‡Ø²)";
  await setStatus(row, status);
}

async function cancelOrder(row){
  if(!confirm("ØªØ£ÙƒÙŠØ¯: Ø¥Ù„ØºØ§Ø¡ Ø§Ù„Ø·Ù„Ø¨ØŸ")) return;
  const status = "CANCELLED âŒ";
  await setStatus(row, status);
}

async function setStatus(row, status){
  const url = `${SCRIPT_URL}?action=updateStatus&key=${encodeURIComponent(DASH_KEY)}&row=${row}&status=${encodeURIComponent(status)}`;
  const res = await fetch(url);
  const j = await res.json().catch(()=>({}));
  if(j.result !== "SUCCESS") alert("âŒ ÙØ´Ù„: " + (j.message||""));
  else { alert("âœ… ØªÙ… ØªØ­Ø¯ÙŠØ« Ø§Ù„Ø­Ø§Ù„Ø©"); await load(); }
}

async function sendConfirm(row){
  if(!confirm("Ø¥Ø±Ø³Ø§Ù„ Ø±Ø³Ø§Ù„Ø© ØªØ£ÙƒÙŠØ¯ Ù…Ø­ØªØ±Ù…Ø© Ù„Ù„Ø¹Ù…ÙŠÙ„ØŸ")) return;
  const url = `${SCRIPT_URL}?action=sendCustomerConfirm&key=${encodeURIComponent(DASH_KEY)}&row=${row}`;
  const res = await fetch(url);
  const j = await res.json().catch(()=>({}));

  if(j.result !== "SUCCESS"){
    alert("âŒ ÙØ´Ù„ Ø§Ù„Ø¥Ø±Ø³Ø§Ù„: " + (j.message||""));
    return;
  }

  // âœ… Ù†Ø¶ÙŠÙ Ø¹Ù„Ø§Ù…Ø© Ø£Ù†Ù‡ ØªÙ… Ø§Ø±Ø³Ø§Ù„ Ù„Ù„Ø¹Ù…ÙŠÙ„ (Ù„Ùˆ Ø§Ù„Ø¨Ø§Ùƒ-Ø¥Ù†Ø¯ Ù…Ø§ ÙŠÙƒØªØ¨Ù‡Ø§)
  await appendFlagToNotes(row, "FLAG:CUST_SENT | ØªÙ… Ø§Ø±Ø³Ø§Ù„ Ù„Ù„Ø¹Ù…ÙŠÙ„ âœ…");
  alert("âœ… ØªÙ… Ø¥Ø±Ø³Ø§Ù„ Ø§Ù„ØªØ£ÙƒÙŠØ¯");
  await load();
}

async function appendFlagToNotes(row, flagText){
  try{
    // Ø­Ù„ Ø³Ø±ÙŠØ¹: Ù†Ø³ØªØ®Ø¯Ù… updateOrder Ù…Ø¹ extraNotes (Ù…Ø§ ÙŠØºÙŠÙ‘Ø± Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª)
    const o = findByRow(row);
    if(!o) return;

    const addr = o.addr || o.city || "";
    const payload = {
      action:"updateOrder",
      key:DASH_KEY,
      row,
      name: o.name || "",
      phone: o.phone || "",
      offer: o.offer || "",
      price: o.price || "",
      payment: o.payment || "",
      proc: o.proc || "",
      addr: addr,
      delivery: o.delivery || "",
      city: o.city || extractCityLocal(addr),
      extraNotes: flagText
    };
    const url = `${SCRIPT_URL}?` + new URLSearchParams(payload).toString();
    await fetch(url);
  }catch(e){}
}

function copySummary(row){
  const o = findByRow(row);
  if(!o){ alert("âŒ Ù„Ù… ÙŠØªÙ… Ø§Ù„Ø¹Ø«ÙˆØ± Ø¹Ù„Ù‰ Ø§Ù„Ø·Ù„Ø¨"); return; }

  const txt =
    `OrderId: ${o.orderId}\n`+
    `Name: ${o.name}\n`+
    `Phone: ${o.phone}\n`+
    `Offer: ${o.offer}\n`+
    `Price: ${o.price||""}\n`+
    `Payment: ${o.payment||""}\n`+
    `Proc: ${o.proc||""}\n`+
    `Addr: ${o.addr||o.city||""}\n`+
    `Delivery: ${o.delivery||""}\n`+
    `Status: ${o.status||""}\n`+
    `Source: ${o.source||""}`;

  navigator.clipboard.writeText(txt).then(()=> alert("âœ… ØªÙ… Ø§Ù„Ù†Ø³Ø®")).catch(()=> prompt("Ø§Ù†Ø³Ø®:", txt));
}

/* ================= Smart Fill (From Notes) ================= */
function smartFillFromNotes(row){
  const o = findByRow(row);
  if(!o){ alert("âŒ Ù„Ù… ÙŠØªÙ… Ø§Ù„Ø¹Ø«ÙˆØ±"); return; }

  const raw = getRawFromNotes(o);
  const parsed = smartParse(raw);

  if(!parsed || (!parsed.phone && !parsed.offer && !parsed.price && !parsed.name)){
    alert("âŒ Ù„Ù… ÙŠØªÙ… Ø§Ù„ØªØ¹Ø±Ù Ø¹Ù„Ù‰ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ù…Ù† Notes");
    return;
  }

  // Quick inputs
  const set = (id, v)=>{
    const el = document.getElementById(id);
    if(el && v) el.value = v;
  };

  set(`name_${row}`, parsed.name || o.name || "");
  set(`phone_${row}`, parsed.phone || o.phone || "");
  set(`offer_${row}`, parsed.offer || o.offer || "");
  set(`price_${row}`, parsed.price || o.price || "");
  set(`payment_${row}`, parsed.payment || o.payment || "");
  set(`proc_${row}`, parsed.proc || o.proc || "Direct");
  set(`addr_${row}`, parsed.addr || (o.addr||o.city||""));
  set(`delivery_${row}`, parsed.delivery || o.delivery || "");

  // Ù„Ùˆ Ù…Ø§ ÙÙŠ nameØŒ Ø®Ù„ÙŠ Ø§Ù„Ø§Ø³Ù… Ø§Ù„Ø­Ø§Ù„ÙŠ
  // Ù„Ùˆ Ù…Ø§ ÙÙŠ offer ÙˆØªÙˆØ¬Ø¯ Codes Ø¯Ø§Ø®Ù„ Ø§Ù„Ù†ØµØŒ Ù‡Ùˆ Ø¨ÙŠØ¹Ø¨Ù‘ÙŠ
  alert("âœ… ØªÙ… Ø§Ù„ØªØ­Ù„ÙŠÙ„ ÙˆØªØ¹Ø¨Ø¦Ø© Ø§Ù„Ø­Ù‚ÙˆÙ„");
}

/* ================= Pro editor modal ================= */
function openEditor(row){
  const o = findByRow(row);
  if(!o){ alert("âŒ Ù„Ù… ÙŠØªÙ… Ø§Ù„Ø¹Ø«ÙˆØ±"); return; }

  document.getElementById("modalTitle").textContent = `ØªØ¹Ø¯ÙŠÙ„ Ù…ØªÙ‚Ø¯Ù‘Ù… â€” ${o.orderId} (#${row})`;

  const raw = getRawFromNotes(o);

  const html = `
    <div class="split">
      <div class="card" style="margin:0">
        <div class="head">
          <div class="oid">ğŸ§¾ ${esc(o.orderId)} <span class="small">#${row}</span></div>
          <div class="status">${esc(o.status||"")}</div>
        </div>

        <div class="two">
          <button class="btn bviolet" onclick="modalSmartParse(${row})">ğŸ§  ØªØ­Ù„ÙŠÙ„ ØªÙ„Ù‚Ø§Ø¦ÙŠ (Ù…Ù† Ø§Ù„Ù†Øµ)</button>
          <button class="btn borange" onclick="modalSave(${row})">ğŸ’¾ Ø­ÙØ¸ Ø§Ù„ØªØ¹Ø¯ÙŠÙ„</button>
        </div>

        <div class="hr"></div>

        <div class="grid">
          ${fieldInput("Ø§Ù„Ø§Ø³Ù…", `m_name`, o.name||"")}
          ${fieldInput("Ø§Ù„Ù‡Ø§ØªÙ", `m_phone`, o.phone||"", true)}
          ${fieldInput("Ø§Ù„Ù…Ø¯ÙŠÙ†Ø©", `m_city`, o.city||"")}
          ${fieldInput("Ø§Ù„Ø¹Ù†ÙˆØ§Ù†", `m_addr`, (o.addr||o.city||""))}
          ${fieldInput("Ø§Ù„Ø·Ù„Ø¨ (C)", `m_offer`, o.offer||"", true)}
          ${fieldInput("Ø§Ù„Ø³Ø¹Ø±", `m_price`, (o.price||""), true)}
          ${fieldInput("Ø§Ù„Ø¯ÙØ¹", `m_payment`, (o.payment||""))}
          ${fieldInput("Ø§Ù„Ø¥Ø¬Ø±Ø§Ø¡", `m_proc`, (o.proc||""))}
          ${fieldInput("Ø´Ø±ÙƒØ© Ø§Ù„ØªÙˆØµÙŠÙ„", `m_delivery`, (o.delivery||""))}

          <div class="field" style="grid-column:1/-1">
            <div class="label">Ù†Øµ ÙˆØ§ØªØ³Ø§Ø¨ (Ù„ØªØ­Ù„ÙŠÙ„ ØªÙ„Ù‚Ø§Ø¦ÙŠ)</div>
            <textarea id="m_raw">${esc(raw)}</textarea>
            <div class="small muted" style="margin-top:8px">Ø§Ù„ØµÙ‚ Ù‡Ù†Ø§ Ø£ÙŠ Ø±Ø³Ø§Ù„Ø© ÙˆØ§ØªØ³Ø§Ø¨ ÙˆØ³ÙŠØªÙ… ØªØ¹Ø¨Ø¦Ø© Ø§Ù„Ø­Ù‚ÙˆÙ„ Ø¨Ø²Ø± ÙˆØ§Ø­Ø¯.</div>
          </div>

          <div class="field" style="grid-column:1/-1">
            <div class="label">Ù…Ù„Ø§Ø­Ø¸Ø§Øª Ø¥Ø¶Ø§ÙÙŠØ© (ØªÙ†Ø¶Ø§Ù Ø¹Ù„Ù‰ Notes)</div>
            <textarea id="m_extraNotes" placeholder="Ù…Ø«Ø§Ù„: Ù…Ù„Ø§Ø­Ø¸Ø© Ù„Ù„Ù…ÙˆØ¸Ù / Ù…Ù„Ø§Ø­Ø¸Ø© Ù„Ù„Ù…Ø¯ÙŠØ±"></textarea>
          </div>

          <div class="field" style="grid-column:1/-1">
            <div class="label">Notes Ø§Ù„Ø­Ø§Ù„ÙŠØ©</div>
            <div class="muted" style="white-space:pre-wrap;word-break:break-word">${esc(o.notes||"")}</div>
          </div>
        </div>

        <div class="actions">
          <button class="btn bgreen hugeBtn" onclick="approveToPrep(${row})">âœ… Ø¥Ø±Ø³Ø§Ù„ Ù„Ù„ØªØ¬Ù‡ÙŠØ²</button>
          <button class="btn bblue hugeBtn" onclick="sendConfirm(${row})">ğŸ“© ØªØ£ÙƒÙŠØ¯ Ù„Ù„Ø¹Ù…ÙŠÙ„</button>
        </div>

        <div class="subactions">
          <button class="btn bgray" onclick="markReady(${row})">âœ… Ø¬Ø§Ù‡Ø²</button>
          <button class="btn bred" onclick="cancelOrder(${row})">ğŸ›‘ Ø¥Ù„ØºØ§Ø¡</button>
          <a class="btn bcyan" href="${waLink(o.phone)}" target="_blank" style="text-decoration:none;display:inline-block">ğŸ’¬ ÙØªØ­ ÙˆØ§ØªØ³Ø§Ø¨</a>
          <button class="btn bgray" onclick="copySummary(${row})">ğŸ“‹ Ù†Ø³Ø®</button>
        </div>
      </div>

      <div class="card" style="margin:0">
        <div class="head">
          <div class="title">Ø­Ø§Ù„Ø§Øª Ø¬Ø§Ù‡Ø²Ø© (Preset)</div>
        </div>

        <div class="row" style="flex-direction:column;align-items:stretch">
          <button class="btn bblue" onclick="setStatus(${row}, 'NEW')">NEW</button>
          <button class="btn bgreen" onclick="setStatus(${row}, 'Approved âœ… (Sent to Prep) | FLAG:PREP_SENT')">Approved âœ…</button>
          <button class="btn bgray" onclick="setStatus(${row}, 'In Prep â³')">In Prep â³</button>
          <button class="btn bgreen" onclick="setStatus(${row}, 'READY âœ… (××•×›×Ÿ / Ù…Ø¬Ù‡Ø²)')">READY âœ…</button>
          <button class="btn borange" onclick="setStatus(${row}, 'Delivery Requested ğŸšš')">Delivery Requested ğŸšš</button>
          <button class="btn bred" onclick="setStatus(${row}, 'CANCELLED âŒ')">CANCELLED âŒ</button>
        </div>

        <div class="small muted" style="margin-top:12px">
          Ø¥Ø°Ø§ Ø³Ø¬Ù„ ÙˆØ§ØªØ³Ø§Ø¨ Inbox: Ø§Ù„ØµÙ‚ Ø§Ù„Ù†Øµ Ø«Ù… â€œØªØ­Ù„ÙŠÙ„ ØªÙ„Ù‚Ø§Ø¦ÙŠâ€ Ø«Ù… â€œØ­ÙØ¸â€ Ø«Ù… â€œApproved âœ…â€.
        </div>
      </div>
    </div>
  `;

  document.getElementById("modalBody").innerHTML = html;
  document.getElementById("modal").classList.add("show");
}

function closeModal(){
  document.getElementById("modal").classList.remove("show");
}

function modalSmartParse(row){
  const raw = getVal("m_raw");
  const parsed = smartParse(raw);

  const set = (id, v)=>{
    const el = document.getElementById(id);
    if(el && v) el.value = v;
  };

  set("m_name", parsed.name);
  set("m_phone", parsed.phone);
  set("m_offer", parsed.offer);
  set("m_price", parsed.price);
  set("m_payment", parsed.payment);
  set("m_proc", parsed.proc || "Direct");
  set("m_addr", parsed.addr);
  set("m_delivery", parsed.delivery);

  if(!getVal("m_city") && parsed.addr){
    document.getElementById("m_city").value = extractCityLocal(parsed.addr);
  }

  alert("âœ… ØªÙ… Ø§Ù„ØªØ­Ù„ÙŠÙ„ ÙˆØªØ¹Ø¨Ø¦Ø© Ø§Ù„Ø­Ù‚ÙˆÙ„");
}

async function modalSave(row){
  const addr = getVal("m_addr");
  const payload = {
    action:"updateOrder",
    key:DASH_KEY,
    row,
    name: getVal("m_name"),
    phone: getVal("m_phone"),
    city:  getVal("m_city") || extractCityLocal(addr),
    addr:  addr,
    offer: getVal("m_offer"),
    price: getVal("m_price"),
    payment: getVal("m_payment"),
    proc: getVal("m_proc"),
    delivery: getVal("m_delivery"),
    extraNotes: getVal("m_extraNotes")
  };

  const url = `${SCRIPT_URL}?` + new URLSearchParams(payload).toString();
  const res = await fetch(url);
  const j = await res.json().catch(()=>({}));
  if(j.result !== "SUCCESS") alert("âŒ ÙØ´Ù„ Ø§Ù„Ø­ÙØ¸: " + (j.message||""));
  else { alert("âœ… ØªÙ… Ø§Ù„Ø­ÙØ¸"); await load(); }
}

/* ================= Smart New Order (Paste WhatsApp text -> Save as order) ================= */
function openSmartNew(){
  document.getElementById("modalTitle").textContent = "â• Ø¥Ø¶Ø§ÙØ© Ø·Ù„Ø¨ Ù…Ù† Ù†Øµ ÙˆØ§ØªØ³Ø§Ø¨ (Smart Parse)";
  document.getElementById("modalBody").innerHTML = `
    <div class="card" style="margin:0">
      <div class="label">Ø§Ù„ØµÙ‚ Ù†Øµ ÙˆØ§ØªØ³Ø§Ø¨ Ù‡Ù†Ø§</div>
      <textarea id="sn_raw" placeholder="Ù…Ø«Ø§Ù„: Ù…Ø­Ù…Ø¯ Ø§Ù„Ù‚Ø¯Ø³ 0525105889 W183 X102 P104 L102 A115 he 500 Ù…Ø¯ÙÙˆØ¹ High Express"></textarea>

      <div class="row" style="margin-top:10px">
        <button class="btn bviolet" onclick="sn_parse()">ğŸ§  ØªØ­Ù„ÙŠÙ„</button>
        <button class="btn bgreen" onclick="sn_save()">âœ… Ø­ÙØ¸ ÙƒØ·Ù„Ø¨ (Ø¬Ø§Ù‡Ø² Ù„Ù„ØªØ¬Ù‡ÙŠØ²)</button>
        <button class="btn bgray" onclick="sn_fillExample()">ğŸ¯ Ù…Ø«Ø§Ù„</button>
      </div>

      <div class="hr"></div>

      <div class="grid">
        ${fieldInput("Ø§Ù„Ø§Ø³Ù…", "sn_name", "")}
        ${fieldInput("Ø§Ù„Ù‡Ø§ØªÙ", "sn_phone", "", true)}
        ${fieldInput("Ø§Ù„Ø·Ù„Ø¨ (C)", "sn_offer", "", true)}
        ${fieldInput("Ø§Ù„Ø³Ø¹Ø±", "sn_price", "", true)}
        ${fieldInput("Ø§Ù„Ø¯ÙØ¹", "sn_payment", "")}
        ${fieldInput("Ø§Ù„Ø¥Ø¬Ø±Ø§Ø¡", "sn_proc", "Direct")}
        ${fieldInput("Ø§Ù„Ø¹Ù†ÙˆØ§Ù†", "sn_addr", "")}
        ${fieldInput("Ø´Ø±ÙƒØ© Ø§Ù„ØªÙˆØµÙŠÙ„", "sn_delivery", "")}
      </div>

      <div class="small muted" style="margin-top:10px">
        Ø§Ù„Ø­ÙØ¸ Ù‡Ù†Ø§ ÙŠØªÙ… Ø¹Ø¨Ø± POST Ø¥Ù„Ù‰ Ø§Ù„Ø³ÙƒØ±Ø¨Øª (Ù„Ø§ ÙŠØ¹ØªÙ…Ø¯ WA Webhook).
      </div>
    </div>
  `;
  document.getElementById("modal").classList.add("show");
}

function sn_fillExample(){
  document.getElementById("sn_raw").value = "Ù…Ø­Ù…Ø¯ Ø§Ù„Ù‚Ø¯Ø³ 0525105889 W183 X102 P104 L102 A115 he 500 Ù…Ø¯ÙÙˆØ¹ High Express";
}

function sn_parse(){
  const raw = getVal("sn_raw");
  const p = smartParse(raw);
  const set = (id,v)=>{ const el=document.getElementById(id); if(el) el.value = v||""; };
  set("sn_name", p.name);
  set("sn_phone", p.phone);
  set("sn_offer", p.offer);
  set("sn_price", p.price);
  set("sn_payment", p.payment);
  set("sn_proc", p.proc || "Direct");
  set("sn_addr", p.addr);
  set("sn_delivery", p.delivery);
  alert("âœ… ØªÙ… Ø§Ù„ØªØ­Ù„ÙŠÙ„");
}

async function sn_save(){
  const name = getVal("sn_name") || "Customer";
  const phone = getVal("sn_phone");
  const offer = getVal("sn_offer") || "Manual-WhatsApp";
  const price = getVal("sn_price") || "";
  const payment = getVal("sn_payment") || "";
  const proc = getVal("sn_proc") || "Direct";
  const addr = getVal("sn_addr") || "-";
  const delivery = getVal("sn_delivery") || "";

  if(!phone){
    alert("âŒ Ù„Ø§Ø²Ù… Ø±Ù‚Ù… Ù‡Ø§ØªÙ");
    return;
  }

  const body = {
    name,
    phone,
    offer,
    price,
    payment,
    process: proc,
    address: addr,
    source: "Manager-WhatsApp",
    status: "Approved âœ… (Sent to Prep) | FLAG:PREP_SENT",
    extraNotes: delivery ? ("Delivery: " + delivery) : ""
  };

  try{
    const res = await fetch(SCRIPT_URL, {
      method:"POST",
      headers:{ "Content-Type":"application/json" },
      body: JSON.stringify(body)
    });
    const j = await res.json().catch(()=>({}));
    if(j.result !== "SUCCESS"){
      alert("âŒ ÙØ´Ù„ Ø§Ù„Ø­ÙØ¸: " + (j.message||""));
      return;
    }
    alert("âœ… ØªÙ… Ø­ÙØ¸ Ø§Ù„Ø·Ù„Ø¨: " + (j.message||""));
    closeModal();
    await load();
  }catch(e){
    alert("âŒ Ø®Ø·Ø£ Ø§ØªØµØ§Ù„");
  }
}

/* ================= Bulk ================= */
function selectedRows(){
  return Array.from(document.querySelectorAll(".sel"))
    .filter(x=>x.checked)
    .map(x=>Number(x.getAttribute("data-row")));
}
function selectAll(on){ document.querySelectorAll(".sel").forEach(x=>x.checked = !!on); }

async function bulkUpdateStatus(){
  const rows = selectedRows();
  if(!rows.length){ alert("Ø­Ø¯Ø¯ Ø·Ù„Ø¨Ø§Øª Ø£ÙˆÙ„Ø§Ù‹"); return; }
  const status = document.getElementById("bulkStatus").value;
  if(!confirm(`ØªØ·Ø¨ÙŠÙ‚ Ø§Ù„Ø­Ø§Ù„Ø© "${status}" Ø¹Ù„Ù‰ ${rows.length} Ø·Ù„Ø¨ØŸ`)) return;

  for(const r of rows){
    await setStatus(r, status);
  }
  await load();
}

async function bulkSendConfirm(){
  const rows = selectedRows();
  if(!rows.length){ alert("Ø­Ø¯Ø¯ Ø·Ù„Ø¨Ø§Øª Ø£ÙˆÙ„Ø§Ù‹"); return; }
  if(!confirm(`Ø¥Ø±Ø³Ø§Ù„ ØªØ£ÙƒÙŠØ¯ Ù„Ù„Ø¹Ù…ÙŠÙ„ Ù„Ù€ ${rows.length} Ø·Ù„Ø¨ØŸ`)) return;

  for(const r of rows){
    await sendConfirm(r);
  }
  await load();
}

/* ================= Notifications ================= */
function enableNotify(){
  if(!("Notification" in window)){
    document.getElementById("notifyState").textContent = "Ù…ØªØµÙØ­Ùƒ Ù„Ø§ ÙŠØ¯Ø¹Ù… Ø¥Ø´Ø¹Ø§Ø±Ø§Øª";
    return;
  }
  Notification.requestPermission().then(p=>{
    document.getElementById("notifyState").textContent = (p === "granted") ? "âœ… Ø§Ù„Ø¥Ø´Ø¹Ø§Ø±Ø§Øª Ù…ÙØ¹Ù‘Ù„Ø©" : "âŒ ØªÙ… Ø±ÙØ¶ Ø§Ù„Ø¥Ø´Ø¹Ø§Ø±Ø§Øª";
  });
}

function pingNewOrders(){
  const newOnes = orders.filter(o => isNewUnapproved(o) && !isPrep(o) && !isReady(o) && !isCancelled(o));
  newOnes.sort((a,b)=>(b.rowIndex||0)-(a.rowIndex||0));
  const newest = newOnes[0] ? `${newOnes[0].orderId}_${newOnes[0].rowIndex}` : "";

  if(firstLoad){
    lastNewKey = newest;
    firstLoad = false;
    return;
  }

  if(newest && newest !== lastNewKey){
    lastNewKey = newest;

    try{
      const ctx = new (window.AudioContext||window.webkitAudioContext)();
      const o = ctx.createOscillator();
      const g = ctx.createGain();
      o.type="sine"; o.frequency.value=880; g.gain.value=0.08;
      o.connect(g); g.connect(ctx.destination);
      o.start(); setTimeout(()=>{o.stop();ctx.close();},180);
    }catch(e){}

    if("Notification" in window && Notification.permission === "granted"){
      new Notification("MAD Manager", { body: "Ø·Ù„Ø¨ Ø¬Ø¯ÙŠØ¯ ØºÙŠØ± Ù…Ø¹ØªÙ…Ø¯ Ø¯Ø®Ù„ Ø§Ù„Ù†Ø¸Ø§Ù… âœ…" });
    }

    document.title = "ğŸŸ¢ Ø·Ù„Ø¨ Ø¬Ø¯ÙŠØ¯ - MAD Manager";
    setTimeout(()=> document.title = "MAD Manager", 5000);
  }
}
</script>

</body>
</html>
