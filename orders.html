<!doctype html>
<html lang="ar" dir="rtl">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width,initial-scale=1,maximum-scale=1,user-scalable=0"/>
  <title>MAD Manager v3.7 - Ø§Ù„Ø±Ø§Ø¨Ø· Ø§Ù„Ø¬Ø¯ÙŠØ¯</title>
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">

  <style>
    :root {
      --bg: #0a0f1e;
      --card: #161b2c;
      --primary: #3b82f6;
      --success: #10b981;
      --ready: #f59e0b;
      --hebrew: #8b5cf6;
      --danger: #ef4444;
      --text: #f8fafc;
      --muted: #94a3b8;
      --border: rgba(255,255,255,0.08);
      --grad: linear-gradient(135deg, #3b82f6 0%, #2563eb 100%);
    }

    body {
      margin: 0; font-family: 'Segoe UI', Roboto, system-ui, sans-serif;
      background: var(--bg); color: var(--text); padding-bottom: 90px;
      line-height: 1.5;
    }

    .header {
      background: rgba(16, 21, 36, 0.85); backdrop-filter: blur(12px);
      padding: 12px 16px; position: sticky; top: 0; z-index: 100;
      border-bottom: 1px solid var(--border);
    }

    .container { padding: 16px; max-width: 600px; margin: 0 auto; }

    .order-card {
      background: var(--card); border-radius: 24px; padding: 20px;
      margin-bottom: 20px; border: 1px solid var(--border);
      box-shadow: 0 10px 25px rgba(0,0,0,0.4);
      transition: transform 0.2s;
    }

    .card-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 12px; }
    .order-id { font-family: monospace; color: var(--muted); background: rgba(255,255,255,0.05); padding: 2px 8px; border-radius: 6px; font-size: 13px; }

    .status-pill { font-size: 11px; padding: 4px 12px; border-radius: 20px; font-weight: 700; text-transform: uppercase; }
    .status-new { background: rgba(59, 130, 246, 0.1); color: #60a5fa; }
    .status-prep { background: rgba(16, 185, 129, 0.1); color: #34d399; }

    .customer-name { font-size: 19px; font-weight: 800; display: block; margin-bottom: 4px; }
    .customer-phone { color: var(--muted); font-size: 14px; display: flex; align-items: center; gap: 6px; }
    
    .offer-details {
      margin: 12px 0; padding: 12px; background: rgba(59, 130, 246, 0.05);
      border-radius: 12px; color: #93c5fd; font-weight: 600; border-right: 3px solid var(--primary);
      font-size: 14px;
    }

    .meta-line { display: flex; flex-wrap: wrap; gap: 10px; font-size: 12px; color: var(--muted); margin-top: 8px; }
    .meta-tag { background: rgba(255,255,255,0.05); padding: 2px 8px; border-radius: 6px; }

    .actions-grid { display: grid; grid-template-columns: repeat(4, 1fr); gap: 8px; margin-top: 20px; }
    .actions-secondary { display: grid; grid-template-columns: 1fr 1fr; gap: 8px; margin-top: 8px; }

    .btn {
      padding: 10px 4px; border-radius: 14px; border: none; font-weight: 700;
      cursor: pointer; display: flex; flex-direction: column; align-items: center; justify-content: center;
      font-size: 10px; transition: 0.2s; gap: 6px; text-decoration: none;
    }
    .btn i { font-size: 18px; }
    .btn-primary { background: var(--grad); color: white; }
    .btn-success { background: #059669; color: white; }
    .btn-wa-ar { background: #d97706; color: white; }
    .btn-wa-he { background: #7c3aed; color: white; }
    .btn-outline { background: rgba(255,255,255,0.03); color: white; border: 1px solid var(--border); }

    .modal-overlay {
      position: fixed; inset: 0; background: rgba(0,0,0,0.8); backdrop-filter: blur(8px);
      display: none; align-items: center; justify-content: center; z-index: 2000; padding: 20px;
    }
    .modal-overlay.show { display: flex; }
    .modal-content { background: var(--card); width: 100%; max-width: 420px; padding: 28px; border-radius: 32px; border: 1px solid var(--border); overflow-y: auto; max-height: 85vh; }

    .invoice-box { background: white; color: black; width: 98mm; height: 98mm; padding: 8mm; box-sizing: border-box; display: flex; flex-direction: column; position: relative; border-radius: 2px; }
    .inv-header { text-align: center; border-bottom: 2px solid #000; padding-bottom: 8px; margin-bottom: 10px; }
    .inv-footer { border-top: 2px solid #000; padding-top: 8px; display: flex; justify-content: space-between; align-items: flex-end; }

    input, select, textarea { width: 100%; padding: 12px; margin-bottom: 12px; border-radius: 12px; border: 1px solid var(--border); background: rgba(0,0,0,0.2); color: white; outline: none; font-size: 15px; }

    #toast { position: fixed; bottom: 30px; left: 50%; transform: translateX(-50%); background: #10b981; color: white; padding: 14px 28px; border-radius: 50px; font-weight: 700; z-index: 3000; display: none; box-shadow: 0 10px 20px rgba(0,0,0,0.3); }
    #loadingOverlay { position: fixed; inset: 0; background: rgba(6, 9, 20, 0.7); z-index: 4000; display: none; align-items: center; justify-content: center; backdrop-filter: blur(4px); }
    .spinner { width: 44px; height: 44px; border: 4px solid rgba(59, 130, 246, 0.1); border-top-color: var(--primary); border-radius: 50%; animation: spin 0.8s infinite; }
    @keyframes spin { to { transform: rotate(360deg); } }

    @media print {
      body * { visibility: hidden; }
      #invoicePreview, #invoicePreview * { visibility: visible; }
      #invoicePreview { position: fixed; left: 0; top: 0; width: 98mm; height: 98mm; border: none; padding: 8mm; margin: 0; }
      .no-print { display: none !important; }
      @page { size: 98mm 98mm; margin: 0; }
    }
  </style>
</head>
<body>

<div id="loadingOverlay"><div class="spinner"></div></div>
<div id="toast">âœ… ØªÙ…Øª Ø§Ù„Ø¹Ù…Ù„ÙŠØ©</div>

<!-- Invoice Preview Modal -->
<div class="modal-overlay" id="printModal">
  <div class="invoice-box" id="invoicePreview">
    <div class="inv-header">
      <h1 style="margin:0; font-size: 32px; letter-spacing: 4px; font-weight: 900;">MAD</h1>
      <div style="font-size: 11px; font-weight: 800; color: #333;">PARFUMEUR</div>
      <div style="display: flex; justify-content: space-between; font-size: 10px; font-weight: 900; margin-top:8px; border-top: 1px solid #eee; padding-top: 4px;">
        <span id="p_date">DATE: 00.00.0000</span>
        <span id="p_ord">ORD: MAD-00000</span>
      </div>
    </div>
    <div class="inv-body" id="p_content_lang" style="font-size: 12px; flex-grow: 1; line-height: 1.5;"></div>
    <div class="inv-footer">
      <div style="text-align:center;">
        <img id="p_qr" src="" style="width:48px; height:48px; border:1px solid #000;">
        <div id="p_footer_phone" style="font-size:9px; font-weight:900; margin-top:4px;"></div>
      </div>
      <div id="p_promo" style="font-size: 8px; text-align: center; flex: 1; padding: 0 8px; font-weight: 800;">ğŸ ØµÙˆØ± Ø§Ù„Ù„Ø­Ø¸Ø© ÙˆØ§Ø±Ø³Ù„Ù‡Ø§ ÙˆØ§ØªØ³Ø§Ø¨ ÙˆØ§Ø­ØµÙ„ Ø¹Ù„Ù‰ Ù‡Ø¯ÙŠØ© ÙÙˆØ±ÙŠØ©!</div>
      <div style="text-align: left;">
        <div id="p_label_total" style="font-size: 11px; font-weight: 700;">TOTAL:</div>
        <div style="font-size: 24px; font-weight: 900; color: #000;">â‚ª<span id="p_total">0</span></div>
      </div>
    </div>
    <div style="position: absolute; bottom: -75px; left: 0; right: 0; display: flex; gap: 12px; justify-content: center;" class="no-print">
      <button class="btn btn-outline" onclick="closeModal('printModal')" style="flex-direction:row; padding:10px 20px;">Ø¥Ù„ØºØ§Ø¡</button>
      <button class="btn btn-primary" onclick="window.print()" style="flex-direction:row; padding:10px 20px;"><i class="fa fa-print"></i> Ø·Ø¨Ø§Ø¹Ø© Ø§Ù„ÙˆØµÙ„</button>
    </div>
  </div>
</div>

<!-- Edit Order Modal -->
<div class="modal-overlay" id="editModal">
  <div class="modal-content">
    <h3>ØªØ¹Ø¯ÙŠÙ„ ØªÙØ§ØµÙŠÙ„ Ø§Ù„Ø·Ù„Ø¨</h3>
    <label>Ø§Ù„Ø§Ø³Ù…</label><input type="text" id="f_name">
    <label>Ø§Ù„Ù‡Ø§ØªÙ</label><input type="tel" id="f_phone">
    <label>Ø§Ù„Ø£ØµÙ†Ø§Ù</label><textarea id="f_offer" rows="2"></textarea>
    <div style="display:grid; grid-template-columns: 1fr 1fr; gap:10px;">
      <div><label>Ø§Ù„Ø³Ø¹Ø± (â‚ª)</label><input type="number" id="f_price"></div>
      <div><label>Ø§Ù„Ø¯ÙØ¹</label><select id="f_payment"><option value="Ù†Ù‚Ø¯Ø§Ù‹">Ù†Ù‚Ø¯Ø§Ù‹</option><option value="Ù…Ø¯ÙÙˆØ¹">Ù…Ø¯ÙÙˆØ¹</option></select></div>
    </div>
    <label>Ø§Ù„Ù…Ø¯ÙŠÙ†Ø©</label><input type="text" id="f_city">
    <label>Ù…Ù„Ø§Ø­Ø¸Ø§Øª Ø¥Ø¶Ø§ÙÙŠØ© (Ø§Ù„Ø¹Ù…ÙˆØ¯ G)</label><textarea id="f_notes" rows="2"></textarea>
    <label>Ø´Ø±ÙƒØ© Ø§Ù„ØªÙˆØµÙŠÙ„</label>
    <select id="f_delivery">
      <option value="">-- Ø§Ø®ØªØ± Ø´Ø±ÙƒØ© Ø§Ù„Ø´Ø­Ù† --</option>
      <option value="High Express">High Express</option>
      <option value="Marwah Delivery">Marwah Delivery</option>
      <option value="Lama Delivery">Lama Delivery</option>
      <option value="Pickup">Pickup</option>
    </select>
    <div style="display:grid; grid-template-columns: 1fr 1fr; gap:10px; margin-top:10px;">
      <button class="btn btn-outline" onclick="closeModal('editModal')">Ø¥Ù„ØºØ§Ø¡</button>
      <button class="btn btn-primary" onclick="saveOrder()">Ø­ÙØ¸ ÙˆØªÙ†Ø¸ÙŠÙ Ø§Ù„Ø³Ø·Ø± âœ¨</button>
    </div>
  </div>
</div>

<div class="header">
  <div class="header-top" style="display:flex; justify-content:space-between; align-items:center;">
    <div class="logo" style="font-weight:900; font-size:20px;">MAD <span>MANAGER</span></div>
    <div style="display:flex; gap:10px;">
      <button class="btn btn-outline" onclick="load()" style="width:40px; height:40px;"><i class="fa fa-sync"></i></button>
      <button class="btn btn-primary" onclick="openAddModal()" style="width:40px; height:40px;"><i class="fa fa-plus"></i></button>
    </div>
  </div>
  <div style="margin-top:10px;">
    <input type="text" id="searchInput" placeholder="Ø¨Ø­Ø« Ø¨Ø§Ù„Ø§Ø³Ù… Ø£Ùˆ Ø±Ù‚Ù… Ø§Ù„Ù‡Ø§ØªÙ..." oninput="filterOrders()" style="margin-bottom:0; background:rgba(255,255,255,0.05);">
  </div>
</div>

<div class="container" id="ordersList"></div>

<script>
// âœ… ØªÙ… ØªØ­Ø¯ÙŠØ« Ø§Ù„Ø±Ø§Ø¨Ø· Ø§Ù„Ø¬Ø¯ÙŠØ¯ Ù‡Ù†Ø§
const SCRIPT_URL = "https://script.google.com/macros/s/AKfycbwWi55Q1H1HNdJb61Ht99ZiZodp4B4aaElWSqSuxo37zhKUwRgy8T-NHNPffH4i_Y89Eg/exec";
const DASH_KEY = "12345678";
let allOrders = [];
let editingRow = null;

function showLoading(s) { document.getElementById('loadingOverlay').style.display = s ? 'flex' : 'none'; }
function showToast(m) { const t = document.getElementById('toast'); t.textContent = m; t.style.display = 'block'; setTimeout(() => t.style.display = 'none', 2500); }

const safe = (v) => (v === undefined || v === null || String(v).toLowerCase()==="undefined" || String(v).toLowerCase()==="null") ? "" : String(v).trim();

async function load() {
  showLoading(true);
  try {
    const res = await fetch(`${SCRIPT_URL}?action=get&_=${Date.now()}`);
    allOrders = await res.json();
    renderOrders(allOrders);
  } catch(e) { showToast("Ø®Ø·Ø£ ÙÙŠ Ø¬Ù„Ø¨ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª"); }
  showLoading(false);
}

function filterOrders() {
    const term = document.getElementById('searchInput').value.toLowerCase();
    const filtered = allOrders.filter(o => safe(o.name).toLowerCase().includes(term) || safe(o.phone).includes(term));
    renderOrders(filtered);
}

function renderOrders(list) {
  const container = document.getElementById('ordersList');
  if (list.length === 0) {
    container.innerHTML = `<div style="text-align:center; padding:50px; color:var(--muted);">Ù„Ø§ ØªÙˆØ¬Ø¯ Ø·Ù„Ø¨Ø§Øª Ù„Ø¹Ø±Ø¶Ù‡Ø§</div>`;
    return;
  }
  container.innerHTML = list.filter(o => o.rowIndex).map(o => {
    const isPrep = (o.status || "").includes("ØªØ¬Ù‡ÙŠØ²");
    return `
    <div class="order-card">
      <div class="card-header">
        <small class="order-id">#${safe(o.orderId) || '---'}</small>
        <span class="status-pill ${isPrep ? 'status-prep' : 'status-new'}">${safe(o.status) || 'NEW'}</span>
      </div>
      <div onclick="openEditModal(${o.rowIndex})">
        <span class="customer-name">${safe(o.name)}</span>
        <div class="customer-phone"><i class="fa fa-phone"></i> ${safe(o.phone)}</div>
        <div class="offer-details">${safe(o.offer)}</div>
        <div class="meta-line">
           <span class="meta-tag">ğŸ“ ${safe(o.city)}</span>
           <span class="meta-tag">â‚ª${safe(o.price)}</span>
           <span class="meta-tag">ğŸ’³ ${safe(o.payment)}</span>
           <span class="meta-tag">ğŸšš ${safe(o.delivery)}</span>
        </div>
      </div>
      <div class="actions-grid">
        <button class="btn btn-wa-ar" onclick="sendMsg(${o.rowIndex}, 'ar')"><i class="fa-brands fa-whatsapp"></i><span>Ø¹Ø±Ø¨ÙŠ</span></button>
        <button class="btn btn-wa-he" onclick="sendMsg(${o.rowIndex}, 'he')"><i class="fa-brands fa-whatsapp"></i><span>×¢×‘×¨×™×ª</span></button>
        <button class="btn btn-success" onclick="approve(${o.rowIndex})"><i class="fa fa-check"></i><span>Ø§Ø¹ØªÙ…Ø§Ø¯</span></button>
        <button class="btn btn-outline" onclick="openEditModal(${o.rowIndex})"><i class="fa fa-edit"></i><span>ØªØ¹Ø¯ÙŠÙ„</span></button>
      </div>
      <div class="actions-secondary">
        <button class="btn btn-outline" onclick="openPrintModal(${o.rowIndex}, 'ar')"><i class="fa fa-print"></i><span>ÙˆØµÙ„ Ø¹</span></button>
        <button class="btn btn-outline" onclick="openPrintModal(${o.rowIndex}, 'he')"><i class="fa fa-print"></i><span>ÙˆØµÙ„ Ù‡Ù€</span></button>
      </div>
    </div>`;
  }).join('');
}

async function sendMsg(row, lang) {
  const o = allOrders.find(x => x.rowIndex == row);
  if(!o) return;
  const msg = lang === 'ar' ? 
    `Ø£Ù‡Ù„Ø§Ù‹ Ø¨Ùƒ ${safe(o.name)} ÙÙŠ MAD Parfumeur ğŸ–¤%0AÙŠØ³Ø¹Ø¯Ù†Ø§ ØªØ£ÙƒÙŠØ¯ Ø·Ù„Ø¨Ùƒ Ø§Ù„Ù…Ù…ÙŠØ²!%0AğŸ’ Ø§Ù„Ø¹Ø±Ø¶: ${safe(o.offer)}%0AğŸ“ Ø§Ù„Ø¹Ù†ÙˆØ§Ù†: ${safe(o.city)}%0AğŸ’° Ø§Ù„Ø³Ø¹Ø±: ${safe(o.price)} â‚ª` :
    `×©×œ×•× ${safe(o.name)} ğŸ‘‹, ×ª×•×“×” ×©×”×–×× ×ª ×-MAD Parfumeur%0AğŸ“¦ ×”××•×¦×¨: ${safe(o.offer)}%0AğŸ“ ×›×ª×•×‘×ª: ${safe(o.city)}%0AğŸ’° ××—×™×¨: ${safe(o.price)} â‚ª`;
  window.open(`https://wa.me/${normalizePhone(o.phone)}?text=${msg}`, '_blank');
}

async function approve(row) {
  showLoading(true);
  const o = allOrders.find(x => x.rowIndex == row);
  // Ù†Ø±Ø³Ù„ ÙƒØ§ÙØ© Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ù„Ø¶Ù…Ø§Ù† ØªÙ†Ø¸ÙŠÙ Ø§Ù„Ø³Ø·Ø± ØªÙ…Ø§Ù…Ø§Ù‹ ÙÙŠ Ø§Ù„Ø®Ù„ÙÙŠØ©
  const p = new URLSearchParams({
    action: "updateOrder", key: DASH_KEY, row: row,
    offer: safe(o.offer), name: safe(o.name), phone: safe(o.phone), 
    city: safe(o.city), notes: safe(o.notes), 
    delivery: safe(o.delivery), payment: safe(o.payment), price: safe(o.price),
    status: "Ø¨Ø§Ù†ØªØ¸Ø§Ø± Ø§Ù„Ø¥Ø±Ø³Ø§Ù„ Ù„Ù„ØªØ¬Ù‡ÙŠØ²"
  });
  try {
    await fetch(`${SCRIPT_URL}?${p.toString()}`);
    showToast("ØªÙ… Ø§Ù„Ø§Ø¹ØªÙ…Ø§Ø¯ Ø¨Ù†Ø¬Ø§Ø­ âœ¨");
    load();
  } catch(e) { showToast("ÙØ´Ù„ Ø§Ù„ØªØ­Ø¯ÙŠØ«", true); showLoading(false); }
}

function openEditModal(row) {
  const o = allOrders.find(x => x.rowIndex == row);
  if(!o) return;
  editingRow = row;
  document.getElementById('f_name').value = safe(o.name);
  document.getElementById('f_phone').value = safe(o.phone);
  document.getElementById('f_offer').value = safe(o.offer);
  document.getElementById('f_price').value = safe(o.price);
  document.getElementById('f_payment').value = safe(o.payment) || "Ù†Ù‚Ø¯Ø§Ù‹";
  document.getElementById('f_city').value = safe(o.city);
  document.getElementById('f_notes').value = safe(o.notes);
  document.getElementById('f_delivery').value = safe(o.delivery);
  document.getElementById('editModal').classList.add('show');
}

async function saveOrder() {
  if (!editingRow) return showToast("ÙŠØ±Ø¬Ù‰ Ø§Ø®ØªÙŠØ§Ø± Ø·Ù„Ø¨ Ù„ØªØ¹Ø¯ÙŠÙ„Ù‡");
  showLoading(true);
  const payload = {
    action: "updateOrder", key: DASH_KEY, row: editingRow,
    name: safe(document.getElementById('f_name').value),
    phone: safe(document.getElementById('f_phone').value),
    offer: safe(document.getElementById('f_offer').value),
    price: safe(document.getElementById('f_price').value),
    city: safe(document.getElementById('f_city').value),
    notes: safe(document.getElementById('f_notes').value),
    payment: safe(document.getElementById('f_payment').value),
    delivery: safe(document.getElementById('f_delivery').value),
    status: "NEW" // Ø¹Ù†Ø¯ Ø§Ù„Ø­ÙØ¸ ÙŠØ¹ÙˆØ¯ Ù„Ù„Ø­Ø§Ù„Ø© NEW Ù„Ø¶Ù…Ø§Ù† Ø§Ù„Ù…Ø±Ø§Ø¬Ø¹Ø©
  };
  try {
    const res = await fetch(`${SCRIPT_URL}?` + new URLSearchParams(payload).toString());
    const data = await res.json();
    if(data.result === "SUCCESS") {
      showToast("ØªÙ… Ø§Ù„Ø­ÙØ¸ Ø¨Ù†Ø¬Ø§Ø­ âœ¨");
      closeModal('editModal');
      load();
    }
  } catch(e) { showToast("ÙØ´Ù„ Ø§Ù„Ø­ÙØ¸", true); showLoading(false); }
}

function openPrintModal(row, lang) {
    const o = allOrders.find(x => x.rowIndex == row);
    if (!o) return;
    const now = new Date();
    document.getElementById('p_date').textContent = `DATE: ${now.getDate()}.${now.getMonth()+1}.${now.getFullYear()}`;
    document.getElementById('p_ord').textContent = "ORD: MAD-" + (safe(o.orderId) || "00000");
    document.getElementById('p_total').textContent = safe(o.price) || "0";
    document.getElementById('p_qr').src = `https://api.qrserver.com/v1/create-qr-code/?size=100x100&data=https://wa.me/${normalizePhone(o.phone)}`;
    document.getElementById('p_footer_phone').textContent = safe(o.phone);
    const c = document.getElementById('p_content_lang');
    c.style.direction = "rtl";
    c.innerHTML = lang === 'ar' ? 
      `<strong>Ø§Ù„Ø§Ø³Ù…:</strong> ${safe(o.name)}<br><strong>Ø§Ù„Ù‡Ø§ØªÙ:</strong> ${safe(o.phone)}<br><strong>Ø§Ù„Ø¹Ù†ÙˆØ§Ù†:</strong> ${safe(o.city)}<br><strong>Ø§Ù„ØªÙˆØµÙŠÙ„:</strong> ${safe(o.delivery)}<br><strong>Ø§Ù„Ø¯ÙØ¹:</strong> ${safe(o.payment)}<br><strong>Ø§Ù„Ø£ØµÙ†Ø§Ù:</strong> ${safe(o.offer)}` :
      `<strong>×œ×›×‘×•×“:</strong> ${safe(o.name)}<br><strong>×˜×œ×¤×•×Ÿ:</strong> ${safe(o.phone)}<br><strong>×›×ª×•×‘×ª:</strong> ${safe(o.city)}<br><strong>××©×œ×•×—:</strong> ${safe(o.delivery)}<br><strong>×ª×©×œ×•×:</strong> ${safe(o.payment)}<br><strong>×¤×¨×™×˜×™×:</strong> ${safe(o.offer)}`;
    document.getElementById('printModal').classList.add('show');
}

function closeModal(id) { document.getElementById(id).classList.remove('show'); }
function openAddModal() { showToast("ÙŠØ±Ø¬Ù‰ Ø§Ø³ØªØ®Ø¯Ø§Ù… Ù†Ù…ÙˆØ°Ø¬ Ø§Ù„Ø¥Ø¶Ø§ÙØ© Ù…Ù† Ø§Ù„Ù…ÙˆÙ‚Ø¹ Ø§Ù„Ø±Ø¦ÙŠØ³ÙŠ"); }
function normalizePhone(p) { let d = String(p||"").replace(/\D/g, ""); if (d.startsWith("0")) d = "972" + d.substring(1); return d; }
window.onload = load;
</script>
</body>
</html>
