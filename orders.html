<!DOCTYPE html>
<html lang="he" dir="rtl">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
  <title>MAD System - Smart Integration</title>

  <!-- PWA -->
  <meta name="mobile-web-app-capable" content="yes">
  <meta name="apple-mobile-web-app-capable" content="yes">
  <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
  <meta name="apple-mobile-web-app-title" content="MAD System">
  <link rel="apple-touch-icon" href="https://www.mad-parfumeur.com/assets/hero/logo.png">
  <link rel="icon" type="image/png" href="https://www.mad-parfumeur.com/assets/hero/logo.png">
  <link rel="manifest" href='data:application/manifest+json,{"name":"MAD System","short_name":"MAD","start_url":".","display":"standalone","background_color":"#0f172a","theme_color":"#1e293b","icons":[{"src":"https://www.mad-parfumeur.com/assets/hero/logo.png","sizes":"192x192","type":"image/png"}]}'>

  <script src="https://cdn.jsdelivr.net/npm/jsbarcode@3.11.5/dist/JsBarcode.all.min.js"></script>

  <style>
    :root {
      --primary: #60a5fa;
      --accent: #3b82f6;
      --success: #10b981;
      --warning: #f59e0b;
      --danger: #ef4444;
      --bg-dark: #0f172a;
      --card-dark: #1e293b;
      --text-main: #f8fafc;
      --text-muted: #94a3b8;
    }

    body {
      font-family: 'Segoe UI', Tahoma, sans-serif;
      background-color: var(--bg-dark);
      color: var(--text-main);
      margin: 0; padding: 0;
      display: flex; flex-direction: column; align-items: center;
      min-height: 100vh;
      padding-bottom: 100px;
      overflow-x: hidden;
    }

    .header-ui {
      width: 100%; max-width: 600px; background: #1e293b;
      padding: 15px; box-sizing: border-box;
      position: sticky; top: 0; z-index: 2000;
      box-shadow: 0 4px 10px rgba(0,0,0,0.4);
    }

    .app-logo {
      position: absolute; top: 12px; left: 12px; width: 38px; height: auto;
      filter: drop-shadow(0 2px 4px rgba(0,0,0,0.5));
    }

    .view-title { margin-bottom: 10px; font-weight: bold; font-size: 14px; color: var(--primary); padding-right: 45px; }

    .dash-bar { display: flex; gap: 5px; margin-bottom: 10px; }
    .stat-item { flex: 1; padding: 8px 5px; border-radius: 8px; text-align: center; font-size: 10px; font-weight: bold; background: #0f172a; border: 1px solid #334155; }
    .stat-new { border-bottom: 3px solid var(--warning); }
    .stat-prep { border-bottom: 3px solid var(--accent); }
    .stat-ready { border-bottom: 3px solid var(--success); }

    .search-input{
      width:100%;
      box-sizing:border-box;
      padding:12px 14px;
      border-radius:12px;
      border:1px solid #334155;
      background:#0b1220;
      color:var(--text-main);
      outline:none;
      font-weight:800;
    }
    .search-input::placeholder{ color:#64748b; font-weight:800; }

    .bottom-nav {
      position: fixed; bottom: 0; width: 100%; max-width: 600px;
      background: #1e293b; display: flex; box-shadow: 0 -4px 15px rgba(0,0,0,0.5); z-index: 2000;
    }
    .nav-item { flex: 1; padding: 15px 5px; text-align: center; border: none; background: none; color: var(--text-muted); cursor: pointer; font-weight: bold; font-size: 11px; }
    .nav-item.active { color: var(--primary); border-top: 3px solid var(--primary); background: #0f172a; }

    .section { display: none; width: 95%; max-width: 500px; margin-top: 15px; }
    .section.active { display: block; animation: slideUp 0.3s ease; }
    @keyframes slideUp { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; } }

    .order-card {
      background: var(--card-dark); border-radius: 20px; padding: 20px;
      margin-bottom: 15px; border-right: 12px solid #475569;
      box-shadow: 0 10px 30px rgba(0,0,0,0.4); position: relative;
    }
    .status-new { border-right-color: var(--warning); }
    .status-approved { border-right-color: var(--accent); }
    .status-ready { border-right-color: var(--success); }

    .section-divider {
      color: var(--text-muted); font-size: 11px; font-weight: bold;
      margin: 25px 0 10px 0; border-bottom: 1px solid #334155; padding-bottom: 5px;
      text-align: right; display: flex; justify-content: space-between;
    }

    .info-container { background: #0f172a; padding: 15px; border-radius: 12px; margin: 10px 0; border: 1px solid #334155; }
    .info-row { display: flex; justify-content: space-between; padding: 6px 0; border-bottom: 1px solid #1e293b; }
    .info-row:last-child { border-bottom: none; }
    .info-label { color: var(--text-muted); font-size: 12px; font-weight: bold; }
    .info-val { color: var(--text-main); font-size: 14px; text-align: left; }

    .select-box { margin-top: 10px; padding: 12px; background: #ffffff; border-radius: 12px; border: 2.5px solid var(--primary); }
    .select-label { font-size: 11px; color: #000; font-weight: bold; display: block; margin-bottom: 5px; }
    .select-input { width: 100%; background: transparent; color: #000; border: none; font-size: 15px; font-weight: 900; outline: none; cursor: pointer; }

    .actions-grid { display: grid; grid-template-columns: 1fr 1fr 1fr; gap: 8px; margin-top: 15px; }
    .btn {
      padding: 12px 5px; border-radius: 10px; font-size: 11px; font-weight: bold;
      border: none; cursor: pointer; display: flex; flex-direction: column;
      align-items: center; justify-content: center; gap: 4px; transition: 0.2s;
    }
    .btn:disabled { opacity: 0.2; cursor: not-allowed; filter: grayscale(1); }
    .btn-approve { background: var(--accent); color: white; }
    .btn-wa { background: #065f46; color: #a7f3d0; }
    .btn-print { background: #1e3a8a; color: #bfdbfe; }
    .btn-ready { background: #6b21a8; color: #f3e8ff; }
    .btn-danger { background: #7f1d1d; color: #fecaca; }

    .form-group{ display:flex; flex-direction:column; gap:6px; margin-bottom:12px; }
    .form-group label{ color:var(--text-muted); font-weight:800; font-size:12px; }
    .form-group input, .form-group textarea{
      background:#0b1220; color:var(--text-main); border:1px solid #334155; border-radius:12px;
      padding:12px 12px; outline:none; font-weight:800;
    }

    #notification-toast {
      position: fixed; top: -100px; left: 50%; transform: translateX(-50%);
      background: var(--warning); color: #000; padding: 15px 30px;
      border-radius: 50px; z-index: 10001; font-weight: 800; transition: 0.6s;
      box-shadow: 0 10px 20px rgba(0,0,0,0.5);
    }
    #notification-toast.show { top: 25px; }

    #print-container { display: none; }
    @media print {
      body * { visibility: hidden; }
      #print-container, #print-container * { visibility: visible; }
      #print-container { display: block !important; position: absolute; left: 0; top: 0; width: 100%; }
      .print-page { width: 100mm; height: 100mm; margin: 0 auto; padding: 5mm; box-sizing: border-box; background: white; color: black; }
    }

    .hint {
      font-size: 11px;
      color: var(--text-muted);
      margin-top: 6px;
      line-height: 1.4;
    }
  </style>
</head>

<body>
  <div id="notification-toast">ğŸ”” ×”×–×× ×” ×—×“×©×” ×‘××¢×¨×›×ª!</div>

  <div id="app-ui">
    <div class="header-ui">
      <img src="https://www.mad-parfumeur.com/assets/hero/logo.png" alt="MAD Logo" class="app-logo">
      <div id="view-label" class="view-title">×œ×•×— ×‘×§×¨×” ×× ×”×œ</div>

      <div class="dash-bar">
        <div class="stat-item stat-new">×—×“×©: <span id="count-new">0</span></div>
        <div class="stat-item stat-prep">×‘×ª×”×œ×™×š: <span id="count-prep">0</span></div>
        <div class="stat-item stat-ready">××•×›×Ÿ: <span id="count-ready">0</span></div>
      </div>

      <div id="audioActivation" style="margin-bottom: 10px;">
        <button class="btn" style="width: 100%; background: var(--success); color:white; flex-direction: row; font-size: 13px;" onclick="activateAudio()">
          <span>ğŸ”Š</span> ×”×¤×¢×œ×ª ×¨×˜×˜ ×•×¦×œ×™×œ (ØªÙØ¹ÙŠÙ„ Ø¬Ø±Ø³ Ø§Ù„ØªÙ†Ø¨ÙŠÙ‡)
        </button>
      </div>

      <input type="text" class="search-input" id="searchInput" placeholder="×—×™×¤×•×© ×œ×¤×™ ×©× Ø£Ùˆ Ø·×œ×¤×•×Ÿ..." oninput="renderTab()">
    </div>

    <!-- Manager -->
    <div id="section-manage" class="section">
      <div id="managerList"></div>
    </div>

    <!-- Preparer -->
    <div id="section-prep" class="section">
      <div id="preparerList"></div>
    </div>

    <!-- Add -->
    <div id="section-add" class="section">

      <!-- âœ… WhatsApp Smart Box -->
      <div class="card" style="background: var(--card-dark); padding: 20px; border-radius: 16px; border: 1px solid #334155; margin-bottom: 14px;">
        <h4 style="margin:0 0 12px 0; text-align: center; color: var(--success);">ğŸ“¥ Ø¨ÙˆÙƒØ³ ÙˆØ§ØªØ³Ø§Ø¨ Ø°ÙƒÙŠ â€” ØªØ­Ù„ÙŠÙ„ + Ø§Ø¹ØªÙ…Ø§Ø¯ + Ø¥Ø±Ø³Ø§Ù„</h4>

        <div class="form-group">
          <label>Ø§Ù„ØµÙ‚ Ø±Ø³Ø§Ù„Ø© ÙˆØ§ØªØ³Ø§Ø¨ Ù‡Ù†Ø§ (Ø£ÙŠ Ø´ÙƒÙ„)</label>
          <textarea id="wa_raw" rows="5" placeholder="Ø§Ù„ØµÙ‚ Ø§Ù„Ø±Ø³Ø§Ù„Ø© Ù‡Ù†Ø§..."></textarea>
          <div class="hint">âœ… Ø§Ù„Ù†Ø¸Ø§Ù… ÙŠÙ„ØªÙ‚Ø· ØªÙ„Ù‚Ø§Ø¦ÙŠÙ‹Ø§: Ø§Ù„Ø§Ø³Ù… + Ø§Ù„Ù‡Ø§ØªÙ + Ø§Ù„Ø¹Ù†ÙˆØ§Ù† + Ø§Ù„ÙƒÙˆØ¯/Ø§Ù„Ø¹Ø±Ø¶ (Ø¥Ø°Ø§ Ù…ÙˆØ¬ÙˆØ¯)</div>
        </div>

        <div class="form-group">
          <label>Ø§Ù„Ø³Ø¹Ø± (â‚ª) â€” Ù„Ù„Ø·Ù„Ø¨</label>
          <input type="number" id="wa_price" value="150" min="0" inputmode="numeric">
        </div>

        <button class="btn" style="width: 100%; background: #0ea5e9; color:white; padding: 14px; font-size: 14px; margin-bottom: 10px;" onclick="parseWhatsAppToForm()">
          ğŸ§  ØªØ­Ù„ÙŠÙ„ Ø§Ù„Ø±Ø³Ø§Ù„Ø© ÙˆØªØ¹Ø¨Ø¦Ø© Ø§Ù„Ø­Ù‚ÙˆÙ„
        </button>

        <div class="select-box" style="margin-top: 10px;">
          <span class="select-label">Ø§Ø®ØªØ± Ø´Ø±ÙƒØ© Ø§Ù„ØªÙˆØµÙŠÙ„ (Ù…Ø·Ù„ÙˆØ¨ Ù„Ù„Ø§Ø¹ØªÙ…Ø§Ø¯):</span>
          <select class="select-input" id="wa_delivery">
            <option value="">-- Ø§Ø®ØªØ± Ø´Ø±ÙƒØ© --</option>
            <option value="High Express">High Express</option>
            <option value="Marwah Delivery">Marwah Delivery</option>
            <option value="Lama Delivery">Lama Delivery</option>
            <option value="Areen Delivery">Areen Delivery</option>
          </select>
        </div>

        <button class="btn" style="width: 100%; background: var(--success); color:white; padding: 15px; font-size: 15px; margin-top: 10px;" onclick="sendSmartApproved()">
          âœ… Ø¥Ø±Ø³Ø§Ù„ ÙˆØ§Ø¹ØªÙ…Ø§Ø¯ Ù…Ø¨Ø§Ø´Ø±Ø© Ù„Ù„Ø´ÙŠØª
        </button>

        <div class="hint">Ø¨Ø¹Ø¯ Ø§Ù„Ø¥Ø±Ø³Ø§Ù„: Ø§Ù„Ø·Ù„Ø¨ ÙŠØ¯Ø®Ù„ Ø§Ù„Ø´ÙŠØª Ø¨Ø­Ø§Ù„Ø© <b>Approved âœ…</b> ÙˆÙŠØ¸Ù‡Ø± ÙÙˆØ±Ù‹Ø§ ÙÙŠ <b>ğŸ“¦ ×”×›× ×”</b>.</div>
      </div>

      <!-- Manual Add -->
      <div class="card" style="background: var(--card-dark); padding: 20px; border-radius: 16px; border: 1px solid #334155;">
        <h4 style="margin:0 0 15px 0; text-align: center; color: var(--primary);">ğŸ“ Ø±ÙŠØ´×•× ×”×–×× ×” ×—×“×©×” (ÙŠØ¯ÙˆÙŠ)</h4>

        <div class="form-group"><label>Ø§Ø³Ù… Ø§Ù„Ø²Ø¨ÙˆÙ†</label><input type="text" id="in_name"></div>
        <div class="form-group"><label>Ø§Ù„Ù‡Ø§ØªÙ</label><input type="tel" id="in_phone"></div>
        <div class="form-group"><label>Ø§Ù„Ø¹Ù†ÙˆØ§Ù†</label><input type="text" id="in_addr"></div>
        <div class="form-group"><label>Ø§Ù„Ø·Ù„Ø¨ (C)</label><input type="text" id="in_offer"></div>

        <div class="form-group"><label>Ø§Ù„Ø³Ø¹Ø± (â‚ª)</label><input type="number" id="in_price" value="150" min="0" inputmode="numeric"></div>

        <div class="form-group"><label>Ù…Ù„Ø§Ø­Ø¸Ø§Øª (G)</label><textarea id="in_notes" rows="2"></textarea></div>

        <button class="btn" style="width: 100%; background: var(--accent); color: white; padding: 15px; font-size: 15px;" onclick="saveOrder()">×©××™×¨×ª ×”×–×× ×” âœ…</button>
      </div>

    </div>
  </div>

  <div class="bottom-nav">
    <button class="nav-item active" id="nav-manage" onclick="switchTab('manage')">âš™ï¸ ×× ×”×œ</button>
    <button class="nav-item" id="nav-prep" onclick="switchTab('prep')">ğŸ“¦ ×”×›× ×”</button>
    <button class="nav-item" id="nav-add" onclick="switchTab('add')">â• ×”×•×¡×¤×”</button>
  </div>

  <div id="print-container"></div>

  <script>
    // âœ… Ø¶Ø¹ Ø±Ø§Ø¨Ø· Apps Script Web App /exec
    const SCRIPT_URL = "https://script.google.com/macros/s/AKfycbz90B0wz9cj9XcVlrW3tg9i2Af2a2aIo86nfgY9lopfFnx4KGVBwjZ91g-1uP6UaX8Y/exec";
    const MANAGER_PHONE = "972509787730";

    let allOrders = [];
    let currentTab = 'manage';
    let localStatusMap = {};
    let managerDeliveryMap = {};
    let employeeNameMap = {};
    let localPriceMap = {}; // âœ… Ø£Ø³Ø¹Ø§Ø± Ù…Ø­Ù„ÙŠØ© Ø­ØªÙ‰ Ø§Ù„Ø­ÙØ¸

    let lastTotalCount = 0;
    let isInitialLoad = true;
    let audioCtx;

    function switchTab(tab) {
      currentTab = tab;
      document.querySelectorAll('.section').forEach(s => s.classList.remove('active'));
      document.querySelectorAll('.nav-item').forEach(n => n.classList.remove('active'));
      document.getElementById('section-' + tab).classList.add('active');
      document.getElementById('nav-' + tab).classList.add('active');

      const labels = {
        'manage': '×œ×•×— ×‘×§×¨×” ×× ×”×œ - ××™×©×•×¨ ×•×ØªØ§Ø¨Ø¹Ø©',
        'prep': '××¢×¨×›×ª ×”×›× ×” - Ù…Ø±Ø¨Ø¹Ø§Øª ××œ××™×',
        'add': 'Ø±×™×©×•× ×”×–×× ×” ×—×“×©×” + Ø¨ÙˆÙƒØ³ ÙˆØ§ØªØ³Ø§Ø¨ Ø°ÙƒÙŠ'
      };
      document.getElementById('view-label').innerText = labels[tab];
      syncData();
    }

    async function syncData() {
      try {
        const res = await fetch(`${SCRIPT_URL}?action=get&t=${Date.now()}`);
        const data = await res.json();

        if (!isInitialLoad && Array.isArray(data) && data.length > lastTotalCount) {
          triggerAlert("×”×–×× ×” ×—×“×©×” ×‘××¢×¨×›×ª!");
        }

        lastTotalCount = Array.isArray(data) ? data.length : 0;
        isInitialLoad = false;

        allOrders = Array.isArray(data) ? data : [];
        updateDashboard(allOrders);
        renderTab();
      } catch(e) { console.error("Sync Error", e); }
    }

    function updateDashboard(data) {
      const stats = { new: 0, prep: 0, ready: 0 };
      data.forEach(o => {
        const s = localStatusMap[o.orderId] || o.status || "";
        if (String(s).includes("Canceled") || String(s).includes("âŒ")) return;
        if (String(s).includes("Delivered")) return;

        if (String(s).includes("××•×›×Ÿ")) stats.ready++;
        else if (String(s).includes("Approved") || String(s).includes("×××•×©×¨")) stats.prep++;
        else stats.new++;
      });
      document.getElementById('count-new').innerText = stats.new;
      document.getElementById('count-prep').innerText = stats.prep;
      document.getElementById('count-ready').innerText = stats.ready;
    }

    function getOrderPrice_(o){
      const p = localPriceMap[o.orderId] || o.price || "150";
      return String(p).replace(/[^\d]/g,'') || "150";
    }

    function renderTab() {
      const query = (document.getElementById('searchInput').value || "").toLowerCase();
      let data = [...allOrders].reverse();

      if (currentTab === 'manage') {
        const filtered = data.filter(o => (String(o.name||"").toLowerCase().includes(query) || String(o.phone||"").includes(query)));
        renderManager(filtered);
      } else if (currentTab === 'prep') {
        const prepData = data.filter(o => {
          const s = localStatusMap[o.orderId] || o.status || "";
          return (String(s).includes("Approved") || String(s).includes("×××•×©×¨")) &&
                 !String(s).includes("Delivered") && !String(s).includes("××•×›×Ÿ") && !String(s).includes("Canceled");
        }).filter(o => (String(o.name||"").toLowerCase().includes(query) || String(o.phone||"").includes(query)));
        renderPreparer(prepData);
      }
    }

    function renderManager(orders) {
      const list = document.getElementById('managerList');

      const newOrders = orders.filter(o => {
        const s = localStatusMap[o.orderId] || o.status || "";
        return !String(s).includes("Approved") && !String(s).includes("×××•×©×¨") && !String(s).includes("××•×›×Ÿ") &&
               !String(s).includes("Delivered") && !String(s).includes("Canceled");
      });

      const inWorkOrders = orders.filter(o => {
        const s = localStatusMap[o.orderId] || o.status || "";
        return (String(s).includes("Approved") || String(s).includes("×××•×©×¨")) &&
               !String(s).includes("××•×›×Ÿ") && !String(s).includes("Delivered") && !String(s).includes("Canceled");
      });

      const readyOrders = orders.filter(o => {
        const s = localStatusMap[o.orderId] || o.status || "";
        return String(s).includes("××•×›×Ÿ") && !String(s).includes("Delivered") && !String(s).includes("Canceled");
      });

      let html = '<div class="section-divider">×”×–×× ×•×ª ×—×“×©×•×ª (Ø¨Ø§Ù†ØªØ¸Ø§Ø± Ø§Ù„Ø§Ø¹ØªÙ…Ø§Ø¯) <span>'+newOrders.length+'</span></div>';
      html += newOrders.map(o => createManagerCard(o, 'new')).join('');

      html += '<div class="section-divider">×‘×˜×™×¤×•×œ ×¢×•×‘×“×•×ª (Ù‚ÙŠØ¯ Ø§Ù„ØªØ¬Ù‡ÙŠØ²) <span>'+inWorkOrders.length+'</span></div>';
      html += inWorkOrders.map(o => createManagerCard(o, 'approved')).join('');

      html += '<div class="section-divider" style="color:var(--success)">×”×–×× ×•×ª ××•×›× ×•×ª (Ø¬Ø§Ù‡Ø² Ù„Ù„ØªÙˆØµÙŠÙ„ âœ…) <span>'+readyOrders.length+'</span></div>';
      html += readyOrders.map(o => createManagerCard(o, 'ready')).join('');

      list.innerHTML = html;
    }

    function createManagerCard(o, type) {
      const s = localStatusMap[o.orderId] || o.status || "×—×“×©";
      const delivery = managerDeliveryMap[o.orderId] || "";
      const isReady = type === 'ready';
      const isApproved = type === 'approved' || isReady;

      const price = getOrderPrice_(o);

      return `
        <div class="order-card ${isReady ? 'status-ready' : (isApproved ? 'status-approved' : 'status-new')}">
          <div style="display:flex; justify-content:space-between; align-items:center;">
            <b style="font-size:16px;">${o.name || "-"}</b>
            <span style="font-size:9px; background:#334155; padding:2px 6px; border-radius:4px;">${s}</span>
          </div>
          <div style="font-size:12px; color:var(--text-muted); margin:4px 0;">
            ğŸ“ ${o.phone || "-"} | ğŸ“ ${o.city || '-'} | ğŸ’° â‚ª${price}
          </div>

          <div style="font-size:13px; background:#0f172a; padding:10px; border-radius:10px; margin-top:5px; border:1px solid #1e293b;">
            ğŸ“¦ ${o.offer || "-"}
          </div>

          <!-- âœ… Price Edit for Manager -->
          <div class="select-box" style="border-color: var(--warning);">
            <span class="select-label">ğŸ’° ØªØ¹Ø¯ÙŠÙ„ Ø§Ù„Ø³Ø¹Ø± (â‚ª):</span>
            <input
              style="width:100%; background:transparent; border:none; outline:none; font-size:18px; font-weight:900; color:#000;"
              type="number" min="0" value="${price}"
              oninput="localPriceMap['${o.orderId}']=this.value"
            />
            <button class="btn" style="margin-top:10px; width:100%; background: var(--warning); color:#000; flex-direction:row;"
              onclick="updatePrice('${o.orderId}', '${o.rowIndex}', (localPriceMap['${o.orderId}']||'${price}'))">
              ğŸ’¾ Ø­ÙØ¸ Ø§Ù„Ø³Ø¹Ø±
            </button>
          </div>

          ${!isReady ? `
          <div class="select-box" style="${isApproved ? 'opacity:0.5; pointer-events:none;' : ''}">
            <span class="select-label">×‘×—×¨ ×—×‘×¨×ª ××©×œ×•×—×™×:</span>
            <select class="select-input" onchange="managerDeliveryMap['${o.orderId}']=this.value; renderTab();">
              <option value="">-- ×‘×—×¨ ×—×‘×¨×” --</option>
              <option value="High Express" ${delivery==='High Express'?'selected':''}>High Express</option>
              <option value="Marwah Delivery" ${delivery==='Marwah Delivery'?'selected':''}>Marwah Delivery</option>
              <option value="Lama Delivery" ${delivery==='Lama Delivery'?'selected':''}>Lama Delivery</option>
              <option value="Areen Delivery" ${delivery==='Areen Delivery'?'selected':''}>Areen Delivery</option>
            </select>
          </div>` : ''}

          <div class="actions-grid">
            ${!isReady ? `<button class="btn btn-approve" ${isApproved || !delivery ? 'disabled' : ''} onclick="updateStatus('${o.orderId}', '${o.rowIndex}', 'Approved âœ… (××©×œ×•×—: ${delivery})')">âœ… Ø§Ø¹ØªÙ…Ø§Ø¯</button>` : ''}
            <button class="btn btn-wa" onclick="sendWA('AR', '${o.phone || ''}', '${o.name || ''}', '${o.offer || ''}', '${o.orderId || ''}', '${price}')">ğŸ’¬ ÙˆØ§ØªØ³Ø§Ø¨</button>
            ${isReady
              ? `<button class="btn" style="background:var(--success); color:white;" onclick="updateStatus('${o.orderId}', '${o.rowIndex}', 'Delivered âœ…')">âœ… ØªØ³Ù„ÙŠÙ… Ù„Ù„Ù…Ù†Ø¯ÙˆØ¨</button>`
              : `<button class="btn btn-danger" onclick="updateStatus('${o.orderId}', '${o.rowIndex}', 'Canceled âŒ')">âŒ Ø¥Ù„ØºØ§Ø¡</button>`
            }
          </div>

          ${isReady ? `<div style="margin-top:10px; padding:5px; background:rgba(16,185,129,0.1); border-radius:8px; color:var(--success); font-weight:bold; font-size:11px; text-align:center; border:1px dashed var(--success);">${s}</div>` : ''}
        </div>
      `;
    }

    function renderPreparer(orders) {
      const list = document.getElementById('preparerList');
      if (orders.length === 0) {
        list.innerHTML = '<p style="text-align:center; padding:30px; color:var(--text-muted);">××™×Ÿ ×”×–×× ×•×ª ×××•×©×¨×•×ª (Ù„Ø§ ØªÙˆØ¬Ø¯ Ø·Ù„Ø¨Ø§Øª Ù…Ø¹ØªÙ…Ø¯Ø©)</p>';
        return;
      }

      list.innerHTML = orders.map(o => {
        const id = o.orderId || o.phone;
        const s = localStatusMap[o.orderId] || o.status || "";
        const empName = employeeNameMap[id] || "";
        const delMatch = String(s).match(/\(××©×œ×•×—: (.*?)\)/);
        const delCompany = delMatch ? delMatch[1] : "Ù„Ù… ÙŠØ­Ø¯Ø¯";
        const price = getOrderPrice_(o);

        return `
          <div class="order-card status-approved">
            <div style="text-align:center; border-bottom:1px solid #334155; padding-bottom:10px; margin-bottom:10px;">
              <b style="font-size:18px; color:var(--primary);">×¤×¨×˜×™ ×”×–×× ×” - Ù…Ø±Ø¨Ø¹ ÙƒØ§Ù…Ù„</b>
            </div>

            <div class="info-container">
              <div class="info-row"><span class="info-label">×©× ×œ×§×•×—:</span><span class="info-val">${o.name || "-"}</span></div>
              <div class="info-row"><span class="info-label">×˜×œ×¤×•×Ÿ:</span><span class="info-val">${o.phone || "-"}</span></div>
              <div class="info-row"><span class="info-label">×›×ª×•×‘×ª:</span><span class="info-val">${o.city || '-'}</span></div>
              <div class="info-row"><span class="info-label">××—×™×¨:</span><span class="info-val" style="font-weight:900; color: var(--warning);">â‚ª${price}</span></div>
              <div class="info-row" style="margin-top:8px; border-top:1px dashed #334155; padding-top:8px;">
                <span class="info-label">×”×–×× ×” (C):</span><span class="info-val" style="color:var(--warning); font-weight:bold;">${o.offer || "-"}</span>
              </div>
              <div class="info-row"><span class="info-label">×”×¢×¨×•×ª:</span><span class="info-val">${o.notes || '××™×Ÿ'}</span></div>
              <div class="info-row" style="background:var(--accent); color:white; padding:6px; border-radius:8px; margin-top:8px;">
                <span class="info-label" style="color:white;">×—×‘×¨×ª ××©×œ×•×—:</span><span class="info-val" style="font-weight:900;">${delCompany}</span>
              </div>
            </div>

            <div class="select-box ${!empName ? 'required' : ''}">
              <span class="select-label">××™ ××›×™× ×”? (Ø¹Ø¨ÙŠØ±ØŒ Ø£Ù„Ø§Ø¡ØŒ Ù„ÙŠÙ„Ù‰):</span>
              <select class="select-input" onchange="employeeNameMap['${id}']=this.value; renderTab();">
                <option value="">-- ×‘×—×¨ ×©× ×¢×•×‘×“×ª --</option>
                <option value="Ø¹Ø¨ÙŠØ± (×¢×‘×™×¨)" ${empName==='Ø¹Ø¨ÙŠØ± (×¢×‘×™×¨)'?'selected':''}>Ø¹Ø¨ÙŠØ± (×¢×‘×™×¨)</option>
                <option value="Ø£Ù„Ø§Ø¡ (××œ××)" ${empName==='Ø£Ù„Ø§Ø¡ (××œ××)'?'selected':''}>Ø£Ù„Ø§Ø¡ (××œ××)</option>
                <option value="Ù„ÙŠÙ„Ù‰ (×œ×™×™×œ×)" ${empName==='Ù„ÙŠÙ„Ù‰ (×œ×™×™×œ×)'?'selected':''}>Ù„ÙŠÙ„Ù‰ (×œ×™×™×œ×)</option>
              </select>
            </div>

            <div class="actions-grid">
              <button class="btn btn-print" onclick="printSticker(${JSON.stringify(o).replace(/"/g, '&quot;')}, '${delCompany}', '${price}')">ğŸ–¨ï¸ Ù…Ù„ØµÙ‚</button>
              <button class="btn btn-ready" ${!empName ? 'disabled' : ''} onclick="finalizeReady('${o.orderId}', '${o.rowIndex}', '${o.name || ''}', '${delCompany}')">ğŸ“¦ ØªÙ… Ø§Ù„ØªØ¬Ù‡ÙŠØ²</button>
              <button class="btn btn-wa" style="background:#064e3b;" onclick="sendWA('HE', '${o.phone || ''}', '${o.name || ''}', '${o.offer || ''}', '${o.orderId || ''}', '${price}')">ğŸ’¬ WhatsApp</button>
            </div>
          </div>
        `;
      }).join('');
    }

    async function saveOrder() {
      const d = {
        name: document.getElementById('in_name').value,
        phone: document.getElementById('in_phone').value,
        address: document.getElementById('in_addr').value,
        offer: document.getElementById('in_offer').value,
        notes: document.getElementById('in_notes').value,
        price: document.getElementById('in_price').value || "150",
        source: "Web-App",
        lang: "ar",
        payment: "Cash",
        process: "Direct"
      };
      if(!d.name || !d.phone) return alert("× × ×œ××œ× ×¤×¨×˜×™×");
      fetch(SCRIPT_URL, { method: 'POST', mode: 'no-cors', body: JSON.stringify(d) });
      alert("× ×©××¨! ×¢×•×‘×¨ ×œ× ×™×”×•×œ ×× ×”×œ.");
      syncData();
      switchTab('manage');
    }

    async function updateStatus(orderId, row, s) {
      localStatusMap[orderId] = s;
      renderTab();
      updateDashboard(allOrders);
      try {
        fetch(`${SCRIPT_URL}?action=updateStatus&row=${encodeURIComponent(row)}&orderId=${encodeURIComponent(orderId)}&status=${encodeURIComponent(s)}&t=${Date.now()}`);
      } catch(e) {}
    }

    async function updatePrice(orderId, row, price) {
      const p = String(price || "").replace(/[^\d]/g,'');
      if(!p) { triggerAlert("âŒ Ø£Ø¯Ø®Ù„ Ø³Ø¹Ø± ØµØ­ÙŠØ­"); return; }
      localPriceMap[orderId] = p;
      renderTab();
      try {
        fetch(`${SCRIPT_URL}?action=updatePrice&row=${encodeURIComponent(row)}&orderId=${encodeURIComponent(orderId)}&price=${encodeURIComponent(p)}&t=${Date.now()}`);
      } catch(e) {}
      triggerAlert("âœ… ØªÙ… Ø­ÙØ¸ Ø§Ù„Ø³Ø¹Ø±");
    }

    async function finalizeReady(orderId, row, custName, delivery) {
      const emp = employeeNameMap[orderId] || "";
      const status = `××•×›×Ÿ ×¢×œ ×™×“×™ ${emp} (××©×œ×•×—: ${delivery})`;
      updateStatus(orderId, row, status);

      const msg = `*×¢×“×›×•×Ÿ ØªØ¬Ù‡ÙŠØ² - MAD SYSTEM* ğŸ“¢\n\nØ§Ù„Ø·Ù„Ø¨ Ø§Ù„Ø®Ø§Øµ Ø¨Ù€ *${custName}* Ø¬Ø§Ù‡Ø² Ø§Ù„Ø¢Ù†!\nğŸ‘¤ Ø§Ù„Ù…ÙˆØ¸ÙØ©: ${emp}\nğŸšš Ø§Ù„Ø´Ø±ÙƒØ©: ${delivery}\nâœ… Ø§Ù„Ø­Ø§Ù„Ø©: ØªÙ… Ø§Ù„ØªØ¬Ù‡ÙŠØ² ÙˆØ¬Ø§Ù‡Ø² Ù„Ù„Ù…Ø±Ø³ÙˆÙ„.`;
      window.open(`https://wa.me/${MANAGER_PHONE}?text=${encodeURIComponent(msg)}`, '_blank');
    }

    function printSticker(o, delivery, price) {
      const container = document.getElementById('print-container');
      container.innerHTML = `
        <div class="print-page" dir="rtl">
          <div style="text-align:center; border-bottom:2px solid #000; font-weight:bold; font-size:16pt;">××¢×¨×›×ª MAD</div>
          <div style="font-size:12pt; margin:10px 0;">
            <b>×©×:</b> ${o.name}<br>
            <b>×˜×œ×¤×•×Ÿ:</b> ${o.phone}<br>
            <b>××—×™×¨:</b> â‚ª${price || (o.price||'150')}<br>
            <b>××©×œ×•×—:</b> ${delivery}
          </div>
          <div style="border:1.5px solid #000; padding:5px; background:#eee;">${o.offer}</div>
          <div style="font-size:8pt; border:1px solid red; color:red; text-align:center; font-weight:bold; margin-top:8px;">×”×—×œ×¤×” ××š ×•×¨×§ ×‘×ª× ××™ ×©×”× ×™×™×œ×•×Ÿ ×œ× × ×¤×ª×—</div>
          <div style="text-align:center; margin-top:10px;"><svg id="bcode_gen"></svg></div>
        </div>`;
      JsBarcode("#bcode_gen", String(o.phone||""), { format: "CODE128", width: 1.8, height: 40, displayValue: false });
      setTimeout(() => window.print(), 500);
    }

    function sendWA(lang, phone, name, offer, id, price) {
      const total = price ? `â‚ª${price}.00` : `â‚ª150.00`;
      let msg = `*Ø´ÙƒØ± Ø¯Ø§ÙØ¦ Ù…Ù† Ø§Ù„Ù‚Ù„Ø¨ - MAD* â¤ï¸\nØ£Ù‡Ù„Ø§Ù‹ Ø¨Ùƒ *${name}*ØŒ Ù†Ø´ÙƒØ±Ùƒ Ø¹Ù„Ù‰ Ø§Ø®ØªÙŠØ§Ø±Ùƒ Ù„Ù†Ø§! ØªÙØ§ØµÙŠÙ„ Ø·Ù„Ø¨ÙŠØªÙƒ:\nğŸ“¦ Ø§Ù„Ù…Ù†ØªØ¬: ${offer}\nğŸ“„ Ø±Ù‚Ù… Ø§Ù„Ø·Ù„Ø¨: ${id || '×—×“×©'}\nğŸ’° Ø§Ù„Ø¥Ø¬Ù…Ø§Ù„ÙŠ: ${total}\nâœ¨ Ø®Ø¯Ù…Ø© Ø§Ù„Ø¹Ù…Ù„Ø§Ø¡: 9935*`;
      if(lang==='HE') msg = `*×ª×•×“×” ×¨×‘×” ××›×œ ×”×œ×‘ - MAD* â¤ï¸\n×©×œ×•× *${name}*,\n×ª×•×“×” ×¢×œ Ø·Ù„Ø¨Ùƒ! ØªÙØ§ØµÙŠÙ„ Ø§Ù„Ø·Ù„Ø¨:\nğŸ“¦ ×¤×¨×™×˜: ${offer}\nğŸ“„ ××¡×¤×¨ ×”×–×× ×”: ${id || '×—×“×©'}\nğŸ’° ×¡×”"×›: ${total}\nâœ¨ ×©×™×¨×•×ª ×œ×§×•×—×•×ª: 9935*`;
      const cp = String(phone||"").startsWith('0') ? ('972' + String(phone||"").substring(1)) : String(phone||"");
      window.open(`https://wa.me/${cp.replace(/\D/g, '')}?text=${encodeURIComponent(msg)}`, '_blank');
    }

    function activateAudio() {
      audioCtx = new (window.AudioContext || window.webkitAudioContext)();
      document.getElementById('audioActivation').style.display = 'none';
    }

    function triggerAlert(text) {
      const toast = document.getElementById('notification-toast');
      toast.innerText = text;
      toast.classList.add('show');
      setTimeout(() => toast.classList.remove('show'), 6000);
      if (audioCtx) {
        const osc = audioCtx.createOscillator();
        const g = audioCtx.createGain();
        osc.connect(g); g.connect(audioCtx.destination);
        osc.start(); osc.stop(audioCtx.currentTime + 0.6);
      }
      if (navigator.vibrate) navigator.vibrate([500, 200, 500]);
    }

    /* ---------------------------
       âœ… WhatsApp Smart Box Parser
    ---------------------------- */
    function hasHebrew_(s){ return /[\u0590-\u05FF]/.test(s || ""); }
    function normalizeDigits_(s){
      const map = {'Ù ':'0','Ù¡':'1','Ù¢':'2','Ù£':'3','Ù¤':'4','Ù¥':'5','Ù¦':'6','Ù§':'7','Ù¨':'8','Ù©':'9'};
      return String(s||"").replace(/[Ù -Ù©]/g, d => map[d] || d);
    }
    function cleanText_(s){ return normalizeDigits_(s).replace(/\r/g,'').trim(); }

    function normalizePhone_(p){
      if(!p) return "";
      let d = String(p).replace(/[^\d]/g,'');
      if (d.startsWith('00')) d = d.slice(2);
      if (d.startsWith('9720')) d = '972' + d.slice(4);
      if (d.startsWith('0')) {
        if (d.startsWith('059') && d.length >= 10) d = '970' + d.slice(1);
        else if (d.startsWith('05') && d.length >= 10) d = '972' + d.slice(1);
        else if (d.length >= 9) d = '972' + d.slice(1);
      }
      if (d.length === 9 && d.startsWith('5')) d = '972' + d;
      if (d.length === 9 && d.startsWith('59')) d = '970' + d;
      return d;
    }

    function extractPhone_(text){
      const t = cleanText_(text);
      const digitGroups = t.match(/\d[\d\s\-\(\)]{7,16}\d/g) || [];
      const cands = digitGroups.map(g => g.replace(/[^\d]/g,'')).filter(x => x.length >= 9 && x.length <= 13);
      let best = "";
      let bestScore = -1;
      cands.forEach(d=>{
        let score = 0;
        if (d.startsWith("05")) score += 5;
        if (d.startsWith("059")) score += 5;
        if (d.startsWith("972")) score += 4;
        if (d.startsWith("970")) score += 4;
        if (d.length >= 9 && d.length <= 13) score += 2;
        if (score > bestScore){ bestScore = score; best = d; }
      });
      return normalizePhone_(best);
    }

    function extractFieldAfterLabel_(lines, labelRegex){
      for (const ln of lines){
        if (labelRegex.test(ln)){
          const parts = ln.split(/[:\-]/);
          if (parts.length > 1) return parts.slice(1).join(':').trim();
          return ln.replace(labelRegex,'').trim();
        }
      }
      return "";
    }

    function extractOffer_(lines, text){
      const t = cleanText_(text);
      const codeMatch = t.match(/\b[A-Za-z]{1,3}\s*[- ]?\s*\d{2,4}\b/g);
      if (codeMatch && codeMatch.length) return codeMatch[0].replace(/\s+/g,'').replace('-', '');
      const keys = [/Ø§Ù„Ø¹Ø±Ø¶/i,/ÙƒÙˆØ¯/i,/code/i,/offer/i,/Ø§Ù„Ø·Ù„Ø¨/i,/product/i,/××•×¦×¨/i,/×¤×¨×™×˜/i,/×§×•×“/i];
      for (const ln of lines){
        for (const k of keys){
          if (k.test(ln)) {
            const parts = ln.split(/[:\-]/);
            if (parts.length > 1) return parts.slice(1).join(':').trim();
            return ln.trim();
          }
        }
      }
      return "";
    }

    function extractAddress_(lines){
      const addr = extractFieldAfterLabel_(lines, /^(Ø§Ù„Ø¹Ù†ÙˆØ§Ù†|Ø¹Ù†ÙˆØ§Ù†|address|×›×ª×•×‘×ª)\s*[:\-]?\s*/i);
      if (addr) return addr;
      const streetKey = /(Ø´Ø§Ø±Ø¹|Ø­Ø§Ø±Ø©|Ø­ÙŠ|Ù…Ù†Ø·Ù‚Ø©|street|st\.|road|ave|×“×™×¨×”|×¨×—×•×‘|×©×›×•× ×”|×¢×™×¨)/i;
      const cand = lines.find(ln => streetKey.test(ln));
      return cand ? cand.trim() : "";
    }

    function extractName_(lines){
      const name = extractFieldAfterLabel_(lines, /^(Ø§Ù„Ø§Ø³Ù…|Ø§Ø³Ù…|name|×©×)\s*[:\-]?\s*/i);
      if (name) return name;
      const badKey = /(Ø´Ø§Ø±Ø¹|Ø¹Ù†ÙˆØ§Ù†|address|×›×ª×•×‘×ª|Ø±Ù‚Ù…|phone|×˜×œ×¤×•×Ÿ|050|052|053|054|055|056|057|058|059|972|970|ÙƒÙˆØ¯|code|offer|Ø§Ù„Ø¹Ø±Ø¶|Ø§Ù„Ø·Ù„Ø¨)/i;
      for (const ln of lines){
        const hasLetters = /[A-Za-z\u0590-\u05FF\u0600-\u06FF]/.test(ln);
        const hasDigits = /\d/.test(ln);
        if (hasLetters && !badKey.test(ln) && !hasDigits && ln.length <= 40) return ln.trim();
      }
      return "";
    }

    function parseWhatsAppText_(raw){
      const text = cleanText_(raw);
      const lines = text.split('\n').map(x => x.trim()).filter(Boolean);

      const phone = extractPhone_(text);
      const offer = extractOffer_(lines, text);
      const name = extractName_(lines);
      const address = extractAddress_(lines);

      return {
        name: name || "Customer",
        phone: phone || "",
        address: address || "",
        offer: offer || "",
        notes: "WA_RAW: " + text
      };
    }

    function parseWhatsAppToForm(){
      const raw = document.getElementById('wa_raw').value || "";
      if (!raw.trim()) { triggerAlert("âŒ Ø§Ù„ØµÙ‚ Ø±Ø³Ø§Ù„Ø© ÙˆØ§ØªØ³Ø§Ø¨ Ø£ÙˆÙ„Ø§Ù‹"); return; }
      const parsed = parseWhatsAppText_(raw);

      document.getElementById('in_name').value = parsed.name || "";
      document.getElementById('in_phone').value = parsed.phone || "";
      document.getElementById('in_addr').value = parsed.address || "";
      document.getElementById('in_offer').value = parsed.offer || "";
      document.getElementById('in_notes').value = parsed.notes || "";

      triggerAlert("âœ… ØªÙ… ØªØ­Ù„ÙŠÙ„ Ø§Ù„Ø±Ø³Ø§Ù„Ø© ÙˆØªØ¹Ø¨Ø¦Ø© Ø§Ù„Ø­Ù‚ÙˆÙ„");
    }

    function sendSmartApproved(){
      const raw = document.getElementById('wa_raw').value || "";
      if (!raw.trim()) { triggerAlert("âŒ Ø§Ù„ØµÙ‚ Ø±Ø³Ø§Ù„Ø© ÙˆØ§ØªØ³Ø§Ø¨ Ø£ÙˆÙ„Ø§Ù‹"); return; }

      const delivery = document.getElementById('wa_delivery').value || "";
      if (!delivery) { triggerAlert("âŒ Ø§Ø®ØªØ± Ø´Ø±ÙƒØ© Ø§Ù„ØªÙˆØµÙŠÙ„ Ø£ÙˆÙ„Ø§Ù‹"); return; }

      const price = String(document.getElementById('wa_price').value || "150").replace(/[^\d]/g,'') || "150";
      const parsed = parseWhatsAppText_(raw);
      const lang = hasHebrew_(raw) ? "he" : "ar";

      const status = `Approved âœ… (××©×œ×•×—: ${delivery})`;

      const payload = {
        name: parsed.name,
        phone: parsed.phone,
        address: parsed.address || "-",
        offer: parsed.offer || "WhatsApp-Order",
        notes: parsed.notes,
        source: "WhatsApp Smart Box",
        lang: lang,
        price: price,
        payment: "Cash",
        process: "Direct",
        status: status
      };

      fetch(SCRIPT_URL, { method: 'POST', mode: 'no-cors', body: JSON.stringify(payload) });

      triggerAlert("âœ… ØªÙ… Ø§Ù„Ø§Ø¹ØªÙ…Ø§Ø¯ ÙˆØ¥Ø±Ø³Ø§Ù„ Ø§Ù„Ø·Ù„Ø¨ Ù„Ù„Ø´ÙŠØª");
      document.getElementById('wa_raw').value = "";
      document.getElementById('wa_delivery').value = "";
      document.getElementById('wa_price').value = "150";

      setTimeout(() => {
        syncData();
        switchTab('prep');
      }, 600);
    }

    window.onload = () => switchTab('manage');
    setInterval(syncData, 35000);
  </script>
</body>
</html>
