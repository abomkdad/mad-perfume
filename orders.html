<!doctype html>
<html lang="ar" dir="rtl">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width,initial-scale=1,maximum-scale=1,user-scalable=0"/>
  <title>MAD Mobile Manager</title>
  
  <script src="https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf.min.js"></script>
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">

  <style>
    :root {
      --bg: #0f172a;
      --card: #1e293b;
      --primary: #3b82f6;
      --success: #22c55e;
      --danger: #ef4444;
      --text: #f8fafc;
      --muted: #94a3b8;
      --accent: #8b5cf6;
    }

    body {
      margin: 0; font-family: 'Segoe UI', system-ui; 
      background: var(--bg); color: var(--text); 
      padding-bottom: 80px; /* مساحة للشريط السفلي */
    }

    /* Header */
    .header {
      background: var(--card); padding: 15px;
      position: sticky; top: 0; z-index: 100;
      border-bottom: 1px solid rgba(255,255,255,0.1);
      display: flex; justify-content: space-between; align-items: center;
    }
    
    /* Search & Filter */
    .search-box { padding: 10px; background: var(--bg); }
    input, select, textarea {
      width: 100%; padding: 12px; border-radius: 12px;
      border: 1px solid #334155; background: #1e293b; color: #fff;
      font-size: 16px; margin-bottom: 10px; box-sizing: border-box;
    }

    /* Order Cards */
    .container { padding: 10px; }
    .order-card {
      background: var(--card); border-radius: 16px; padding: 15px;
      margin-bottom: 15px; border: 1px solid rgba(255,255,255,0.05);
      box-shadow: 0 4px 6px -1px rgba(0,0,0,0.1);
    }
    .order-header { display: flex; justify-content: space-between; margin-bottom: 10px; }
    .order-id { font-weight: bold; color: var(--primary); }
    .order-status { font-size: 12px; padding: 4px 8px; border-radius: 6px; background: rgba(255,255,255,0.1); }

    .order-body h3 { margin: 5px 0; font-size: 18px; }
    .order-details { font-size: 14px; color: var(--muted); line-height: 1.6; }
    .order-details i { width: 20px; color: var(--primary); }

    /* Action Buttons */
    .actions { display: grid; grid-template-columns: 1fr 1fr; gap: 10px; margin-top: 15px; }
    .btn {
      padding: 12px; border-radius: 10px; border: none; font-weight: bold;
      display: flex; align-items: center; justify-content: center; gap: 8px;
      cursor: pointer; font-size: 14px;
    }
    .btn-primary { background: var(--primary); color: white; }
    .btn-success { background: var(--success); color: white; }
    .btn-outline { background: transparent; border: 1px solid #334155; color: white; }
    .btn-wa { background: #25d366; color: white; }

    /* Bottom Nav */
    .bottom-nav {
      position: fixed; bottom: 0; left: 0; right: 0;
      background: var(--card); display: flex; justify-content: space-around;
      padding: 10px; border-top: 1px solid rgba(255,255,255,0.1);
    }
    .nav-item { 
      text-align: center; color: var(--muted); text-decoration: none; font-size: 11px;
      flex: 1; display: flex; flex-direction: column; gap: 4px;
    }
    .nav-item.active { color: var(--primary); }
    .nav-item i { font-size: 20px; }

    /* Modal */
    .modal {
      position: fixed; inset: 0; background: rgba(0,0,0,0.8);
      display: none; padding: 20px; z-index: 1000; overflow-y: auto;
    }
    .modal.show { display: block; }
    .modal-content { background: var(--card); padding: 20px; border-radius: 20px; }
    
    /* Stats */
    .badge-count { background: var(--danger); color: white; padding: 2px 6px; border-radius: 50%; font-size: 10px; }

  </style>
</head>
<body>

<div class="header">
  <div style="font-weight: 900; font-size: 20px;">MAD <span style="color:var(--primary)">Manager</span></div>
  <button class="btn btn-primary" onclick="openAddModal()" style="padding: 8px 15px;"><i class="fa fa-plus"></i></button>
</div>

<div class="search-box">
  <input type="text" id="searchInput" placeholder="ابحث باسم العميل أو رقم الطلب..." oninput="renderOrders()">
</div>

<div class="container" id="ordersList">
  </div>

<div class="bottom-nav">
  <a href="#" class="nav-item active" onclick="setFilter('NEW', this)">
    <i class="fa fa-inbox"></i> جديد <span id="countNew" class="badge-count">0</span>
  </a>
  <a href="#" class="nav-item" onclick="setFilter('PREP', this)">
    <i class="fa fa-clock"></i> تجهيز
  </a>
  <a href="#" class="nav-item" onclick="setFilter('READY', this)">
    <i class="fa fa-check-circle"></i> جاهز
  </a>
  <a href="#" class="nav-item" onclick="load()">
    <i class="fa fa-sync"></i> تحديث
  </a>
</div>

<div class="modal" id="orderModal">
  <div class="modal-content">
    <h2 id="modalTitle">تعديل الطلب</h2>
    
    <label>نص ذكي (الصق نص الواتساب هنا للتحليل)</label>
    <div style="display:flex; gap:10px;">
      <textarea id="rawText" placeholder="الصق النص هنا..." style="height: 80px; flex:1;"></textarea>
      <button class="btn btn-primary" onclick="magicParse()" style="height: 80px;"><i class="fa fa-wand-magic-sparkles"></i></button>
    </div>

    <input type="text" id="f_name" placeholder="اسم العميل">
    <input type="tel" id="f_phone" placeholder="رقم الهاتف">
    <input type="text" id="f_offer" placeholder="الطلبات (أكواد)">
    <input type="number" id="f_price" placeholder="السعر الإجمالي">
    
    <select id="f_payment">
      <option value="Cash">نقداً (מזומן)</option>
      <option value="Paid">مدفوع</option>
      <option value="PaidLink">مدفوع بالرابط</option>
    </select>
    
    <input type="text" id="f_addr" placeholder="العنوان بالتفصيل">
    
    <div class="actions">
      <button class="btn btn-success" onclick="saveOrder(true)">حفظ واعتماد ✅</button>
      <button class="btn btn-outline" onclick="closeModal()">إلغاء</button>
    </div>
  </div>
</div>

<script>
const SCRIPT_URL = "https://script.google.com/macros/s/AKfycbyLjLFa8AaH82Ip7m747WC-KSUUEaU_M70S0I9Mda14XbnmcuEfZ7pBnF_zzJYZuXmZ/exec";
const DASH_KEY = "12345678";

let allOrders = [];
let currentFilter = 'NEW';
let editingRow = null;

// تشغيل عند التحميل
async function start() {
  await load();
  setInterval(load, 20000); // تحديث كل 20 ثانية
}
start();

async function load() {
  try {
    const res = await fetch(`${SCRIPT_URL}?action=get&_=${Date.now()}`);
    const data = await res.json();
    allOrders = data.filter(o => o.rowIndex);
    renderOrders();
    updateStats();
  } catch (e) { console.error("Error loading data"); }
}

function updateStats() {
  const newCount = allOrders.filter(o => isNew(o)).length;
  document.getElementById('countNew').textContent = newCount;
}

function setFilter(f, el) {
  currentFilter = f;
  document.querySelectorAll('.nav-item').forEach(i => i.classList.remove('active'));
  el.classList.add('active');
  renderOrders();
}

function isNew(o) { return !o.status || o.status.toLowerCase().includes('new') || o.status.includes('Inbox'); }
function isPrep(o) { return o.status && o.status.includes('Approved'); }
function isReady(o) { return o.status && o.status.includes('READY'); }

function renderOrders() {
  const container = document.getElementById('ordersList');
  const query = document.getElementById('searchInput').value.toLowerCase();
  
  let filtered = allOrders.filter(o => {
    const matchSearch = (o.name + o.orderId + o.phone).toLowerCase().includes(query);
    if (currentFilter === 'NEW') return matchSearch && isNew(o);
    if (currentFilter === 'PREP') return matchSearch && isPrep(o);
    if (currentFilter === 'READY') return matchSearch && isReady(o);
    return matchSearch;
  });

  filtered.sort((a,b) => b.rowIndex - a.rowIndex);

  container.innerHTML = filtered.map(o => `
    <div class="order-card">
      <div class="order-header">
        <span class="order-id">#${o.orderId}</span>
        <span class="order-status">${o.status || 'جديد'}</span>
      </div>
      <div class="order-body" onclick="openEditModal(${o.rowIndex})">
        <h3>${o.name || 'عميل غير معروف'}</h3>
        <div class="order-details">
          <div><i class="fa fa-phone"></i> ${o.phone}</div>
          <div><i class="fa fa-shopping-bag"></i> ${o.offer}</div>
          <div><i class="fa fa-map-marker-alt"></i> ${o.addr || o.city || 'لا يوجد عنوان'}</div>
          <div style="font-weight:bold; color:#fff; margin-top:5px;"><i class="fa fa-money-bill"></i> ${o.price} ₪ (${o.payment})</div>
        </div>
      </div>
      <div class="actions">
        <a href="https://wa.me/${normalizePhone(o.phone)}" class="btn btn-wa"><i class="fab fa-whatsapp"></i> واتساب</a>
        ${isNew(o) ? 
          `<button class="btn btn-success" onclick="quickApprove(${o.rowIndex})"><i class="fa fa-check"></i> اعتماد</button>` : 
          `<button class="btn btn-outline" onclick="openEditModal(${o.rowIndex})"><i class="fa fa-edit"></i> تعديل</button>`
        }
      </div>
    </div>
  `).join('');
}

// فتح مودال الإضافة
function openAddModal() {
  editingRow = null;
  document.getElementById('modalTitle').textContent = "إضافة طلب جديد";
  clearModal();
  document.getElementById('orderModal').classList.add('show');
}

// فتح مودال التعديل
function openEditModal(row) {
  const o = allOrders.find(x => x.rowIndex == row);
  if (!o) return;
  editingRow = row;
  document.getElementById('modalTitle').textContent = "تعديل الطلب #" + o.orderId;
  document.getElementById('f_name').value = o.name;
  document.getElementById('f_phone').value = o.phone;
  document.getElementById('f_offer').value = o.offer;
  document.getElementById('f_price').value = o.price;
  document.getElementById('f_payment').value = o.payment || 'Cash';
  document.getElementById('f_addr').value = o.addr || o.city;
  document.getElementById('rawText').value = o.notes || "";
  document.getElementById('orderModal').classList.add('show');
}

function closeModal() { document.getElementById('orderModal').classList.remove('show'); }

function clearModal() {
  ['f_name','f_phone','f_offer','f_price','f_addr','rawText'].forEach(id => document.getElementById(id).value = "");
}

// التحليل الذكي
function magicParse() {
  const text = document.getElementById('rawText').value;
  if(!text) return;
  
  // منطق تحليل بسيط وسريع
  const phoneMatch = text.match(/(05\d{8})/);
  const priceMatch = text.match(/(\d{2,4})\s*(₪|شيكل|ils)/i) || text.match(/(?:السعر|Total)[:\s]*(\d+)/i);
  
  if(phoneMatch) document.getElementById('f_phone').value = phoneMatch[1];
  if(priceMatch) document.getElementById('f_price').value = priceMatch[1];
  
  // محاولة استخراج الاسم (أول كلمتين)
  const lines = text.split('\n').filter(l => l.trim().length > 2);
  if(lines.length > 0 && !lines[0].includes(':')) document.getElementById('f_name').value = lines[0].trim();

  alert("تم استخراج البيانات المتاحة ✨");
}

async function saveOrder(approve = false) {
  const payload = {
    action: editingRow ? "updateOrder" : "addOrder", // نفترض وجود addOrder في السكربت
    key: DASH_KEY,
    row: editingRow,
    name: document.getElementById('f_name').value,
    phone: document.getElementById('f_phone').value,
    offer: document.getElementById('f_offer').value,
    price: document.getElementById('f_price').value,
    payment: document.getElementById('f_payment').value,
    addr: document.getElementById('f_addr').value,
    status: approve ? "Approved ✅ (Sent to Prep)" : "NEW"
  };

  if(!payload.phone || !payload.offer) return alert("الرجاء ملء الهاتف والطلب");

  const url = `${SCRIPT_URL}?` + new URLSearchParams(payload).toString();
  
  // إغلاق المودال فوراً لتحسين السرعة
  closeModal();
  
  try {
    const res = await fetch(url);
    const data = await res.json();
    if(data.result === "SUCCESS") {
      load();
    } else {
      alert("خطأ في الحفظ: " + data.message);
    }
  } catch(e) { alert("خطأ اتصال"); }
}

async function quickApprove(row) {
  const url = `${SCRIPT_URL}?action=updateStatus&key=${DASH_KEY}&row=${row}&status=${encodeURIComponent("Approved ✅ (Sent to Prep)")}`;
  await fetch(url);
  load();
}

function normalizePhone(p) {
  if(!p) return "";
  let d = p.replace(/[^\d]/g,"");
  if(d.startsWith("05")) return "972" + d.slice(1);
  return d;
}

function normalizePhone(p) {
  let d = String(p).replace(/[^\d]/g,"");
  if(d.startsWith("05")) return "972" + d.substring(1);
  return d;
}
</script>

</body>
</html>
