<!DOCTYPE html>
<html lang="he" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>××¢×¨×›×ª MAD - × ×™×”×•×œ ×”×–×× ×•×ª</title>
    <script src="https://cdn.jsdelivr.net/npm/jsbarcode@3.11.5/dist/JsBarcode.all.min.js"></script>
    <style>
        :root {
            /* Ù†Ø¸Ø§Ù… Ø§Ù„Ø£Ù„ÙˆØ§Ù† Ø§Ù„Ø¯Ø§ÙƒÙ† */
            --primary: #60a5fa; /* Ø£Ø²Ø±Ù‚ Ù…Ø´Ø±Ù‚ Ù„Ù„Ø¨Ø±ÙˆØ² */
            --accent: #3b82f6;
            --success: #10b981;
            --warning: #f59e0b;
            --danger: #ef4444;
            --bg-dark: #0f172a; /* Ø®Ù„ÙÙŠØ© Ø¯Ø§ÙƒÙ†Ø© Ø¬Ø¯Ø§Ù‹ */
            --card-dark: #1e293b; /* Ø®Ù„ÙÙŠØ© Ø§Ù„ÙƒØ±ÙˆØª */
            --text-main: #f8fafc;
            --text-muted: #94a3b8;
            --cancel-bg: #450a0a;
        }

        body {
            font-family: 'Segoe UI', Tahoma, sans-serif;
            background-color: var(--bg-dark);
            color: var(--text-main);
            margin: 0; padding: 0;
            display: flex; flex-direction: column; align-items: center;
            min-height: 100vh;
            padding-bottom: 80px;
        }

        /* ÙˆØ§Ø¬Ù‡Ø© Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù… */
        #app-ui { width: 100%; display: flex; flex-direction: column; align-items: center; }

        .header-ui {
            width: 100%; max-width: 600px; background: #1e293b;
            padding: 15px; box-sizing: border-box;
            position: sticky; top: 0; z-index: 900;
            box-shadow: 0 4px 10px rgba(0,0,0,0.3);
        }

        .search-input {
            width: 100%; padding: 12px; border: 1px solid #334155;
            border-radius: 12px; font-size: 16px; margin-bottom: 10px;
            box-sizing: border-box; outline: none; text-align: right;
            background: #0f172a; color: white;
        }

        .tabs-container { display: flex; gap: 8px; }
        .tab-btn {
            flex: 1; padding: 10px; border-radius: 10px; border: 1px solid #334155;
            background: #334155; font-size: 11px; font-weight: bold; cursor: pointer; color: var(--text-muted);
        }
        .tab-btn.active { background: var(--accent); color: white; border-color: var(--accent); }

        .container { width: 95%; max-width: 500px; margin-top: 15px; }

        /* ÙƒØ±Øª Ø§Ù„Ø·Ù„Ø¨ */
        .order-card {
            background: var(--card-dark); border-radius: 16px; padding: 15px;
            margin-bottom: 15px; border-right: 8px solid #475569;
            box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.2);
            transition: transform 0.2s;
        }
        .order-card:active { transform: scale(0.98); }
        
        .status-waiting { border-right-color: var(--warning); }
        .status-contacted { border-right-color: var(--primary); }
        .status-delivered { border-right-color: var(--success); }
        .status-canceled { border-right-color: var(--danger); background: var(--cancel-bg); opacity: 0.8; }

        .check-green { color: var(--success); font-weight: bold; margin-left: 8px; font-size: 20px; }
        .x-red { color: var(--danger); font-weight: bold; margin-left: 8px; font-size: 20px; }

        .actions-grid { display: grid; grid-template-columns: 1fr 1fr 1fr; gap: 8px; margin-top: 12px; }
        .btn-op {
            padding: 10px 4px; border-radius: 8px; font-size: 11px;
            font-weight: bold; border: none; cursor: pointer;
            display: flex; flex-direction: column; align-items: center; gap: 4px;
            background: #334155; color: white;
        }
        .btn-wa { background: #065f46; color: #a7f3d0; }
        .btn-print { background: #1e3a8a; color: #bfdbfe; }
        .btn-invoice { background: #701a75; color: #f5d0fe; }
        .btn-contact { background: #1e40af; color: white; }
        .btn-cancel { background: #7f1d1d; color: #fecaca; }

        .bottom-nav {
            position: fixed; bottom: 0; width: 100%; max-width: 600px;
            background: #1e293b; display: flex; box-shadow: 0 -4px 10px rgba(0,0,0,0.3); z-index: 1000;
        }
        .nav-item { flex: 1; padding: 15px; text-align: center; border: none; background: none; font-weight: bold; color: var(--text-muted); }
        .nav-item.active { color: var(--primary); border-top: 3px solid var(--primary); background: #0f172a; }

        /* Ù†Ø¸Ø§Ù… Ø§Ù„Ø·Ø¨Ø§Ø¹Ø© Ø§Ù„Ù…Ø¹Ø²ÙˆÙ„ (Ø®Ù„ÙÙŠØ© Ø¨ÙŠØ¶Ø§Ø¡ Ø¯Ø§Ø¦Ù…Ø§Ù‹) */
        #print-container { display: none; }
        @media print {
            body { background: white !important; color: black !important; }
            #app-ui, .bottom-nav, .header-ui { display: none !important; }
            #print-container { display: block !important; width: 100%; }
            .print-page { display: block !important; page-break-after: always; margin: 0 auto; background: white !important; color: black !important; }
            .invoice-size { width: 210mm; min-height: 297mm; padding: 15mm; box-sizing: border-box; }
            .sticker-size { width: 100mm; height: 100mm; padding: 5mm; box-sizing: border-box; }
            @page { margin: 0; }
            svg { display: inline-block !important; }
        }

        /* Ø³ØªØ§ÙŠÙ„Ø§Øª Ø§Ù„ÙØ§ØªÙˆØ±Ø© A4 Ø§Ù„Ø§Ø­ØªØ±Ø§ÙÙŠØ© */
        .inv-header { text-align: center; border-bottom: 4px solid #1e3a8a; padding-bottom: 10px; margin-bottom: 20px; }
        .inv-title { font-size: 26pt; font-weight: 900; color: #1e3a8a; margin: 0; }
        .inv-client-box { background: #f8fafc; padding: 15px; border-radius: 8px; margin: 20px 0; border-right: 6px solid #1e3a8a; font-size: 13pt; line-height: 1.8; color: black; }
        .inv-table { width: 100%; border-collapse: collapse; margin: 20px 0; font-size: 13pt; color: black; }
        .inv-table th { background: #f1f5f9; padding: 12px; text-align: right; border-bottom: 2px solid #1e3a8a; color: black; }
        .inv-table td { padding: 12px; border-bottom: 1px solid #e2e8f0; color: black; }
        .warn-box { border: 1.5px solid #b91c1c; padding: 10px; text-align: center; color: #b91c1c; font-weight: bold; margin-top: 15px; }
    </style>
</head>
<body>

<div id="app-ui">
    <div id="header-ui" class="header-ui">
        <input type="text" class="search-input" id="searchInput" placeholder="×—×¤×© ×œ×¤×™ ×©× ××• ×˜×œ×¤×•×Ÿ..." oninput="handleFilter()">
        <div class="tabs-container">
            <button class="tab-btn active" id="tab-all" onclick="setFilter('all')">20 ××—×¨×•× ×•×ª</button>
            <button class="tab-btn" id="tab-new" onclick="setFilter('new')">×××ª×™×Ÿ ×œ×©×™×—×”</button>
            <button class="tab-btn" id="tab-prep" onclick="setFilter('prep')">×‘×•×¦×¢×” ×©×™×—×”</button>
        </div>
    </div>
    <div class="container" id="mainContainer">
        <div id="ordersList"></div>
    </div>
</div>

<div class="bottom-nav">
    <button class="nav-item active" onclick="location.reload()">×”×–×× ×•×ª</button>
</div>

<!-- Ø­Ø§ÙˆÙŠØ© Ø§Ù„Ø·Ø¨Ø§Ø¹Ø© -->
<div id="print-container"></div>

<script>
    const SCRIPT_URL = "https://script.google.com/macros/s/AKfycbw2QxGHOxMv7_uNbMulwO60IHOcKj16rbBJRfoltkwcdb2Bg4zrVjyMt_lf9KgnyyXl/exec";
    let allData = [];
    let currentTab = 'all';
    let localSessionStore = {}; 

    async function fetchOrders() {
        try {
            const res = await fetch(`${SCRIPT_URL}?action=get&t=${Date.now()}`);
            const data = await res.json();
            allData = data;
            handleFilter();
        } catch(e) { console.error("Sync Error"); }
    }

    function setFilter(tab) {
        currentTab = tab;
        document.querySelectorAll('.tab-btn').forEach(b => b.classList.remove('active'));
        document.getElementById('tab-' + tab).classList.add('active');
        handleFilter();
    }

    function handleFilter() {
        const query = document.getElementById('searchInput').value.toLowerCase();
        let filtered = [...allData].reverse();

        filtered.forEach(o => {
            const uniqueKey = o.orderId || o.phone;
            if(localSessionStore[uniqueKey]) o.status = localSessionStore[uniqueKey];
        });

        if (currentTab === 'new') filtered = filtered.filter(o => !o.status || o.status.includes('Processing') || o.status.includes('×××ª×™×Ÿ'));
        else if (currentTab === 'prep') filtered = filtered.filter(o => o.status === '×‘×•×¦×¢×” ×©×™×—×”');
        else filtered = filtered.slice(0, 20);

        if (query) {
            filtered = filtered.filter(o => (o.name && o.name.toLowerCase().includes(query)) || (o.phone && o.phone.includes(query)));
        }
        renderOrders(filtered);
    }

    function renderOrders(orders) {
        const list = document.getElementById('ordersList');
        list.innerHTML = '';
        orders.forEach(o => {
            let status = o.status || '×××ª×™×Ÿ ×œ×©×™×—×”';
            if (status === 'Processing...') status = '×××ª×™×Ÿ ×œ×©×™×—×”';
            
            const isContacted = status === '×‘×•×¦×¢×” ×©×™×—×”' || status.includes('Delivered');
            const isDone = status.includes('Delivered');
            const isCanceled = status.includes('××‘×•×˜×œ');
            
            const card = document.createElement('div');
            let statusClass = "status-waiting";
            if (isContacted) statusClass = "status-contacted";
            if (isDone) statusClass = "status-delivered";
            if (isCanceled) statusClass = "status-canceled";

            card.className = `order-card ${statusClass}`;
            card.innerHTML = `
                <div style="display:flex; justify-content:space-between; align-items:center;">
                    <b style="font-size:17px; color:${isCanceled ? '#64748b' : 'var(--text-main)'}; ${isCanceled ? 'text-decoration:line-through;' : ''}">
                        ${isContacted && !isCanceled ? '<span class="check-green">âœ”</span>' : ''}
                        ${isCanceled ? '<span class="x-red">âŒ</span>' : ''}
                        ${o.name}
                    </b>
                    <span style="font-size:10px; background:#334155; padding:2px 6px; border-radius:4px; font-weight:bold; color:var(--text-muted);">
                        ${status}
                    </span>
                </div>
                <div style="font-size:13px; margin:5px 0; color:var(--text-muted);">ğŸ“ ${o.phone} | ğŸ“ ${o.city || '-'}</div>
                <div style="background:#0f172a; padding:8px; border-radius:8px; font-size:12px; border:1px solid #334155; color:var(--text-main);">
                    <b>×”×–×× ×”:</b> ${o.offer}
                </div>
                <div class="actions-grid" style="${isDone || isCanceled ? 'opacity: 0.3; pointer-events: none;' : ''}">
                    <button class="btn-op btn-invoice" onclick="generatePDF('invoice', ${JSON.stringify(o).replace(/"/g, '&quot;')})">ğŸ“„ ×—×©×‘×•× ×™×ª PDF</button>
                    <button class="btn-op btn-print" onclick="generatePDF('sticker', ${JSON.stringify(o).replace(/"/g, '&quot;')})">ğŸ–¨ï¸ ××“×‘×§×”</button>
                    <button class="btn-op btn-wa" onclick="sendWA('${o.phone}', '${o.name}', '${o.offer}')">ğŸ’¬ ×•×•××˜×¡××¤</button>
                    <button class="btn-op ${isContacted ? '' : 'btn-contact'}" onclick="updateStatusLocal('${o.orderId || o.phone}', '${o.rowIndex}', '×‘×•×¦×¢×” ×©×™×—×”')">
                        ${isContacted ? 'âœ… ×‘×•×¦×¢×” ×©×™×—×”' : 'ğŸ“ ×‘×•×¦×¢ ×©×™×—×”'}
                    </button>
                    <button class="btn-op btn-cancel" onclick="updateStatusLocal('${o.orderId || o.phone}', '${o.rowIndex}', '××‘×•×˜×œ âŒ')">âŒ ×‘×™×˜×•×œ</button>
                    <button class="btn-op" style="background:var(--success); color:white;" onclick="updateStatusLocal('${o.orderId || o.phone}', '${o.rowIndex}', 'Delivered âœ…')">âœ… × ××¡×¨</button>
                </div>
            `;
            list.appendChild(card);
        });
    }

    async function updateStatusLocal(idKey, row, s) {
        if(s === '××‘×•×˜×œ âŒ' && !confirm("×”×× ××ª×” ×‘×˜×•×— ×©×‘×¨×¦×•× ×š ×œ×‘×˜×œ? (Ù‡Ù„ Ø£Ù†Øª Ù…ØªØ£ÙƒØ¯ Ù…Ù† Ø§Ù„Ø¥Ù„ØºØ§Ø¡ØŸ)")) return;
        localSessionStore[idKey] = s;
        handleFilter();
        try { fetch(`${SCRIPT_URL}?action=updateStatus&row=${row}&status=${encodeURIComponent(s)}`); } catch(e) {}
    }

    function generatePDF(type, o) {
        const container = document.getElementById('print-container');
        container.innerHTML = '';
        const date = new Date().toLocaleDateString('he-IL');

        if (type === 'invoice') {
            document.title = `Invoice_${o.name}`;
            container.innerHTML = `
                <div class="print-page invoice-size" dir="rtl">
                    <div class="inv-header">
                        <h1 class="inv-title">××¢×¨×›×ª MAD ×œ× ×™×”×•×œ ×”×–×× ×•×ª</h1>
                        <p style="font-size:14pt; color:#444; margin:5px 0;">××œ×’× ×˜×™×•×ª ×•×“×™×•×§ ×‘×›×œ ×”×–×× ×”</p>
                    </div>
                    <div style="display:flex; justify-content:space-between; font-weight:bold; color:black;">
                        <div>××¡×¤×¨ ×”×–×× ×”: ${o.orderId || 'MAD-NEW'}</div>
                        <div>×ª××¨×™×š ×”× ×¤×§×”: ${date}</div>
                    </div>
                    <div class="inv-client-box">
                        <b style="font-size:16pt; color:#1e3a8a;">×—×©×‘×•× ×™×ª ×¢×‘×•×¨: (ØªÙØ§ØµÙŠÙ„ Ø§Ù„Ø¹Ù…ÙŠÙ„)</b><br>
                        ×©×: ${o.name}<br>×›×ª×•×‘×ª: ${o.address || o.city || "-"}<br>×˜×œ×¤×•×Ÿ: ${o.phone}
                    </div>
                    <table class="inv-table">
                        <thead><tr style="background:#f1f5f9;"><th>×ª×™××•×¨ ×•××•×¦×¨ (C)</th><th>×¡×˜×˜×•×¡</th><th>××—×™×¨</th></tr></thead>
                        <tbody><tr><td><b>${o.offer}</b></td><td>×‘×˜×™×¤×•×œ</td><td><b>â‚ª 150.00</b></td></tr></tbody>
                    </table>
                    <div class="warn-box">** ×ª× ××™ ×”×—×œ×¤×”: ×”×—×œ×¤×” ×ª×ª×‘×¦×¢ ××š ×•×¨×§ ×‘×ª× ××™ ×©××¨×™×–×ª ×”× ×™×™×œ×•×Ÿ ×œ× × ×¤×ª×—×”.<br>Ø§Ù„ØªØ¨Ø¯ÙŠÙ„ Ø®Ù„Ø§Ù„ 14 ÙŠÙˆÙ… Ø¨Ø´Ø±Ø· Ø¹Ø¯Ù… ÙØªØ­ Ø§Ù„Ù†Ø§ÙŠÙ„ÙˆÙ†</div>
                    <div style="margin-top:20px; font-size:11pt; color:black; line-height:1.5;">
                        ×”×—×©×‘×•× ×™×ª ×ª×™×©×œ×— ×‘××™×™×œ ×œ××—×¨ ×§×‘×œ×ª ×”××©×œ×•×—. × × ×œ×©×œ×•×— ××ª ×›×ª×•×‘×ª ×”××™×™×œ ×œ×©×™×¨×•×ª ×”×œ×§×•×—×•×ª.<br>
                        Ø³Ù†Ø±Ø³Ù„ Ø§Ù„ÙØ§ØªÙˆØ±Ø© Ø¨Ø§Ù„Ø¥ÙŠÙ…ÙŠÙ„ Ø¨Ø¹Ø¯ ØªØ³Ù„ÙŠÙ… Ø§Ù„Ø·Ù„Ø¨ - ÙŠØ±Ø¬Ù‰ Ø¥Ø±Ø³Ø§Ù„ Ø§Ù„Ø¥ÙŠÙ…ÙŠÙ„ Ù„Ø®Ø¯Ù…Ø© Ø§Ù„Ø¹Ù…Ù„Ø§Ø¡.
                    </div>
                    <div style="text-align:center; margin-top:50px;"><svg id="bp"></svg><br><b style="color:black;">×©×™×¨×•×ª ×œ×§×•×—×•×ª: *9935</b></div>
                </div>`;
        } else {
            document.title = `Sticker_${o.name}`;
            container.innerHTML = `
                <div class="print-page sticker-size" dir="rtl">
                    <div style="text-align:center; border-bottom:2px solid #000; padding-bottom:5px; font-weight:bold; font-size:18pt;">××¢×¨×›×ª MAD</div>
                    <div style="font-size:12pt; line-height:1.5; margin:10px 0; color:black;">
                        ×©×: ${o.name}<br>×›×ª×•×‘×ª: ${o.address || o.city || "-"}<br>×˜×œ×¤×•×Ÿ: ${o.phone}
                    </div>
                    <div style="border:2.2px solid #000; padding:8px; font-size:11pt; background:#f9f9f9; color:black;">×ª×™××•×¨: ${o.offer}</div>
                    <div style="font-size:8.5pt; border:1.1px solid red; color:red; text-align:center; font-weight:bold; padding:3px; margin-top:10px;">×”×—×œ×¤×” ××š ×•×¨×§ ×‘×ª× ××™ ×©×”× ×™×™×œ×•×Ÿ ×œ× × ×¤×ª×—</div>
                    <div style="text-align:center; margin-top:10px;"><svg id="bp"></svg></div>
                </div>`;
        }
        JsBarcode("#bp", o.phone, { format: "CODE128", width: 2, height: 40, displayValue: false });
        setTimeout(() => { window.print(); document.title = "××¢×¨×›×ª MAD"; }, 600);
    }

    function sendWA(p, n, off) {
        const cp = p.startsWith('0') ? '972' + p.substring(1) : p;
        const msg = `*×©×œ×•× ${n}, ×”×–×× ×ª×š ×‘-MAD ×”×ª×§×‘×œ×”*\nğŸ“¦ ×¤×¨×™×˜: ${off}\nğŸ“¢ ×”×—×œ×¤×” ×ª×•×š 14 ×™×•× ×‘×ª× ××™ ×©×”× ×™×™×œ×•×Ÿ ×¡×’×•×¨.`;
        window.open(`https://wa.me/${cp}?text=${encodeURIComponent(msg)}`, '_blank');
    }

    window.onload = fetchOrders;
    setInterval(fetchOrders, 45000);
</script>
</body>
</html>
