<!doctype html>
<html lang="ar" dir="rtl">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width,initial-scale=1,maximum-scale=1,user-scalable=0"/>
  <title>MAD Mobile Manager v2</title>
  
  <script src="https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf.min.js"></script>
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">

  <style>
    :root {
      --bg: #060914;
      --card: #161b2c;
      --primary: #2563eb;
      --success: #16a34a;
      --danger: #dc2626;
      --warning: #f59e0b;
      --text: #ffffff;
      --muted: #94a3b8;
      --border: rgba(255,255,255,0.1);
    }

    body {
      margin: 0; font-family: system-ui, -apple-system, sans-serif;
      background: var(--bg); color: var(--text);
      padding-bottom: 90px;
    }

    /* Header */
    .header {
      background: rgba(22, 27, 44, 0.9); backdrop-filter: blur(10px);
      padding: 15px; position: sticky; top: 0; z-index: 100;
      border-bottom: 1px solid var(--border);
      display: flex; justify-content: space-between; align-items: center;
    }

    /* Search Section */
    .search-area { padding: 12px; background: var(--bg); }
    .input-group { position: relative; }
    .input-group i { position: absolute; right: 12px; top: 14px; color: var(--muted); }
    input, select, textarea {
      width: 100%; padding: 12px 40px 12px 12px; border-radius: 12px;
      border: 1px solid var(--border); background: var(--card); color: #fff;
      font-size: 16px; box-sizing: border-box; outline: none;
    }
    input:focus { border-color: var(--primary); }
    select { padding-right: 12px; appearance: none; background-image: url("data:image/svg+xml,..."); }

    /* Orders List */
    .container { padding: 12px; }
    .order-card {
      background: var(--card); border-radius: 18px; padding: 16px;
      margin-bottom: 15px; border: 1px solid var(--border);
      box-shadow: 0 10px 15px -3px rgba(0,0,0,0.3);
    }
    .order-header { display: flex; justify-content: space-between; margin-bottom: 12px; }
    .status-pill { font-size: 11px; padding: 4px 10px; border-radius: 20px; font-weight: bold; background: rgba(255,255,255,0.1); }
    
    .order-body h3 { margin: 0 0 8px 0; font-size: 18px; color: var(--text); }
    .info-row { display: flex; align-items: center; gap: 8px; font-size: 14px; color: var(--muted); margin-bottom: 6px; }
    .info-row i { width: 18px; color: var(--primary); text-align: center; }
    .price-tag { font-size: 18px; font-weight: 800; color: var(--success); margin-top: 10px; display: block; }

    /* Buttons */
    .actions { display: grid; grid-template-columns: 1fr 1fr; gap: 10px; margin-top: 15px; }
    .btn {
      padding: 12px; border-radius: 12px; border: none; font-weight: bold;
      display: flex; align-items: center; justify-content: center; gap: 8px;
      cursor: pointer; font-size: 14px; transition: 0.2s;
    }
    .btn-primary { background: var(--primary); color: white; }
    .btn-success { background: var(--success); color: white; }
    .btn-wa { background: #075e54; color: white; }
    .btn-outline { background: rgba(255,255,255,0.05); color: white; border: 1px solid var(--border); }

    /* Bottom Nav */
    .bottom-nav {
      position: fixed; bottom: 0; left: 0; right: 0;
      background: var(--card); display: flex; justify-content: space-around;
      padding: 12px 5px; border-top: 1px solid var(--border); z-index: 100;
    }
    .nav-item { 
      text-align: center; color: var(--muted); text-decoration: none; font-size: 11px;
      flex: 1; display: flex; flex-direction: column; gap: 5px;
    }
    .nav-item.active { color: var(--primary); font-weight: bold; }
    .nav-item i { font-size: 22px; }

    /* Modal */
    .modal {
      position: fixed; inset: 0; background: rgba(0,0,0,0.85); backdrop-filter: blur(5px);
      display: none; padding: 15px; z-index: 1000; overflow-y: auto;
    }
    .modal.show { display: block; }
    .modal-content { background: var(--card); padding: 20px; border-radius: 24px; border: 1px solid var(--border); }
    .field-label { display: block; font-size: 13px; color: var(--muted); margin: 10px 5px 5px 0; }
    
    .badge { position: absolute; top: -5px; left: 50%; transform: translateX(5px); background: var(--danger); font-size: 10px; padding: 2px 6px; border-radius: 10px; color: #fff; }
  </style>
</head>
<body>

<div class="header">
  <div style="font-weight: 900; font-size: 22px; letter-spacing: -1px;">MAD <span style="color:var(--primary)">MANAGER</span></div>
  <div style="display:flex; gap:10px;">
    <button class="btn btn-outline" onclick="load()" style="padding: 8px; border-radius: 50%; width: 40px; height: 40px;"><i class="fa fa-sync"></i></button>
    <button class="btn btn-primary" onclick="openAddModal()" style="padding: 8px 15px; border-radius: 12px;"><i class="fa fa-plus"></i> Ø·Ù„Ø¨ Ø¬Ø¯ÙŠØ¯</button>
  </div>
</div>

<div class="search-area">
  <div class="input-group">
    <i class="fa fa-search"></i>
    <input type="text" id="searchInput" placeholder="Ø¨Ø­Ø« Ø¨Ø§Ø³Ù… Ø§Ù„Ø¹Ù…ÙŠÙ„ØŒ Ø§Ù„Ø±Ù‚Ù…ØŒ Ø£Ùˆ Ø§Ù„ÙƒÙˆØ¯..." oninput="renderOrders()">
  </div>
</div>

<div class="container" id="ordersList">
  </div>

<div class="bottom-nav">
  <a href="#" class="nav-item active" onclick="setFilter('NEW', this)">
    <div style="position:relative; display:inline-block;"><i class="fa fa-inbox"></i><span id="countNew" class="badge">0</span></div>
    <span>Ø¬Ø¯ÙŠØ¯</span>
  </a>
  <a href="#" class="nav-item" onclick="setFilter('PREP', this)">
    <i class="fa fa-tools"></i>
    <span>Ù„Ù„ØªØ¬Ù‡ÙŠØ²</span>
  </a>
  <a href="#" class="nav-item" onclick="setFilter('READY', this)">
    <i class="fa fa-shipping-fast"></i>
    <span>Ø¬Ø§Ù‡Ø²</span>
  </a>
  <a href="#" class="nav-item" onclick="setFilter('ALL', this)">
    <i class="fa fa-list"></i>
    <span>Ø§Ù„ÙƒÙ„</span>
  </a>
</div>

<div class="modal" id="orderModal">
  <div class="modal-content">
    <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:20px;">
        <h2 id="modalTitle" style="margin:0; font-size:20px;">Ø¥Ø¶Ø§ÙØ© Ø·Ù„Ø¨</h2>
        <button onclick="closeModal()" style="background:none; border:none; color:var(--muted); font-size:24px;">&times;</button>
    </div>
    
    <div style="background:rgba(255,255,255,0.03); padding:12px; border-radius:15px; margin-bottom:15px;">
        <label class="field-label" style="margin-top:0;">Ø§Ù„ØªØ­Ù„ÙŠÙ„ Ø§Ù„Ø°ÙƒÙŠ (Ø§Ù„ØµÙ‚ Ù†Øµ Ø§Ù„ÙˆØ§ØªØ³Ø§Ø¨ Ù‡Ù†Ø§)</label>
        <div style="display:flex; gap:8px;">
            <textarea id="rawText" placeholder="Ø§Ù„Ø§Ø³Ù…ØŒ Ø§Ù„Ø±Ù‚Ù…ØŒ Ø§Ù„Ø¹Ø·Ø±ØŒ Ø§Ù„Ø³Ø¹Ø±..." style="height: 70px; padding:10px;"></textarea>
            <button class="btn btn-primary" onclick="magicParse()" style="width:60px;"><i class="fa fa-wand-magic-sparkles" style="font-size:20px;"></i></button>
        </div>
    </div>

    <div style="display:grid; grid-template-columns:1fr 1fr; gap:10px;">
        <div>
            <label class="field-label">Ø§Ø³Ù… Ø§Ù„Ø¹Ù…ÙŠÙ„</label>
            <input type="text" id="f_name" placeholder="Ø§Ù„Ø§Ø³Ù…">
        </div>
        <div>
            <label class="field-label">Ø±Ù‚Ù… Ø§Ù„Ù‡Ø§ØªÙ</label>
            <input type="tel" id="f_phone" placeholder="05x-xxxxxxx">
        </div>
    </div>

    <label class="field-label">Ø§Ù„Ø·Ù„Ø¨Ø§Øª (Ø§Ù„Ø£ÙƒÙˆØ§Ø¯)</label>
    <input type="text" id="f_offer" placeholder="W101, M202...">

    <div style="display:grid; grid-template-columns:1fr 1fr; gap:10px;">
        <div>
            <label class="field-label">Ø§Ù„Ø³Ø¹Ø± (â‚ª)</label>
            <input type="number" id="f_price" placeholder="0.00">
        </div>
        <div>
            <label class="field-label">Ø·Ø±ÙŠÙ‚Ø© Ø§Ù„Ø¯ÙØ¹</label>
            <select id="f_payment">
                <option value="Ù†Ù‚Ø¯Ø§Ù‹">Ù†Ù‚Ø¯Ø§Ù‹ (××–×•××Ÿ)</option>
                <option value="Ù…Ø¯ÙÙˆØ¹">Ù…Ø¯ÙÙˆØ¹ (×©×•×œ×)</option>
                <option value="Ù…Ø¯ÙÙˆØ¹ Ø¨Ø§Ù„Ø±Ø§Ø¨Ø·">Ù…Ø¯ÙÙˆØ¹ Ø¨Ø§Ù„Ø±Ø§Ø¨Ø·</option>
            </select>
        </div>
    </div>

    <label class="field-label">Ø´Ø±ÙƒØ© Ø§Ù„ØªÙˆØµÙŠÙ„ ğŸšš</label>
    <select id="f_delivery">
        <option value="">-- Ø§Ø®ØªØ± Ø§Ù„Ø´Ø±ÙƒØ© --</option>
        <option value="High Express">High Express (Ù‡Ø§ÙŠ Ø§ÙƒØ³Ø¨Ø±Ø³)</option>
        <option value="Marwah Delivery">Marwah (Ù…Ø±ÙˆØ©)</option>
        <option value="Lama Delivery">Lama (Ù„Ù…Ù‰)</option>
        <option value="Areen Delivery">Areen (Ø¹Ø±ÙŠÙ†)</option>
        <option value="Pickup">Ø§Ø³ØªÙ„Ø§Ù… Ø°Ø§ØªÙŠ</option>
    </select>

    <label class="field-label">Ø§Ù„Ø¹Ù†ÙˆØ§Ù† / Ø§Ù„Ø¨Ù„Ø¯</label>
    <input type="text" id="f_addr" placeholder="Ø§Ù„Ø¨Ù„Ø¯ØŒ Ø§Ù„Ø­ÙŠØŒ Ø§Ù„Ø´Ø§Ø±Ø¹...">

    <div class="actions" style="margin-top:25px;">
      <button class="btn btn-outline" onclick="closeModal()">Ø¥ØºÙ„Ø§Ù‚</button>
      <button class="btn btn-success" onclick="saveOrder(true)">Ø­ÙØ¸ ÙˆØ§Ø¹ØªÙ…Ø§Ø¯ âœ…</button>
    </div>
  </div>
</div>

<script>
// Ø§Ù„Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª - ØªØ£ÙƒØ¯ Ù…Ù† ØµØ­Ø© Ø§Ù„Ø±Ø§Ø¨Ø· ÙˆØ§Ù„Ù€ Key
const SCRIPT_URL = "https://script.google.com/macros/s/AKfycbyLjLFa8AaH82Ip7m747WC-KSUUEaU_M70S0I9Mda14XbnmcuEfZ7pBnF_zzJYZuXmZ/exec";
const DASH_KEY = "12345678";

let allOrders = [];
let currentFilter = 'NEW';
let editingRow = null;

// ØªØ´ØºÙŠÙ„ Ø§Ù„Ù†Ø¸Ø§Ù…
async function load() {
  document.body.style.opacity = "0.7";
  try {
    const res = await fetch(`${SCRIPT_URL}?action=get&_=${Date.now()}`);
    const data = await res.json();
    allOrders = data.filter(o => o.rowIndex);
    updateStats();
    renderOrders();
  } catch (e) { console.error("Data fetch error"); }
  document.body.style.opacity = "1";
}

function updateStats() {
  const newOnes = allOrders.filter(o => isNew(o)).length;
  document.getElementById('countNew').textContent = newOnes;
}

function setFilter(f, el) {
  currentFilter = f;
  document.querySelectorAll('.nav-item').forEach(i => i.classList.remove('active'));
  el.classList.add('active');
  renderOrders();
}

// Ù‚ÙˆØ§Ø¹Ø¯ Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† Ø§Ù„Ø­Ø§Ù„Ø©
const isNew = (o) => {
    const s = (o.status || "").toLowerCase();
    return s.includes('new') || s === "" || s.includes('inbox') || s.includes('pending');
};
const isPrep = (o) => (o.status || "").includes('Approved') || (o.status || "").includes('ØªØ¬Ù‡ÙŠØ²');
const isReady = (o) => (o.status || "").includes('READY') || (o.status || "").includes('Ø¬Ø§Ù‡Ø²');

// Ø¹Ø±Ø¶ Ø§Ù„Ø·Ù„Ø¨Ø§Øª
function renderOrders() {
  const container = document.getElementById('ordersList');
  const query = document.getElementById('searchInput').value.replace(/[-\s]/g, "").toLowerCase(); // ØªØ¬Ø§ÙˆØ² Ø§Ù„Ø£Ø´Ø±Ø·Ø© ÙÙŠ Ø§Ù„Ø¨Ø­Ø«
  
  let filtered = allOrders.filter(o => {
    const cleanPhone = String(o.phone || "").replace(/[-\s]/g, "");
    const blob = (o.name + o.orderId + cleanPhone + o.offer + (o.addr||"") + (o.city||"")).toLowerCase();
    const matchSearch = blob.includes(query);
    
    if (currentFilter === 'NEW') return matchSearch && isNew(o);
    if (currentFilter === 'PREP') return matchSearch && isPrep(o);
    if (currentFilter === 'READY') return matchSearch && isReady(o);
    return matchSearch;
  });

  filtered.sort((a,b) => b.rowIndex - a.rowIndex);

  if(filtered.length === 0) {
    container.innerHTML = `<div style="text-align:center; padding:50px; color:var(--muted);">Ù„Ø§ ÙŠÙˆØ¬Ø¯ Ø·Ù„Ø¨Ø§Øª Ø­Ø§Ù„ÙŠØ§Ù‹</div>`;
    return;
  }

  container.innerHTML = filtered.map(o => `
    <div class="order-card">
      <div class="order-header">
        <span class="order-id"><i class="fa fa-hashtag"></i> ${o.orderId}</span>
        <span class="status-pill">${o.status || 'Ø¬Ø¯ÙŠØ¯'}</span>
      </div>
      <div onclick="openEditModal(${o.rowIndex})">
        <h3>${o.name || 'Ø¹Ù…ÙŠÙ„ Ø¬Ø¯ÙŠØ¯'}</h3>
        <div class="info-row"><i class="fa fa-phone"></i> ${o.phone}</div>
        <div class="info-row"><i class="fa fa-shopping-bag"></i> ${o.offer}</div>
        <div class="info-row"><i class="fa fa-truck"></i> ${o.delivery || 'ØªÙˆØµÙŠÙ„ Ø¹Ø§Ø¯ÙŠ'}</div>
        <div class="info-row"><i class="fa fa-map-marker-alt"></i> ${o.addr || o.city || 'Ø§Ù„Ø¹Ù†ÙˆØ§Ù† ØºÙŠØ± Ù…Ø­Ø¯Ø¯'}</div>
        <span class="price-tag">${o.price} â‚ª <small style="font-size:12px; color:var(--muted)">(${o.payment || 'Ù†Ù‚Ø¯Ø§Ù‹'})</small></span>
      </div>
      <div class="actions">
        <a href="https://wa.me/${normalizePhone(o.phone)}" target="_blank" class="btn btn-wa"><i class="fab fa-whatsapp"></i> ÙˆØ§ØªØ³Ø§Ø¨</a>
        ${isNew(o) ? 
          `<button class="btn btn-success" onclick="quickApprove(${o.rowIndex})"><i class="fa fa-check"></i> Ø§Ø¹ØªÙ…Ø§Ø¯</button>` : 
          `<button class="btn btn-outline" onclick="openEditModal(${o.rowIndex})"><i class="fa fa-edit"></i> ØªØ¹Ø¯ÙŠÙ„</button>`
        }
      </div>
    </div>
  `).join('');
}

// Ø§Ù„ØªØ­Ù„ÙŠÙ„ Ø§Ù„Ø°ÙƒÙŠ Ø§Ù„Ù…Ø­Ø³Ù†
function magicParse() {
  const text = document.getElementById('rawText').value;
  if(!text) return;
  
  // ØªÙ†Ø¸ÙŠÙ Ø§Ù„Ø±Ù‚Ù… Ù…Ù† Ø§Ù„Ø£Ø´Ø±Ø·Ø© ÙÙˆØ±Ø§Ù‹ Ø¹Ù†Ø¯ Ø§Ù„Ù„ØµÙ‚
  const phoneMatch = text.replace(/[-\s]/g, "").match(/(05\d{8})/);
  const priceMatch = text.match(/(\d{2,4})\s*(â‚ª|Ø´ÙŠÙƒÙ„|ils|nis)/i);
  
  if(phoneMatch) document.getElementById('f_phone').value = phoneMatch[1];
  if(priceMatch) document.getElementById('f_price').value = priceMatch[1];
  
  // ÙƒØ´Ù Ø§Ù„Ø´Ø±ÙƒØ©
  if(/Ù‡Ø§ÙŠ|High|Express/i.test(text)) document.getElementById('f_delivery').value = "High Express";
  else if(/Ù…Ø±ÙˆØ©|Marwah/i.test(text)) document.getElementById('f_delivery').value = "Marwah Delivery";
  else if(/Ù„Ù…Ù‰|Lama/i.test(text)) document.getElementById('f_delivery').value = "Lama Delivery";
  else if(/Ø¹Ø±ÙŠÙ†|Areen/i.test(text)) document.getElementById('f_delivery').value = "Areen Delivery";

  // Ø§Ù„Ø¯ÙØ¹
  if(/Ù…Ø¯ÙÙˆØ¹|Ø´×•×œ×|paid/i.test(text)) document.getElementById('f_payment').value = "Ù…Ø¯ÙÙˆØ¹";
  if(/Ø±Ø§Ø¨Ø·|×§×™×©×•×¨|link/i.test(text)) document.getElementById('f_payment').value = "Ù…Ø¯ÙÙˆØ¹ Ø¨Ø§Ù„Ø±Ø§Ø¨Ø·";

  // Ø§Ø³ØªØ®Ø±Ø§Ø¬ Ø§Ù„Ø§Ø³Ù… (Ø£ÙˆÙ„ Ø³Ø·Ø± Ù„ÙŠØ³ ÙÙŠÙ‡ Ø£Ø±Ù‚Ø§Ù… ÙƒØ«ÙŠØ±Ø©)
  const lines = text.split('\n').map(l => l.trim()).filter(l => l.length > 2);
  if(lines.length > 0) document.getElementById('f_name').value = lines[0];

  alert("ØªÙ… Ø§Ù„ØªØ­Ù„ÙŠÙ„ Ø§Ù„Ø°ÙƒÙŠ ÙˆØªØ­Ø¯ÙŠØ« Ø§Ù„Ø­Ù‚ÙˆÙ„ âœ¨");
}

async function saveOrder(approve = false) {
  const payload = {
    action: editingRow ? "updateOrder" : "addOrder",
    key: DASH_KEY,
    row: editingRow,
    name: document.getElementById('f_name').value,
    phone: document.getElementById('f_phone').value.replace(/[-\s]/g, ""),
    offer: document.getElementById('f_offer').value,
    price: document.getElementById('f_price').value,
    payment: document.getElementById('f_payment').value,
    addr: document.getElementById('f_addr').value,
    delivery: document.getElementById('f_delivery').value,
    status: approve ? "Approved âœ… (Sent to Prep)" : "NEW"
  };

  if(!payload.phone) return alert("Ø±Ù‚Ù… Ø§Ù„Ù‡Ø§ØªÙ Ù…Ø·Ù„ÙˆØ¨");
  
  closeModal();
  try {
    const res = await fetch(`${SCRIPT_URL}?` + new URLSearchParams(payload).toString());
    const data = await res.json();
    if(data.result === "SUCCESS") load();
  } catch(e) { alert("ØªÙ… Ø§Ù„Ø­ÙØ¸ Ø¨Ù†Ø¬Ø§Ø­ (ÙŠØ±Ø¬Ù‰ Ø§Ù„ØªØ­Ø¯ÙŠØ«)"); load(); }
}

function openAddModal() {
  editingRow = null;
  document.getElementById('modalTitle').textContent = "Ø¥Ø¶Ø§ÙØ© Ø·Ù„Ø¨ Ø¬Ø¯ÙŠØ¯";
  ['f_name','f_phone','f_offer','f_price','f_addr','rawText'].forEach(id => document.getElementById(id).value = "");
  document.getElementById('f_delivery').value = "";
  document.getElementById('f_payment').value = "Ù†Ù‚Ø¯Ø§Ù‹";
  document.getElementById('orderModal').classList.add('show');
}

function openEditModal(row) {
  const o = allOrders.find(x => x.rowIndex == row);
  if (!o) return;
  editingRow = row;
  document.getElementById('modalTitle').textContent = "ØªØ¹Ø¯ÙŠÙ„ #" + o.orderId;
  document.getElementById('f_name').value = o.name || "";
  document.getElementById('f_phone').value = o.phone || "";
  document.getElementById('f_offer').value = o.offer || "";
  document.getElementById('f_price').value = o.price || "";
  document.getElementById('f_payment').value = o.payment || "Ù†Ù‚Ø¯Ø§Ù‹";
  document.getElementById('f_delivery').value = o.delivery || "";
  document.getElementById('f_addr').value = o.addr || o.city || "";
  document.getElementById('orderModal').classList.add('show');
}

function closeModal() { document.getElementById('orderModal').classList.remove('show'); }

async function quickApprove(row) {
  const url = `${SCRIPT_URL}?action=updateStatus&key=${DASH_KEY}&row=${row}&status=${encodeURIComponent("Approved âœ… (Sent to Prep)")}`;
  await fetch(url);
  load();
}

function normalizePhone(p) {
  let d = String(p).replace(/[^\d]/g,"");
  if(d.startsWith("05")) return "972" + d.substring(1);
  return d;
}

// Ø¨Ø¯Ø¡ Ø§Ù„ØªØ­Ù…ÙŠÙ„ Ø¹Ù†Ø¯ ÙØªØ­ Ø§Ù„ØµÙØ­Ø©
window.onload = load;
</script>

</body>
</html>
