<!doctype html>
<html lang="ar" dir="rtl">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width,initial-scale=1,maximum-scale=1,user-scalable=0"/>
  <title>MAD Manager v4.6 - Latest Orders First</title>
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">

  <style>
    :root {
      --bg: #0a0f1e;
      --card: #161b2c;
      --primary: #3b82f6;
      --success: #10b981;
      --ready: #f59e0b;
      --hebrew: #8b5cf6;
      --danger: #ef4444;
      --text: #f8fafc;
      --muted: #94a3b8;
      --border: rgba(255,255,255,0.08);
      --grad: linear-gradient(135deg, #3b82f6 0%, #2563eb 100%);
    }

    body {
      margin: 0; font-family: 'Segoe UI', Roboto, system-ui, sans-serif;
      background: var(--bg); color: var(--text); padding-bottom: 90px;
      line-height: 1.5;
    }

    .header {
      background: rgba(16, 21, 36, 0.85); backdrop-filter: blur(12px);
      padding: 12px 16px; position: sticky; top: 0; z-index: 100;
      border-bottom: 1px solid var(--border);
    }

    .container { padding: 16px; max-width: 600px; margin: 0 auto; }

    .order-card {
      background: var(--card); border-radius: 24px; padding: 20px;
      margin-bottom: 20px; border: 1px solid var(--border);
      box-shadow: 0 10px 25px rgba(0,0,0,0.4);
      transition: transform 0.2s;
    }

    .card-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 12px; }
    .order-id { font-family: monospace; color: var(--muted); background: rgba(255,255,255,0.05); padding: 2px 8px; border-radius: 6px; font-size: 13px; }

    .status-pill { font-size: 11px; padding: 4px 12px; border-radius: 20px; font-weight: 700; text-transform: uppercase; }
    .status-new { background: rgba(59, 130, 246, 0.1); color: #60a5fa; }
    .status-prep { background: rgba(16, 185, 129, 0.1); color: #34d399; }

    .customer-name { font-size: 19px; font-weight: 800; display: block; margin-bottom: 4px; }
    .customer-phone { color: var(--muted); font-size: 14px; display: flex; align-items: center; gap: 6px; }
    
    .offer-details {
      margin: 12px 0; padding: 12px; background: rgba(59, 130, 246, 0.05);
      border-radius: 12px; color: #93c5fd; font-weight: 600; border-right: 3px solid var(--primary);
      font-size: 14px;
    }

    .meta-line { display: flex; flex-wrap: wrap; gap: 10px; font-size: 12px; color: var(--muted); margin-top: 8px; }
    .meta-tag { background: rgba(255,255,255,0.05); padding: 2px 8px; border-radius: 6px; }

    .actions-grid { display: grid; grid-template-columns: repeat(4, 1fr); gap: 8px; margin-top: 20px; }
    .actions-secondary { display: grid; grid-template-columns: 1fr 1fr; gap: 8px; margin-top: 8px; }

    .btn {
      padding: 10px 4px; border-radius: 14px; border: none; font-weight: 700;
      cursor: pointer; display: flex; flex-direction: column; align-items: center; justify-content: center;
      font-size: 10px; transition: 0.2s; gap: 6px; text-decoration: none;
    }
    .btn i { font-size: 18px; }
    .btn-primary { background: var(--grad); color: white; }
    .btn-success { background: #059669; color: white; }
    .btn-wa-ar { background: #d97706; color: white; }
    .btn-wa-he { background: #7c3aed; color: white; }
    .btn-outline { background: rgba(255,255,255,0.03); color: white; border: 1px solid var(--border); }

    .modal-overlay {
      position: fixed; inset: 0; background: rgba(0,0,0,0.8); backdrop-filter: blur(8px);
      display: none; align-items: center; justify-content: center; z-index: 2000; padding: 20px;
    }
    .modal-overlay.show { display: flex; }
    .modal-content { background: var(--card); width: 100%; max-width: 450px; padding: 24px; border-radius: 32px; border: 1px solid var(--border); overflow-y: auto; max-height: 90vh; }

    .smart-box { background: rgba(59, 130, 246, 0.1); border: 1px dashed var(--primary); padding: 15px; border-radius: 16px; margin-bottom: 20px; }
    .smart-box h4 { margin: 0 0 10px 0; font-size: 14px; color: var(--primary); display: flex; align-items: center; gap: 8px; }

    input, select, textarea { width: 100%; padding: 12px; margin-bottom: 12px; border-radius: 12px; border: 1px solid var(--border); background: rgba(0,0,0,0.2); color: white; outline: none; font-size: 15px; box-sizing: border-box; }
    input:focus, textarea:focus { border-color: var(--primary); background: rgba(0,0,0,0.4); }

    .invoice-box { background: white; color: black; width: 98mm; height: 98mm; padding: 8mm; box-sizing: border-box; display: flex; flex-direction: column; position: relative; border-radius: 2px; }
    .inv-header { text-align: center; border-bottom: 2px solid #000; padding-bottom: 8px; margin-bottom: 10px; }
    .inv-footer { border-top: 2px solid #000; padding-top: 8px; display: flex; justify-content: space-between; align-items: flex-end; }

    #toast { position: fixed; bottom: 30px; left: 50%; transform: translateX(-50%); background: #10b981; color: white; padding: 14px 28px; border-radius: 50px; font-weight: 700; z-index: 3000; display: none; box-shadow: 0 10px 20px rgba(0,0,0,0.3); }
    #loadingOverlay { position: fixed; inset: 0; background: rgba(6, 9, 20, 0.7); z-index: 4000; display: none; align-items: center; justify-content: center; backdrop-filter: blur(4px); }
    .spinner { width: 44px; height: 44px; border: 4px solid rgba(59, 130, 246, 0.1); border-top-color: var(--primary); border-radius: 50%; animation: spin 0.8s infinite; }
    @keyframes spin { to { transform: rotate(360deg); } }

    @media print {
      body * { visibility: hidden; }
      #invoicePreview, #invoicePreview * { visibility: visible; }
      #invoicePreview { position: fixed; left: 0; top: 0; width: 98mm; height: 98mm; border: none; padding: 8mm; margin: 0; }
      .no-print { display: none !important; }
      @page { size: 98mm 98mm; margin: 0; }
    }
  </style>
</head>
<body>

<div id="loadingOverlay"><div class="spinner"></div></div>
<div id="toast">âœ… ØªÙ…Øª Ø§Ù„Ø¹Ù…Ù„ÙŠØ©</div>

<!-- Invoice Preview Modal -->
<div class="modal-overlay" id="printModal">
  <div class="invoice-box" id="invoicePreview">
    <div class="inv-header">
      <h1 style="margin:0; font-size: 32px; letter-spacing: 4px; font-weight: 900;">MAD</h1>
      <div style="font-size: 11px; font-weight: 800; color: #333;">PARFUMEUR</div>
      <div style="display: flex; justify-content: space-between; font-size: 10px; font-weight: 900; margin-top:8px; border-top: 1px solid #eee; padding-top: 4px;">
        <span id="p_date">DATE: 00.00.0000</span>
        <span id="p_ord">ORD: MAD-00000</span>
      </div>
    </div>
    <div class="inv-body" id="p_content_lang" style="font-size: 12px; flex-grow: 1; line-height: 1.5;"></div>
    <div class="inv-footer">
      <div style="text-align:center;">
        <img id="p_qr" src="" style="width:48px; height:48px; border:1px solid #000;">
        <div id="p_footer_phone" style="font-size:9px; font-weight:900; margin-top:4px;"></div>
      </div>
      <div id="p_promo" style="font-size: 8px; text-align: center; flex: 1; padding: 0 8px; font-weight: 800;">ğŸ ØµÙˆØ± Ø§Ù„Ù„Ø­Ø¸Ø© ÙˆØ§Ø±Ø³Ù„Ù‡Ø§ ÙˆØ§ØªØ³Ø§Ø¨ ÙˆØ§Ø­ØµÙ„ Ø¹Ù„Ù‰ Ù‡Ø¯ÙŠØ© ÙÙˆØ±ÙŠØ©!</div>
      <div style="text-align: left;">
        <div id="p_label_total" style="font-size: 11px; font-weight: 700;">TOTAL:</div>
        <div style="font-size: 24px; font-weight: 900; color: #000;">â‚ª<span id="p_total">0</span></div>
      </div>
    </div>
    <div style="position: absolute; bottom: -75px; left: 0; right: 0; display: flex; gap: 12px; justify-content: center;" class="no-print">
      <button class="btn btn-outline" onclick="closeModal('printModal')" style="flex-direction:row; padding:10px 20px;">Ø¥Ù„ØºØ§Ø¡</button>
      <button class="btn btn-primary" onclick="window.print()" style="flex-direction:row; padding:10px 20px;"><i class="fa fa-print"></i> Ø·Ø¨Ø§Ø¹Ø© Ø§Ù„ÙˆØµÙ„</button>
    </div>
  </div>
</div>

<!-- Order Modal (Add/Edit) -->
<div class="modal-overlay" id="orderModal">
  <div class="modal-content">
    <h3 id="modalTitle" style="margin-top:0;">Ø¥Ø¶Ø§ÙØ© Ø·Ù„Ø¨ Ø¬Ø¯ÙŠØ¯</h3>
    
    <!-- Smart Analysis Section -->
    <div class="smart-box" id="smartSection">
        <h4><i class="fa fa-magic"></i> Ø§Ù„Ù…Ø­Ù„Ù„ Ø§Ù„Ø°ÙƒÙŠ Ù„Ù„Ø¨ÙŠØ§Ù†Ø§Øª</h4>
        <textarea id="smartInput" placeholder="Ø§Ù„ØµÙ‚ Ù†Øµ Ø§Ù„Ø·Ù„Ø¨ Ù‡Ù†Ø§ (Ø§Ù„Ø§Ø³Ù…ØŒ Ø§Ù„Ù‡Ø§ØªÙØŒ Ø§Ù„Ø¹Ù†ÙˆØ§Ù†...) Ø«Ù… Ø§Ø¶ØºØ· ØªØ­Ù„ÙŠÙ„..." style="height: 80px; margin-bottom: 8px; font-size: 13px;"></textarea>
        <button class="btn btn-primary" onclick="analyzeText()" style="width: 100%; flex-direction: row; height: 35px; font-size: 13px;">ØªØ­Ù„ÙŠÙ„ ÙˆØªØ¹Ø¨Ø¦Ø© ØªÙ„Ù‚Ø§Ø¦ÙŠØ©</button>
    </div>

    <label>Ø§Ù„Ø§Ø³Ù… Ø§Ù„ÙƒØ§Ù…Ù„</label><input type="text" id="f_name">
    <label>Ø±Ù‚Ù… Ø§Ù„Ù‡Ø§ØªÙ</label><input type="tel" id="f_phone">
    <label>Ø§Ù„Ø£ØµÙ†Ø§Ù Ø§Ù„Ù…Ø·Ù„ÙˆØ¨Ø©</label><textarea id="f_offer" rows="2"></textarea>
    <div style="display:grid; grid-template-columns: 1fr 1fr; gap:10px;">
      <div><label>Ø§Ù„Ø³Ø¹Ø± (â‚ª)</label><input type="number" id="f_price"></div>
      <div>
        <label>Ø·Ø±ÙŠÙ‚Ø© Ø§Ù„Ø¯ÙØ¹</label>
        <select id="f_payment">
          <option value="Ø¯ÙØ¹ Ø¹Ù†Ø¯ Ø§Ù„Ø§Ø³ØªÙ„Ø§Ù…">Ø¯ÙØ¹ Ø¹Ù†Ø¯ Ø§Ù„Ø§Ø³ØªÙ„Ø§Ù…</option>
          <option value="Ø´Ø±Ø§Ø¡ Ù…Ù† Ø§Ù„Ù…ÙˆÙ‚Ø¹ - Ù…Ø¯ÙÙˆØ¹">Ø´Ø±Ø§Ø¡ Ù…Ù† Ø§Ù„Ù…ÙˆÙ‚Ø¹ - Ù…Ø¯ÙÙˆØ¹</option>
          <option value="Ø´Ø±Ø§Ø¡ Ø¹Ø¨Ø± Ø§Ù„Ø±Ø§Ø¨Ø·">Ø´Ø±Ø§Ø¡ Ø¹Ø¨Ø± Ø§Ù„Ø±Ø§Ø¨Ø·</option>
        </select>
      </div>
    </div>
    <label>Ø§Ù„Ù…Ø¯ÙŠÙ†Ø©</label><input type="text" id="f_city">
    <label>Ù…Ù„Ø§Ø­Ø¸Ø§Øª Ø¥Ø¶Ø§ÙÙŠØ©</label><textarea id="f_notes" rows="2"></textarea>
    <label>Ø´Ø±ÙƒØ© Ø§Ù„ØªÙˆØµÙŠÙ„</label>
    <select id="f_delivery">
      <option value="">-- Ø§Ø®ØªØ± Ø´Ø±ÙƒØ© Ø§Ù„Ø´Ø­Ù† --</option>
      <option value="High Express (050-9566919)">High Express (050-9566919)</option>
      <option value="Lama (050-5102019)">Lama (050-5102019)</option>
      <option value="Marwah (052-7035370)">Marwah (052-7035370)</option>
      <option value="Areen (052-5118966)">Areen (052-5118966)</option>
      <option value="Pickup">Pickup</option>
    </select>
    <div style="display:grid; grid-template-columns: 1fr 1fr; gap:10px; margin-top:10px;">
      <button class="btn btn-outline" onclick="closeModal('orderModal')">Ø¥Ù„ØºØ§Ø¡</button>
      <button class="btn btn-primary" onclick="saveOrder()" id="saveBtn">Ø­ÙØ¸ Ø§Ù„Ø·Ù„Ø¨ âœ¨</button>
    </div>
  </div>
</div>

<div class="header">
  <div class="header-top" style="display:flex; justify-content:space-between; align-items:center;">
    <div class="logo" style="font-weight:900; font-size:20px;">MAD <span>MANAGER</span></div>
    <div style="display:flex; gap:10px;">
      <button class="btn btn-outline" onclick="load()" style="width:40px; height:40px;"><i class="fa fa-sync"></i></button>
      <button class="btn btn-primary" onclick="openAddModal()" style="width:40px; height:40px;"><i class="fa fa-plus"></i></button>
    </div>
  </div>
  <div style="margin-top:10px;">
    <input type="text" id="searchInput" placeholder="Ø¨Ø­Ø« Ø¨Ø§Ø³Ù… Ø§Ù„Ø¹Ù…ÙŠÙ„ Ø£Ùˆ Ø±Ù‚Ù… Ø§Ù„Ù‡Ø§ØªÙ..." oninput="filterOrders()" style="margin-bottom:0; background:rgba(255,255,255,0.05);">
  </div>
</div>

<div class="container" id="ordersList"></div>

<script>
const SCRIPT_URL = "https://script.google.com/macros/s/AKfycbwWi55Q1H1HNdJb61Ht99ZiZodp4B4aaElWSqSuxo37zhKUwRgy8T-NHNPffH4i_Y89Eg/exec";
const DASH_KEY = "12345678";
let allOrders = [];
let editingRow = null;

function showLoading(s) { document.getElementById('loadingOverlay').style.display = s ? 'flex' : 'none'; }
function showToast(m) { const t = document.getElementById('toast'); t.textContent = m; t.style.display = 'block'; setTimeout(() => t.style.display = 'none', 2500); }

const safe = (v) => (v === undefined || v === null || String(v).toLowerCase()==="undefined" || String(v).toLowerCase()==="null") ? "" : String(v).trim();

function formatLocalPhone(p) {
  if(!p) return "";
  let d = String(p).replace(/\D/g, "");
  if (d.startsWith("972")) d = "0" + d.substring(3);
  if (!d.startsWith("0") && d.length === 9) d = "0" + d;
  return d;
}

function normalizePhoneForLink(p) { 
  let d = String(p||"").replace(/\D/g, ""); 
  if (d.startsWith("0")) d = "972" + d.substring(1); 
  return d; 
}

function analyzeText() {
    const raw = document.getElementById('smartInput').value;
    if(!raw.trim()) return showToast("Ø§Ù„ØµÙ‚ Ù†ØµØ§Ù‹ Ø£ÙˆÙ„Ø§Ù‹");

    const phoneMatch = raw.match(/(?:05|972|5)\d{8,11}/);
    if(phoneMatch) document.getElementById('f_phone').value = formatLocalPhone(phoneMatch[0]);

    const priceMatch = raw.match(/(\d{2,4})\s*(?:â‚ª|shekel|ILS|Ø§Ù„Ø³Ø¹Ø±)/i) || raw.match(/(?:â‚ª|Ø§Ù„Ø³Ø¹Ø±|Price)\s*:?\s*(\d{2,4})/i);
    if(priceMatch) document.getElementById('f_price').value = priceMatch[1];

    const nameMatch = raw.match(/(?:Ø§Ù„Ø§Ø³Ù…|Name)\s*:?\s*([^\n|]+)/i);
    if(nameMatch) {
        document.getElementById('f_name').value = nameMatch[1].trim();
    } else {
        const firstLine = raw.split('\n')[0].trim();
        if(firstLine.length < 30) document.getElementById('f_name').value = firstLine;
    }

    const cityMatch = raw.match(/(?:Ø§Ù„Ù…Ø¯ÙŠÙ†Ø©|city|Ø¹Ù†ÙˆØ§Ù†|Ù…Ù†)\s*:?\s*([^\n|]+)/i);
    if(cityMatch) document.getElementById('f_city').value = cityMatch[1].trim();

    document.getElementById('f_offer').value = raw.substring(0, 100).trim();

    showToast("ØªÙ… ØªØ­Ù„ÙŠÙ„ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ø¨Ù†Ø¬Ø§Ø­ âš¡");
}

async function load() {
  showLoading(true);
  try {
    const res = await fetch(`${SCRIPT_URL}?action=get&_=${Date.now()}`);
    allOrders = await res.json();
    renderOrders(allOrders);
  } catch(e) { showToast("Ø®Ø·Ø£ ÙÙŠ Ø¬Ù„Ø¨ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª"); }
  showLoading(false);
}

function filterOrders() {
    const term = document.getElementById('searchInput').value.toLowerCase();
    const filtered = allOrders.filter(o => safe(o.name).toLowerCase().includes(term) || safe(o.phone).includes(term));
    renderOrders(filtered);
}

/**
 * Ø¯Ø§Ù„Ø© Ø§Ù„Ø¹Ø±Ø¶ - ØªÙ… ØªØ¹Ø¯ÙŠÙ„Ù‡Ø§ Ù„Ø¹Ø±Ø¶ Ø¢Ø®Ø± Ø·Ù„Ø¨ ÙÙŠ Ø§Ù„Ø¨Ø¯Ø§ÙŠØ©
 */
function renderOrders(list) {
  const container = document.getElementById('ordersList');
  if (list.length === 0) {
    container.innerHTML = `<div style="text-align:center; padding:50px; color:var(--muted);">Ù„Ø§ ØªÙˆØ¬Ø¯ Ø·Ù„Ø¨Ø§Øª Ù„Ø¹Ø±Ø¶Ù‡Ø§</div>`;
    return;
  }
  
  // Ù†Ù‚ÙˆÙ… Ø¨Ù†Ø³Ø® Ø§Ù„Ù‚Ø§Ø¦Ù…Ø© ÙˆØ¹ÙƒØ³Ù‡Ø§ Ù„Ø¹Ø±Ø¶ Ø§Ù„Ø£Ø­Ø¯Ø« Ø£ÙˆÙ„Ø§Ù‹
  const reversedList = [...list].filter(o => o.rowIndex).reverse();

  container.innerHTML = reversedList.map(o => {
    const isPrep = (o.status || "").includes("ØªØ¬Ù‡ÙŠØ²");
    return `
    <div class="order-card">
      <div class="card-header">
        <small class="order-id">#${safe(o.orderId) || '---'}</small>
        <span class="status-pill ${isPrep ? 'status-prep' : 'status-new'}">${safe(o.status) || 'Ø¬Ø¯ÙŠØ¯'}</span>
      </div>
      <div onclick="openEditModal(${o.rowIndex})">
        <span class="customer-name">${safe(o.name)}</span>
        <div class="customer-phone"><i class="fa fa-phone"></i> ${formatLocalPhone(o.phone)}</div>
        <div class="offer-details">${safe(o.offer)}</div>
        <div class="meta-line">
           <span class="meta-tag">ğŸ“ ${safe(o.city)}</span>
           <span class="meta-tag">â‚ª${safe(o.price)}</span>
           <span class="meta-tag">ğŸ’³ ${safe(o.payment)}</span>
           <span class="meta-tag">ğŸšš ${safe(o.delivery)}</span>
        </div>
      </div>
      <div class="actions-grid">
        <button class="btn btn-wa-ar" onclick="sendMsg(${o.rowIndex}, 'ar')"><i class="fa-brands fa-whatsapp"></i><span>Ø¹Ø±Ø¨ÙŠ</span></button>
        <button class="btn btn-wa-he" onclick="sendMsg(${o.rowIndex}, 'he')"><i class="fa-brands fa-whatsapp"></i><span>×¢×‘×¨×™×ª</span></button>
        <button class="btn btn-success" onclick="approve(${o.rowIndex})"><i class="fa fa-check"></i><span>Ø§Ø¹ØªÙ…Ø§Ø¯</span></button>
        <button class="btn btn-outline" onclick="openEditModal(${o.rowIndex})"><i class="fa fa-edit"></i><span>ØªØ¹Ø¯ÙŠÙ„</span></button>
      </div>
      <div class="actions-secondary">
        <button class="btn btn-outline" onclick="openPrintModal(${o.rowIndex}, 'ar')"><i class="fa fa-print"></i><span>ÙˆØµÙ„ Ø¹</span></button>
        <button class="btn btn-outline" onclick="openPrintModal(${o.rowIndex}, 'he')"><i class="fa fa-print"></i><span>ÙˆØµÙ„ Ù‡Ù€</span></button>
      </div>
    </div>`;
  }).join('');
}

async function sendMsg(row, lang) {
  const o = allOrders.find(x => x.rowIndex == row);
  if(!o) return;
  const paymentMethod = safe(o.payment) || "Ø¯ÙØ¹ Ø¹Ù†Ø¯ Ø§Ù„Ø§Ø³ØªÙ„Ø§Ù…";
  const note = safe(o.notes) ? `%0AğŸ“ Ù…Ù„Ø§Ø­Ø¸Ø©: ${safe(o.notes)}` : "";
  const deliveryComp = safe(o.delivery) ? `%0AğŸšš Ø´Ø±ÙƒØ© Ø§Ù„ØªÙˆØµÙŠÙ„: ${safe(o.delivery)}` : "";
  const customerPhone = formatLocalPhone(o.phone);
  const msg = lang === 'ar' ? 
    `Ø£Ù‡Ù„Ø§Ù‹ Ø¨Ùƒ ${safe(o.name)} ÙÙŠ MAD Parfumeur ğŸ–¤%0AÙŠØ³Ø¹Ø¯Ù†Ø§ ØªØ£ÙƒÙŠØ¯ Ø·Ù„Ø¨Ùƒ Ø§Ù„Ù…Ù…ÙŠØ²!%0AğŸ’ Ø§Ù„Ø¹Ø±Ø¶: ${safe(o.offer)}%0AğŸ“ Ø§Ù„Ø¹Ù†ÙˆØ§Ù†: ${safe(o.city)}%0AğŸ’° Ø§Ù„Ø³Ø¹Ø±: ${safe(o.price)} â‚ª%0AğŸ’³ Ø§Ù„Ø¯ÙØ¹: ${paymentMethod}${deliveryComp}${note}%0AğŸ“ Ù‡Ø§ØªÙ Ø§Ù„ØªÙˆØ§ØµÙ„: ${â¦972509787730â©â©}` :
    `×©×œ×•× ${safe(o.name)} ğŸ‘‹, ×ª×•×“×” ×©×”×–×× ×ª ×-MAD Parfumeur%0AğŸ“¦ ×”××•×¦×¨: ${safe(o.offer)}%0AğŸ“ ×›×ª×•×‘×ª: ${safe(o.city)}%0AğŸ’° ××—×™×¨: ${safe(o.price)} â‚ª%0AğŸ’³ ×ª×©×œ×•×: ${paymentMethod}${deliveryComp}%0AğŸ“ ×˜×œ×¤×•×Ÿ: ${â¦972509787730}`;
  window.open(`https://wa.me/${normalizePhoneForLink(o.phone)}?text=${msg}`, '_blank');
}

async function approve(row) {
  showLoading(true);
  const o = allOrders.find(x => x.rowIndex == row);
  const p = new URLSearchParams({
    action: "updateOrder", key: DASH_KEY, row: row,
    offer: safe(o.offer), name: safe(o.name), phone: safe(o.phone), 
    city: safe(o.city), notes: safe(o.notes), 
    delivery: safe(o.delivery), payment: safe(o.payment), price: safe(o.price),
    status: "Ø¨Ø§Ù†ØªØ¸Ø§Ø± Ø§Ù„Ø¥Ø±Ø³Ø§Ù„ Ù„Ù„ØªØ¬Ù‡ÙŠØ²"
  });
  try {
    await fetch(`${SCRIPT_URL}?${p.toString()}`);
    showToast("ØªÙ… Ø§Ù„Ø§Ø¹ØªÙ…Ø§Ø¯ Ø¨Ù†Ø¬Ø§Ø­ âœ¨");
    load();
  } catch(e) { showToast("ÙØ´Ù„ Ø§Ù„ØªØ­Ø¯ÙŠØ«", true); showLoading(false); }
}

function openAddModal() {
  editingRow = null;
  document.getElementById('modalTitle').textContent = "Ø¥Ø¶Ø§ÙØ© Ø·Ù„Ø¨ Ø¬Ø¯ÙŠØ¯";
  document.getElementById('smartSection').style.display = 'block';
  document.getElementById('smartInput').value = "";
  document.getElementById('f_name').value = "";
  document.getElementById('f_phone').value = "";
  document.getElementById('f_offer').value = "";
  document.getElementById('f_price').value = "";
  document.getElementById('f_city').value = "";
  document.getElementById('f_notes').value = "";
  document.getElementById('orderModal').classList.add('show');
}

function openEditModal(row) {
  const o = allOrders.find(x => x.rowIndex == row);
  if(!o) return;
  editingRow = row;
  document.getElementById('modalTitle').textContent = "ØªØ¹Ø¯ÙŠÙ„ ØªÙØ§ØµÙŠÙ„ Ø§Ù„Ø·Ù„Ø¨";
  document.getElementById('smartSection').style.display = 'none';
  document.getElementById('f_name').value = safe(o.name);
  document.getElementById('f_phone').value = formatLocalPhone(o.phone);
  document.getElementById('f_offer').value = safe(o.offer);
  document.getElementById('f_price').value = safe(o.price);
  document.getElementById('f_payment').value = safe(o.payment) || "Ø¯ÙØ¹ Ø¹Ù†Ø¯ Ø§Ù„Ø§Ø³ØªÙ„Ø§Ù…";
  document.getElementById('f_city').value = safe(o.city);
  document.getElementById('f_notes').value = safe(o.notes);
  document.getElementById('f_delivery').value = safe(o.delivery);
  document.getElementById('orderModal').classList.add('show');
}

async function saveOrder() {
  const isAdd = !editingRow;
  showLoading(true);
  const payload = {
    action: isAdd ? "addOrder" : "updateOrder", 
    key: DASH_KEY, 
    row: editingRow || "",
    name: safe(document.getElementById('f_name').value),
    phone: safe(document.getElementById('f_phone').value),
    offer: safe(document.getElementById('f_offer').value),
    price: safe(document.getElementById('f_price').value),
    city: safe(document.getElementById('f_city').value),
    notes: safe(document.getElementById('f_notes').value),
    payment: safe(document.getElementById('f_payment').value),
    delivery: safe(document.getElementById('f_delivery').value),
    status: isAdd ? "NEW" : "NEW"
  };
  try {
    const res = await fetch(`${SCRIPT_URL}?` + new URLSearchParams(payload).toString());
    const data = await res.json();
    if(data.result === "SUCCESS") {
      showToast(isAdd ? "ØªÙ…Øª Ø¥Ø¶Ø§ÙØ© Ø§Ù„Ø·Ù„Ø¨ Ø¨Ù†Ø¬Ø§Ø­ âœ¨" : "ØªÙ… Ø§Ù„Ø­ÙØ¸ Ø¨Ù†Ø¬Ø§Ø­ âœ¨");
      closeModal('orderModal');
      load();
    }
  } catch(e) { showToast("ÙØ´Ù„ Ø§Ù„Ø­ÙØ¸", true); showLoading(false); }
}

function openPrintModal(row, lang) {
    const o = allOrders.find(x => x.rowIndex == row);
    if (!o) return;
    const now = new Date();
    document.getElementById('p_date').textContent = `DATE: ${now.getDate()}.${now.getMonth()+1}.${now.getFullYear()}`;
    document.getElementById('p_ord').textContent = "ORD: MAD-" + (safe(o.orderId) || "00000");
    document.getElementById('p_total').textContent = safe(o.price) || "0";
    document.getElementById('p_qr').src = `https://api.qrserver.com/v1/create-qr-code/?size=100x100&data=https://wa.me/${normalizePhoneForLink(o.phone)}`;
    document.getElementById('p_footer_phone').textContent = formatLocalPhone(o.phone);
    const c = document.getElementById('p_content_lang');
    c.style.direction = "rtl";
    c.innerHTML = lang === 'ar' ? 
      `<strong>Ø§Ù„Ø§Ø³Ù…:</strong> ${safe(o.name)}<br><strong>Ø§Ù„Ù‡Ø§ØªÙ:</strong> ${formatLocalPhone(o.phone)}<br><strong>Ø§Ù„Ø¹Ù†ÙˆØ§Ù†:</strong> ${safe(o.city)}<br><strong>Ø§Ù„ØªÙˆØµÙŠÙ„:</strong> ${safe(o.delivery)}<br><strong>Ø§Ù„Ø¯ÙØ¹:</strong> ${safe(o.payment)}<br><strong>Ø§Ù„Ø£ØµÙ†Ø§Ù:</strong> ${safe(o.offer)}` :
      `<strong>×œ×›×‘×•×“:</strong> ${safe(o.name)}<br><strong>×˜×œ×¤×•×Ÿ:</strong> ${formatLocalPhone(o.phone)}<br><strong>×›×ª×•×‘×ª:</strong> ${safe(o.city)}<br><strong>××©×œ×•×—:</strong> ${safe(o.delivery)}<br><strong>×ª×©×œ×•×:</strong> ${safe(o.payment)}<br><strong>×¤×¨×™×˜×™×:</strong> ${safe(o.offer)}`;
    document.getElementById('printModal').classList.add('show');
}

function closeModal(id) { document.getElementById(id).classList.remove('show'); }

window.onload = load;
</script>
</body>
</html>
