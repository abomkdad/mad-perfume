<!doctype html>
<html lang="ar" dir="rtl">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width,initial-scale=1,maximum-scale=1,user-scalable=0"/>
  <title>MAD Manager v2.5 - Arabic & Hebrew Invoices</title>
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">

  <style>
    :root {
      --bg: #0a0f1e;
      --card: #161b2c;
      --primary: #3b82f6;
      --success: #10b981;
      --ready: #f59e0b;
      --hebrew: #8b5cf6;
      --danger: #ef4444;
      --text: #f8fafc;
      --muted: #94a3b8;
      --border: rgba(255,255,255,0.08);
      --grad: linear-gradient(135deg, #3b82f6 0%, #2563eb 100%);
    }

    body {
      margin: 0; font-family: 'Segoe UI', Roboto, Helvetica, Arial, sans-serif;
      background: var(--bg); color: var(--text); padding-bottom: 90px;
      line-height: 1.5;
    }

    .header {
      background: rgba(16, 21, 36, 0.85); backdrop-filter: blur(12px);
      padding: 12px 16px; position: sticky; top: 0; z-index: 100;
      border-bottom: 1px solid var(--border);
      display: flex; flex-direction: column; gap: 10px;
    }

    .header-top { display: flex; justify-content: space-between; align-items: center; }
    .logo { font-weight: 900; font-size: 22px; letter-spacing: -0.5px; }
    .logo span { color: var(--primary); }

    .search-container { position: relative; width: 100%; }
    .search-input {
      width: 100%; background: rgba(255,255,255,0.05); border: 1px solid var(--border);
      border-radius: 12px; padding: 10px 40px 10px 12px; color: white; outline: none;
      transition: all 0.3s; box-sizing: border-box; font-size: 14px;
    }
    .search-icon { position: absolute; left: 12px; top: 50%; transform: translateY(-50%); color: var(--muted); }

    .container { padding: 16px; max-width: 600px; margin: 0 auto; }

    .order-card {
      background: var(--card); border-radius: 24px; padding: 20px;
      margin-bottom: 20px; border: 1px solid var(--border);
      box-shadow: 0 10px 25px -5px rgba(0,0,0,0.4);
      transition: transform 0.2s, box-shadow 0.2s;
      position: relative; overflow: hidden;
    }

    .card-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 12px; }
    .order-id { font-family: monospace; font-size: 14px; color: var(--muted); background: rgba(255,255,255,0.05); padding: 2px 8px; border-radius: 6px; }

    .status-pill { font-size: 11px; padding: 4px 12px; border-radius: 20px; font-weight: 700; text-transform: uppercase; }
    .status-prep { background: rgba(16, 185, 129, 0.15); color: #34d399; border: 1px solid rgba(16, 185, 129, 0.2); }
    .status-new { background: rgba(59, 130, 246, 0.15); color: #60a5fa; border: 1px solid rgba(59, 130, 246, 0.2); }

    .customer-name { font-size: 19px; font-weight: 800; margin-bottom: 2px; display: block; }
    .customer-phone { color: var(--muted); font-size: 14px; display: flex; align-items: center; gap: 6px; }
    .offer-details {
      margin: 12px 0; padding: 12px; background: rgba(59, 130, 246, 0.05);
      border-radius: 12px; font-size: 14px; color: #93c5fd; font-weight: 600;
      border-right: 3px solid var(--primary);
    }

    .meta-info { display: flex; flex-wrap: wrap; gap: 12px; font-size: 12px; color: var(--muted); }
    .meta-item { display: flex; align-items: center; gap: 4px; }

    .actions-grid { display: grid; grid-template-columns: repeat(4, 1fr); gap: 8px; margin-top: 20px; }
    .actions-secondary { display: grid; grid-template-columns: 1fr 1fr; gap: 8px; margin-top: 8px; }

    .btn {
      padding: 10px 4px; border-radius: 14px; border: none; font-weight: 700;
      cursor: pointer; display: flex; flex-direction: column; align-items: center; justify-content: center;
      font-size: 10px; transition: 0.2s; gap: 6px; text-decoration: none;
    }
    .btn i { font-size: 18px; }
    .btn-primary { background: var(--grad); color: white; box-shadow: 0 4px 12px rgba(37, 99, 235, 0.3); }
    .btn-success { background: #059669; color: white; }
    .btn-ar { background: #d97706; color: white; }
    .btn-he { background: #7c3aed; color: white; }
    .btn-danger { background: var(--danger); color: white; }
    .btn-outline { background: rgba(255,255,255,0.03); color: white; border: 1px solid var(--border); }

    .modal-overlay {
      position: fixed; inset: 0; background: rgba(0,0,0,0.8); backdrop-filter: blur(8px);
      display: none; align-items: center; justify-content: center; z-index: 2000; padding: 20px;
    }
    .modal-overlay.show { display: flex; }

    .invoice-box {
        background: white; color: black; width: 98mm; height: 98mm;
        padding: 8mm; box-sizing: border-box; display: flex;
        flex-direction: column; position: relative; border-radius: 2px;
    }
    .inv-header { text-align: center; border-bottom: 2px solid #000; padding-bottom: 8px; margin-bottom: 10px; }
    .inv-body { font-size: 12px; flex-grow: 1; line-height: 1.5; }
    .inv-row { margin-bottom: 5px; display: flex; gap: 8px; }
    .inv-footer { border-top: 2px solid #000; padding-top: 8px; display: flex; justify-content: space-between; align-items: flex-end; }

    .modal-content {
      background: var(--card); width: 100%; max-width: 420px; padding: 28px;
      border-radius: 32px; border: 1px solid var(--border); overflow-y: auto; max-height: 85vh;
    }

    label { display: block; font-size: 12px; color: var(--muted); margin-bottom: 6px; }
    input, select, textarea {
      width: 100%; padding: 14px; margin-bottom: 16px; border-radius: 14px;
      border: 1px solid var(--border); background: rgba(0,0,0,0.2); color: white;
      font-size: 16px; box-sizing: border-box; outline: none; transition: 0.3s;
    }

    #toast {
      position: fixed; bottom: 30px; left: 50%; transform: translateX(-50%);
      background: #10b981; color: white; padding: 14px 28px; border-radius: 50px;
      font-weight: 700; z-index: 3000; display: none;
    }

    #loadingOverlay {
      position: fixed; inset: 0; background: rgba(6, 9, 20, 0.7); backdrop-filter: blur(4px); z-index: 4000;
      display: none; align-items: center; justify-content: center;
    }
    .spinner { width: 44px; height: 44px; border: 4px solid rgba(59, 130, 246, 0.1); border-top-color: var(--primary); border-radius: 50%; animation: spin 0.8s infinite; }
    @keyframes spin { to { transform: rotate(360deg); } }

    @media print {
      body * { visibility: hidden; }
      #invoicePreview, #invoicePreview * { visibility: visible; }
      #invoicePreview { position: fixed; left: 0; top: 0; width: 98mm; height: 98mm; border: none; margin: 0; padding: 8mm; }
      .no-print { display: none !important; }
      @page { size: 98mm 98mm; margin: 0; }
    }
  </style>
</head>
<body>

<div id="loadingOverlay"><div class="spinner"></div></div>
<div id="toast">âœ… ØªÙ… Ø§Ù„ØªØ­Ø¯ÙŠØ« Ø¨Ù†Ø¬Ø§Ø­</div>

<!-- Invoice Preview Modal -->
<div class="modal-overlay" id="printModal">
  <div class="invoice-box" id="invoicePreview">
    <div class="inv-header">
      <h1 style="margin:0; font-size: 32px; letter-spacing: 4px; font-weight: 900;">MAD</h1>
      <div style="font-size: 11px; font-weight: 800; color: #333;">PARFUMEUR</div>
      <div style="display: flex; justify-content: space-between; font-size: 10px; font-weight: 900; margin-top:8px; border-top: 1px solid #eee; padding-top: 4px;">
        <span id="p_date">DATE: 00.00.0000</span>
        <span id="p_ord">ORD: MAD-00000</span>
      </div>
    </div>
    <div class="inv-body" id="p_content_lang"></div>
    <div class="inv-footer">
      <div style="text-align:center;">
        <img id="p_qr" src="" style="width:48px; height:48px; border:1px solid #000; padding: 2px;">
        <div id="p_footer_phone" style="font-size:9px; font-weight:900; margin-top:4px;"></div>
      </div>
      <div id="p_promo" style="font-size: 9px; text-align: center; flex: 1; padding: 0 8px; font-weight: 800; line-height: 1.2;"></div>
      <div style="text-align: left;">
        <div id="p_label_total" style="font-size: 11px; font-weight: 700;">TOTAL:</div>
        <div style="font-size: 24px; font-weight: 900; color: #000;">â‚ª<span id="p_total">0</span></div>
      </div>
    </div>
    <div style="position: absolute; bottom: -75px; left: 0; right: 0; display: flex; gap: 12px; justify-content: center;" class="no-print">
      <button class="btn btn-outline" onclick="closeModal('printModal')" style="padding: 12px 24px;">Ø¥Ù„ØºØ§Ø¡</button>
      <button class="btn btn-primary" onclick="window.print()" style="padding: 12px 24px;"><i class="fa fa-print"></i> Ø·Ø¨Ø§Ø¹Ø©</button>
    </div>
  </div>
</div>

<!-- Add/Edit Modal -->
<div class="modal-overlay" id="editModal">
  <div class="modal-content">
    <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:20px;">
      <h3 id="modalTitle" style="margin:0; font-size: 22px;">ØªØ¹Ø¯ÙŠÙ„ Ø§Ù„Ø·Ù„Ø¨</h3>
      <button id="deleteBtn" class="btn btn-danger" onclick="deleteOrder()" style="padding: 8px 12px; flex-direction: row; font-size: 12px; gap: 6px;">
        <i class="fa fa-trash"></i> Ø­Ø°Ù
      </button>
    </div>
    <label>Ø§Ù„Ø§Ø³Ù… Ø§Ù„ÙƒØ§Ù…Ù„</label>
    <input type="text" id="f_name">
    <label>Ø±Ù‚Ù… Ø§Ù„Ù‡Ø§ØªÙ</label>
    <input type="tel" id="f_phone">
    <label>Ø§Ù„Ø£ØµÙ†Ø§Ù</label>
    <textarea id="f_offer" style="height:80px;"></textarea>
    <div style="display:grid; grid-template-columns: 1fr 1fr; gap:12px;">
      <div><label>Ø§Ù„Ø³Ø¹Ø±</label><input type="number" id="f_price"></div>
      <div>
        <label>Ø·Ø±ÙŠÙ‚Ø© Ø§Ù„Ø¯ÙØ¹</label>
        <select id="f_payment">
          <option value="Ù†Ù‚Ø¯Ø§Ù‹">Ù†Ù‚Ø¯Ø§Ù‹</option>
          <option value="Ù…Ø¯ÙÙˆØ¹">Ù…Ø¯ÙÙˆØ¹</option>
          <option value="Ù…Ø¯ÙÙˆØ¹ Ø¨Ø§Ù„Ø±Ø§Ø¨Ø·">Ù…Ø¯ÙÙˆØ¹ Ø¨Ø§Ù„Ø±Ø§Ø¨Ø·</option>
        </select>
      </div>
    </div>
    <label>Ø§Ù„Ø¹Ù†ÙˆØ§Ù†</label>
    <input type="text" id="f_addr">
    <label>Ø´Ø±ÙƒØ© Ø§Ù„Ø´Ø­Ù†</label>
    <select id="f_delivery">
      <option value="">-- Ø§Ø®ØªØ± --</option>
      <option value="High Express">High Express</option>
      <option value="Marwah Delivery">Marwah Delivery</option>
      <option value="Lama Delivery">Lama Delivery</option>
      <option value="Areen Delivery">Areen Delivery</option>
      <option value="Pickup">Pickup</option>
    </select>
    <div style="display:grid; grid-template-columns: 1fr 1.5fr; gap:12px; margin-top:15px;">
      <button class="btn btn-outline" onclick="closeModal('editModal')" style="height: 50px;">Ø¥Ù„ØºØ§Ø¡</button>
      <button class="btn btn-primary" onclick="saveOrder()" style="height: 50px;">Ø­ÙØ¸</button>
    </div>
  </div>
</div>

<div class="header">
  <div class="header-top">
    <div class="logo">MAD <span>MANAGER</span></div>
    <div style="display:flex; gap:10px;">
      <button class="btn btn-outline" onclick="load()" style="width:42px; height:42px;"><i class="fa fa-sync"></i></button>
      <button class="btn btn-primary" onclick="openAddModal()" style="width:42px; height:42px;"><i class="fa fa-plus"></i></button>
    </div>
  </div>
  <div class="search-container">
    <i class="fa fa-search search-icon"></i>
    <input type="text" class="search-input" id="searchInput" placeholder="Ø¨Ø­Ø«..." oninput="filterOrders()">
  </div>
</div>

<div class="container" id="ordersList"></div>

<script>
const SCRIPT_URL = "https://script.google.com/macros/s/AKfycbyLjLFa8AaH82Ip7m747WC-KSUUEaU_M70S0I9Mda14XbnmcuEfZ7pBnF_zzJYZuXmZ/exec";
const DASH_KEY = "12345678";
let allOrders = [];
let editingRow = null;

function showLoading(status) { document.getElementById('loadingOverlay').style.display = status ? 'flex' : 'none'; }
function showToast(msg, isError = false) {
  const t = document.getElementById('toast');
  t.textContent = msg; t.style.background = isError ? 'var(--danger)' : 'var(--success)';
  t.style.display = 'block'; setTimeout(() => { t.style.display = 'none'; }, 2500);
}

/**
 * ØªÙ†Ø¸ÙŠÙ Ø¬Ø°Ø±ÙŠ Ù„Ù…Ù†Ø¹ Ø¸Ù‡ÙˆØ± "undefined" Ø£Ùˆ "null" ÙÙŠ Google Sheets
 * ØªØ¶Ù…Ù† Ø¥Ø±Ø¬Ø§Ø¹ Ù†Øµ ÙØ§Ø±Øº Ø¯Ø§Ø¦Ù…Ø§Ù‹ ÙÙŠ Ø­Ø§Ù„Ø© Ø¹Ø¯Ù… ÙˆØ¬ÙˆØ¯ Ù‚ÙŠÙ…Ø©
 */
const cleanVal = (val) => {
  if (val === undefined || val === null) return "";
  const s = String(val).trim();
  if (s.toLowerCase() === "undefined" || s.toLowerCase() === "null") return "";
  return s;
};

/**
 * âœ… ØªÙ†Ø¸ÙŠÙ/ØªØ­Ø¯ÙŠØ« Ø§Ù„Ø³Ø·Ø± Ù…Ø­Ù„ÙŠØ§Ù‹ Ø¨Ø¹Ø¯ (Ø­ÙØ¸/Ø§Ø¹ØªÙ…Ø§Ø¯) Ù„ÙŠØ¸Ù‡Ø± ÙÙˆØ±Ø§Ù‹ Ø¨Ø§Ù„Ù…Ø¹Ù„ÙˆÙ…Ø§Øª Ø§Ù„Ù…Ø¹ØªÙ…Ø¯Ø©
 * Ù‡Ø°Ø§ Ù„Ø§ ÙŠÙ„ØºÙŠ Ø§Ù„ØªØ­Ø¯ÙŠØ« Ø¹Ù„Ù‰ Ø§Ù„Ø´ÙŠØªØŒ Ù„ÙƒÙ†Ù‡ ÙŠØ¶Ù…Ù† Ø£Ù† Ø§Ù„ÙƒØ§Ø±Ø¯ ÙŠØªØ­Ø¯Ø« ÙÙˆØ±Ø§Ù‹ Ø¨Ø¯ÙˆÙ† Ø§Ù†ØªØ¸Ø§Ø± reload
 */
function applyLocalClean(rowIndex, patch) {
  const idx = allOrders.findIndex(x => String(x.rowIndex) === String(rowIndex));
  if (idx === -1) return;
  const o = allOrders[idx];
  const cleanedPatch = {};
  Object.keys(patch || {}).forEach(k => cleanedPatch[k] = cleanVal(patch[k]));
  allOrders[idx] = { ...o, ...cleanedPatch };
}

function refreshView() {
  const term = (document.getElementById('searchInput').value || "").trim();
  if (term) filterOrders();
  else renderOrders(allOrders);
}

async function load() {
  showLoading(true);
  try {
    const res = await fetch(`${SCRIPT_URL}?action=get&_=${Date.now()}`);
    allOrders = await res.json();
    renderOrders(allOrders);
  } catch (e) { showToast("Ø®Ø·Ø£ ÙÙŠ Ø§Ù„Ø§ØªØµØ§Ù„", true); }
  showLoading(false);
}

function filterOrders() {
    const term = document.getElementById('searchInput').value.toLowerCase();
    const filtered = allOrders.filter(o => cleanVal(o.name).toLowerCase().includes(term) || cleanVal(o.phone).includes(term));
    renderOrders(filtered);
}

function renderOrders(ordersToRender) {
  const container = document.getElementById('ordersList');
  container.innerHTML = ordersToRender.filter(o => o.rowIndex).map(o => {
    const isPrep = (o.status || "").includes("ØªØ¬Ù‡ÙŠØ²");
    return `
    <div class="order-card">
      <div class="card-header">
        <span class="order-id">#${cleanVal(o.orderId) || '---'}</span>
        <span class="status-pill ${isPrep ? 'status-prep' : 'status-new'}">${cleanVal(o.status) || 'Ø¬Ø¯ÙŠØ¯'}</span>
      </div>
      <div onclick="openEditModal(${o.rowIndex})">
        <span class="customer-name">${cleanVal(o.name) || 'Ø¹Ù…ÙŠÙ„'}</span>
        <div class="customer-phone"><i class="fa fa-phone"></i> ${cleanVal(o.phone)}</div>
        <div class="offer-details">${cleanVal(o.offer)}</div>
      </div>
      <div class="actions-grid">
        <button class="btn btn-ar" onclick="sendMsg(${o.rowIndex}, 'ar')"><i class="fa-brands fa-whatsapp"></i><span>Ø¹Ø±Ø¨ÙŠ</span></button>
        <button class="btn btn-he" onclick="sendMsg(${o.rowIndex}, 'he')"><i class="fa-brands fa-whatsapp"></i><span>×¢×‘×¨×™×ª</span></button>
        <button class="btn btn-success" onclick="updateToSent(${o.rowIndex})"><i class="fa fa-check-double"></i><span>Ø§Ø¹ØªÙ…Ø§Ø¯</span></button>
        <button class="btn btn-outline" onclick="openEditModal(${o.rowIndex})"><i class="fa fa-sliders"></i><span>ØªØ­ÙƒÙ…</span></button>
      </div>
      <div class="actions-secondary">
        <button class="btn btn-outline" onclick="openPrintModal(${o.rowIndex}, 'ar')"><i class="fa fa-file-invoice"></i><span>ÙˆØµÙ„ Ø¹</span></button>
        <button class="btn btn-outline" onclick="openPrintModal(${o.rowIndex}, 'he')"><i class="fa fa-file-invoice"></i><span>ÙˆØµÙ„ Ù‡Ù€</span></button>
      </div>
    </div>`;
  }).join('');
}

async function sendMsg(row, lang) {
  const o = allOrders.find(x => String(x.rowIndex) === String(row));
  if(!o) return;
  const msg = lang === 'ar' ? `Ø£Ù‡Ù„Ø§Ù‹ Ø¨Ùƒ ${cleanVal(o.name)}...` : `×©×œ×•× ${cleanVal(o.name)} ğŸ‘‹...`;
  // âœ… Encoding Ù„ØªÙØ§Ø¯ÙŠ Ù…Ø´Ø§ÙƒÙ„ Ø§Ù„Ù…Ø³Ø§ÙØ§Øª/Ø§Ù„Ø£Ø­Ø±Ù
  window.open(`https://wa.me/${normalizePhone(o.phone)}?text=${encodeURIComponent(msg)}`, '_blank');
  // âœ… Ø§Ø¹ØªÙ…Ø§Ø¯ ØµØ§Ù…Øª + ØªÙ†Ø¸ÙŠÙ Ù…Ø­Ù„ÙŠ Ù„Ù„Ø³Ø·Ø± (Ø¨Ø¯ÙˆÙ† Ø§Ù†ØªØ¸Ø§Ø± reload)
  updateToSent(row, true);
}

/**
 * âœ… ÙˆØ¸ÙŠÙØ© Ø§Ù„Ø§Ø¹ØªÙ…Ø§Ø¯: ØªØ±Ø³Ù„ ÙƒÙ„ Ø§Ù„Ø­Ù‚ÙˆÙ„ Ù…Ù†Ø¸ÙØ© Ù„Ø¥Ø¬Ø¨Ø§Ø± Ø§Ù„Ø´ÙŠØª Ø¹Ù„Ù‰ Ø§Ø³ØªØ¨Ø¯Ø§Ù„ Ø§Ù„Ù‚ÙŠÙ… (ØªÙ†Ø¸ÙŠÙ Ø§Ù„Ø³Ø·Ø±)
 * ÙˆØ¨Ù†ÙØ³ Ø§Ù„ÙˆÙ‚Øª ØªØ­Ø¯Ø« Ø§Ù„ÙƒØ§Ø±Ø¯ Ù…Ø¨Ø§Ø´Ø±Ø© Ø¨Ø§Ù„Ù…Ø¹Ù„ÙˆÙ…Ø§Øª Ø§Ù„Ù…Ø¹ØªÙ…Ø¯Ø©.
 */
async function updateToSent(row, silent = false) {
  const o = allOrders.find(x => String(x.rowIndex) === String(row));
  if(!o) return;

  const payload = {
    action: "updateOrder",
    key: DASH_KEY,
    row: row,
    name: cleanVal(o.name),
    phone: cleanVal(o.phone),
    offer: cleanVal(o.offer),
    price: cleanVal(o.price) || "0",
    payment: cleanVal(o.payment) || "Ù†Ù‚Ø¯Ø§Ù‹",
    addr: cleanVal(o.addr),
    delivery: cleanVal(o.delivery),
    status: "Ø¨Ø§Ù†ØªØ¸Ø§Ø± Ø§Ù„Ø¥Ø±Ø³Ø§Ù„ Ù„Ù„ØªØ¬Ù‡ÙŠØ²",
    // âœ… ÙÙ„Ø§Øº Ø§Ø®ØªÙŠØ§Ø±ÙŠ (Ø¥Ø°Ø§ Ø­Ø¨ÙŠØª Ù„Ø§Ø­Ù‚Ø§Ù‹ ØªØ¯Ø¹Ù…Ù‡ Ø¨Ø§Ù„Ù€ Apps Script)
    clean: "1"
  };

  // âœ… ØªÙ†Ø¸ÙŠÙ/ØªØ­Ø¯ÙŠØ« Ù…Ø­Ù„ÙŠ ÙÙˆØ±ÙŠ
  applyLocalClean(row, payload);
  refreshView();

  if(!silent) showLoading(true);
  try {
    const res = await fetch(`${SCRIPT_URL}?` + new URLSearchParams(payload).toString());
    const data = await res.json();
    if(data.result === "SUCCESS") {
      if(!silent) {
        showToast("ØªÙ… Ø§Ù„Ø§Ø¹ØªÙ…Ø§Ø¯ Ø¨Ù†Ø¬Ø§Ø­ âœ¨");
        // âœ… Ø¥Ø¹Ø§Ø¯Ø© ØªØ­Ù…ÙŠÙ„ Ù„Ù„ØªØ£ÙƒØ¯ Ù…Ù† Ù…Ø·Ø§Ø¨Ù‚Ø© Ø§Ù„Ø´ÙŠØª (Ø§Ø®ØªÙŠØ§Ø±ÙŠ Ù„ÙƒÙ† Ø£ÙØ¶Ù„ Ù„Ù„Ø«Ø¨Ø§Øª)
        load();
      }
    } else {
      if(!silent) showToast("ÙØ´Ù„ Ø§Ù„Ø§Ø¹ØªÙ…Ø§Ø¯", true);
    }
  } catch(e) {
    if(!silent) showToast("Ø®Ø·Ø£ ÙÙŠ Ø§Ù„ØªØ­Ø¯ÙŠØ«", true);
  }
  if(!silent) showLoading(false);
}

async function saveOrder() {
  const isEdit = !!editingRow;
  const old = isEdit ? (allOrders.find(x => String(x.rowIndex) === String(editingRow)) || {}) : {};

  // âœ… ÙƒÙ„ Ø§Ù„Ù‚ÙŠÙ… Ù…Ù†Ø¸ÙØ© Ù…Ù† Ø§Ù„Ù…ØµØ¯Ø± (Ø§Ù„ÙÙˆØ±Ù…)
  const name = cleanVal(document.getElementById('f_name').value);
  const phone = cleanVal(document.getElementById('f_phone').value);
  const offer = cleanVal(document.getElementById('f_offer').value);
  const price = cleanVal(document.getElementById('f_price').value) || "0";
  const payment = cleanVal(document.getElementById('f_payment').value) || "Ù†Ù‚Ø¯Ø§Ù‹";
  const addr = cleanVal(document.getElementById('f_addr').value);
  const delivery = cleanVal(document.getElementById('f_delivery').value);

  // âœ… Ø§Ù„Ø­Ø§Ù„Ø©: ÙÙŠ Ø§Ù„ØªØ¹Ø¯ÙŠÙ„ Ù†ÙØ¨Ù‚ÙŠ Ø§Ù„Ø­Ø§Ù„Ø© Ø§Ù„Ù‚Ø¯ÙŠÙ…Ø© Ø¥Ù† ÙˆØ¬Ø¯ØªØŒ ÙˆØ¥Ù„Ø§ Ù†Ø¶Ø¹ NEW
  const status = isEdit ? (cleanVal(old.status) || "NEW") : "NEW";

  const payload = {
    action: isEdit ? "updateOrder" : "addOrder",
    key: DASH_KEY,
    row: isEdit ? editingRow : "",
    name,
    phone,
    offer,
    price,
    payment,
    addr,
    delivery,
    status,
    // âœ… ÙÙ„Ø§Øº Ø§Ø®ØªÙŠØ§Ø±ÙŠ (Ø¥Ø°Ø§ Ø­Ø¨ÙŠØª Ù„Ø§Ø­Ù‚Ø§Ù‹ ØªØ¯Ø¹Ù…Ù‡ Ø¨Ø§Ù„Ù€ Apps Script)
    clean: "1"
  };

  if (!payload.name || !payload.phone) return showToast("Ø¨ÙŠØ§Ù†Ø§Øª Ù†Ø§Ù‚ØµØ©", true);

  closeModal('editModal');

  // âœ… ØªÙ†Ø¸ÙŠÙ/ØªØ­Ø¯ÙŠØ« Ù…Ø­Ù„ÙŠ ÙÙˆØ±ÙŠ Ø¨Ø¹Ø¯ Ø§Ù„Ø­ÙØ¸ (Ø¹Ø´Ø§Ù† Ø§Ù„Ø³Ø·Ø± ÙŠØªÙ†Ø¸Ù Ø¨Ø§Ù„ÙƒØ§Ø±Ø¯ ÙÙˆØ±Ø§Ù‹)
  if (isEdit) {
    applyLocalClean(editingRow, payload);
    refreshView();
  }

  showLoading(true);
  try {
    const res = await fetch(`${SCRIPT_URL}?` + new URLSearchParams(payload).toString());
    const data = await res.json();
    if(data.result === "SUCCESS") {
      showToast("ØªÙ… Ø§Ù„Ø­ÙØ¸ Ø¨Ù†Ø¬Ø§Ø­ âœ¨");
      // âœ… Ø¥Ø¹Ø§Ø¯Ø© ØªØ­Ù…ÙŠÙ„ Ù„ØªØ­Ø¯ÙŠØ« Ø£ÙŠ Ø­Ù‚ÙˆÙ„ ÙŠÙˆÙ„Ø¯Ù‡Ø§ Ø§Ù„Ø´ÙŠØª Ù…Ø«Ù„ orderId / timestamp
      load();
    } else {
      showToast("ÙØ´Ù„Øª Ø§Ù„Ø¹Ù…Ù„ÙŠØ©", true);
      showLoading(false);
    }
  } catch(e) {
    showToast("ÙØ´Ù„Øª Ø§Ù„Ø¹Ù…Ù„ÙŠØ©", true);
    showLoading(false);
  }
}

function openPrintModal(row, lang) {
    const o = allOrders.find(x => String(x.rowIndex) === String(row));
    if (!o) return;
    const now = new Date();
    document.getElementById('p_date').textContent = `DATE: ${now.getDate()}.${now.getMonth()+1}.${now.getFullYear()}`;
    document.getElementById('p_ord').textContent = "ORD: MAD-" + (cleanVal(o.orderId) || "00000");
    document.getElementById('p_total').textContent = cleanVal(o.price) || "0";
    document.getElementById('p_qr').src = `https://api.qrserver.com/v1/create-qr-code/?size=100x100&data=https://wa.me/${normalizePhone(o.phone)}`;
    document.getElementById('p_footer_phone').textContent = cleanVal(o.phone);
    const contentArea = document.getElementById('p_content_lang');
    contentArea.style.direction = "rtl";
    contentArea.innerHTML = lang === 'ar' ?
      `<div class="inv-row"><strong>Ø§Ù„Ø§Ø³Ù…:</strong> ${cleanVal(o.name)}</div><div class="inv-row"><strong>Ø§Ù„Ù‡Ø§ØªÙ:</strong> ${cleanVal(o.phone)}</div><div class="inv-row"><strong>Ø§Ù„Ø¹Ù†ÙˆØ§Ù†:</strong> ${cleanVal(o.addr)}</div><div class="inv-row"><strong>Ø§Ù„Ø£ØµÙ†Ø§Ù:</strong> ${cleanVal(o.offer)}</div>` :
      `<div class="inv-row"><strong>×œ×›×‘×•×“:</strong> ${cleanVal(o.name)}</div><div class="inv-row"><strong>×˜×œ×¤×•×Ÿ:</strong> ${cleanVal(o.phone)}</div><div class="inv-row"><strong>×›×ª×•×‘×ª:</strong> ${cleanVal(o.addr)}</div><div class="inv-row"><strong>×¤×¨×™×˜×™×:</strong> ${cleanVal(o.offer)}</div>`;
    document.getElementById('printModal').classList.add('show');
}

function openAddModal() {
  editingRow = null; document.getElementById('modalTitle').textContent = "Ø·Ù„Ø¨ Ø¬Ø¯ÙŠØ¯";
  document.getElementById('deleteBtn').style.display = 'none';
  ['f_name','f_phone','f_offer','f_price','f_addr'].forEach(id => document.getElementById(id).value = "");
  document.getElementById('f_payment').value = "Ù†Ù‚Ø¯Ø§Ù‹"; document.getElementById('f_delivery').value = "";
  document.getElementById('editModal').classList.add('show');
}

function openEditModal(row) {
  const o = allOrders.find(x => String(x.rowIndex) === String(row));
  if (!o) return;
  editingRow = row; document.getElementById('modalTitle').textContent = "ØªØ¹Ø¯ÙŠÙ„ Ø§Ù„Ø·Ù„Ø¨";
  document.getElementById('deleteBtn').style.display = 'block';
  document.getElementById('f_name').value = cleanVal(o.name);
  document.getElementById('f_phone').value = cleanVal(o.phone);
  document.getElementById('f_offer').value = cleanVal(o.offer);
  document.getElementById('f_price').value = cleanVal(o.price);
  document.getElementById('f_payment').value = cleanVal(o.payment) || "Ù†Ù‚Ø¯Ø§Ù‹";
  document.getElementById('f_addr').value = cleanVal(o.addr);
  document.getElementById('f_delivery').value = cleanVal(o.delivery);
  document.getElementById('editModal').classList.add('show');
}

async function deleteOrder() {
  if (!confirm("Ø­Ø°Ù Ø§Ù„Ø·Ù„Ø¨ØŸ")) return;
  const payload = { action: "deleteOrder", key: DASH_KEY, row: editingRow };

  // âœ… Ø­Ø°Ù Ù…Ø­Ù„ÙŠ Ù…Ø¨Ø§Ø´Ø± (Ù„ØªÙ†Ø¸ÙŠÙ Ø§Ù„Ø³Ø·Ø± ÙÙˆØ±Ø§Ù‹)
  allOrders = allOrders.filter(x => String(x.rowIndex) !== String(editingRow));
  refreshView();

  closeModal('editModal'); showLoading(true);
  try {
    await fetch(`${SCRIPT_URL}?` + new URLSearchParams(payload).toString());
    showToast("ØªÙ… Ø§Ù„Ø­Ø°Ù");
    load();
  } catch (e) {
    showToast("Ø®Ø·Ø£", true);
    showLoading(false);
  }
}

function closeModal(id) { document.getElementById(id).classList.remove('show'); }

function normalizePhone(p) {
  if(!p) return "";
  let d = String(p).replace(/\D/g, "");
  if (d.startsWith("0")) d = "972" + d.substring(1);
  return d;
}

window.onload = load;
</script>
</body>
</html>
