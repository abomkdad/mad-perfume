<!doctype html>
<html lang="ar" dir="rtl">
<head>
  <meta charset="utf-8"/>
  <title>MAD SYSTEM v5.5 | Auto-Sync</title>
  
  <script src="https://cdn.jsdelivr.net/npm/jsbarcode@3.11.5/dist/JsBarcode.all.min.js"></script>
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">

  <style>
    :root { --bg: #0f172a; --card: #1e293b; --blue: #3b82f6; --text: #f8fafc; --green: #10b981; --red: #ef4444; --orange: #f59e0b; }
    body { font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; background: var(--bg); color: var(--text); margin: 0; direction: rtl; }
    
    /* Header & Search */
    header { background: var(--card); padding: 15px 25px; display: flex; justify-content: space-between; align-items: center; border-bottom: 2px solid #334155; position: sticky; top: 0; z-index: 90; box-shadow: 0 4px 15px rgba(0,0,0,0.3); }
    .search-box { flex: 1; max-width: 500px; margin: 0 20px; position: relative; }
    .search-box input { width: 100%; padding: 12px 20px; border-radius: 50px; border: 1px solid #334155; background: #0f172a; color: white; font-size: 16px; outline: none; transition: 0.3s; }
    .search-box input:focus { border-color: var(--blue); box-shadow: 0 0 10px rgba(59, 130, 246, 0.3); }

    /* Grid Layout */
    .grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(340px, 1fr)); gap: 25px; padding: 25px; }
    
    /* Card Design */
    .card { background: var(--card); border-radius: 16px; overflow: hidden; border: 1px solid #334155; transition: all 0.3s ease; display: flex; flex-direction: column; position: relative; }
    .card:hover { transform: translateY(-5px); box-shadow: 0 15px 30px rgba(0,0,0,0.4); border-color: var(--blue); }
    .card.selected { border: 2px solid var(--blue); background: #232f42; }
    
    /* Status Badge */
    .status-badge { position: absolute; top: 15px; left: 15px; padding: 5px 12px; border-radius: 20px; font-size: 12px; font-weight: bold; color: white; box-shadow: 0 2px 5px rgba(0,0,0,0.2); cursor: pointer; z-index: 10; }
    .status-pending { background: var(--orange); animation: pulse 2s infinite; }
    .status-ready { background: var(--green); }
    
    @keyframes pulse { 0% { opacity: 1; } 50% { opacity: 0.7; } 100% { opacity: 1; } }

    .card-content { padding: 20px; flex-grow: 1; }
    .card-id { font-size: 13px; color: #94a3b8; font-weight: bold; margin-bottom: 5px; }
    .card-name { font-size: 20px; font-weight: 800; margin-bottom: 10px; color: #fff; }
    
    .info-row { display: flex; align-items: center; gap: 10px; margin-bottom: 8px; color: #cbd5e1; font-size: 14px; }
    .info-row i { width: 20px; text-align: center; color: var(--blue); }

    /* Products Section */
    .products-box { background: #0f172a; border-radius: 8px; padding: 10px; margin-top: 15px; border: 1px dashed #334155; }
    .products-title { font-size: 11px; color: #64748b; text-transform: uppercase; letter-spacing: 1px; margin-bottom: 5px; }
    .product-item { font-size: 13px; color: #e2e8f0; display: flex; justify-content: space-between; padding: 3px 0; border-bottom: 1px solid #1e293b; }
    .product-item:last-child { border-bottom: none; }

    .card-price { font-size: 28px; font-weight: 900; color: var(--green); margin-top: 15px; text-align: left; direction: ltr; }

    /* Actions Bar */
    .card-actions { display: grid; grid-template-columns: 1fr 1fr 1fr 1fr; background: #161e2e; border-top: 1px solid #334155; }
    .btn-action { border: none; background: transparent; color: #94a3b8; padding: 12px 0; cursor: pointer; font-size: 13px; display: flex; flex-direction: column; align-items: center; gap: 5px; transition: 0.2s; border-left: 1px solid #334155; }
    .btn-action:last-child { border-left: none; }
    .btn-action:hover { background: #1e293b; color: white; }
    .btn-status:hover { color: var(--orange); }

    /* Bulk Bar */
    .bulk-bar { position: fixed; bottom: 30px; left: 50%; transform: translateX(-50%) translateY(100px); background: white; color: black; padding: 12px 30px; border-radius: 50px; display: flex; align-items: center; gap: 20px; box-shadow: 0 10px 40px rgba(0,0,0,0.6); z-index: 1000; transition: 0.4s cubic-bezier(0.175, 0.885, 0.32, 1.275); opacity: 0; }
    .bulk-bar.active { transform: translateX(-50%) translateY(0); opacity: 1; }
    
    /* Edit Modal */
    .modal-overlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.7); z-index: 2000; display: none; justify-content: center; align-items: center; backdrop-filter: blur(5px); }
    .modal { background: var(--card); padding: 30px; border-radius: 20px; width: 90%; max-width: 500px; border: 1px solid #334155; box-shadow: 0 25px 50px -12px rgba(0,0,0,0.5); }
    .modal h2 { margin-top: 0; color: white; border-bottom: 1px solid #334155; padding-bottom: 15px; }
    .form-group { margin-bottom: 15px; }
    .form-group label { display: block; color: #94a3b8; font-size: 13px; margin-bottom: 5px; }
    .form-group input, .form-group textarea { width: 100%; padding: 10px; background: #0f172a; border: 1px solid #334155; border-radius: 8px; color: white; box-sizing: border-box; }
    .modal-btns { display: flex; justify-content: flex-end; gap: 10px; margin-top: 20px; }
    .btn-save { background: var(--blue); color: white; border: none; padding: 10px 20px; border-radius: 8px; cursor: pointer; font-weight: bold; }
    .btn-close { background: #334155; color: white; border: none; padding: 10px 20px; border-radius: 8px; cursor: pointer; }

    /* Notification Toast */
    #toast { position: fixed; top: 20px; right: 20px; background: var(--green); color: white; padding: 15px 25px; border-radius: 10px; box-shadow: 0 5px 15px rgba(0,0,0,0.3); transform: translateX(150%); transition: 0.3s; z-index: 3000; display: flex; align-items: center; gap: 10px; font-weight: bold; }
    #toast.show { transform: translateX(0); }

    /* Print Styles */
    @media print {
      body * { visibility: hidden; }
      #printArea, #printArea * { visibility: visible; }
      #printArea { position: absolute; left: 0; top: 0; width: 100%; }
      @page { size: 100mm 100mm; margin: 0; }
      .label { 
          width: 100mm; height: 100mm; padding: 5mm; 
          background: white !important; color: black !important; 
          display: flex; flex-direction: column; page-break-after: always; 
          box-sizing: border-box; font-family: sans-serif; position: relative; 
          border: 2px dashed #333;
          -webkit-print-color-adjust: exact; 
      }
      .label-header { display: flex; justify-content: space-between; align-items: center; border-bottom: 3px solid #000; padding-bottom: 10px; margin-bottom: 15px; }
      .label-row { font-size: 13pt; margin-bottom: 6px; line-height: 1.3; display: flex; }
      .label-key { width: 75px; font-weight: bold; }
      .label-val { flex: 1; font-weight: bold; }
      .label-products { border-top: 2px solid #000; margin-top: 5px; padding-top: 5px; font-size: 11pt; height: 110px; overflow: hidden; }
      .label-footer { margin-top: auto; text-align: center; border: 3px solid #000; border-radius: 15px; padding: 5px; display: flex; align-items: center; justify-content: space-between; }
      .label-price { font-size: 24pt; font-weight: 900; }
      .barcode-container { text-align: center; margin-top: 5px; }
      .barcode-container svg { height: 40px; width: 100%; }
    }
    #printArea { display: none; }
  </style>
</head>
<body>

<header>
  <div style="font-size: 24px; font-weight: 900; display:flex; align-items:center; gap:10px;">
    <span>MAD</span> <span style="color:var(--blue)">SYS v5.5</span>
    <span id="loader" style="font-size:12px; font-weight:normal; color:#64748b; margin-right:15px; opacity:0; transition:0.3s"><i class="fas fa-circle-notch fa-spin"></i> مزامنة...</span>
  </div>
  
  <div class="search-box">
    <input type="text" id="searchInput" placeholder="ابحث عن اسم، هاتف، أو رقم طلب..." oninput="app.render()">
  </div>

  <button onclick="app.manualRefresh()" style="background: #1e293b; color: white; border: 1px solid #334155; padding: 10px 20px; border-radius: 10px; cursor: pointer; font-weight: bold; transition:0.2s">
    <i class="fas fa-sync-alt"></i> تحديث
  </button>
</header>

<div class="grid" id="grid"></div>

<div class="bulk-bar" id="bulkBar">
  <span id="selectedCount" style="font-weight: bold; min-width: 100px;">0 مختار</span>
  <button onclick="app.printSelected()" style="background: black; color: white; border: none; padding: 10px 25px; border-radius: 30px; cursor: pointer; font-weight: bold;">
    <i class="fas fa-print"></i> طباعة المحدد
  </button>
  <button onclick="app.clearSelection()" style="background: none; border: none; color: #ef4444; cursor: pointer; font-weight:bold;">إلغاء</button>
</div>

<div class="modal-overlay" id="editModal">
  <div class="modal">
    <h2>تعديل الطلب <span id="editIdStr"></span></h2>
    <input type="hidden" id="editRealId">
    <div class="form-group">
      <label>اسم العميل</label>
      <input type="text" id="editName">
    </div>
    <div class="form-group">
      <label>الهاتف</label>
      <input type="text" id="editPhone">
    </div>
    <div class="form-group">
      <label>المدينة / العنوان</label>
      <input type="text" id="editCity">
    </div>
    <div class="form-group">
      <label>المنتجات (افصل بفاصلة)</label>
      <textarea id="editProducts" rows="3"></textarea>
    </div>
    <div class="form-group">
      <label>السعر</label>
      <input type="number" id="editPrice">
    </div>
    <div class="modal-btns">
      <button class="btn-close" onclick="app.closeModal()">إغلاق</button>
      <button class="btn-save" onclick="app.saveEdit()">حفظ التعديلات</button>
    </div>
  </div>
</div>

<div id="toast"><i class="fas fa-bell"></i> <span>طلب جديد وصل!</span></div>
<div id="printArea"></div>

<script>
class MadSystem {
  constructor() {
    // IMPORTANT: Replace this URL with your actual Google Apps Script Web App URL
    this.scriptUrl = "https://script.google.com/macros/s/AKfycbyLjLFa8AaH82Ip7m747WC-KSUUEaU_M70S0I9Mda14XbnmcuEfZ7pBnF_zzJYZuXmZ/exec";
    this.orders = [];
    this.selected = new Set();
    this.localStatus = JSON.parse(localStorage.getItem('mad_status_v5') || '{}');
    this.lastOrderCount = 0;
    this.editingId = null;

    this.init();
  }

  async init() {
    await this.loadData();
    setInterval(() => this.loadData(true), 5000);
  }

  async loadData(isAuto = false) {
    if(isAuto) document.getElementById('loader').style.opacity = '1';
    
    try {
      // Added error handling for network requests
      const res = await fetch(`${this.scriptUrl}?action=get`);
      if (!res.ok) throw new Error('Network response was not ok');
      const data = await res.json();
      
      if (this.lastOrderCount > 0 && data.length > this.lastOrderCount) {
        this.showToast();
        this.playNotificationSound();
      }
      this.lastOrderCount = data.length;
      
      this.orders = data.map(o => {
          const id = String(o.orderId || o.id || '0'); // Force ID to string
          return {
              id: id,
              name: o.name || o.customer || 'بدون اسم',
              phone: o.phone || o.tel || '',
              city: o.city || o.address || '',
              payment: o.payment || '',
              price: o.price || '0',
              products: o.products || o.items || '',
              status: this.localStatus[id] || (o.status || 'pending')
          };
      });

      this.render();
      
    } catch (e) {
      console.error("Connection Error", e);
      // Optional: Show error in UI
    } finally {
      if(isAuto) setTimeout(() => document.getElementById('loader').style.opacity = '0', 1000);
    }
  }

  manualRefresh() {
    this.loadData();
  }

  translate(type, val) {
    if(!val) return "---";
    const v = val.toString().toLowerCase().trim();
    
    if(type === 'payment') {
      if(v.includes('cash') || v.includes('מזומן')) return 'نقدي';
      if(v.includes('bit') || v.includes('ביט')) return 'Bit';
      if(v.includes('credit') || v.includes('אשראי')) return 'بطاقة ائتمان';
      if(v.includes('pending')) return 'عند الاستلام';
      return val;
    }
    
    if(type === 'city') {
      const map = {
        'haifa': 'حيفا', 'חיפה': 'حيفا',
        'acre': 'عكا', 'akko': 'عكا', 'עכו': 'عكا',
        'nazareth': 'الناصرة', 'נצרת': 'الناصرة',
        'tel aviv': 'تل أبيب', 'תל אביב': 'تل أبيب',
        'jerusalem': 'القدس', 'ירושלים': 'القدس'
      };
      return map[v] || val; 
    }
    return val;
  }

  render() {
    const query = document.getElementById('searchInput').value.toLowerCase().trim();
    const grid = document.getElementById('grid');
    
    // Sort: Pending first
    let displayList = [...this.orders].sort((a, b) => {
        const sA = a.status === 'ready' ? 1 : 0;
        const sB = b.status === 'ready' ? 1 : 0;
        return sA - sB;
    });

    if(query) {
      displayList = displayList.filter(o => 
        o.name.toLowerCase().includes(query) || 
        o.phone.includes(query) || 
        String(o.id).includes(query)
      );
    }

    grid.innerHTML = displayList.map(o => {
      // Use ID for selection check instead of Index
      const isSel = this.selected.has(o.id);
      const isReady = o.status === 'ready';
      
      let prodHTML = '';
      if(o.products) {
          // Safe split fix
          const pList = String(o.products).split(/,|،|\n/).filter(p => p.trim() !== '');
          if(pList.length > 0) {
              prodHTML = `<div class="products-box"><div class="products-title">المنتجات</div>` + 
                         pList.map(p => `<div class="product-item"><span>- ${p}</span></div>`).join('') + 
                         `</div>`;
          }
      }

      // Pass ID string specifically using quotes
      return `
        <div class="card ${isSel ? 'selected' : ''}">
          <div class="status-badge ${isReady ? 'status-ready' : 'status-pending'}" onclick="app.toggleStatus('${o.id}', event)">
            ${isReady ? 'جاهز للتسليم <i class="fas fa-check"></i>' : 'انتظار التجهيز <i class="fas fa-clock"></i>'}
          </div>

          <div class="card-content">
            <div class="card-id">ORDER #${o.id}</div>
            <div class="card-name">${o.name}</div>
            
            <div class="info-row"><i class="fas fa-phone"></i> ${o.phone}</div>
            <div class="info-row"><i class="fas fa-map-marker-alt"></i> ${this.translate('city', o.city)}</div>
            <div class="info-row"><i class="fas fa-wallet"></i> ${this.translate('payment', o.payment)}</div>
            
            ${prodHTML}
            
            <div class="card-price">₪${o.price}</div>
          </div>
          
          <div class="card-actions">
            <button class="btn-action" onclick="app.printSingle('${o.id}')">
              <i class="fas fa-print"></i> طباعة
            </button>
            <button class="btn-action" onclick="app.openEdit('${o.id}')">
              <i class="fas fa-edit"></i> تعديل
            </button>
             <button class="btn-action btn-status" onclick="app.toggleStatus('${o.id}', event)">
              <i class="fas fa-exchange-alt"></i> الحالة
            </button>
            <button class="btn-action" onclick="app.toggleSelect('${o.id}')" style="color:${isSel?'var(--blue)':'inherit'}">
              <i class="fas ${isSel ? 'fa-check-square' : 'fa-square'}"></i> تحديد
            </button>
          </div>
        </div>
      `;
    }).join("");
  }

  // --- Logic Helper ---
  findOrder(id) {
    return this.orders.find(o => o.id === id);
  }

  toggleStatus(id, e) {
    if(e) e.stopPropagation();
    const o = this.findOrder(id);
    if(!o) return;

    o.status = o.status === 'ready' ? 'pending' : 'ready';
    this.localStatus[o.id] = o.status;
    localStorage.setItem('mad_status_v5', JSON.stringify(this.localStatus));
    this.render();
  }

  toggleSelect(id) {
    this.selected.has(id) ? this.selected.delete(id) : this.selected.add(id);
    this.updateBulkUI();
    this.render();
  }

  updateBulkUI() {
    const bar = document.getElementById('bulkBar');
    document.getElementById('selectedCount').innerText = `${this.selected.size} طلبات`;
    this.selected.size > 0 ? bar.classList.add('active') : bar.classList.remove('active');
  }

  clearSelection() {
    this.selected.clear();
    this.updateBulkUI();
    this.render();
  }

  // --- Edit System ---
  openEdit(id) {
    this.editingId = id;
    const o = this.findOrder(id);
    if(!o) return;

    document.getElementById('editIdStr').innerText = `#${o.id}`;
    document.getElementById('editRealId').value = o.id;
    document.getElementById('editName').value = o.name;
    document.getElementById('editPhone').value = o.phone;
    document.getElementById('editCity').value = o.city;
    document.getElementById('editPrice').value = o.price;
    document.getElementById('editProducts').value = o.products;
    
    document.getElementById('editModal').style.display = 'flex';
  }

  closeModal() {
    document.getElementById('editModal').style.display = 'none';
    this.editingId = null;
  }

  saveEdit() {
    if (this.editingId === null) return;
    const o = this.findOrder(this.editingId);
    if(!o) return;
    
    o.name = document.getElementById('editName').value;
    o.phone = document.getElementById('editPhone').value;
    o.city = document.getElementById('editCity').value;
    o.price = document.getElementById('editPrice').value;
    o.products = document.getElementById('editProducts').value;
    
    this.closeModal();
    this.render();
    // Warning persists because backend sync is not implemented in this snippet
    alert("تم التحديث محلياً فقط.");
  }

  // --- Printing System ---
  printSingle(id) {
    const o = this.findOrder(id);
    if(!o) return;
    this.executePrint([o]);
  }

  printSelected() {
    // Convert Set of IDs back to Order Objects
    const list = Array.from(this.selected).map(id => this.findOrder(id)).filter(x => x);
    if(list.length === 0) return alert("اختر طلبات أولاً");
    this.executePrint(list);
  }

  executePrint(list) {
    const area = document.getElementById('printArea');
    area.innerHTML = list.map(o => this.generateLabel(o)).join("");
    
    // Generate Barcodes
    list.forEach(o => {
      try {
        JsBarcode(`#barcode-${o.id}`, o.id, {
          format: "CODE128",
          lineColor: "#000",
          width: 2,
          height: 30,
          displayValue: false
        });
      } catch(e) { console.log('Barcode Err', e); }
    });

    setTimeout(() => {
        window.print();
        // Optional: clear selection after print
        // this.clearSelection(); 
    }, 500);
  }

  generateLabel(o) {
    const date = new Date().toLocaleDateString('ar-EG');
    const cityAr = this.translate('city', o.city);
    const payAr = this.translate('payment', o.payment);
    const safeProd = o.products ? String(o.products).replace(/,|،/g, '<br>') : '---';
    
    return `
      <div class="label" dir="rtl">
        <div class="label-header">
          <div style="font-size:18pt; font-weight:900;">MAD PARFUM</div>
          <div style="font-size:14pt;">#${o.id}</div>
        </div>

        <div class="label-row">
          <div class="label-key">العميل:</div>
          <div class="label-val">${o.name}</div>
        </div>
        <div class="label-row">
          <div class="label-key">الهاتف:</div>
          <div class="label-val" dir="ltr" style="text-align:right">${o.phone}</div>
        </div>
        <div class="label-row">
          <div class="label-key">المدينة:</div>
          <div class="label-val">${cityAr}</div>
        </div>
         <div class="label-row">
          <div class="label-key">الدفع:</div>
          <div class="label-val">${payAr}</div>
        </div>

        <div class="label-products">
          <b>المنتجات:</b><br>
          ${safeProd}
        </div>

        <div class="label-footer">
          <div>
            <div style="font-size:10pt;">المطلوب للدفع</div>
            <div class="label-price">₪${o.price}</div>
          </div>
          <div style="text-align:left">
             <div class="barcode-container">
                <svg id="barcode-${o.id}"></svg>
             </div>
          </div>
        </div>
      </div>
    `;
  }

  // --- Notifications ---
  showToast() {
    const t = document.getElementById('toast');
    t.classList.add('show');
    setTimeout(() => t.classList.remove('show'), 4000);
  }

  playNotificationSound() {
    // Improved sound handling
    const audio = new Audio('https://assets.mixkit.co/active_storage/sfx/2869/2869-preview.mp3');
    audio.volume = 0.5;
    audio.play().catch(e => console.log("Audio requires interaction first"));
  }
}

const app = new MadSystem();
</script>
</body>
</html>
