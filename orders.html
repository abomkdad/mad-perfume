<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no" />
  <title>MAD Manager</title>

  <link rel="icon" type="image/png" href="https://www.mad-parfumeur.com/assets/hero/logo.png">
  <script src="https://cdn.jsdelivr.net/npm/jsbarcode@3.11.5/dist/JsBarcode.all.min.js"></script>

  <style>
    :root{
      --bg:#0b1220;
      --card:#111c33;
      --line:#22304d;
      --text:#f8fafc;
      --muted:#9fb0c6;
      --primary:#60a5fa;
      --success:#22c55e;
      --warn:#f59e0b;
      --danger:#ef4444;
      --darkbtn:#0e1830;
      --shadow: 0 10px 30px rgba(0,0,0,.35);
      --radius:18px;
    }
    *{ box-sizing:border-box; }
    body{
      margin:0;
      font-family: system-ui, -apple-system, Segoe UI, Roboto, Arial;
      background:var(--bg);
      color:var(--text);
      display:flex;
      justify-content:center;
      padding-bottom:90px;
    }
    .app{
      width:100%;
      max-width:650px;
    }
    .top{
      position:sticky;
      top:0;
      z-index:999;
      background:rgba(11,18,32,.92);
      backdrop-filter: blur(8px);
      border-bottom:1px solid var(--line);
      padding:14px 14px 10px;
    }
    .topRow{
      display:flex;
      align-items:center;
      gap:10px;
    }
    .logo{
      width:42px;height:42px;border-radius:12px;
      background:#0f172a;
      border:1px solid var(--line);
      display:flex;align-items:center;justify-content:center;
      overflow:hidden;
      box-shadow: var(--shadow);
      flex:0 0 auto;
    }
    .logo img{ width:100%; height:100%; object-fit:cover; }
    .title{
      flex:1;
      line-height:1.1;
    }
    .title b{ display:block; font-size:18px; }
    .title span{ display:block; color:var(--muted); font-weight:800; font-size:12px; margin-top:4px; }
    .btn{
      border:none;
      cursor:pointer;
      border-radius:14px;
      padding:12px 12px;
      font-weight:1000;
      color:var(--text);
      background:var(--darkbtn);
      border:1px solid var(--line);
      box-shadow: var(--shadow);
      transition:.15s;
      user-select:none;
    }
    .btn:active{ transform:scale(.98); }
    .btnWide{
      width:100%;
      display:flex;
      gap:10px;
      justify-content:center;
      align-items:center;
      font-size:16px;
      padding:14px;
      border-radius:16px;
    }
    .btnPrimary{ background:rgba(96,165,250,.18); border-color:rgba(96,165,250,.35); }
    .btnSuccess{ background:rgba(34,197,94,.18); border-color:rgba(34,197,94,.35); }
    .btnWarn{ background:rgba(245,158,11,.18); border-color:rgba(245,158,11,.35); color:#fff; }
    .btnDanger{ background:rgba(239,68,68,.18); border-color:rgba(239,68,68,.35); }
    .btnSolidPrimary{ background: #2563eb; border-color:#2563eb; }
    .btnSolidSuccess{ background: #16a34a; border-color:#16a34a; }
    .btnSolidDanger{ background: #b91c1c; border-color:#b91c1c; }
    .btnSolidWarn{ background:#d97706; border-color:#d97706; }

    .stats{
      margin-top:10px;
      display:grid;
      grid-template-columns:1fr 1fr 1fr;
      gap:8px;
    }
    .stat{
      background:rgba(17,28,51,.7);
      border:1px solid var(--line);
      border-radius:16px;
      padding:10px;
      text-align:center;
      box-shadow: var(--shadow);
      font-weight:1000;
    }
    .stat small{ display:block; color:var(--muted); font-size:11px; margin-bottom:6px; }
    .stat b{ font-size:18px; }
    .statNew{ border-bottom:4px solid var(--warn); }
    .statWork{ border-bottom:4px solid var(--primary); }
    .statReady{ border-bottom:4px solid var(--success); }

    .searchRow{
      display:flex;
      gap:8px;
      margin-top:10px;
    }
    .search{
      flex:1;
      border-radius:16px;
      border:1px solid var(--line);
      background:#081127;
      color:var(--text);
      padding:14px;
      font-weight:900;
      outline:none;
      box-shadow: var(--shadow);
    }
    .search::placeholder{ color:#6b7d98; font-weight:900; }

    .content{
      padding:14px;
    }
    .sectionTitle{
      display:flex;
      align-items:center;
      justify-content:space-between;
      margin:14px 0 10px;
      color:var(--muted);
      font-weight:1000;
      font-size:13px;
      border-bottom:1px solid var(--line);
      padding-bottom:8px;
    }
    .sectionTitle strong{ color:var(--text); }
    .card{
      background:var(--card);
      border:1px solid var(--line);
      border-radius:var(--radius);
      padding:14px;
      box-shadow: var(--shadow);
      margin-bottom:12px;
    }
    .cardHead{
      display:flex;
      justify-content:space-between;
      gap:10px;
      align-items:flex-start;
    }
    .name{
      font-size:18px;
      font-weight:1000;
      line-height:1.2;
    }
    .badge{
      font-size:12px;
      font-weight:1000;
      padding:6px 10px;
      border-radius:999px;
      border:1px solid var(--line);
      background:#0a1430;
      color:var(--muted);
      white-space:nowrap;
    }
    .meta{
      margin-top:8px;
      display:flex;
      flex-wrap:wrap;
      gap:8px;
      color:var(--muted);
      font-weight:900;
      font-size:12px;
    }
    .offer{
      margin-top:10px;
      background:#0a1430;
      border:1px solid var(--line);
      border-radius:16px;
      padding:12px;
      font-weight:1000;
      font-size:14px;
    }
    .row2{
      display:grid;
      grid-template-columns:1fr 1fr;
      gap:10px;
      margin-top:10px;
    }
    .field{
      background:#ffffff;
      border-radius:16px;
      border:2px solid rgba(96,165,250,.45);
      padding:10px;
      color:#000;
    }
    .field label{
      display:block;
      font-size:11px;
      font-weight:1000;
      margin-bottom:6px;
      color:#0b1220;
    }
    .field input, .field select{
      width:100%;
      border:none;
      outline:none;
      background:transparent;
      font-size:18px;
      font-weight:1000;
      color:#000;
    }

    .actions{
      display:grid;
      grid-template-columns:1fr 1fr 1fr;
      gap:10px;
      margin-top:12px;
    }
    .actions .btnWide{ padding:14px 10px; font-size:15px; }

    .bottomBar{
      position:fixed;
      bottom:0;
      left:50%;
      transform:translateX(-50%);
      width:100%;
      max-width:650px;
      display:flex;
      gap:10px;
      padding:10px 14px;
      background:rgba(11,18,32,.95);
      border-top:1px solid var(--line);
      z-index:1000;
    }
    .bottomBar .btn{ flex:1; padding:14px; font-size:16px; }

    /* Modal */
    .modalWrap{
      position:fixed;
      inset:0;
      background:rgba(0,0,0,.55);
      display:none;
      align-items:center;
      justify-content:center;
      padding:16px;
      z-index:2000;
    }
    .modal{
      width:100%;
      max-width:520px;
      background:var(--card);
      border:1px solid var(--line);
      border-radius:22px;
      padding:14px;
      box-shadow: var(--shadow);
    }
    .modal h3{
      margin:0 0 12px 0;
      font-size:18px;
      font-weight:1000;
    }
    .formGrid{
      display:grid;
      grid-template-columns:1fr;
      gap:10px;
    }
    .in{
      width:100%;
      border-radius:16px;
      border:1px solid var(--line);
      background:#081127;
      color:var(--text);
      padding:14px;
      font-weight:900;
      outline:none;
      font-size:15px;
    }
    textarea.in{ min-height:90px; resize:none; }
    .modalActions{
      display:flex;
      gap:10px;
      margin-top:12px;
    }
    .modalActions .btn{ flex:1; }

    /* Toast */
    .toast{
      position:fixed;
      top:-120px;
      left:50%;
      transform:translateX(-50%);
      background:var(--warn);
      color:#000;
      font-weight:1000;
      padding:14px 18px;
      border-radius:999px;
      box-shadow: var(--shadow);
      transition:.5s;
      z-index:3000;
    }
    .toast.show{ top:18px; }

    .empty{
      text-align:center;
      color:var(--muted);
      padding:26px 10px;
      font-weight:1000;
    }
  </style>
</head>

<body>
  <div class="toast" id="toast">ØªÙ… âœ…</div>

  <div class="app">
    <div class="top">
      <div class="topRow">
        <div class="logo">
          <img src="https://www.mad-parfumeur.com/assets/hero/logo.png" alt="MAD">
        </div>
        <div class="title">
          <b>Ù†Ø³Ø®Ø© Ø§Ù„Ù…Ø¯ÙŠØ± âœ…</b>
          <span>Ø§Ø¹ØªÙ…Ø§Ø¯ + Ø´Ø±ÙƒØ© ØªÙˆØµÙŠÙ„ + ØªØ¹Ø¯ÙŠÙ„ Ø§Ù„Ø³Ø¹Ø± + Ø¥Ù„ØºØ§Ø¡ + ØªØ³Ù„ÙŠÙ… Ù„Ù„Ù…Ù†Ø¯ÙˆØ¨</span>
        </div>
        <button class="btn btnPrimary" onclick="activateAudio()">ğŸ”” ØµÙˆØª</button>
      </div>

      <div class="stats">
        <div class="stat statNew"><small>Ø·Ù„Ø¨Ø§Øª Ø¬Ø¯ÙŠØ¯Ø©</small><b id="cNew">0</b></div>
        <div class="stat statWork"><small>Ù‚ÙŠØ¯ Ø§Ù„ØªØ¬Ù‡ÙŠØ²</small><b id="cWork">0</b></div>
        <div class="stat statReady"><small>Ø¬Ø§Ù‡Ø² Ù„Ù„ØªØ³Ù„ÙŠÙ…</small><b id="cReady">0</b></div>
      </div>

      <div class="searchRow">
        <input id="q" class="search" placeholder="Ø§Ø¨Ø­Ø« Ø¨Ø§Ù„Ø§Ø³Ù… Ø£Ùˆ Ø§Ù„Ù‡Ø§ØªÙ..." oninput="render()">
        <button class="btn btnPrimary" onclick="sync()">ğŸ”„ ØªØ­Ø¯ÙŠØ«</button>
      </div>
    </div>

    <div class="content">
      <div id="list"></div>
    </div>

    <div class="bottomBar">
      <button class="btn btnSolidPrimary" onclick="openAdd()">â• Ø¥Ø¶Ø§ÙØ© Ø·Ù„Ø¨</button>
      <button class="btn btnSuccess" onclick="sync()">â†» ØªØ­Ø¯ÙŠØ« Ø§Ù„Ø¢Ù†</button>
    </div>
  </div>

  <!-- Add Modal -->
  <div class="modalWrap" id="modalWrap" onclick="closeAdd(event)">
    <div class="modal" onclick="event.stopPropagation()">
      <h3>â• Ø¥Ø¶Ø§ÙØ© Ø·Ù„Ø¨ Ø¬Ø¯ÙŠØ¯ (ÙŠØ¯ÙˆÙŠ)</h3>
      <div class="formGrid">
        <input id="in_name" class="in" placeholder="Ø§Ø³Ù… Ø§Ù„Ø²Ø¨ÙˆÙ†">
        <input id="in_phone" class="in" placeholder="Ø§Ù„Ù‡Ø§ØªÙ">
        <input id="in_addr" class="in" placeholder="Ø§Ù„Ø¹Ù†ÙˆØ§Ù† / Ø§Ù„Ù…Ø¯ÙŠÙ†Ø©">
        <input id="in_offer" class="in" placeholder="Ø§Ù„Ø·Ù„Ø¨ (C)">
        <input id="in_price" class="in" placeholder="Ø§Ù„Ø³Ø¹Ø± â‚ª (Ù…Ø«Ø§Ù„ 150)" value="150" inputmode="numeric">
        <textarea id="in_notes" class="in" placeholder="Ù…Ù„Ø§Ø­Ø¸Ø§Øª (Ø§Ø®ØªÙŠØ§Ø±ÙŠ)"></textarea>
      </div>

      <div class="modalActions">
        <button class="btn btnDanger" onclick="closeAdd()">Ø¥ØºÙ„Ø§Ù‚</button>
        <button class="btn btnSolidSuccess" onclick="saveOrder()">âœ… Ø­ÙØ¸</button>
      </div>
    </div>
  </div>

<script>
  // âœ… Ø±Ø§Ø¨Ø· Ø§Ù„Ù€ Apps Script Web App
  const SCRIPT_URL = "https://script.google.com/macros/s/AKfycbw2QxGHOxMv7_uNbMulwO60IHOcKj16rbBJRfoltkwcdb2Bg4zrVjyMt_lf9KgnyyXl/exec";

  let all = [];
  let audioCtx = null;

  // Persist maps
  let deliveryMap = JSON.parse(localStorage.getItem("mad_delivery_map") || "{}");
  let priceMap = JSON.parse(localStorage.getItem("mad_price_map") || "{}");
  let statusLocal = JSON.parse(localStorage.getItem("mad_status_map") || "{}"); // optional local cache

  function toast(msg){
    const t = document.getElementById("toast");
    t.textContent = msg;
    t.classList.add("show");
    setTimeout(()=>t.classList.remove("show"), 2500);
  }

  function activateAudio(){
    try{
      audioCtx = new (window.AudioContext || window.webkitAudioContext)();
      toast("ğŸ”” ØªÙ… ØªÙØ¹ÙŠÙ„ Ø§Ù„ØµÙˆØª");
    }catch(e){
      toast("âŒ Ø¬Ù‡Ø§Ø²Ùƒ Ù„Ø§ ÙŠØ¯Ø¹Ù… Ø§Ù„ØµÙˆØª");
    }
  }

  async function sync(){
    try{
      const res = await fetch(`${SCRIPT_URL}?action=get&t=${Date.now()}`, { cache:"no-store" });
      const data = await res.json();
      all = Array.isArray(data) ? data : [];
      render();
    }catch(e){
      console.error(e);
      toast("âŒ Ù…Ø´ÙƒÙ„Ø© Ø§ØªØµØ§Ù„");
    }
  }

  function getS(o){
    return String(statusLocal[o.orderId] || o.status || "");
  }
  function setS(orderId, s){
    statusLocal[orderId] = s;
    localStorage.setItem("mad_status_map", JSON.stringify(statusLocal));
  }
  function getPrice(o){
    const p = priceMap[o.orderId] ?? o.price ?? "150";
    const only = String(p).replace(/[^\d]/g,"");
    return only || "150";
  }
  function saveMaps(){
    localStorage.setItem("mad_delivery_map", JSON.stringify(deliveryMap));
    localStorage.setItem("mad_price_map", JSON.stringify(priceMap));
  }

  function updateCounters(){
    let n=0,w=0,r=0;
    all.forEach(o=>{
      const s = getS(o);
      if (s.includes("Canceled") || s.includes("âŒ")) return;
      if (s.includes("Delivered")) return;

      if (s.includes("××•×›×Ÿ")) r++;
      else if (s.includes("Approved") || s.includes("×××•×©×¨")) w++;
      else n++;
    });
    document.getElementById("cNew").textContent = n;
    document.getElementById("cWork").textContent = w;
    document.getElementById("cReady").textContent = r;
  }

  function normalizePhone(p){
    let d = String(p||"").replace(/[^\d]/g,"");
    if (d.startsWith("00")) d = d.slice(2);
    if (d.startsWith("9720")) d = "972" + d.slice(4);
    if (d.startsWith("0")) {
      if (d.startsWith("059") && d.length >= 10) d = "970" + d.slice(1);
      else if (d.startsWith("05") && d.length >= 10) d = "972" + d.slice(1);
      else if (d.length >= 9) d = "972" + d.slice(1);
    }
    if (d.length === 9 && d.startsWith("5")) d = "972" + d;
    if (d.length === 9 && d.startsWith("59")) d = "970" + d;
    return d;
  }

  function sendWA(phone, name, offer, orderId, price){
    const p = normalizePhone(phone);
    const total = `â‚ª${(price||"150")}.00`;
    const msg =
`*MAD* ğŸ–¤
Ø£Ù‡Ù„Ø§Ù‹ Ø¨Ùƒ *${name}*
ğŸ“¦ Ø§Ù„Ø·Ù„Ø¨: ${offer}
ğŸ“„ Ø±Ù‚Ù…: ${orderId}
ğŸ’° Ø§Ù„Ø¥Ø¬Ù…Ø§Ù„ÙŠ: ${total}
âœ¨ Ø®Ø¯Ù…Ø© Ø§Ù„Ø¹Ù…Ù„Ø§Ø¡: 9935*`;
    window.open(`https://wa.me/${p}?text=${encodeURIComponent(msg)}`, "_blank");
  }

  async function updateStatus(rowIndex, orderId, status){
    setS(orderId, status);
    render();

    try{
      await fetch(`${SCRIPT_URL}?action=updateStatus&row=${encodeURIComponent(rowIndex)}&orderId=${encodeURIComponent(orderId)}&status=${encodeURIComponent(status)}&t=${Date.now()}`, { cache:"no-store" });
      toast("âœ… ØªÙ… ØªØ­Ø¯ÙŠØ« Ø§Ù„Ø­Ø§Ù„Ø©");
    }catch(e){
      toast("âš ï¸ ØªÙ… Ù…Ø­Ù„ÙŠÙ‹Ø§ (ØªØ­Ù‚Ù‚ Ù…Ù† Ø§Ù„Ø³ÙƒØ±Ø¨Øª)");
    }
  }

  async function updatePrice(rowIndex, orderId, price){
    const p = String(price||"").replace(/[^\d]/g,"");
    if(!p){ toast("âŒ Ø£Ø¯Ø®Ù„ Ø³Ø¹Ø± ØµØ­ÙŠØ­"); return; }
    priceMap[orderId] = p;
    saveMaps();
    render();

    try{
      await fetch(`${SCRIPT_URL}?action=updatePrice&row=${encodeURIComponent(rowIndex)}&orderId=${encodeURIComponent(orderId)}&price=${encodeURIComponent(p)}&t=${Date.now()}`, { cache:"no-store" });
      toast("âœ… ØªÙ… Ø­ÙØ¸ Ø§Ù„Ø³Ø¹Ø±");
    }catch(e){
      toast("âš ï¸ ØªÙ… Ù…Ø­Ù„ÙŠÙ‹Ø§ (ØªØ­Ù‚Ù‚ Ù…Ù† Ø§Ù„Ø³ÙƒØ±Ø¨Øª)");
    }
  }

  function card(o){
    const s = getS(o);
    const q = (document.getElementById("q").value || "").toLowerCase();
    const name = String(o.name || "-");
    const phone = String(o.phone || "-");
    const city = String(o.city || "-");
    const offer = String(o.offer || "-");
    const row = o.rowIndex;
    const orderId = o.orderId || "";
    const price = getPrice(o);

    const match = name.toLowerCase().includes(q) || phone.includes(q) || offer.toLowerCase().includes(q);
    if(q && !match) return "";

    const isDelivered = s.includes("Delivered");
    const isCanceled = s.includes("Canceled") || s.includes("âŒ");
    const isReady = s.includes("××•×›×Ÿ") && !isDelivered && !isCanceled;
    const isApproved = (s.includes("Approved") || s.includes("×××•×©×¨")) && !isReady && !isDelivered && !isCanceled;
    const isNew = !isApproved && !isReady && !isDelivered && !isCanceled;

    let badge = "Ø¬Ø¯ÙŠØ¯";
    if(isApproved) badge = "Ù…Ø¹ØªÙ…Ø¯ / Ù‚ÙŠØ¯ Ø§Ù„ØªØ¬Ù‡ÙŠØ²";
    if(isReady) badge = "Ø¬Ø§Ù‡Ø² Ù„Ù„ØªØ³Ù„ÙŠÙ…";
    if(isDelivered) badge = "ØªÙ… Ø§Ù„ØªØ³Ù„ÙŠÙ…";
    if(isCanceled) badge = "Ù…Ù„ØºÙŠ";

    const del = deliveryMap[orderId] || "";
    const approveDisabled = (!del || !isNew);

    return `
      <div class="card">
        <div class="cardHead">
          <div>
            <div class="name">${escapeHtml(name)}</div>
            <div class="meta">
              <span>ğŸ“ ${escapeHtml(phone)}</span>
              <span>ğŸ“ ${escapeHtml(city)}</span>
              <span>ğŸ’° â‚ª${escapeHtml(price)}</span>
            </div>
          </div>
          <div class="badge">${escapeHtml(badge)}</div>
        </div>

        <div class="offer">ğŸ“¦ ${escapeHtml(offer)}</div>

        <div class="row2">
          <div class="field">
            <label>ğŸ’° ØªØ¹Ø¯ÙŠÙ„ Ø§Ù„Ø³Ø¹Ø± (â‚ª)</label>
            <input type="number" inputmode="numeric" min="0" value="${escapeHtml(price)}"
              oninput="priceMap['${escapeAttr(orderId)}']=this.value; saveMaps()">
            <button class="btn btnSolidWarn btnWide" style="margin-top:8px" onclick="updatePrice('${row}','${escapeAttr(orderId)}', priceMap['${escapeAttr(orderId)}'] || '${escapeAttr(price)}')">ğŸ’¾ Ø­ÙØ¸ Ø§Ù„Ø³Ø¹Ø±</button>
          </div>

          <div class="field">
            <label>ğŸšš Ø´Ø±ÙƒØ© Ø§Ù„ØªÙˆØµÙŠÙ„ (Ù…Ø·Ù„ÙˆØ¨ Ù„Ù„Ø§Ø¹ØªÙ…Ø§Ø¯)</label>
            <select onchange="deliveryMap['${escapeAttr(orderId)}']=this.value; saveMaps(); render()">
              <option value="">-- Ø§Ø®ØªØ± Ø´Ø±ÙƒØ© --</option>
              <option value="High Express" ${del==="High Express"?"selected":""}>High Express</option>
              <option value="Marwah Delivery" ${del==="Marwah Delivery"?"selected":""}>Marwah Delivery</option>
              <option value="Lama Delivery" ${del==="Lama Delivery"?"selected":""}>Lama Delivery</option>
              <option value="Areen Delivery" ${del==="Areen Delivery"?"selected":""}>Areen Delivery</option>
            </select>
          </div>
        </div>

        <div class="actions">
          <button class="btn btnSolidSuccess btnWide" ${approveDisabled?"disabled":""}
            onclick="updateStatus('${row}','${escapeAttr(orderId)}','Approved âœ… (××©×œ×•×—: ${escapeAttr(del)})')">âœ… Ø§Ø¹ØªÙ…Ø§Ø¯</button>

          <button class="btn btnSolidPrimary btnWide" onclick="sendWA('${escapeAttr(phone)}','${escapeAttr(name)}','${escapeAttr(offer)}','${escapeAttr(orderId)}','${escapeAttr(priceMap[orderId]||price)}')">ğŸ’¬ ÙˆØ§ØªØ³Ø§Ø¨</button>

          ${isReady
            ? `<button class="btn btnSolidWarn btnWide" onclick="updateStatus('${row}','${escapeAttr(orderId)}','Delivered âœ…')">âœ… ØªØ³Ù„ÙŠÙ… Ù„Ù„Ù…Ù†Ø¯ÙˆØ¨</button>`
            : `<button class="btn btnSolidDanger btnWide" ${(!isNew && !isApproved)?"disabled":""} onclick="updateStatus('${row}','${escapeAttr(orderId)}','Canceled âŒ')">âŒ Ø¥Ù„ØºØ§Ø¡</button>`
          }
        </div>
      </div>
    `;
  }

  function render(){
    updateCounters();

    const newList = [];
    const workList = [];
    const readyList = [];

    all.slice().reverse().forEach(o=>{
      const s = getS(o);
      if (s.includes("Delivered")) return;
      if (s.includes("Canceled") || s.includes("âŒ")) return;

      if (s.includes("××•×›×Ÿ")) readyList.push(o);
      else if (s.includes("Approved") || s.includes("×××•×©×¨")) workList.push(o);
      else newList.push(o);
    });

    let html = "";
    html += `<div class="sectionTitle"><strong>Ø·Ù„Ø¨Ø§Øª Ø¬Ø¯ÙŠØ¯Ø©</strong><span>${newList.length}</span></div>`;
    html += newList.length ? newList.map(card).join("") : `<div class="empty">Ù„Ø§ ÙŠÙˆØ¬Ø¯ Ø·Ù„Ø¨Ø§Øª Ø¬Ø¯ÙŠØ¯Ø©</div>`;

    html += `<div class="sectionTitle"><strong>Ù‚ÙŠØ¯ Ø§Ù„ØªØ¬Ù‡ÙŠØ²</strong><span>${workList.length}</span></div>`;
    html += workList.length ? workList.map(card).join("") : `<div class="empty">Ù„Ø§ ÙŠÙˆØ¬Ø¯</div>`;

    html += `<div class="sectionTitle"><strong>Ø¬Ø§Ù‡Ø² Ù„Ù„ØªØ³Ù„ÙŠÙ…</strong><span>${readyList.length}</span></div>`;
    html += readyList.length ? readyList.map(card).join("") : `<div class="empty">Ù„Ø§ ÙŠÙˆØ¬Ø¯</div>`;

    document.getElementById("list").innerHTML = html;
  }

  function openAdd(){
    document.getElementById("modalWrap").style.display = "flex";
  }
  function closeAdd(e){
    document.getElementById("modalWrap").style.display = "none";
  }

  async function saveOrder(){
    const name = document.getElementById("in_name").value.trim();
    const phone = document.getElementById("in_phone").value.trim();
    const address = document.getElementById("in_addr").value.trim();
    const offer = document.getElementById("in_offer").value.trim();
    const price = String(document.getElementById("in_price").value || "150").replace(/[^\d]/g,"") || "150";
    const notes = document.getElementById("in_notes").value.trim();

    if(!name || !phone || !offer){ toast("âŒ Ø§ÙƒØªØ¨ Ø§Ù„Ø§Ø³Ù… + Ø§Ù„Ù‡Ø§ØªÙ + Ø§Ù„Ø·Ù„Ø¨"); return; }

    const payload = {
      name, phone,
      address: address || "-",
      offer,
      price,
      notes,
      source: "Manager Manual",
      lang: "ar",
      payment: "Cash",
      process: "Direct",
      status: "Processing..."
    };

    try{
      fetch(SCRIPT_URL, { method:"POST", mode:"no-cors", body: JSON.stringify(payload) });
      toast("âœ… ØªÙ… Ø­ÙØ¸ Ø§Ù„Ø·Ù„Ø¨");
      closeAdd();
      // clear
      ["in_name","in_phone","in_addr","in_offer","in_notes"].forEach(id=>document.getElementById(id).value="");
      document.getElementById("in_price").value = "150";
      setTimeout(sync, 600);
    }catch(e){
      toast("âŒ ÙØ´Ù„ Ø§Ù„Ø­ÙØ¸");
    }
  }

  function escapeHtml(str){
    return String(str ?? "").replace(/[&<>"']/g, s => ({
      "&":"&amp;","<":"&lt;",">":"&gt;",'"':"&quot;","'":"&#39;"
    }[s]));
  }
  function escapeAttr(str){
    return String(str ?? "").replace(/'/g, "\\'").replace(/"/g, '\\"');
  }

  // Start
  sync();
  setInterval(sync, 25000);
</script>
</body>
</html>
