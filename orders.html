<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no"/>
  <title>MAD Manager - Easy Mode</title>
  <link rel="icon" type="image/png" href="https://www.mad-parfumeur.com/assets/hero/logo.png">

  <style>
    :root{
      --bg:#071022; --card:#0d1a33; --line:#1e2b47;
      --text:#f8fafc; --muted:#9fb0c6;
      --success:#16a34a; --warn:#f59e0b; --primary:#2563eb; --danger:#ef4444;
      --shadow:0 12px 35px rgba(0,0,0,.45);
      --r:22px;
    }
    *{box-sizing:border-box}
    body{
      margin:0; font-family:system-ui,"Segoe UI",Tahoma,Arial;
      background:radial-gradient(1200px 600px at 20% 0%, rgba(37,99,235,.14), transparent 55%),
                 radial-gradient(1000px 700px at 80% 15%, rgba(245,158,11,.10), transparent 55%),
                 var(--bg);
      color:var(--text);
      display:flex; justify-content:center;
      padding-bottom:110px;
    }
    .app{width:100%; max-width:980px}
    .top{
      position:sticky; top:0; z-index:999;
      background:rgba(7,16,34,.92); backdrop-filter:blur(10px);
      border-bottom:1px solid var(--line);
      padding:14px;
    }
    .head{display:flex; gap:10px; align-items:center}
    .logo{
      width:46px; height:46px; border-radius:16px; overflow:hidden;
      border:1px solid var(--line); background:#0b1730; box-shadow:var(--shadow);
      flex:0 0 auto;
    }
    .logo img{width:100%; height:100%; object-fit:cover}
    .title{flex:1; line-height:1.1}
    .title b{display:block; font-size:18px}
    .title span{display:block; margin-top:4px; font-size:12px; font-weight:900; color:var(--muted)}
    .iconBtn{
      width:48px; height:48px; border-radius:16px;
      border:1px solid var(--line);
      background:#0b1730; color:var(--text);
      box-shadow:var(--shadow);
      cursor:pointer; font-size:18px; font-weight:1000;
      flex:0 0 auto;
    }
    .dash{
      display:flex; gap:8px; margin-top:10px; flex-wrap:wrap;
    }
    .stat{
      flex:1; min-width:140px;
      background:rgba(13,26,51,.92);
      border:1px solid var(--line);
      border-radius:18px;
      padding:10px;
      box-shadow:var(--shadow);
      display:flex; justify-content:space-between; align-items:center;
      font-weight:1000;
    }
    .stat small{color:var(--muted); font-weight:900}
    .stat .n{font-size:18px}
    .sNew{border-bottom:3px solid var(--warn)}
    .sPrep{border-bottom:3px solid var(--primary)}
    .sReady{border-bottom:3px solid var(--success)}

    .search{
      width:100%;
      border-radius:18px; border:1px solid var(--line);
      background:#071331; color:var(--text);
      padding:14px 14px; font-weight:1000;
      outline:none; box-shadow:var(--shadow);
      font-size:16px;
      margin-top:10px;
    }

    .tabs{
      display:flex; gap:8px; margin-top:10px; flex-wrap:wrap;
    }
    .tab{
      border:1px solid var(--line);
      background:#0b1730;
      color:var(--muted);
      padding:10px 12px;
      border-radius:16px;
      font-weight:1000;
      cursor:pointer;
      box-shadow:var(--shadow);
      flex:1; min-width:160px;
      text-align:center;
    }
    .tab.active{color:var(--text); border-color:rgba(37,99,235,.6); background:rgba(37,99,235,.15)}
    .content{padding:14px}
    .sectionTitle{
      display:flex; justify-content:space-between; align-items:center;
      padding:10px 6px;
      margin:10px 0;
      color:var(--muted);
      font-weight:1100;
      border-bottom:1px solid rgba(255,255,255,.10);
    }

    .card{
      background:linear-gradient(180deg, rgba(13,26,51,.92), rgba(13,26,51,.78));
      border:1px solid var(--line);
      border-radius:var(--r);
      padding:14px;
      box-shadow:var(--shadow);
      margin-bottom:14px;
      position:relative;
      overflow:hidden;
    }
    .stripe{
      position:absolute; top:0; right:0; width:10px; height:100%;
      background:#475569;
    }
    .stripe.new{background:var(--warn)}
    .stripe.prep{background:var(--primary)}
    .stripe.ready{background:var(--success)}

    .rowTop{
      display:flex; gap:10px; align-items:center; flex-wrap:wrap;
    }
    .badge{
      padding:6px 10px;
      border-radius:999px;
      font-weight:1100;
      font-size:12px;
      background:rgba(255,255,255,.08);
      border:1px solid rgba(255,255,255,.10);
      color:var(--text);
    }
    .badge.new{background:rgba(245,158,11,.16); border-color:rgba(245,158,11,.35)}
    .badge.prep{background:rgba(37,99,235,.16); border-color:rgba(37,99,235,.35)}
    .badge.ready{background:rgba(22,163,74,.16); border-color:rgba(22,163,74,.35)}

    .oid{color:#bfdbfe; font-weight:1100}
    .grid{
      display:grid;
      grid-template-columns: 1fr 1fr;
      gap:10px;
      margin-top:12px;
    }
    @media (max-width: 820px){
      .grid{grid-template-columns:1fr}
    }
    .field{
      background:#fff;
      border-radius:18px;
      border:2px solid rgba(37,99,235,.18);
      padding:12px;
      color:#0b1020;
    }
    .field label{display:block; font-size:11px; font-weight:1100; margin-bottom:6px; color:#0b1020}
    .field input,.field textarea,.field select{
      width:100%; border:none; outline:none; background:transparent;
      font-size:18px; font-weight:1100; color:#0b1020;
    }
    .field textarea{resize:vertical}
    .full{grid-column: 1 / -1;}
    .btns{
      display:grid;
      grid-template-columns: 1fr 1fr 1fr;
      gap:10px;
      margin-top:12px;
    }
    @media (max-width: 820px){
      .btns{grid-template-columns:1fr}
    }
    .btn{
      border:none; cursor:pointer;
      border-radius:18px; padding:16px 14px;
      font-weight:1100; font-size:18px;
      box-shadow:var(--shadow);
      transition:.12s; user-select:none;
      display:flex; align-items:center; justify-content:center; gap:10px;
    }
    .btn:active{transform:scale(.98)}
    .btnSave{background:var(--primary); color:white}
    .btnSend{background:var(--success); color:white}
    .btnWA{background:#065f46; color:#d1fae5}
    .btnConfirm{background:#0ea5e9; color:#001019}
    .btnDel{background:#7c3aed; color:white}
    .btnCancel{background:var(--danger); color:white}
    .btn:disabled{opacity:.25; cursor:not-allowed}

    .hint{
      margin-top:10px;
      padding:10px 12px;
      border-radius:18px;
      border:1px dashed rgba(255,255,255,.18);
      color:var(--muted);
      font-weight:1000;
      text-align:center;
    }
    .empty{
      text-align:center;
      color:var(--muted);
      padding:20px;
      font-weight:1100;
      background:rgba(13,26,51,.65);
      border:1px solid var(--line);
      border-radius:22px;
      box-shadow:var(--shadow);
    }
    .toast{
      position:fixed; top:-120px; left:50%;
      transform:translateX(-50%);
      background:var(--warn); color:#0b1020;
      font-weight:1000; padding:12px 16px; border-radius:999px;
      box-shadow:var(--shadow);
      transition:.5s; z-index:2000;
    }
    .toast.show{top:16px}

    /* Bottom bar (Add new order) */
    .bottomBar{
      position:fixed; bottom:0; left:0; right:0;
      display:flex; justify-content:center;
      padding:10px;
      background:rgba(7,16,34,.92); backdrop-filter:blur(10px);
      border-top:1px solid var(--line);
      z-index:1000;
    }
    .addBtn{
      width:100%; max-width:980px;
      border:none; cursor:pointer;
      border-radius:18px;
      padding:16px 14px;
      font-weight:1100; font-size:18px;
      background:rgba(245,158,11,.18);
      color:#fff;
      border:1px solid rgba(245,158,11,.35);
      box-shadow:var(--shadow);
    }

    /* Modal add new order */
    .modalWrap{
      position:fixed; inset:0;
      background:rgba(0,0,0,.55);
      display:none; align-items:center; justify-content:center;
      padding:16px; z-index:3000;
    }
    .modal{
      width:100%; max-width:820px;
      background:var(--card);
      border:1px solid var(--line);
      border-radius:24px;
      padding:14px;
      box-shadow:var(--shadow);
    }
    .modal h3{margin:0 0 10px 0; font-size:18px; font-weight:1100}
    .modalActions{display:grid; grid-template-columns:1fr 1fr; gap:10px; margin-top:12px}
    .btnClose{background:var(--danger); color:white}
  </style>
</head>

<body>
  <div class="toast" id="toast">ØªÙ… âœ…</div>

  <div class="app">
    <div class="top">
      <div class="head">
        <div class="logo"><img src="https://www.mad-parfumeur.com/assets/hero/logo.png" alt="MAD"></div>
        <div class="title">
          <b>Ù†Ø³Ø®Ø© Ø§Ù„Ù…Ø¯ÙŠØ± (Ø³Ù‡Ù„ Ø¬Ø¯Ù‹Ø§)</b>
          <span>Ø·Ù„Ø¨Ø§Øª Ø¬Ø¯ÙŠØ¯Ø© â†’ Ø¥Ø±Ø³Ø§Ù„ Ù„Ù„ØªØ¬Ù‡ÙŠØ² â†’ Ø¬Ø§Ù‡Ø² â†’ ØªØ³Ù„ÙŠÙ… Ù„Ù„Ù…Ù†Ø¯ÙˆØ¨</span>
        </div>
        <button class="iconBtn" onclick="sync()" title="ØªØ­Ø¯ÙŠØ«">â†»</button>
      </div>

      <div class="dash">
        <div class="stat sNew"><small>Ø¬Ø¯ÙŠØ¯</small><span class="n" id="cNew">0</span></div>
        <div class="stat sPrep"><small>ØªÙ… Ø§Ù„Ø¥Ø±Ø³Ø§Ù„ Ù„Ù„ØªØ¬Ù‡ÙŠØ²</small><span class="n" id="cPrep">0</span></div>
        <div class="stat sReady"><small>Ø¬Ø§Ù‡Ø²</small><span class="n" id="cReady">0</span></div>
      </div>

      <input id="q" class="search" placeholder="Ø¨Ø­Ø«: Ø§Ø³Ù… / Ù‡Ø§ØªÙ / Ø·Ù„Ø¨..." oninput="render()">

      <div class="tabs">
        <button class="tab active" id="tab_new" onclick="setView('new')">ğŸŸ  Ø¬Ø¯ÙŠØ¯</button>
        <button class="tab" id="tab_prep" onclick="setView('prep')">ğŸ”µ ØªÙ… Ø§Ù„Ø¥Ø±Ø³Ø§Ù„ Ù„Ù„ØªØ¬Ù‡ÙŠØ²</button>
        <button class="tab" id="tab_ready" onclick="setView('ready')">ğŸŸ¢ Ø¬Ø§Ù‡Ø²</button>
      </div>
    </div>

    <div class="content" id="list"></div>
  </div>

  <!-- Bottom Add Button -->
  <div class="bottomBar">
    <button class="addBtn" onclick="openAdd()">â• Ø¥Ø¶Ø§ÙØ© Ø·Ù„Ø¨ Ø¬Ø¯ÙŠØ¯ (Ù…Ø¹ Ø§Ù„Ø³Ø¹Ø±)</button>
  </div>

  <!-- Add Modal -->
  <div class="modalWrap" id="addWrap" onclick="closeAdd(event)">
    <div class="modal" onclick="event.stopPropagation()">
      <h3>â• Ø¥Ø¶Ø§ÙØ© Ø·Ù„Ø¨ Ø¬Ø¯ÙŠØ¯</h3>

      <div class="grid">
        <div class="field"><label>Ø§Ø³Ù… Ø§Ù„Ø²Ø¨ÙˆÙ†</label><input id="a_name" placeholder="Ù…Ø«Ø§Ù„: Ù…Ø­Ù…Ø¯"></div>
        <div class="field"><label>Ø§Ù„Ù‡Ø§ØªÙ</label><input id="a_phone" inputmode="tel" placeholder="05X... Ø£Ùˆ 972..."></div>

        <div class="field full"><label>Ø§Ù„Ù…Ø¯ÙŠÙ†Ø© / Ø§Ù„Ø¹Ù†ÙˆØ§Ù†</label><input id="a_city" placeholder="Ø§Ù„Ø¹Ù†ÙˆØ§Ù† ÙƒØ§Ù…Ù„"></div>

        <div class="field full"><label>Ø§Ù„Ø·Ù„Ø¨ (C)</label><input id="a_offer" placeholder="W183 X102 ... he"></div>

        <div class="field"><label>Ø§Ù„Ø³Ø¹Ø± â‚ª</label><input id="a_price" inputmode="numeric" value="150"></div>

        <div class="field"><label>Ù…Ù„Ø§Ø­Ø¸Ø§Øª</label><input id="a_notes" placeholder="Ù…Ø«Ø§Ù„: order_confirmation_he / Ø¹Ø±Ø¶ Ø®Ø§Øµ"></div>
      </div>

      <div class="modalActions">
        <button class="btn btnClose" onclick="closeAdd()">Ø¥Ù„ØºØ§Ø¡</button>
        <button class="btn btnSend" onclick="addOrder()">âœ… Ø­ÙØ¸ Ø§Ù„Ø·Ù„Ø¨</button>
      </div>
    </div>
  </div>

<script>
  // âœ… Ø¶Ø¹ Ø±Ø§Ø¨Ø· Ø§Ù„Ø³ÙƒØ±Ø¨Øª ØªØ¨Ø¹Ùƒ
  const SCRIPT_URL = "https://script.google.com/macros/s/AKfycbw2QxGHOxMv7_uNbMulwO60IHOcKj16rbBJRfoltkwcdb2Bg4zrVjyMt_lf9KgnyyXl/exec";
  const CUSTOMER_SERVICE = "9935";

  let all = [];
  let view = "new";

  function toast(msg){
    const t = document.getElementById("toast");
    t.textContent = msg;
    t.classList.add("show");
    setTimeout(()=>t.classList.remove("show"), 2200);
  }

  function setView(v){
    view = v;
    document.querySelectorAll(".tab").forEach(x=>x.classList.remove("active"));
    document.getElementById("tab_"+v).classList.add("active");
    render();
  }

  function isApproved(s){ s=String(s||""); return s.includes("Approved") || s.includes("×××•×©×¨"); }
  function isReady(s){ s=String(s||""); return s.includes("××•×›×Ÿ"); }
  function isDelivered(s){ s=String(s||""); return s.includes("Delivered"); }
  function isCanceled(s){ s=String(s||""); return s.includes("Canceled") || s.includes("âŒ"); }

  function parseDeliveryFromStatus(s){
    const m = String(s||"").match(/\(××©×œ×•×—:\s*(.*?)\)/);
    return m ? m[1] : "";
  }

  function extractPrice(o){
    // prefer o.price
    let p = String(o.price||"").replace(/[^\d]/g,"");
    if(p) return p;

    // try notes: Price: 500 â‚ª
    const notes = String(o.notes||"");
    let m = notes.match(/Price:\s*([0-9]{2,6})\s*â‚ª/i);
    if(m) return m[1];

    // try offerRaw: "= 500 â‚ª" or "500 â‚ª"
    const offerRaw = String(o.offerRaw || o.offer || "");
    m = offerRaw.match(/=\s*([0-9]{2,6})/);
    if(m) return m[1];
    m = offerRaw.match(/([0-9]{2,6})\s*â‚ª/);
    if(m) return m[1];

    return "150";
  }

  function escapeHtml(str){
    return String(str ?? "").replace(/[&<>"']/g, s => ({ "&":"&amp;","<":"&lt;",">":"&gt;",'"':"&quot;","'":"&#39;" }[s]));
  }

  function safeId(x){
    return String(x).replace(/[^\w-]/g,"_");
  }

  async function sync(){
    try{
      const res = await fetch(`${SCRIPT_URL}?action=get&t=${Date.now()}`, { cache:"no-store" });
      const data = await res.json();
      all = Array.isArray(data) ? data : [];
      updateDash();
      render();
    }catch(e){
      all = [];
      updateDash();
      render();
      toast("âš ï¸ Ù…Ø´ÙƒÙ„Ø© Ø§ØªØµØ§Ù„");
    }
  }

  function updateDash(){
    let n=0,p=0,r=0;
    all.forEach(o=>{
      const s = String(o.status||"");
      if(isDelivered(s) || isCanceled(s)) return;
      if(isReady(s)) r++;
      else if(isApproved(s)) p++;
      else n++;
    });
    document.getElementById("cNew").innerText = n;
    document.getElementById("cPrep").innerText = p;
    document.getElementById("cReady").innerText = r;
  }

  function render(){
    const q = (document.getElementById("q").value||"").toLowerCase();
    const rev = all.slice().reverse();

    const filtered = rev.filter(o=>{
      const s = String(o.status||"");
      if(isDelivered(s) || isCanceled(s)) return false;

      if(view==="new"){
        if(isApproved(s) || isReady(s)) return false;
      } else if(view==="prep"){
        if(!isApproved(s) || isReady(s)) return false;
      } else if(view==="ready"){
        if(!isReady(s)) return false;
      }

      if(!q) return true;
      const match = String(o.name||"").toLowerCase().includes(q) ||
                    String(o.phone||"").includes(q) ||
                    String(o.offer||"").toLowerCase().includes(q) ||
                    String(o.offerRaw||"").toLowerCase().includes(q) ||
                    String(o.orderId||"").toLowerCase().includes(q);
      return match;
    });

    if(!filtered.length){
      document.getElementById("list").innerHTML = `<div class="empty">Ù„Ø§ ÙŠÙˆØ¬Ø¯ Ø·Ù„Ø¨Ø§Øª ÙÙŠ Ù‡Ø°Ø§ Ø§Ù„Ù‚Ø³Ù… âœ…</div>`;
      return;
    }

    document.getElementById("list").innerHTML = filtered.map(o=>{
      const s = String(o.status||"");
      const delivery = parseDeliveryFromStatus(s) || "";
      const price = extractPrice(o);
      const orderId = o.orderId || ("ROW-"+o.rowIndex);

      const stripe = view==="new" ? "new" : (view==="prep" ? "prep" : "ready");
      const badge = view==="new" ? "new" : (view==="prep" ? "prep" : "ready");
      const badgeText = view==="new" ? "Ø·Ù„Ø¨ Ø¬Ø¯ÙŠØ¯" : (view==="prep" ? "ØªÙ… Ø¥Ø±Ø³Ø§Ù„Ù‡ Ù„Ù„ØªØ¬Ù‡ÙŠØ²" : "Ø¬Ø§Ù‡Ø² Ù„Ù„ØªÙˆØµÙŠÙ„");

      const rid = safeId(o.rowIndex);

      return `
        <div class="card">
          <div class="stripe ${stripe}"></div>

          <div class="rowTop">
            <span class="badge ${badge}">${badgeText}</span>
            <span class="oid">Ø±Ù‚Ù…: ${escapeHtml(orderId)}</span>
            <span class="badge" style="margin-inline-start:auto">${escapeHtml(s||"â€”")}</span>
          </div>

          <div class="grid">
            <div class="field"><label>Ø§Ø³Ù… Ø§Ù„Ø²Ø¨ÙˆÙ†</label>
              <input id="name_${rid}" value="${escapeHtml(o.name||"")}" />
            </div>

            <div class="field"><label>Ø§Ù„Ù‡Ø§ØªÙ</label>
              <input id="phone_${rid}" value="${escapeHtml(o.phone||"")}" />
            </div>

            <div class="field full"><label>Ø§Ù„Ù…Ø¯ÙŠÙ†Ø© / Ø§Ù„Ø¹Ù†ÙˆØ§Ù†</label>
              <input id="city_${rid}" value="${escapeHtml(o.city||"")}" />
            </div>

            <div class="field full"><label>Ø§Ù„Ø·Ù„Ø¨ (C)</label>
              <input id="offer_${rid}" value="${escapeHtml(o.offer||o.offerRaw||"")}" />
            </div>

            <div class="field"><label>Ø§Ù„Ø³Ø¹Ø± â‚ª</label>
              <input id="price_${rid}" inputmode="numeric" value="${escapeHtml(price)}" />
            </div>

            <div class="field"><label>Ø´Ø±ÙƒØ© Ø§Ù„ØªÙˆØµÙŠÙ„</label>
              <select id="del_${rid}">
                <option value="">-- Ø§Ø®ØªØ± --</option>
                <option ${delivery==="High Express"?"selected":""} value="High Express">High Express</option>
                <option ${delivery==="Marwah Delivery"?"selected":""} value="Marwah Delivery">Marwah Delivery</option>
                <option ${delivery==="Lama Delivery"?"selected":""} value="Lama Delivery">Lama Delivery</option>
                <option ${delivery==="Areen Delivery"?"selected":""} value="Areen Delivery">Areen Delivery</option>
              </select>
            </div>

            <div class="field full"><label>Ø§Ù„Ø­Ø§Ù„Ø© (ØªÙ‚Ø¯Ø± ØªØ¹Ø¯Ù„Ù‡Ø§)</label>
              <input id="status_${rid}" value="${escapeHtml(s||"")}" placeholder="Ù…Ø«Ø§Ù„: Approved âœ… (××©×œ×•×—: High Express)" />
            </div>

            <div class="field full"><label>Ù…Ù„Ø§Ø­Ø¸Ø§Øª</label>
              <textarea id="notes_${rid}" rows="2">${escapeHtml(o.notes||"")}</textarea>
            </div>
          </div>

          <div class="btns">
            <button class="btn btnSave" onclick="saveAll(${o.rowIndex}, '${escapeHtml(orderId)}')">ğŸ’¾ Ø­ÙØ¸ Ø§Ù„ØªØ¹Ø¯ÙŠÙ„</button>

            <button class="btn btnSend" ${view!=="new" ? "disabled" : ""} onclick="sendToPrep(${o.rowIndex}, '${escapeHtml(orderId)}')">
              âœ… Ø¥Ø±Ø³Ø§Ù„ Ù„Ù„ØªØ¬Ù‡ÙŠØ²
            </button>

            <button class="btn btnConfirm" onclick="confirmCustomer(${o.rowIndex}, '${escapeHtml(orderId)}')">âœ… ØªØ£ÙƒÙŠØ¯ Ù„Ù„Ø¹Ù…ÙŠÙ„</button>

            <button class="btn btnWA" onclick="openWA(${o.rowIndex}, '${escapeHtml(orderId)}')">ğŸ’¬ ÙˆØ§ØªØ³Ø§Ø¨</button>

            <button class="btn btnDel" ${view!=="ready" ? "disabled" : ""} onclick="markDelivered(${o.rowIndex}, '${escapeHtml(orderId)}')">
              âœ… ØªØ³Ù„ÙŠÙ… Ù„Ù„Ù…Ù†Ø¯ÙˆØ¨
            </button>

            <button class="btn btnCancel" onclick="cancelOrder(${o.rowIndex}, '${escapeHtml(orderId)}')">âŒ Ø¥Ù„ØºØ§Ø¡</button>
          </div>

          <div class="hint">
            âš ï¸ Ø¥Ø°Ø§ Ù…Ø§ Ø¸Ù‡Ø± â€œØ¥Ø±Ø³Ø§Ù„ Ù„Ù„ØªØ¬Ù‡ÙŠØ²â€ ÙØ¹Ù‘Ø§Ù„: Ù‡Ø°Ø§ Ø§Ù„Ø·Ù„Ø¨ Ù„ÙŠØ³ Ø¬Ø¯ÙŠØ¯Ù‹Ø§ Ø£Ùˆ ØªÙ… Ø§Ø¹ØªÙ…Ø§Ø¯Ù‡ Ø³Ø§Ø¨Ù‚Ù‹Ø§.
          </div>
        </div>
      `;
    }).join("");
  }

  function getVals(row){
    const rid = safeId(row);
    const name = (document.getElementById("name_"+rid).value||"").trim();
    const phone = (document.getElementById("phone_"+rid).value||"").trim();
    const city = (document.getElementById("city_"+rid).value||"").trim();
    const offer = (document.getElementById("offer_"+rid).value||"").trim();
    const price = String(document.getElementById("price_"+rid).value||"150").replace(/[^\d]/g,"") || "150";
    const notes = (document.getElementById("notes_"+rid).value||"").trim();
    const status = (document.getElementById("status_"+rid).value||"").trim();
    const delivery = (document.getElementById("del_"+rid).value||"").trim();
    return {name, phone, city, offer, price, notes, status, delivery};
  }

  async function saveAll(row, orderId){
    const v = getVals(row);

    // âœ… notes standardized (Ù„Ùˆ Ø¨ØªØ­Ø¨)
    // Ø®Ù„Ù‘ÙŠÙ‡Ø§ Ù…Ø«Ù„ Ø§Ù„Ù†Ø¸Ø§Ù…:
    // Price: 500 â‚ª | Pay: Cash | Proc: Direct | Addr: xxx
    // Ø¥Ø°Ø§ Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù… ÙƒØªØ¨ notes Ù…Ø®ØªÙ„ÙØ©ØŒ Ù…Ø§ Ø¨Ù†ÙØ±Ø¶ Ø¹Ù„ÙŠÙ‡.
    await updateOrder(row, orderId, v);

    // Ø¥Ø°Ø§ Ø§Ù„Ù…Ø¯ÙŠØ± Ø¹Ø¯Ù‘Ù„ Ø§Ù„Ø­Ø§Ù„Ø© ÙŠØ¯ÙˆÙŠÙ‹Ø§
    if(v.status){
      await updateStatus(row, orderId, v.status);
    }

    toast("âœ… ØªÙ… Ø§Ù„Ø­ÙØ¸");
    setTimeout(sync, 500);
  }

  async function sendToPrep(row, orderId){
    const v = getVals(row);
    if(!v.delivery){
      toast("âŒ Ø§Ø®ØªØ± Ø´Ø±ÙƒØ© ØªÙˆØµÙŠÙ„ Ø£ÙˆÙ„Ø§Ù‹");
      return;
    }

    // Ø§Ø­ÙØ¸ ÙƒÙ„ Ø§Ù„ØªØ¹Ø¯ÙŠÙ„Ø§Øª Ø£ÙˆÙ„Ø§Ù‹
    await updateOrder(row, orderId, v);

    // Ø«Ù… ØºÙŠÙ‘Ø± Ø§Ù„Ø­Ø§Ù„Ø© Ø¥Ù„Ù‰ Approved Ù…Ø¹ Ø´Ø±ÙƒØ© Ø§Ù„ØªÙˆØµÙŠÙ„
    const newStatus = `Approved âœ… (××©×œ×•×—: ${v.delivery})`;
    await updateStatus(row, orderId, newStatus);

    toast("âœ… ØªÙ… Ø¥Ø±Ø³Ø§Ù„ Ø§Ù„Ø·Ù„Ø¨ Ù„Ù„ØªØ¬Ù‡ÙŠØ²");
    setTimeout(sync, 600);
  }

  async function markDelivered(row, orderId){
    await updateStatus(row, orderId, "Delivered âœ…");
    toast("âœ… ØªÙ… Ø§Ù„ØªØ³Ù„ÙŠÙ… Ù„Ù„Ù…Ù†Ø¯ÙˆØ¨");
    setTimeout(sync, 600);
  }

  async function cancelOrder(row, orderId){
    await updateStatus(row, orderId, "Canceled âŒ");
    toast("âœ… ØªÙ… Ø§Ù„Ø¥Ù„ØºØ§Ø¡");
    setTimeout(sync, 600);
  }

  async function updateStatus(row, orderId, status){
    try{
      await fetch(`${SCRIPT_URL}?action=updateStatus&row=${encodeURIComponent(row)}&orderId=${encodeURIComponent(orderId)}&status=${encodeURIComponent(status)}&t=${Date.now()}`, { cache:"no-store" });
    }catch(e){
      toast("âš ï¸ ÙØ´Ù„ ØªØ­Ø¯ÙŠØ« Ø§Ù„Ø­Ø§Ù„Ø©");
    }
  }

  async function updateOrder(row, orderId, v){
    try{
      // Ù†Ø±Ø³Ù„ address=city ÙƒÙ…Ø§Ù† Ù„Ù„ØªÙˆØ§ÙÙ‚
      await fetch(`${SCRIPT_URL}?action=updateOrder&row=${encodeURIComponent(row)}&orderId=${encodeURIComponent(orderId)}`
        + `&name=${encodeURIComponent(v.name)}`
        + `&phone=${encodeURIComponent(v.phone)}`
        + `&city=${encodeURIComponent(v.city)}`
        + `&address=${encodeURIComponent(v.city)}`
        + `&offer=${encodeURIComponent(v.offer)}`
        + `&price=${encodeURIComponent(v.price)}`
        + `&notes=${encodeURIComponent(v.notes)}`
        + `&t=${Date.now()}`, { cache:"no-store" });
    }catch(e){
      toast("âš ï¸ ÙØ´Ù„ Ø­ÙØ¸ Ø§Ù„ØªØ¹Ø¯ÙŠÙ„");
    }
  }

  // ===== WhatsApp Buttons =====
  function toWA_(phone){
    let p = String(phone||"").replace(/\D/g,"");
    if (!p) return "";
    if (p.startsWith("00")) p = p.slice(2);
    if (p.startsWith("9720")) p = "972" + p.slice(4);
    if (p.startsWith("0") && p.length >= 9) p = "972" + p.slice(1);
    return p;
  }

  function detectLang_(name, offer, notes){
    const n = String(name||"");
    const o = String(offer||"").toLowerCase();
    const no = String(notes||"").toLowerCase();
    if (/[\u0590-\u05FF]/.test(n)) return "he";
    if (o.includes(" he") || o.endsWith("he") || no.includes("order_confirmation_he")) return "he";
    return "ar";
  }

  function confirmCustomer(row, orderId){
    const v = getVals(row);
    const phone = toWA_(v.phone);
    if(!phone){ toast("âŒ Ø±Ù‚Ù… ØºÙŠØ± ØµØ­ÙŠØ­"); return; }

    const lang = detectLang_(v.name, v.offer, v.notes);
    const price = String(v.price||"150").replace(/[^\d]/g,"") || "150";
    const addr = v.city || "-";
    const offer = v.offer || "-";
    const id = orderId || ("ROW-" + row);

    let msg = "";
    if(lang === "he"){
      msg =
`*MAD Parfumeur* âœ…
×©×œ×•× ${v.name} ğŸŒ¿
×”×–×× ×ª×š ×”×ª×§×‘×œ×” ×•× ×¨×©××” ××¦×œ× ×•.

ğŸ§¾ ×”×–×× ×”: ${offer}
ğŸ’° ×¡×”"×›: â‚ª${price}
ğŸ“ ×›×ª×•×‘×ª: ${addr}
ğŸ†” ××¡' ×”×–×× ×”: ${id}

×›×“×™ ×œ××©×¨ â€“ ×”×©×‘/×™: *×›×Ÿ*
×œ×‘×™×˜×•×œ â€“ ×”×©×‘/×™: *×œ×*
×©×™×¨×•×ª ×œ×§×•×—×•×ª: *${CUSTOMER_SERVICE}*`;
    } else {
      msg =
`*MAD Parfumeur* âœ…
Ø£Ù‡Ù„Ø§Ù‹ ${v.name} ğŸŒ¿
ØªÙ… Ø§Ø³ØªÙ„Ø§Ù… Ø·Ù„Ø¨Ùƒ ÙˆØªØ³Ø¬ÙŠÙ„Ù‡ Ù„Ø¯ÙŠÙ†Ø§.

ğŸ§¾ Ø§Ù„Ø·Ù„Ø¨: ${offer}
ğŸ’° Ø§Ù„Ø¥Ø¬Ù…Ø§Ù„ÙŠ: â‚ª${price}
ğŸ“ Ø§Ù„Ø¹Ù†ÙˆØ§Ù†: ${addr}
ğŸ†” Ø±Ù‚Ù… Ø§Ù„Ø·Ù„Ø¨: ${id}

Ù„Ù„ØªØ£ÙƒÙŠØ¯: Ø§ÙƒØªØ¨ *Ù†Ø¹Ù…*
Ù„Ù„Ø¥Ù„ØºØ§Ø¡: Ø§ÙƒØªØ¨ *Ù„Ø§*
Ø®Ø¯Ù…Ø© Ø§Ù„Ø¹Ù…Ù„Ø§Ø¡: *${CUSTOMER_SERVICE}*`;
    }
    window.open(`https://wa.me/${phone}?text=${encodeURIComponent(msg)}`, "_blank");
  }

  function openWA(row, orderId){
    const v = getVals(row);
    const phone = toWA_(v.phone);
    if(!phone){ toast("âŒ Ø±Ù‚Ù… ØºÙŠØ± ØµØ­ÙŠØ­"); return; }

    const msg =
`MAD âœ…
Ø§Ù„Ø§Ø³Ù…: ${v.name}
Ø§Ù„Ø·Ù„Ø¨: ${v.offer}
Ø§Ù„Ø³Ø¹Ø±: â‚ª${v.price}
Ø§Ù„Ø¹Ù†ÙˆØ§Ù†: ${v.city}
Ø±Ù‚Ù… Ø§Ù„Ø·Ù„Ø¨: ${orderId}`;
    window.open(`https://wa.me/${phone}?text=${encodeURIComponent(msg)}`, "_blank");
  }

  // ===== Add New Order =====
  function openAdd(){ document.getElementById("addWrap").style.display="flex"; }
  function closeAdd(){ document.getElementById("addWrap").style.display="none"; }

  async function addOrder(){
    const name = (document.getElementById("a_name").value||"").trim();
    const phone = (document.getElementById("a_phone").value||"").trim();
    const city = (document.getElementById("a_city").value||"").trim();
    const offer = (document.getElementById("a_offer").value||"").trim();
    const price = String(document.getElementById("a_price").value||"150").replace(/[^\d]/g,"") || "150";
    const notes = (document.getElementById("a_notes").value||"").trim();

    if(!name || !phone){
      toast("âŒ Ø§ÙƒØªØ¨ Ø§Ù„Ø§Ø³Ù… ÙˆØ§Ù„Ù‡Ø§ØªÙ");
      return;
    }

    // Ù†Ø±Ø³Ù„ POST Ù„Ù„Ù†Ø¸Ø§Ù… (ÙŠØ­ÙØ¸ ÙÙŠ Ø§Ù„Ø´ÙŠØª)
    // status Ø§ÙØªØ±Ø§Ø¶ÙŠ Processing... (Ø£Ùˆ Ø®Ù„ÙŠÙ‡Ø§ "New")
    const payload = {
      name, phone, address: city, offer,
      price,
      notes,
      status: "New âœ…",
      source: "Manager-App",
      payment: "Cash",
      process: "Direct",
      lang: detectLang_(name, offer, notes)
    };

    try{
      await fetch(SCRIPT_URL, {
        method:"POST",
        mode:"no-cors",
        headers:{ "Content-Type":"application/json" },
        body: JSON.stringify(payload)
      });
      toast("âœ… ØªÙ… Ø­ÙØ¸ Ø§Ù„Ø·Ù„Ø¨");
      closeAdd();
      // Ù…Ø³Ø­
      ["a_name","a_phone","a_city","a_offer","a_notes"].forEach(id=>document.getElementById(id).value="");
      document.getElementById("a_price").value="150";
      setTimeout(sync, 800);
    }catch(e){
      toast("âš ï¸ ÙØ´Ù„ Ø­ÙØ¸ Ø§Ù„Ø·Ù„Ø¨");
    }
  }

  // init
  sync();
  setInterval(sync, 20000);
</script>
</body>
</html>
