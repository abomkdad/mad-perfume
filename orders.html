<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no" />
  <title>MAD Manager - Ultra Simple</title>
  <link rel="icon" type="image/png" href="https://www.mad-parfumeur.com/assets/hero/logo.png">
  <style>
    :root{
      --bg:#071022; --card:#0d1a33; --line:#1e2b47;
      --text:#f8fafc; --muted:#9fb0c6;
      --primary:#2563eb; --success:#16a34a; --warn:#f59e0b; --danger:#ef4444;
      --shadow:0 12px 35px rgba(0,0,0,.45);
      --r:20px;
    }
    *{box-sizing:border-box}
    body{
      margin:0; font-family:system-ui,"Segoe UI",Tahoma,Arial;
      background:radial-gradient(1200px 600px at 20% 0%, rgba(37,99,235,.18), transparent 55%),
                 radial-gradient(1000px 700px at 80% 15%, rgba(245,158,11,.12), transparent 55%),
                 var(--bg);
      color:var(--text);
      display:flex; justify-content:center;
      padding-bottom:90px;
    }
    .app{width:100%; max-width:980px}
    .top{
      position:sticky; top:0; z-index:999;
      background:rgba(7,16,34,.92); backdrop-filter:blur(10px);
      border-bottom:1px solid var(--line);
      padding:14px;
    }
    .head{display:flex; gap:10px; align-items:center}
    .logo{
      width:44px; height:44px; border-radius:16px; overflow:hidden;
      border:1px solid var(--line); background:#0b1730; box-shadow:var(--shadow);
      flex:0 0 auto;
    }
    .logo img{width:100%; height:100%; object-fit:cover}
    .title{flex:1; line-height:1.1}
    .title b{display:block; font-size:18px}
    .title span{display:block; margin-top:4px; font-size:12px; font-weight:900; color:var(--muted)}
    .iconBtn{
      width:48px; height:48px; border-radius:16px;
      border:1px solid var(--line);
      background:#0b1730; color:var(--text);
      box-shadow:var(--shadow);
      cursor:pointer; font-size:18px; font-weight:1000;
    }
    .row{display:flex; gap:10px; margin-top:10px; flex-wrap:wrap}
    .search{
      flex:1; min-width:220px;
      border-radius:18px; border:1px solid var(--line);
      background:#071331; color:var(--text);
      padding:14px 14px; font-weight:1000;
      outline:none; box-shadow:var(--shadow);
      font-size:16px;
    }
    .btn{
      border:none; cursor:pointer;
      border-radius:18px; padding:14px 16px;
      font-weight:1000; font-size:16px; color:var(--text);
      box-shadow:var(--shadow);
      transition:.12s; user-select:none;
      display:flex; align-items:center; justify-content:center; gap:8px;
      white-space:nowrap;
    }
    .btn:active{transform:scale(.98)}
    .btnPrimary{background:var(--primary)}
    .btnSuccess{background:var(--success)}
    .btnWarn{background:var(--warn); color:#0b1020}
    .btnDanger{background:var(--danger)}
    .content{padding:14px}
    .sec{
      margin:16px 0 10px;
      display:flex; justify-content:space-between; align-items:center;
      padding-bottom:8px; border-bottom:1px solid var(--line);
      color:var(--muted); font-weight:1000;
    }
    .sec strong{color:var(--text); font-size:15px}
    .sec span{background:#0b1730; border:1px solid var(--line); padding:6px 10px; border-radius:999px; color:var(--text)}
    .grid{
      display:grid;
      grid-template-columns: 1.2fr 1fr 1fr;
      gap:10px;
      margin-top:12px;
    }
    @media (max-width: 900px){
      .grid{grid-template-columns:1fr}
    }
    .card{
      background:linear-gradient(180deg, rgba(13,26,51,.92), rgba(13,26,51,.78));
      border:1px solid var(--line);
      border-radius:var(--r);
      padding:14px;
      box-shadow:var(--shadow);
      margin-bottom:14px;
      position:relative;
      overflow:hidden;
    }
    .badge{
      position:absolute; top:12px; left:12px;
      font-size:11px; font-weight:1000;
      padding:6px 10px; border-radius:999px;
      border:1px solid var(--line);
      background:#0b1730; color:var(--text);
    }
    .badge.new{border-color:rgba(245,158,11,.4); background:rgba(245,158,11,.12); color:#fde68a}
    .badge.sent{border-color:rgba(37,99,235,.4); background:rgba(37,99,235,.12); color:#bfdbfe}
    .badge.ready{border-color:rgba(22,163,74,.45); background:rgba(22,163,74,.12); color:#bbf7d0}
    .idLine{
      display:flex; justify-content:flex-end;
      font-size:12px; color:var(--muted); font-weight:1000;
      margin-bottom:8px;
    }
    .bigBox{
      background:rgba(7,19,49,.75);
      border:1px solid var(--line);
      border-radius:18px;
      padding:12px;
      margin-top:10px;
    }
    .field{
      background:#ffffff;
      border-radius:16px;
      border:2px solid rgba(37,99,235,.22);
      padding:10px;
      color:#0b1020;
    }
    .field label{
      display:block; font-size:11px; font-weight:1000;
      margin-bottom:6px; color:#0b1020;
    }
    .field input,.field select,.field textarea{
      width:100%; border:none; outline:none; background:transparent;
      font-size:16px; font-weight:1000; color:#0b1020;
    }
    .field textarea{resize:vertical}
    .mini{
      margin-top:10px;
      display:flex; gap:10px; flex-wrap:wrap;
    }
    .mini .field{flex:1; min-width:180px}
    .actions{
      display:grid; grid-template-columns: repeat(4, 1fr);
      gap:10px; margin-top:12px;
    }
    @media (max-width: 900px){
      .actions{grid-template-columns:1fr 1fr}
    }
    .toast{
      position:fixed; top:-120px; left:50%;
      transform:translateX(-50%);
      background:var(--warn); color:#0b1020;
      font-weight:1000; padding:12px 16px; border-radius:999px;
      box-shadow:var(--shadow);
      transition:.5s; z-index:2000;
    }
    .toast.show{top:16px}
    .err{
      margin-top:10px;
      background:rgba(239,68,68,.15);
      border:1px solid rgba(239,68,68,.35);
      padding:10px; border-radius:16px;
      color:#fecaca; font-weight:1000;
    }

    /* Modal (Add New) */
    .modalWrap{
      position:fixed; inset:0;
      background:rgba(0,0,0,.55);
      display:none; align-items:center; justify-content:center;
      padding:16px; z-index:3000;
    }
    .modal{
      width:100%; max-width:720px;
      background:var(--card);
      border:1px solid var(--line);
      border-radius:24px;
      padding:14px;
      box-shadow:var(--shadow);
    }
    .modal h3{margin:0 0 10px 0; font-size:18px; font-weight:1000}
    .modalActions{display:grid; grid-template-columns:1fr 1fr; gap:10px; margin-top:12px}
  </style>
</head>
<body>
  <div class="toast" id="toast">ØªÙ… âœ…</div>

  <div class="app">
    <div class="top">
      <div class="head">
        <div class="logo"><img src="https://www.mad-parfumeur.com/assets/hero/logo.png" alt="MAD"></div>
        <div class="title">
          <b>Ù†Ø³Ø®Ø© Ø§Ù„Ù…Ø¯ÙŠØ± (ØªØ¹Ø¯ÙŠÙ„ Ù…Ø¨Ø§Ø´Ø± Ù„ÙƒÙ„ Ø·Ù„Ø¨)</b>
          <span>Ø¹Ø¯Ù‘Ù„ Ø£ÙŠ Ø®Ø§Ù†Ø© Ø«Ù… Ø§Ø¶ØºØ· (Ø­ÙØ¸) â€” Ø«Ù… (Ø¥Ø±Ø³Ø§Ù„ Ù„Ù„ØªØ¬Ù‡ÙŠØ²) / (Ø¥Ù„ØºØ§Ø¡) / (ØªØ³Ù„ÙŠÙ…)</span>
        </div>
        <button class="iconBtn" onclick="sync()" title="ØªØ­Ø¯ÙŠØ«">â†»</button>
      </div>

      <div class="row">
        <input id="q" class="search" placeholder="Ø¨Ø­Ø« Ø¨Ø§Ù„Ø§Ø³Ù…/Ø§Ù„Ù‡Ø§ØªÙ/Ø§Ù„Ø¹Ø±Ø¶..." oninput="render()">
        <button class="btn btnWarn" onclick="openAdd()">â• Ø·Ù„Ø¨ Ø¬Ø¯ÙŠØ¯</button>
      </div>
      <div id="errBox"></div>
    </div>

    <div class="content" id="list"></div>
  </div>

  <!-- Add Modal -->
  <div class="modalWrap" id="modalWrap" onclick="closeModal(event)">
    <div class="modal" onclick="event.stopPropagation()">
      <h3>â• Ø¥Ø¶Ø§ÙØ© Ø·Ù„Ø¨ Ø¬Ø¯ÙŠØ¯</h3>

      <div class="grid">
        <div class="field"><label>Ø§Ø³Ù… Ø§Ù„Ø²Ø¨ÙˆÙ†</label><input id="a_name"></div>
        <div class="field"><label>Ø§Ù„Ù‡Ø§ØªÙ</label><input id="a_phone"></div>
        <div class="field"><label>Ø§Ù„Ù…Ø¯ÙŠÙ†Ø© / Ø§Ù„Ø¹Ù†ÙˆØ§Ù†</label><input id="a_city"></div>

        <div class="field"><label>Ø§Ù„Ø·Ù„Ø¨ (C)</label><input id="a_offer"></div>
        <div class="field"><label>Ø§Ù„Ø³Ø¹Ø± â‚ª</label><input id="a_price" inputmode="numeric" value="150"></div>
        <div class="field">
          <label>Ø´Ø±ÙƒØ© ØªÙˆØµÙŠÙ„</label>
          <select id="a_delivery">
            <option value="">-- Ø§Ø®ØªØ± --</option>
            <option value="High Express">High Express</option>
            <option value="Marwah Delivery">Marwah Delivery</option>
            <option value="Lama Delivery">Lama Delivery</option>
            <option value="Areen Delivery">Areen Delivery</option>
          </select>
        </div>

        <div class="field" style="grid-column:1/-1"><label>Ù…Ù„Ø§Ø­Ø¸Ø§Øª</label><textarea id="a_notes" rows="3"></textarea></div>
      </div>

      <div class="modalActions">
        <button class="btn btnDanger" onclick="closeModal()">Ø¥ØºÙ„Ø§Ù‚</button>
        <button class="btn btnSuccess" onclick="saveAdd()">âœ… Ø­ÙØ¸ Ø§Ù„Ø·Ù„Ø¨</button>
      </div>
    </div>
  </div>

<script>
  const SCRIPT_URL = "https://script.google.com/macros/s/AKfycbxKQZk5SJZ2w5XENWzxRL5Vf5UPwW0OtTMsz3RV4i-Pp3swg2KVh_6FaSnDkacPR8Kd/exec";

  let all = [];

  function toast(msg){
    const t = document.getElementById("toast");
    t.textContent = msg;
    t.classList.add("show");
    setTimeout(()=>t.classList.remove("show"), 2200);
  }

  function isApproved(s){ s=String(s||""); return s.includes("Approved") || s.includes("×××•×©×¨"); }
  function isReady(s){ s=String(s||""); return s.includes("××•×›×Ÿ"); }
  function isDelivered(s){ s=String(s||""); return s.includes("Delivered"); }
  function isCanceled(s){ s=String(s||""); return s.includes("Canceled") || s.includes("âŒ"); }

  function parseDeliveryFromStatus(s){
    const m = String(s||"").match(/\(××©×œ×•×—:\s*(.*?)\)/);
    return m ? m[1] : "";
  }

  async function sync(){
    document.getElementById("errBox").innerHTML = "";
    try{
      const res = await fetch(`${SCRIPT_URL}?action=get&t=${Date.now()}`, { cache:"no-store" });
      const data = await res.json();

      if (!Array.isArray(data)) {
        document.getElementById("errBox").innerHTML =
          `<div class="err">âš ï¸ Ø®Ø·Ø£ Ù…Ù† Ø§Ù„Ø³ÙŠØ±ÙØ±: ${escapeHtml(JSON.stringify(data))}</div>`;
        all = [];
      } else {
        all = data;
      }

      render();
    }catch(e){
      document.getElementById("errBox").innerHTML = `<div class="err">âš ï¸ ÙØ´Ù„ Ø§ØªØµØ§Ù„: ${escapeHtml(String(e))}</div>`;
      all = [];
      render();
    }
  }

  function render(){
    const q = (document.getElementById("q").value||"").toLowerCase();
    const rev = all.slice().reverse();

    const news = [];
    const sent = [];
    const ready = [];

    rev.forEach(o=>{
      const s = String(o.status||"");
      if (isDelivered(s) || isCanceled(s)) return;

      const match = String(o.name||"").toLowerCase().includes(q) ||
                    String(o.phone||"").includes(q) ||
                    String(o.offer||"").toLowerCase().includes(q);
      if (q && !match) return;

      if (isReady(s)) ready.push(o);
      else if (isApproved(s)) sent.push(o);
      else news.push(o);
    });

    let html = "";
    html += `<div class="sec"><strong>ğŸŸ  Ø·Ù„Ø¨Ø§Øª Ø¬Ø¯ÙŠØ¯Ø© (ØºÙŠØ± Ù…Ø¹ØªÙ…Ø¯Ø©)</strong><span>${news.length}</span></div>`;
    html += news.length ? news.map(o=>card(o,"new")).join("") : `<div class="card"><div style="text-align:center;color:var(--muted);font-weight:1000">Ù„Ø§ ÙŠÙˆØ¬Ø¯</div></div>`;

    html += `<div class="sec"><strong>ğŸ”µ ØªÙ… Ø¥Ø±Ø³Ø§Ù„Ù‡Ø§ Ù„Ù„ØªØ¬Ù‡ÙŠØ²</strong><span>${sent.length}</span></div>`;
    html += sent.length ? sent.map(o=>card(o,"sent")).join("") : `<div class="card"><div style="text-align:center;color:var(--muted);font-weight:1000">Ù„Ø§ ÙŠÙˆØ¬Ø¯</div></div>`;

    html += `<div class="sec"><strong>ğŸŸ¢ Ø¬Ø§Ù‡Ø² (ØªÙ… Ø§Ù„ØªØ¬Ù‡ÙŠØ²)</strong><span>${ready.length}</span></div>`;
    html += ready.length ? ready.map(o=>card(o,"ready")).join("") : `<div class="card"><div style="text-align:center;color:var(--muted);font-weight:1000">Ù„Ø§ ÙŠÙˆØ¬Ø¯</div></div>`;

    document.getElementById("list").innerHTML = html;
  }

  function card(o, type){
    const row = o.rowIndex;
    const oid = o.orderId || "";
    const s = String(o.status||"");
    const del = parseDeliveryFromStatus(s);
    const price = String(o.price||"").replace(/[^\d]/g,"") || "150";

    const badge =
      type==="new" ? `<div class="badge new">Ø¬Ø¯ÙŠØ¯</div>` :
      type==="sent" ? `<div class="badge sent">Ø£ÙØ±Ø³Ù„ Ù„Ù„ØªØ¬Ù‡ÙŠØ²</div>` :
      `<div class="badge ready">Ø¬Ø§Ù‡Ø²</div>`;

    const statusSelectDisabled = (type==="ready") ? "disabled" : "";
    const currentStage =
      (type==="ready") ? "READY" : (type==="sent" ? "APPROVED" : "NEW");

    return `
      <div class="card" id="card_${row}">
        ${badge}
        <div class="idLine">Ø±Ù‚Ù… Ø§Ù„Ø·Ù„Ø¨: <span style="color:var(--text);margin-right:6px">${escapeHtml(oid || ("ROW-"+row))}</span></div>

        <div class="grid">
          <div class="field">
            <label>Ø§Ø³Ù… Ø§Ù„Ø²Ø¨ÙˆÙ†</label>
            <input id="f_name_${row}" value="${escAttr(o.name||"")}">
          </div>
          <div class="field">
            <label>Ø§Ù„Ù‡Ø§ØªÙ</label>
            <input id="f_phone_${row}" value="${escAttr(o.phone||"")}">
          </div>
          <div class="field">
            <label>Ø§Ù„Ù…Ø¯ÙŠÙ†Ø© / Ø§Ù„Ø¹Ù†ÙˆØ§Ù†</label>
            <input id="f_city_${row}" value="${escAttr(o.city||"")}">
          </div>

          <div class="field" style="grid-column:1/-1">
            <label>Ø§Ù„Ø·Ù„Ø¨ (C)</label>
            <input id="f_offer_${row}" value="${escAttr(o.offer||"")}">
          </div>

          <div class="field">
            <label>Ø§Ù„Ø³Ø¹Ø± â‚ª</label>
            <input id="f_price_${row}" inputmode="numeric" value="${escAttr(price)}">
          </div>

          <div class="field">
            <label>Ø´Ø±ÙƒØ© Ø§Ù„ØªÙˆØµÙŠÙ„</label>
            <select id="f_delivery_${row}">
              <option value="">-- Ø§Ø®ØªØ± --</option>
              <option value="High Express" ${del==="High Express"?"selected":""}>High Express</option>
              <option value="Marwah Delivery" ${del==="Marwah Delivery"?"selected":""}>Marwah Delivery</option>
              <option value="Lama Delivery" ${del==="Lama Delivery"?"selected":""}>Lama Delivery</option>
              <option value="Areen Delivery" ${del==="Areen Delivery"?"selected":""}>Areen Delivery</option>
            </select>
          </div>

          <div class="field">
            <label>Ø§Ù„Ø­Ø§Ù„Ø© (Ù„Ù„Ø¹Ø±Ø¶ ÙÙ‚Ø· / ØªØ¹Ø¯ÙŠÙ„Ù‡Ø§ Ø¹Ø¨Ø± Ø§Ù„Ø£Ø²Ø±Ø§Ø±)</label>
            <select id="f_stage_${row}" ${statusSelectDisabled}>
              <option value="NEW" ${currentStage==="NEW"?"selected":""}>Ø¬Ø¯ÙŠØ¯ / Ù‚ÙŠØ¯ Ø§Ù„Ù…Ø¹Ø§Ù„Ø¬Ø©</option>
              <option value="APPROVED" ${currentStage==="APPROVED"?"selected":""}>Ø£Ø±Ø³Ù„ Ù„Ù„ØªØ¬Ù‡ÙŠØ²</option>
              <option value="READY" ${currentStage==="READY"?"selected":""} disabled>Ø¬Ø§Ù‡Ø² (Ø§Ù„Ù…ÙˆØ¸Ù ÙŠØ­Ø¯Ø¯Ù‡Ø§)</option>
              <option value="DELIVERED" ${isDelivered(s)?"selected":""}>ØªÙ… ØªØ³Ù„ÙŠÙ… Ù„Ù„Ù…Ù†Ø¯ÙˆØ¨</option>
              <option value="CANCELED" ${isCanceled(s)?"selected":""}>Ù…Ù„ØºÙŠ</option>
            </select>
          </div>

          <div class="field" style="grid-column:1/-1">
            <label>Ù…Ù„Ø§Ø­Ø¸Ø§Øª</label>
            <textarea id="f_notes_${row}" rows="3">${escapeHtml(o.notes||"")}</textarea>
          </div>
        </div>

        <div class="actions">
          <button class="btn btnPrimary" onclick="saveRow(${row}, '${escAttr(oid)}', '${type}')">ğŸ’¾ Ø­ÙØ¸ Ø§Ù„ØªØ¹Ø¯ÙŠÙ„</button>

          ${type!=="ready"
            ? `<button class="btn btnSuccess" onclick="sendToPrep(${row}, '${escAttr(oid)}')">âœ… Ø¥Ø±Ø³Ø§Ù„ Ù„Ù„ØªØ¬Ù‡ÙŠØ²</button>`
            : `<button class="btn btnWarn" onclick="markDelivered(${row}, '${escAttr(oid)}')">âœ… ØªØ³Ù„ÙŠÙ… Ù„Ù„Ù…Ù†Ø¯ÙˆØ¨</button>`
          }

          <button class="btn btnDanger" onclick="cancelOrder(${row}, '${escAttr(oid)}')">âŒ Ø¥Ù„ØºØ§Ø¡</button>

          <button class="btn btnWarn" onclick="forceRefresh()">â†» ØªØ­Ø¯ÙŠØ«</button>
        </div>

        ${type==="sent" ? `<div class="bigBox" style="margin-top:12px;font-weight:1000;color:#bfdbfe">âœ… Ø§Ù„Ù…Ø¯ÙŠØ±: ØªÙ… Ø¥Ø±Ø³Ø§Ù„ Ù‡Ø°Ø§ Ø§Ù„Ø·Ù„Ø¨ Ù„Ù„ØªØ¬Ù‡ÙŠØ²</div>` : ""}
        ${type==="ready" ? `<div class="bigBox" style="margin-top:12px;font-weight:1000;color:#bbf7d0">âœ… Ø¬Ø§Ù‡Ø² â€” Ø§Ù„Ù…ÙˆØ¸Ù Ø£Ù†Ù‡Ù‰ Ø§Ù„ØªØ¬Ù‡ÙŠØ²</div>` : ""}
      </div>
    `;
  }

  function getRowValues(row){
    const name = (document.getElementById(`f_name_${row}`).value||"").trim();
    const phone = (document.getElementById(`f_phone_${row}`).value||"").trim();
    const city = (document.getElementById(`f_city_${row}`).value||"").trim();
    const offer = (document.getElementById(`f_offer_${row}`).value||"").trim();
    const price = String(document.getElementById(`f_price_${row}`).value||"150").replace(/[^\d]/g,"") || "150";
    const notes = (document.getElementById(`f_notes_${row}`).value||"").trim();
    const delivery = (document.getElementById(`f_delivery_${row}`).value||"").trim();
    return { name, phone, city, offer, price, notes, delivery };
  }

  async function saveRow(row, orderId, type){
    const v = getRowValues(row);
    if(!v.name || !v.phone || !v.offer){
      toast("âŒ Ù„Ø§Ø²Ù… Ø§Ù„Ø§Ø³Ù… + Ø§Ù„Ù‡Ø§ØªÙ + Ø§Ù„Ø·Ù„Ø¨");
      return;
    }

    try{
      await fetch(`${SCRIPT_URL}?action=updateOrder&row=${encodeURIComponent(row)}&orderId=${encodeURIComponent(orderId)}`
        + `&name=${encodeURIComponent(v.name)}&phone=${encodeURIComponent(v.phone)}&city=${encodeURIComponent(v.city)}`
        + `&offer=${encodeURIComponent(v.offer)}&price=${encodeURIComponent(v.price)}&notes=${encodeURIComponent(v.notes)}`
        + `&address=${encodeURIComponent(v.city)}&t=${Date.now()}`, { cache:"no-store" });

      toast("âœ… ØªÙ… Ø­ÙØ¸ Ø§Ù„ØªØ¹Ø¯ÙŠÙ„");
      setTimeout(sync, 400);
    }catch(e){
      toast("âš ï¸ ÙØ´Ù„ Ø§Ù„Ø­ÙØ¸ (Ø§ÙØ­Øµ Ø§Ù„Ø³ÙƒØ±Ø¨Øª)");
    }
  }

  async function sendToPrep(row, orderId){
    const v = getRowValues(row);
    if(!v.delivery){
      toast("âŒ Ø§Ø®ØªØ± Ø´Ø±ÙƒØ© ØªÙˆØµÙŠÙ„");
      return;
    }

    // Ø§Ø­ÙØ¸ Ø§Ù„ØªØ¹Ø¯ÙŠÙ„ Ø£ÙˆÙ„Ø§Ù‹
    await saveRow(row, orderId, "new");

    const status = `Approved âœ… (××©×œ×•×—: ${v.delivery})`;
    await updateStatus(row, orderId, status);
    toast("âœ… ØªÙ… Ø¥Ø±Ø³Ø§Ù„ Ù„Ù„ØªØ¬Ù‡ÙŠØ²");
    setTimeout(sync, 400);
  }

  async function cancelOrder(row, orderId){
    await updateStatus(row, orderId, "Canceled âŒ");
    toast("âœ… ØªÙ… Ø§Ù„Ø¥Ù„ØºØ§Ø¡");
    setTimeout(sync, 400);
  }

  async function markDelivered(row, orderId){
    await updateStatus(row, orderId, "Delivered âœ…");
    toast("âœ… ØªÙ… Ø§Ù„ØªØ³Ù„ÙŠÙ… Ù„Ù„Ù…Ù†Ø¯ÙˆØ¨");
    setTimeout(sync, 400);
  }

  async function updateStatus(row, orderId, status){
    try{
      await fetch(`${SCRIPT_URL}?action=updateStatus&row=${encodeURIComponent(row)}&orderId=${encodeURIComponent(orderId)}&status=${encodeURIComponent(status)}&t=${Date.now()}`, { cache:"no-store" });
    }catch(e){
      toast("âš ï¸ ÙØ´Ù„ ØªØ­Ø¯ÙŠØ« Ø§Ù„Ø­Ø§Ù„Ø©");
    }
  }

  function openAdd(){
    document.getElementById("a_name").value = "";
    document.getElementById("a_phone").value = "";
    document.getElementById("a_city").value = "";
    document.getElementById("a_offer").value = "";
    document.getElementById("a_price").value = "150";
    document.getElementById("a_delivery").value = "";
    document.getElementById("a_notes").value = "";
    document.getElementById("modalWrap").style.display = "flex";
  }
  function closeModal(){ document.getElementById("modalWrap").style.display = "none"; }

  async function saveAdd(){
    const name = (document.getElementById("a_name").value||"").trim();
    const phone = (document.getElementById("a_phone").value||"").trim();
    const city = (document.getElementById("a_city").value||"").trim() || "-";
    const offer = (document.getElementById("a_offer").value||"").trim();
    const price = String(document.getElementById("a_price").value||"150").replace(/[^\d]/g,"") || "150";
    const notes = (document.getElementById("a_notes").value||"").trim();
    const delivery = (document.getElementById("a_delivery").value||"").trim();

    if(!name || !phone || !offer){
      toast("âŒ Ù„Ø§Ø²Ù… Ø§Ù„Ø§Ø³Ù… + Ø§Ù„Ù‡Ø§ØªÙ + Ø§Ù„Ø·Ù„Ø¨");
      return;
    }

    const payload = {
      name, phone,
      address: city,
      offer,
      price,
      notes,
      source: "Manager Manual",
      lang: "ar",
      payment: "Cash",
      process: "Direct",
      status: "Processing..."
    };

    // Ø§Ø­ÙØ¸
    fetch(SCRIPT_URL, { method:"POST", mode:"no-cors", body: JSON.stringify(payload) });

    // Ø¥Ø°Ø§ Ø§Ø®ØªØ§Ø± ØªÙˆØµÙŠÙ„ØŒ Ø§Ø¹ØªÙ…Ø¯Ù‡ Ù…Ø¨Ø§Ø´Ø±Ø© Ø¨Ø¹Ø¯ Ù…Ø§ ÙŠÙ†Ø­ÙØ¸ Ø¨Ø§Ù„Ø³Ø¬Ù„ (Ø³Ù‡Ù„)
    closeModal();
    toast("âœ… ØªÙ… Ø­ÙØ¸ Ø§Ù„Ø·Ù„Ø¨");

    setTimeout(sync, 800);

    // Ù…Ù„Ø§Ø­Ø¸Ø©: Ø§Ù„Ø§Ø¹ØªÙ…Ø§Ø¯ Ø§Ù„Ù…Ø¨Ø§Ø´Ø± ÙŠØªØ·Ù„Ø¨ orderId Ù…Ø¹Ø±ÙˆÙ â€” Ù‡Ù†Ø§ ØªØ±ÙƒÙ†Ø§Ù‡ ÙŠØ¯ÙˆÙŠ Ù…Ù† Ø§Ù„Ù…Ø¯ÙŠØ± Ø¯Ø§Ø®Ù„ Ø§Ù„Ø·Ù„Ø¨ Ø¨Ø¹Ø¯ Ø¸Ù‡ÙˆØ±Ù‡.
    // Ù„Ùˆ Ø¨Ø¯Ùƒ â€œÙŠØ­ÙØ¸ ÙˆÙŠØ¹ØªÙ…Ø¯ ÙÙˆØ±Ù‹Ø§â€ Ø¨Ù†Ø¶ÙŠÙ ØªÙˆÙ„ÙŠØ¯ orderId Ù…Ù† Ø§Ù„ÙˆØ§Ø¬Ù‡Ø© ÙˆÙ†Ø±Ø³Ù„Ù‡ Ù…Ø¹ POST.
  }

  function forceRefresh(){ sync(); }

  function escapeHtml(str){
    return String(str ?? "").replace(/[&<>"']/g, s => ({ "&":"&amp;","<":"&lt;",">":"&gt;",'"':"&quot;","'":"&#39;" }[s]));
  }
  function escAttr(str){
    return String(str ?? "").replace(/&/g,"&amp;").replace(/</g,"&lt;").replace(/>/g,"&gt;").replace(/"/g,"&quot;").replace(/'/g,"&#39;");
  }

  sync();
  setInterval(sync, 20000);
</script>
</body>
</html>
