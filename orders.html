<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
  <title>MAD Manager</title>
  <style>
    :root{
      --bg:#0b1220; --card:#111c33; --line:#22314f; --txt:#f3f6ff; --muted:#9fb0d0;
      --blue:#3b82f6; --green:#10b981; --yellow:#f59e0b; --red:#ef4444;
    }
    body{margin:0;background:var(--bg);color:var(--txt);font-family:system-ui,-apple-system,"Segoe UI",Tahoma,Arial; padding-bottom:90px;}
    .wrap{max-width:720px;margin:0 auto;padding:12px;}
    .top{position:sticky;top:0;background:rgba(11,18,32,.92);backdrop-filter:blur(10px);border-bottom:1px solid var(--line);z-index:5}
    .bar{display:flex;gap:8px;align-items:center;justify-content:space-between;padding:10px 0}
    .stats{display:flex;gap:8px;flex-wrap:wrap}
    .pill{background:var(--card);border:1px solid var(--line);border-radius:12px;padding:8px 10px;font-weight:800;font-size:12px}
    .pill b{color:var(--yellow)}
    .search{width:100%;padding:12px;border-radius:14px;border:1px solid var(--line);background:var(--card);color:var(--txt);outline:none;font-weight:700}
    .tabs{display:flex;gap:8px;margin:10px 0}
    .tab{flex:1;padding:12px;border-radius:14px;border:1px solid var(--line);background:var(--card);color:var(--txt);font-weight:900;cursor:pointer}
    .tab.active{outline:2px solid var(--blue)}
    .card{background:var(--card);border:1px solid var(--line);border-radius:18px;padding:14px;margin:12px 0}
    .row{display:flex;gap:10px;flex-wrap:wrap}
    label{font-size:12px;color:var(--muted);font-weight:800}
    input,select,textarea{
      width:100%;padding:10px;border-radius:12px;border:1px solid var(--line);
      background:#0b1630;color:var(--txt);outline:none;font-weight:800
    }
    textarea{min-height:70px;resize:vertical}
    .col{flex:1;min-width:180px}
    .title{display:flex;justify-content:space-between;align-items:center;gap:10px}
    .badge{font-size:12px;font-weight:900;padding:6px 10px;border-radius:999px;border:1px solid var(--line);background:#0b1630}
    .btns{display:grid;grid-template-columns:repeat(2,1fr);gap:10px;margin-top:10px}
    .btn{border:0;border-radius:14px;padding:12px;font-weight:1000;cursor:pointer}
    .b-save{background:var(--blue);color:white}
    .b-approve{background:var(--green);color:#062217}
    .b-confirm{background:var(--yellow);color:#1c1204}
    .b-cancel{background:var(--red);color:#2a0c0c}
    .b-delivered{background:#7c3aed;color:#f3e8ff}
    .hint{color:var(--muted);font-size:12px;font-weight:700;margin-top:6px}
    .fixednav{position:fixed;bottom:0;left:0;right:0;background:rgba(11,18,32,.92);backdrop-filter:blur(10px);border-top:1px solid var(--line)}
    .fixednav .wrap{display:flex;gap:10px}
    .big{flex:1;padding:14px;border-radius:16px;background:var(--blue);color:white;font-weight:1000;border:0;cursor:pointer}
    .ghost{flex:1;padding:14px;border-radius:16px;background:var(--card);color:var(--txt);font-weight:1000;border:1px solid var(--line);cursor:pointer}
    /* Login */
    .lock{
      position:fixed;inset:0;background:rgba(0,0,0,.65);display:flex;align-items:center;justify-content:center;z-index:999;
    }
    .lockbox{width:min(420px,92vw);background:var(--card);border:1px solid var(--line);border-radius:22px;padding:18px}
    .lockbox h2{margin:0 0 10px 0}
  </style>
</head>
<body>

<div id="lock" class="lock" style="display:none">
  <div class="lockbox">
    <h2>ğŸ”’ Ø¯Ø®ÙˆÙ„ Ø§Ù„Ù…Ø¯ÙŠØ±</h2>
    <div class="hint">Ø§ÙƒØªØ¨ ÙƒÙ„Ù…Ø© Ø§Ù„Ø³Ø± Ù„Ù„Ø¯Ø®ÙˆÙ„</div>
    <input id="pw" type="password" placeholder="ÙƒÙ„Ù…Ø© Ø§Ù„Ø³Ø±" />
    <div style="height:10px"></div>
    <button class="btn b-save" style="width:100%" onclick="login()">Ø¯Ø®ÙˆÙ„</button>
  </div>
</div>

<div class="top">
  <div class="wrap">
    <div class="bar">
      <div style="font-weight:1000;font-size:16px">MAD â€¢ Manager</div>
      <div class="stats">
        <div class="pill">Ø¬Ø¯ÙŠØ¯: <b id="cNew">0</b></div>
        <div class="pill">ØªØ¬Ù‡ÙŠØ²: <b id="cPrep">0</b></div>
        <div class="pill">Ø¬Ø§Ù‡Ø²: <b id="cReady">0</b></div>
      </div>
    </div>

    <input id="q" class="search" placeholder="Ø¨Ø­Ø« Ø¨Ø§Ù„Ø§Ø³Ù… Ø£Ùˆ Ø§Ù„ØªÙ„ÙÙˆÙ† Ø£Ùˆ Ø±Ù‚Ù… Ø§Ù„Ø·Ù„Ø¨..." oninput="render()" />

    <div class="tabs">
      <button class="tab active" id="t_new" onclick="setTab('new')">Ø·Ù„Ø¨Ø§Øª Ø¬Ø¯ÙŠØ¯Ø©</button>
      <button class="tab" id="t_prep" onclick="setTab('prep')">ØªÙ… Ø¥Ø±Ø³Ø§Ù„ Ù„Ù„ØªØ¬Ù‡ÙŠØ²</button>
      <button class="tab" id="t_ready" onclick="setTab('ready')">Ø¬Ø§Ù‡Ø²/ØªØ³Ù„ÙŠÙ…</button>
    </div>
  </div>
</div>

<div class="wrap" id="list"></div>

<div class="fixednav">
  <div class="wrap">
    <button class="big" onclick="sync()">ğŸ”„ ØªØ­Ø¯ÙŠØ«</button>
    <button class="ghost" onclick="logout()">Ø®Ø±ÙˆØ¬</button>
  </div>
</div>

<script>
  // âœ… Ø¶Ø¹ Ø±Ø§Ø¨Ø· Web App Ø§Ù„Ø®Ø§Øµ Ø¨Ø§Ù„Ù€ Apps Script
  const SCRIPT_URL = "PUT_YOUR_SCRIPT_WEBAPP_URL_HERE";
  const DASH_KEY = "12345678";

  let tab = "new";
  let orders = [];

  function showLock(){
    const ok = localStorage.getItem("mad_mgr_ok")==="1";
    document.getElementById("lock").style.display = ok ? "none" : "flex";
  }
  function login(){
    const v = document.getElementById("pw").value;
    if(v === DASH_KEY){
      localStorage.setItem("mad_mgr_ok","1");
      showLock();
      sync();
    }else{
      alert("ÙƒÙ„Ù…Ø© Ø§Ù„Ø³Ø± Ø®Ø·Ø£");
    }
  }
  function logout(){
    localStorage.removeItem("mad_mgr_ok");
    showLock();
  }

  function setTab(t){
    tab=t;
    document.querySelectorAll(".tab").forEach(x=>x.classList.remove("active"));
    document.getElementById("t_"+t).classList.add("active");
    render();
  }

  async function sync(){
    try{
      const res = await fetch(`${SCRIPT_URL}?action=get&t=${Date.now()}`);
      orders = await res.json();
      updateCounters();
      render();
    }catch(e){
      console.error(e);
      alert("Ù…Ø´ÙƒÙ„Ø© ÙÙŠ Ø¬Ù„Ø¨ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª");
    }
  }

  function isApproved(s){ s=String(s||""); return s.includes("Approved") || s.includes("×××•×©×¨") || s.includes("Sent to Prep"); }
  function isReady(s){ s=String(s||""); return s.includes("××•×›×Ÿ") || s.toLowerCase().includes("ready"); }
  function isDelivered(s){ s=String(s||""); return s.includes("Delivered"); }
  function isCanceled(s){ s=String(s||""); return s.toLowerCase().includes("canceled") || s.includes("Ø¥Ù„ØºØ§Ø¡"); }

  function updateCounters(){
    const a = orders || [];
    let n=0,p=0,r=0;
    a.forEach(o=>{
      const s=o.status||"";
      if(isDelivered(s) || isCanceled(s)) return;
      if(isReady(s)) r++;
      else if(isApproved(s)) p++;
      else n++;
    });
    document.getElementById("cNew").innerText=n;
    document.getElementById("cPrep").innerText=p;
    document.getElementById("cReady").innerText=r;
  }

  function render(){
    const q = (document.getElementById("q").value||"").toLowerCase().trim();
    let a = [...(orders||[])].reverse();

    // filter by tab
    a = a.filter(o=>{
      const s=o.status||"";
      if(isDelivered(s) || isCanceled(s)) return false;
      if(tab==="new") return !isApproved(s) && !isReady(s);
      if(tab==="prep") return isApproved(s) && !isReady(s);
      if(tab==="ready") return isReady(s);
      return true;
    });

    // search
    if(q){
      a = a.filter(o=>{
        return (String(o.name||"").toLowerCase().includes(q) ||
                String(o.phone||"").includes(q) ||
                String(o.orderId||"").toLowerCase().includes(q) ||
                String(o.offer||"").toLowerCase().includes(q));
      });
    }

    const list = document.getElementById("list");
    if(!a.length){
      list.innerHTML = `<div class="hint" style="text-align:center;padding:30px">Ù„Ø§ ØªÙˆØ¬Ø¯ Ø·Ù„Ø¨Ø§Øª Ù‡Ù†Ø§</div>`;
      return;
    }

    list.innerHTML = a.map(o=>card(o)).join("");
  }

  function detectLangByName(name){
    const s = String(name||"");
    const hasArabic = /[\u0600-\u06FF]/.test(s);
    return hasArabic ? "AR" : "HE";
  }

  function buildConfirmMsg(o){
    const lang = detectLangByName(o.name);
    const delivery = o.delivery || "";
    const addr = o.addr || o.city || "-";
    const price = o.price || "150";
    if(lang==="AR"){
      return `*Ø´ÙƒØ± Ø¯Ø§ÙØ¦ Ù…Ù† Ø§Ù„Ù‚Ù„Ø¨ - MAD SYSTEM* â¤ï¸\n\nØ£Ù‡Ù„Ø§Ù‹ Ø¨Ùƒ *${o.name}*ØŒ\nØªÙ… ØªØ£ÙƒÙŠØ¯ Ø·Ù„Ø¨Ùƒ âœ…\n\nğŸ“„ *Ø±Ù‚Ù… Ø§Ù„ÙØ§ØªÙˆØ±Ø©:* ${o.orderId}\nğŸ“¦ *Ø§Ù„Ù…Ù†ØªØ¬:* ${o.offer}\nğŸ“ *Ø§Ù„Ø¹Ù†ÙˆØ§Ù†:* ${addr}\nğŸšš *Ø´Ø±ÙƒØ© Ø§Ù„ØªÙˆØµÙŠÙ„:* ${delivery || "Ø³ÙŠØªÙ… ØªØ­Ø¯ÙŠØ¯Ù‡Ø§"}\nğŸ’° *Ø§Ù„Ù…Ø¨Ù„Øº Ø§Ù„Ø¥Ø¬Ù…Ø§Ù„ÙŠ:* â‚ª${price}.00\n\nØ´ÙƒØ±Ø§Ù‹ Ø¹Ù„Ù‰ Ø«Ù‚ØªÙƒ Ø¨Ù†Ø§ âœ¨\n*Ø®Ø¯Ù…Ø© Ø§Ù„Ø¹Ù…Ù„Ø§Ø¡: 9935*`;
    }
    return `*×ª×•×“×” ×¨×‘×” ××›×œ ×”×œ×‘ - MAD SYSTEM* â¤ï¸\n\n×©×œ×•× *${o.name}*,\n×”×”×–×× ×” ××•×©×¨×” âœ…\n\nğŸ“„ *××¡×¤×¨ ×”×–×× ×”:* ${o.orderId}\nğŸ“¦ *××•×¦×¨:* ${o.offer}\nğŸ“ *×›×ª×•×‘×ª:* ${addr}\nğŸšš *××©×œ×•×—:* ${delivery || "×™×™×§×‘×¢ ×‘×”××©×š"}\nğŸ’° *×¡×”×´×›:* â‚ª${price}.00\n\n×©×™×¨×•×ª ×œ×§×•×—×•×ª: *9935*`;
  }

  function waOpen(phone, msg){
    const p = String(phone||"").replace(/\D/g,"");
    let cp = p;
    if(cp.startsWith("0")) cp = "972"+cp.slice(1);
    window.open(`https://wa.me/${cp}?text=${encodeURIComponent(msg)}`,'_blank');
  }

  async function updateStatus(row, status){
    await fetch(`${SCRIPT_URL}?action=updateStatus&key=${encodeURIComponent(DASH_KEY)}&row=${encodeURIComponent(row)}&status=${encodeURIComponent(status)}&t=${Date.now()}`);
    await sync();
  }

  async function updateOrder(row, data){
    const params = new URLSearchParams();
    params.set("action","updateOrder");
    params.set("key",DASH_KEY);
    params.set("row",row);
    Object.keys(data).forEach(k=>params.set(k, data[k] ?? ""));
    await fetch(`${SCRIPT_URL}?${params.toString()}&t=${Date.now()}`);
    await sync();
  }

  function card(o){
    const s = o.status || "NEW";
    const delivery = o.delivery || "";
    const addr = o.addr || o.city || "";
    const price = o.price || "150";
    const pay = o.payment || "Cash";
    const proc = o.proc || "Direct";

    return `
      <div class="card">
        <div class="title">
          <div style="font-weight:1000;font-size:16px">${o.name || "-"}</div>
          <div class="badge">${s}</div>
        </div>
        <div class="hint">ğŸ†” ${o.orderId || ""} â€¢ ğŸ“ ${o.phone || ""}</div>

        <div class="row" style="margin-top:10px">
          <div class="col">
            <label>Ø§Ø³Ù…</label>
            <input id="n_${o.rowIndex}" value="${escapeHtml(o.name||"")}" />
          </div>
          <div class="col">
            <label>Ù‡Ø§ØªÙ</label>
            <input id="p_${o.rowIndex}" value="${escapeHtml(o.phone||"")}" />
          </div>
        </div>

        <div class="row">
          <div class="col">
            <label>Ø¹Ù†ÙˆØ§Ù† / Ù…Ø¯ÙŠÙ†Ø©</label>
            <input id="a_${o.rowIndex}" value="${escapeHtml(addr||"")}" />
          </div>
          <div class="col">
            <label>Ø³Ø¹Ø± (â‚ª)</label>
            <input id="pr_${o.rowIndex}" value="${escapeHtml(price)}" />
          </div>
        </div>

        <div class="row">
          <div class="col">
            <label>Ø§Ù„Ø¯ÙØ¹</label>
            <select id="pay_${o.rowIndex}">
              <option ${pay==="Cash"?"selected":""} value="Cash">Cash / Ù†Ù‚Ø¯</option>
              <option ${pay==="Paid"?"selected":""} value="Paid">Paid / Ù…Ø¯ÙÙˆØ¹</option>
              <option ${pay==="Card"?"selected":""} value="Card">Card / Ø¨Ø·Ø§Ù‚Ø©</option>
            </select>
          </div>
          <div class="col">
            <label>Ø§Ù„Ø¥Ø¬Ø±Ø§Ø¡</label>
            <select id="proc_${o.rowIndex}">
              <option ${proc==="Direct"?"selected":""} value="Direct">Direct</option>
              <option ${proc==="Call"?"selected":""} value="Call">Call</option>
            </select>
          </div>
        </div>

        <div class="row">
          <div class="col">
            <label>Ø´Ø±ÙƒØ© Ø§Ù„ØªÙˆØµÙŠÙ„</label>
            <select id="del_${o.rowIndex}">
              <option value="">-- Ø§Ø®ØªØ± --</option>
              <option ${delivery==="High Express"?"selected":""} value="High Express">High Express</option>
              <option ${delivery==="Marwah Delivery"?"selected":""} value="Marwah Delivery">Marwah Delivery</option>
              <option ${delivery==="Lama Delivery"?"selected":""} value="Lama Delivery">Lama Delivery</option>
              <option ${delivery==="Areen Delivery"?"selected":""} value="Areen Delivery">Areen Delivery</option>
            </select>
          </div>
          <div class="col">
            <label>Ø§Ù„Ø·Ù„Ø¨ (Ø§Ù„Ø¹Ø·ÙˆØ±)</label>
            <textarea id="o_${o.rowIndex}">${escapeHtml(o.offer||"")}</textarea>
          </div>
        </div>

        <div class="row">
          <div class="col">
            <label>Ù…Ù„Ø§Ø­Ø¸Ø§Øª Ø¥Ø¶Ø§ÙÙŠØ© (Ø§Ø®ØªÙŠØ§Ø±ÙŠ)</label>
            <textarea id="x_${o.rowIndex}"></textarea>
            <div class="hint">Ø§Ù„Ù…Ù„Ø§Ø­Ø¸Ø§Øª Ø§Ù„Ø­Ø§Ù„ÙŠØ© Ù…Ø­ÙÙˆØ¸Ø© Ø¨Ø§Ù„Ù†Ø¸Ø§Ù… â€” Ù‡Ù†Ø§ Ø§ÙƒØªØ¨ ÙÙ‚Ø· Ø§Ù„Ø¥Ø¶Ø§ÙØ©</div>
          </div>
        </div>

        <div class="btns">
          <button class="btn b-save" onclick="onSave(${o.rowIndex})">ğŸ’¾ Ø­ÙØ¸ Ø§Ù„ØªØ¹Ø¯ÙŠÙ„</button>
          <button class="btn b-approve" onclick="onApprove(${o.rowIndex})">âœ… Ø¥Ø±Ø³Ø§Ù„ Ù„Ù„ØªØ¬Ù‡ÙŠØ²</button>
          <button class="btn b-confirm" onclick="onConfirm(${o.rowIndex})">ğŸ’¬ ØªØ£ÙƒÙŠØ¯ Ù„Ù„Ø¹Ù…ÙŠÙ„</button>
          ${tab==="ready"
            ? `<button class="btn b-delivered" onclick="onDelivered(${o.rowIndex})">ğŸšš Delivered</button>`
            : `<button class="btn b-cancel" onclick="onCancel(${o.rowIndex})">âŒ Ø¥Ù„ØºØ§Ø¡</button>`
          }
        </div>
      </div>
    `;
  }

  async function onSave(row){
    const data = collectRow(row);
    await updateOrder(row, data);
  }

  async function onApprove(row){
    const data = collectRow(row);
    const delivery = data.delivery || document.getElementById("del_"+row).value || "";
    const st = `Approved âœ… (Sent to Prep)${delivery?` (××©×œ×•×—: ${delivery})`:``}`;
    await updateOrder(row, data);
    await updateStatus(row, st);
  }

  async function onDelivered(row){
    await updateStatus(row, "Delivered âœ…");
  }

  async function onCancel(row){
    await updateStatus(row, "Canceled âŒ");
  }

  function onConfirm(row){
    const o = orders.find(x=>x.rowIndex==row);
    if(!o) return;
    // refresh from current inputs
    const data = collectRow(row);
    const temp = {
      ...o,
      name: data.name,
      phone: data.phone,
      offer: data.offer,
      price: data.price,
      payment: data.payment,
      proc: data.proc,
      addr: data.addr,
      city: data.addr,
      delivery: data.delivery
    };
    const msg = buildConfirmMsg(temp);
    waOpen(temp.phone, msg);
  }

  function collectRow(row){
    return {
      name: document.getElementById("n_"+row).value,
      phone: document.getElementById("p_"+row).value,
      addr: document.getElementById("a_"+row).value,
      city: document.getElementById("a_"+row).value,
      price: document.getElementById("pr_"+row).value,
      payment: document.getElementById("pay_"+row).value,
      proc: document.getElementById("proc_"+row).value,
      delivery: document.getElementById("del_"+row).value,
      offer: document.getElementById("o_"+row).value,
      extraNotes: document.getElementById("x_"+row).value
    };
  }

  function escapeHtml(s){
    return String(s||"").replace(/[&<>"']/g, m => ({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'}[m]));
  }

  showLock();
  if(localStorage.getItem("mad_mgr_ok")==="1") sync();
</script>
</body>
</html>
