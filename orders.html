<!doctype html>
<html lang="ar" dir="rtl">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width,initial-scale=1"/>
  <title>MAD Manager</title>
  <style>
    body{margin:0;font-family:system-ui,Segoe UI,Tahoma,Arial;background:#070b16;color:#fff}
    .top{position:sticky;top:0;background:rgba(7,11,22,.92);backdrop-filter:blur(10px);padding:14px;border-bottom:1px solid rgba(255,255,255,.08);z-index:10}
    .wrap{max-width:980px;margin:0 auto;padding:16px}
    .row{display:flex;gap:10px;flex-wrap:wrap;align-items:center}
    input,select,textarea,button{
      font:inherit;border-radius:14px;border:1px solid rgba(255,255,255,.14);
      background:rgba(255,255,255,.06);color:#fff;padding:12px 12px;outline:none
    }
    textarea{min-height:70px;resize:vertical}
    button{cursor:pointer;border:none}
    .btn{padding:12px 14px;border-radius:14px;font-weight:800}
    .bblue{background:#2563eb}
    .bgreen{background:#16a34a}
    .bred{background:#dc2626}
    .borange{background:#f59e0b;color:#111}
    .bgray{background:rgba(255,255,255,.12)}
    .card{
      background:linear-gradient(180deg,rgba(255,255,255,.08),rgba(255,255,255,.04));
      border:1px solid rgba(255,255,255,.10);
      border-radius:18px;padding:14px;margin:14px 0;
      box-shadow:0 12px 40px rgba(0,0,0,.35)
    }
    .h{display:flex;justify-content:space-between;gap:10px;flex-wrap:wrap;align-items:center;margin-bottom:10px}
    .tag{padding:6px 10px;border-radius:999px;background:rgba(255,255,255,.10);font-weight:800}
    .grid{display:grid;grid-template-columns:1fr 1fr;gap:10px}
    @media(max-width:760px){.grid{grid-template-columns:1fr}}
    .muted{opacity:.75}
    .big{font-size:18px;font-weight:900}
    .sep{height:1px;background:rgba(255,255,255,.10);margin:12px 0}
  </style>
</head>
<body>
  <div class="top">
    <div class="wrap">
      <div class="row">
        <div style="font-weight:900;font-size:18px">Ù†Ø³Ø®Ø© Ø§Ù„Ù…Ø¯ÙŠØ± (ØªØ¹Ø¯ÙŠÙ„ ÙƒØ§Ù…Ù„)</div>
        <span class="tag" id="stat">...</span>
        <button class="btn bgray" onclick="load()">ØªØ­Ø¯ÙŠØ« â†»</button>
        <select id="filter" onchange="render()">
          <option value="NEW">Ø·Ù„Ø¨Ø§Øª Ø¬Ø¯ÙŠØ¯Ø© (NEW)</option>
          <option value="APPROVED">ØªÙ… Ø¥Ø±Ø³Ø§Ù„ Ù„Ù„ØªØ¬Ù‡ÙŠØ²</option>
          <option value="READY">ØªÙ… ØªØ¬Ù‡ÙŠØ²</option>
          <option value="ALL">ÙƒÙ„ Ø§Ù„Ø·Ù„Ø¨Ø§Øª</option>
        </select>
      </div>
      <div class="row" style="margin-top:10px">
        <input id="q" placeholder="Ø¨Ø­Ø«: Ø§Ø³Ù… / Ø±Ù‚Ù… / OrderId" style="flex:1;min-width:240px" oninput="render()"/>
      </div>
    </div>
  </div>

  <div class="wrap" id="list"></div>

<script>
  // ==== EDIT THESE ONLY ====
  const SCRIPT_URL = "https://script.google.com/macros/s/AKfycbyLjLFa8AaH82Ip7m747WC-KSUUEaU_M70S0I9Mda14XbnmcuEfZ7pBnF_zzJYZuXmZ/exec";
  const DASH_KEY   = "12345678";
  // ========================

  let orders = [];
  let authed = false;

  (function(){
    const pass = prompt("ÙƒÙ„Ù…Ø© Ø§Ù„Ø³Ø±:");
    if(pass !== DASH_KEY){ document.body.innerHTML = "<div style='padding:30px;font-size:20px'>âŒ ÙƒÙ„Ù…Ø© Ø§Ù„Ø³Ø± ØºÙ„Ø·</div>"; return; }
    authed = true;
    load();
  })();

  async function load(){
    if(!authed) return;
    document.getElementById("stat").textContent = "ØªØ­Ù…ÙŠÙ„...";
    const res = await fetch(`${SCRIPT_URL}?action=get`);
    orders = await res.json();
    document.getElementById("stat").textContent = `Ø¹Ø¯Ø¯: ${orders.length}`;
    render();
  }

  function matchFilter(o){
    const f = document.getElementById("filter").value;
    const st = String(o.status||"");
    if(f==="ALL") return true;
    if(f==="NEW") return st.trim().toUpperCase().startsWith("NEW");
    if(f==="APPROVED") return st.includes("Approved") || st.includes("Ø§Ù„ØªØ¬Ù‡ÙŠØ²") || st.includes("Prep");
    if(f==="READY") return st.includes("READY") || st.includes("Ù…Ø¬Ù‡Ø²") || st.includes("××•×›×Ÿ");
    return true;
  }

  function render(){
    const q = document.getElementById("q").value.trim().toLowerCase();
    const list = document.getElementById("list");
    const items = orders
      .filter(matchFilter)
      .filter(o=>{
        if(!q) return true;
        return `${o.orderId} ${o.name} ${o.phone} ${o.offer} ${o.notes}`.toLowerCase().includes(q);
      })
      .sort((a,b)=> (b.rowIndex||0)-(a.rowIndex||0));

    list.innerHTML = items.map(o => cardHtml(o)).join("");
  }

  function esc(s){ return String(s||"").replace(/[&<>"']/g,m=>({ "&":"&amp;","<":"&lt;",">":"&gt;",'"':"&quot;","'":"&#39;" }[m])); }

  function cardHtml(o){
    const price = o.price || "";
    const pay = o.payment || "";
    const proc = o.proc || "";
    const addr = o.addr || "";
    const delivery = o.delivery || "";
    const isInbox = (String(o.offer||"").toLowerCase().includes("whatsapp"));

    return `
    <div class="card" id="c${o.rowIndex}">
      <div class="h">
        <div class="big">ğŸ§¾ ${esc(o.orderId)} <span class="muted">#${o.rowIndex}</span></div>
        <div class="tag">${esc(o.status||"")}</div>
      </div>

      <div class="grid">
        <div>
          <div class="muted">Ø§Ø³Ù… Ø§Ù„Ø²Ø¨ÙˆÙ†</div>
          <input id="name${o.rowIndex}" value="${esc(o.name)}" style="width:100%"/>
        </div>
        <div>
          <div class="muted">Ø§Ù„Ù‡Ø§ØªÙ</div>
          <input id="phone${o.rowIndex}" value="${esc(o.phone)}" style="width:100%"/>
        </div>

        <div>
          <div class="muted">Ø§Ù„Ù…Ø¯ÙŠÙ†Ø© / Ø§Ù„Ø¹Ù†ÙˆØ§Ù†</div>
          <input id="city${o.rowIndex}" value="${esc(o.city)}" style="width:100%"/>
        </div>
        <div>
          <div class="muted">Ø§Ù„Ø¹Ù†ÙˆØ§Ù† Ø§Ù„ØªÙØµÙŠÙ„ÙŠ (Ø¯Ø§Ø®Ù„ Ø§Ù„Ù…Ù„Ø§Ø­Ø¸Ø§Øª)</div>
          <input id="addr${o.rowIndex}" value="${esc(addr)}" style="width:100%"/>
        </div>

        <div>
          <div class="muted">Ø§Ù„Ø·Ù„Ø¨ (C)</div>
          <input id="offer${o.rowIndex}" value="${esc(o.offer)}" style="width:100%"/>
        </div>
        <div>
          <div class="muted">Ø§Ù„Ø³Ø¹Ø± â‚ª</div>
          <input id="price${o.rowIndex}" value="${esc(price)}" style="width:100%"/>
        </div>

        <div>
          <div class="muted">Ø·Ø±ÙŠÙ‚Ø© Ø§Ù„Ø¯ÙØ¹</div>
          <select id="pay${o.rowIndex}" style="width:100%">
            ${opt(pay,"Cash","Cash")}
            ${opt(pay,"Paid","Paid")}
            ${opt(pay,"Card","Card")}
          </select>
        </div>
        <div>
          <div class="muted">Ø§Ù„Ø¥Ø¬Ø±Ø§Ø¡</div>
          <select id="proc${o.rowIndex}" style="width:100%">
            ${opt(proc,"Direct","Direct")}
            ${opt(proc,"Call","Call")}
            ${opt(proc,"No-Call","No-Call")}
          </select>
        </div>

        <div>
          <div class="muted">Ø´Ø±ÙƒØ© Ø§Ù„ØªÙˆØµÙŠÙ„</div>
          <select id="del${o.rowIndex}" style="width:100%">
            ${opt(delivery,"High Express","High Express")}
            ${opt(delivery,"Marwah Delivery","Marwah Delivery")}
            ${opt(delivery,"Lama Delivery","Lama Delivery")}
            ${opt(delivery,"Areen Delivery","Areen Delivery")}
            ${opt(delivery,"","â€”")}
          </select>
        </div>

        <div>
          <div class="muted">Ø§Ù„Ø­Ø§Ù„Ø©</div>
          <select id="status${o.rowIndex}" style="width:100%">
            ${opt(o.status,"NEW","NEW")}
            ${opt(o.status,"Approved âœ… (Sent to Prep)","Approved âœ… (Sent to Prep)")}
            ${opt(o.status,"READY âœ… (Ù…Ø¬Ù‡Ø²)","READY âœ… (Ù…Ø¬Ù‡Ø²)")}
            ${opt(o.status,"CANCELLED âŒ","CANCELLED âŒ")}
          </select>
        </div>
      </div>

      <div class="sep"></div>

      <div class="muted">Ù…Ù„Ø§Ø­Ø¸Ø§Øª (G)</div>
      <textarea id="notes${o.rowIndex}" style="width:100%">${esc(o.notes||"")}</textarea>

      <div class="row" style="margin-top:12px">
        <button class="btn bblue" onclick="saveOrder(${o.rowIndex})">ğŸ’¾ Ø­ÙØ¸ Ø§Ù„ØªØ¹Ø¯ÙŠÙ„</button>
        <button class="btn bgreen" onclick="sendToPrep(${o.rowIndex})">âœ… Ø¥Ø±Ø³Ø§Ù„ Ù„Ù„ØªØ¬Ù‡ÙŠØ²</button>
        <button class="btn bgray" onclick="confirmCustomer(${o.rowIndex})">ğŸ“© ØªØ£ÙƒÙŠØ¯ Ù„Ù„Ø¹Ù…ÙŠÙ„</button>
        <button class="btn bred" onclick="setStatus(${o.rowIndex}, 'CANCELLED âŒ')">âœ– Ø¥Ù„ØºØ§Ø¡</button>
        ${isInbox ? `<button class="btn borange" onclick="alert('Ù‡Ø°Ø§ Inbox (ÙˆØ§ØªØ³Ø§Ø¨/PDF). Ø¹Ø¯Ù„ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ø«Ù… Ø§Ø¶ØºØ· Ø¥Ø±Ø³Ø§Ù„ Ù„Ù„ØªØ¬Ù‡ÙŠØ² âœ…')">âš  Inbox</button>` : ``}
      </div>

      <div class="muted" style="margin-top:10px">
        *Ù…Ù„Ø§Ø­Ø¸Ø©:* Ø§Ù„Ø³Ø¹Ø± ÙŠØ¸Ù‡Ø± ÙÙŠ (C) Ø¨Ø¹Ø¯ Ø§Ù„Ø·Ù„Ø¨ + Ø£ÙŠØ¶Ø§Ù‹ Ø¯Ø§Ø®Ù„ Ø§Ù„Ù…Ù„Ø§Ø­Ø¸Ø§Øª (G).
      </div>
    </div>`;
  }

  function opt(current, value, label){
    const c = String(current||"");
    const sel = (c===value) ? "selected" : "";
    return `<option value="${value}" ${sel}>${label}</option>`;
  }

  async function saveOrder(row){
    const payload = getForm(row);
    const url = `${SCRIPT_URL}?action=updateOrder&key=${encodeURIComponent(DASH_KEY)}&row=${row}` +
      `&name=${enc(payload.name)}&phone=${enc(payload.phone)}&city=${enc(payload.city)}` +
      `&offer=${enc(payload.offer)}&price=${enc(payload.price)}&payment=${enc(payload.payment)}` +
      `&proc=${enc(payload.proc)}&addr=${enc(payload.addr)}&extraNotes=${enc(payload.notes)}`;

    await fetch(url);
    await setStatus(row, payload.status, false);
    await load();
    jump(row);
  }

  async function sendToPrep(row){
    // Ø§ÙˆÙ„Ø§Ù‹ Ø­ÙØ¸ ÙƒÙ„ Ø´ÙŠØ¡
    await saveOrder(row);
    await setStatus(row, "Approved âœ… (Sent to Prep)");
    await load();
    jump(row);
  }

  async function confirmCustomer(row){
    const url = `${SCRIPT_URL}?action=sendConfirm&key=${encodeURIComponent(DASH_KEY)}&row=${row}`;
    const r = await (await fetch(url)).json();
    alert(r.result==="SUCCESS" ? "âœ… ØªÙ… Ø¥Ø±Ø³Ø§Ù„ Ø§Ù„ØªØ£ÙƒÙŠØ¯ Ù„Ù„Ø¹Ù…ÙŠÙ„" : ("âŒ ÙØ´Ù„: " + r.message));
    await load();
    jump(row);
  }

  async function setStatus(row, status, reload=true){
    const url = `${SCRIPT_URL}?action=updateStatus&key=${encodeURIComponent(DASH_KEY)}&row=${row}&status=${enc(status)}`;
    await fetch(url);
    if(reload) await load();
    jump(row);
  }

  function getForm(row){
    return {
      name:  val(`name${row}`),
      phone: val(`phone${row}`),
      city:  val(`city${row}`),
      addr:  val(`addr${row}`),
      offer: val(`offer${row}`),
      price: val(`price${row}`),
      payment: val(`pay${row}`),
      proc: val(`proc${row}`),
      status: val(`status${row}`),
      notes: val(`notes${row}`),
      delivery: val(`del${row}`)
    };
  }
  function val(id){ const el=document.getElementById(id); return el? el.value : ""; }
  function enc(s){ return encodeURIComponent(String(s||"")); }
  function jump(row){ const el=document.getElementById("c"+row); if(el) el.scrollIntoView({behavior:"smooth",block:"start"}); }
</script>
</body>
</html>
