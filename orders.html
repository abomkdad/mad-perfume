<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no" />
  <title>MAD Manager - Simple</title>
  <link rel="icon" type="image/png" href="https://www.mad-parfumeur.com/assets/hero/logo.png">
  <style>
    :root{
      --bg:#0b1220; --card:#111c33; --line:#22304d; --text:#f8fafc; --muted:#9fb0c6;
      --primary:#2563eb; --success:#16a34a; --warn:#d97706; --danger:#b91c1c;
      --shadow:0 10px 30px rgba(0,0,0,.35); --r:18px;
    }
    *{box-sizing:border-box}
    body{margin:0;font-family:system-ui,Segoe UI,Arial;background:var(--bg);color:var(--text);display:flex;justify-content:center;padding-bottom:80px}
    .app{width:100%;max-width:680px}
    .top{position:sticky;top:0;z-index:999;background:rgba(11,18,32,.93);backdrop-filter:blur(8px);border-bottom:1px solid var(--line);padding:14px}
    .head{display:flex;gap:10px;align-items:center}
    .logo{width:44px;height:44px;border-radius:14px;overflow:hidden;border:1px solid var(--line);box-shadow:var(--shadow);background:#0f172a}
    .logo img{width:100%;height:100%;object-fit:cover}
    .title{flex:1;line-height:1.1}
    .title b{display:block;font-size:18px}
    .title span{display:block;margin-top:4px;font-size:12px;font-weight:900;color:var(--muted)}
    .row{display:flex;gap:10px;margin-top:10px}
    .search{flex:1;border-radius:16px;border:1px solid var(--line);background:#081127;color:var(--text);padding:14px;font-weight:900;outline:none;box-shadow:var(--shadow)}
    .btn{border:none;cursor:pointer;border-radius:16px;padding:14px;font-weight:1000;font-size:16px;color:var(--text);box-shadow:var(--shadow);transition:.12s;user-select:none}
    .btn:active{transform:scale(.98)}
    .btnPrimary{background:var(--primary)}
    .btnSuccess{background:var(--success)}
    .btnWarn{background:var(--warn)}
    .btnDanger{background:var(--danger)}
    .content{padding:14px}
    .sec{margin:14px 0 10px;padding-bottom:8px;border-bottom:1px solid var(--line);display:flex;justify-content:space-between;align-items:center;color:var(--muted);font-weight:1000}
    .sec strong{color:var(--text)}
    .card{background:var(--card);border:1px solid var(--line);border-radius:var(--r);padding:14px;box-shadow:var(--shadow);margin-bottom:12px}
    .name{font-size:20px;font-weight:1000}
    .meta{margin-top:8px;display:flex;flex-wrap:wrap;gap:8px;color:var(--muted);font-weight:900;font-size:12px}
    .offer{margin-top:10px;background:#0a1430;border:1px solid var(--line);border-radius:16px;padding:12px;font-weight:1000}
    .bigLine{margin-top:10px;padding:10px;border-radius:14px;border:1px dashed rgba(22,163,74,.7);background:rgba(22,163,74,.12);font-weight:1000}
    .field{margin-top:10px;background:#fff;border-radius:16px;border:2px solid rgba(37,99,235,.35);padding:10px;color:#000}
    .field label{display:block;font-size:11px;font-weight:1000;margin-bottom:6px}
    .field input,.field select,.field textarea{width:100%;border:none;outline:none;background:transparent;font-size:16px;font-weight:1000}
    .actions{display:grid;grid-template-columns:1fr 1fr;gap:10px;margin-top:12px}
    .actions3{display:grid;grid-template-columns:1fr 1fr 1fr;gap:10px;margin-top:12px}
    .empty{text-align:center;color:var(--muted);padding:20px;font-weight:1000}
    .toast{position:fixed;top:-120px;left:50%;transform:translateX(-50%);background:#f59e0b;color:#000;font-weight:1000;padding:12px 16px;border-radius:999px;box-shadow:var(--shadow);transition:.5s;z-index:2000}
    .toast.show{top:16px}
    .err{margin-top:10px;background:rgba(239,68,68,.15);border:1px solid rgba(239,68,68,.35);padding:10px;border-radius:14px;color:#fecaca;font-weight:1000}
    /* modal */
    .modalWrap{position:fixed;inset:0;background:rgba(0,0,0,.55);display:none;align-items:center;justify-content:center;padding:16px;z-index:3000}
    .modal{width:100%;max-width:560px;background:var(--card);border:1px solid var(--line);border-radius:22px;padding:14px;box-shadow:var(--shadow)}
    .modal h3{margin:0 0 12px 0;font-size:18px;font-weight:1000}
    .grid{display:grid;grid-template-columns:1fr;gap:10px}
  </style>
</head>
<body>
  <div class="toast" id="toast">ØªÙ… âœ…</div>

  <div class="app">
    <div class="top">
      <div class="head">
        <div class="logo"><img src="https://www.mad-parfumeur.com/assets/hero/logo.png" alt="MAD"></div>
        <div class="title">
          <b>Ù†Ø³Ø®Ø© Ø§Ù„Ù…Ø¯ÙŠØ± (Ø³Ù‡Ù„ Ø¬Ø¯Ù‹Ø§)</b>
          <span>Ø²Ø± Ø¥Ø±Ø³Ø§Ù„ Ù„Ù„ØªØ¬Ù‡ÙŠØ² + Ø²Ø± ØªØ¹Ø¯ÙŠÙ„ + Ø²Ø± Ø¥Ù„ØºØ§Ø¡</span>
        </div>
        <button class="btn btnPrimary" onclick="sync()">â†»</button>
      </div>

      <div class="row">
        <input id="q" class="search" placeholder="Ø§Ø¨Ø­Ø« Ø¨Ø§Ù„Ø§Ø³Ù… Ø£Ùˆ Ø§Ù„Ù‡Ø§ØªÙ..." oninput="render()">
        <button class="btn btnWarn" onclick="openAdd()">â•</button>
      </div>
      <div id="errBox"></div>
    </div>

    <div class="content" id="list"></div>
  </div>

  <!-- Edit/Add Modal -->
  <div class="modalWrap" id="modalWrap" onclick="closeModal(event)">
    <div class="modal" onclick="event.stopPropagation()">
      <h3 id="modalTitle">âœï¸ ØªØ¹Ø¯ÙŠÙ„ Ø§Ù„Ø·Ù„Ø¨</h3>
      <div class="grid">
        <div class="field"><label>Ø§Ø³Ù…</label><input id="m_name"></div>
        <div class="field"><label>Ù‡Ø§ØªÙ</label><input id="m_phone"></div>
        <div class="field"><label>Ù…Ø¯ÙŠÙ†Ø© / Ø¹Ù†ÙˆØ§Ù†</label><input id="m_city"></div>
        <div class="field"><label>Ø§Ù„Ø·Ù„Ø¨ (C)</label><input id="m_offer"></div>
        <div class="field"><label>Ø§Ù„Ø³Ø¹Ø± â‚ª</label><input id="m_price" inputmode="numeric"></div>
        <div class="field"><label>Ù…Ù„Ø§Ø­Ø¸Ø§Øª</label><textarea id="m_notes" rows="3"></textarea></div>
      </div>
      <div class="actions" style="margin-top:12px">
        <button class="btn btnDanger" onclick="closeModal()">Ø¥ØºÙ„Ø§Ù‚</button>
        <button class="btn btnSuccess" onclick="saveEdit()">âœ… Ø­ÙØ¸</button>
      </div>
    </div>
  </div>

<script>
  const SCRIPT_URL = "https://script.google.com/macros/s/AKfycbzNkx4pMGWNhH8BBBI_7qC61iYUgLjRlfJ877cwiQtKQaY5sXqq9Pmcg8zeCDaM9G9r/exec";

  let all = [];
  let editing = null; // {rowIndex, orderId}

  function toast(msg){
    const t = document.getElementById("toast");
    t.textContent = msg;
    t.classList.add("show");
    setTimeout(()=>t.classList.remove("show"), 2200);
  }

  async function sync(){
    document.getElementById("errBox").innerHTML = "";
    try{
      const res = await fetch(`${SCRIPT_URL}?action=get&t=${Date.now()}`, { cache:"no-store" });
      const data = await res.json();

      if (!Array.isArray(data)) {
        document.getElementById("errBox").innerHTML =
          `<div class="err">âš ï¸ Ø®Ø·Ø£ Ø¨Ø§Ù„Ù€ GET: ${escapeHtml(JSON.stringify(data))}</div>`;
        all = [];
      } else {
        all = data;
      }

      render();
    }catch(e){
      document.getElementById("errBox").innerHTML = `<div class="err">âš ï¸ ÙØ´Ù„ Ø§ØªØµØ§Ù„: ${escapeHtml(String(e))}</div>`;
      all = [];
      render();
    }
  }

  function isApproved(s){ s=String(s||""); return s.includes("Approved") || s.includes("×××•×©×¨"); }
  function isReady(s){ s=String(s||""); return s.includes("××•×›×Ÿ"); }
  function isDelivered(s){ s=String(s||""); return s.includes("Delivered"); }
  function isCanceled(s){ s=String(s||""); return s.includes("Canceled") || s.includes("âŒ"); }

  function render(){
    const q = (document.getElementById("q").value||"").toLowerCase();
    const rev = all.slice().reverse();

    const news = [];
    const sent = [];
    const ready = [];

    rev.forEach(o=>{
      const s = String(o.status||"");
      if (isDelivered(s) || isCanceled(s)) return;

      const match = String(o.name||"").toLowerCase().includes(q) ||
                    String(o.phone||"").includes(q) ||
                    String(o.offer||"").toLowerCase().includes(q);
      if (q && !match) return;

      if (isReady(s)) ready.push(o);
      else if (isApproved(s)) sent.push(o);
      else news.push(o);
    });

    let html = "";
    html += `<div class="sec"><strong>ğŸŸ  Ø·Ù„Ø¨Ø§Øª Ø¬Ø¯ÙŠØ¯Ø© (Ù„Ù… ØªÙØ¹ØªÙ…Ø¯)</strong><span>${news.length}</span></div>`;
    html += news.length ? news.map(cardNew).join("") : `<div class="empty">Ù„Ø§ ÙŠÙˆØ¬Ø¯</div>`;

    html += `<div class="sec"><strong>ğŸ”µ ØªÙ… Ø¥Ø±Ø³Ø§Ù„Ù‡Ø§ Ù„Ù„ØªØ¬Ù‡ÙŠØ²</strong><span>${sent.length}</span></div>`;
    html += sent.length ? sent.map(cardSent).join("") : `<div class="empty">Ù„Ø§ ÙŠÙˆØ¬Ø¯</div>`;

    html += `<div class="sec"><strong>ğŸŸ¢ Ø¬Ø§Ù‡Ø² (ØªÙ… Ø§Ù„ØªØ¬Ù‡ÙŠØ²)</strong><span>${ready.length}</span></div>`;
    html += ready.length ? ready.map(cardReady).join("") : `<div class="empty">Ù„Ø§ ÙŠÙˆØ¬Ø¯</div>`;

    document.getElementById("list").innerHTML = html;
  }

  function cardBase(o, extraTopHtml, buttonsHtml){
    const price = String(o.price||"").replace(/[^\d]/g,"") || "150";
    return `
      <div class="card">
        ${extraTopHtml || ""}
        <div class="name">${escapeHtml(o.name||"-")}</div>
        <div class="meta">
          <span>ğŸ“ ${escapeHtml(o.phone||"-")}</span>
          <span>ğŸ“ ${escapeHtml(o.city||"-")}</span>
          <span>ğŸ’° â‚ª${escapeHtml(price)}</span>
        </div>
        <div class="offer">ğŸ“¦ ${escapeHtml(o.offer||"-")}</div>
        ${o.notes ? `<div class="meta" style="margin-top:10px">ğŸ“ ${escapeHtml(o.notes)}</div>` : ""}
        ${buttonsHtml}
      </div>
    `;
  }

  function cardNew(o){
    const orderId = o.orderId || "";
    const row = o.rowIndex;

    const extra = `
      <div class="field" style="margin-top:0">
        <label>ğŸšš Ø§Ø®ØªØ± Ø´Ø±ÙƒØ© ØªÙˆØµÙŠÙ„ (Ø¶Ø±ÙˆØ±ÙŠ)</label>
        <select id="del_${escapeAttr(orderId)}">
          <option value="">-- Ø§Ø®ØªØ± --</option>
          <option value="High Express">High Express</option>
          <option value="Marwah Delivery">Marwah Delivery</option>
          <option value="Lama Delivery">Lama Delivery</option>
          <option value="Areen Delivery">Areen Delivery</option>
        </select>
      </div>
    `;

    const btns = `
      <div class="actions3">
        <button class="btn btnSuccess" onclick="sendToPrep('${row}','${escapeAttr(orderId)}')">âœ… Ø¥Ø±Ø³Ø§Ù„ Ù„Ù„ØªØ¬Ù‡ÙŠØ²</button>
        <button class="btn btnPrimary" onclick='openEdit(${safeJson(o)})'>âœï¸ ØªØ¹Ø¯ÙŠÙ„</button>
        <button class="btn btnDanger" onclick="updateStatus('${row}','${escapeAttr(orderId)}','Canceled âŒ')">âŒ Ø¥Ù„ØºØ§Ø¡</button>
      </div>
    `;

    return cardBase(o, extra, btns);
  }

  function cardSent(o){
    const btns = `
      <div class="bigLine">âœ… ØªÙ… Ø¥Ø±Ø³Ø§Ù„ Ù‡Ø°Ø§ Ø§Ù„Ø·Ù„Ø¨ Ù„Ù„ØªØ¬Ù‡ÙŠØ²</div>
      <div class="actions">
        <button class="btn btnPrimary" onclick='openEdit(${safeJson(o)})'>âœï¸ ØªØ¹Ø¯ÙŠÙ„</button>
        <button class="btn btnDanger" onclick="updateStatus('${o.rowIndex}','${escapeAttr(o.orderId||"")}','Canceled âŒ')">âŒ Ø¥Ù„ØºØ§Ø¡</button>
      </div>
    `;
    return cardBase(o, "", btns);
  }

  function cardReady(o){
    const btns = `
      <div class="bigLine">âœ… ØªÙ… Ø§Ù„ØªØ¬Ù‡ÙŠØ² â€” Ø¬Ø§Ù‡Ø² Ù„Ù„ØªØ³Ù„ÙŠÙ…</div>
      <div class="actions">
        <button class="btn btnWarn" onclick="updateStatus('${o.rowIndex}','${escapeAttr(o.orderId||"")}','Delivered âœ…')">âœ… ØªØ³Ù„ÙŠÙ… Ù„Ù„Ù…Ù†Ø¯ÙˆØ¨</button>
        <button class="btn btnPrimary" onclick='openEdit(${safeJson(o)})'>âœï¸ ØªØ¹Ø¯ÙŠÙ„</button>
      </div>
    `;
    return cardBase(o, "", btns);
  }

  async function sendToPrep(row, orderId){
    const sel = document.getElementById(`del_${orderId}`);
    const del = sel ? sel.value : "";
    if(!del){ toast("âŒ Ø§Ø®ØªØ± Ø´Ø±ÙƒØ© ØªÙˆØµÙŠÙ„"); return; }
    const status = `Approved âœ… (××©×œ×•×—: ${del})`;
    await updateStatus(row, orderId, status);
    toast("âœ… ØªÙ… Ø¥Ø±Ø³Ø§Ù„ Ù„Ù„ØªØ¬Ù‡ÙŠØ²");
  }

  async function updateStatus(row, orderId, status){
    try{
      await fetch(`${SCRIPT_URL}?action=updateStatus&row=${encodeURIComponent(row)}&orderId=${encodeURIComponent(orderId)}&status=${encodeURIComponent(status)}&t=${Date.now()}`, { cache:"no-store" });
      // update local copy
      const idx = all.findIndex(x => String(x.orderId) === String(orderId));
      if(idx >= 0) all[idx].status = status;
      render();
    }catch(e){
      toast("âš ï¸ ÙØ´Ù„ ØªØ­Ø¯ÙŠØ« (Ø§ÙØ­Øµ Ø§Ù„Ø³ÙƒØ±Ø¨Øª)");
    }
  }

  function openEdit(o){
    editing = { rowIndex: o.rowIndex, orderId: o.orderId };
    document.getElementById("modalTitle").textContent = "âœï¸ ØªØ¹Ø¯ÙŠÙ„ Ø§Ù„Ø·Ù„Ø¨";
    document.getElementById("m_name").value = o.name || "";
    document.getElementById("m_phone").value = o.phone || "";
    document.getElementById("m_city").value = o.city || "";
    document.getElementById("m_offer").value = o.offer || "";
    document.getElementById("m_price").value = (String(o.price||"").replace(/[^\d]/g,"") || "150");
    document.getElementById("m_notes").value = o.notes || "";
    document.getElementById("modalWrap").style.display = "flex";
  }

  function openAdd(){
    editing = { rowIndex: "", orderId: "" }; // new -> POST
    document.getElementById("modalTitle").textContent = "â• Ø¥Ø¶Ø§ÙØ© Ø·Ù„Ø¨ Ø¬Ø¯ÙŠØ¯";
    ["m_name","m_phone","m_city","m_offer","m_notes"].forEach(id=>document.getElementById(id).value="");
    document.getElementById("m_price").value = "150";
    document.getElementById("modalWrap").style.display = "flex";
  }

  function closeModal(){ document.getElementById("modalWrap").style.display = "none"; }

  async function saveEdit(){
    const name = (document.getElementById("m_name").value||"").trim();
    const phone = (document.getElementById("m_phone").value||"").trim();
    const city = (document.getElementById("m_city").value||"").trim();
    const offer = (document.getElementById("m_offer").value||"").trim();
    const price = String(document.getElementById("m_price").value||"150").replace(/[^\d]/g,"") || "150";
    const notes = (document.getElementById("m_notes").value||"").trim();

    // NEW order -> POST
    if(!editing || !editing.orderId){
      if(!name || !phone || !offer){ toast("âŒ Ø§ÙƒØªØ¨ Ø§Ù„Ø§Ø³Ù… + Ø§Ù„Ù‡Ø§ØªÙ + Ø§Ù„Ø·Ù„Ø¨"); return; }
      const payload = { name, phone, address: city || "-", offer, price, notes, source:"Manager Manual", lang:"ar", payment:"Cash", process:"Direct", status:"Processing..." };
      fetch(SCRIPT_URL, { method:"POST", mode:"no-cors", body: JSON.stringify(payload) });
      toast("âœ… ØªÙ… Ø­ÙØ¸ Ø§Ù„Ø·Ù„Ø¨");
      closeModal();
      setTimeout(sync, 700);
      return;
    }

    // update existing
    const row = editing.rowIndex;
    const orderId = editing.orderId;

    try{
      await fetch(`${SCRIPT_URL}?action=updateOrder&row=${encodeURIComponent(row)}&orderId=${encodeURIComponent(orderId)}&name=${encodeURIComponent(name)}&phone=${encodeURIComponent(phone)}&city=${encodeURIComponent(city)}&offer=${encodeURIComponent(offer)}&price=${encodeURIComponent(price)}&notes=${encodeURIComponent(notes)}&t=${Date.now()}`, { cache:"no-store" });
      toast("âœ… ØªÙ… Ø§Ù„ØªØ¹Ø¯ÙŠÙ„");
      closeModal();
      setTimeout(sync, 500);
    }catch(e){
      toast("âš ï¸ ÙØ´Ù„ Ø§Ù„ØªØ¹Ø¯ÙŠÙ„");
    }
  }

  function escapeHtml(str){
    return String(str ?? "").replace(/[&<>"']/g, s => ({ "&":"&amp;","<":"&lt;",">":"&gt;",'"':"&quot;","'":"&#39;" }[s]));
  }
  function escapeAttr(str){
    return String(str ?? "").replace(/'/g,"\\'").replace(/"/g,'\\"');
  }
  function safeJson(obj){
    return JSON.stringify(obj).replace(/</g,"\\u003c").replace(/>/g,"\\u003e").replace(/&/g,"\\u0026");
  }

  sync();
  setInterval(sync, 20000);
</script>
</body>
</html>
