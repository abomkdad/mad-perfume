<!doctype html>
<html lang="ar" dir="rtl">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width,initial-scale=1"/>
  <title>MAD Manager | Ø§Ù„Ø§Ø­ØªØ±Ø§ÙÙŠ</title>

  <style>
    :root {
      --bg: #0f172a;
      --card: #1e293b;
      --border: #334155;
      --accent: #3b82f6;
      --success: #22c55e;
      --danger: #ef4444;
      --text: #f8fafc;
    }

    body {
      margin: 0; font-family: system-ui, -apple-system, sans-serif;
      background: var(--bg); color: var(--text); line-height: 1.5;
    }

    /* ØªØ­Ø³ÙŠÙ†Ø§Øª Ø§Ù„Ø·Ø¨Ø§Ø¹Ø© - ØªØ¸Ù‡Ø± ÙÙ‚Ø· Ø§Ù„ÙØ§ØªÙˆØ±Ø© Ø§Ù„Ù…Ø®ØªØ§Ø±Ø© */
    @media print {
      body * { visibility: hidden; }
      #printArea, #printArea * { visibility: visible; }
      #printArea { position: absolute; left: 0; top: 0; width: 100%; color: black; background: white; padding: 20px; }
      .no-print { display: none !important; }
    }

    .container { max-width: 1200px; margin: 0 auto; padding: 20px; }
    .header { 
      position: sticky; top: 0; z-index: 100; background: rgba(15, 23, 42, 0.9);
      backdrop-filter: blur(10px); border-bottom: 1px solid var(--border);
      padding: 15px 0; margin-bottom: 20px;
    }

    .flex { display: flex; gap: 10px; align-items: center; flex-wrap: wrap; }
    .card { 
      background: var(--card); border: 1px solid var(--border); 
      border-radius: 12px; padding: 20px; margin-bottom: 15px;
      transition: transform 0.2s;
    }
    .card:hover { border-color: var(--accent); }

    .grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 15px; }
    
    input, select, textarea {
      width: 100%; padding: 10px; border-radius: 8px;
      border: 1px solid var(--border); background: #0f172a; color: white;
      box-sizing: border-box; font-size: 14px;
    }

    .btn {
      padding: 10px 15px; border-radius: 8px; border: none;
      cursor: pointer; font-weight: bold; transition: opacity 0.2s;
      display: inline-flex; align-items: center; justify-content: center; gap: 5px;
    }
    .btn:active { transform: scale(0.98); }
    .btn-primary { background: var(--accent); color: white; }
    .btn-success { background: var(--success); color: white; }
    .btn-outline { background: transparent; border: 1px solid var(--border); color: white; }

    .modal {
      position: fixed; inset: 0; background: rgba(0,0,0,0.7);
      display: none; align-items: center; justify-content: center; z-index: 1000;
    }
    .modal.show { display: flex; }
    .modal-content { background: var(--card); padding: 25px; border-radius: 15px; width: 90%; max-width: 600px; max-height: 90vh; overflow-y: auto; }

    .badge { padding: 4px 8px; border-radius: 6px; font-size: 12px; background: var(--border); }

    /* ØªØ­Ø³ÙŠÙ† Ø§Ø³ØªØ¬Ø§Ø¨Ø© Ø§Ù„Ù…ÙˆØ¨Ø§ÙŠÙ„ */
    @media (max-width: 600px) {
      .grid { grid-template-columns: 1fr; }
      .header .flex { flex-direction: column; align-items: stretch; }
    }
  </style>
</head>
<body>

<div class="header no-print">
  <div class="container">
    <div class="flex">
      <div style="font-size: 20px; font-weight: bold;">MAD Manager ğŸš€</div>
      <div id="statusTag" class="badge">Ø¬Ø§Ø±ÙŠ Ø§Ù„ØªØ­Ù…ÙŠÙ„...</div>
      <div style="flex-grow: 1;"></div>
      <button class="btn btn-primary" onclick="openSmartModal()">â• Ø¥Ø¶Ø§ÙØ© Ø°ÙƒÙŠØ©</button>
      <button class="btn btn-outline" onclick="loadOrders()">â†» ØªØ­Ø¯ÙŠØ«</button>
    </div>
    <div class="flex" style="margin-top: 15px;">
      <input type="text" id="searchInput" placeholder="Ø¨Ø­Ø« Ø¨Ø§Ù„Ø§Ø³Ù… Ø£Ùˆ Ø§Ù„Ø±Ù‚Ù… Ø£Ùˆ Ø§Ù„ÙƒÙˆØ¯..." oninput="renderOrders()">
      <select id="statusFilter" style="width: 150px;" onchange="renderOrders()">
        <option value="ALL">Ø§Ù„ÙƒÙ„</option>
        <option value="NEW">Ø¬Ø¯ÙŠØ¯</option>
        <option value="PREP">Ù‚ÙŠØ¯ Ø§Ù„ØªØ¬Ù‡ÙŠØ²</option>
        <option value="READY">Ø¬Ø§Ù‡Ø²</option>
      </select>
    </div>
  </div>
</div>

<div class="container no-print" id="ordersList">
  </div>

<div id="printArea"></div>

<div class="modal" id="smartModal">
  <div class="modal-content">
    <h3 style="margin-top:0">ØªØ­Ù„ÙŠÙ„ Ù†Øµ ÙˆØ§ØªØ³Ø§Ø¨ Ø°ÙƒÙŠ ğŸ§ </h3>
    <textarea id="rawInput" rows="6" placeholder="Ø§Ù„ØµÙ‚ Ø§Ù„Ù†Øµ Ù‡Ù†Ø§..."></textarea>
    <button class="btn btn-primary" style="width:100%; margin: 15px 0;" onclick="handleAnalysis()">ØªØ­Ù„ÙŠÙ„ Ø§Ù„Ù†Øµ</button>
    
    <div id="analysisResult" class="grid" style="display: none;">
      <div><label>Ø§Ù„Ø§Ø³Ù…</label><input id="new_name"></div>
      <div><label>Ø§Ù„Ù‡Ø§ØªÙ</label><input id="new_phone"></div>
      <div><label>Ø§Ù„Ø·Ù„Ø¨</label><input id="new_offer"></div>
      <div><label>Ø§Ù„Ø³Ø¹Ø±</label><input id="new_price"></div>
      <div style="grid-column: 1/-1;"><label>Ø§Ù„Ø¹Ù†ÙˆØ§Ù†</label><input id="new_addr"></div>
      <button class="btn btn-success" style="grid-column: 1/-1;" onclick="submitNewOrder(this)">ØªØ£ÙƒÙŠØ¯ ÙˆØ­ÙØ¸ Ø§Ù„Ø·Ù„Ø¨ âœ…</button>
    </div>
    
    <button class="btn btn-outline" style="width:100%; margin-top:10px;" onclick="closeModal()">Ø¥Ù„ØºØ§Ø¡</button>
  </div>
</div>

<script>
const SCRIPT_URL = "YOUR_SCRIPT_URL_HERE"; // Ø¶Ø¹ Ø±Ø§Ø¨Ø· Ø§Ù„Ø³ÙƒØ±ÙŠØ¨Øª Ù‡Ù†Ø§
const DASH_KEY = "12345678";
let orders = [];

// 1. Ø¬Ù„Ø¨ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª
async function loadOrders() {
  const statusTag = document.getElementById("statusTag");
  statusTag.textContent = "Ø¬Ø§Ø±ÙŠ Ø§Ù„Ù…Ø²Ø§Ù…Ù†Ø©...";
  try {
    const res = await fetch(`${SCRIPT_URL}?action=get&_=${Date.now()}`);
    orders = await res.json();
    statusTag.textContent = `Ø·Ù„Ø¨Ø§Øª: ${orders.length}`;
    renderOrders();
  } catch (e) {
    statusTag.textContent = "Ø®Ø·Ø£ ÙÙŠ Ø§Ù„Ø§ØªØµØ§Ù„";
    console.error(e);
  }
}

// 2. ØªØ­Ù„ÙŠÙ„ Ø§Ù„Ù†Øµ (Ù…Ø­Ø³Ù† Ø¬Ø¯Ø§Ù‹)
function smartParse(text) {
  const clean = text.replace(/[\u200b-\u200d\uFEFF]/g, ''); // Ø¥Ø²Ø§Ù„Ø© Ø§Ù„Ø±Ù…ÙˆØ² Ø§Ù„Ù…Ø®ÙÙŠØ©
  
  // Ø§Ø³ØªØ®Ø±Ø§Ø¬ Ø§Ù„Ù‡Ø§ØªÙ: ÙŠØ¯Ø¹Ù… ØµÙŠØº Ù…Ø«Ù„ 059-123-4567 Ø£Ùˆ +972 52...
  const phoneMatch = clean.match(/(?:\+972|05)\s?[- ]?\d{1,2}\s?[- ]?\d{3}\s?[- ]?\d{4}/);
  
  // Ø§Ø³ØªØ®Ø±Ø§Ø¬ Ø§Ù„Ø³Ø¹Ø±: ÙŠØ¨Ø­Ø« Ø¹Ù† Ø£Ø±Ù‚Ø§Ù… Ø¨Ø¬Ø§Ù†Ø¨Ù‡Ø§ Ø¹Ù…Ù„Ø©
  const priceMatch = clean.match(/(\d{2,4})\s?(?:â‚ª|Ø´ÙŠÙƒÙ„|Ø´ÙƒÙ„|nis|ils)/i);

  // Ø§Ø³ØªØ®Ø±Ø§Ø¬ Ø§Ù„Ø£ÙƒÙˆØ§Ø¯: (Ù…Ø«Ø§Ù„: C102, A15)
  const codes = clean.match(/[A-Z]{1,2}\d{2,4}/gi);

  // Ø§Ø³ØªØ®Ø±Ø§Ø¬ Ø§Ù„Ø¹Ù†ÙˆØ§Ù†: ÙŠØ£Ø®Ø° Ø§Ù„Ø³Ø·Ø± ÙƒØ§Ù…Ù„Ø§Ù‹ Ø¨Ø¹Ø¯ ÙƒÙ„Ù…Ø© "Ø§Ù„Ø¹Ù†ÙˆØ§Ù†"
  const addrMatch = clean.match(/(?:Ø§Ù„Ø¹Ù†ÙˆØ§Ù†|address|×›×ª×•×‘×ª)[:\s]+(.+)/i);

  return {
    name: clean.split('\n')[0].substring(0, 30).trim(),
    phone: phoneMatch ? phoneMatch[0].replace(/[- ]/g, '') : "",
    offer: codes ? codes.join(", ") : "",
    price: priceMatch ? priceMatch[1] : "",
    addr: addrMatch ? addrMatch[1].trim() : ""
  };
}

// 3. Ø¹Ø±Ø¶ Ø§Ù„Ø·Ù„Ø¨Ø§Øª
function renderOrders() {
  const container = document.getElementById("ordersList");
  const q = document.getElementById("searchInput").value.toLowerCase();
  const filter = document.getElementById("statusFilter").value;

  const filtered = orders.filter(o => {
    const searchStr = `${o.name} ${o.phone} ${o.offer} ${o.addr}`.toLowerCase();
    const matchSearch = searchStr.includes(q);
    const matchStatus = (filter === "ALL") || (o.status === filter);
    return matchSearch && matchStatus;
  });

  container.innerHTML = filtered.reverse().map(o => `
    <div class="card" id="card_${o.rowIndex}">
      <div class="flex" style="margin-bottom: 15px;">
        <span class="badge">#${o.orderId || o.rowIndex}</span>
        <strong style="font-size: 1.1em;">${o.name || 'Ø¨Ø¯ÙˆÙ† Ø§Ø³Ù…'}</strong>
        <div style="flex-grow: 1;"></div>
        <select onchange="updateStatus(${o.rowIndex}, this.value)" style="width: auto; padding: 5px;">
          <option value="NEW" ${o.status==='NEW'?'selected':''}>Ø¬Ø¯ÙŠØ¯</option>
          <option value="PREP" ${o.status==='PREP'?'selected':''}>ØªØ¬Ù‡ÙŠØ²</option>
          <option value="READY" ${o.status==='READY'?'selected':''}>Ø¬Ø§Ù‡Ø²</option>
        </select>
      </div>
      
      <div class="grid">
        <div><label style="font-size: 11px; opacity: 0.6;">Ø§Ù„Ù‡Ø§ØªÙ</label><input value="${o.phone||''}" onchange="updateLocal(${o.rowIndex}, 'phone', this.value)"></div>
        <div><label style="font-size: 11px; opacity: 0.6;">Ø§Ù„Ø·Ù„Ø¨</label><input value="${o.offer||''}" onchange="updateLocal(${o.rowIndex}, 'offer', this.value)"></div>
        <div><label style="font-size: 11px; opacity: 0.6;">Ø§Ù„Ø³Ø¹Ø±</label><input value="${o.price||''}" onchange="updateLocal(${o.rowIndex}, 'price', this.value)"></div>
        <div><label style="font-size: 11px; opacity: 0.6;">Ø§Ù„Ø¹Ù†ÙˆØ§Ù†</label><input value="${o.addr||''}" onchange="updateLocal(${o.rowIndex}, 'addr', this.value)"></div>
      </div>

      <div class="flex" style="margin-top: 15px; justify-content: flex-end;">
        <button class="btn btn-outline" onclick="printInvoice(${o.rowIndex})">ğŸ–¨ï¸ Ø·Ø¨Ø§Ø¹Ø©</button>
        <button class="btn btn-success" onclick="saveChanges(${o.rowIndex}, this)">ğŸ’¾ Ø­ÙØ¸</button>
      </div>
    </div>
  `).join("");
}

// 4. ØªØ­Ø¯ÙŠØ« Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª (Ø¨Ø¯ÙˆÙ† Ø¥Ø¹Ø§Ø¯Ø© ØªØ­Ù…ÙŠÙ„ Ø§Ù„ØµÙØ­Ø© ÙƒØ§Ù…Ù„Ø©)
async function saveChanges(row, btn) {
  btn.textContent = "â³...";
  const card = document.getElementById(`card_${row}`);
  const inputs = card.querySelectorAll('input');
  
  const data = {
    action: "updateOrder",
    key: DASH_KEY,
    row: row,
    name: card.querySelector('strong').textContent,
    phone: inputs[0].value,
    offer: inputs[1].value,
    price: inputs[2].value,
    addr: inputs[3].value
  };

  try {
    await fetch(`${SCRIPT_URL}?` + new URLSearchParams(data));
    btn.textContent = "âœ… ØªÙ…";
    setTimeout(() => { btn.textContent = "ğŸ’¾ Ø­ÙØ¸"; }, 2000);
  } catch (e) {
    alert("Ø®Ø·Ø£ ÙÙŠ Ø§Ù„Ø­ÙØ¸");
    btn.textContent = "ğŸ’¾ Ø­ÙØ¸";
  }
}

// 5. ÙˆØ¸ÙŠÙØ© Ø§Ù„Ø·Ø¨Ø§Ø¹Ø© Ø§Ù„Ù…Ø­ØªØ±ÙØ©
function printInvoice(row) {
  const order = orders.find(o => o.rowIndex == row);
  const printArea = document.getElementById("printArea");
  
  printArea.innerHTML = `
    <div style="text-align: center; border-bottom: 2px solid #000; padding-bottom: 10px; margin-bottom: 20px;">
      <h1>ÙØ§ØªÙˆØ±Ø© Ø·Ù„Ø¨ #${order.orderId || order.rowIndex}</h1>
      <p>ØªØ§Ø±ÙŠØ® Ø§Ù„Ø·Ø¨Ø§Ø¹Ø©: ${new Date().toLocaleString('ar-EG')}</p>
    </div>
    <table style="width: 100%; border-collapse: collapse; font-size: 18px;">
      <tr><td style="padding: 10px; border: 1px solid #ddd;"><b>Ø§Ù„Ø§Ø³Ù…:</b></td><td style="padding: 10px; border: 1px solid #ddd;">${order.name}</td></tr>
      <tr><td style="padding: 10px; border: 1px solid #ddd;"><b>Ø§Ù„Ù‡Ø§ØªÙ:</b></td><td style="padding: 10px; border: 1px solid #ddd;">${order.phone}</td></tr>
      <tr><td style="padding: 10px; border: 1px solid #ddd;"><b>Ø§Ù„Ø·Ù„Ø¨:</b></td><td style="padding: 10px; border: 1px solid #ddd;">${order.offer}</td></tr>
      <tr><td style="padding: 10px; border: 1px solid #ddd;"><b>Ø§Ù„Ø¹Ù†ÙˆØ§Ù†:</b></td><td style="padding: 10px; border: 1px solid #ddd;">${order.addr}</td></tr>
      <tr><td style="padding: 10px; border: 1px solid #ddd;"><b>Ø§Ù„Ù…Ø¨Ù„Øº Ø§Ù„Ù…Ø³ØªØ­Ù‚:</b></td><td style="padding: 10px; border: 1px solid #ddd; font-size: 24px;"><b>${order.price} â‚ª</b></td></tr>
    </table>
  `;
  window.print();
}

// ÙˆØ¸Ø§Ø¦Ù Ø§Ù„Ù…ÙˆØ¯Ø§Ù„
function openSmartModal() { document.getElementById("smartModal").classList.add("show"); }
function closeModal() { document.getElementById("smartModal").classList.remove("show"); }

function handleAnalysis() {
  const raw = document.getElementById("rawInput").value;
  if(!raw) return;
  const p = smartParse(raw);
  
  document.getElementById("new_name").value = p.name;
  document.getElementById("new_phone").value = p.phone;
  document.getElementById("new_offer").value = p.offer;
  document.getElementById("new_price").value = p.price;
  document.getElementById("new_addr").value = p.addr;
  
  document.getElementById("analysisResult").style.display = "grid";
}

async function submitNewOrder(btn) {
  const originalText = btn.textContent;
  btn.textContent = "Ø¬Ø§Ø±ÙŠ Ø§Ù„Ø¥Ø±Ø³Ø§Ù„...";
  btn.disabled = true;

  const data = {
    name: document.getElementById("new_name").value,
    phone: document.getElementById("new_phone").value,
    offer: document.getElementById("new_offer").value,
    price: document.getElementById("new_price").value,
    address: document.getElementById("new_addr").value,
    status: "NEW"
  };

  try {
    // Ø¥Ø±Ø³Ø§Ù„ ÙƒÙ€ text/plain Ù„ØªØ¬Ù†Ø¨ Ù…Ø´Ø§ÙƒÙ„ CORS Ù…Ø¹ GAS
    await fetch(SCRIPT_URL, {
      method: "POST",
      mode: "no-cors", 
      body: JSON.stringify(data)
    });
    
    alert("ØªÙ… Ø¥Ø±Ø³Ø§Ù„ Ø§Ù„Ø·Ù„Ø¨ Ø¨Ù†Ø¬Ø§Ø­!");
    closeModal();
    loadOrders();
  } catch (e) {
    alert("Ø­Ø¯Ø« Ø®Ø·Ø£ Ø£Ø«Ù†Ø§Ø¡ Ø§Ù„Ø­ÙØ¸");
  } finally {
    btn.textContent = originalText;
    btn.disabled = false;
  }
}

// Ø§Ù„ØªØ­Ù…ÙŠÙ„ Ø¹Ù†Ø¯ Ø¨Ø¯Ø¡ Ø§Ù„ØªØ´ØºÙŠÙ„
loadOrders();
</script>

</body>
</html>
