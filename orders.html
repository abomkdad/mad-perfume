<!doctype html>
<html lang="ar" dir="rtl">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width,initial-scale=1,maximum-scale=1,user-scalable=0"/>
  <title>MAD Manager v2 - Approved Print Edition</title>
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">

  <style>
    :root {
      --bg: #060914;
      --card: #161b2c;
      --primary: #2563eb;
      --success: #16a34a;
      --text: #ffffff;
      --muted: #94a3b8;
      --border: rgba(255,255,255,0.1);
    }

    body {
      margin: 0; font-family: system-ui, -apple-system, sans-serif;
      background: var(--bg); color: var(--text); padding-bottom: 90px;
    }

    /* UI Layout */
    .header { background: rgba(22, 27, 44, 0.9); padding: 15px; position: sticky; top: 0; z-index: 100; border-bottom: 1px solid var(--border); display: flex; justify-content: space-between; align-items: center; }
    .container { padding: 12px; }
    .order-card { background: var(--card); border-radius: 18px; padding: 16px; margin-bottom: 15px; border: 1px solid var(--border); }
    .actions { display: grid; grid-template-columns: 1fr 1fr 1fr; gap: 8px; margin-top: 15px; }
    .btn { padding: 10px; border-radius: 12px; border: none; font-weight: bold; cursor: pointer; display: flex; align-items: center; justify-content: center; gap: 6px; }
    .btn-primary { background: var(--primary); color: white; }
    .btn-outline { background: rgba(255,255,255,0.05); color: white; border: 1px solid var(--border); }
    .btn-wa { background: #075e54; color: white; }

    /* Print Preview Modal (مركز الشاشة للموبايل) */
    .modal-overlay {
      position: fixed; inset: 0; background: rgba(0,0,0,0.85); backdrop-filter: blur(5px);
      display: none; align-items: center; justify-content: center; z-index: 2000; padding: 10px;
    }
    .modal-overlay.show { display: flex; }
    
    .invoice-container {
      background: white; color: black; width: 98mm; height: 98mm;
      padding: 6mm; box-sizing: border-box; border-radius: 4px;
      display: flex; flex-direction: column; position: relative;
    }

    /* Approved Design Styling */
    .inv-header { text-align: center; margin-bottom: 5px; border-bottom: 1.5px solid #000; padding-bottom: 5px; }
    .inv-logo-text { font-size: 28px; font-weight: 900; margin: 0; line-height: 1; letter-spacing: 2px; }
    .inv-subtitle { font-size: 10px; font-weight: bold; margin-bottom: 5px; }
    .inv-meta { display: flex; justify-content: space-between; font-size: 9px; font-weight: bold; margin-top: 2px; }

    .inv-body { font-size: 12px; margin-top: 10px; flex-grow: 1; line-height: 1.4; text-align: right; }
    .inv-row { margin-bottom: 4px; border-bottom: 0.5px solid #eee; padding-bottom: 2px; }
    .inv-row strong { font-weight: 900; }

    .inv-footer { border-top: 1.5px solid #000; padding-top: 8px; display: flex; justify-content: space-between; align-items: flex-end; }
    .promo-section { text-align: center; flex: 1; }
    .promo-title { font-size: 10px; font-weight: 900; margin-bottom: 3px; }
    .promo-steps { font-size: 8.5px; line-height: 1.2; text-align: right; }
    
    .qr-area { text-align: center; margin-left: 10px; }
    .qr-area img { width: 45px; height: 45px; border: 1px solid #000; }
    .qr-phone { font-size: 8px; font-weight: bold; margin-top: 2px; }

    .total-area { text-align: left; min-width: 60px; }
    .total-label { font-size: 10px; font-weight: bold; }
    .total-amount { font-size: 20px; font-weight: 900; }

    /* Modal Controls */
    .modal-btns { position: absolute; bottom: -60px; left: 0; right: 0; display: flex; gap: 10px; justify-content: center; }

    @media print {
      body * { visibility: hidden; }
      #invoicePreview, #invoicePreview * { visibility: visible; }
      #invoicePreview { position: fixed; left: 0; top: 0; width: 98mm; height: 98mm; margin: 0; padding: 6mm; border: none; }
      .modal-btns { display: none; }
      @page { size: 98mm 98mm; margin: 0; }
    }
  </style>
</head>
<body>

<div class="modal-overlay" id="printModal">
    <div class="invoice-container" id="invoicePreview">
        <div class="inv-header">
            <h1 class="inv-logo-text">MAD</h1>
            <div class="inv-subtitle">PARFUMEUR</div>
            <div class="inv-meta">
                <span>DATE: <span id="p_date">4.2.2026</span></span>
                <span>ORD: <span id="p_ord">MAD-04752</span></span>
            </div>
        </div>

        <div class="inv-body">
            <div class="inv-row"><strong>לכבוד:</strong> <span id="p_name">Mohamad Basheer</span></div>
            <div class="inv-row"><strong>טלפון:</strong> <span id="p_phone">054-9748773</span></div>
            <div class="inv-row"><strong>כתובת:</strong> <span id="p_addr">شفاعمر - High Express</span></div>
            <div style="margin-top: 8px;">
                <strong>פריטים:</strong>
                <div id="p_items" style="font-size: 10px; background: #f9f9f9; padding: 4px; margin-top: 2px;">W183, X102, P104</div>
            </div>
        </div>

        <div class="inv-footer">
            <div class="qr-area">
                <img id="p_qr" src="https://api.qrserver.com/v1/create-qr-code/?size=100x100&data=https://wa.me/972549748773" alt="QR">
                <div class="qr-phone" id="p_phone_footer">0549748773</div>
            </div>
            
            <div class="promo-section">
                <div class="promo-title">צלם את הרגע וקבל מתנה</div>
                <div class="promo-steps">
                    1. סרוק את הקוד <br>
                    2. שלח סרטון ל-WA <br>
                    3. קבל מתנה!
                </div>
            </div>

            <div class="total-area">
                <div class="total-label">לתשלום:</div>
                <div class="total-amount">₪<span id="p_total">20</span></div>
            </div>
        </div>

        <div class="modal-btns">
            <button class="btn btn-outline" onclick="closePrintModal()">إغلاق</button>
            <button class="btn btn-primary" onclick="window.print()"><i class="fa fa-print"></i> طباعة الآن</button>
        </div>
    </div>
</div>

<div class="header">
  <div style="font-weight: 900; font-size: 20px;">MAD <span style="color:var(--primary)">MANAGER</span></div>
  <button class="btn btn-primary" onclick="load()"><i class="fa fa-sync"></i></button>
</div>

<div class="container" id="ordersList"></div>

<script>
const SCRIPT_URL = "https://script.google.com/macros/s/AKfycbyLjLFa8AaH82Ip7m747WC-KSUUEaU_M70S0I9Mda14XbnmcuEfZ7pBnF_zzJYZuXmZ/exec";
let allOrders = [];

async function load() {
  document.body.style.opacity = "0.5";
  try {
    const res = await fetch(`${SCRIPT_URL}?action=get&_=${Date.now()}`);
    allOrders = await res.json();
    renderOrders();
  } catch (e) { console.error("Error loading data"); }
  document.body.style.opacity = "1";
}

function renderOrders() {
  const container = document.getElementById('ordersList');
  container.innerHTML = allOrders.filter(o => o.rowIndex).map(o => `
    <div class="order-card">
      <div style="display:flex; justify-content:space-between; margin-bottom:8px;">
        <strong>#${o.orderId}</strong>
        <span style="font-size:12px;">${o.status || 'NEW'}</span>
      </div>
      <div>
        <div style="font-size:16px; font-weight:bold;">${o.name}</div>
        <div style="font-size:13px; color:var(--muted);">${o.phone}</div>
      </div>
      <div class="actions">
        <a href="https://wa.me/${o.phone}" class="btn btn-wa"><i class="fab fa-whatsapp"></i></a>
        <button class="btn btn-outline" onclick="openPrintModal(${o.rowIndex})"><i class="fa fa-file-invoice"></i> فاتورة</button>
        <button class="btn btn-primary" onclick="alert('تعديل')"><i class="fa fa-edit"></i></button>
      </div>
    </div>
  `).join('');
}

function openPrintModal(row) {
    const o = allOrders.find(x => x.rowIndex == row);
    if (!o) return;

    // تعبئة البيانات بناءً على النسخة المعتمدة
    document.getElementById('p_date').textContent = "4.2.2026"; // التاريخ الحالي حسب المطلوب 
    document.getElementById('p_ord').textContent = "MAD-" + (o.orderId || "0000"); // [cite: 2]
    document.getElementById('p_name').textContent = o.name; // לכבוד [cite: 6]
    document.getElementById('p_phone').textContent = o.phone; // טלפון [cite: 7]
    document.getElementById('p_addr').textContent = (o.addr || o.city || "") + " - " + (o.delivery || ""); // כתובת [cite: 8]
    document.getElementById('p_items').textContent = o.offer; // פריטים [cite: 9]
    document.getElementById('p_total').textContent = o.price; // לתשלום 
    
    // تحديث QR والترويج
    const cleanPhone = String(o.phone).replace(/\D/g, "");
    document.getElementById('p_qr').src = `https://api.qrserver.com/v1/create-qr-code/?size=100x100&data=https://wa.me/${cleanPhone}`;
    document.getElementById('p_phone_footer').textContent = cleanPhone;

    document.getElementById('printModal').classList.add('show');
}

function closePrintModal() {
    document.getElementById('printModal').classList.remove('show');
}

window.onload = load;
</script>

</body>
</html>
