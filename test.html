<!DOCTYPE html>
<html lang="he">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>MAD PARFUMEUR | Luxury Fragrance</title>
    
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link href="https://fonts.googleapis.com/css2?family=Cinzel:wght@700&family=Assistant:wght@300;400;700&display=swap" rel="stylesheet">

    <style>
        :root { --gold: #D4AF37; --black: #000; --card: #111; --white: #fff; --wa: #25D366; }
        * { box-sizing: border-box; margin: 0; padding: 0; }
        body { background: var(--black); color: var(--white); font-family: 'Assistant', sans-serif; -webkit-font-smoothing: antialiased; opacity: 0; transition: opacity 0.3s ease; }
        .container { max-width: 1200px; margin: 0 auto; padding: 0 15px; }

        header { padding: 30px 0; text-align: center; border-bottom: 1px solid #222; }
        .logo { font-family: 'Cinzel', serif; color: var(--gold); font-size: 2.2rem; letter-spacing: 4px; text-transform: uppercase; }
        .br-name { font-size: 1.3rem; margin: 10px 0; font-weight: 300; }
        
        .status { display: inline-block; padding: 5px 15px; border-radius: 20px; font-size: 0.8rem; font-weight: 700; border: 1px solid; }
        .open { color: var(--wa); border-color: var(--wa); background: rgba(37,211,102,0.1); }
        .closed { color: #ff4d4d; border-color: #ff4d4d; background: rgba(255,77,77,0.1); }

        .social-row { display: flex; justify-content: center; gap: 20px; margin-top: 15px; }
        .social-row a { color: var(--white); font-size: 1.4rem; transition: 0.2s; opacity: 0.8; }
        .social-row a:hover { color: var(--gold); opacity: 1; transform: translateY(-2px); }

        .nav-wrap { position: sticky; top: 0; background: var(--black); z-index: 100; padding: 12px 0; border-bottom: 1px solid #222; }
        .cats { display: flex; gap: 10px; overflow-x: auto; scrollbar-width: none; white-space: nowrap; }
        .cats::-webkit-scrollbar { display: none; }
        .c-btn { background: #1a1a1a; color: #fff; border: 1px solid #333; padding: 8px 18px; border-radius: 4px; cursor: pointer; border: 1px solid transparent; }
        .c-btn.active { background: var(--gold); color: #000; font-weight: 700; border-color: var(--gold); }

        .grid { display: grid; grid-template-columns: repeat(2, 1fr); gap: 15px; padding: 25px 0 80px; }
        @media (min-width: 768px) { .grid { grid-template-columns: repeat(4, 1fr); gap: 25px; } }
        
        .card { background: var(--card); border: 1px solid #222; border-radius: 4px; overflow: hidden; display: flex; flex-direction: column; transition: 0.3s; }
        .card:hover { border-color: var(--gold); }
        .img-box { width: 100%; aspect-ratio: 1/1; background: #000; overflow: hidden; }
        .img-box img { width: 100%; height: 100%; object-fit: cover; opacity: 0; transition: opacity 0.4s; }
        .img-box img.loaded { opacity: 1; }

        .info { padding: 15px; text-align: center; flex-grow: 1; display: flex; flex-direction: column; }
        .p-title { font-size: 0.95rem; height: 2.8em; overflow: hidden; margin-bottom: 10px; font-family: 'Cinzel', serif; line-height: 1.4; }
        .p-price { color: var(--gold); font-weight: 700; font-size: 1.2rem; margin-bottom: 15px; }
        .wa-btn { background: var(--wa); color: #fff; text-decoration: none; padding: 12px; border-radius: 4px; font-weight: 700; display: flex; align-items: center; justify-content: center; gap: 8px; font-size: 0.9rem; }

        #popup { position: fixed; inset: 0; background: rgba(0,0,0,0.92); z-index: 2000; display: none; align-items: center; justify-content: center; padding: 20px; }
        .p-box { width: 100%; max-width: 420px; background: #000; border: 1px solid var(--gold); position: relative; animation: popScale 0.4s ease; }
        @keyframes popScale { from { transform: scale(0.9); opacity: 0; } to { transform: scale(1); opacity: 1; } }
        .p-close { position: absolute; top: -45px; right: 0; color: #fff; font-size: 2.5rem; cursor: pointer; }
        .p-timer { background: var(--gold); color: #000; padding: 12px; text-align: center; font-weight: 900; font-size: 1.2rem; }
        .p-wa { display: block; background: var(--wa); color: #fff; text-align: center; padding: 18px; text-decoration: none; font-weight: 900; font-size: 1.1rem; }
    </style>
</head>
<body>

<header>
    <div class="container">
        <h1 class="logo">MAD PARFUMEUR</h1>
        <div id="br-name" class="br-name"></div>
        <div id="br-status"></div>
        <div id="br-socials" class="social-row"></div>
    </div>
</header>

<div class="nav-wrap">
    <div class="container">
        <nav id="br-cats" class="cats"></nav>
    </div>
</div>

<main class="container">
    <div id="br-grid" class="grid"></div>
</main>

<div id="popup">
    <div class="p-box">
        <span class="p-close" onclick="closePop()">&times;</span>
        <img src="sale.png" style="width:100%; display:block;" alt="Daily Offer">
        <div id="timer" class="p-timer">00:00:00</div>
        <a href="#" id="p-wa-btn" class="p-wa">CLAIM OFFER</a>
    </div>
</div>

<script>
/**
 * PERFORMANCE ARCHITECT & AI FIX PROMPT LOGIC
 */
const App = {
    branchId: new URLSearchParams(window.location.search).get('branch') || '1',
    lang: navigator.language.startsWith('ar') ? 'ar' : 'he',
    branch: null,
    products: [],
    timerId: null,
    i18n: {
        he: { dir: 'ltr', open: "פתוח עכשיו", closed: "סגور כעת", all: "הכל", order: "הזמנה ב-WhatsApp", msg: "היי, אני מעוניין ב: " },
        ar: { dir: 'rtl', open: "مفتوح الآن", closed: "مغلق حالياً", all: "الكل", order: "طلب عبر واتساب", msg: "مرحباً، أنا مهتم بمنتج: " }
    }
};

/**
 * NORMALIZATION UTILS
 */
const normalizeWA = (num) => {
    let clean = num.replace(/\D/g, '');
    if (clean.startsWith('05')) clean = '972' + clean.substring(1);
    return clean;
};

const track = (action, label = '') => {
    const payload = { branch_id: App.branchId, action: action, item: label };
    console.log(`[TRACKING]`, payload);
    if (window.fbq) fbq('track', 'Lead', payload);
    if (window.ttq) ttq.track('SubmitForm', { contents: [{ content_name: action, content_id: label }] });
};

/**
 * CSV PARSER (Handles quoted commas)
 */
const parseCSV = (text) => {
    const lines = text.split(/\r?\n/).filter(line => line.trim() !== "");
    const headers = lines[0].split(',').map(h => h.trim());
    return lines.slice(1).map(line => {
        // Regex handles commas inside quotes
        const values = line.split(/,(?=(?:(?:[^"]*"){2})*[^"]*$)/);
        let entry = {};
        headers.forEach((h, i) => {
            let val = values[i] ? values[i].replace(/^"|"$/g, '').trim() : "";
            entry[h] = val;
        });
        return entry;
    });
};

/**
 * UI ENGINE
 */
const renderGrid = (filter = 'all') => {
    const grid = document.getElementById('br-grid');
    grid.innerHTML = '';
    
    // FILTER LOGIC: Match BranchID column AND Category
    const filtered = App.products.filter(p => {
        const matchBranch = p.BranchID == App.branchId;
        const matchCat = filter === 'all' || p["Category (g:product_type)"] === filter;
        return matchBranch && matchCat;
    });

    if (filtered.length === 0) {
        grid.innerHTML = `<div style="grid-column:1/-1;text-align:center;padding:50px;opacity:0.5;">No products available for this branch.</div>`;
        return;
    }

    const frag = document.createDocumentFragment();
    filtered.forEach(p => {
        const waLink = `https://wa.me/${normalizeWA(App.branch.phone)}?text=${encodeURIComponent(App.i18n[App.lang].msg + p.Title)}`;
        const card = document.createElement('div');
        card.className = 'card';
        card.innerHTML = `
            <div class="img-box"><img data-src="${p.Image}" src="data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" alt="${p.Title}"></div>
            <div class="info">
                <div class="p-title">${p.Title}</div>
                <div class="p-price">${p.Price}</div>
                <a href="${waLink}" target="_blank" class="wa-btn" onclick="track('WA_Product_Click', '${p.Title}')">
                    <i class="fab fa-whatsapp"></i> ${App.i18n[App.lang].order}
                </a>
            </div>`;
        frag.appendChild(card);
    });
    grid.appendChild(frag);

    // Optimized Intersection Observer
    const obs = new IntersectionObserver((entries) => {
        entries.forEach(en => {
            if (en.isIntersecting) {
                const img = en.target;
                img.src = img.dataset.src;
                img.onload = () => img.classList.add('loaded');
                obs.unobserve(img);
            }
        });
    }, { rootMargin: '100px' });
    grid.querySelectorAll('img').forEach(i => obs.observe(i));
};

const renderCats = () => {
    const catField = "Category (g:product_type)";
    // Get cats only for current branch products
    const branchProds = App.products.filter(p => p.BranchID == App.branchId);
    const cats = [App.i18n[App.lang].all, ...new Set(branchProds.map(p => p[catField]))].filter(Boolean);
    const container = document.getElementById('br-cats');
    
    cats.forEach(c => {
        const btn = document.createElement('button');
        btn.className = 'c-btn' + (c === App.i18n[App.lang].all ? ' active' : '');
        btn.textContent = c;
        btn.onclick = () => {
            document.querySelectorAll('.c-btn').forEach(b => b.classList.remove('active'));
            btn.classList.add('active');
            renderGrid(c === App.i18n[App.lang].all ? 'all' : c);
        };
        container.appendChild(btn);
    });
};

/**
 * POPUP LOGIC
 */
const startTimer = () => {
    const timerEl = document.getElementById('timer');
    const update = () => {
        const now = new Date();
        const end = new Date().setHours(23, 59, 59);
        const diff = end - now;
        if (diff <= 0) { closePop(); return; }
        const h = Math.floor(diff/3600000).toString().padStart(2,'0');
        const m = Math.floor((diff%3600000)/60000).toString().padStart(2,'0');
        const s = Math.floor((diff%60000)/1000).toString().padStart(2,'0');
        timerEl.textContent = `${h}:${m}:${s}`;
    };
    update();
    App.timerId = setInterval(update, 1000);
};

window.closePop = () => {
    document.getElementById('popup').style.display = 'none';
    localStorage.setItem('mad_pop_' + new Date().toDateString(), '1');
    if (App.timerId) clearInterval(App.timerId); // Memory Leak Protection
};

/**
 * INITIALIZATION
 */
async function boot() {
    try {
        const [r1, r2] = await Promise.all([ fetch('test.json'), fetch('products.csv') ]);
        const bData = await r1.json();
        const pRaw = await r2.text();

        App.branch = bData.branches.find(b => b.id == App.branchId) || bData.branches[0];
        App.products = parseCSV(pRaw);

        // Language & Direction Injection
        const meta = App.i18n[App.lang];
        document.documentElement.lang = App.lang;
        document.body.dir = meta.dir;

        // Header Render
        document.getElementById('br-name').textContent = App.branch[`name_${App.lang}`];
        
        // Live Status Logic
        const now = new Date();
        const day = ['sun','mon','tue','wed','thu','fri','sat'][now.getDay()];
        const sched = App.branch.schedule[day] || [];
        const nowM = now.getHours() * 60 + now.getMinutes();
        const isOpen = sched.some(r => {
            const [sH, sM] = r[0].split(':').map(Number);
            const [eH, eM] = r[1].split(':').map(Number);
            return nowM >= (sH*60+sM) && nowM < (eH*60+eM);
        });
        document.getElementById('br-status').innerHTML = `<span class="status ${isOpen?'open':'closed'}">${isOpen?meta.open:meta.closed}</span>`;

        // Socials
        const socMap = { tiktok:'fa-tiktok', instagram:'fa-instagram', facebook:'fa-facebook', waze:'fa-waze', email:'fa-envelope' };
        document.getElementById('br-socials').innerHTML = Object.entries(App.branch.social)
            .map(([k,v]) => v ? `<a href="${v}" target="_blank" onclick="track('Social_Click', '${k}')"><i class="fab ${socMap[k]||'fa-link'}"></i></a>` : '').join('');

        renderCats();
        renderGrid();

        // Popup Trigger
        if (!localStorage.getItem('mad_pop_' + new Date().toDateString())) {
            setTimeout(() => {
                document.getElementById('popup').style.display = 'flex';
                const waLink = `https://wa.me/${normalizeWA(App.branch.phone)}?text=Daily Offer from ${App.branchId}`;
                document.getElementById('p-wa-btn').href = waLink;
                document.getElementById('p-wa-btn').onclick = () => track('Popup_CTA_Click');
                startTimer();
            }, 3000);
        }

        document.body.style.opacity = '1';
    } catch (e) {
        console.error("FATAL BOOT ERROR:", e);
    }
}

window.addEventListener('DOMContentLoaded', boot);
</script>
</body>
</html>
