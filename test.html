<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>MAD Parfumeur – Elite Branch Portal</title>
    
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/lucide@latest"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Cairo:wght@400;700&display=swap');
        body { font-family: 'Cairo', sans-serif; background-color: #ffffff; }
        .header-bg { 
            background-image: linear-gradient(rgba(0,0,0,0.5), rgba(0,0,0,0.5)), url('https://images.unsplash.com/photo-1541643600914-78b084683601?q=80&w=1000');
            background-size: cover; background-position: center;
        }
        .no-scrollbar::-webkit-scrollbar { display: none; }
    </style>
</head>
<body class="antialiased text-gray-900">

    <script>
        const meta_pixel_id = "YOUR_META_ID"; // تتبع زيارات وتحويلات Meta
        const tiktok_pixel_id = "YOUR_TIKTOK_ID"; // تتبع زيارات وتحويلات TikTok
    </script>

    <header class="header-bg h-56 flex flex-col items-center justify-center text-white p-4 relative">
        <img src="logo.png" alt="MAD Logo" class="w-24 mb-3 drop-shadow-md" onerror="this.src='https://via.placeholder.com/150?text=MAD'">
        <h1 id="branch-name-display" class="text-2xl font-bold italic tracking-wider">MAD PARFUMEUR</h1>
        <div id="status-display" class="mt-2 px-4 py-1 rounded-full text-[10px] font-bold uppercase tracking-widest bg-gray-500">
            جاري التحقق...
        </div>
    </header>

    <nav class="sticky top-0 z-40 bg-white border-b shadow-sm">
        <div class="container mx-auto px-4 py-3 flex justify-around items-center">
            <a id="waze-link" href="#" class="flex flex-col items-center text-blue-600">
                <i data-lucide="map-pin"></i><span class="text-[10px] mt-1">WAZE</span>
            </a>
            <a id="phone-link" href="#" class="flex flex-col items-center text-green-600">
                <i data-lucide="phone"></i><span class="text-[10px] mt-1">اتصال</span>
            </a>
            <a id="insta-link" href="#" class="flex flex-col items-center text-pink-600">
                <i data-lucide="instagram"></i><span class="text-[10px] mt-1">INSTA</span>
            </a>
            <button onclick="toggleCart()" class="relative flex flex-col items-center text-gray-800">
                <i data-lucide="shopping-cart"></i>
                <span id="cart-count" class="absolute -top-2 -right-2 bg-red-600 text-white text-[10px] w-5 h-5 rounded-full flex items-center justify-center">0</span>
                <span class="text-[10px] mt-1">السلة</span>
            </button>
        </div>
    </nav>

    <div id="categories-bar" class="flex gap-2 p-4 overflow-x-auto no-scrollbar bg-gray-50 border-b">
        </div>

    <main class="container mx-auto p-4 min-h-screen">
        <div id="product-grid" class="grid grid-cols-2 md:grid-cols-4 lg:grid-cols-5 gap-4">
            </div>
    </main>

    <div id="sale-popup" class="fixed inset-0 z-[100] hidden items-center justify-center bg-black/80 p-6 backdrop-blur-sm">
        <div class="relative max-w-sm w-full animate-in zoom-in duration-300">
            <button onclick="closePopup()" class="absolute -top-10 right-0 text-white"><i data-lucide="x-circle"></i></button>
            <img src="sale.png" alt="اليوم فقط" class="rounded-xl shadow-2xl border-2 border-white/20">
        </div>
    </div>

    <div id="cart-sidebar" class="fixed inset-y-0 left-0 w-80 bg-white shadow-2xl z-[110] transform -translate-x-full transition-transform duration-300 flex flex-col">
        <div class="p-4 border-b flex justify-between items-center bg-gray-100">
            <h2 class="font-bold">سلة المشتريات</h2>
            <button onclick="toggleCart()"><i data-lucide="x"></i></button>
        </div>
        <div id="cart-items" class="flex-grow overflow-y-auto p-4 space-y-4">
            </div>
        <div class="p-4 border-t bg-gray-50">
            <div class="flex justify-between mb-4 font-bold text-lg">
                <span>الإجمالي:</span>
                <span id="cart-total">0 ILS</span>
            </div>
            <button onclick="sendOrder()" class="w-full bg-green-600 text-white py-4 rounded-xl font-bold flex items-center justify-center gap-2 shadow-lg">
                <i data-lucide="message-circle"></i> إرسال الطلب (واتساب)
            </button>
        </div>
    </div>

    <script>
        let currentBranch = null;
        let allProducts = [];
        let cart = [];

        // 1. منطق الفروع (Logic: URL → branches.json)
        async function initBranch() {
            const urlParams = new URLSearchParams(window.location.search);
            const branchId = urlParams.get('branch'); // يتم اختيار الفرع عبر ?branch=ID

            try {
                const response = await fetch('branches.json');
                const data = await response.json();
                
                // في حال عدم وجود ID يتم تحميل أول فرع تلقائياً
                currentBranch = data.branches.find(b => b.id == branchId) || data.branches[0];
                
                renderBranchInfo();
                loadProducts();
                checkStatus();
            } catch (err) { console.error("Error loading branches.json", err); }
        }

        function renderBranchInfo() {
            document.getElementById('branch-name-display').innerText = currentBranch.name_ar;
            document.getElementById('waze-link').href = currentBranch.social.waze;
            document.getElementById('phone-link').href = `tel:${currentBranch.phone}`;
            document.getElementById('insta-link').href = currentBranch.social.instagram;
        }

        // تحديد مفتوح / مغلق لحظياً (Logic: schedule)
        function checkStatus() {
            const now = new Date();
            const days = ['sun', 'mon', 'tue', 'wed', 'thu', 'fri', 'sat'];
            const today = days[now.getDay()];
            const schedule = currentBranch.schedule[today];
            const display = document.getElementById('status-display');

            if (schedule && schedule.length > 0) {
                display.innerText = "مفتوح الآن - " + currentBranch.hours;
                display.classList.replace('bg-gray-500', 'bg-green-600');
            } else {
                display.innerText = "مغلق الآن";
                display.classList.replace('bg-gray-500', 'bg-red-600');
            }
        }

        // 2. منطق المنتجات (Logic: products.csv parsing)
        async function loadProducts() {
            try {
                const response = await fetch('products.csv');
                const text = await response.text();
                
                // معالجة CSV وتجاهل الهيدر (Parsing Rules)
                const rows = text.split('\n').slice(1);
                allProducts = rows.map(row => {
                    // استخدام Regex لمعالجة الفواصل داخل النصوص
                    const cols = row.split(/,(?=(?:(?:[^"]*"){2})*[^"]*$)/);
                    if (cols.length < 11) return null;
                    
                    return {
                        name: cols[0].replace(/"/g, ''),
                        image: cols[3].trim(),
                        price: cols[9].trim(),
                        catAr: cols[11].trim(), // Category Arabic
                        catHe: cols[10].trim()  // Category Hebrew
                    };
                }).filter(p => p !== null);

                renderCategories();
                renderProducts(allProducts);
            } catch (err) { console.error("Error loading products.csv", err); }
        }

        function renderCategories() {
            const categories = ['الكل', ...new Set(allProducts.map(p => p.catAr))];
            const container = document.getElementById('categories-bar');
            container.innerHTML = categories.map(cat => `
                <button onclick="filterProducts('${cat}')" class="px-6 py-2 rounded-full bg-white border border-gray-200 text-xs font-bold whitespace-nowrap active:bg-black active:text-white">
                    ${cat}
                </button>
            `).join('');
        }

        function renderProducts(list) {
            const grid = document.getElementById('product-grid');
            grid.innerHTML = list.map(p => `
                <div class="bg-white rounded-xl shadow-sm border border-gray-100 p-3 flex flex-col justify-between">
                    <div>
                        <img src="${p.image}" class="w-full aspect-square object-cover rounded-lg mb-2" onerror="this.src='logo.png'">
                        <h3 class="text-xs font-bold leading-tight h-8 overflow-hidden">${p.name}</h3>
                    </div>
                    <div class="mt-3 flex justify-between items-center">
                        <span class="text-sm font-bold text-gray-900">${p.price}</span>
                        <button onclick="addToCart('${p.name}', '${p.price}')" class="bg-black text-white p-2 rounded-lg">
                            <i data-lucide="plus" class="w-4 h-4"></i>
                        </button>
                    </div>
                </div>
            `).join('');
            lucide.createIcons();
        }

        function filterProducts(cat) {
            if (cat === 'الكل') renderProducts(allProducts);
            else renderProducts(allProducts.filter(p => p.catAr === cat));
        }

        // 3. نظام السلة والطلب (Order Flow: Cart → WhatsApp → Branch Phone)
        function addToCart(name, price) {
            cart.push({ name, price });
            updateCartUI();
            // Tracking Flow (User Action -> Pixel Event)
            console.log("Tracking: Product added to cart");
        }

        function updateCartUI() {
            document.getElementById('cart-count').innerText = cart.length;
            const itemsCont = document.getElementById('cart-items');
            itemsCont.innerHTML = cart.map((item, idx) => `
                <div class="flex justify-between items-center bg-gray-50 p-3 rounded-lg border">
                    <span class="text-xs font-bold">${item.name}</span>
                    <div class="flex items-center gap-3">
                        <span class="text-xs">${item.price}</span>
                        <button onclick="removeFromCart(${idx})" class="text-red-500"><i data-lucide="trash-2" class="w-4 h-4"></i></button>
                    </div>
                </div>
            `).join('');
            
            const total = cart.reduce((acc, item) => acc + parseFloat(item.price.replace(/[^0-9.]/g, '') || 0), 0);
            document.getElementById('cart-total').innerText = total + " ILS";
            lucide.createIcons();
        }

        function removeFromCart(idx) {
            cart.splice(idx, 1);
            updateCartUI();
        }

        function toggleCart() {
            const sb = document.getElementById('cart-sidebar');
            sb.classList.toggle('-translate-x-full');
        }

        function sendOrder() {
            if (cart.length === 0) return alert("السلة فارغة");
            let message = `مرحباً MAD ${currentBranch.name_ar}، أود طلب التالي:\n\n`;
            cart.forEach(i => message += `- ${i.name} (${i.price})\n`);
            message += `\nالإجمالي: ${document.getElementById('cart-total').innerText}`;
            
            // ربط الطلب برقم فرع الواتساب (WhatsApp Message → Branch Phone)
            const waPhone = currentBranch.phone.startsWith('0') ? '972' + currentBranch.phone.substring(1) : currentBranch.phone;
            window.open(`https://wa.me/${waPhone}?text=${encodeURIComponent(message)}`, '_blank');
        }

        // 4. النوافذ المنبثقة (Asset: sale_image)
        setTimeout(() => {
            document.getElementById('sale-popup').classList.replace('hidden', 'flex');
        }, 3000);

        function closePopup() { document.getElementById('sale-popup').classList.replace('flex', 'hidden'); }

        // تهيئة النظام عند التحميل
        initBranch();
        lucide.createIcons();
    </script>
</body>
</html>
