<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
<title>MAD PARFUMEUR | Branch Portal</title>

<link href="https://fonts.googleapis.com/css2?family=Playfair+Display:wght@700;900&family=Inter:wght@400;600;800&family=Amiri:wght@400;700&family=Assistant:wght@400;700;800&display=swap" rel="stylesheet">
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
<script src="https://cdn.tailwindcss.com"></script>

<style>
:root{
--primary:#d97706;
--bg:#020202;
--border:rgba(255,255,255,.1);
}

body{
background:var(--bg);
color:#f4f4f4;
font-family:'Assistant','Inter',sans-serif;
}

/* STORE */
.sticky-cats{
position:sticky;
top:0;
z-index:50;
background:rgba(2,2,2,.95);
backdrop-filter:blur(10px);
padding:16px 0;
border-bottom:1px solid var(--border);
}

.cat-pill{
padding:10px 25px;
border-radius:99px;
border:1px solid var(--border);
font-size:1rem;
font-weight:700;
cursor:pointer;
white-space:nowrap;
transition:.3s;
}

.cat-pill.active{
background:var(--primary);
color:#000;
border-color:var(--primary);
}

.product-card{
background:#0a0a0a;
border:1px solid var(--border);
border-radius:20px;
overflow:hidden;
display:flex;
flex-direction:column;
}

.ask-btn{
background:var(--primary);
color:#000;
font-weight:900;
width:100%;
padding:14px;
border-radius:14px;
font-size:1rem;
margin-top:12px;
transition:.2s;
}

.ask-btn:hover{
filter:brightness(1.05);
}
</style>
</head>

<body>

<!-- STORE -->
<section id="shop" class="bg-[#050505] min-h-screen pb-24">

<div class="sticky-cats">
<div id="cats-container" class="flex gap-3 px-6 overflow-x-auto"></div>
</div>

<div id="products-grid" class="grid grid-cols-2 gap-4 p-4 max-w-5xl mx-auto"></div>

</section>

<script>
/* ===============================
   GLOBAL STATE
================================ */
const params = new URLSearchParams(window.location.search);
const branchID = parseInt(params.get("branch")) || 1;
const lang = navigator.language.startsWith("ar") ? "ar" : "he";

let BRANCH = null;
let PRODUCTS = [];
let activeCat = "all";

const TEXTS = {
ar:{
cats:{all:"الكل",men:"رجالي",women:"نسائي",unisex:"للجنسين"},
ask:"اسأل عن توافر هذا المنتج في فرعكم"
},
he:{
cats:{all:"הכל",men:"גברים",women:"נשים",unisex:"יוניסקס"},
ask:"בדוק זמינות בסניף"
}
};

/* ===============================
   INIT
================================ */
async function initStore(){
try{

/* LOAD BRANCH DATA */
const branchRes = await fetch("branches.json");
const branchJson = await branchRes.json();
BRANCH = branchJson.branches.find(b => b.id === branchID) || branchJson.branches[0];

/* LOAD PRODUCTS CSV */
const prodRes = await fetch("products.csv");
const csvText = await prodRes.text();
parseProducts(csvText);

/* RENDER */
renderCats();
renderProducts();

}catch(e){
console.error("STORE LOAD ERROR:",e);
}
}

/* ===============================
   CSV PARSER
================================ */
function parseProducts(csv){
const rows = csv.split("\n");
const catIndex = lang === "ar" ? 11 : 10;

for(let i=1;i<rows.length;i++){
const cols = rows[i].split(/,(?=(?:(?:[^"]*"){2})*[^"]*$)/);
if(!cols[0]) continue;

PRODUCTS.push({
id:i,
name_ar: cols[0]?.replace(/"/g,"").trim(),
name_he: cols[0]?.replace(/"/g,"").trim(),
img: cols[3]?.trim() || "logo.png",
price: parseFloat(cols[9]?.replace(/[^\d.]/g,"")) || 0,
cat: cols[catIndex]?.trim() || "men"
});
}
}

/* ===============================
   CATEGORIES
================================ */
function renderCats(){
const t = TEXTS[lang].cats;
const cats = ["all",...new Set(PRODUCTS.map(p=>p.cat))];
const box = document.getElementById("cats-container");

box.innerHTML = cats.map(c=>`
<div onclick="filterCat('${c}')" class="cat-pill ${activeCat===c?'active':'text-slate-400'}">
${c==="all"?t.all:c}
</div>
`).join("");
}

function filterCat(c){
activeCat=c;
renderCats();
renderProducts();
}

/* ===============================
   PRODUCTS GRID
================================ */
function renderProducts(){
const list = activeCat==="all" ? PRODUCTS : PRODUCTS.filter(p=>p.cat===activeCat);
const grid = document.getElementById("products-grid");

grid.innerHTML = list.map(p=>{
const name = lang==="ar" ? p.name_ar : p.name_he;
return `
<div class="product-card">
<div class="h-44 bg-white/5 flex items-center justify-center p-5 relative">
<img src="${p.img}" class="h-full object-contain drop-shadow-2xl hover:scale-110 transition duration-500">
</div>

<div class="p-4 text-center flex-1 flex flex-col justify-between">
<div>
<h3 class="text-base font-bold text-white mb-2">${name}</h3>
<p class="text-amber-500 font-black text-lg mb-2">${p.price} ₪</p>
</div>

<button onclick="askAvailability('${name}')" class="ask-btn">
${TEXTS[lang].ask}
</button>
</div>
</div>
`;
}).join("");
}

/* ===============================
   WHATSAPP AVAILABILITY
================================ */
function askAvailability(product){

if(!BRANCH || !BRANCH.phone){
alert("Branch phone not found");
return;
}

let msg = lang==="ar"
? `مرحبا، أريد الاستفسار عن توفر هذا المنتج في فرعكم:\n${product}`
: `שלום, אני רוצה לבדוק זמינות למוצר:\n${product}`;

const phone = "972"+BRANCH.phone.substring(1);

window.open(`https://wa.me/${phone}?text=${encodeURIComponent(msg)}`,"_blank");
}

/* ===============================
   START
================================ */
initStore();
</script>

</body>
</html>
