<!DOCTYPE html>
<html lang="he" dir="rtl">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width,initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
<title>MAD Parfumeur | Elite Portal</title>

<!-- PERFORMANCE -->
<link rel="preload" href="logo.svg" as="image">
<link rel="preload" href="heder.svg" as="image">

<style>
:root{
  --blue:#2563eb;
  --ice:#f5f9ff;
  --card:#ffffff;
  --border:#e5e7eb;
  --text:#0f172a;
  --muted:#64748b;
  --wa:#25D366;
}

*{box-sizing:border-box;margin:0;padding:0}
body{
  font-family: system-ui, -apple-system, Arial, sans-serif;
  background:var(--ice);
  color:var(--text);
  padding-bottom:90px;
}

/* HEADER */
header{
  background:#fff url("heder.svg") center/cover no-repeat;
  padding:30px 16px 50px;
  text-align:center;
}
header img{
  width:110px;
}

/* LANG */
.lang{
  position:absolute;
  top:12px;
  left:12px;
  font-size:13px;
}
.lang a{color:#fff;text-decoration:none;font-weight:700}

/* BRANCH */
.branch{
  background:var(--card);
  margin:-35px 12px 12px;
  border-radius:18px;
  padding:16px;
  box-shadow:0 10px 25px rgba(0,0,0,.08);
}
.branch h1{font-size:18px}
.status{
  margin-top:6px;
  font-size:13px;
  font-weight:700;
}
.open{color:#16a34a}
.closed{color:#dc2626}

/* CATEGORIES */
.cats{
  position:sticky;
  top:0;
  background:var(--ice);
  display:flex;
  gap:8px;
  padding:10px;
  overflow-x:auto;
}
.cats button{
  border:1px solid var(--border);
  background:#fff;
  padding:8px 14px;
  border-radius:999px;
  font-size:14px;
  white-space:nowrap;
}
.cats button.active{
  background:var(--blue);
  color:#fff;
  border-color:var(--blue);
}

/* PRODUCTS */
.grid{
  display:grid;
  grid-template-columns:repeat(2,1fr);
  gap:12px;
  padding:12px;
}
.card{
  background:#fff;
  border-radius:14px;
  border:1px solid var(--border);
  overflow:hidden;
}
.card img{
  width:100%;
  aspect-ratio:1/1;
  object-fit:cover;
}
.card div{
  padding:10px;
}
.card h3{
  font-size:14px;
  font-weight:700;
  height:2.4em;
  overflow:hidden;
}
.price{
  color:var(--blue);
  font-weight:900;
  margin-top:4px;
}

/* WHATSAPP */
.wa{
  position:fixed;
  bottom:0;
  left:0;
  width:100%;
  background:var(--wa);
  color:#fff;
  text-align:center;
  padding:16px;
  font-size:18px;
  font-weight:900;
  text-decoration:none;
}

/* POPUP */
.popup{
  position:fixed;
  inset:0;
  background:rgba(0,0,0,.7);
  display:none;
  align-items:center;
  justify-content:center;
  z-index:999;
}
.popup img{
  width:90%;
  max-width:360px;
  border-radius:16px;
}
.close{
  position:absolute;
  top:20px;
  left:20px;
  color:#fff;
  font-size:26px;
}
</style>
</head>

<body>

<header>
  <div class="lang">
    <a href="?lang=he">HE</a> | <a href="?lang=ar">AR</a>
  </div>
  <img src="logo.svg" alt="MAD">
</header>

<section class="branch">
  <h1 id="bname"></h1>
  <div id="bstatus" class="status"></div>
  <div id="bhours" style="font-size:13px;color:var(--muted)"></div>
</section>

<nav class="cats" id="cats"></nav>
<main class="grid" id="grid"></main>

<a id="wa" class="wa" href="#" target="_blank">WhatsApp Order</a>

<div class="popup" id="popup">
  <div class="close" onclick="popup(false)">✕</div>
  <img src="sale.svg">
</div>

<script>
const q=new URLSearchParams(location.search);
const lang=q.get("lang")||"he";
const branchID=parseInt(q.get("branch"))||1;

const TXT={
 he:{all:"הכל",open:"פתוח עכשיו",closed:"סגור כעת",wa:"הזמנה בוואטסאפ"},
 ar:{all:"الكل",open:"مفتوح الآن",closed:"مغلق حالياً",wa:"اطلب عبر واتساب"}
};

document.documentElement.lang=lang;
document.documentElement.dir="rtl";

let STATE={branch:null,products:[]};

async function init(){
 const [bj,pc]=await Promise.all([
  fetch("branches.json").then(r=>r.json()),
  fetch("products.csv").then(r=>r.text())
 ]);
 STATE.branch=bj.branches.find(b=>b.id===branchID)||bj.branches[0];
 parseProducts(pc);
 renderBranch();
 renderCats();
 renderGrid("all");
 setTimeout(()=>popup(true),3000);
}

function renderBranch(){
 const b=STATE.branch,t=TXT[lang];
 document.getElementById("bname").textContent=(lang==="ar"?b.name_ar:b.name_he);
 document.getElementById("bhours").textContent=b.hours||"";
 document.getElementById("wa").href=`https://api.whatsapp.com/send/?phone=972${b.phone.substring(1)}`;
 document.getElementById("wa").textContent=t.wa;
 updateStatus();
}

function updateStatus(){
 const b=STATE.branch,t=TXT[lang];
 const now=new Date();
 const days=["sun","mon","tue","wed","thu","fri","sat"];
 const d=days[now.getDay()];
 const m=now.getHours()*60+now.getMinutes();
 let open=false;
 (b.schedule?.[d]||[]).forEach(s=>{
  const a=s[0].split(":").map(Number);
  const z=s[1].split(":").map(Number);
  if(m>=a[0]*60+a[1] && m<z[0]*60+z[1]) open=true;
 });
 const el=document.getElementById("bstatus");
 el.textContent=open?t.open:t.closed;
 el.className="status "+(open?"open":"closed");
}

function parseProducts(text){
 const lines=text.split("\n");
 const cIdx=lang==="ar"?11:10;
 for(let i=1;i<lines.length;i++){
  const c=lines[i].split(/,(?=(?:(?:[^"]*"){2})*[^"]*$)/);
  if(!c[0]) continue;
  STATE.products.push({
   name:c[0].replace(/"/g,"").trim(),
   img:c[3]?.trim()||"logo.svg",
   price:c[9]?.replace(/[^\d]/g,"")+" ₪",
   cat:c[cIdx]?.trim()||""
  });
 }
}

function renderCats(){
 const box=document.getElementById("cats");
 const cats=[...new Set(STATE.products.map(p=>p.cat))].filter(Boolean);
 box.innerHTML=`<button class="active" onclick="filter('all',this)">${TXT[lang].all}</button>`+
 cats.map(c=>`<button onclick="filter('${c}',this)">${c}</button>`).join("");
}

function filter(c,el){
 document.querySelectorAll(".cats button").forEach(b=>b.classList.remove("active"));
 el.classList.add("active");
 renderGrid(c);
}

function renderGrid(f){
 const g=document.getElementById("grid"); g.innerHTML="";
 (f==="all"?STATE.products:STATE.products.filter(p=>p.cat===f))
 .forEach(p=>{
  g.innerHTML+=`
  <div class="card">
   <img src="${p.img}" loading="lazy" onerror="this.src='logo.svg'">
   <div>
    <h3>${p.name}</h3>
    <div class="price">${p.price}</div>
   </div>
  </div>`;
 });
}

function popup(s){document.getElementById("popup").style.display=s?"flex":"none";}

init();
</script>
</body>
</html>
