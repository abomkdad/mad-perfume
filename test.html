<!DOCTYPE html>
<html lang="he">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width,initial-scale=1.0">
<title>MAD PARFUMEUR | Official Branch Page</title>

<link href="https://fonts.googleapis.com/css2?family=Cinzel:wght@700&family=Assistant:wght@400;700&display=swap" rel="stylesheet">
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">

<script>
!function(f,b,e,v,n,t,s){if(f.fbq)return;n=f.fbq=function(){n.callMethod?
n.callMethod.apply(n,arguments):n.queue.push(arguments)};
if(!f._fbq)f._fbq=n;n.push=n;n.loaded=!0;n.version='2.0';
n.queue=[];t=b.createElement(e);t.async=!0;
t.src=v;s=b.getElementsByTagName(e)[0];
s.parentNode.insertBefore(t,s)}(window,document,'script',
'https://connect.facebook.net/en_US/fbevents.js');
fbq('init','1072283127290819'); fbq('track','PageView');
</script>

<script>
!function (w, d, t) {
  w.TiktokAnalyticsObject=t;
  var ttq=w[t]=w[t]||[];
  ttq.methods=["page","track"];
  ttq.setAndDefer=function(t,e){
    t[e]=function(){
      t.push([e].concat(Array.prototype.slice.call(arguments,0)))
    }
  };
  for(var i=0;i<ttq.methods.length;i++){
    ttq.setAndDefer(ttq,ttq.methods[i]);
  }
  ttq.load=function(e){
    var i=d.createElement("script");
    i.async=!0;
    i.src="https://analytics.tiktok.com/i18n/pixel/events.js?sdkid="+e;
    var s=d.getElementsByTagName("script")[0];
    s.parentNode.insertBefore(i,s);
  };
  ttq.load("D2D02JBC77U4ENLN9SBG");
  ttq.page();
}(window, document, 'ttq');
</script>

<style>
:root{ --gold:#D4AF37; --black:#000; --card:#111; --white:#fff; --wa:#25D366; }
*{box-sizing:border-box; margin:0; padding:0}
body{background:#000; color:#fff; font-family:'Assistant', sans-serif; opacity:0; transition: opacity 0.5s;}

header{text-align:center; padding:30px; border-bottom:1px solid #222}
.logo{font-family:'Cinzel'; color:var(--gold); font-size:2.2rem; letter-spacing:4px}
.branch-name{margin-top:10px; font-size:1.3rem; font-weight:700}
.hours-text{font-size:0.9rem; margin-top:5px; opacity:0.8}

.status{display:inline-block; margin-top:10px; padding:4px 14px; border-radius:20px; font-size:.8rem; font-weight:700}
.open{color:#25D366; border:1px solid #25D366}
.closed{color:#ff4d4d; border:1px solid #ff4d4d}

.social-nav{display:flex; justify-content:center; gap:18px; margin-top:20px}
.social-nav a{color:#fff; font-size:1.4rem; transition:0.3s; opacity:0.8}
.social-nav a:hover{color:var(--gold); opacity:1; transform:translateY(-3px)}

.cats{display:flex; gap:8px; overflow-x:auto; padding:10px; border-bottom:1px solid #222; scrollbar-width:none}
.cats::-webkit-scrollbar{display:none}
.cats button{background:#111; color:#fff; border:1px solid #333; padding:8px 20px; border-radius:4px; cursor:pointer; white-space:nowrap}
.cats button.active{background:var(--gold); color:#000; font-weight:700}

.grid{display:grid; grid-template-columns:repeat(2,1fr); gap:12px; padding:15px}
@media(min-width:768px){.grid{grid-template-columns:repeat(4,1fr); gap:20px}}

.card{background:#111; border:1px solid #222; display:flex; flex-direction:column; border-radius:4px; overflow:hidden}
.img{aspect-ratio:1/1; overflow:hidden}
.img img{width:100%; height:100%; object-fit:cover; opacity:0; transition:.3s}
.img img.loaded{opacity:1}
.info{text-align:center; padding:15px}
.name{font-family:'Cinzel'; font-size:.9rem; height:2.6em; overflow:hidden}
.price{color:var(--gold); margin:10px 0; font-weight:700; font-size:1.1rem}
.wa{background:var(--wa); color:#fff; text-decoration:none; padding:12px; font-weight:700; border-radius:4px; display:block}

#popup{position:fixed; inset:0; background:rgba(0,0,0,.92); display:none; align-items:center; justify-content:center; z-index:9999; padding:20px}
.pbox{width:100%; max-width:400px; border:1px solid var(--gold); position:relative; background:#000; border-radius:4px; overflow:hidden}
.pclose{position:absolute; top:-45px; right:0; font-size:2.5rem; color:#fff; cursor:pointer}
.ptimer{background:var(--gold); color:#000; font-weight:900; padding:12px; text-align:center; font-size:1.2rem}
.pwa{display:block; background:var(--wa); color:#fff; padding:18px; text-align:center; font-weight:900; text-decoration:none; font-size:1.2rem}
</style>
</head>

<body>

<header>
  <div class="logo">MAD PARFUMEUR</div>
  <div id="br-name" class="branch-name"></div>
  <div id="br-hours" class="hours-text"></div>
  <div id="br-status"></div>
  <div id="br-social" class="social-nav"></div>
</header>

<nav id="cats" class="cats"></nav>
<main id="grid" class="grid"></main>

<div id="popup">
  <div class="pbox">
    <span class="pclose" onclick="closePop()">×</span>
    <img src="sale.png" style="width:100%; display:block;" alt="Special Offer">
    <div id="timer" class="ptimer">00:00:00</div>
    <a id="pwa-offer" class="pwa" target="_blank"></a>
  </div>
</div>

<script>
/** Configuration & State **/
const params = new URLSearchParams(window.location.search);
const branchID = params.get('branch') || '1'; 
const lang = navigator.language.startsWith('ar') ? 'ar' : 'he';
document.documentElement.dir = (lang === 'ar' ? 'rtl' : 'ltr');

const TXT = {
  he: { 
    open:'פתוח עכשיו', closed:'סגור כעת', all:'הכל', order:'הזמנה ב-WhatsApp', 
    msg:'היי, אני מעוניין בבושם: ', claimOffer: 'קבלת ההטבה עכשיו' 
  },
  ar: { 
    open:'مفتوح الآن', closed:'مغلق حالياً', all:'الكل', order:'طلب عبر واتساب', 
    msg:'مرحباً، أنا مهتم بمنتج: ', claimOffer: 'احصل على العرض الآن' 
  }
};

let STATE = { branch: null, products: [] };

/** Tracking Utility **/
function lead(action, label) {
  if(window.fbq) fbq('track', 'Lead', { branch: branchID, action, label });
  if(window.ttq) ttq.track('SubmitForm', { branch: branchID, action, label });
}

/** Robust CSV Parser **/
function parseCSV(text) {
  const lines = text.split('\n');
  for(let i=1; i<lines.length; i++){
    const c = lines[i].split(/,(?=(?:(?:[^"]*"){2})*[^"]*$)/);
    if(!c[1]) continue;
    STATE.products.push({
      title: c[1].replace(/"/g,''),
      img: c[4],
      price: c[10],
      cat: c[11]
    });
  }
}

/** UI Rendering **/
function renderUI() {
  const b = STATE.branch;
  const t = TXT[lang];

  // Header
  document.getElementById('br-name').textContent = b[`name_${lang}`];
  document.getElementById('br-hours').textContent = b.hours || '';

  [cite_start]// Calculate Open/Closed Status [cite: 1]
  const now = new Date();
  const d = ['sun','mon','tue','wed','thu','fri','sat'][now.getDay()];
  const mins = now.getHours()*60 + now.getMinutes();
  const isOpen = b.schedule[d]?.some(r => {
    const start = r[0].split(':'), end = r[1].split(':');
    return mins >= (+start[0]*60 + +start[1]) && mins < (+end[0]*60 + +end[1]);
  });
  document.getElementById('br-status').innerHTML = `<span class="status ${isOpen?'open':'closed'}">${isOpen?t.open:t.closed}</span>`;

  [cite_start]// Social Icons Fixed [cite: 1]
  const socialEl = document.getElementById('br-social');
  const icons = { 
    tiktok: 'fa-brands fa-tiktok', 
    instagram: 'fa-brands fa-instagram', 
    facebook: 'fa-brands fa-facebook', 
    snapchat: 'fa-brands fa-snapchat', 
    waze: 'fa-brands fa-waze', 
    email: 'fa-solid fa-envelope', 
    youtube: 'fa-brands fa-youtube' 
  };
  
  Object.entries(b.social).forEach(([key, url]) => {
    if(url && icons[key]) {
      const a = document.createElement('a');
      a.href = (key === 'email') ? `mailto:${url}` : url;
      a.target = "_blank";
      a.innerHTML = `<i class="${icons[key]}"></i>`;
      a.onclick = () => lead('social_click', key);
      socialEl.appendChild(a);
    }
  });

  renderCats();
  renderGrid('all');
  initPopup();
  document.body.style.opacity = "1";
}

function renderCats() {
  const t = TXT[lang];
  const cats = [t.all, ...new Set(STATE.products.map(p => p.cat))].filter(Boolean);
  const nav = document.getElementById('cats');
  cats.forEach(c => {
    const btn = document.createElement('button');
    btn.textContent = c;
    btn.className = (c === t.all) ? 'active' : '';
    btn.onclick = () => {
      document.querySelectorAll('.cats button').forEach(x => x.classList.remove('active'));
      btn.classList.add('active');
      renderGrid(c === t.all ? 'all' : c);
    };
    nav.appendChild(btn);
  });
}

function renderGrid(f) {
  const g = document.getElementById('grid'); g.innerHTML = '';
  const t = TXT[lang];
  const list = (f === 'all') ? STATE.products : STATE.products.filter(p => p.cat === f);
  
  const obs = new IntersectionObserver(entries => {
    entries.forEach(e => { 
      if(e.isIntersecting){ 
        e.target.src = e.target.dataset.src; 
        e.target.onload = () => e.target.classList.add('loaded'); 
        obs.unobserve(e.target);
      } 
    });
  });

  list.forEach(p => {
    const card = document.createElement('div');
    card.className = 'card';
    card.innerHTML = `
      <div class="img"><img data-src="${p.img}" alt="${p.title}"></div>
      <div class="info">
        <div class="name">${p.title}</div>
        <div class="price">${p.price}</div>
        <a class="wa" target="_blank" href="https://wa.me/${STATE.branch.phone}?text=${encodeURIComponent(t.msg+p.title)}" onclick="lead('wa_order','${p.title}')">${t.order}</a>
      </div>`;
    g.appendChild(card);
    obs.observe(card.querySelector('img'));
  });
}

/** Popup Logic (Daily Offer) **/
function initPopup() {
  const key = 'mad_pop_' + new Date().toDateString();
  if(localStorage.getItem(key)) return;

  setTimeout(() => {
    const t = TXT[lang];
    document.getElementById('popup').style.display = 'flex';
    
    const pwa = document.getElementById('pwa-offer');
    pwa.textContent = t.claimOffer;
    pwa.href = `https://wa.me/${STATE.branch.phone}?text=${encodeURIComponent(lang === 'ar' ? 'أريد العرض اليومي' : 'היי، אשמח לקבל את ההטבה היומית')}`;
    pwa.onclick = () => lead('popup_offer_click', 'daily_sale');

    setInterval(() => {
      const d = new Date().setHours(23,59,59) - new Date();
      const h = Math.floor(d/3600000).toString().padStart(2,'0');
      const m = Math.floor((d%3600000)/60000).toString().padStart(2,'0');
      const s = Math.floor((d%60000)/1000).toString().padStart(2,'0');
      document.getElementById('timer').textContent = `${h}:${m}:${s}`;
    }, 1000);
  }, 3000);
}

function closePop() {
  document.getElementById('popup').style.display = 'none';
  localStorage.setItem('mad_pop_' + new Date().toDateString(), '1');
  lead('popup_close', 'daily_offer');
}

/** Bootstrap **/
async function start() {
  try {
    const [bj, pc] = await Promise.all([
      fetch('test.json').then(r => r.json()),
      fetch('products.csv').then(r => r.text())
    ]);

    STATE.branch = bj.branches.find(b => b.id == branchID) || bj.branches[0];
    parseCSV(pc);
    renderUI();
  } catch (e) { console.error("Error loading data", e); }
}

start();
</script>

</body>
</html>
