<!DOCTYPE html>
<html lang="he">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width,initial-scale=1.0">
<title>MAD PARFUMEUR | Official Branch</title>

<link href="https://fonts.googleapis.com/css2?family=Cinzel:wght@700&family=Assistant:wght@400;700&display=swap" rel="stylesheet">
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">

<style>
:root{ --gold:#D4AF37; --black:#000; --wa:#25D366; --live-red:#ff0000; }
*{box-sizing:border-box; margin:0; padding:0}
body{background:#000; color:#fff; font-family:'Assistant', sans-serif; opacity:0; transition: opacity 0.5s;}

/* Header & Background */
header{
    position: relative; text-align:center; padding: 50px 20px;
    background: linear-gradient(rgba(0,0,0,0.7), rgba(0,0,0,0.8)), url('header.jpg') center/cover;
    border-bottom: 2px solid var(--gold);
}
.logo-img { max-width: 180px; margin-bottom: 15px; filter: drop-shadow(0 0 10px rgba(0,0,0,0.5)); }
.branch-name{font-size:1.8rem; font-weight:700; text-shadow: 2px 2px 8px #000;}

/* Live Staff Section */
.duty-container { display: flex; flex-direction: column; align-items: center; margin: 25px 0; }
.staff-wrapper { position: relative; width: 85px; height: 85px; }
.staff-img { width: 100%; height: 100%; border-radius: 50%; border: 2px solid var(--gold); object-fit: cover; box-shadow: 0 0 15px rgba(212, 175, 55, 0.4); }

/* Live Indicator Overlay */
.live-indicator {
    position: absolute; bottom: 0; right: 0; background: var(--live-red); color: #fff;
    font-size: 9px; font-weight: 900; padding: 2px 6px; border-radius: 4px;
    display: flex; align-items: center; gap: 3px; border: 1.5px solid #000;
}
.pulse-dot {
    width: 5px; height: 5px; background: #fff; border-radius: 50%;
    animation: blink 1.2s infinite;
}
@keyframes blink { 0% { opacity: 1; } 50% { opacity: 0.3; } 100% { opacity: 1; } }

.duty-btn { background: var(--wa); color: #fff; text-decoration: none; padding: 10px 22px; border-radius: 50px; font-weight: 700; display: flex; align-items: center; gap: 8px; transition: 0.3s; margin-top: 12px; font-size: 0.9rem; }

/* Social Icons */
.social-nav{display:flex; justify-content:center; gap:18px; margin-top:15px}
.social-nav a{color:#fff; font-size:1.5rem; transition:0.3s; opacity: 0.8;}
.social-nav a:hover{color:var(--gold); opacity: 1; transform: scale(1.1);}

/* Rest of the styles... (Categories, Grid, etc.) */
.cats-wrapper { position: sticky; top: 0; background: rgba(0,0,0,0.9); z-index: 100; border-bottom: 1px solid #222; backdrop-filter: blur(10px); }
.cats{display:flex; gap:10px; overflow-x:auto; padding:12px; scrollbar-width:none;}
.cats::-webkit-scrollbar{display:none}
.cats button{ background: #111; color: #ccc; border: 1px solid #333; padding: 10px 24px; border-radius: 50px; cursor: pointer; white-space: nowrap; transition: 0.3s; }
.cats button.active{background: var(--gold); color: #000; border-color: var(--gold); font-weight: 700;}
.grid{display:grid; grid-template-columns:repeat(2,1fr); gap:12px; padding:15px}
@media(min-width:768px){.grid{grid-template-columns:repeat(4,1fr); gap:20px}}
.card{background:#111; border:1px solid #222; border-radius:10px; overflow:hidden;}
.img img{width:100%; aspect-ratio:1/1; object-fit:cover; opacity:0; transition:.5s}
.img img.loaded{opacity:1}
.info{padding:15px; text-align:center}
.price{color:var(--gold); font-weight:700; margin:10px 0; font-size: 1.2rem}
.wa-btn{background:var(--wa); color:#fff; text-decoration:none; padding:12px; font-weight:700; border-radius:8px; display:block;}
#popup{position:fixed; inset:0; background:rgba(0,0,0,.95); display:none; align-items:center; justify-content:center; z-index:9999; padding:20px}
.pbox{width:100%; max-width:400px; border:1px solid var(--gold); background:#000; border-radius:15px; overflow:hidden; position: relative;}
.pclose{position:absolute; top:10px; right:15px; font-size:2.5rem; color:#fff; cursor:pointer; z-index: 10;}
.ptimer{background:var(--gold); color:#000; font-weight:900; padding:15px; text-align:center; font-size:1.2rem}
.pwa{display:block; background:var(--wa); color:#fff; padding:20px; text-align:center; font-weight:900; text-decoration:none; font-size:1.3rem}
</style>
</head>

<body dir="rtl">

<header>
    <img src="logo.png" alt="MAD" class="logo-img">
    <div id="br-name" class="branch-name"></div>
    <div id="br-hours" style="font-size:0.9rem; margin:5px 0 15px; opacity:0.8;"></div>
    
    <div class="duty-container">
        <div class="staff-wrapper">
            <img src="https://madperfume.ps/upload/01-2026/page/6966930e9af7f.png" class="staff-img">
            <div class="live-indicator">
                <div class="pulse-dot"></div> LIVE
            </div>
        </div>
        <a id="duty-link" class="duty-btn" target="_blank">
            <i class="fab fa-whatsapp"></i> <span id="duty-text"></span>
        </a>
    </div>

    <div id="br-social" class="social-nav"></div>
</header>

<div class="cats-wrapper"><nav id="cats" class="cats"></nav></div>
<main id="grid" class="grid"></main>

<div id="popup">
    <div class="pbox">
        <span class="pclose" onclick="closePop()">×</span>
        <img src="sale.png" style="width:100%; display:block">
        <div id="timer" class="ptimer">00:00:00</div>
        <a id="pwa-offer" class="pwa" target="_blank"></a>
    </div>
</div>

<script>
const params = new URLSearchParams(window.location.search);
const branchID = parseInt(params.get('branch')) || 1; 
const lang = navigator.language.startsWith('ar') ? 'ar' : 'he';

const TXT = {
    he: { open:'פתוח עכשיו', closed:'סגור כעת', all:'הכל', order:'הזמנה', msg:'היי, אני מעוניין ב: ', offer:'קבלת ההטבה', duty:'המנהל בתורנות' },
    ar: { open:'مفتوح الآن', closed:'مغلق حالياً', all:'الكل', order:'طلب', msg:'مرحباً، أنا مهتم بـ: ', offer:'احصل على العرض', duty:'الموظف المناوب' }
};

let STATE = { branch: null, products: [] };

function trackLead(action, label) {
    if(window.fbq) fbq('track', 'Lead', { branch: branchID, action, label });
}

async function start() {
    try {
        const [bj, pc] = await Promise.all([
            fetch('test.json').then(r => r.json()),
            fetch('products.csv').then(r => r.text())
        ]);
        STATE.branch = bj.branches.find(b => b.id === branchID) || bj.branches[0];
        parseCSV(pc);
        renderUI();
    } catch (e) { console.error(e); }
}

function parseCSV(text) {
    const lines = text.split('\n');
    for(let i=1; i<lines.length; i++){
        const c = lines[i].split(/,(?=(?:(?:[^"]*"){2})*[^"]*$)/);
        if(!c[1]) continue;
        STATE.products.push({ 
            title: c[1].replace(/"/g,'').trim(), 
            img: c[4], 
            price: c[10].replace('ILS', '').trim() + ' ₪', 
            cat: c[11] 
        });
    }
}

function renderUI() {
    const b = STATE.branch; const t = TXT[lang];
    document.getElementById('br-name').textContent = b[`name_${lang}`];
    document.getElementById('br-hours').textContent = b.hours;
    document.getElementById('duty-text').textContent = t.duty;
    document.getElementById('duty-link').href = `https://wa.me/${b.phone}?text=${encodeURIComponent(t.duty)}`;

    const socialEl = document.getElementById('br-social');
    const icons = { 
        tiktok:'fa-brands fa-tiktok', 
        instagram:'fa-brands fa-instagram', 
        facebook:'fa-brands fa-facebook', 
        snapchat:'fa-brands fa-snapchat', 
        waze:'fa-brands fa-waze', 
        email:'fa-solid fa-envelope',
        youtube:'fa-brands fa-youtube' // تفعيل أيقونة اليوتيوب
    };

    Object.entries(b.social).forEach(([k, v]) => {
        if(v && icons[k]){
            const a = document.createElement('a');
            a.href = k==='email'?'mailto:'+v:v; a.target="_blank";
            a.innerHTML = `<i class="${icons[k]}"></i>`;
            a.onclick = () => trackLead('Social_Click', k);
            socialEl.appendChild(a);
        }
    });

    renderCats(); renderGrid('all'); initPopup();
    document.body.style.opacity = "1";
}

function renderCats() {
    const t = TXT[lang];
    const cats = [t.all, ...new Set(STATE.products.map(p => p.cat))].filter(Boolean);
    const nav = document.getElementById('cats');
    cats.forEach(c => {
        const btn = document.createElement('button');
        btn.textContent = c; btn.className = c === t.all ? 'active' : '';
        btn.onclick = (e) => {
            document.querySelectorAll('.cats button').forEach(b => b.classList.remove('active'));
            e.target.classList.add('active');
            renderGrid(c === t.all ? 'all' : c);
        };
        nav.appendChild(btn);
    });
}

function renderGrid(f) {
    const g = document.getElementById('grid'); g.innerHTML = ''; const t = TXT[lang];
    const list = f === 'all' ? STATE.products : STATE.products.filter(p => p.cat === f);
    const obs = new IntersectionObserver(es => {
        es.forEach(e => { if(e.isIntersecting){ e.target.src = e.target.dataset.src; e.target.onload = () => e.target.classList.add('loaded'); } });
    });
    list.forEach(p => {
        const d = document.createElement('div'); d.className = 'card';
        d.innerHTML = `<div class="img"><img data-src="${p.img}"></div>
            <div class="info"><div style="font-size:0.85rem; height:2.5em; overflow:hidden;">${p.title}</div><div class="price">${p.price}</div>
            <a class="wa-btn" target="_blank" href="https://wa.me/${STATE.branch.phone}?text=${encodeURIComponent(t.msg+p.title)}" onclick="trackLead('Product_Order', '${p.title}')">${t.order}</a></div>`;
        g.appendChild(d); obs.observe(d.querySelector('img'));
    });
}

function initPopup() {
    if(localStorage.getItem('mad_pop_'+new Date().toDateString())) return;
    setTimeout(() => {
        const t = TXT[lang]; document.getElementById('popup').style.display = 'flex';
        const pwa = document.getElementById('pwa-offer'); pwa.textContent = t.offer;
        pwa.href = `https://wa.me/${STATE.branch.phone}?text=Offer`;
        pwa.onclick = () => trackLead('Popup_Offer_Click', 'Sale');
        setInterval(() => {
            const diff = new Date().setHours(23,59,59) - new Date();
            const h = Math.floor(diff/3600000).toString().padStart(2,'0');
            const m = Math.floor((diff%3600000)/60000).toString().padStart(2,'0');
            const s = Math.floor((diff%60000)/1000).toString().padStart(2,'0');
            document.getElementById('timer').textContent = `${h}:${m}:${s}`;
        }, 1000);
    }, 3000);
}

function closePop() { document.getElementById('popup').style.display = 'none'; localStorage.setItem('mad_pop_'+new Date().toDateString(), '1'); }

start();
</script>
</body>
</html>
