<!doctype html>
<html lang="ar" dir="rtl">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width,initial-scale=1">
  <title>MAD Manager v5.0</title>
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
  <style>
    :root { --bg: #0a0f1e; --card: #161b2c; --primary: #3b82f6; --text: #f8fafc; --border: rgba(255,255,255,0.08); }
    body { margin: 0; font-family: 'Segoe UI', sans-serif; background: var(--bg); color: var(--text); direction: rtl; }
    .header { background: #111827; padding: 15px; position: sticky; top: 0; z-index: 100; border-bottom: 1px solid var(--border); display: flex; justify-content: space-between; align-items: center; }
    .container { padding: 15px; max-width: 600px; margin: 0 auto; }
    .order-card { background: var(--card); border-radius: 20px; padding: 20px; margin-bottom: 20px; border: 1px solid var(--border); box-shadow: 0 10px 20px rgba(0,0,0,0.2); }
    .status-badge { font-size: 11px; padding: 4px 10px; border-radius: 10px; background: rgba(59,130,246,0.1); color: var(--primary); font-weight: bold; }
    .btn-group { display: grid; grid-template-columns: 1fr 1fr; gap: 10px; margin-top: 15px; }
    .btn { padding: 12px; border-radius: 12px; border: none; cursor: pointer; display: flex; align-items: center; justify-content: center; gap: 8px; font-weight: bold; font-size: 13px; transition: 0.3s; }
    .btn-delivery { background: #2563eb; color: white; width: 100%; margin-top: 10px; }
    .btn-whatsapp { background: #10b981; color: white; }
    .btn-refresh { background: #374151; color: white; }
    #loader { position: fixed; inset: 0; background: rgba(0,0,0,0.8); display: none; align-items: center; justify-content: center; z-index: 1000; }
    .spinner { width: 40px; height: 40px; border: 4px solid #3b82f6; border-top-color: transparent; border-radius: 50%; animation: spin 1s infinite; }
    @keyframes spin { to { transform: rotate(360deg); } }
  </style>
</head>
<body>

<div id="loader"><div class="spinner"></div></div>

<div class="header">
  <strong>Ù„ÙˆØ­Ø© Ø¥Ø¯Ø§Ø±Ø© MAD 5.0</strong>
  <button class="btn btn-refresh" onclick="fetchOrders()"><i class="fa fa-sync"></i> ØªØ­Ø¯ÙŠØ«</button>
</div>

<div class="container" id="ordersContainer"></div>

<script>
  const SCRIPT_URL = "Ø¶Ø¹_Ø±Ø§Ø¨Ø·_Ø§Ù„Ø³ÙƒØ±Ø¨Øª_Ù‡Ù†Ø§";

  async function fetchOrders() {
    document.getElementById('loader').style.display = 'flex';
    try {
      const response = await fetch(`${SCRIPT_URL}?action=get&_=${Date.now()}`);
      const data = await response.json();
      renderOrders(data);
    } catch (e) { alert("Ø®Ø·Ø£ ÙÙŠ Ø¬Ù„Ø¨ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª"); }
    document.getElementById('loader').style.display = 'none';
  }

  function renderOrders(orders) {
    const container = document.getElementById('ordersContainer');
    container.innerHTML = orders.filter(o => o.rowIndex).reverse().map(o => `
      <div class="order-card">
        <div style="display:flex; justify-content:space-between; align-items:center;">
          <small style="color:var(--muted)">#${o.orderId}</small>
          <span class="status-badge">${o.status || 'Ø¬Ø¯ÙŠØ¯'}</span>
        </div>
        <h2 style="margin:10px 0 5px 0; font-size:18px;">${o.name}</h2>
        <div style="color:#94a3b8; font-size:14px;">ğŸ“ ${o.city} | â‚ª${o.price}</div>
        <div style="margin-top:10px; font-size:13px; border-top:1px solid var(--border); padding-top:10px;">
          <strong>Ø§Ù„Ø£ØµÙ†Ø§Ù:</strong> ${o.offer}
        </div>
        
        <button class="btn btn-delivery" onclick="sendToDelivery(${o.rowIndex})">
          <i class="fa fa-paper-plane"></i> Ø¥Ø±Ø³Ø§Ù„ Ù„Ø´Ø±ÙƒØ© Ø§Ù„ØªÙˆØµÙŠÙ„
        </button>
        
        <div class="btn-group">
          <button class="btn btn-whatsapp" onclick="window.open('https://wa.me/${o.phone}')">
            <i class="fa-brands fa-whatsapp"></i> ÙˆØ§ØªØ³Ø§Ø¨ Ø§Ù„Ø¹Ù…ÙŠÙ„
          </button>
          <button class="btn btn-refresh" onclick="alert('Ù…Ù„Ø§Ø­Ø¸Ø§Øª: ${o.notes}')">
            <i class="fa fa-info-circle"></i> Ù…Ù„Ø§Ø­Ø¸Ø§Øª
          </button>
        </div>
      </div>
    `).join('');
  }

  async function sendToDelivery(row) {
    if(!confirm("Ø³ÙŠØªÙ… Ø¥Ø±Ø³Ø§Ù„ ØªÙØ§ØµÙŠÙ„ Ø§Ù„Ø·Ù„Ø¨ Ù„Ø´Ø±ÙƒØ© Ø§Ù„ØªÙˆØµÙŠÙ„ Ø¹Ø¨Ø± APIØŒ Ù‡Ù„ Ø£Ù†Øª Ù…ØªØ£ÙƒØ¯ØŸ")) return;
    document.getElementById('loader').style.display = 'flex';
    const res = await fetch(`${SCRIPT_URL}?action=sendToDelivery&row=${row}`);
    const result = await res.json();
    if(result.result === "SUCCESS") {
      alert("ğŸš€ ØªÙ… Ø§Ù„Ø¥Ø±Ø³Ø§Ù„ Ù„Ø´Ø±ÙƒØ© Ø§Ù„ØªÙˆØµÙŠÙ„ Ø¨Ù†Ø¬Ø§Ø­");
      fetchOrders();
    } else {
      alert("âŒ Ø®Ø·Ø£: " + result.message);
    }
    document.getElementById('loader').style.display = 'none';
  }

  window.onload = fetchOrders;
</script>
</body>
</html>
