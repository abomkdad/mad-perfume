<!DOCTYPE html>
<html lang="he" dir="rtl">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width,initial-scale=1.0,maximum-scale=1.0,user-scalable=no">
<title>MAD PARFUMEUR | Branch</title>

<link rel="preconnect" href="https://fonts.googleapis.com">
<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
<link href="https://fonts.googleapis.com/css2?family=Assistant:wght@400;700;800&family=Cinzel:wght@700;900&family=Cairo:wght@400;700;900&display=swap" rel="stylesheet">
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">

<!-- Meta Pixel -->
<script>
!function(f,b,e,v,n,t,s){if(f.fbq)return;n=f.fbq=function(){
n.callMethod?n.callMethod.apply(n,arguments):n.queue.push(arguments)};
if(!f._fbq)f._fbq=n;n.push=n;n.loaded=!0;n.version='2.0';
n.queue=[];t=b.createElement(e);t.async=!0;t.src=v;
s=b.getElementsByTagName(e)[0];s.parentNode.insertBefore(t,s)
}(window,document,'script','https://connect.facebook.net/en_US/fbevents.js');
fbq('init','1072283127290819');
fbq('track','PageView');
</script>

<!-- TikTok Pixel -->
<script>
!function (w,d,t) {
w.TiktokAnalyticsObject=t;var ttq=w[t]=w[t]||[];
ttq.methods=["page","track"];ttq.setAndDefer=function(t,e){
t[e]=function(){t.push([e].concat(Array.prototype.slice.call(arguments,0)))}};
for(var i=0;i<ttq.methods.length;i++)ttq.setAndDefer(ttq,ttq.methods[i]);
ttq.load=function(e){
var s=d.createElement("script");s.async=!0;
s.src="https://analytics.tiktok.com/i18n/pixel/events.js?sdkid="+e;
var x=d.getElementsByTagName("script")[0];x.parentNode.insertBefore(s,x)};
ttq.load('D2D02JBC77U4ENLN9SBG');ttq.page();
}(window,document,'ttq');

function trackLead(name){
if(window.fbq) fbq('track','Lead',{content_name:name});
if(window.ttq) ttq.track('Contact',{content_name:name});
}
</script>

<style>
:root{--gold:#D4AF37;--black:#080808;--wa:#25D366}
*{box-sizing:border-box;margin:0;padding:0}
body{background:var(--black);color:#fff;font-family:'Assistant','Cairo',sans-serif;padding-bottom:120px}

.top-wa{
background:var(--wa);color:#fff;
padding:14px;text-align:center;
font-weight:800;text-decoration:none;
display:block;position:sticky;top:0;z-index:10
}

header{text-align:center;padding:30px 15px;border-bottom:2px solid var(--gold)}
.logo{max-width:120px;margin-bottom:10px}
.branch{font-family:'Cinzel';color:var(--gold);font-size:1.6rem;font-weight:900}

.cats{display:flex;gap:10px;overflow-x:auto;padding:12px}
.cat{background:#111;border:1px solid #222;
border-radius:30px;padding:6px 16px;
white-space:nowrap;cursor:pointer}
.cat.active{background:var(--gold);color:#000}

.grid{display:grid;grid-template-columns:repeat(2,1fr);gap:12px;padding:12px}
.card{background:#111;border-radius:14px;overflow:hidden}
.card img{width:100%;aspect-ratio:1/1;object-fit:cover}
.info{padding:10px;text-align:center}
.price{color:var(--gold);font-weight:900;margin:6px 0}
.btn{background:var(--gold);color:#000;border:none;
padding:10px;width:100%;border-radius:8px;font-weight:900}
.btn.added{background:#333;color:#fff}

.cart{
position:fixed;bottom:0;left:0;width:100%;
background:#111;border-top:2px solid var(--gold);
padding:12px;display:flex;justify-content:space-between;align-items:center
}
</style>
</head>

<body>

<a id="waTop" class="top-wa" onclick="trackLead('Top WhatsApp')" target="_blank">
<i class="fab fa-whatsapp"></i> تواصل معنا عبر واتساب
</a>

<header>
<img src="logo.png" class="logo">
<div id="bName" class="branch"></div>
</header>

<div id="cats" class="cats"></div>
<div id="grid" class="grid"></div>

<div class="cart">
<div id="count">0 منتجات</div>
<button class="btn" onclick="sendOrder()">
<i class="fab fa-whatsapp"></i> إرسال الطلب
</button>
</div>

<script>
const lang=navigator.language.startsWith('ar')?'ar':'he';
const params=new URLSearchParams(location.search);
const branchID=parseInt(params.get('branch'))||1;

let STATE={branch:null,products:[],cart:[]};

async function init(){
const [b,p]=await Promise.all([
fetch('branches.json').then(r=>r.json()),
fetch('products.csv').then(r=>r.text())
]);
STATE.branch=b.branches.find(x=>x.id===branchID)||b.branches[0];
parseCSV(p);
render();
}

function parseCSV(t){
const lines=t.split('\n');
const catIdx=lang==='ar'?11:10;
for(let i=1;i<lines.length;i++){
const c=lines[i].split(/,(?=(?:(?:[^"]*"){2})*[^"]*$)/);
if(!c[0])continue;
STATE.products.push({
id:i,title:c[0].replace(/"/g,''),
img:c[3]||'logo.png',
price:c[9],
cat:c[catIdx]
});
}
}

function render(){
document.getElementById('bName').textContent=
(lang==='ar'?'فرع ':'סניף ')+(lang==='ar'?STATE.branch.name_ar:STATE.branch.name_he);
document.getElementById('waTop').href=
`https://api.whatsapp.com/send/?phone=972${STATE.branch.phone.substring(1)}`;

const cats=[...new Set(STATE.products.map(p=>p.cat).filter(Boolean))];
document.getElementById('cats').innerHTML=
['الكل',...cats].map(c=>
`<div class="cat" onclick="filter('${c}')">${c}</div>`).join('');

filter('الكل');
}

function filter(c){
document.querySelectorAll('.cat').forEach(x=>x.classList.remove('active'));
event.target.classList.add('active');
const list=c==='الكل'?STATE.products:STATE.products.filter(p=>p.cat===c);
document.getElementById('grid').innerHTML=list.map(p=>`
<div class="card">
<img src="${p.img}">
<div class="info">
<div>${p.title}</div>
<div class="price">${p.price}</div>
<button class="btn" onclick="add(${p.id},this)">إضافة</button>
</div></div>`).join('');
}

function add(id,btn){
if(STATE.cart.find(i=>i.id===id))return;
STATE.cart.push(STATE.products.find(p=>p.id===id));
btn.classList.add('added');btn.textContent='تم';
document.getElementById('count').textContent=STATE.cart.length+' منتجات';
}

function sendOrder(){
let msg='طلب جديد:\n';
STATE.cart.forEach((i,n)=>msg+=`${n+1}. ${i.title}\n`);
trackLead('Checkout');
open(`https://api.whatsapp.com/send/?phone=972${STATE.branch.phone.substring(1)}&text=${encodeURIComponent(msg)}`);
}

init();
</script>
</body>
</html>
