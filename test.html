<!DOCTYPE html>
<html lang="he" dir="rtl">
<head>

<meta charset="UTF-8">
<meta name="viewport" content="width=device-width,initial-scale=1.0">

<title>MAD PARFUMEUR | Elite Branch Portal</title>

<!-- PERFORMANCE -->
<link rel="preconnect" href="https://fonts.googleapis.com">
<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>

<link href="https://fonts.googleapis.com/css2?family=Cinzel:wght@700;900&family=Assistant:wght@400;700&family=Cairo:wght@400;700;900&display=swap" rel="stylesheet">
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">

<!-- META PIXEL -->
<script defer>
!function(f,b,e,v,n,t,s){
if(f.fbq)return;n=f.fbq=function(){
n.callMethod?n.callMethod.apply(n,arguments):n.queue.push(arguments)
};
if(!f._fbq)f._fbq=n;
n.push=n;n.loaded=!0;n.version='2.0';
n.queue=[];
t=b.createElement(e);t.async=!0;
t.src=v;
s=b.getElementsByTagName(e)[0];
s.parentNode.insertBefore(t,s)
}(window,document,'script','https://connect.facebook.net/en_US/fbevents.js');

fbq('init','1072283127290819');
fbq('track','PageView');
</script>

<!-- TIKTOK PIXEL -->
<script defer>
!function(w,d,t){
w.TiktokAnalyticsObject=t;
var ttq=w[t]=w[t]||[];
ttq.methods=["page","track"];
ttq.setAndDefer=function(t,e){
t[e]=function(){t.push([e].concat([].slice.call(arguments)))}
};
for(var i=0;i<ttq.methods.length;i++){
ttq.setAndDefer(ttq,ttq.methods[i]);
}
ttq.load=function(e){
var s=d.createElement("script");
s.async=true;
s.src="https://analytics.tiktok.com/i18n/pixel/events.js?sdkid="+e;
d.head.appendChild(s);
};
ttq.load('D2D02JBC77U4ENLN9SBG');
ttq.page();
}(window,document,'ttq');
</script>

<style>

/* ===== ROOT ===== */

:root{
--gold:#D4AF37;
--wa:#25D366;
--border:#e5e5e5;
}

/* ===== GLOBAL ===== */

*{
box-sizing:border-box;
margin:0;
padding:0;
touch-action:manipulation;
}

body{
font-family:Assistant,Cairo,sans-serif;
background:#fff;
color:#000;
padding-bottom:130px;
scroll-behavior:smooth;
-webkit-overflow-scrolling:touch;
}

/* ===== TOP BAR ===== */

.top-wa-bar{
background:var(--wa);
color:#fff;
padding:12px;
font-weight:800;
display:flex;
justify-content:center;
gap:8px;
text-decoration:none;
}

/* ===== HEADER ===== */

header{
padding:20px;
border-bottom:1px solid var(--border);
text-align:center;
}

.logo-img{width:120px}

.branch-title{
font-family:Cinzel;
font-size:22px;
color:var(--gold);
font-weight:900;
}

.open-status-text{
font-weight:700;
margin-top:5px;
}

/* ===== SOCIAL ===== */

.social-icons{
display:flex;
justify-content:center;
gap:12px;
margin-top:12px;
}

.social-icons a{
width:42px;
height:42px;
border-radius:50%;
display:flex;
align-items:center;
justify-content:center;
color:#fff;
font-size:18px;
}

.facebook{background:#1877F2}
.instagram{background:#E1306C}
.tiktok{background:#000}

/* ===== CATEGORIES ===== */

.cats-wrapper{
position:sticky;
top:0;
background:#fff;
border-bottom:1px solid var(--border);
z-index:1000;
}

.cats-container{
display:flex;
gap:10px;
padding:10px;
overflow-x:auto;
transform:translateZ(0);
will-change:transform;
}

.cat-pill{
border:1px solid var(--border);
border-radius:30px;
padding:6px 14px;
font-size:13px;
font-weight:700;
cursor:pointer;
white-space:nowrap;
}

.cat-pill.active{
background:var(--gold);
color:#000;
}

/* ===== GRID ===== */

.shop-grid{
display:grid;
grid-template-columns:repeat(2,1fr);
gap:12px;
padding:12px;
transform:translateZ(0);
will-change:transform;
}

.p-card{
border:1px solid var(--border);
border-radius:14px;
overflow:hidden;
background:#fff;
}

.p-card img{
width:100%;
aspect-ratio:1/1;
object-fit:cover;
}

.p-info{
padding:10px;
text-align:center;
}

.add-btn{
background:var(--gold);
border:none;
padding:10px;
border-radius:8px;
font-weight:800;
width:100%;
margin-top:6px;
cursor:pointer;
}

.add-btn.added{
background:#000;
color:#fff;
}

/* ===== SKELETON ===== */

.skeleton{
height:220px;
border-radius:14px;
background:linear-gradient(90deg,#eee 25%,#ddd 37%,#eee 63%);
background-size:400% 100%;
animation:skeleton 1.2s infinite;
}

@keyframes skeleton{
0%{background-position:100%}
100%{background-position:0}
}

/* ===== CART ===== */

#cart-fab{
position:fixed;
bottom:100px;
right:18px;
width:58px;
height:58px;
background:var(--gold);
border-radius:50%;
display:flex;
align-items:center;
justify-content:center;
font-size:20px;
z-index:2000;
cursor:pointer;
}

#cart-count{
position:absolute;
top:-6px;
right:-6px;
background:red;
color:#fff;
width:20px;
height:20px;
border-radius:50%;
font-size:11px;
display:flex;
align-items:center;
justify-content:center;
}

/* ===== DRAWER ===== */

.drawer{
position:fixed;
bottom:-100%;
left:0;
width:100%;
height:75%;
background:#fff;
border-top:3px solid var(--gold);
transition:.35s;
padding:15px;
display:flex;
flex-direction:column;
z-index:3000;
}

.drawer.open{bottom:0}

.checkout-btn{
background:var(--wa);
color:#fff;
border:none;
padding:16px;
border-radius:12px;
font-weight:900;
margin-top:12px;
}

.overlay{
position:fixed;
inset:0;
background:rgba(0,0,0,.6);
display:none;
z-index:2500;
}

.overlay.show{display:block}

</style>
</head>

<body>

<a id="top-wa-btn" class="top-wa-bar">
<i class="fab fa-whatsapp"></i>
<span id="top-wa-txt"></span>
</a>

<header>
<img src="logo.png" class="logo-img">
<div id="br-name" class="branch-title"></div>
<div id="open-status-display" class="open-status-text"></div>
<div id="br-social" class="social-icons"></div>
</header>

<div class="cats-wrapper">
<div id="cats-box" class="cats-container"></div>
</div>

<main id="main-grid" class="shop-grid"></main>

<div id="cart-fab" onclick="toggleCart(true)">
<i class="fas fa-shopping-bag"></i>
<div id="cart-count">0</div>
</div>

<div id="overlay" class="overlay" onclick="toggleCart(false)"></div>

<div id="cart-drawer" class="drawer">
<h2 id="cart-title"></h2>
<div id="cart-list" style="flex:1;overflow:auto"></div>
<div id="cart-total"></div>
<button class="checkout-btn" onclick="sendOrder()">
<i class="fab fa-whatsapp"></i>
<span id="check-txt"></span>
</button>
</div>

<script>

/* ===== SETTINGS ===== */

const params=new URLSearchParams(location.search);
const branchID=parseInt(params.get("branch"))||1;
const lang=navigator.language.startsWith("ar")?"ar":"he";
const LOW_RAM=navigator.deviceMemory && navigator.deviceMemory<4;

/* ===== TEXT ===== */

const TXT={
ar:{all:"الكل",add:"إضافة للسلة",added:"في السلة",check:"إرسال الطلب",cart:"سلة المشتريات",wa_top:"تواصل واتساب"},
he:{all:"הכל",add:"הוסף לסל",added:"בסל",check:"שליחת הזמנה",cart:"עגלה",wa_top:"צור קשר בוואטסאפ"}
};

/* ===== STATE ===== */

let STATE={
branch:null,
products:[],
cart:[],
view:[],
page:0,
chunk:LOW_RAM?10:20,
loading:false
};

/* ===== INIT ===== */

async function init(){

const bj=await fetch("branches.json").then(r=>r.json());
STATE.branch=bj.branches.find(b=>b.id===branchID)||bj.branches[0];

renderHeader();
updateBranchStatus();

const cached=localStorage.getItem("MAD_PRODUCTS");

if(cached){
STATE.products=JSON.parse(cached);
renderCats();
renderGrid("all");
}else{
const pc=await fetch("products.csv").then(r=>r.text());
parseData(pc);
localStorage.setItem("MAD_PRODUCTS",JSON.stringify(STATE.products));
renderCats();
renderGrid("all");
}

}

/* ===== CSV ===== */

function parseData(text){

const rows=text.split("\n");
const catIdx=lang==="ar"?11:10;

for(let i=1;i<rows.length;i++){

const c=rows[i].split(/,(?=(?:(?:[^"]*"){2})*[^"]*$)/);

if(!c[0]) continue;

STATE.products.push({
id:i,
title:c[0].replace(/"/g,""),
img:c[3],
priceStr:c[9],
price:parseFloat(c[9])||0,
cat:c[catIdx]
});
}

}

/* ===== HEADER ===== */

function renderHeader(){

document.getElementById("top-wa-txt").textContent=TXT[lang].wa_top;
document.getElementById("br-name").textContent=STATE.branch.name_he;
document.getElementById("cart-title").textContent=TXT[lang].cart;
document.getElementById("check-txt").textContent=TXT[lang].check;

document.getElementById("top-wa-btn").href=`https://wa.me/972${STATE.branch.phone.substring(1)}`;

const soc=document.getElementById("br-social");

if(STATE.branch.social?.facebook) soc.innerHTML+=`<a class="facebook" href="${STATE.branch.social.facebook}" target="_blank"><i class="fab fa-facebook-f"></i></a>`;
if(STATE.branch.social?.instagram) soc.innerHTML+=`<a class="instagram" href="${STATE.branch.social.instagram}" target="_blank"><i class="fab fa-instagram"></i></a>`;
if(STATE.branch.social?.tiktok) soc.innerHTML+=`<a class="tiktok" href="${STATE.branch.social.tiktok}" target="_blank"><i class="fab fa-tiktok"></i></a>`;

}

/* ===== STATUS ===== */

function updateBranchStatus(){

const now=new Date();
const days=["sun","mon","tue","wed","thu","fri","sat"];
const d=days[now.getDay()];
const mins=now.getHours()*60+now.getMinutes();

let open=false;

if(STATE.branch.schedule?.[d]){
STATE.branch.schedule[d].forEach(t=>{
const s=parseInt(t[0])*60;
const e=parseInt(t[1])*60;
if(mins>=s && mins<e) open=true;
});
}

const el=document.getElementById("open-status-display");

el.textContent=open?"OPEN ● פתוח":"CLOSED ● مغلق";
el.style.color=open?"green":"red";

}

/* ===== CATEGORIES ===== */

function renderCats(){

const cats=[...new Set(STATE.products.map(p=>p.cat).filter(Boolean))];
const box=document.getElementById("cats-box");

box.innerHTML=`<div class="cat-pill active" onclick="filterCats(this,'all')">${TXT[lang].all}</div>`;

cats.forEach(c=>{
box.innerHTML+=`<div class="cat-pill" onclick="filterCats(this,'${c}')">${c}</div>`;
});

}

function filterCats(el,name){

document.querySelectorAll(".cat-pill").forEach(p=>p.classList.remove("active"));
el.classList.add("active");

renderGrid(name);

}

/* ===== GRID ENGINE ===== */

function renderGrid(filter){

STATE.page=0;

STATE.view=filter==="all"
?STATE.products
:STATE.products.filter(p=>p.cat===filter);

const g=document.getElementById("main-grid");
g.innerHTML="";

for(let i=0;i<6;i++){
g.innerHTML+=`<div class="skeleton"></div>`;
}

loadChunk();

}

/* ===== CHUNK LOAD ===== */

function loadChunk(){

if(STATE.loading) return;
STATE.loading=true;

const start=STATE.page*STATE.chunk;
const end=start+STATE.chunk;

const part=STATE.view.slice(start,end);
const g=document.getElementById("main-grid");

part.forEach(p=>{

const inCart=STATE.cart.some(i=>i.id===p.id);

g.insertAdjacentHTML("beforeend",`

<div class="p-card">
<img loading="lazy" decoding="async"
style="filter:blur(6px);transition:.25s"
onload="this.style.filter='blur(0)'"
src="${p.img}?v=1">

<div class="p-info">
<div style="font-size:.85rem;font-weight:700;height:2.4em;overflow:hidden">${p.title}</div>
<div style="color:var(--gold);font-weight:900">${p.priceStr}</div>

<button class="add-btn ${inCart?'added':''}" onclick="addToCart(${p.id},this)">
${inCart?TXT[lang].added:TXT[lang].add}
</button>
</div>
</div>

`);

});

STATE.page++;
STATE.loading=false;

}

/* ===== INFINITE SCROLL ===== */

window.addEventListener("scroll",()=>{

if(window.innerHeight+window.scrollY>=document.body.offsetHeight-600){
loadChunk();
}

});

/* ===== CART ===== */

function addToCart(id,btn){

if(STATE.cart.some(i=>i.id===id)) return;

STATE.cart.push(STATE.products.find(p=>p.id===id));

btn.classList.add("added");
btn.textContent=TXT[lang].added;

document.getElementById("cart-count").textContent=STATE.cart.length;

}

function toggleCart(open){

document.getElementById("cart-drawer").classList.toggle("open",open);
document.getElementById("overlay").classList.toggle("show",open);

}

function sendOrder(){

let txt=TXT[lang].check+"\n";

STATE.cart.forEach((p,i)=>{
txt+=(i+1)+". "+p.title+"\n";
});

/* SAFE TRACKING */

if(window.fbq) fbq('track','Lead');
if(window.ttq) ttq.track('Contact');

window.open(`https://wa.me/972${STATE.branch.phone.substring(1)}?text=${encodeURIComponent(txt)}`);

}

/* ===== START ===== */

init();

</script>

</body>
</html>
