<!DOCTYPE html>
<html lang="he" dir="rtl">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no" />
  <title>MAD Parfumeur | Elite Branch Portal</title>

  <!-- Fonts -->
  <link href="https://fonts.googleapis.com/css2?family=Cinzel:wght@700;900&family=Assistant:wght@400;700&family=Cairo:wght@400;700;900&display=swap" rel="stylesheet">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">

  <!-- Meta Pixel -->
  <script>
  !function(f,b,e,v,n,t,s){if(f.fbq)return;n=f.fbq=function(){n.callMethod?
  n.callMethod.apply(n,arguments):n.queue.push(arguments)};if(!f._fbq)f._fbq=n;
  n.push=n;n.loaded=!0;n.version='2.0';n.queue=[];t=b.createElement(e);t.async=!0;
  t.src=v;s=b.getElementsByTagName(e)[0];s.parentNode.insertBefore(t,s)}
  (window,document,'script','https://connect.facebook.net/en_US/fbevents.js');
  fbq('init','1072283127290819'); fbq('track','PageView');
  </script>

  <!-- TikTok Pixel -->
  <script>
  !function(w,d,t){
    w.TiktokAnalyticsObject=t;var ttq=w[t]=w[t]||[];
    ttq.methods=["page","track","identify","instances","debug","on","off","once","ready","alias","group","enableCookie","disableCookie","holdConsent","revokeConsent","grantConsent"];
    ttq.setAndDefer=function(t,e){t[e]=function(){t.push([e].concat([].slice.call(arguments)))}}; 
    for(var i=0;i<ttq.methods.length;i++)ttq.setAndDefer(ttq,ttq.methods[i]);
    ttq.load=function(e){var n=d.createElement("script");n.type="text/javascript";n.async=!0;
      n.src="https://analytics.tiktok.com/i18n/pixel/events.js?sdkid="+e+"&lib="+t;
      var a=d.getElementsByTagName("script")[0];a.parentNode.insertBefore(n,a)};
    ttq.load('D2D02JBC77U4ENLN9SBG'); ttq.page();
  }(window,document,'ttq');
  </script>

  <style>
    :root{--gold:#D4AF37;--black:#080808;--wa:#25D366;--green:#00ff88;--red:#ff4d4d}
    *{box-sizing:border-box;margin:0;padding:0}
    body{background:var(--black);color:#fff;font-family:'Assistant','Cairo',sans-serif;opacity:0;transition:.4s}
    a{text-decoration:none;color:inherit}

    .top-wa{position:sticky;top:0;z-index:9;background:var(--wa);padding:12px;
      display:flex;gap:10px;justify-content:center;align-items:center;font-weight:900}

    header{padding:28px 16px;text-align:center;
      background:linear-gradient(rgba(0,0,0,.8),#000),
      url('https://madparfumeurglobal.com/wp-content/uploads/2025/10/1920x600-BERGAY.jpg') center/cover;
      border-bottom:2px solid var(--gold)}
    .logo{max-width:120px;margin-bottom:10px}
    .staff{width:96px;height:96px;border-radius:50%;border:3px solid var(--gold);object-fit:cover}
    .status{margin-top:8px;font-weight:900}
    .open{color:var(--green)} .closed{color:var(--red)}
    .branch{font-family:'Cinzel';color:var(--gold);font-size:1.6rem;margin-top:6px}

    .cats{position:sticky;top:48px;background:#0b0b0b;border-bottom:1px solid #222;
      display:flex;gap:10px;overflow-x:auto;padding:12px}
    .cat{background:#1a1a1a;border:1px solid #333;border-radius:999px;
      padding:6px 14px;white-space:nowrap;cursor:pointer}
    .cat.active{background:var(--gold);color:#000}

    .grid{display:grid;grid-template-columns:repeat(2,1fr);gap:12px;padding:14px}
    .card{background:#121212;border-radius:14px;border:1px solid #1a1a1a;overflow:hidden}
    .card img{width:100%;aspect-ratio:1/1;object-fit:cover}
    .info{padding:10px;text-align:center}
    .price{color:var(--gold);font-weight:900;margin:6px 0}
    .btn{width:100%;border:none;border-radius:8px;padding:10px;font-weight:900;cursor:pointer}
    .add{background:var(--gold);color:#000}
    .added{background:#333;color:#fff}

    .fab{position:fixed;bottom:90px;width:56px;height:56px;border-radius:50%;
      display:flex;align-items:center;justify-content:center;z-index:9}
    .cart{right:18px;background:var(--gold);color:#000}
    .sale{left:18px;background:#fff;border:3px solid var(--gold)}

    .drawer{position:fixed;left:0;bottom:-100%;width:100%;height:78%;
      background:#0a0a0a;border-top:3px solid var(--gold);transition:.35s;
      border-radius:22px 22px 0 0;padding:20px;z-index:10}
    .drawer.open{bottom:0}
    .checkout{background:var(--wa);border:none;border-radius:12px;padding:16px;font-weight:900}

    .overlay{position:fixed;inset:0;background:rgba(0,0,0,.6);display:none;z-index:8}
  </style>
</head>

<body>

<a id="waTop" class="top-wa" target="_blank"><i class="fab fa-whatsapp"></i><span id="waTxt"></span></a>

<header>
  <img src="logo.png" class="logo">
  <img src="https://madperfume.ps/upload/01-2026/page/6966930e9af7f.png" class="staff">
  <div id="branch" class="branch"></div>
  <div id="status" class="status"></div>
</header>

<div id="cats" class="cats"></div>
<main id="grid" class="grid"></main>

<div class="fab cart" onclick="toggleCart(true)"><i class="fas fa-shopping-bag"></i></div>
<div class="fab sale" onclick="claimOffer()"><i class="fas fa-gift" style="color:var(--gold)"></i></div>

<div id="overlay" class="overlay" onclick="toggleCart(false)"></div>

<div id="drawer" class="drawer">
  <h2 id="cartTitle" style="color:var(--gold);text-align:center;font-family:'Cinzel'"></h2>
  <div id="list" style="max-height:60%;overflow:auto;margin:10px 0"></div>
  <div id="total" style="text-align:center;color:var(--gold);font-size:1.4rem;font-weight:900"></div>
  <button class="checkout" onclick="sendOrder()"><i class="fab fa-whatsapp"></i> <span id="sendTxt"></span></button>
</div>

<script>
/* ========= Language (Arabic / Hebrew only) ========= */
const lang = navigator.language.startsWith('ar') ? 'ar' : 'he';
const TXT = {
  ar:{all:'الكل',add:'إضافة للسلة',added:'في السلة',send:'إرسال الطلب عبر واتساب',
      open:'مفتوح الآن',closed:'مغلق حالياً',wa:'تواصل معنا عبر واتساب',cart:'سلة المشتريات'},
  he:{all:'הכל',add:'הוסף לסל',added:'בסל',send:'שליחת הזמנה בוואטסאפ',
      open:'פתוח עכשיו',closed:'סגור כעת',wa:'דברו איתנו בוואטסאפ',cart:'סל קניות'}
};

/* ========= State ========= */
const params=new URLSearchParams(location.search);
const branchID=parseInt(params.get('branch'))||1;
const STATE={branch:null,products:[],cart:[]};

/* ========= Init ========= */
init();
async function init(){
  try{
    const [bj,pc]=await Promise.all([
      fetch('branches.json').then(r=>r.json()),
      fetch('products.csv').then(r=>r.text())
    ]);
    STATE.branch=bj.branches.find(b=>b.id===branchID)||bj.branches[0];
    parseCSV(pc);
    renderHeader(); renderCats(); renderGrid('all'); updateStatus();
  }finally{document.body.style.opacity=1}
}

/* ========= Header ========= */
function renderHeader(){
  document.getElementById('branch').textContent =
    (lang==='ar'?STATE.branch.name_ar:STATE.branch.name_he);
  document.getElementById('waTxt').textContent=TXT[lang].wa;
  document.getElementById('waTop').href=
    `https://api.whatsapp.com/send/?phone=972${STATE.branch.phone.substring(1)}`;
  document.getElementById('cartTitle').textContent=TXT[lang].cart;
  document.getElementById('sendTxt').textContent=TXT[lang].send;
}

/* ========= Status ========= */
function updateStatus(){
  const d=new Date(); const day=['sun','mon','tue','wed','thu','fri','sat'][d.getDay()];
  const now=d.getHours()*60+d.getMinutes();
  let open=false;
  (STATE.branch.schedule?.[day]||[]).forEach(s=>{
    const a=s[0].split(':'),b=s[1].split(':');
    const st=+a[0]*60+ +a[1], en=+b[0]*60+ +b[1];
    if(now>=st&&now<en) open=true;
  });
  const el=document.getElementById('status');
  el.textContent=open?TXT[lang].open:TXT[lang].closed;
  el.className='status '+(open?'open':'closed');
}

/* ========= CSV ========= */
function parseCSV(t){
  const lines=t.split('\n');
  const catIdx=lang==='ar'?11:10;
  for(let i=1;i<lines.length;i++){
    const c=lines[i].split(/,(?=(?:(?:[^"]*"){2})*[^"]*$)/);
    if(!c[0])continue;
    STATE.products.push({
      id:i,
      title:c[0].replace(/"/g,'').trim(),
      img:c[3]?.trim()||'logo.png',
      price:parseFloat(c[9]?.replace(/[^\d.]/g,''))||0,
      priceStr:(c[9]||'').replace('ILS','').trim()+' ₪',
      cat:c[catIdx]?.trim()||''
    });
  }
}

/* ========= Categories ========= */
function renderCats(){
  const set=[...new Set(STATE.products.map(p=>p.cat))].filter(Boolean);
  const box=document.getElementById('cats');
  box.innerHTML=
    `<div class="cat active" onclick="filter(this,'all')">${TXT[lang].all}</div>`+
    set.map(c=>`<div class="cat" onclick="filter(this,'${c.replace(/'/g,"\\'")}')">${c}</div>`).join('');
}
function filter(el,c){
  document.querySelectorAll('.cat').forEach(x=>x.classList.remove('active'));
  el.classList.add('active'); renderGrid(c);
}

/* ========= Grid ========= */
function renderGrid(c){
  const g=document.getElementById('grid'); g.innerHTML='';
  const list=c==='all'?STATE.products:STATE.products.filter(p=>p.cat===c);
  list.forEach(p=>{
    const inCart=STATE.cart.some(i=>i.id===p.id);
    g.innerHTML+=`
      <div class="card">
        <img src="${p.img}">
        <div class="info">
          <div>${p.title}</div>
          <div class="price">${p.priceStr}</div>
          <button class="btn ${inCart?'added':'add'}"
            onclick="add(${p.id},this)">${inCart?TXT[lang].added:TXT[lang].add}</button>
        </div>
      </div>`;
  });
}

/* ========= Cart ========= */
function add(id,btn){
  if(STATE.cart.some(i=>i.id===id))return;
  STATE.cart.push(STATE.products.find(p=>p.id===id));
  btn.className='btn added'; btn.textContent=TXT[lang].added;
}
function toggleCart(s){
  document.getElementById('drawer').classList.toggle('open',s);
  document.getElementById('overlay').style.display=s?'block':'none';
}
function sendOrder(){
  let msg=TXT[lang].cart+':\n';
  let total=0;
  STATE.cart.forEach((i,n)=>{msg+=`${n+1}. ${i.title}\n`; total+=i.price});
  msg+=`\n${total} ₪`;
  fbq('track','Lead'); ttq.track('Contact');
  window.open(`https://api.whatsapp.com/send/?phone=972${STATE.branch.phone.substring(1)}&text=${encodeURIComponent(msg)}`,'_blank');
}
function claimOffer(){
  fbq('track','Lead'); ttq.track('Contact');
  window.open(`https://api.whatsapp.com/send/?phone=972${STATE.branch.phone.substring(1)}`,'_blank');
}
</script>
</body>
</html>
