<!DOCTYPE html>
<html lang="he">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width,initial-scale=1.0">
<title>MAD PARFUMEUR | דלית אל כרמל</title>

<link href="https://fonts.googleapis.com/css2?family=Cinzel:wght@700&family=Assistant:wght@400;700&display=swap" rel="stylesheet">
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">

<script>
!function(f,b,e,v,n,t,s){if(f.fbq)return;n=f.fbq=function(){n.callMethod?
n.callMethod.apply(n,arguments):n.queue.push(arguments)};
if(!f._fbq)f._fbq=n;n.push=n;n.loaded=!0;n.version='2.0';
n.queue=[];t=b.createElement(e);t.async=!0;
t.src=v;s=b.getElementsByTagName(e)[0];
s.parentNode.insertBefore(t,s)}(window,document,'script',
'https://connect.facebook.net/en_US/fbevents.js');
fbq('init','1072283127290819'); fbq('track','PageView');
</script>

<script>
!function (w, d, t) {
  w.TiktokAnalyticsObject=t;
  var ttq=w[t]=w[t]||[];
  ttq.methods=["page","track"];
  ttq.setAndDefer=function(t,e){
    t[e]=function(){
      t.push([e].concat(Array.prototype.slice.call(arguments,0)))
    }
  };
  for(var i=0;i<ttq.methods.length;i++){
    ttq.setAndDefer(ttq,ttq.methods[i]);
  }
  ttq.load=function(e){
    var i=d.createElement("script");
    i.async=!0;
    i.src="https://analytics.tiktok.com/i18n/pixel/events.js?sdkid="+e;
    var s=d.getElementsByTagName("script")[0];
    s.parentNode.insertBefore(i,s);
  };
  ttq.load("D2D02JBC77U4ENLN9SBG");
  ttq.page();
}(window, document, 'ttq');
</script>

<style>
:root{
--gold:#D4AF37;--black:#000;--card:#111;
--white:#fff;--wa:#25D366;
}
*{box-sizing:border-box;margin:0;padding:0}
body{background:#000;color:#fff;font-family:'Assistant',sans-serif}

/* Header Section */
header{text-align:center;padding:40px 20px;border-bottom:1px solid #222}
.logo{font-family:'Cinzel';color:var(--gold);font-size:2.5rem;letter-spacing:5px;margin-bottom:10px}
.branch-title{font-size:1.4rem;margin-bottom:5px}
.hours-display{font-size:0.95rem;opacity:0.8;margin-bottom:15px}

/* Status Badge */
.status{display:inline-block;padding:5px 15px;border-radius:20px;font-size:.85rem;font-weight:700;margin-bottom:20px}
.open{color:#25D366;border:1px solid #25D366;background:rgba(37,211,102,0.1)}
.closed{color:#ff4d4d;border:1px solid #ff4d4d;background:rgba(255,77,77,0.1)}

/* Social Icons */
.social-icons{display:flex;justify-content:center;gap:15px;margin-bottom:10px}
.social-icons a{color:#fff;font-size:1.3rem;transition:0.3s;opacity:0.7}
.social-icons a:hover{color:var(--gold);opacity:1;transform:translateY(-2px)}

/* Navigation/Cats */
.cats{display:flex;gap:8px;overflow-x:auto;padding:15px;border-bottom:1px solid #222;scrollbar-width:none}
.cats::-webkit-scrollbar{display:none}
.cats button{background:#111;color:#fff;border:1px solid #333;padding:8px 20px;border-radius:4px;cursor:pointer;white-space:nowrap}
.cats button.active{background:var(--gold);color:#000;font-weight:700}

/* Grid System */
.grid{display:grid;grid-template-columns:repeat(2,1fr);gap:12px;padding:15px}
@media(min-width:768px){.grid{grid-template-columns:repeat(4,1fr);gap:20px}}

.card{background:#111;border:1px solid #222;display:flex;flex-direction:column;border-radius:4px;overflow:hidden;transition:0.3s}
.card:hover{border-color:var(--gold)}
.img{aspect-ratio:1/1;overflow:hidden;background:#000}
.img img{width:100%;height:100%;object-fit:cover;opacity:0;transition:opacity 0.4s}
.img img.loaded{opacity:1}
.info{text-align:center;padding:15px}
.name{font-family:'Cinzel';font-size:.95rem;height:2.6em;overflow:hidden;margin-bottom:10px}
.price{color:var(--gold);margin-bottom:15px;font-weight:700;font-size:1.1rem}
.wa{background:var(--wa);color:#fff;text-decoration:none;padding:12px;font-weight:700;border-radius:4px;display:block;font-size:0.9rem}

/* Offer Popup */
#popup{position:fixed;inset:0;background:rgba(0,0,0,.92);display:none;align-items:center;justify-content:center;z-index:9999;padding:20px}
.pbox{width:100%;max-width:400px;border:1px solid var(--gold);position:relative;background:#000}
.pclose{position:absolute;top:-45px;right:0;font-size:2.5rem;color:#fff;cursor:pointer}
.ptimer{background:var(--gold);color:#000;font-weight:900;padding:12px;text-align:center;font-size:1.2rem}
.pwa{display:block;background:var(--wa);color:#fff;padding:18px;text-align:center;font-weight:900;text-decoration:none;font-size:1.3rem}
</style>
</head>

<body dir="rtl">

<header>
  <div class="logo">MAD PARFUMEUR</div>
  <div id="branch-info">
    <div id="branch-name" class="branch-title">טוען...</div>
    <div id="branch-hours-text" class="hours-display"></div>
  </div>
  <div id="status"></div>
  <div id="social-links" class="social-icons"></div>
</header>

<nav id="cats" class="cats"></nav>
<main id="grid" class="grid"></main>

<div id="popup">
  <div class="pbox">
    <span class="pclose" onclick="closePop()">×</span>
    <img src="sale.png" style="width:100%; display:block;" alt="Sale">
    <div id="timer" class="ptimer">00:00:00</div>
    <a id="pwa-link" class="pwa" target="_blank">קבלת ההطבה עכשיו</a>
  </div>
</div>

<script>
const qs = new URLSearchParams(location.search);
const branchID = qs.get('branch') || '1'; // Default to ID 1 if not specified
const lang = navigator.language.startsWith('ar') ? 'ar' : 'he';

const TXT = {
  he: { open: 'פתוח עכשיו', closed: 'סגור כעת', all: 'הכל', order: 'הזמנה ב-WhatsApp', msg: 'היי, אני מעוניין ב: ' },
  ar: { open: 'مفتوح الآن', closed: 'مغلق حالياً', all: 'الكل', order: 'طلب عبر واتساب', msg: 'مرحباً، أنا مهتم بـ: ' }
};

let STATE = { branch: null, products: [] };

// Tracking Logic
function lead(action, label) {
  if (window.fbq) fbq('track', 'Lead', { branch: branchID, action, label });
  if (window.ttq) ttq.track('SubmitForm', { branch: branchID, action, label });
}

async function start() {
  try {
    const [branchRes, productsRes] = await Promise.all([
      fetch('test.json').then(r => r.json()),
      fetch('products.csv').then(r => r.text())
    ]);

    STATE.branch = branchRes.branches.find(b => b.id == branchID) || branchRes.branches[0];
    parseCSV(productsRes);
    renderHeader();
    renderCats();
    renderGrid('all');
    initPopup();
  } catch (err) {
    console.error("Initialization failed:", err);
  }
}

function parseCSV(text) {
  const lines = text.split('\n');
  for (let i = 1; i < lines.length; i++) {
    const c = lines[i].split(/,(?=(?:(?:[^"]*"){2})*[^"]*$)/);
    if (!c[1]) continue;
    STATE.products.push({
      title: c[1].replace(/"/g, ''),
      img: c[4],
      price: c[10],
      cat: c[11]
    });
  }
}

function renderHeader() {
  const t = TXT[lang];
  const b = STATE.branch;

  // Branch Name & Hours Text
  document.getElementById('branch-name').textContent = b[`name_${lang}`];
  document.getElementById('branch-hours-text').textContent = b.hours || '';

  // Calculate Open/Closed status
  const now = new Date();
  const days = ['sun', 'mon', 'tue', 'wed', 'thu', 'fri', 'sat'];
  const today = days[now.getDay()];
  const currentMinutes = now.getHours() * 60 + now.getMinutes();
  
  const schedule = b.schedule[today] || [];
  const isOpen = schedule.some(range => {
    const [startH, startM] = range[0].split(':').map(Number);
    const [endH, endM] = range[1].split(':').map(Number);
    return currentMinutes >= (startH * 60 + startM) && currentMinutes <= (endH * 60 + endM);
  });

  document.getElementById('status').innerHTML = 
    `<span class="status ${isOpen ? 'open' : 'closed'}">${isOpen ? t.open : t.closed}</span>`;

  // Render Social Links from JSON
  const socials = b.social || {};
  const icons = {
    tiktok: 'fa-tiktok', instagram: 'fa-instagram', facebook: 'fa-facebook',
    snapchat: 'fa-snapchat', youtube: 'fa-youtube', email: 'fa-envelope', waze: 'fa-waze'
  };
  
  const socialEl = document.getElementById('social-links');
  Object.entries(socials).forEach(([key, url]) => {
    if (url && icons[key]) {
      const a = document.createElement('a');
      a.href = url;
      a.target = "_blank";
      a.innerHTML = `<i class="fab ${icons[key]}"></i>`;
      a.onclick = () => lead('social_click', key);
      socialEl.appendChild(a);
    }
  });
}

function renderCats() {
  const t = TXT[lang];
  const cats = [t.all, ...new Set(STATE.products.map(p => p.cat))].filter(Boolean);
  const el = document.getElementById('cats');
  
  cats.forEach(c => {
    const b = document.createElement('button');
    b.textContent = c;
    b.className = (c === t.all) ? 'active' : '';
    b.onclick = (e) => {
      document.querySelectorAll('.cats button').forEach(x => x.classList.remove('active'));
      e.target.classList.add('active');
      renderGrid(c === t.all ? 'all' : c);
    };
    el.appendChild(b);
  });
}

function renderGrid(filter) {
  const g = document.getElementById('grid');
  g.innerHTML = '';
  const t = TXT[lang];
  const list = filter === 'all' ? STATE.products : STATE.products.filter(p => p.cat === filter);

  const obs = new IntersectionObserver(entries => {
    entries.forEach(e => {
      if (e.isIntersecting) {
        const i = e.target; i.src = i.dataset.src;
        i.onload = () => i.classList.add('loaded');
        obs.unobserve(i);
      }
    });
  });

  list.forEach(p => {
    const card = document.createElement('div');
    card.className = 'card';
    card.innerHTML = `
      <div class="img"><img data-src="${p.img}" alt="${p.title}"></div>
      <div class="info">
        <div class="name">${p.title}</div>
        <div class="price">${p.price}</div>
        <a class="wa" target="_blank"
           href="https://wa.me/${STATE.branch.phone}?text=${encodeURIComponent(t.msg + p.title)}"
           onclick="lead('whatsapp_order', '${p.title}')">${t.order}</a>
      </div>`;
    g.appendChild(card);
    obs.observe(card.querySelector('img'));
  });
}

function initPopup() {
  const key = 'mad_pop_' + new Date().toDateString();
  if (localStorage.getItem(key)) return;

  setTimeout(() => {
    document.getElementById('popup').style.display = 'flex';
    document.getElementById('pwa-link').href = `https://wa.me/${STATE.branch.phone}?text=היי، אשמח לקבל את ההטבה היומית!`;
    document.getElementById('pwa-link').onclick = () => lead('popup_offer_click', 'daily_sale');

    setInterval(() => {
      const now = new Date();
      const end = new Date();
      end.setHours(23, 59, 59);
      const diff = end - now;
      
      const h = Math.floor(diff / 3600000).toString().padStart(2, '0');
      const m = Math.floor((diff % 3600000) / 60000).toString().padStart(2, '0');
      const s = Math.floor((diff % 60000) / 1000).toString().padStart(2, '0');
      document.getElementById('timer').textContent = `${h}:${m}:${s}`;
    }, 1000);
  }, 3000);
}

function closePop() {
  document.getElementById('popup').style.display = 'none';
  localStorage.setItem('mad_pop_' + new Date().toDateString(), '1');
  lead('popup_close', 'daily_offer');
}

start();
</script>

</body>
</html>
