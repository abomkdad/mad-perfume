<!DOCTYPE html>
<html lang="he" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>MAD PARFUMEUR</title>
    
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link href="https://fonts.googleapis.com/css2?family=Cinzel:wght@700&family=Assistant:wght@400;700&display=swap" rel="stylesheet">

    <style>
        :root { --gold: #D4AF37; --black: #000; --card: #111; --white: #fff; --wa: #25D366; }
        
        /* تحسين الأداء: منع القفزات في التصميم */
        * { box-sizing: border-box; margin: 0; padding: 0; }
        body { background: var(--black); color: var(--white); font-family: 'Assistant', sans-serif; -webkit-font-smoothing: antialiased; }
        
        .container { max-width: 1200px; margin: 0 auto; padding: 0 15px; }

        /* الهيدر ثابت لسرعة الرندر */
        header { padding: 30px 0; text-align: center; border-bottom: 1px solid #222; }
        .logo { font-family: 'Cinzel', serif; color: var(--gold); font-size: 2.2rem; letter-spacing: 4px; }
        .br-name { font-size: 1.2rem; margin: 10px 0; font-weight: 300; }
        
        .status { display: inline-block; padding: 4px 12px; border-radius: 20px; font-size: 0.8rem; font-weight: 700; border: 1px solid; }
        .open { color: var(--wa); border-color: var(--wa); background: rgba(37,211,102,0.1); }
        .closed { color: #ff4d4d; border-color: #ff4d4d; background: rgba(255,77,77,0.1); }

        /* شريط التصنيفات سريع الاستجابة */
        .filter-wrap { position: sticky; top: 0; background: var(--black); z-index: 100; padding: 10px 0; border-bottom: 1px solid #222; }
        .cats { display: flex; gap: 8px; overflow-x: auto; scrollbar-width: none; white-space: nowrap; }
        .cats::-webkit-scrollbar { display: none; }
        .c-btn { background: #1a1a1a; color: #fff; border: 1px solid #333; padding: 6px 16px; border-radius: 4px; cursor: pointer; }
        .c-btn.active { background: var(--gold); color: #000; font-weight: 700; border-color: var(--gold); }

        /* شبكة المنتجات مع Lazy Load حقيقي */
        .grid { display: grid; grid-template-columns: repeat(2, 1fr); gap: 10px; padding: 20px 0; }
        @media (min-width: 768px) { .grid { grid-template-columns: repeat(4, 1fr); gap: 20px; } }
        
        .card { background: var(--card); border: 1px solid #222; border-radius: 4px; overflow: hidden; display: flex; flex-direction: column; }
        .img-box { width: 100%; aspect-ratio: 1/1; background: #000; position: relative; }
        .img-box img { width: 100%; height: 100%; object-fit: cover; position: absolute; top: 0; left: 0; opacity: 0; transition: opacity 0.3s; }
        .img-box img.loaded { opacity: 1; }

        .info { padding: 12px; text-align: center; flex-grow: 1; }
        .name { font-size: 0.9rem; height: 2.6em; overflow: hidden; margin-bottom: 8px; font-family: 'Cinzel', serif; }
        .price { color: var(--gold); font-weight: 700; margin-bottom: 12px; }
        
        .wa-btn { background: var(--wa); color: #fff; text-decoration: none; padding: 10px; border-radius: 4px; display: block; font-weight: 700; font-size: 0.85rem; }

        /* Popup */
        #popup { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.9); z-index: 2000; display: none; align-items: center; justify-content: center; }
        .p-box { width: 90%; max-width: 400px; background: #000; border: 1px solid var(--gold); position: relative; }
        .p-close { position: absolute; top: -40px; right: 0; color: #fff; font-size: 2rem; cursor: pointer; }
        .p-timer { background: var(--gold); color: #000; padding: 10px; text-align: center; font-weight: 900; }
        .p-wa { display: block; background: var(--wa); color: #fff; text-align: center; padding: 15px; text-decoration: none; font-weight: 900; }

        /* Loader */
        #loading { position: fixed; inset: 0; background: #000; z-index: 3000; display: flex; align-items: center; justify-content: center; font-family: 'Cinzel', serif; color: var(--gold); }
    </style>
</head>
<body>

<div id="loading">MAD PARFUMEUR</div>

<header>
    <div class="container">
        <h1 class="logo">MAD PARFUMEUR</h1>
        <div id="b-name" class="br-name"></div>
        <div id="b-status"></div>
    </div>
</header>

<div class="filter-wrap">
    <div class="container">
        <nav id="b-cats" class="cats"></nav>
    </div>
</div>

<main class="container">
    <div id="b-grid" class="grid"></div>
</main>

<div id="popup">
    <div class="p-box">
        <span class="p-close" onclick="closePop()">&times;</span>
        <img src="sale.png" style="width:100%; display:block;">
        <div id="timer" class="p-timer">00:00:00</div>
        <a href="#" id="p-wa-btn" class="p-wa">CLAIM OFFER</a>
    </div>
</div>

<script>
    const State = {
        id: new URLSearchParams(window.location.search).get('branch') || '1',
        lang: navigator.language.startsWith('ar') ? 'ar' : 'he',
        data: null,
        prods: []
    };

    const UI = {
        he: { open: "פתוח", closed: "סגור", all: "הכל", order: "הזמנה", msg: "היי, אני מעוניין ב: " },
                ar: { open: "مفتوح", closed: "مغلق", all: "الكل", order: "طلب", msg: "مرحباً، أنا مهتم بـ: " }
    };

    async function start() {
        try {
            // تحميل البيانات بالتوازي
            const [r1, r2] = await Promise.all([ fetch('test.json'), fetch('products.csv') ]);
            const bJson = await r1.json();
            const pText = await r2.text();

            State.data = bJson.branches.find(b => b.id == State.id) || bJson.branches[0];
            
            // معالجة CSV بأسلوب مصفوفة سريعة
            const lines = pText.split('\n');
            const headers = lines[0].split(',');
            for(let i=1; i<lines.length; i++) {
                if(!lines[i]) continue;
                const cols = lines[i].split(/,(?=(?:(?:[^"]*"){2})*[^"]*$)/);
                State.prods.push({
                    title: cols[1]?.replace(/"/g, ''),
                    price: cols[10]?.replace(/"/g, ''),
                    img: cols[4]?.replace(/"/g, ''),
                    cat: cols[11]?.replace(/"/g, '')
                });
            }

            renderHeader();
            renderCats();
            renderGrid('all');
            initPop();

            document.getElementById('loading').style.display = 'none';
        } catch(e) { console.error(e); }
    }

    function renderHeader() {
        const t = UI[State.lang];
        document.getElementById('b-name').textContent = State.data[`name_${State.lang}`];
        
        // حساب الوقت
        const now = new Date();
        const day = ['sun','mon','tue','wed','thu','fri','sat'][now.getDay()];
        const sched = State.data.schedule[day];
        const nowMin = now.getHours() * 60 + now.getMinutes();
        const isOpen = sched && sched.some(r => {
            const [sH, sM] = r[0].split(':').map(Number);
            const [eH, eM] = r[1].split(':').map(Number);
            return nowMin >= (sH*60+sM) && nowMin < (eH*60+eM);
        });

        document.getElementById('b-status').innerHTML = `<span class="status ${isOpen?'open':'closed'}">${isOpen?t.open:t.closed}</span>`;
    }

    function renderCats() {
        const t = UI[State.lang];
        const cats = [t.all, ...new Set(State.prods.map(p => p.cat))].filter(Boolean);
        const container = document.getElementById('b-cats');
        cats.forEach(c => {
            const btn = document.createElement('button');
            btn.className = 'c-btn' + (c === t.all ? ' active' : '');
            btn.textContent = c;
            btn.onclick = (e) => {
                document.querySelectorAll('.c-btn').forEach(b => b.classList.remove('active'));
                btn.classList.add('active');
                renderGrid(c === t.all ? 'all' : c);
            };
            container.appendChild(btn);
        });
    }

    function renderGrid(filter) {
        const grid = document.getElementById('b-grid');
        grid.innerHTML = '';
        const list = filter === 'all' ? State.prods : State.prods.filter(p => p.cat === filter);
        const t = UI[State.lang];

        // تقنية Fragment لتحسين سرعة الرندر
        const frag = document.createDocumentFragment();
        list.forEach(p => {
            const div = document.createElement('div');
            div.className = 'card';
            div.innerHTML = `
                <div class="img-box"><img data-src="${p.img}" alt=""></div>
                <div class="info">
                    <div class="name">${p.title}</div>
                    <div class="price">${p.price}</div>
                    <a href="https://wa.me/${State.data.phone}?text=${encodeURIComponent(t.msg+p.title)}" class="wa-btn">${t.order}</a>
                </div>
            `;
            frag.appendChild(div);
        });
        grid.appendChild(frag);

        // Lazy Loading يدوي فائق السرعة
        const obs = new IntersectionObserver(entries => {
            entries.forEach(en => {
                if(en.isIntersecting) {
                    const img = en.target;
                    img.src = img.dataset.src;
                    img.onload = () => img.classList.add('loaded');
                    obs.unobserve(img);
                }
            });
        });
        grid.querySelectorAll('img').forEach(i => obs.observe(i));
    }

    function initPop() {
        if(localStorage.getItem('mad_pop_'+new Date().toDateString())) return;
        setTimeout(() => {
            document.getElementById('popup').style.display = 'flex';
            document.getElementById('p-wa-btn').href = `https://wa.me/${State.data.phone}?text=Offer`;
            setInterval(() => {
                const diff = new Date().setHours(23,59,59) - new Date();
                const h = Math.floor(diff/3600000).toString().padStart(2,'0');
                const m = Math.floor((diff%3600000)/60000).toString().padStart(2,'0');
                const s = Math.floor((diff%60000)/1000).toString().padStart(2,'0');
                document.getElementById('timer').textContent = `${h}:${m}:${s}`;
            }, 1000);
        }, 2000);
    }

    function closePop() {
        document.getElementById('popup').style.display = 'none';
        localStorage.setItem('mad_pop_'+new Date().toDateString(), '1');
    }

    window.onload = start;
</script>

</body>
</html>
