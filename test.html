<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
  <title>MAD PARFUMEUR | Branch Portal</title>

  <!-- Fonts -->
  <link href="https://fonts.googleapis.com/css2?family=Playfair+Display:ital,wght@0,400;0,700;0,900;1,400;1,900&family=Inter:wght@300;400;600;800&family=Amiri:wght@400;700&family=Assistant:wght@300;400;600;700;800&display=swap" rel="stylesheet">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">

  <!-- Tailwind CSS (CDN) -->
  <script src="https://cdn.tailwindcss.com"></script>
  <script src="https://unpkg.com/lucide@latest"></script>

  <!-- PapaParse for CSV -->
  <script src="https://cdn.jsdelivr.net/npm/papaparse@5.4.1/papaparse.min.js"></script>

  <!-- Meta Pixel Code -->
  <script>
  !function(f,b,e,v,n,t,s){if(f.fbq)return;n=f.fbq=function(){n.callMethod?
  n.callMethod.apply(n,arguments):n.queue.push(arguments)};if(!f._fbq)f._fbq=n;
  n.push=n;n.loaded=!0;n.version='2.0';n.queue=[];t=b.createElement(e);t.async=!0;
  t.src=v;s=b.getElementsByTagName(e)[0];s.parentNode.insertBefore(t,s)}(window,document,'script',
  'https://connect.facebook.net/en_US/fbevents.js');
  fbq('init', '1072283127290819');
  fbq('track', 'PageView');
  </script>

  <!-- TikTok Pixel -->
  <script>
  !function (w, d, t) {
    w.TiktokAnalyticsObject=t;var ttq=w[t]=w[t]||[];
    ttq.methods=["page","track","identify","instances","debug","on","off","once","ready","alias","group","enableCookie","disableCookie","holdConsent","revokeConsent","grantConsent"];
    ttq.setAndDefer=function(t,e){t[e]=function(){t.push([e].concat(Array.prototype.slice.call(arguments,0)))}};for(var i=0;i<ttq.methods.length;i++)ttq.setAndDefer(ttq,ttq.methods[i]);
    ttq.instance=function(t){for(var e=ttq._i[t]||[],n=0;n<ttq.methods.length;n++)ttq.setAndDefer(e,ttq.methods[n]);return e};
    ttq.load=function(e,n){var r="https://analytics.tiktok.com/i18n/pixel/events.js",o=n&&n.partner;ttq._i=ttq._i||{},ttq._i[e]=[],ttq._i[e]._u=r,ttq._t=ttq._t||{},ttq._t[e]=+new Date,ttq._o=ttq._o||{},ttq._o[e]=n||{};
    n=document.createElement("script");n.type="text/javascript",n.async=!0,n.src=r+"?sdkid="+e+"&lib="+t;e=document.getElementsByTagName("script")[0];e.parentNode.insertBefore(n,e)};
    ttq.load('D2D02JBC77U4ENLN9SBG');
    ttq.page();
  }(window, document, 'ttq');

  // ✅ ALWAYS "Lead"
  function trackLead(name) {
    try{ if(window.fbq) fbq('track', 'Lead', {content_name: name}); }catch(e){}
    try{ if(window.ttq) ttq.track('Lead', {content_name: name}); }catch(e){}
  }
  </script>

  <style>
    :root {
      --primary:#d97706;
      --primary-light:#fbbf24;
      --bg-dark:#020202;
      --glass:rgba(10,10,10,.85);
      --border-glass:rgba(255,255,255,.1);
      --live-green:#10b981;
      --live-red:#ef4444;
    }

    body {
      background-color: var(--bg-dark);
      color:#f4f4f4;
      font-family:'Assistant','Inter',sans-serif;
      overflow-x:hidden;
      font-size:16px;
      opacity:0;
      transition:opacity .5s ease;
    }

    .font-serif { font-family:'Playfair Display', serif; }
    .font-arabic { font-family:'Amiri', serif; }

    /* Header Video */
    .video-header{position:relative;height:90vh;width:100%;overflow:hidden;display:flex;align-items:center;justify-content:center;text-align:center;}
    .video-bg{position:absolute;top:0;left:0;width:100%;height:100%;object-fit:cover;z-index:0;opacity:.6;}
    .video-overlay{position:absolute;inset:0;background:linear-gradient(to top,#020202 5%,rgba(0,0,0,.3) 60%,#020202 100%);z-index:1;}
    .header-content{position:relative;z-index:10;padding:20px;width:100%;}

    /* Staff */
    .staff-avatar{
      width:130px;height:130px;border-radius:50%;
      border:3px solid var(--primary);
      padding:4px;margin:0 auto 25px;position:relative;
      background:rgba(0,0,0,.5);
      backdrop-filter:blur(10px);
      box-shadow:0 10px 40px rgba(0,0,0,.5);
    }
    .staff-img{width:100%;height:100%;border-radius:50%;object-fit:cover;}
    .status-badge{
      position:absolute;bottom:-10px;left:50%;transform:translateX(-50%);
      background:#000;border:1px solid var(--border-glass);
      padding:8px 20px;border-radius:30px;font-size:1rem;font-weight:800;white-space:nowrap;
      display:flex;align-items:center;gap:8px;
      box-shadow:0 5px 20px rgba(0,0,0,.6);
    }
    .status-dot{width:12px;height:12px;border-radius:50%;background:var(--live-red);box-shadow:0 0 10px var(--live-red);animation:pulse 2s infinite;}
    @keyframes pulse{0%{opacity:1}50%{opacity:.5}100%{opacity:1}}

    /* Social */
    .social-bar{display:flex;justify-content:center;gap:20px;margin-top:30px;flex-wrap:wrap;}
    .social-btn{
      width:55px;height:55px;border-radius:50%;
      background:rgba(255,255,255,.05);
      border:1px solid var(--border-glass);
      display:flex;align-items:center;justify-content:center;
      color:#fff;transition:all .3s ease;font-size:1.6rem;
    }
    .social-btn:hover{background:var(--primary);color:#000;transform:translateY(-5px);}

    .section-title{
      font-family:'Playfair Display', serif;
      font-weight:900;font-style:italic;
      background:linear-gradient(to right,#fff,#999);
      -webkit-background-clip:text;
      -webkit-text-fill-color:transparent;
      line-height:1.2;
    }

    /* Comparison */
    .comp-row{display:grid;grid-template-columns:1fr 1fr;background:#0a0a0a;border:1px solid var(--border-glass);margin-bottom:15px;border-radius:20px;overflow:hidden;box-shadow:0 10px 30px -10px rgba(0,0,0,.5);}
    .comp-col{padding:25px 15px;font-size:1rem;display:flex;flex-direction:column;justify-content:center;align-items:center;}
    .comp-mad{background:linear-gradient(135deg,rgba(217,119,6,.15),rgba(217,119,6,.05));border-left:1px solid rgba(217,119,6,.2);}

    /* Store */
    .sticky-cats{position:sticky;top:0;z-index:50;background:rgba(2,2,2,.95);backdrop-filter:blur(10px);padding:20px 0;border-bottom:1px solid var(--border-glass);}
    .cat-pill{padding:10px 25px;border-radius:99px;border:1px solid var(--border-glass);font-size:1rem;font-weight:600;cursor:pointer;transition:.3s;white-space:nowrap;}
    .cat-pill.active{background:var(--primary);color:#000;font-weight:800;border-color:var(--primary);}

    .product-card{background:#0a0a0a;border:1px solid var(--border-glass);border-radius:20px;overflow:hidden;position:relative;display:flex;flex-direction:column;}
    .add-btn{background:var(--primary);color:#000;font-weight:800;width:100%;padding:14px;margin-top:12px;border-radius:12px;font-size:1rem;}

    /* Drawer */
    .drawer{position:fixed;bottom:-100%;left:0;width:100%;height:75vh;background:#111;z-index:100;border-radius:30px 30px 0 0;transition:.4s;border-top:1px solid var(--primary);padding:25px;display:flex;flex-direction:column;}
    .drawer.open{bottom:0;}

    /* Modal overlay */
    .modal-overlay{position:fixed;inset:0;z-index:200;background:rgba(0,0,0,.9);backdrop-filter:blur(5px);display:none;align-items:center;justify-content:center;padding:20px;}

    /* ✅ FIXED SALE POPUP (FULLY VISIBLE) */
    .sale-box{
      width:100%;
      max-width:420px;
      max-height:90vh;
      background:#111;
      border:1px solid var(--primary);
      border-radius:24px;
      overflow:hidden;
      position:relative;
      display:flex;
      flex-direction:column;
    }
    .sale-media{
      width:100%;
      background:#000;
      display:flex;
      align-items:center;
      justify-content:center;
    }
    .sale-media img{
      width:100%;
      height:auto;
      max-height:48vh;
      object-fit:contain;
      display:block;
    }
    .sale-body{padding:20px;text-align:center;overflow:auto;}
    .timer-box{
      background:var(--primary);color:#000;
      text-align:center;padding:15px;font-size:2rem;font-weight:900;
      border-radius:12px;margin:12px 0 15px;
    }
  </style>
</head>

<body dir="rtl">

  <!-- LANGUAGE TOGGLE -->
  <div class="fixed top-6 right-6 z-50 flex gap-3">
    <button onclick="setLang('ar')" class="w-10 h-10 flex items-center justify-center bg-black/60 backdrop-blur rounded-full border border-white/20 text-sm font-bold text-white hover:border-amber-500 hover:text-amber-500 transition">AR</button>
    <button onclick="setLang('he')" class="w-10 h-10 flex items-center justify-center bg-black/60 backdrop-blur rounded-full border border-white/20 text-sm font-bold text-white hover:border-amber-500 hover:text-amber-500 transition">HE</button>
  </div>

  <!-- 1. VIDEO HEADER & BRANCH INFO -->
  <header class="video-header">
    <video autoplay muted loop playsinline class="video-bg">
      <source src="https://madparfumeurglobal.com/wp-content/uploads/2025/10/download.mp4" type="video/mp4">
    </video>
    <div class="video-overlay"></div>

    <div class="header-content pt-10">
      <img src="https://madperfume.ps/upload/01-2026/page/45CM.png" class="h-14 mx-auto mb-8 drop-shadow-[0_0_20px_rgba(217,119,6,0.6)]" alt="MAD">

      <div class="staff-avatar">
        <img src="https://madperfume.ps/upload/01-2026/page/6966930e9af7f.png" class="staff-img" alt="Staff">
        <div class="status-badge">
          <div class="status-dot" id="status-light"></div>
          <span id="status-text">Checking...</span>
        </div>
      </div>

      <h1 class="text-5xl md:text-7xl font-serif font-black text-white mb-3 tracking-wide" id="branch-name">MAD PARFUMEUR</h1>
      <p class="text-xl text-slate-300 mb-6 font-bold tracking-widest" id="work-hours">...</p>

      <div class="social-bar" id="social-container"></div>

      <div class="absolute bottom-10 left-1/2 -translate-x-1/2 animate-bounce text-slate-400">
        <i class="fas fa-chevron-down text-2xl"></i>
      </div>
    </div>
  </header>

  <!-- 2. NICHE STORY -->
  <section class="py-20 px-6 border-b border-white/5 bg-[#050505] text-center">
    <div class="max-w-4xl mx-auto">
      <span class="text-amber-500 text-sm font-black tracking-[0.4em] uppercase block mb-6" id="niche-tag">THE ART OF SCENT</span>
      <h2 class="section-title text-5xl md:text-6xl mb-8" id="niche-title">عطور النيش</h2>

      <div class="relative mb-14 mt-10">
        <div class="absolute top-1/2 left-1/2 -translate-x-1/2 -translate-y-1/2 w-[800px] h-[800px] bg-amber-500/10 blur-[100px] rounded-full"></div>
        <img src="https://madperfume.ps/upload/01-2026/page/69724b7327345.png" class="relative z-10 w-full max-w-[900px] mx-auto drop-shadow-2xl transition-transform duration-700 hover:scale-105" alt="">
      </div>

      <p class="text-slate-300 leading-loose text-xl font-light max-w-2xl mx-auto px-2" id="niche-desc"></p>
    </div>
  </section>

  <!-- 3. SELECTIVE -->
  <section class="py-20 px-4 bg-black relative overflow-hidden border-b border-white/5">
    <div class="relative z-10 text-center">
      <h2 class="text-4xl md:text-5xl font-serif font-black text-white italic mb-3">Selective Collection</h2>
      <p class="text-amber-500 font-bold text-lg mb-12 uppercase tracking-widest" id="sel-subtitle"></p>

      <img src="https://madperfume.ps/upload/01-2026/page/69724b7327f56.png" class="w-full max-w-[900px] mx-auto mb-12 drop-shadow-[0_30px_60px_rgba(217,119,6,0.3)]" alt="">
      <p class="text-slate-300 max-w-lg mx-auto text-lg leading-relaxed px-6" id="sel-desc"></p>
    </div>
  </section>

  <!-- 4. GLOBAL -->
  <section class="py-16 px-4 bg-[#080808] border-b border-white/5">
    <div class="grid grid-cols-3 gap-3 max-w-lg mx-auto text-center">
      <div class="bg-white/5 rounded-3xl p-6 border border-white/5 hover:border-amber-500/30 transition">
        <div class="text-3xl md:text-4xl font-black text-white mb-2">18</div>
        <div class="text-xs font-bold text-amber-500 uppercase tracking-widest" id="stat-country"></div>
      </div>
      <div class="bg-white/5 rounded-3xl p-6 border border-white/5 hover:border-amber-500/30 transition">
        <div class="text-3xl md:text-4xl font-black text-white mb-2">455+</div>
        <div class="text-xs font-bold text-amber-500 uppercase tracking-widest" id="stat-store"></div>
      </div>
      <div class="bg-white/5 rounded-3xl p-6 border border-white/5 hover:border-amber-500/30 transition">
        <div class="text-3xl md:text-4xl font-black text-white mb-2">26</div>
        <div class="text-xs font-bold text-amber-500 uppercase tracking-widest" id="stat-year"></div>
      </div>
    </div>
  </section>

  <!-- 5. MANIFESTO -->
  <section class="py-20 px-4 bg-black border-b border-white/5">
    <div class="text-center mb-12">
      <span class="text-amber-500 text-sm font-black tracking-widest uppercase block mb-2">THE MANIFESTO</span>
      <h2 class="text-4xl md:text-5xl text-white font-serif italic" id="comp-title"></h2>
    </div>
    <div class="max-w-xl mx-auto space-y-4" id="comparison-container"></div>
  </section>

  <!-- 6. STORE -->
  <section id="shop" class="bg-[#050505] min-h-screen pb-28">
    <div class="sticky-cats">
      <div class="flex overflow-x-auto gap-3 px-6 no-scrollbar" id="cats-container"></div>
    </div>
    <div class="grid grid-cols-2 gap-4 p-4 max-w-5xl mx-auto" id="products-grid"></div>
  </section>

  <!-- CART FAB -->
  <div onclick="toggleDrawer(true)" class="fixed bottom-8 left-8 z-40 bg-amber-500 text-black w-16 h-16 rounded-full flex items-center justify-center shadow-[0_0_40px_rgba(217,119,6,0.6)] cursor-pointer hover:scale-110 transition active:scale-95">
    <i class="fas fa-shopping-bag text-2xl"></i>
    <span id="cart-count" class="absolute -top-1 -right-1 bg-white text-black w-6 h-6 rounded-full text-sm font-black flex items-center justify-center border-2 border-black">0</span>
  </div>

  <!-- ✅ SALE POPUP -->
  <div id="sale-popup" class="modal-overlay">
    <div class="sale-box">
      <span style="position:absolute; top:12px; right:14px; font-size:2rem; color:#fff; cursor:pointer; z-index:10;" onclick="toggleSale(false)">&times;</span>
      <div class="sale-media">
        <img src="sale.png" alt="sale" onerror="this.style.display='none'">
      </div>
      <div class="sale-body">
        <h3 class="font-serif text-2xl mb-2 text-white" id="sale-title">عرض اليوم</h3>
        <div id="timer" class="timer-box">00:00:00</div>
        <button class="add-btn" style="margin:0;" id="sale-btn" onclick="claimOffer()">احصل على عرض اليوم</button>
      </div>
    </div>
  </div>

  <!-- CART DRAWER -->
  <div id="cart-drawer" class="drawer">
    <div class="flex justify-between items-center mb-8">
      <h2 class="text-2xl font-bold text-white" id="cart-title"></h2>
      <button onclick="toggleDrawer(false)" class="text-slate-400 p-2"><i class="fas fa-times text-2xl"></i></button>
    </div>
    <div id="cart-items" class="flex-1 overflow-y-auto space-y-4 pr-2"></div>
    <div class="border-t border-white/10 pt-6 mt-4">
      <div class="flex justify-between text-xl font-bold text-white mb-6">
        <span id="txt-total"></span>
        <span class="text-amber-500" id="cart-total">0 ₪</span>
      </div>
      <button onclick="checkout()" class="w-full py-5 bg-[#25D366] text-white rounded-2xl font-black text-lg flex items-center justify-center gap-3 hover:bg-[#20b857] transition shadow-lg active:scale-95">
        <i class="fab fa-whatsapp text-2xl"></i> <span id="txt-checkout"></span>
      </button>
    </div>
  </div>

  <script>
    /***************
     ✅ ضع الملفات بنفس مجلد الصفحة:
     - branches.json
     - products.csv
    ***************/
    const DATA_SOURCES = {
      branchesUrl: "./branches.json",
      productsCsvUrl: "./products.csv"
    };

    const params = new URLSearchParams(location.search);
    const branchID = parseInt(params.get("branch") || "1", 10);

    let STATE = { branch: null, products: [], cart: [] };
    let lang = "ar";
    let activeCat = "all";

    const TEXTS = {
      ar: {
        open: "مفتوح الآن", closed: "مغلق",
        add: "إضافة للسلة", added: "تمت الإضافة",
        all: "الكل",
        nicheT: "عطور النيش",
        nicheD: "في MAD، نحن لا نصنع العطور فحسب، بل نصمم حضوراً. عطور النيش لدينا تعتمد على ندرة المكونات وحرية الإبداع، بعيداً عن القيود التجارية.",
        selT: "مجموعة النخبة المختارة",
        selD: "أيقونة العطور الفاخرة التي تجمع بين الثبات الخارق (Extrait de Parfum) والمكونات النادرة المستوحاة من أعظم العطور العالمية.",
        statC: "دولة", statS: "نقطة بيع", statY: "عاماً",
        compTitle: "MAD vs بدائل الأسواق",
        compLabelOthers: "دبي / تركيا / خلط",
        compItems: [
          { icon: 'shield-check', title: 'الأمان والتراخيص', mad: 'آمن 100% (معتمد IFRA)', other: 'زيوت مجهولة المصدر' },
          { icon: 'flask', title: 'الهندسة العطرية', mad: 'تطابق جزيئي وتعتيق', other: 'خلط يدوي عشوائي' },
          { icon: 'droplets', title: 'مصدر الزيوت', mad: 'خلاصات أوروبية (نخب أول)', other: 'زيوت تجارية بالكيلو' },
          { icon: 'activity', title: 'التأثير الصحي', mad: 'هايبوالرجينيك', other: 'مذيبات تسبب الحساسية' },
          { icon: 'timer', title: 'الثبات والأداء', mad: 'Extrait (+24 ساعة)', other: 'يختفي بسرعة' }
        ],
        cartT: "سلة المشتريات", total: "المجموع:", check: "إتمام عبر واتساب",
        saleTitle: "عرض اليوم",
        saleBtn: "احصل على عرض اليوم",
        saleMsg: "مرحباً، أريد عرض اليوم"
      },
      he: {
        open: "פתוח עכשיו", closed: "סגור",
        add: "הוסף לסל", added: "נוסף",
        all: "הכל",
        nicheT: "בשמי נישה",
        nicheD: "ב-MAD אנחנו לא רק יוצרים בושם — אנחנו מעצבים נוכחות. בשמי הנישה שלנו מבוססים על נדירות ויצירתיות.",
        selT: "קולקציית העילית",
        selD: "אייקון של בשמי יוקרה עם עמידות יוצאת דופן ורכיבים נדירים.",
        statC: "מדינות", statS: "נקודות מכירה", statY: "שנים",
        compTitle: "MAD vs חיקויים",
        compLabelOthers: "דובאי / טורקיה",
        compItems: [
          { icon: 'shield-check', title: 'בטיחות ותקנים', mad: 'בטוח 100% (אישור IFRA)', other: 'שמנים ממקור לא ידוע' },
          { icon: 'flask', title: 'הנדסה ארומטית', mad: 'התאמה מולקולרית', other: 'ערבוב ידני אקראי' },
          { icon: 'droplets', title: 'מקור השמנים', mad: 'תמציות אירופאיות', other: 'שמנים זולים' },
          { icon: 'activity', title: 'השפעה בריאותית', mad: 'היפואלרגני', other: 'ממיסים גורמי אלרגיה' },
          { icon: 'timer', title: 'עמידות', mad: 'Extrait (24+ שעות)', other: 'מתנדף מהר' }
        ],
        cartT: "סל קניות", total: "סה״כ:", check: "הזמנה בווטסאפ",
        saleTitle: "מבצע היום",
        saleBtn: "קבלו את מבצע היום",
        saleMsg: "שלום, אני רוצה את מבצע היום"
      }
    };

    function setLang(l){
      lang = (l === "he") ? "he" : "ar";
      document.documentElement.dir = (lang === "ar") ? "rtl" : "ltr";
      renderAll();
    }

    function extractBranches(data){
      if(Array.isArray(data)) return data;
      if(data && Array.isArray(data.branches)) return data.branches;
      if(data && Array.isArray(data.data)) return data.data;
      return [];
    }

    function parseProductIdFromLink(link){
      if(!link) return null;
      const m = String(link).match(/product\.show\.(\d+)/i);
      return m ? parseInt(m[1],10) : null;
    }

    function parsePriceToNumber(val){
      if(val == null) return 0;
      const s = String(val).replace(/,/g,'');
      const m = s.match(/(\d+(\.\d+)?)/);
      return m ? parseFloat(m[1]) : 0;
    }

    function parseProductsCSV(csvText){
      const parsed = Papa.parse(csvText, { header:true, skipEmptyLines:true });
      const rows = parsed.data || [];
      const out = [];

      for(let i=0;i<rows.length;i++){
        const r = rows[i] || {};
        const title = (r["Title"] || "").toString().trim();
        const link = (r["Product Link"] || "").toString().trim();
        const img  = (r["Image"] || "").toString().trim();
        if(!title && !link && !img) continue;

        const id = parseProductIdFromLink(link) || (i+1);
        out.push({
          id,
          title,
          description: (r["Description"]||"").toString().trim(),
          link,
          img,
          additionalImages: (r["Additional Images"]||"").toString().trim(),
          video: (r["Video"]||"").toString().trim(),
          brand: (r["Brand"]||"").toString().trim(),
          availability: (r["Availability"]||"").toString().trim(),
          condition: (r["Condition"]||"").toString().trim(),
          price: parsePriceToNumber(r["Price"]),
          cat_he: (r["Category he"]||"").toString().trim(),
          cat_ar: (r["Category ar"]||"").toString().trim()
        });
      }
      return out;
    }

    async function loadData(){
      const [branchesRes, productsRes] = await Promise.all([
        fetch(DATA_SOURCES.branchesUrl, {cache:"no-store"}),
        fetch(DATA_SOURCES.productsCsvUrl, {cache:"no-store"})
      ]);

      if(!branchesRes.ok) throw new Error("branches.json not found");
      if(!productsRes.ok) throw new Error("products.csv not found");

      const branchesJSON = await branchesRes.json();
      const csvText = await productsRes.text();

      const branches = extractBranches(branchesJSON);
      if(!branches.length) throw new Error("No branches in branches.json");

      STATE.branch = branches.find(b => parseInt(b.id,10) === branchID) || branches[0];
      STATE.products = parseProductsCSV(csvText);
      if(!STATE.products.length) throw new Error("No products in products.csv");
    }

    function renderAll(){
      const t = TEXTS[lang];
      const b = STATE.branch;

      document.getElementById('branch-name').innerText = (lang==='ar') ? (b.name_ar || "MAD") : (b.name_he || "MAD");
      updateBranchStatus();

      // Socials (use social.waze directly ✅ no lat/lng)
      const s = b.social || {};
      const socContainer = document.getElementById('social-container');
      let socHTML = '';

      if(b.phone){
        // whatsapp from phone
        let phone = String(b.phone).replace(/\D/g,'');
        if(phone.startsWith('0')) phone = '972' + phone.substring(1);
        socHTML += `<a href="https://wa.me/${phone}" target="_blank" rel="noopener" class="social-btn" onclick="trackLead('WhatsApp')"><i class="fab fa-whatsapp"></i></a>`;
        socHTML += `<a href="tel:${b.phone}" class="social-btn" onclick="trackLead('Call')"><i class="fas fa-phone"></i></a>`;
      }
      if(s.instagram) socHTML += `<a href="${s.instagram}" target="_blank" rel="noopener" class="social-btn" onclick="trackLead('Instagram')"><i class="fab fa-instagram"></i></a>`;
      if(s.tiktok) socHTML += `<a href="${s.tiktok}" target="_blank" rel="noopener" class="social-btn" onclick="trackLead('TikTok')"><i class="fab fa-tiktok"></i></a>`;
      if(s.facebook) socHTML += `<a href="${s.facebook}" target="_blank" rel="noopener" class="social-btn" onclick="trackLead('Facebook')"><i class="fab fa-facebook-f"></i></a>`;
      if(s.snapchat) socHTML += `<a href="${s.snapchat}" target="_blank" rel="noopener" class="social-btn" onclick="trackLead('Snapchat')"><i class="fab fa-snapchat"></i></a>`;
      if(s.youtube) socHTML += `<a href="${s.youtube}" target="_blank" rel="noopener" class="social-btn" onclick="trackLead('YouTube')"><i class="fab fa-youtube"></i></a>`;
      if(s.email) socHTML += `<a href="mailto:${s.email}" class="social-btn" onclick="trackLead('Email')"><i class="fas fa-envelope"></i></a>`;
      if(s.waze) socHTML += `<a href="${s.waze}" target="_blank" rel="noopener" class="social-btn" onclick="trackLead('Waze')"><i class="fab fa-waze"></i></a>`;

      socContainer.innerHTML = socHTML;

      // Texts
      document.getElementById('niche-title').innerText = t.nicheT;
      document.getElementById('niche-desc').innerText = t.nicheD;
      document.getElementById('sel-subtitle').innerText = t.selT;
      document.getElementById('sel-desc').innerText = t.selD;
      document.getElementById('stat-country').innerText = t.statC;
      document.getElementById('stat-store').innerText = t.statS;
      document.getElementById('stat-year').innerText = t.statY;
      document.getElementById('cart-title').innerText = t.cartT;
      document.getElementById('txt-total').innerText = t.total;
      document.getElementById('txt-checkout').innerText = t.check;
      document.getElementById('comp-title').innerText = t.compTitle;

      // ✅ Popup language
      document.getElementById('sale-title').innerText = t.saleTitle;
      document.getElementById('sale-btn').innerText = t.saleBtn;

      renderComparison();
      renderCats();
      renderProducts();
      updateCart();
    }

    function updateBranchStatus(){
      const b = STATE.branch;
      const now = new Date();
      const days = ['sun','mon','tue','wed','thu','fri','sat'];
      const currentDay = days[now.getDay()];
      const currentTime = now.getHours()*60 + now.getMinutes();

      let isOpen = false;
      let hoursStr = "—";

      if(b.schedule && b.schedule[currentDay]){
        const slots = b.schedule[currentDay] || [];
        if(slots.length > 0) hoursStr = `${slots[0][0]} - ${slots[0][1]}`;
        slots.forEach(slot => {
          const startMins = parseInt(slot[0].split(':')[0])*60 + parseInt(slot[0].split(':')[1]);
          let endMins = parseInt(slot[1].split(':')[0])*60 + parseInt(slot[1].split(':')[1]);
          if(slot[1].startsWith("24")) endMins = 1440;
          if(currentTime >= startMins && currentTime < endMins) isOpen = true;
        });
      } else if(b.hours){
        hoursStr = b.hours;
      }

      document.getElementById('work-hours').innerText = hoursStr;

      const light = document.getElementById('status-light');
      const txt = document.getElementById('status-text');

      if(isOpen){
        light.style.background = 'var(--live-green)';
        light.style.boxShadow = '0 0 10px var(--live-green)';
        txt.innerText = TEXTS[lang].open;
        txt.style.color = 'var(--live-green)';
      } else {
        light.style.background = 'var(--live-red)';
        light.style.boxShadow = '0 0 10px var(--live-red)';
        txt.innerText = TEXTS[lang].closed;
        txt.style.color = 'var(--live-red)';
      }
    }

    function renderComparison(){
      const t = TEXTS[lang];
      const items = t.compItems || [];
      document.getElementById('comparison-container').innerHTML = items.map(item => `
        <div class="comp-row">
          <div class="comp-col comp-mad text-center">
            <div class="flex items-center justify-center gap-2 mb-2 text-amber-500 font-bold tracking-wider text-sm">
              <i data-lucide="${item.icon}" class="w-5 h-5"></i> ${item.title}
            </div>
            <div class="text-white font-black text-lg leading-tight">${item.mad}</div>
          </div>
          <div class="comp-col text-center" style="background:rgba(255,255,255,0.02); color:#666;">
            <div class="mb-2 text-[10px] font-bold tracking-widest text-slate-500 uppercase">${t.compLabelOthers}</div>
            <div class="text-red-400 font-bold text-lg leading-tight">${item.other}</div>
          </div>
        </div>
      `).join('');
      try{ lucide.createIcons(); }catch(e){}
    }

    function renderCats(){
      const catField = (lang === 'ar') ? 'cat_ar' : 'cat_he';
      const categories = [...new Set(STATE.products.map(p => p[catField]).filter(Boolean))];
      let html = `<div onclick="filterCat('all')" class="cat-pill ${activeCat==='all' ? 'active' : 'text-slate-400 border-white/10'}">${TEXTS[lang].all}</div>`;
      categories.forEach(c => {
        const safe = String(c).replace(/'/g,"\\'");
        html += `<div onclick="filterCat('${safe}')" class="cat-pill ${activeCat===c ? 'active' : 'text-slate-400 border-white/10'}">${c}</div>`;
      });
      document.getElementById('cats-container').innerHTML = html;
    }

    function filterCat(c){
      activeCat = c;
      renderCats();
      renderProducts();
    }

    function renderProducts(){
      const catField = (lang === 'ar') ? 'cat_ar' : 'cat_he';
      const list = (activeCat === 'all') ? STATE.products : STATE.products.filter(p => p[catField] === activeCat);

      document.getElementById('products-grid').innerHTML = list.map(p => {
        const inCart = STATE.cart.find(i => i.id === p.id);
        return `
          <div class="product-card">
            <div class="h-44 bg-white/5 flex items-center justify-center p-6 relative">
              <img src="${p.img || ''}" class="h-full object-contain drop-shadow-2xl hover:scale-110 transition duration-500" loading="lazy"
                   onerror="this.style.opacity=.2; this.style.filter='grayscale(1)';">
            </div>
            <div class="p-4 text-center flex-1 flex flex-col justify-between">
              <div>
                <h3 class="text-base font-bold text-white mb-1 h-12 overflow-hidden leading-snug">${p.title || ''}</h3>
                <p class="text-amber-500 font-black text-lg mb-2">${p.price || 0} ₪</p>
              </div>
              <button onclick="addToCart(${p.id})" class="add-btn ${inCart ? 'bg-slate-800 text-white' : ''}">
                ${inCart ? TEXTS[lang].added : TEXTS[lang].add}
              </button>
            </div>
          </div>
        `;
      }).join('');
    }

    function addToCart(id){
      const p = STATE.products.find(x => x.id === id);
      if(!p) return;
      if(!STATE.cart.find(i => i.id === id)) STATE.cart.push(p);
      renderProducts();
      updateCart();
      trackLead('Add To Cart');
    }

    function updateCart(){
      document.getElementById('cart-count').innerText = STATE.cart.length;
      let total = 0;

      document.getElementById('cart-items').innerHTML = STATE.cart.map(item => {
        total += item.price || 0;
        return `
          <div class="flex items-center gap-4 bg-white/5 p-4 rounded-2xl border border-white/5">
            <img src="${item.img || ''}" class="w-14 h-14 rounded-xl bg-black/50 object-cover" onerror="this.style.opacity=.2; this.style.filter='grayscale(1)';">
            <div class="flex-1">
              <div class="text-base font-bold text-white mb-1">${item.title || ''}</div>
              <div class="text-amber-500 text-sm font-bold">${item.price || 0} ₪</div>
            </div>
            <button onclick="removeFromCart(${item.id})" class="w-8 h-8 rounded-full bg-red-500/10 flex items-center justify-center text-red-500 hover:bg-red-500 hover:text-white transition"><i class="fas fa-trash text-sm"></i></button>
          </div>
        `;
      }).join('');

      document.getElementById('cart-total').innerText = total + ' ₪';
    }

    function removeFromCart(id){
      STATE.cart = STATE.cart.filter(i => i.id !== id);
      renderProducts();
      updateCart();
    }

    function toggleDrawer(open){
      const d = document.getElementById('cart-drawer');
      open ? d.classList.add('open') : d.classList.remove('open');
    }

    function toggleSale(open){
      const m = document.getElementById('sale-popup');
      if(open){ m.style.display='flex'; startTimer(); }
      else { m.style.display='none'; }
    }

    function checkout(){
      if(STATE.cart.length === 0) return;
      const b = STATE.branch;

      let phone = String(b.phone || '').replace(/\D/g,'');
      if(phone.startsWith('0')) phone = '972' + phone.substring(1);

      let msg = (lang==='ar') ? "مرحباً، أريد طلب:\n" : "שלום, אני רוצה להזמין:\n";
      STATE.cart.forEach(i => msg += `- ${i.title}\n`);
      msg += `\n${TEXTS[lang].total} ${document.getElementById('cart-total').innerText}`;

      trackLead('Cart Checkout');
      window.open(`https://api.whatsapp.com/send/?phone=${phone}&text=${encodeURIComponent(msg)}`, '_blank');
    }

    // ✅ FIXED (كان هنا الخطأ اللي كسر الصفحة)
    function claimOffer(){
      trackLead('Claim Offer');
      const b = STATE.branch;

      let phone = String(b.phone || '').replace(/\D/g,'');
      if(phone.startsWith('0')) phone = '972' + phone.substring(1);

      const msg = TEXTS[lang].saleMsg;
      window.open(`https://api.whatsapp.com/send/?phone=${phone}&text=${encodeURIComponent(msg)}`, '_blank');
    }

    let tInt;
    function startTimer(){
      clearInterval(tInt);
      tInt = setInterval(() => {
        const d = new Date();
        const end = new Date(); end.setHours(23,59,59,999);
        const diff = end - d;

        const h = Math.max(0, Math.floor(diff/3600000)).toString().padStart(2,'0');
        const m = Math.max(0, Math.floor((diff%3600000)/60000)).toString().padStart(2,'0');
        const s = Math.max(0, Math.floor((diff%60000)/1000)).toString().padStart(2,'0');
        document.getElementById('timer').innerText = `${h}:${m}:${s}`;
      }, 1000);
    }

    async function init(){
      // language detect
      const urlLang = params.get('lang');
      if(urlLang) lang = (urlLang === 'he') ? 'he' : 'ar';
      else lang = navigator.language.startsWith('ar') ? 'ar' : 'he';

      setLang(lang);

      try{
        await loadData();
        renderAll();
        setTimeout(() => toggleSale(true), 2500);
        document.body.style.opacity = "1";
      }catch(err){
        console.error(err);
        document.body.style.opacity = "1";
        alert(lang === 'ar'
          ? "خطأ تحميل البيانات: تأكد أن branches.json و products.csv موجودين بجانب الصفحة."
          : "שגיאת טעינה: ודא ש-branches.json ו-products.csv נמצאים לצד הדף."
        );
      }
    }

    init();
  </script>
</body>
</html>
