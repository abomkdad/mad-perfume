<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>متجر الجوال المتطور</title>
    <style>
        :root { --primary: #2563eb; --accent: #059669; --bg: #f8fafc; }
        body { font-family: 'Segoe UI', sans-serif; background: var(--bg); margin: 0; padding: 10px; }
        
        .grid-container { 
            display: grid; 
            grid-template-columns: repeat(auto-fill, minmax(160px, 1fr)); 
            gap: 15px; 
            padding-bottom: 100px;
        }

        .product-card { 
            background: white; border-radius: 12px; overflow: hidden;
            box-shadow: 0 4px 6px -1px rgba(0,0,0,0.1); display: flex; flex-direction: column;
        }

        .product-img { 
            width: 100%; height: 140px; object-fit: cover; background: #eee;
        }

        .product-details { padding: 10px; flex-grow: 1; }
        .product-name { font-weight: bold; font-size: 0.95rem; margin-bottom: 5px; height: 40px; overflow: hidden; }
        .price-tag { color: var(--accent); font-weight: bold; font-size: 1.1rem; }
        .expiry-date { font-size: 0.75rem; color: #ef4444; margin-top: 5px; }

        .qty-area { 
            display: flex; justify-content: space-between; align-items: center; 
            background: #f1f5f9; padding: 8px; border-top: 1px solid #e2e8f0;
        }

        .qty-btn { 
            width: 28px; height: 28px; border-radius: 6px; border: none;
            background: var(--primary); color: white; cursor: pointer;
        }

        .footer-cart { 
            position: fixed; bottom: 0; left: 0; right: 0; 
            background: white; padding: 15px; box-shadow: 0 -4px 10px rgba(0,0,0,0.1);
            display: flex; justify-content: space-between; align-items: center; z-index: 100;
        }

        .btn-confirm { 
            background: var(--accent); color: white; border: none; 
            padding: 12px 25px; border-radius: 8px; font-weight: bold; cursor: pointer;
        }

        #loader { display: none; position: fixed; inset: 0; background: rgba(255,255,255,0.9); z-index: 1000; align-items: center; justify-content: center; flex-direction: column; }
    </style>
</head>
<body>

<div id="loader">
    <div style="border: 4px solid #f3f3f3; border-top: 4px solid var(--primary); border-radius: 50%; width: 40px; height: 40px; animation: spin 1s linear infinite;"></div>
    <p>جاري معالجة طلبك...</p>
</div>

<h2 style="text-align: center;">قائمة المنتجات</h2>
<div class="grid-container" id="products-grid">
    </div>

<div class="footer-cart">
    <div>
        <span id="total-items">0</span> منتجات مختارة
    </div>
    <button class="btn-confirm" onclick="sendOrder()">تأكيد الطلب</button>
</div>

<script>
    const SHEET_JSON_URL = "https://docs.google.com/spreadsheets/d/1g3_D2NBwT27O2OI-v1R5tAB2QCfF3_ZCUL9sSLoCv54/gviz/tq?tqx=out:json";
    const SCRIPT_URL = "ضع_رابط_سكربت_جوجل_هنا"; 

    async function loadProducts() {
        try {
            const res = await fetch(SHEET_JSON_URL);
            const text = await res.text();
            const data = JSON.parse(text.substr(47).slice(0, -2));
            const rows = data.table.rows;
            
            let html = '';
            rows.forEach(row => {
                // تعيين المتغيرات بناءً على ترتيب الأعمدة في ملفك
                const name = row.c[1]?.v || "بدون اسم";       // Description (العمود B)
                const price = row.c[2]?.v || "0";            // price (العمود C)
                const imgUrl = row.c[3]?.v || "";            // imge link (العمود D)
                const symbol = row.c[4]?.v || "";            // Symbol (العمود E)
                const stock = row.c[6]?.v || 0;              // Quantity (العمود G)
                const expiry = row.c[8]?.v || "N/A";         // Expiry Date (العمود I)

                html += `
                <div class="product-card" data-name="${name}">
                    <img src="${imgUrl}" class="product-img" onerror="this.src='https://via.placeholder.com/150?text=No+Image'">
                    <div class="product-details">
                        <div class="product-name">${name}</div>
                        <div class="price-tag">${price} ${symbol}</div>
                        <div class="expiry-date">انتهاء: ${expiry}</div>
                        <div style="font-size:0.8rem; color: #666;">المخزون: ${stock}</div>
                    </div>
                    <div class="qty-area">
                        <button class="qty-btn" onclick="changeQty(this, -1)">-</button>
                        <span class="qty-val">0</span>
                        <button class="qty-btn" onclick="changeQty(this, 1)">+</button>
                    </div>
                </div>`;
            });
            document.getElementById('products-grid').innerHTML = html;
        } catch (e) {
            console.error(e);
            document.getElementById('products-grid').innerHTML = "حدث خطأ في جلب البيانات.";
        }
    }

    function changeQty(btn, delta) {
        const valSpan = btn.parentElement.querySelector('.qty-val');
        let current = parseInt(valSpan.innerText);
        let newVal = Math.max(0, current + delta);
        valSpan.innerText = newVal;
        updateTotal();
    }

    function updateTotal() {
        let total = 0;
        document.querySelectorAll('.qty-val').forEach(v => total += parseInt(v.innerText));
        document.getElementById('total-items').innerText = total;
    }

    async function sendOrder() {
        const products = document.querySelectorAll('.product-card');
        let orders = [];
        products.forEach(p => {
            let q = parseInt(p.querySelector('.qty-val').innerText);
            if(q > 0) orders.push({ name: p.getAttribute('data-name'), quantity: q });
        });

        if(orders.length === 0) return alert("اختر منتجات أولاً");
        
        document.getElementById('loader').style.display = 'flex';
        try {
            await fetch(SCRIPT_URL, { method: 'POST', mode: 'no-cors', body: JSON.stringify({ orders }) });
            alert("تم إرسال الطلب!");
            location.reload();
        } catch (e) {
            alert("خطأ في الاتصال");
            document.getElementById('loader').style.display = 'none';
        }
    }

    window.onload = loadProducts;
</script>

<style> @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } } </style>
</body>
</html>
