<!DOCTYPE html>
<html id="html-tag" lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width,initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>MAD PARFUMEUR | Elite Portal</title>

    <link href="https://fonts.googleapis.com/css2?family=Assistant:wght@400;700&family=Cairo:wght@400;700;900&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">

    <script>
        // Meta Pixel
        !function(f,b,e,v,n,t,s){if(f.fbq)return;n=f.fbq=function(){n.callMethod?
        n.callMethod.apply(n,arguments):n.queue.push(arguments)};
        if(!f._fbq)f._fbq=n;n.push=n;n.loaded=!0;n.version='2.0';
        n.queue=[];t=b.createElement(e);t.async=!0;
        t.src=v;s=b.getElementsByTagName(e)[0];
        s.parentNode.insertBefore(t,s)}(window,document,'script',
        'https://connect.facebook.net/en_US/fbevents.js');
        fbq('init', '1072283127290819'); // Meta Pixel ID من index.html
        fbq('track', 'PageView');

        // TikTok Pixel
        !function (w, d, t) {
            w.TiktokAnalyticsObject=t;var ttq=w[t]=w[t]||[];ttq.methods=["page","track","identify","instances","debug","on","off","once","ready","alias","group","enableCookie","disableCookie","holdConsent","revokeConsent","grantConsent"],ttq.setAndDefer=function(t,e){t[e]=function(){t.push([e].concat(Array.prototype.slice.call(arguments,0)))}};for(var i=0;i<ttq.methods.length;i++)ttq.setAndDefer(ttq,ttq.methods[i]);ttq.instance=function(t){for(var e=ttq._i[t]||[],n=0;n<ttq.methods.length;n++)ttq.setAndDefer(e,ttq.methods[n]);return e},ttq.load=function(e,n){var r="https://analytics.tiktok.com/i18n/pixel/events.js",o=n&&n.partner;ttq._i=ttq._i||{},ttq._i[e]=[],ttq._i[e]._u=r,ttq._t=ttq._t||{},ttq._t[e]=+new Date,ttq._o=ttq._o||{},ttq._o[e]=n||{};n=document.createElement("script");n.type="text/javascript",n.async=!0,n.src=r+"?sdkid="+e+"&lib="+t;e=document.getElementsByTagName("script")[0];e.parentNode.insertBefore(n,e)};
            ttq.load('D2D02JBC77U4ENLN9SBG'); // TikTok Pixel ID من index.html
            ttq.page();
        }(window, document, 'ttq');

        // وظيفة تتبع التحويل (Tracking Flow)
        function trackAction(event, name) {
            if(window.fbq) fbq('track', event, {content_name: name});
            if(window.ttq) ttq.track(event, {content_name: name});
        }
    </script>

    <style>
        :root { --mad-blue: #2A5CFF; --ice-white: #ffffff; --text-dark: #1a1a1a; --wa-green: #25D366; }
        * { box-sizing: border-box; margin: 0; padding: 0; }
        body { background: #fdfdfd; color: var(--text-dark); font-family: 'Cairo', sans-serif; }
        header { text-align: center; padding: 50px 20px; background: url('heder.svg') center/cover no-repeat; background-color: #fff; border-bottom: 2px solid var(--mad-blue); }
        .logo-img { max-width: 120px; margin-bottom: 15px; }
        .lang-switcher { position: absolute; top: 15px; left: 15px; display: flex; gap: 10px; z-index: 3000; }
        .lang-btn { background: #fff; border: 1px solid var(--mad-blue); color: var(--mad-blue); padding: 5px 12px; border-radius: 5px; font-weight: bold; cursor: pointer; font-size: 12px; }
        .lang-btn.active { background: var(--mad-blue); color: #fff; }
        .cats-wrapper { position: sticky; top: 0; z-index: 1000; background: rgba(255,255,255,0.9); backdrop-filter: blur(10px); border-bottom: 1px solid #eee; }
        .cats-container { display: flex; gap: 10px; overflow-x: auto; padding: 15px; scrollbar-width: none; }
        .cat-pill { background: #fff; border: 1px solid #ddd; padding: 8px 20px; border-radius: 50px; white-space: nowrap; font-weight: 700; cursor: pointer; }
        .cat-pill.active { background: var(--mad-blue); color: #fff; border-color: var(--mad-blue); }
        .shop-grid { display: grid; grid-template-columns: repeat(2, 1fr); gap: 15px; padding: 15px; }
        .p-card { background: #fff; border-radius: 15px; overflow: hidden; border: 1px solid #f0f0f0; display: flex; flex-direction: column; box-shadow: 0 4px 10px rgba(0,0,0,0.03); }
        .p-card img { width: 100%; aspect-ratio: 1/1; object-fit: cover; }
        .p-info { padding: 12px; text-align: center; }
        .add-btn { background: #fff; color: var(--mad-blue); border: 2px solid var(--mad-blue); padding: 10px; border-radius: 10px; font-weight: 900; width: 100%; margin-top: 8px; cursor: pointer; }
        .modal-overlay { position: fixed; inset: 0; background: rgba(0,0,0,0.85); display: none; align-items: center; justify-content: center; z-index: 10005; }
        .sale-box { width: 90%; max-width: 400px; background: #fff; border-radius: 20px; overflow: hidden; position: relative; }
        .timer-box { background: #000; color: #fff; text-align: center; padding: 15px; font-size: 1.5rem; font-weight: 900; }
        .drawer { position: fixed; bottom: -100%; left: 0; width: 100%; height: 75%; background: #fff; border-top: 5px solid var(--mad-blue); z-index: 10001; transition: 0.5s; padding: 25px; border-radius: 30px 30px 0 0; }
        .drawer.open { bottom: 0; }
    </style>
</head>
<body>

    <div class="lang-switcher">
        <button id="btn-ar" class="lang-btn active" onclick="switchLang('ar')">AR</button>
        <button id="btn-he" class="lang-btn" onclick="switchLang('he')">HE</button>
    </div>

    <header>
        <img src="logo.svg" class="logo-img" onerror="this.src='logo.png'">
        <h1 id="br-name" style="font-family:'Cinzel'; color:var(--mad-blue);">MAD PARFUMEUR</h1>
        <p id="open-status" style="font-weight: bold; color: #666;"></p>
    </header>

    <div class="cats-wrapper"><div id="cats-box" class="cats-container"></div></div>
    <main id="main-grid" class="shop-grid"></main>

    <div id="cart-drawer" class="drawer">
        <h3 id="cart-title" style="text-align:center; margin-bottom:20px;">حقيبة التسوق</h3>
        <div id="cart-list" style="max-height: 60%; overflow-y: auto;"></div>
        <button id="checkout-btn" class="add-btn" style="background:var(--wa-green); color:#fff; border:none; padding:15px; margin-top:20px;" onclick="sendOrder()">إرسال الطلب</button>
        <button onclick="toggleCart(false)" style="width:100%; margin-top:15px; border:none; color:gray; background:none;">إغلاق</button>
    </div>

    <div id="sale-popup" class="modal-overlay">
        <div class="sale-box">
            <img src="sale.svg" style="width:100%;" onerror="this.src='sale.png'">
            <div id="timer" class="timer-box">00:00:00</div>
            <button id="sale-btn" onclick="claimOffer()" style="width:100%; padding:15px; background:var(--mad-blue); color:#fff; border:none; font-weight:900;">استفد من العرض</button>
        </div>
    </div>

    <script>
        let currentLang = 'ar'; // اللغة الافتراضية
        let STATE = { branch: null, products: [], cart: [] };

        const TXT = {
            ar: { cart: "حقيبة التسوق", send: "إرسال الطلب واتساب", sale: "استفد من العرض", close: "إغلاق", add: "إضافة", all: "الكل" },
            he: { cart: "סל קניות", send: "שלח הזמנה בוואטסאפ", sale: "קבל את ההצעה", close: "סגור", add: "הוסף", all: "הכל" }
        };

        async function init() {
            try {
                const bj = await fetch('branches.json').then(r => r.json());
                const pc = await fetch('products.csv').then(r => r.text());
                const params = new URLSearchParams(window.location.search);
                const branchID = params.get('branch') || 1;
                STATE.branch = bj.branches.find(b => b.id == branchID) || bj.branches[0];
                parseCSV(pc);
                renderUI();
                setTimeout(() => toggleSale(true), 3000);
                startTimer();
            } catch(e) { console.error("Data Load Fail", e); }
        }

        function switchLang(lang) {
            currentLang = lang;
            document.body.dir = lang === 'ar' ? 'rtl' : 'ltr';
            document.getElementById('html-tag').lang = lang;
            document.getElementById('btn-ar').classList.toggle('active', lang === 'ar');
            document.getElementById('btn-he').classList.toggle('active', lang === 'he');
            renderUI(); // إعادة رسم الواجهة باللغة الجديدة
        }

        function parseCSV(text) {
            const rows = text.split('\n').slice(1);
            STATE.products = rows.map(row => {
                const cols = row.split(/,(?=(?:(?:[^"]*"){2})*[^"]*$)/);
                if(cols.length < 11) return null;
                return { name: cols[0].replace(/"/g,''), img: cols[3].trim(), price: cols[9].trim(), catAr: cols[11]?.trim(), catHe: cols[10]?.trim() };
            }).filter(p => p);
        }

        function renderUI() {
            const t = TXT[currentLang];
            document.getElementById('br-name').textContent = currentLang === 'ar' ? STATE.branch.name_ar : STATE.branch.name_he;
            document.getElementById('cart-title').textContent = t.cart;
            document.getElementById('checkout-btn').textContent = t.send;
            document.getElementById('sale-btn').textContent = t.sale;

            const cats = [t.all, ...new Set(STATE.products.map(p => currentLang === 'ar' ? p.catAr : p.catHe))];
            document.getElementById('cats-box').innerHTML = cats.map(c => 
                `<div class="cat-pill ${c===t.all?'active':''}" onclick="renderGrid('${c}', this)">${c}</div>`
            ).join('');
            renderGrid(t.all);
        }

        function renderGrid(cat, el) {
            if(el) {
                document.querySelectorAll('.cat-pill').forEach(p => p.classList.remove('active'));
                el.classList.add('active');
            }
            const grid = document.getElementById('main-grid');
            const t = TXT[currentLang];
            const list = cat === t.all ? STATE.products : STATE.products.filter(p => (currentLang === 'ar' ? p.catAr : p.catHe) === cat);
            grid.innerHTML = list.map(p => `
                <div class="p-card">
                    <img src="${p.img}">
                    <div class="p-info">
                        <div style="font-size:0.8rem; font-weight:700; height:40px; overflow:hidden;">${p.name}</div>
                        <div style="color:var(--mad-blue); font-weight:900;">${p.price}</div>
                        <button class="add-btn" onclick="addToCart('${p.name}')">${t.add}</button>
                    </div>
                </div>`).join('');
        }

        function addToCart(name) {
            STATE.cart.push(name);
            trackAction('AddToCart', name); // تتبع إضافة للسلة
            alert(currentLang === 'ar' ? 'تمت الإضافة' : 'נוסף לסל');
            updateCartList();
        }

        function toggleSale(s) { document.getElementById('sale-popup').style.display = s ? 'flex' : 'none'; }
        function toggleCart(s) { document.getElementById('cart-drawer').classList.toggle('open', s); }

        function sendOrder() {
            if(STATE.cart.length === 0) return;
            trackAction('Lead', 'Order initiated'); // تتبع التحويل
            let text = (currentLang === 'ar' ? "طلب جديد:\n" : "הזמנה חדשה:\n") + STATE.cart.join('\n');
            window.open(`https://wa.me/972${STATE.branch.phone.substring(1)}?text=${encodeURIComponent(text)}`);
        }

        function startTimer() {
            setInterval(() => {
                const d = new Date().setHours(23,59,59) - new Date();
                const h = Math.floor(d/3600000).toString().padStart(2,'0');
                const m = Math.floor((d%3600000)/60000).toString().padStart(2,'0');
                const s = Math.floor((d%60000)/1000).toString().padStart(2,'0');
                document.getElementById('timer').textContent = `${h}:${m}:${s}`;
            }, 1000);
        }
        init();
    </script>
</body>
</html>
