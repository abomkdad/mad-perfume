<!DOCTYPE html>
<html lang="he">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>MAD PARFUMEUR | Premium Branch Page</title>
    
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link href="https://fonts.googleapis.com/css2?family=Cinzel:wght@700&family=Assistant:wght@300;400;700&display=swap" rel="stylesheet">

    <style>
        :root { --gold: #D4AF37; --black: #000; --card: #111; --white: #fff; --wa: #25D366; }
        * { box-sizing: border-box; margin: 0; padding: 0; }
        body { background: var(--black); color: var(--white); font-family: 'Assistant', sans-serif; -webkit-font-smoothing: antialiased; opacity: 0; transition: opacity 0.3s ease; }
        
        /* Layout */
        .container { max-width: 1200px; margin: 0 auto; padding: 0 15px; }
        header { padding: 30px 0; text-align: center; border-bottom: 1px solid #222; }
        .logo { font-family: 'Cinzel', serif; color: var(--gold); font-size: 2.2rem; letter-spacing: 4px; text-transform: uppercase; }
        .br-name { font-size: 1.3rem; margin: 10px 0; font-weight: 300; }
        
        .status-pill { display: inline-block; padding: 5px 15px; border-radius: 20px; font-size: 0.8rem; font-weight: 700; border: 1px solid; }
        .open { color: var(--wa); border-color: var(--wa); background: rgba(37,211,102,0.1); }
        .closed { color: #ff4d4d; border-color: #ff4d4d; background: rgba(255,77,77,0.1); }

        .socials { display: flex; justify-content: center; gap: 18px; margin-top: 15px; }
        .socials a { color: #fff; font-size: 1.3rem; transition: 0.2s; opacity: 0.7; }
        .socials a:hover { color: var(--gold); opacity: 1; transform: translateY(-2px); }

        /* Navigation */
        .nav-sticky { position: sticky; top: 0; background: var(--black); z-index: 1000; padding: 12px 0; border-bottom: 1px solid #222; }
        .cats { display: flex; gap: 10px; overflow-x: auto; scrollbar-width: none; }
        .cats::-webkit-scrollbar { display: none; }
        .c-btn { background: #1a1a1a; color: #fff; border: 1px solid #333; padding: 8px 18px; border-radius: 4px; cursor: pointer; white-space: nowrap; font-size: 0.9rem; border: 1px solid transparent; transition: 0.2s; }
        .c-btn.active { background: var(--gold); color: #000; font-weight: 700; border-color: var(--gold); }

        /* Grid */
        .grid { display: grid; grid-template-columns: repeat(2, 1fr); gap: 12px; padding: 20px 0 80px; }
        @media (min-width: 768px) { .grid { grid-template-columns: repeat(4, 1fr); gap: 20px; } }
        
        .card { background: var(--card); border: 1px solid #222; border-radius: 4px; overflow: hidden; display: flex; flex-direction: column; }
        .img-box { width: 100%; aspect-ratio: 1/1; background: #000; position: relative; }
        .img-box img { width: 100%; height: 100%; object-fit: cover; opacity: 0; transition: opacity 0.4s; }
        .img-box img.loaded { opacity: 1; }

        .info { padding: 12px; text-align: center; flex-grow: 1; display: flex; flex-direction: column; }
        .p-title { font-size: 0.9rem; height: 2.8em; overflow: hidden; margin-bottom: 8px; font-family: 'Cinzel', serif; line-height: 1.4; }
        .p-price { color: var(--gold); font-weight: 700; margin-bottom: 12px; font-size: 1.1rem; }
        .wa-btn { background: var(--wa); color: #fff; text-decoration: none; padding: 12px; border-radius: 4px; font-weight: 700; font-size: 0.85rem; display: flex; align-items: center; justify-content: center; gap: 6px; }

        /* Popup */
        #pop { position: fixed; inset: 0; background: rgba(0,0,0,0.9); z-index: 9999; display: none; align-items: center; justify-content: center; padding: 20px; }
        .pop-box { width: 100%; max-width: 400px; background: #000; border: 1px solid var(--gold); position: relative; }
        .pop-close { position: absolute; top: -40px; right: 0; color: #fff; font-size: 2rem; cursor: pointer; }
        .pop-timer { background: var(--gold); color: #000; padding: 10px; text-align: center; font-weight: 900; }
        .pop-wa { display: block; background: var(--wa); color: #fff; text-align: center; padding: 15px; text-decoration: none; font-weight: 900; }
    </style>
</head>
<body>

<header>
    <div class="container">
        <h1 class="logo">MAD PARFUMEUR</h1>
        <div id="br-name" class="br-name"></div>
        <div id="br-status"></div>
        <div id="br-socials" class="socials"></div>
    </div>
</header>

<div class="nav-sticky">
    <div class="container">
        <nav id="br-cats" class="cats"></nav>
    </div>
</div>

<main class="container">
    <div id="br-grid" class="grid"></div>
</main>

<div id="pop">
    <div class="pop-box">
        <span class="pop-close" onclick="closePop()">&times;</span>
        <img src="sale.png" style="width:100%; display:block;">
        <div id="timer" class="pop-timer">00:00:00</div>
        <a href="#" id="pop-wa" class="pop-wa">CLAIM OFFER</a>
    </div>
</div>

<script>
/**
 * MAD PARFUMEUR - CORE ENGINE (FIXED & OPTIMIZED)
 */
const App = {
    branchId: new URLSearchParams(window.location.search).get('branch') || '1',
    lang: navigator.language.startsWith('ar') ? 'ar' : 'he',
    branch: null,
    products: [],
    timer: null,
    i18n: {
        he: { dir: 'ltr', open: "פתוח עכשيو", closed: "סגור כעת", all: "הכל", order: "הזמנה", msg: "היי, אני מעוניין ב: " },
        ar: { dir: 'rtl', open: "مفتوح الآن", closed: "مغلق حالياً", all: "الكل", order: "طلب", msg: "مرحباً، أنا مهتم بـ: " }
    }
};

// WA Number Normalizer (052 -> 97252)
const normWA = num => num.startsWith('0') ? '972' + num.substring(1) : num;

// Central Tracking
const logEvent = (action, label = '') => {
    const data = { branch: App.branchId, action, label };
    console.log("Tracking:", data);
    if(window.fbq) fbq('track', 'Lead', { content_name: action, content_category: label });
    if(window.ttq) ttq.track('SubmitForm', { contents: [{ content_name: action }] });
};

// Robust CSV Parser (Handles quoted commas)
const parseCSV = text => {
    const lines = text.split(/\r?\n/).filter(l => l.trim());
    const headers = lines[0].split(',').map(h => h.trim());
    return lines.slice(1).map(line => {
        const values = line.split(/,(?=(?:(?:[^"]*"){2})*[^"]*$)/);
        let obj = {};
        headers.forEach((h, i) => obj[h] = values[i]?.replace(/^"|"$/g, '').trim() || "");
        return obj;
    });
};

const renderGrid = (filter = 'all') => {
    const grid = document.getElementById('br-grid');
    grid.innerHTML = '';
    const catKey = "Category (g:product_type)";
    
    // FILTER: Only show products where CSV ID (or BranchID if exists) matches current Branch
    const filtered = App.products.filter(p => {
        const branchMatch = p.ID == App.branchId || p.BranchID == App.branchId;
        const catMatch = filter === 'all' || p[catKey] === filter;
        return branchMatch && catMatch;
    });

    const frag = document.createDocumentFragment();
    filtered.forEach(p => {
        const card = document.createElement('div');
        card.className = 'card';
        card.innerHTML = `
            <div class="img-box"><img data-src="${p.Image}" src="data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7"></div>
            <div class="info">
                <div class="p-title">${p.Title}</div>
                <div class="p-price">${p.Price}</div>
                <a href="https://wa.me/${normWA(App.branch.phone)}?text=${encodeURIComponent(App.i18n[App.lang].msg + p.Title)}" 
                   target="_blank" class="wa-btn" onclick="logEvent('WhatsApp_Order', '${p.Title}')">
                   <i class="fab fa-whatsapp"></i> ${App.i18n[App.lang].order}
                </a>
            </div>`;
        frag.appendChild(card);
    });
    grid.appendChild(frag);

    // Fast Lazy Loading
    const obs = new IntersectionObserver(entries => {
        entries.forEach(en => {
            if(en.isIntersecting) {
                const img = en.target;
                img.src = img.dataset.src;
                img.onload = () => img.classList.add('loaded');
                obs.unobserve(img);
            }
        });
    }, { rootMargin: '100px' });
    grid.querySelectorAll('img').forEach(i => obs.observe(i));
};

const renderCats = () => {
    const catKey = "Category (g:product_type)";
    const branchProds = App.products.filter(p => p.ID == App.branchId || p.BranchID == App.branchId);
    const cats = [App.i18n[App.lang].all, ...new Set(branchProds.map(p => p[catKey]))].filter(Boolean);
    const nav = document.getElementById('br-cats');
    cats.forEach(c => {
        const btn = document.createElement('button');
        btn.className = 'c-btn' + (c === App.i18n[App.lang].all ? ' active' : '');
        btn.textContent = c;
        btn.onclick = () => {
            document.querySelectorAll('.c-btn').forEach(b => b.classList.remove('active'));
            btn.classList.add('active');
            renderGrid(c === App.i18n[App.lang].all ? 'all' : c);
        };
        nav.appendChild(btn);
    });
};

function closePop() {
    document.getElementById('pop').style.display = 'none';
    if(App.timer) clearInterval(App.timer);
    localStorage.setItem('mad_v2_' + new Date().toDateString(), '1');
}

async function boot() {
    try {
        const [r1, r2] = await Promise.all([fetch('test.json'), fetch('products.csv')]);
        const bData = await r1.json();
        App.branch = bData.branches.find(b => b.id == App.branchId) || bData.branches[0];
        App.products = parseCSV(await r2.text());

        // Language & UI Direction
        document.documentElement.lang = App.lang;
        document.body.dir = App.i18n[App.lang].dir;
        document.getElementById('br-name').textContent = App.branch[`name_${App.lang}`];

        // Status Logic
        const now = new Date();
        const sched = App.branch.schedule[['sun','mon','tue','wed','thu','fri','sat'][now.getDay()]];
        const nowM = now.getHours() * 60 + now.getMinutes();
        const isOpen = sched && sched.some(r => {
            const [sH, sM] = r[0].split(':').map(Number);
            const [eH, eM] = r[1].split(':').map(Number);
            return nowM >= (sH*60+sM) && nowM < (eH*60+eM);
        });
        document.getElementById('br-status').innerHTML = `<span class="status-pill ${isOpen?'open':'closed'}">${isOpen?App.i18n[App.lang].open:App.i18n[App.lang].closed}</span>`;

        // Socials
        const socMap = { tiktok:'fa-tiktok', instagram:'fa-instagram', facebook:'fa-facebook', waze:'fa-waze', email:'fa-envelope', snapchat:'fa-snapchat' };
        document.getElementById('br-socials').innerHTML = Object.entries(App.branch.social)
            .map(([k,v]) => v ? `<a href="${v}" target="_blank" onclick="logEvent('Social_Click', '${k}')"><i class="fab ${socMap[k]||'fa-link'}"></i></a>` : '').join('');

        renderCats();
        renderGrid();

        // Popup Logic
        if(!localStorage.getItem('mad_v2_' + new Date().toDateString())) {
            setTimeout(() => {
                document.getElementById('pop').style.display = 'flex';
                document.getElementById('pop-wa').href = `https://wa.me/${normWA(App.branch.phone)}?text=DailyOffer`;
                document.getElementById('pop-wa').onclick = () => logEvent('Popup_CTA_Click');
                App.timer = setInterval(() => {
                    const diff = new Date().setHours(23,59,59) - new Date();
                    const h = Math.floor(diff/3600000).toString().padStart(2,'0');
                    const m = Math.floor((diff%3600000)/60000).toString().padStart(2,'0');
                    const s = Math.floor((diff%60000)/1000).toString().padStart(2,'0');
                    document.getElementById('timer').textContent = `${h}:${m}:${s}`;
                }, 1000);
            }, 3000);
        }

        document.body.style.opacity = '1';
    } catch(e) { console.error("Boot Error", e); }
}

window.addEventListener('DOMContentLoaded', boot);
</script>
</body>
</html>
