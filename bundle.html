<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>MAD - Ø¨Ø§Ù‚Ø© Ù…Ø®ØªØ§Ø±Ø©</title>

  <!-- OG Preview (ÙˆØ§ØªØ³Ø§Ø¨ ÙŠØ¹Ø±Ø¶ ØµÙˆØ±Ø© ÙˆØ§Ø­Ø¯Ø© ÙÙ‚Ø· - Ø·Ø¨ÙŠØ¹ÙŠ) -->
  <meta property="og:title" content="MAD - Ø¨Ø§Ù‚Ø© Ù…Ø®ØªØ§Ø±Ø©" />
  <meta property="og:description" content="Ø§Ø®ØªØ± Ø§Ù„Ù…Ù†ØªØ¬Ø§Øª Ø§Ù„Ù…ÙØ¶Ù„Ø© ÙˆØ£Ø±Ø³Ù„ Ø§Ù„Ø·Ù„Ø¨ Ø¹Ø¨Ø± ÙˆØ§ØªØ³Ø§Ø¨" />
  <meta property="og:type" content="website" />
  <meta property="og:image" content="https://www.mad-parfumeur.com/assets/hero/logo.png" />
  <meta property="og:image:width" content="1200" />
  <meta property="og:image:height" content="630" />

  <script src="https://cdn.tailwindcss.com"></script>

  <style>
    body {
      font-family: Arial, sans-serif;
      background:
        radial-gradient(1200px 600px at 20% 0%, rgba(197,160,89,.25), transparent 55%),
        radial-gradient(900px 500px at 80% 10%, rgba(0,0,0,.12), transparent 55%),
        linear-gradient(180deg, #0b0d10, #0f1116 45%, #f6f7f9 45%, #f6f7f9);
    }
    .glass { backdrop-filter: blur(16px); -webkit-backdrop-filter: blur(16px); background: rgba(255,255,255,.10); border: 1px solid rgba(255,255,255,.18); }
    .glassLight { backdrop-filter: blur(16px); -webkit-backdrop-filter: blur(16px); background: rgba(255,255,255,.78); border: 1px solid rgba(255,255,255,.55); }
    .shadowLux { box-shadow: 0 18px 55px rgba(0,0,0,.18); }
    .shadowSoft { box-shadow: 0 12px 32px rgba(0,0,0,.10); }
    .card { transition: .18s transform, .18s box-shadow; }
    .card:hover { transform: translateY(-2px); box-shadow: 0 18px 55px rgba(0,0,0,.16); }
    .goldText { background: linear-gradient(90deg, #f6e27a, #c5a059, #fff2b6); -webkit-background-clip: text; background-clip: text; color: transparent; }
    .goldBorder { border: 1px solid rgba(197,160,89,.45); }
    .btnGold { background: linear-gradient(135deg, #f6e27a, #c5a059); color:#111; }
    .btnGold:hover { filter: brightness(1.03); }
    .btnDark { background: linear-gradient(180deg, #161a22, #0f1218); color: #fff; }
    .btnDark:hover { filter: brightness(1.05); }
    .qtyBadge { min-width: 36px; height: 36px; display:flex; align-items:center; justify-content:center; border-radius: 999px; font-weight: 900; }
    .pill { border-radius: 999px; }
    .fadeIn { animation: fadeIn .25s ease-out both; }
    @keyframes fadeIn { from { opacity: 0; transform: translateY(6px);} to {opacity:1; transform:none;} }
  </style>
</head>

<body class="min-h-screen">

  <!-- Top Bar -->
  <div class="sticky top-0 z-40">
    <div class="glass shadowLux">
      <div class="max-w-7xl mx-auto px-4 py-4 flex items-center justify-between gap-3">
        <div class="flex items-center gap-3">
          <div class="w-11 h-11 rounded-2xl bg-white/10 border border-white/15 flex items-center justify-center overflow-hidden">
            <img src="https://www.mad-parfumeur.com/assets/hero/logo.png" class="w-9 h-9 object-contain" alt="MAD">
          </div>
          <div>
            <div class="font-black text-lg leading-6 text-white">
              <span class="goldText">MAD</span> <span id="t_title">- Ø¨Ø§Ù‚Ø© Ù…Ø®ØªØ§Ø±Ø©</span>
            </div>
            <div class="text-xs text-white/70" id="t_sub">Ø§Ø®ØªØ± Ø§Ù„Ù…Ù†ØªØ¬Ø§Øª Ø§Ù„Ù…ÙØ¶Ù„Ø© ÙˆØ£Ø±Ø³Ù„ Ø§Ù„Ø·Ù„Ø¨ Ø¹Ø¨Ø± ÙˆØ§ØªØ³Ø§Ø¨</div>
          </div>
        </div>

        <button id="langBtn" class="px-4 py-2 pill btnDark shadowSoft text-sm font-bold">
          Ø¹Ø±Ø¨ÙŠ / ×¢×‘×¨×™×ª
        </button>
      </div>

      <div class="max-w-7xl mx-auto px-4 pb-4">
        <div class="glassLight shadowSoft rounded-3xl p-3 md:p-4">
          <div class="text-[11px] text-gray-600 leading-5" id="notePreview">
            Ù…Ù„Ø§Ø­Ø¸Ø©: ÙˆØ§ØªØ³Ø§Ø¨ ÙŠØ¹Ø±Ø¶ Preview ÙˆØ§Ø­Ø¯ Ù„Ù„ØµÙØ­Ø© ÙÙ‚Ø· â€” Ø¯Ø§Ø®Ù„ Ø§Ù„ØµÙØ­Ø© Ø³ØªØ¸Ù‡Ø± ÙƒÙ„ Ø§Ù„ØµÙˆØ±.
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- Content -->
  <div class="max-w-7xl mx-auto px-4 pt-4 pb-10">

    <!-- Mini Stats -->
    <div class="grid grid-cols-2 gap-3">
      <div class="glassLight shadowSoft rounded-3xl p-4">
        <div class="text-xs text-gray-500" id="t_products">Products</div>
        <div class="mt-1 text-2xl font-black"><span id="countBox">0</span></div>
      </div>
      <div class="glassLight shadowSoft rounded-3xl p-4">
        <div class="text-xs text-gray-500" id="t_wa">WhatsApp</div>
        <div class="mt-1 text-lg font-black" id="waBox">â€”</div>
      </div>
    </div>

    <!-- Products -->
    <div class="mt-6">
      <div class="flex items-center justify-between mb-3">
        <div class="font-black text-lg" id="t_selected_products">Ø§Ù„Ù…Ù†ØªØ¬Ø§Øª Ø§Ù„Ù…Ø®ØªØ§Ø±Ø©</div>
        <div class="text-xs text-gray-500" id="t_hint">ÙŠÙ…ÙƒÙ†Ùƒ ØªØ¹Ø¯ÙŠÙ„ Ø§Ù„ÙƒÙ…ÙŠØ© Ø£Ùˆ Ø­Ø°Ù Ø§Ù„Ù…Ù†ØªØ¬</div>
      </div>

      <div id="productsGrid" class="grid grid-cols-1 sm:grid-cols-2 md:grid-cols-3 lg:grid-cols-4 gap-4"></div>

      <div id="emptyState" class="hidden mt-4 p-6 rounded-3xl glassLight shadowSoft text-center text-gray-700 fadeIn">
        <div class="font-black text-lg" id="t_empty">Ù„Ø§ ÙŠÙˆØ¬Ø¯ Ù…Ù†ØªØ¬Ø§Øª ÙÙŠ Ø§Ù„Ø¨Ø§Ù‚Ø©</div>
        <div class="text-sm text-gray-500 mt-1" id="t_empty2">Ø§Ø±Ø¬Ø¹ Ù„ØµÙØ­Ø© Ø§Ù„Ø§Ø®ØªÙŠØ§Ø± ÙˆØ£Ù†Ø´Ø¦ Ø¨Ø§Ù‚Ø© Ø¬Ø¯ÙŠØ¯Ø©.</div>
      </div>
    </div>

    <!-- Order Form -->
    <div class="mt-8 glassLight shadowLux rounded-3xl p-4 md:p-6">
      <div class="flex items-center justify-between">
        <div class="font-black text-xl" id="t_form_title">ÙÙˆØ±Ù… Ø§Ù„Ø·Ù„Ø¨</div>
        <div class="text-xs text-gray-500" id="t_form_note">Ø³ÙŠØªÙ… Ø¥Ø±Ø³Ø§Ù„ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ù„Ù„ÙˆØ§ØªØ³Ø§Ø¨</div>
      </div>

      <div class="mt-4 grid grid-cols-1 md:grid-cols-2 gap-3">
        <div>
          <div class="text-xs text-gray-500 mb-1" id="t_name">Ø§Ù„Ø§Ø³Ù…</div>
          <input id="custName" class="w-full border rounded-2xl p-3 bg-white/90" placeholder="Ø§Ù„Ø§Ø³Ù… Ø§Ù„ÙƒØ§Ù…Ù„" />
        </div>
        <div>
          <div class="text-xs text-gray-500 mb-1" id="t_phone">Ø§Ù„ØªÙ„ÙÙˆÙ†</div>
          <input id="custPhone" class="w-full border rounded-2xl p-3 bg-white/90" placeholder="Ø±Ù‚Ù… Ø§Ù„ØªÙ„ÙÙˆÙ†" inputmode="tel" />
        </div>
      </div>

      <div class="mt-3">
        <div class="text-xs text-gray-500 mb-1" id="t_address">Ø§Ù„Ø¹Ù†ÙˆØ§Ù†</div>
        <textarea id="custAddress" class="w-full border rounded-2xl p-3 bg-white/90" rows="3" placeholder="Ø§Ù„Ø¹Ù†ÙˆØ§Ù† Ø§Ù„ÙƒØ§Ù…Ù„"></textarea>
      </div>

      <div class="mt-4 grid grid-cols-1 md:grid-cols-2 gap-3">
        <div class="rounded-3xl bg-white/85 border p-4 shadowSoft">
          <div class="text-sm font-black mb-2" id="t_pay">Ø·Ø±ÙŠÙ‚Ø© Ø§Ù„Ø¯ÙØ¹</div>
          <label class="flex items-center gap-2 text-sm"><input type="radio" name="pay" value="COD" checked> <span id="t_cod">Ø§Ù„Ø¯ÙØ¹ Ø¹Ù†Ø¯ Ø§Ù„Ø§Ø³ØªÙ„Ø§Ù…</span></label>
          <label class="flex items-center gap-2 text-sm mt-2"><input type="radio" name="pay" value="CARD"> <span id="t_card">Ø¨Ø·Ø§Ù‚Ø© / ØªØ­ÙˆÙŠÙ„</span></label>
        </div>

        <div class="rounded-3xl bg-white/85 border p-4 shadowSoft">
          <div class="flex items-center justify-between text-sm">
            <span id="t_subtotal">Ø§Ù„Ù…Ø¬Ù…ÙˆØ¹ Ø§Ù„ÙØ±Ø¹ÙŠ</span>
            <span class="font-black">â‚ª<span id="subtotal">0</span></span>
          </div>
          <div class="flex items-center justify-between text-sm mt-2">
            <span id="t_ship">Ø§Ù„ØªÙˆØµÙŠÙ„</span>
            <span class="font-black">â‚ª<span id="shipping">50</span></span>
          </div>
          <div class="h-px bg-gray-200 my-3"></div>
          <div class="flex items-center justify-between text-base">
            <span class="font-black" id="t_total">Ø§Ù„Ø¥Ø¬Ù…Ø§Ù„ÙŠ</span>
            <span class="font-black text-lg">â‚ª<span id="total">50</span></span>
          </div>
        </div>
      </div>

      <!-- Ø²Ø± ÙˆØ§Ø­Ø¯ ÙÙ‚Ø· -->
      <button id="sendBtn" class="mt-5 w-full py-4 rounded-2xl btnGold shadowLux font-black text-lg">
        <span id="t_send2">Ø¥Ø±Ø³Ø§Ù„ Ø§Ù„Ø·Ù„Ø¨ Ø¹Ø¨Ø± ÙˆØ§ØªØ³Ø§Ø¨</span>
      </button>
    </div>

  </div>

<script>
/* =========================
   CONFIG
========================= */
const RSS_PATH = "products.rss";
const DELIVERY_FEE = 50;
const DEFAULT_WA = "972524033442";

/* =========================
   STATE
========================= */
let LANG = (navigator.language || "").toLowerCase().includes("he") ? "he" : "ar";
let IDS = [];
let PRODUCTS = [];
let COUNTS = new Map();
let SELECTED_UNIQUE = [];
let WA = DEFAULT_WA;

/* =========================
   I18N
========================= */
function T(ar, he){ return (LANG==="he") ? he : ar; }

function setTexts(){
  document.documentElement.lang = LANG;
  document.documentElement.dir  = (LANG==="he") ? "ltr" : "rtl";

  document.getElementById("t_title").textContent = T("- Ø¨Ø§Ù‚Ø© Ù…Ø®ØªØ§Ø±Ø©","- ×××¨×– ××•×¦×¨×™×");
  document.getElementById("t_sub").textContent   = T("Ø§Ø®ØªØ± Ø§Ù„Ù…Ù†ØªØ¬Ø§Øª Ø§Ù„Ù…ÙØ¶Ù„Ø© ÙˆØ£Ø±Ø³Ù„ Ø§Ù„Ø·Ù„Ø¨ Ø¹Ø¨Ø± ÙˆØ§ØªØ³Ø§Ø¨","×‘×—×¨ ××•×¦×¨×™× ×•×©×œ×— ×”×–×× ×” ×‘×•×•××˜×¡××¤");

  document.getElementById("t_products").textContent = T("Products","××•×¦×¨×™×");
  document.getElementById("t_wa").textContent = "WhatsApp";

  document.getElementById("notePreview").textContent = T(
    "Ù…Ù„Ø§Ø­Ø¸Ø©: ÙˆØ§ØªØ³Ø§Ø¨ ÙŠØ¹Ø±Ø¶ Preview ÙˆØ§Ø­Ø¯ Ù„Ù„ØµÙØ­Ø© ÙÙ‚Ø· â€” Ø¯Ø§Ø®Ù„ Ø§Ù„ØµÙØ­Ø© Ø³ØªØ¸Ù‡Ø± ÙƒÙ„ Ø§Ù„ØµÙˆØ±.",
    "×”×¢×¨×”: ×•×•××˜×¡××¤ ××¦×™×’ Preview ××—×“ ×‘×œ×‘×“ â€” ×‘×ª×•×š ×”×“×£ ×ª×•×¤×¢× ×” ×›×œ ×”×ª××•× ×•×ª."
  );

  document.getElementById("t_selected_products").textContent = T("Ø§Ù„Ù…Ù†ØªØ¬Ø§Øª Ø§Ù„Ù…Ø®ØªØ§Ø±Ø©","××•×¦×¨×™× ×©× ×‘×—×¨×•");
  document.getElementById("t_hint").textContent = T("ÙŠÙ…ÙƒÙ†Ùƒ ØªØ¹Ø¯ÙŠÙ„ Ø§Ù„ÙƒÙ…ÙŠØ© Ø£Ùˆ Ø­Ø°Ù Ø§Ù„Ù…Ù†ØªØ¬","× ×™×ª×Ÿ ×œ×¢×“×›×Ÿ ×›××•×ª ××• ×œ××—×•×§ ××•×¦×¨");

  document.getElementById("t_empty").textContent = T("Ù„Ø§ ÙŠÙˆØ¬Ø¯ Ù…Ù†ØªØ¬Ø§Øª ÙÙŠ Ø§Ù„Ø¨Ø§Ù‚Ø©","××™×Ÿ ××•×¦×¨×™× ×‘×××¨×–");
  document.getElementById("t_empty2").textContent = T("Ø§Ø±Ø¬Ø¹ Ù„ØµÙØ­Ø© Ø§Ù„Ø§Ø®ØªÙŠØ§Ø± ÙˆØ£Ù†Ø´Ø¦ Ø¨Ø§Ù‚Ø© Ø¬Ø¯ÙŠØ¯Ø©.","×—×–×•×¨ ×œ×¢××•×“ ×”×‘×—×™×¨×” ×•×¦×•×¨ ×××¨×– ×—×“×©.");

  document.getElementById("t_form_title").textContent = T("ÙÙˆØ±Ù… Ø§Ù„Ø·Ù„Ø¨","×˜×•×¤×¡ ×”×–×× ×”");
  document.getElementById("t_form_note").textContent = T("Ø³ÙŠØªÙ… Ø¥Ø±Ø³Ø§Ù„ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ù„Ù„ÙˆØ§ØªØ³Ø§Ø¨","×”× ×ª×•× ×™× ×™×™×©×œ×—×• ×œ×•×•××˜×¡××¤");

  document.getElementById("t_name").textContent = T("Ø§Ù„Ø§Ø³Ù…","×©×");
  document.getElementById("custName").placeholder = T("Ø§Ù„Ø§Ø³Ù… Ø§Ù„ÙƒØ§Ù…Ù„","×©× ××œ×");
  document.getElementById("t_phone").textContent = T("Ø§Ù„ØªÙ„ÙÙˆÙ†","×˜×œ×¤×•×Ÿ");
  document.getElementById("custPhone").placeholder = T("Ø±Ù‚Ù… Ø§Ù„ØªÙ„ÙÙˆÙ†","××¡×¤×¨ ×˜×œ×¤×•×Ÿ");
  document.getElementById("t_address").textContent = T("Ø§Ù„Ø¹Ù†ÙˆØ§Ù†","×›×ª×•×‘×ª");
  document.getElementById("custAddress").placeholder = T("Ø§Ù„Ø¹Ù†ÙˆØ§Ù† Ø§Ù„ÙƒØ§Ù…Ù„","×›×ª×•×‘×ª ××œ××”");

  document.getElementById("t_pay").textContent = T("Ø·Ø±ÙŠÙ‚Ø© Ø§Ù„Ø¯ÙØ¹","×××¦×¢×™ ×ª×©×œ×•×");
  document.getElementById("t_cod").textContent = T("Ø§Ù„Ø¯ÙØ¹ Ø¹Ù†Ø¯ Ø§Ù„Ø§Ø³ØªÙ„Ø§Ù…","×ª×©×œ×•× ×‘×¢×ª ××¡×™×¨×”");
  document.getElementById("t_card").textContent = T("Ø¨Ø·Ø§Ù‚Ø© / ØªØ­ÙˆÙŠÙ„","×›×¨×˜×™×¡ / ×”×¢×‘×¨×”");

  document.getElementById("t_subtotal").textContent = T("Ø§Ù„Ù…Ø¬Ù…ÙˆØ¹ Ø§Ù„ÙØ±Ø¹ÙŠ","×¡×›×•× ×‘×™× ×™×™×");
  document.getElementById("t_ship").textContent = T("Ø§Ù„ØªÙˆØµÙŠÙ„","××©×œ×•×—");
  document.getElementById("t_total").textContent = T("Ø§Ù„Ø¥Ø¬Ù…Ø§Ù„ÙŠ","×¡×”×´×›");

  document.getElementById("t_send2").textContent = T("Ø¥Ø±Ø³Ø§Ù„ Ø§Ù„Ø·Ù„Ø¨ Ø¹Ø¨Ø± ÙˆØ§ØªØ³Ø§Ø¨","×©×œ×— ×”×–×× ×” ×‘×•×•××˜×¡××¤");
}

/* =========================
   URL / QUERY
========================= */
function qs(name){
  const u = new URL(location.href);
  return u.searchParams.get(name) || "";
}
function normalizeWa(v){ return (v||"").toString().replace(/\D/g,"").trim(); }

function rebuildIdsFromCounts(){
  const out = [];
  for(const [id, qty] of COUNTS.entries()){
    for(let i=0;i<qty;i++) out.push(id);
  }
  IDS = out;
}

function updateUrlFromCounts(){
  rebuildIdsFromCounts();
  const u = new URL(location.href);
  u.searchParams.set("ids", IDS.join(","));
  u.searchParams.set("lang", LANG);
  u.searchParams.set("wa", WA);
  history.replaceState({}, "", u.toString());
}

function readQuery(){
  const idsRaw = (qs("ids") || "").trim();
  IDS = idsRaw ? idsRaw.split(",").map(s=>s.trim()).filter(Boolean) : [];

  const langQ = (qs("lang") || "").toLowerCase();
  if(langQ === "ar" || langQ === "he") LANG = langQ;

  WA = normalizeWa(qs("wa")) || DEFAULT_WA;
  document.getElementById("waBox").textContent = WA;

  COUNTS = new Map();
  for(const id of IDS){
    COUNTS.set(id, (COUNTS.get(id)||0) + 1);
  }
}

/* =========================
   RSS PARSE
========================= */
function getTextByLocalName(parent, localName){
  const nodes = parent.getElementsByTagName("*");
  const target = localName.toLowerCase();
  for (let i=0;i<nodes.length;i++){
    const ln = (nodes[i].localName || "").toLowerCase();
    if (ln === target) return (nodes[i].textContent || "").trim();
  }
  return "";
}
function parsePrice(priceText){
  if(!priceText) return 0;
  const n = parseFloat(String(priceText).replace(/[^\d.]/g,""));
  return isNaN(n) ? 0 : n;
}

async function loadRSS(){
  try{
    const res = await fetch(RSS_PATH, { cache:"no-store" });
    if(!res.ok) throw new Error("HTTP " + res.status);
    const text = await res.text();
    const xml = new DOMParser().parseFromString(text, "application/xml");
    const err = xml.getElementsByTagName("parsererror");
    if(err && err.length) throw new Error("XML parse error");

    const items = Array.from(xml.getElementsByTagName("item"));
    PRODUCTS = items.map(item=>{
      const priceRaw = getTextByLocalName(item, "price") || getTextByLocalName(item, "sale_price") || "";
      return {
        id: getTextByLocalName(item,"id"),
        title: getTextByLocalName(item,"title"),
        image: getTextByLocalName(item,"image_link"),
        link: getTextByLocalName(item,"link"),
        price_raw: priceRaw,
        price: parsePrice(priceRaw)
      };
    }).filter(p=>p.id && p.title);

    rebuildSelectedUnique();
  }catch(e){
    console.error(e);
    alert("ÙØ´Ù„ ØªØ­Ù…ÙŠÙ„ products.rss\n" + e.message);
  }
}

function rebuildSelectedUnique(){
  const map = new Map(PRODUCTS.map(p=>[p.id,p]));
  SELECTED_UNIQUE = Array.from(COUNTS.keys()).map(id => map.get(id)).filter(Boolean);

  document.getElementById("countBox").textContent = String(totalQty());

  if(SELECTED_UNIQUE.length === 0){
    document.getElementById("productsGrid").innerHTML = "";
    document.getElementById("emptyState").classList.remove("hidden");
  }else{
    document.getElementById("emptyState").classList.add("hidden");
    renderProducts();
  }

  renderTotals();
  updateUrlFromCounts();
}

function totalQty(){
  let s = 0;
  for(const q of COUNTS.values()) s += q;
  return s;
}

/* =========================
   RENDER PRODUCTS
========================= */
function renderProducts(){
  const grid = document.getElementById("productsGrid");
  grid.innerHTML = "";

  SELECTED_UNIQUE.forEach(p=>{
    const qty = COUNTS.get(p.id) || 1;
    const lineTotal = ((p.price||0) * qty);

    const card = document.createElement("div");
    card.className = "card glassLight shadowLux rounded-3xl overflow-hidden fadeIn";

    card.innerHTML = `
      <div class="relative bg-white/40">
        <img src="${esc(p.image)}" class="w-full h-56 object-contain" alt="">
        <div class="absolute top-3 left-3 qtyBadge bg-white/90 goldBorder shadowSoft text-black">
          ${qty}
        </div>
      </div>

      <div class="p-4">
        <div class="flex items-start justify-between gap-3">
          <div>
            <div class="text-xs text-gray-500 font-semibold">${esc(p.id)}</div>
            <div class="font-black text-base leading-snug mt-1">${esc(p.title)}</div>
          </div>

          <button class="px-3 py-2 rounded-2xl bg-red-500 text-white text-sm font-black shadowSoft"
                  data-remove="${esc(p.id)}">
            ${esc(T("Ø­Ø°Ù","××—×§"))}
          </button>
        </div>

        <div class="mt-4 flex items-center justify-between gap-2">
          <div class="flex items-center gap-3 bg-black/5 rounded-2xl px-3 py-2">
            <button class="w-10 h-10 rounded-2xl bg-white shadowSoft font-black text-lg" data-dec="${esc(p.id)}">âˆ’</button>
            <div class="min-w-[28px] text-center font-black text-lg">${qty}</div>
            <button class="w-10 h-10 rounded-2xl bg-white shadowSoft font-black text-lg" data-inc="${esc(p.id)}">+</button>
          </div>

          <div class="text-right">
            <div class="text-lg font-black">â‚ª${lineTotal.toFixed(0)}</div>
            <div class="text-xs text-gray-500 mt-1">â‚ª${(p.price||0).toFixed(0)} Ã— ${qty}</div>
          </div>
        </div>
      </div>
    `;

    card.querySelector(`[data-remove="${CSS.escape(p.id)}"]`).onclick = ()=> removeAll(p.id);
    card.querySelector(`[data-inc="${CSS.escape(p.id)}"]`).onclick = ()=> changeQty(p.id, +1);
    card.querySelector(`[data-dec="${CSS.escape(p.id)}"]`).onclick = ()=> changeQty(p.id, -1);

    grid.appendChild(card);
  });
}

function changeQty(id, delta){
  const now = COUNTS.get(id) || 0;
  const next = now + delta;
  if(next <= 0) COUNTS.delete(id);
  else COUNTS.set(id, next);
  rebuildSelectedUnique();
}
function removeAll(id){
  COUNTS.delete(id);
  rebuildSelectedUnique();
}

/* =========================
   TOTALS
========================= */
function calcSubtotal(){
  const map = new Map(PRODUCTS.map(p=>[p.id,p]));
  let sum = 0;
  for(const [id, qty] of COUNTS.entries()){
    const p = map.get(id);
    if(!p) continue;
    sum += (p.price||0) * qty;
  }
  return sum;
}
function renderTotals(){
  const sub = calcSubtotal();
  const total = sub + DELIVERY_FEE;
  document.getElementById("subtotal").textContent = sub.toFixed(0);
  document.getElementById("shipping").textContent = DELIVERY_FEE.toFixed(0);
  document.getElementById("total").textContent = total.toFixed(0);
}

/* =========================
   ORDER SEND
========================= */
function getPay(){
  const el = document.querySelector('input[name="pay"]:checked');
  return el ? el.value : "COD";
}

function buildBundleUrl(){
  const base = location.origin + location.pathname.replace(/[^/]+$/, "") + "bundle.html";
  const idsParam = encodeURIComponent(IDS.join(","));
  return `${base}?ids=${idsParam}&lang=${encodeURIComponent(LANG)}&wa=${encodeURIComponent(WA)}`;
}

function buildOrderText(){
  const name = (document.getElementById("custName").value || "").trim();
  const phone = (document.getElementById("custPhone").value || "").trim();
  const addr = (document.getElementById("custAddress").value || "").trim();
  const pay = getPay();

  if(!name || !phone || !addr) return { ok:false, text:"" };
  if(totalQty() === 0) return { ok:false, text:"" };

  const payTxt = (pay==="COD")
    ? T("Ø§Ù„Ø¯ÙØ¹ Ø¹Ù†Ø¯ Ø§Ù„Ø§Ø³ØªÙ„Ø§Ù…","×ª×©×œ×•× ×‘×¢×ª ××¡×™×¨×”")
    : T("Ø¨Ø·Ø§Ù‚Ø©/ØªØ­ÙˆÙŠÙ„","×›×¨×˜×™×¡/×”×¢×‘×¨×”");

  const sub = calcSubtotal();
  const total = sub + DELIVERY_FEE;

  const map = new Map(PRODUCTS.map(p=>[p.id,p]));
  let msg = T("ğŸ›’ Ø·Ù„Ø¨ Ø¬Ø¯ÙŠØ¯\n","ğŸ›’ ×”×–×× ×” ×—×“×©×”\n");
  msg += "----------------------\n";
  msg += T(`ğŸ‘¤ Ø§Ù„Ø§Ø³Ù…: ${name}\n`,`ğŸ‘¤ ×©×: ${name}\n`);
  msg += T(`ğŸ“ Ø§Ù„ØªÙ„ÙÙˆÙ†: ${phone}\n`,`ğŸ“ ×˜×œ×¤×•×Ÿ: ${phone}\n`);
  msg += T(`ğŸ“ Ø§Ù„Ø¹Ù†ÙˆØ§Ù†: ${addr}\n`,`ğŸ“ ×›×ª×•×‘×ª: ${addr}\n`);
  msg += T(`ğŸ’³ Ø§Ù„Ø¯ÙØ¹: ${payTxt}\n`,`ğŸ’³ ×ª×©×œ×•×: ${payTxt}\n`);
  msg += "----------------------\n";
  msg += T("ğŸ§¾ Ø§Ù„Ù…Ù†ØªØ¬Ø§Øª:\n","ğŸ§¾ ××•×¦×¨×™×:\n");

  for(const [id, qty] of COUNTS.entries()){
    const p = map.get(id);
    if(!p) continue;
    msg += `â€¢ ${p.title} (x${qty}) â€” â‚ª${((p.price||0)*qty).toFixed(0)}\n`;
  }

  msg += "----------------------\n";
  msg += T(`Ø§Ù„Ù…Ø¬Ù…ÙˆØ¹ Ø§Ù„ÙØ±Ø¹ÙŠ: â‚ª${sub.toFixed(0)}\n`,`×¡×›×•× ×‘×™× ×™×™×: â‚ª${sub.toFixed(0)}\n`);
  msg += T(`Ø§Ù„ØªÙˆØµÙŠÙ„: â‚ª${DELIVERY_FEE}\n`,`××©×œ×•×—: â‚ª${DELIVERY_FEE}\n`);
  msg += T(`Ø§Ù„Ø¥Ø¬Ù…Ø§Ù„ÙŠ: â‚ª${total.toFixed(0)}\n`,`×¡×”×´×›: â‚ª${total.toFixed(0)}\n`);
  msg += "----------------------\n";
  msg += T("ğŸ“¦ Ø±Ø§Ø¨Ø· Ø§Ù„Ø¨Ø§Ù‚Ø©:\n","ğŸ“¦ ×§×™×©×•×¨ ×œ×××¨×–:\n");
  msg += buildBundleUrl();

  return { ok:true, text:msg };
}

function sendWhatsApp(){
  const data = buildOrderText();
  if(!data.ok){
    alert(T("Ø§Ù…Ù„Ø£ Ø§Ù„Ø§Ø³Ù… ÙˆØ§Ù„ØªÙ„ÙÙˆÙ† ÙˆØ§Ù„Ø¹Ù†ÙˆØ§Ù† ÙˆØªØ£ÙƒØ¯ Ù…Ù† ÙˆØ¬ÙˆØ¯ Ù…Ù†ØªØ¬Ø§Øª","××œ× ×©×/×˜×œ×¤×•×Ÿ/×›×ª×•×‘×ª ×•×•×“× ×©×™×© ××•×¦×¨×™×"));
    return;
  }
  window.open(`https://wa.me/${WA}?text=${encodeURIComponent(data.text)}`, "_blank");
}

/* =========================
   UTILS
========================= */
function esc(s){
  return (s||"").replace(/[&<>"']/g, m => ({ "&":"&amp;","<":"&lt;",">":"&gt;",'"':"&quot;","'":"&#039;" }[m]));
}

/* =========================
   INIT
========================= */
document.getElementById("langBtn").onclick = ()=>{
  LANG = (LANG==="ar") ? "he" : "ar";
  setTexts();
  rebuildSelectedUnique();
};

document.getElementById("sendBtn").onclick = sendWhatsApp;

function init(){
  readQuery();
  setTexts();
  loadRSS();
}
init();
</script>

</body>
</html>
