<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>MAD Bundle</title>

  <!-- OG Preview (Ø«Ø§Ø¨Øª Ù„Ù„ØµÙØ­Ø©) -->
  <meta property="og:title" content="MAD Parfumeur - Bundle" />
  <meta property="og:description" content="Selected products bundle" />
  <meta property="og:type" content="website" />
  <!-- Ø­Ø· ØµÙˆØ±Ø© Ø«Ø§Ø¨ØªØ© Ø¹Ù†Ø¯Ùƒ (Ø¨Ù†Ø± Ø±Ø¬Ø§Ù„/Ù†Ø³Ø§Ø¡/Ø¹Ø±ÙˆØ¶) -->
  <meta property="og:image" content="https://www.mad-parfumeur.com/assets/hero/1.webp" />
  <meta property="og:image:width" content="1200" />
  <meta property="og:image:height" content="630" />

  <script src="https://cdn.tailwindcss.com"></script>
  <style>
    body { font-family: Arial, sans-serif; background:#f6f7f9; }
  </style>
</head>

<body class="p-4">
  <div class="max-w-6xl mx-auto">

    <div class="bg-white rounded-2xl shadow p-4 mb-4">
      <div class="flex items-center justify-between gap-2">
        <div>
          <h1 id="title" class="text-2xl font-bold">MAD Bundle</h1>
          <p id="sub" class="text-sm text-gray-600">Browse selected products</p>
        </div>
        <button id="langBtn" class="bg-black text-white px-4 py-2 rounded-lg" onclick="toggleLang()">Ø¹Ø±Ø¨ÙŠ / ×¢×‘×¨×™×ª</button>
      </div>

      <div class="mt-3 grid grid-cols-1 md:grid-cols-3 gap-2">
        <div class="bg-gray-50 border rounded-xl p-3">
          <div class="text-xs text-gray-500">Products</div>
          <div id="count" class="text-lg font-bold">0</div>
        </div>
        <div class="bg-gray-50 border rounded-xl p-3">
          <div class="text-xs text-gray-500">Status</div>
          <div id="status" class="text-sm text-gray-700">Loading...</div>
        </div>
        <div class="bg-gray-50 border rounded-xl p-3">
          <div class="text-xs text-gray-500">WhatsApp</div>
          <div id="waView" class="text-sm font-semibold">â€”</div>
        </div>
      </div>

      <div class="mt-4 flex flex-col md:flex-row gap-2">
        <button class="bg-green-600 text-white px-5 py-3 rounded-xl" onclick="orderWhatsApp()">
          <span id="btnOrder">Ø§Ø·Ù„Ø¨ Ø¹Ø¨Ø± ÙˆØ§ØªØ³Ø§Ø¨</span>
        </button>
        <button class="bg-gray-900 text-white px-5 py-3 rounded-xl" onclick="copyOrderText()">
          <span id="btnCopy">Ù†Ø³Ø® Ù†Øµ Ø§Ù„Ø·Ù„Ø¨</span>
        </button>
      </div>
    </div>

    <div id="grid" class="grid grid-cols-2 md:grid-cols-4 lg:grid-cols-5 gap-4"></div>

  </div>

<script>
  let LANG = "ar";
  let WA = "";
  let IDS = [];
  let PRODUCTS = [];
  let BUNDLE = [];

  function qs(name){
    const u = new URL(location.href);
    return u.searchParams.get(name) || "";
  }

  function getTextByLocalName(parent, localName){
    const nodes = parent.getElementsByTagName("*");
    const target = localName.toLowerCase();
    for (let i = 0; i < nodes.length; i++){
      const ln = (nodes[i].localName || "").toLowerCase();
      if (ln === target) return (nodes[i].textContent || "").trim();
    }
    return "";
  }

  function setUiTexts(){
    if(LANG === "ar"){
      document.documentElement.lang = "ar";
      document.documentElement.dir = "rtl";
      document.getElementById("title").textContent = "MAD - Ø¨Ø§Ù‚Ø© Ù…Ø®ØªØ§Ø±Ø©";
      document.getElementById("sub").textContent = "Ø§Ø®ØªØ± Ø§Ù„Ù…Ù†ØªØ¬ Ø§Ù„Ù…Ù†Ø§Ø³Ø¨ ÙˆØªÙˆØ§ØµÙ„ Ø¹Ø¨Ø± ÙˆØ§ØªØ³Ø§Ø¨";
      document.getElementById("btnOrder").textContent = "Ø§Ø·Ù„Ø¨ Ø¹Ø¨Ø± ÙˆØ§ØªØ³Ø§Ø¨";
      document.getElementById("btnCopy").textContent = "Ù†Ø³Ø® Ù†Øµ Ø§Ù„Ø·Ù„Ø¨";
      document.getElementById("langBtn").textContent = "Ø¹Ø±Ø¨ÙŠ / ×¢×‘×¨×™×ª";
    } else {
      document.documentElement.lang = "he";
      document.documentElement.dir = "ltr";
      document.getElementById("title").textContent = "MAD - ×××¨×– ××•×¦×¨×™×";
      document.getElementById("sub").textContent = "×¦×¤×” ×‘××•×¦×¨×™× ×”× ×‘×—×¨×™× ×•×¦×•×¨ ×§×©×¨ ×‘×•×•××˜×¡××¤";
      document.getElementById("btnOrder").textContent = "×”×–×× ×” ×‘×•×•××˜×¡××¤";
      document.getElementById("btnCopy").textContent = "×”×¢×ª×§ ×˜×§×¡×˜ ×”×–×× ×”";
      document.getElementById("langBtn").textContent = "Ø¹Ø±Ø¨ÙŠ / ×¢×‘×¨×™×ª";
    }
  }

  function toggleLang(){
    LANG = (LANG === "ar") ? "he" : "ar";
    setUiTexts();
    renderGrid();
  }

  function buildOrderText(){
    if(!BUNDLE.length) return (LANG==="ar" ? "Ù„Ø§ ÙŠÙˆØ¬Ø¯ Ù…Ù†ØªØ¬Ø§Øª" : "××™×Ÿ ××•×¦×¨×™×");

    let msg = (LANG==="ar")
      ? "Ù…Ø±Ø­Ø¨Ø§ ğŸ‘‹\nÙ‡Ø°Ù‡ Ø§Ù„Ù…Ù†ØªØ¬Ø§Øª Ø§Ù„Ù„ÙŠ Ø§Ø®ØªØ±ØªÙ‡Ø§:\n\n"
      : "×”×™×™ ğŸ‘‹\n××œ×• ×”××•×¦×¨×™× ×©×‘×—×¨×ª×™:\n\n";

    BUNDLE.forEach(p => {
      msg += `â€¢ ${p.title}\n${p.link}\n\n`;
    });

    msg += (LANG==="ar")
      ? "âœ… Ø§ÙƒØªØ¨Ù„ÙŠ Ø§Ù„ÙƒÙ…ÙŠØ© ÙˆØ§Ù„Ø¹Ù†ÙˆØ§Ù†"
      : "âœ… ×›×ª×•×‘ ×œ×™ ×›××•×ª ×•×›×ª×•×‘×ª";

    return msg;
  }

  function orderWhatsApp(){
    if(!WA) return alert("WhatsApp number missing in URL (wa=...)");
    const text = buildOrderText();
    const url = `https://wa.me/${WA}?text=${encodeURIComponent(text)}`;
    window.open(url, "_blank");
  }

  function copyOrderText(){
    const text = buildOrderText();
    navigator.clipboard.writeText(text).then(()=>{
      alert(LANG==="ar" ? "ØªÙ… Ø§Ù„Ù†Ø³Ø® âœ…" : "×”×•×¢×ª×§ âœ…");
    }).catch(()=>{
      alert(LANG==="ar" ? "Ø§Ù„Ù†Ø³Ø® Ù…Ø±ÙÙˆØ¶ Ù…Ù† Ø§Ù„Ù…ØªØµÙØ­" : "×”×¢×ª×§×” × ×—×¡××” ×‘×“×¤×“×¤×Ÿ");
    });
  }

  function renderGrid(){
    const grid = document.getElementById("grid");
    grid.innerHTML = "";

    BUNDLE.forEach(p => {
      const card = document.createElement("div");
      card.className = "bg-white rounded-2xl shadow p-2 border";
      card.innerHTML = `
        <img src="${escapeHtml(p.image)}" class="w-full h-36 object-contain bg-gray-50 rounded-xl" />
        <div class="mt-2 text-sm font-semibold text-center">${escapeHtml(p.title)}</div>
        <div class="mt-1 flex gap-2">
          <a class="w-full text-center bg-black text-white py-2 rounded-xl text-sm"
             href="${escapeHtml(p.link)}" target="_blank">${LANG==="ar" ? "Ø±Ø§Ø¨Ø· Ø§Ù„Ù…Ù†ØªØ¬" : "×§×™×©×•×¨ ×œ××•×¦×¨"}</a>
        </div>
      `;
      grid.appendChild(card);
    });

    document.getElementById("count").textContent = BUNDLE.length.toString();
  }

  function escapeHtml(s){
    return (s||"").replace(/[&<>"']/g, m => ({ "&":"&amp;","<":"&lt;",">":"&gt;",'"':"&quot;","'":"&#039;" }[m]));
  }

  async function loadRSS(){
    const status = document.getElementById("status");
    status.textContent = "Loading RSS...";
    try{
      const rssUrl = location.origin + location.pathname.replace(/[^/]+$/, "") + "products.rss";
      const res = await fetch(rssUrl, { cache: "no-store" });
      if(!res.ok) throw new Error("HTTP " + res.status);
      const text = await res.text();

      const parser = new DOMParser();
      const xml = parser.parseFromString(text, "application/xml");
      const parseError = xml.getElementsByTagName("parsererror");
      if(parseError && parseError.length) throw new Error("XML parse error");

      const items = Array.from(xml.getElementsByTagName("item"));
      PRODUCTS = items.map(item => ({
        id: getTextByLocalName(item, "id"),
        title: getTextByLocalName(item, "title"),
        image: getTextByLocalName(item, "image_link"),
        link: getTextByLocalName(item, "link"),
      })).filter(p => p.id && p.title);

      const map = new Map(PRODUCTS.map(p => [p.id, p]));
      BUNDLE = IDS.map(id => map.get(id)).filter(Boolean);

      status.textContent = `OK âœ… Loaded bundle: ${BUNDLE.length}`;
      renderGrid();
    }catch(e){
      console.error(e);
      document.getElementById("status").textContent = "Failed âŒ";
      alert("ÙØ´Ù„ ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ù…Ù†ØªØ¬Ø§Øª. ØªØ£ÙƒØ¯ Ø£Ù† products.rss Ù…ÙˆØ¬ÙˆØ¯ ÙÙŠ Ù†ÙØ³ Ø§Ù„Ù…Ø¬Ù„Ø¯.\n" + e.message);
    }
  }

  // Init
  (function init(){
    LANG = qs("lang") || "ar";
    WA = (qs("wa") || "").replace(/\D/g,"");
    const idsStr = qs("ids") || "";
    IDS = idsStr ? decodeURIComponent(idsStr).split(",").map(s=>s.trim()).filter(Boolean) : [];

    setUiTexts();
    document.getElementById("waView").textContent = WA ? WA : "â€”";

    if(!IDS.length){
      document.getElementById("status").textContent = "No ids in URL";
      alert("Ù„Ø§ ÙŠÙˆØ¬Ø¯ Ù…Ù†ØªØ¬Ø§Øª ÙÙŠ Ø§Ù„Ø±Ø§Ø¨Ø·. Ø§Ø±Ø¬Ø¹ Ù„ØµÙØ­Ø© Ø§Ù„Ø§Ø®ØªÙŠØ§Ø± ÙˆØ§Ø¹Ù…Ù„ Create Bundle.");
      return;
    }

    loadRSS();
  })();
</script>
</body>
</html>
