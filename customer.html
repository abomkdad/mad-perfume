<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>MAD Parfumeur | Order Catalog</title>

  <meta property="og:title" content="MAD Parfumeur - Catalog" />
  <meta property="og:description" content="Choose products, fill the form, and order via WhatsApp" />
  <meta property="og:type" content="website" />
  <meta property="og:image" content="https://www.mad-parfumeur.com/assets/hero/logo2.webp" />
  <meta property="og:image:width" content="1200" />
  <meta property="og:image:height" content="630" />

  <script src="https://cdn.tailwindcss.com"></script>
  <style>
    body { font-family: Arial, sans-serif; background:#f6f7f9; }
    .glass { backdrop-filter: blur(10px); background: rgba(255,255,255,.75); }
    .shadow-soft { box-shadow: 0 10px 30px rgba(0,0,0,.08); }
    .card { transition: .15s transform; }
    .card:hover { transform: scale(1.02); }
    .chip { white-space: nowrap; }
  </style>
</head>

<body class="min-h-screen">

  <!-- Top Bar -->
  <div class="sticky top-0 z-30 border-b bg-white/80 glass">
    <div class="max-w-7xl mx-auto px-4 py-3 flex items-center justify-between gap-3">
      <div class="flex items-center gap-3">
        <img src="https://www.mad-parfumeur.com/assets/hero/logo.png" alt="MAD" class="h-10 w-10 rounded-xl object-contain bg-white border">
        <div>
          <div class="font-black text-lg leading-5">MAD Parfumeur</div>
          <div id="t_sub" class="text-xs text-gray-600">Ø§Ø®ØªØ± Ø¹Ø·ÙˆØ±Ùƒ ÙˆØ§Ø·Ù„Ø¨ ÙÙˆØ±Ù‹Ø§ Ø¹Ø¨Ø± ÙˆØ§ØªØ³Ø§Ø¨</div>
        </div>
      </div>

      <div class="flex items-center gap-2">
        <button id="langBtn" class="px-4 py-2 rounded-xl bg-black text-white text-sm shadow-soft">Ø¹Ø±Ø¨ÙŠ / ×¢×‘×¨×™×ª</button>

        <button id="cartBtn" class="relative px-4 py-2 rounded-xl bg-green-600 text-white text-sm shadow-soft">
          <span id="t_cart">Ø§Ù„Ø³Ù„Ø©</span>
          <span id="cartCountBadge" class="absolute -top-2 -right-2 bg-black text-white text-xs px-2 py-1 rounded-full">0</span>
        </button>
      </div>
    </div>
  </div>

  <!-- Hero -->
  <div class="max-w-7xl mx-auto px-4 pt-6">
    <div class="rounded-3xl overflow-hidden bg-black text-white shadow-soft">
      <div class="p-6 md:p-10 flex flex-col md:flex-row md:items-center md:justify-between gap-6">
        <div>
          <div id="t_hero_title" class="text-2xl md:text-3xl font-black">Ø§Ø®ØªÙØ± Ù…Ù†ØªØ¬Ø§ØªÙƒ Ø§Ù„Ù…ÙØ¶Ù„Ø©</div>
          <div id="t_hero_desc" class="mt-2 text-white/80 text-sm md:text-base">
            Ø£Ø¶Ù Ù„Ù„Ø³Ù„Ø©ØŒ Ø§Ù…Ù„Ø£ Ø§Ù„Ù…Ø¹Ù„ÙˆÙ…Ø§ØªØŒ Ø«Ù… Ø£Ø±Ø³Ù„ Ø§Ù„Ø·Ù„Ø¨ Ù…Ø¨Ø§Ø´Ø±Ø© Ù„Ø®Ø¯Ù…Ø© Ø§Ù„Ø¹Ù…Ù„Ø§Ø¡.
          </div>

          <div class="mt-4 flex flex-wrap gap-2">
            <div class="px-3 py-1 rounded-full bg-white/10 text-xs border border-white/10" id="pill1">Ø³Ù„Ø© ÙØ®Ù…Ø©</div>
            <div class="px-3 py-1 rounded-full bg-white/10 text-xs border border-white/10" id="pill2">ÙÙˆØ±Ù… Ø·Ù„Ø¨</div>
            <div class="px-3 py-1 rounded-full bg-white/10 text-xs border border-white/10" id="pill3">Ø¥Ø±Ø³Ø§Ù„ ÙˆØ§ØªØ³Ø§Ø¨</div>
          </div>
        </div>

        <div class="bg-white/10 rounded-2xl p-4 md:p-5 border border-white/10 w-full md:w-[360px]">
          <div class="text-xs text-white/70" id="t_search_label">Ø¨Ø­Ø« Ø³Ø±ÙŠØ¹</div>
          <input id="search" class="mt-2 w-full px-4 py-3 rounded-xl bg-white text-black outline-none" placeholder="Ø§Ø¨Ø­Ø« Ø¨Ø§Ù„Ø§Ø³Ù… / Ø§Ù„ÙƒÙˆØ¯..." />
          <div class="mt-3 text-xs text-white/70">
            <span id="t_status">Status:</span> <span id="status">Auto loading...</span>
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- Categories -->
  <div class="max-w-7xl mx-auto px-4 mt-6">
    <div class="flex items-center justify-between">
      <div class="font-bold" id="t_categories">Ø§Ù„ØªØµÙ†ÙŠÙØ§Øª</div>
      <div class="text-sm text-gray-600">
        <span id="t_products">Products:</span> <span id="countAll">0</span>
      </div>
    </div>
    <div id="categories" class="mt-3 flex flex-wrap gap-2"></div>
  </div>

  <!-- Products Grid -->
  <div class="max-w-7xl mx-auto px-4 mt-4 pb-24">
    <div id="products" class="grid grid-cols-2 md:grid-cols-4 lg:grid-cols-5 gap-4"></div>
  </div>

  <!-- Cart Drawer -->
  <div id="cartOverlay" class="fixed inset-0 bg-black/40 hidden z-40"></div>
  <div id="cartDrawer" class="fixed top-0 right-0 h-full w-full max-w-md bg-white z-50 translate-x-full transition-transform duration-200 shadow-soft">
    <div class="p-4 border-b flex items-center justify-between">
      <div>
        <div class="font-black text-lg" id="t_cart_title">Ø¹Ø±Ø¨Ø© Ø§Ù„ØªØ³ÙˆÙ‚</div>
        <div class="text-xs text-gray-600" id="t_cart_sub">Ø§Ù…Ù„Ø£ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ø«Ù… Ø£Ø±Ø³Ù„ Ø§Ù„Ø·Ù„Ø¨</div>
      </div>
      <button id="closeCart" class="px-3 py-2 rounded-xl bg-gray-100">âœ•</button>
    </div>

    <div class="p-4 space-y-4 overflow-y-auto" style="height: calc(100% - 180px);">
      <div class="flex gap-2">
        <button id="clearCart" class="w-full px-4 py-3 rounded-xl bg-gray-100 font-semibold" id="t_clear">Ù…Ø³Ø­ Ø§Ù„Ø³Ù„Ø©</button>
        <button id="openBundle" class="w-full px-4 py-3 rounded-xl bg-black text-white font-semibold">
          <span id="t_bundle">Ø¹Ø±Ø¶ Ø§Ù„Ø¨Ø§Ù†Ø¯Ù„</span>
        </button>
      </div>

      <div class="text-sm text-gray-600">
        <span id="t_selected">Selected:</span> <span id="countSel">0</span>
      </div>

      <!-- Cart Items -->
      <div id="cartItems" class="space-y-3"></div>

      <!-- Form -->
      <div class="rounded-2xl border p-3 bg-gray-50">
        <div class="font-black mb-2" id="t_form">Ù…Ø¹Ù„ÙˆÙ…Ø§Øª Ø§Ù„Ø·Ù„Ø¨</div>

        <div class="space-y-2">
          <input id="custName" class="w-full border rounded-xl p-3" placeholder="Ø§Ù„Ø§Ø³Ù… Ø§Ù„ÙƒØ§Ù…Ù„" />
          <input id="custPhone" class="w-full border rounded-xl p-3" placeholder="Ø±Ù‚Ù… Ø§Ù„ØªÙ„ÙÙˆÙ†" inputmode="tel" />
          <textarea id="custAddress" class="w-full border rounded-xl p-3" rows="3" placeholder="Ø§Ù„Ø¹Ù†ÙˆØ§Ù† Ø§Ù„ÙƒØ§Ù…Ù„"></textarea>

          <div class="border rounded-xl p-3 bg-white">
            <div class="text-sm font-bold mb-2" id="t_pay">Ø·Ø±ÙŠÙ‚Ø© Ø§Ù„Ø¯ÙØ¹</div>
            <label class="flex items-center gap-2 text-sm"><input type="radio" name="pay" value="COD" checked /> <span id="t_cod">Ø§Ù„Ø¯ÙØ¹ Ø¹Ù†Ø¯ Ø§Ù„Ø§Ø³ØªÙ„Ø§Ù…</span></label>
            <label class="flex items-center gap-2 text-sm mt-2"><input type="radio" name="pay" value="CARD" /> <span id="t_card">Ø¨Ø·Ø§Ù‚Ø© / ØªØ­ÙˆÙŠÙ„</span></label>
          </div>
        </div>
      </div>

      <!-- Totals -->
      <div class="rounded-2xl border p-3 bg-white">
        <div class="flex items-center justify-between text-sm">
          <span id="t_subtotal">Ø§Ù„Ù…Ø¬Ù…ÙˆØ¹ Ø§Ù„ÙØ±Ø¹ÙŠ</span>
          <span class="font-black">â‚ª<span id="subtotal">0</span></span>
        </div>
        <div class="flex items-center justify-between text-sm mt-2">
          <span id="t_ship">Ø§Ù„ØªÙˆØµÙŠÙ„</span>
          <span class="font-black">â‚ª<span id="shipping">50</span></span>
        </div>
        <div class="h-px bg-gray-200 my-3"></div>
        <div class="flex items-center justify-between text-base">
          <span class="font-black" id="t_total">Ø§Ù„Ø¥Ø¬Ù…Ø§Ù„ÙŠ</span>
          <span class="font-black text-lg">â‚ª<span id="total">50</span></span>
        </div>
      </div>

    </div>

    <div class="absolute bottom-0 left-0 right-0 p-4 border-t bg-white">
      <button id="sendOrder" class="w-full px-4 py-4 rounded-2xl bg-green-600 text-white font-black shadow-soft">
        <span id="t_send">Ø¥Ø±Ø³Ø§Ù„ Ø§Ù„Ø·Ù„Ø¨ Ø¹Ø¨Ø± ÙˆØ§ØªØ³Ø§Ø¨</span>
      </button>
      <div class="mt-2 text-xs text-gray-500" id="t_note">
        Ø³ÙŠØªÙ… Ø§Ù„Ø¥Ø±Ø³Ø§Ù„ Ø¥Ù„Ù‰ Ø±Ù‚Ù… Ø®Ø¯Ù…Ø© Ø§Ù„Ø¹Ù…Ù„Ø§Ø¡ Ù…Ø¨Ø§Ø´Ø±Ø©.
      </div>
    </div>
  </div>

<script>
/* ========= CONFIG ========= */
const CS_WHATSAPP = "972524033442";
const DELIVERY_FEE = 50;

// Ø§Ù„ÙƒØ§ØªÙŠØ¬ÙˆØ±ÙŠØ§Øª Ø§Ù„Ù…Ø³Ù…ÙˆØ­Ø© Ù„Ù„Ø¹Ù…ÙŠÙ„
const CUSTOMER_CATEGORIES = [
  { key: "men",   match: "×’×‘×¨×™×",  ar: "Ø¹Ø·ÙˆØ± Ø§Ù„Ø±Ø¬Ø§Ù„", he: "×‘×©××™ ×’×‘×¨×™×" },
  { key: "women", match: "× ×©×™×",   ar: "Ø¹Ø·ÙˆØ± Ø§Ù„Ù†Ø³Ø§Ø¡", he: "×‘×©××™ × ×©×™×" },
  { key: "offers",match: "××‘×¦×¢×™×", ar: "Ø¹Ø±ÙˆØ¶",        he: "××‘×¦×¢×™×" },
  { key: "niche", match: "× ×™×©×”",   ar: "Ù†ÙŠØ´",         he: "× ×™×©×”" },
];

/* ========= STATE ========= */
let LANG = (navigator.language || "").toLowerCase().includes("he") ? "he" : "ar";
let PRODUCTS = [];
let FILTERED = [];
let CURRENT_CAT_KEY = CUSTOMER_CATEGORIES[0].key;
let CART = new Map(); // id -> qty

/* ========= UI TEXT ========= */
function T(ar, he){ return (LANG==="he") ? he : ar; }
function setTexts(){
  document.documentElement.lang = LANG;
  document.documentElement.dir = (LANG==="he") ? "ltr" : "rtl";

  document.getElementById("t_sub").textContent = T("Ø§Ø®ØªØ± Ø¹Ø·ÙˆØ±Ùƒ ÙˆØ§Ø·Ù„Ø¨ ÙÙˆØ±Ù‹Ø§ Ø¹Ø¨Ø± ÙˆØ§ØªØ³Ø§Ø¨","×‘×—×¨ ××•×¦×¨×™× ×•×”×–××Ÿ ×‘×•×•××˜×¡××¤");
  document.getElementById("t_cart").textContent = T("Ø§Ù„Ø³Ù„Ø©","×¢×’×œ×”");
  document.getElementById("t_hero_title").textContent = T("Ø§Ø®ØªÙØ± Ù…Ù†ØªØ¬Ø§ØªÙƒ Ø§Ù„Ù…ÙØ¶Ù„Ø©","×‘×—×¨ ××ª ×”××•×¦×¨×™× ×”××”×•×‘×™× ×¢×œ×™×š");
  document.getElementById("t_hero_desc").textContent = T("Ø£Ø¶Ù Ù„Ù„Ø³Ù„Ø©ØŒ Ø§Ù…Ù„Ø£ Ø§Ù„Ù…Ø¹Ù„ÙˆÙ…Ø§ØªØŒ Ø«Ù… Ø£Ø±Ø³Ù„ Ø§Ù„Ø·Ù„Ø¨ Ù…Ø¨Ø§Ø´Ø±Ø© Ù„Ø®Ø¯Ù…Ø© Ø§Ù„Ø¹Ù…Ù„Ø§Ø¡.","×”×•×¡×£ ×œ×¢×’×œ×”, ××œ× ×¤×¨×˜×™× ×•×©×œ×— ×”×–×× ×” ×œ×©×™×¨×•×ª ×œ×§×•×—×•×ª.");
  document.getElementById("pill1").textContent = T("Ø³Ù„Ø© ÙØ®Ù…Ø©","×¢×’×œ×” ×™×•×§×¨×ª×™×ª");
  document.getElementById("pill2").textContent = T("ÙÙˆØ±Ù… Ø·Ù„Ø¨","×˜×•×¤×¡ ×”×–×× ×”");
  document.getElementById("pill3").textContent = T("Ø¥Ø±Ø³Ø§Ù„ ÙˆØ§ØªØ³Ø§Ø¨","×©×œ×™×—×” ×‘×•×•××˜×¡××¤");
  document.getElementById("t_search_label").textContent = T("Ø¨Ø­Ø« Ø³Ø±ÙŠØ¹","×—×™×¤×•×© ××”×™×¨");
  document.getElementById("search").placeholder = T("Ø§Ø¨Ø­Ø« Ø¨Ø§Ù„Ø§Ø³Ù… / Ø§Ù„ÙƒÙˆØ¯...","×—×¤×© ×œ×¤×™ ×©× / ×§×•×“...");
  document.getElementById("t_status").textContent = T("Status:","Status:");
  document.getElementById("t_categories").textContent = T("Ø§Ù„ØªØµÙ†ÙŠÙØ§Øª","×§×˜×’×•×¨×™×•×ª");
  document.getElementById("t_products").textContent = T("Products:","××•×¦×¨×™×:");
  document.getElementById("t_cart_title").textContent = T("Ø¹Ø±Ø¨Ø© Ø§Ù„ØªØ³ÙˆÙ‚","×¢×’×œ×ª ×§× ×™×•×ª");
  document.getElementById("t_cart_sub").textContent = T("Ø§Ù…Ù„Ø£ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ø«Ù… Ø£Ø±Ø³Ù„ Ø§Ù„Ø·Ù„Ø¨","××œ× ×¤×¨×˜×™× ×•××– ×©×œ×— ×”×–×× ×”");
  document.getElementById("clearCart").textContent = T("Ù…Ø³Ø­ Ø§Ù„Ø³Ù„Ø©","× ×§×” ×¢×’×œ×”");
  document.getElementById("t_bundle").textContent = T("Ø¹Ø±Ø¶ Ø§Ù„Ø¨Ø§Ù†Ø¯Ù„","×¦×¤×” ×‘×‘×× ×“×œ");
  document.getElementById("t_selected").textContent = T("Selected:","× ×‘×—×¨×•:");
  document.getElementById("t_form").textContent = T("Ù…Ø¹Ù„ÙˆÙ…Ø§Øª Ø§Ù„Ø·Ù„Ø¨","×¤×¨×˜×™ ×”×–×× ×”");
  document.getElementById("custName").placeholder = T("Ø§Ù„Ø§Ø³Ù… Ø§Ù„ÙƒØ§Ù…Ù„","×©× ××œ×");
  document.getElementById("custPhone").placeholder = T("Ø±Ù‚Ù… Ø§Ù„ØªÙ„ÙÙˆÙ†","××¡×¤×¨ ×˜×œ×¤×•×Ÿ");
  document.getElementById("custAddress").placeholder = T("Ø§Ù„Ø¹Ù†ÙˆØ§Ù† Ø§Ù„ÙƒØ§Ù…Ù„","×›×ª×•×‘×ª ××œ××”");
  document.getElementById("t_pay").textContent = T("Ø·Ø±ÙŠÙ‚Ø© Ø§Ù„Ø¯ÙØ¹","×××¦×¢×™ ×ª×©×œ×•×");
  document.getElementById("t_cod").textContent = T("Ø§Ù„Ø¯ÙØ¹ Ø¹Ù†Ø¯ Ø§Ù„Ø§Ø³ØªÙ„Ø§Ù…","×ª×©×œ×•× ×‘×¢×ª ××¡×™×¨×”");
  document.getElementById("t_card").textContent = T("Ø¨Ø·Ø§Ù‚Ø© / ØªØ­ÙˆÙŠÙ„","×›×¨×˜×™×¡ / ×”×¢×‘×¨×”");
  document.getElementById("t_subtotal").textContent = T("Ø§Ù„Ù…Ø¬Ù…ÙˆØ¹ Ø§Ù„ÙØ±Ø¹ÙŠ","×¡×›×•× ×‘×™× ×™×™×");
  document.getElementById("t_ship").textContent = T("Ø§Ù„ØªÙˆØµÙŠÙ„","××©×œ×•×—");
  document.getElementById("t_total").textContent = T("Ø§Ù„Ø¥Ø¬Ù…Ø§Ù„ÙŠ","×¡×”×´×›");
  document.getElementById("t_send").textContent = T("Ø¥Ø±Ø³Ø§Ù„ Ø§Ù„Ø·Ù„Ø¨ Ø¹Ø¨Ø± ÙˆØ§ØªØ³Ø§Ø¨","×©×œ×— ×”×–×× ×” ×‘×•×•××˜×¡××¤");
  document.getElementById("t_note").textContent = T("Ø³ÙŠØªÙ… Ø§Ù„Ø¥Ø±Ø³Ø§Ù„ Ø¥Ù„Ù‰ Ø±Ù‚Ù… Ø®Ø¯Ù…Ø© Ø§Ù„Ø¹Ù…Ù„Ø§Ø¡ Ù…Ø¨Ø§Ø´Ø±Ø©.","×”×”×•×“×¢×” ×ª×™×©×œ×— ×œ×©×™×¨×•×ª ×œ×§×•×—×•×ª.");
}

document.getElementById("langBtn").onclick = ()=>{
  LANG = (LANG==="ar") ? "he" : "ar";
  setTexts();
  renderCategories();
  applyFilters();
  renderCart();
};

/* ========= RSS PARSE ========= */
function getTextByLocalName(parent, localName){
  const nodes = parent.getElementsByTagName("*");
  const target = localName.toLowerCase();
  for(let i=0;i<nodes.length;i++){
    const ln = (nodes[i].localName || "").toLowerCase();
    if(ln===target) return (nodes[i].textContent||"").trim();
  }
  return "";
}

function parsePrice(priceText){
  // examples: "129.00 ILS" or "129 ILS" or "129"
  if(!priceText) return 0;
  const n = parseFloat(String(priceText).replace(/[^\d.]/g,""));
  return isNaN(n) ? 0 : n;
}

async function loadRSS(){
  const status = document.getElementById("status");
  status.textContent = "Loading...";
  try{
    const res = await fetch("products.rss", { cache:"no-store" });
    if(!res.ok) throw new Error("HTTP "+res.status);
    const text = await res.text();
    const xml = new DOMParser().parseFromString(text, "application/xml");
    const err = xml.getElementsByTagName("parsererror");
    if(err && err.length) throw new Error("XML parse error");

    const items = Array.from(xml.getElementsByTagName("item"));
    PRODUCTS = items.map(item=>{
      const priceRaw = getTextByLocalName(item, "price") || getTextByLocalName(item, "sale_price") || "";
      // Ø¨Ø¹Ø¶ RSS ÙŠØ³ØªØ®Ø¯Ù… g:price / g:sale_price ÙƒÙ€ localName "price" / "sale_price"
      return {
        id: getTextByLocalName(item,"id"),
        title: getTextByLocalName(item,"title"),
        image: getTextByLocalName(item,"image_link"),
        link: getTextByLocalName(item,"link"),
        product_type: getTextByLocalName(item,"product_type") || "",
        price_raw: priceRaw,
        price: parsePrice(priceRaw)
      };
    }).filter(p=>p.id && p.title);

    document.getElementById("countAll").textContent = PRODUCTS.length.toString();
    status.textContent = "OK âœ…";

    renderCategories();
    applyFilters();
  }catch(e){
    console.error(e);
    status.textContent = "Failed âŒ";
    alert("ÙØ´Ù„ ØªØ­Ù…ÙŠÙ„ products.rss\n"+e.message);
  }
}

/* ========= CATEGORIES ========= */
function catLabel(cat){ return (LANG==="he") ? cat.he : cat.ar; }
function renderCategories(){
  const wrap = document.getElementById("categories");
  wrap.innerHTML="";
  CUSTOMER_CATEGORIES.forEach(cat=>{
    const active = (cat.key===CURRENT_CAT_KEY);
    const b = document.createElement("button");
    b.className = "chip px-4 py-2 rounded-full border " + (active ? "bg-black text-white" : "bg-white");
    b.textContent = catLabel(cat);
    b.onclick = ()=>{ CURRENT_CAT_KEY = cat.key; applyFilters(); renderCategories(); };
    wrap.appendChild(b);
  });
}

/* ========= FILTER + RENDER PRODUCTS ========= */
document.getElementById("search").addEventListener("input", applyFilters);

function matchesCategory(pt, matchWord){ return (pt||"").includes(matchWord); }

function applyFilters(){
  const q = (document.getElementById("search").value||"").trim().toLowerCase();
  const cat = CUSTOMER_CATEGORIES.find(c=>c.key===CURRENT_CAT_KEY);

  FILTERED = PRODUCTS.filter(p=>{
    const catOk = matchesCategory(p.product_type, cat.match);
    const qOk = !q ? true : (p.title.toLowerCase().includes(q) || p.id.toLowerCase().includes(q));
    return catOk && qOk;
  });

  renderProducts(FILTERED);
}

function renderProducts(list){
  const grid = document.getElementById("products");
  grid.innerHTML="";

  list.forEach(p=>{
    const inCart = CART.has(p.id);
    const card = document.createElement("div");
    card.className = "card bg-white rounded-3xl shadow-soft border overflow-hidden";

    card.innerHTML = `
      <div class="bg-gray-50">
        <img src="${escapeHtml(p.image)}" class="w-full h-44 object-contain" alt="">
      </div>
      <div class="p-3">
        <div class="text-xs text-gray-500 font-semibold">${escapeHtml(p.id)}</div>
        <div class="mt-1 font-bold text-sm leading-snug min-h-[40px]">${escapeHtml(p.title)}</div>

        <div class="mt-2 flex items-center justify-between">
          <div class="text-sm font-black">â‚ª${(p.price||0).toFixed(0)}</div>
          <div class="text-xs text-gray-500">${escapeHtml(p.price_raw||"")}</div>
        </div>

        <div class="mt-3 flex gap-2">
          <button class="w-full px-3 py-3 rounded-2xl ${inCart ? "bg-black text-white" : "bg-green-600 text-white"} font-bold text-sm">
            ${inCart ? "âœ“ " + T("Ø¨Ø§Ù„Ø³Ù„Ø©","×‘×¢×’×œ×”") : "+ " + T("Ø£Ø¶Ù Ù„Ù„Ø³Ù„Ø©","×”×•×¡×£ ×œ×¢×’×œ×”")}
          </button>
          <a class="px-3 py-3 rounded-2xl bg-gray-100 text-black text-sm font-bold" href="${escapeHtml(p.link)}" target="_blank">
            ${escapeHtml(T("Ø±Ø§Ø¨Ø·","×§×™×©×•×¨"))}
          </a>
        </div>
      </div>
    `;

    card.querySelector("button").onclick = ()=>{
      if(CART.has(p.id)) CART.delete(p.id);
      else CART.set(p.id, 1);
      syncCartBadges();
      renderProducts(FILTERED);
      renderCart();
    };

    grid.appendChild(card);
  });
}

/* ========= CART DRAWER ========= */
const cartBtn = document.getElementById("cartBtn");
const cartDrawer = document.getElementById("cartDrawer");
const cartOverlay = document.getElementById("cartOverlay");
const closeCart = document.getElementById("closeCart");

cartBtn.onclick = openCart;
cartOverlay.onclick = closeCartFn;
closeCart.onclick = closeCartFn;

function openCart(){
  cartOverlay.classList.remove("hidden");
  cartDrawer.classList.remove("translate-x-full");
  renderCart();
}
function closeCartFn(){
  cartOverlay.classList.add("hidden");
  cartDrawer.classList.add("translate-x-full");
}

document.getElementById("clearCart").onclick = ()=>{
  CART.clear();
  syncCartBadges();
  renderCart();
  renderProducts(FILTERED);
};

function syncCartBadges(){
  const count = CART.size;
  document.getElementById("cartCountBadge").textContent = count.toString();
  document.getElementById("countSel").textContent = count.toString();
}

function calcSubtotal(){
  const map = new Map(PRODUCTS.map(p=>[p.id,p]));
  let sum = 0;
  for(const [id, qty] of CART.entries()){
    const p = map.get(id);
    if(!p) continue;
    sum += (p.price||0) * qty;
  }
  return sum;
}

function renderTotals(){
  const sub = calcSubtotal();
  document.getElementById("subtotal").textContent = sub.toFixed(0);
  document.getElementById("shipping").textContent = DELIVERY_FEE.toFixed(0);
  document.getElementById("total").textContent = (sub + DELIVERY_FEE).toFixed(0);
}

function renderCart(){
  const wrap = document.getElementById("cartItems");
  wrap.innerHTML = "";

  if(CART.size === 0){
    wrap.innerHTML = `<div class="p-4 rounded-2xl bg-gray-50 border text-gray-700 text-sm">${escapeHtml(T("Ø§Ù„Ø³Ù„Ø© ÙØ§Ø±ØºØ©â€¦ Ø§Ø®ØªØ± Ù…Ù†ØªØ¬Ø§Øª Ø£ÙˆÙ„Ø§Ù‹","×”×¢×’×œ×” ×¨×™×§×”â€¦ ×‘×—×¨ ××•×¦×¨×™×"))}</div>`;
    renderTotals();
    return;
  }

  const map = new Map(PRODUCTS.map(p=>[p.id,p]));

  for(const [id, qty] of CART.entries()){
    const p = map.get(id);
    if(!p) continue;

    const row = document.createElement("div");
    row.className = "flex gap-3 p-3 rounded-2xl border bg-white shadow-soft";
    row.innerHTML = `
      <img src="${escapeHtml(p.image)}" class="w-16 h-16 rounded-xl object-contain bg-gray-50 border" alt="">
      <div class="flex-1">
        <div class="text-xs text-gray-500 font-semibold">${escapeHtml(p.id)}</div>
        <div class="font-bold text-sm">${escapeHtml(p.title)}</div>
        <div class="mt-1 text-sm font-black">â‚ª${(p.price||0).toFixed(0)} <span class="text-xs text-gray-500 font-normal">x${qty}</span></div>
        <div class="mt-2 flex items-center gap-2">
          <button class="px-3 py-1 rounded-lg bg-gray-100 font-bold" data-act="dec">-</button>
          <div class="min-w-[28px] text-center font-black">${qty}</div>
          <button class="px-3 py-1 rounded-lg bg-gray-100 font-bold" data-act="inc">+</button>
        </div>
      </div>
      <button class="px-3 py-2 rounded-xl bg-black text-white text-xs font-bold h-fit" data-act="rm">${escapeHtml(T("Ø­Ø°Ù","×”×¡×¨"))}</button>
    `;

    row.querySelector('[data-act="dec"]').onclick = ()=>{
      const now = CART.get(id) || 1;
      if(now <= 1) CART.delete(id);
      else CART.set(id, now-1);
      syncCartBadges(); renderCart(); renderProducts(FILTERED);
    };
    row.querySelector('[data-act="inc"]').onclick = ()=>{
      const now = CART.get(id) || 1;
      CART.set(id, now+1);
      syncCartBadges(); renderCart();
    };
    row.querySelector('[data-act="rm"]').onclick = ()=>{
      CART.delete(id);
      syncCartBadges(); renderCart(); renderProducts(FILTERED);
    };

    wrap.appendChild(row);
  }

  renderTotals();
}

/* ========= BUNDLE + SEND ORDER ========= */
function buildBundleUrl(ids){
  const base = location.origin + location.pathname.replace(/[^/]+$/, "") + "bundle.html";
  const idsParam = encodeURIComponent(ids.join(","));
  const wa = CS_WHATSAPP;
  const langParam = LANG;
  return `${base}?ids=${idsParam}&lang=${encodeURIComponent(langParam)}&wa=${encodeURIComponent(wa)}`;
}

document.getElementById("openBundle").onclick = ()=>{
  if(CART.size === 0) return;
  const ids = Array.from(CART.keys());
  window.open(buildBundleUrl(ids), "_blank");
};

function getPay(){
  const el = document.querySelector('input[name="pay"]:checked');
  return el ? el.value : "COD";
}

function normalizePhone(p){
  return (p||"").trim();
}

document.getElementById("sendOrder").onclick = ()=>{
  if(CART.size === 0) return;

  const name = (document.getElementById("custName").value || "").trim();
  const phone = normalizePhone(document.getElementById("custPhone").value || "");
  const addr = (document.getElementById("custAddress").value || "").trim();
  const pay = getPay();

  if(!name || !phone || !addr){
    alert(T("Ø§Ù…Ù„Ø£ Ø§Ù„Ø§Ø³Ù… ÙˆØ§Ù„ØªÙ„ÙÙˆÙ† ÙˆØ§Ù„Ø¹Ù†ÙˆØ§Ù†","××œ× ×©×, ×˜×œ×¤×•×Ÿ ×•×›×ª×•×‘×ª"));
    openCart();
    return;
  }

  const ids = Array.from(CART.keys());
  const bundleUrl = buildBundleUrl(ids);

  const map = new Map(PRODUCTS.map(p=>[p.id, p]));
  let msg = T("ğŸ›’ Ø·Ù„Ø¨ Ø¬Ø¯ÙŠØ¯\n","ğŸ›’ ×”×–×× ×” ×—×“×©×”\n");
  msg += "----------------------\n";
  msg += T(`ğŸ‘¤ Ø§Ù„Ø§Ø³Ù…: ${name}\n`,`ğŸ‘¤ ×©×: ${name}\n`);
  msg += T(`ğŸ“ Ø§Ù„ØªÙ„ÙÙˆÙ†: ${phone}\n`,`ğŸ“ ×˜×œ×¤×•×Ÿ: ${phone}\n`);
  msg += T(`ğŸ“ Ø§Ù„Ø¹Ù†ÙˆØ§Ù†: ${addr}\n`,`ğŸ“ ×›×ª×•×‘×ª: ${addr}\n`);
  msg += T(`ğŸ’³ Ø§Ù„Ø¯ÙØ¹: ${pay==="COD" ? "Ø§Ù„Ø¯ÙØ¹ Ø¹Ù†Ø¯ Ø§Ù„Ø§Ø³ØªÙ„Ø§Ù…" : "Ø¨Ø·Ø§Ù‚Ø©/ØªØ­ÙˆÙŠÙ„"}\n`,
           `ğŸ’³ ×ª×©×œ×•×: ${pay==="COD" ? "×‘×¢×ª ××¡×™×¨×”" : "×›×¨×˜×™×¡/×”×¢×‘×¨×”"}\n`);
  msg += "----------------------\n";
  msg += T("ğŸ§¾ Ø§Ù„Ù…Ù†ØªØ¬Ø§Øª:\n","ğŸ§¾ ××•×¦×¨×™×:\n");

  for(const [id, qty] of CART.entries()){
    const p = map.get(id);
    if(!p) continue;
    msg += `â€¢ ${p.title} (x${qty}) â€” â‚ª${( (p.price||0)*qty ).toFixed(0)}\n`;
  }

  const sub = calcSubtotal();
  msg += "----------------------\n";
  msg += T(`Ø§Ù„Ù…Ø¬Ù…ÙˆØ¹ Ø§Ù„ÙØ±Ø¹ÙŠ: â‚ª${sub.toFixed(0)}\n`,`×¡×›×•× ×‘×™× ×™×™×: â‚ª${sub.toFixed(0)}\n`);
  msg += T(`Ø§Ù„ØªÙˆØµÙŠÙ„: â‚ª${DELIVERY_FEE}\n`,`××©×œ×•×—: â‚ª${DELIVERY_FEE}\n`);
  msg += T(`Ø§Ù„Ø¥Ø¬Ù…Ø§Ù„ÙŠ: â‚ª${(sub + DELIVERY_FEE).toFixed(0)}\n`,`×¡×”×´×›: â‚ª${(sub + DELIVERY_FEE).toFixed(0)}\n`);
  msg += "----------------------\n";
  msg += T("ğŸ“¦ Ø±Ø§Ø¨Ø· Ø§Ù„Ø¨Ø§Ù†Ø¯Ù„ (ØµÙˆØ±):\n","ğŸ“¦ ×§×™×©×•×¨ ×œ×‘×× ×“×œ (×ª××•× ×•×ª):\n");
  msg += bundleUrl + "\n";

  const waUrl = `https://wa.me/${CS_WHATSAPP}?text=${encodeURIComponent(msg)}`;
  window.open(waUrl, "_blank");
};

/* ========= UTILS ========= */
function escapeHtml(s){
  return (s||"").replace(/[&<>"']/g, m => ({ "&":"&amp;","<":"&lt;",">":"&gt;",'"':"&quot;","'":"&#039;" }[m]));
}

/* ========= INIT ========= */
setTexts();
syncCartBadges();
window.addEventListener("load", loadRSS);
</script>
</body>
</html>
