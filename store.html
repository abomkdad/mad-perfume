<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
<meta charset="UTF-8">
<title>متجر الفرع</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0">

<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css">

<style>
body{margin:0;font-family:system-ui;background:#f4f6fb}
.header{
background:#fff;padding:20px;text-align:center;
box-shadow:0 2px 10px rgba(0,0,0,.1)
}
.card{
background:#fff;margin:20px auto;
max-width:500px;border-radius:22px;
padding:24px;text-align:center;
box-shadow:0 10px 30px rgba(0,0,0,.06)
}
.actions{display:flex;justify-content:center;gap:20px;margin-top:16px}
.actions a{font-size:22px;color:#1d3a8a}
</style>
</head>

<body>

<div class="header">
<h1 id="name">متجر الفرع</h1>
</div>

<div class="card">
<div id="status"></div>
<div class="actions" id="actions"></div>
</div>

<script>
/* ================== LANGUAGE ================== */
const lang = navigator.language.startsWith("he") ? "he" : "ar";
document.documentElement.lang = lang;
document.documentElement.dir = "rtl";

/* ================== PARAMS ================== */
const params = new URLSearchParams(window.location.search);
const branchParam = params.get("branch"); // اختياري

/* ================== STATE ================== */
let branches = [];
let products = {};
let currentBranch = null;
let userLocation = null;

/* ================== HELPERS ================== */
function distance(lat1, lon1, lat2, lon2) {
  const R = 6371;
  const dLat = (lat2 - lat1) * Math.PI / 180;
  const dLon = (lon2 - lon1) * Math.PI / 180;
  const a =
    Math.sin(dLat/2)**2 +
    Math.cos(lat1*Math.PI/180) *
    Math.cos(lat2*Math.PI/180) *
    Math.sin(dLon/2)**2;
  return R * (2 * Math.atan2(Math.sqrt(a), Math.sqrt(1 - a)));
}

function isOpenNow() {
  const h = new Date().getHours();
  return h >= 10 && h < 22; // مؤقت – جاهز للتطوير
}

/* ================== LOAD DATA ================== */
async function loadData() {
  branches = await fetch("branches.json").then(r => r.json());

  const prodFile = lang === "he" ? "he-products.json" : "ar-products.json";
  const prodJson = await fetch(prodFile).then(r => r.json());
  products = prodJson.madperfume_catalog;

  getUserLocation();
}

/* ================== LOCATION ================== */
function getUserLocation() {
  navigator.geolocation.getCurrentPosition(
    pos => {
      userLocation = {
        lat: pos.coords.latitude,
        lng: pos.coords.longitude
      };
      selectBranch();
    },
    () => {
      selectBranch();
    },
    { enableHighAccuracy: true }
  );
}

/* ================== BRANCH SELECTION ================== */
function selectBranch() {
  // 1️⃣ إذا branch موجود بالرابط
  if (branchParam) {
    currentBranch = branches.find(b => b.id == branchParam);
  }

  // 2️⃣ إذا لا يوجد → أقرب فرع مفتوح
  if (!currentBranch && userLocation) {
    let min = Infinity;
    branches.forEach(b => {
      if (!isOpenNow()) return;
      const d = distance(
        userLocation.lat,
        userLocation.lng,
        b.lat,
        b.lng
      );
      if (d < min) {
        min = d;
        currentBranch = b;
      }
    });
  }

  // 3️⃣ fallback
  if (!currentBranch) currentBranch = branches[0];

  renderHeader();
  renderProducts();
}

/* ================== HEADER ================== */
function renderHeader() {
  document.getElementById("branchInfo").style.display = "block";
  document.getElementById("defaultInfo").style.display = "none";

  document.getElementById("branchName").textContent =
    lang === "he" ? currentBranch.name_he : currentBranch.name_ar;

  document.getElementById("branchHours").innerHTML =
    isOpenNow()
      ? (lang === "he" ? "פתוח עכשיו" : "مفتوح الآن")
      : (lang === "he" ? "סגור כעת" : "مغلق حاليًا");

  document.getElementById("mapLink").href = currentBranch.waze_maps || "#";
  document.getElementById("instaLink").href = currentBranch.social?.instagram || "#";
  document.getElementById("tiktokLink").href = currentBranch.social?.tiktok || "#";
  document.getElementById("fbLink").href = currentBranch.social?.facebook || "#";

  const wa = currentBranch.whatsapp;
  document.getElementById("waHeaderLink").href = `https://wa.me/${wa}`;
  document.getElementById("waFloat").href = `https://wa.me/${wa}`;
}

/* ================== CATEGORIES ================== */
function renderCategories() {
  const categoriesDiv = document.getElementById("categories");
  categoriesDiv.innerHTML = "";

  const cats = Object.keys(products);

  const allBtn = document.createElement("button");
  allBtn.textContent = lang === "he" ? "הכל" : "الكل";
  allBtn.classList.add("active");
  allBtn.onclick = () => {
    setActive(allBtn);
    renderProducts("ALL");
  };
  categoriesDiv.appendChild(allBtn);

  cats.forEach(cat => {
    const btn = document.createElement("button");
    btn.textContent = cat;
    btn.onclick = () => {
      setActive(btn);
      renderProducts(cat);
    };
    categoriesDiv.appendChild(btn);
  });
}

function setActive(btn) {
  document.querySelectorAll(".categories button")
    .forEach(b => b.classList.remove("active"));
  btn.classList.add("active");
}

/* ================== PRODUCTS ================== */
function renderProducts(filter = "ALL") {
  const grid = document.getElementById("products");
  grid.innerHTML = "";

  renderCategories();

  let list = [];
  if (filter === "ALL") {
    Object.values(products).forEach(arr => list.push(...arr));
  } else {
    list = products[filter] || [];
  }

  if (!list.length) {
    grid.innerHTML = `<div class="loading">لا توجد منتجات</div>`;
    return;
  }

  list.forEach(p => {
    const msg =
      lang === "he"
        ? `שלום, אני מעוניין במוצר: ${p.title}\nסניף: ${currentBranch.name_he}`
        : `مرحبًا، أنا مهتم بالمنتج: ${p.title}\nالفرع: ${currentBranch.name_ar}`;

    const waLink =
      `https://wa.me/${currentBranch.whatsapp}?text=${encodeURIComponent(msg)}`;

    const card = document.createElement("div");
    card.className = "card";

    card.innerHTML = `
      <img src="${p.image}" loading="lazy" alt="${p.title}">
      <div class="code">${p.title}</div>
      <div class="price">${p.price || ""}</div>
      <a class="btn" href="${waLink}" target="_blank">
        <i class="fa-brands fa-whatsapp"></i>
        ${lang === "he" ? "בדיקת זמינות" : "افحص التوفر"}
      </a>
    `;

    grid.appendChild(card);
  });
}

/* ================== START ================== */
loadData();
</script>


</body>
</html>
