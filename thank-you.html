<!-- =========================
     FILE: thank-you.html  (FULL + COMPATIBLE)
     - Meta Pixel + TikTok Pixel
     - FB: Purchase | TikTok: CompletePayment
     - AR/HE via ?lang=ar|he (fallback browser)
     - Prevent manual access + prevent refresh duplicate (sessionStorage)
========================= -->
<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no" />
  <title>تم تأكيد الطلب | MAD Parfumeur</title>

  <!-- META PIXEL -->
  <script>
    !function(f,b,e,v,n,t,s){
      if(f.fbq)return;
      n=f.fbq=function(){n.callMethod? n.callMethod.apply(n,arguments):n.queue.push(arguments)};
      if(!f._fbq)f._fbq=n;
      n.push=n; n.loaded=!0; n.version='2.0'; n.queue=[];
      t=b.createElement(e); t.async=!0; t.src=v;
      s=b.getElementsByTagName(e)[0]; s.parentNode.insertBefore(t,s)
    }(window, document,'script','https://connect.facebook.net/en_US/fbevents.js');
    fbq('init', '1072283127290819');
    fbq('track', 'PageView');
  </script>
  <noscript>
    <img height="1" width="1" style="display:none"
      src="https://www.facebook.com/tr?id=1072283127290819&ev=PageView&noscript=1"/>
  </noscript>

  <!-- TIKTOK PIXEL -->
  <script>
    !function (w, d, t) {
      w.TiktokAnalyticsObject = t;
      var ttq = w[t] = w[t] || [];
      ttq.methods = ["page","track","identify","instances","debug","on","off","once","ready","alias","group","enableCookie","disableCookie"];
      ttq.setAndDefer = function (t, e) {
        t[e] = function () { t.push([e].concat([].slice.call(arguments, 0))) };
      };
      for (var i = 0; i < ttq.methods.length; i++) ttq.setAndDefer(ttq, ttq.methods[i]);
      ttq.load = function (e, n) {
        var i = "https://analytics.tiktok.com/i18n/pixel/events.js";
        ttq._i = ttq._i || {};
        ttq._i[e] = [];
        ttq._i[e]._u = i;
        ttq._t = ttq._t || {};
        ttq._t[e] = +new Date;
        ttq._o = ttq._o || {};
        ttq._o[e] = n || {};
        var o = document.createElement("script");
        o.type = "text/javascript";
        o.async = !0;
        o.src = i + "?sdkid=" + e + "&lib=" + t;
        var a = document.getElementsByTagName("script")[0];
        a.parentNode.insertBefore(o, a);
      };
      ttq.load('D2D02JBC77U4ENLN9SBG');
      ttq.page();
    }(window, document, 'ttq');
  </script>

  <style>
    body{
      margin:0;min-height:100vh;display:flex;align-items:center;justify-content:center;
      background:#ffffff;font-family:system-ui,-apple-system,"Segoe UI",Arial;
      text-align:center;padding:20px;
    }
    .box{
      width:100%;max-width:460px;border-radius:24px;
      box-shadow:0 15px 60px rgba(0,0,0,.08);
      padding:36px 26px;background:#fff;
    }
    .logo{height:34px;opacity:.9;margin-bottom:18px}
    .check{font-size:64px;line-height:1;color:#12b76a;margin-bottom:14px}
    h1{margin:0 0 10px;font-size:22px}
    p{margin:0;color:#666;font-size:15px;line-height:1.7}
    .btn{display:block;margin-top:22px;padding:14px 18px;border-radius:14px;text-decoration:none;font-weight:800;}
    .btn-main{background:#000;color:#fff}
    .btn-wa{background:#25d366;color:#fff;margin-top:12px}
    .note{margin-top:14px;font-size:12px;color:#999}
    .warn{margin-top:14px;font-size:13px;color:#b42318;font-weight:800;display:none}
  </style>
</head>

<body>
  <div class="box">
    <img class="logo" src="https://madperfume.ps/upload/01-2026/page/45CM.png" alt="MAD">
    <div class="check" id="icon">✓</div>

    <h1 id="t">تم تأكيد طلبك بنجاح</h1>
    <p id="b">سيتم تجهيز المجموعة بعناية وتسليمها خلال 3–5 أيام عمل. الدفع عند الاستلام.</p>

    <a class="btn btn-main" href="index.html#order-section" id="btn">تقديم طلب جديد</a>
    <a class="btn btn-wa" href="https://wa.me/972509787730" id="wa">تواصل عبر واتساب</a>

    <div class="note" id="note">شكراً لاختيارك MAD Parfumeur</div>
    <div class="warn" id="warn">تم الدخول لصفحة الشكر بدون تحقق. سيتم تحويلك تلقائياً.</div>
  </div>

  <script>
    const qs = new URLSearchParams(location.search);

    // ---- Safe back URL (so it doesn't always go to homepage) ----
    function safeBack(raw){
      if(!raw) return null;
      try{
        const r = String(raw).trim();
        if(!r) return null;
        if(r.toLowerCase().startsWith("javascript:")) return null;

        if(r.startsWith("http://") || r.startsWith("https://")){
          const u = new URL(r);
          if(u.origin === location.origin) return u.pathname + u.search + u.hash;
          return null;
        }
        if(r.includes("://")) return null; // block other schemes
        return r; // relative path ok
      }catch(e){ return null; }
    }

    const backRaw = qs.get('back') || document.referrer || 'index.html#order-section';
    const back = safeBack(backRaw) || 'index.html#order-section';
    document.getElementById('btn').href = back;

    // ---- Language ----
    const langParam = (qs.get('lang') || '').toLowerCase();
    const isHebrew = langParam === 'he' || (navigator.language && navigator.language.toLowerCase().startsWith('he'));

    // ---- Purchase params ----
    const value = Number(qs.get('value') || '500');
    const currency = (qs.get('currency') || 'ILS').toUpperCase();
    const contentName = qs.get('item') || 'Elite Set';
    const contentId = qs.get('content_id') || 'ELITE_SET_5';

    // ---- Localize UI ----
    if (isHebrew) {
      document.documentElement.lang = 'he';
      document.documentElement.dir = 'rtl';
      document.title = "ההזמנה אושרה | MAD Parfumeur";
      document.getElementById('t').innerText = "ההזמנה אושרה בהצלחה";
      document.getElementById('b').innerText = "המארז יימסר תוך 3–5 ימי עסקים. תשלום במעמד המסירה.";
      document.getElementById('btn').innerText = "הזמנה חדשה";
      document.getElementById('wa').innerText = "צרו קשר בוואטסאפ";
      document.getElementById('note').innerText = "תודה שבחרתם MAD Parfumeur";
      document.getElementById('warn').innerText = "הגעתם לעמוד תודה ללא אימות. תועברו אוטומטית.";
    }

    // ---- Validation (prevent manual access) ----
    const ORDER_OK_KEY = "MAD_ORDER_OK_V1";
    const urlOk = (qs.get('mad_ty') === '1') || (qs.get('ty') === '1');
    let ssOk = false;
    try { ssOk = (sessionStorage.getItem(ORDER_OK_KEY) === '1'); } catch(e) {}

    const isValid = urlOk || ssOk;

    if (!isValid) {
      document.getElementById('warn').style.display = 'block';
      document.getElementById('icon').textContent = '!';
      document.getElementById('icon').style.color = '#b42318';
      setTimeout(() => { location.href = back; }, 1500);
    } else {
      // ---- Fire once per session ----
      const OLD_LOCK = 'mad_purchase_fired';
      const NEW_LOCK = 'MAD_PURCHASE_LOCK_V1';

      let already = false;
      try {
        already = sessionStorage.getItem(OLD_LOCK) === '1' || sessionStorage.getItem(NEW_LOCK) === '1';
      } catch(e) {}

      if (!already) {
        try { sessionStorage.setItem(OLD_LOCK, '1'); } catch(e) {}
        try { sessionStorage.setItem(NEW_LOCK, '1'); } catch(e) {}
        try { sessionStorage.removeItem(ORDER_OK_KEY); } catch(e) {} // optional: clean validation after success

        // Meta Purchase
        try {
          fbq('track', 'Purchase', {
            value: value,
            currency: currency,
            content_name: contentName,
            content_ids: [contentId],
            content_type: 'product'
          });
        } catch (e) {}

        // TikTok CompletePayment
        try {
          ttq.track('CompletePayment', {
            value: value,
            currency: currency,
            content_id: contentId,
            content_name: contentName,
            content_type: 'product',
            quantity: 1
          });
        } catch (e) {}
      }
    }
  </script>
</body>
</html>
