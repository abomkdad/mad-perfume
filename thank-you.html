<!doctype html>
<html lang="ar" dir="rtl">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width,initial-scale=1"/>
  <title>Thank You | MAD</title>

  <!-- Meta Pixel -->
  <script>
    !function(f,b,e,v,n,t,s){if(f.fbq)return;n=f.fbq=function(){n.callMethod?
    n.callMethod.apply(n,arguments):n.queue.push(arguments)};if(!f._fbq)n=f.fbq;
    n.push=n;n.loaded=!0;n.version='2.0';n.queue=[];t=b.createElement(e);t.async=!0;
    t.src=v;s=b.getElementsByTagName(e)[0];s.parentNode.insertBefore(t,s)}(window,document,'script',
    'https://connect.facebook.net/en_US/fbevents.js');
    fbq('init','1072283127290819');
    fbq('track','PageView');
  </script>

  <!-- TikTok Pixel -->
  <script>
    !function (w, d, t) { w.TiktokAnalyticsObject=t; var ttq=w[t]=w[t]||[];
      ttq.methods=["page","track","identify","instances","debug","on","off","once","ready","alias","group","enableCookie","disableCookie","holdConsent","revokeConsent","grantConsent"];
      ttq.setAndDefer=function(t,e){t[e]=function(){t.push([e].concat([].slice.call(arguments,0)))}}; 
      for(var i=0;i<ttq.methods.length;i++)ttq.setAndDefer(ttq,ttq.methods[i]);
      ttq.load=function(e,n){ var r="https://analytics.tiktok.com/i18n/pixel/events.js"; 
        ttq._i=ttq._i||{}; ttq._i[e]=[]; ttq._i[e]._u=r; ttq._t=ttq._t||{}; ttq._t[e]=+new Date; 
        ttq._o=ttq._o||{}; ttq._o[e]=n||{}; var s=d.createElement("script"); s.type="text/javascript"; 
        s.async=!0; s.src=r+"?sdkid="+e+"&lib="+t; var x=d.getElementsByTagName("script")[0];
        x.parentNode.insertBefore(s,x) };
      ttq.load('D2D02JBC77U4ENLN9SBG'); ttq.page();
    }(window, document, 'ttq');
  </script>

  <style>
    body{margin:0;background:#0a0a0a;color:#fff;font-family:system-ui,-apple-system,Segoe UI,Roboto;display:flex;min-height:100vh;align-items:center;justify-content:center;padding:20px}
    .card{max-width:560px;width:100%;background:#111;border:1px solid rgba(255,255,255,.1);border-radius:18px;padding:22px;text-align:center}
    .ok{font-size:22px;font-weight:900;margin:0 0 10px}
    .sub{opacity:.8;margin:0 0 18px;line-height:1.6}
    .pill{display:inline-block;padding:6px 12px;border-radius:999px;background:rgba(217,119,6,.15);border:1px solid rgba(217,119,6,.35);color:#fbbf24;font-weight:800;font-size:12px}
  </style>
</head>
<body>
  <div class="card">
    <div class="pill" id="pill">MAD</div>
    <h1 class="ok" id="title">تم استلام طلبك ✅</h1>
    <p class="sub" id="desc">شكراً! سيتم التواصل معك خلال وقت قصير.</p>
    <p class="sub" style="font-size:12px;opacity:.6" id="oid"></p>
  </div>

<script>
(function(){
  const qs = new URLSearchParams(location.search || "");
  const lang = (qs.get("lang")||"ar").toLowerCase();
  document.documentElement.lang = lang;
  document.documentElement.dir = (lang==="he") ? "rtl" : "rtl";

  const value = parseFloat(qs.get("value") || "500") || 500;
  const currency = qs.get("currency") || "ILS";
  const item = qs.get("item") || "Offer";
  const content_id = qs.get("content_id") || "";
  const oid = qs.get("oid") || "";
  const mad_ty = qs.get("mad_ty") || "";

  document.getElementById("pill").textContent = item;
  document.getElementById("oid").textContent = oid ? ("Order ID: " + oid) : "";

  // امنع الدخول اليدوي (بدون تحويل من السكربت)
  if(mad_ty !== "1" || !oid){
    console.log("Blocked: manual access");
    return;
  }

  // منع التكرار لكل طلب
  const lockKey = "MAD_TX_LOCK_" + oid;
  if(sessionStorage.getItem(lockKey) === "1"){
    console.log("Already fired for this order");
    return;
  }
  sessionStorage.setItem(lockKey, "1");

  // ✅ هنا إطلاق Lead + Purchase بشكل مضمون
  try{
    fbq && fbq("track","Lead", {
      value:value, currency:currency,
      content_name:item,
      content_ids: content_id ? [content_id] : undefined,
      content_type:"product"
    });
  }catch(e){}

  try{
    fbq && fbq("track","Purchase", {
      value:value, currency:currency,
      content_name:item,
      content_ids: content_id ? [content_id] : undefined,
      content_type:"product",
      contents: content_id ? [{id:content_id, quantity:1}] : undefined
    });
  }catch(e){}

  // TikTok (الأفضل حدث قياسي + كمان Lead لو بدك)
  try{
    ttq && ttq.track("SubmitForm", {content_id:content_id, content_type:"product"});
  }catch(e){}

  try{
    ttq && ttq.track("CompletePayment", {value:value, currency:currency, content_id:content_id});
  }catch(e){}

  // لو مصرّ على Lead بتكتوك كاسم (Custom)
  try{
    ttq && ttq.track("Lead", {value:value, currency:currency, content_id:content_id});
  }catch(e){}
})();
</script>
</body>
</html>
