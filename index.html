<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>MAD Parfumeur | Ø§Ù„ÙØ±ÙˆØ¹</title>

  <!-- Leaflet -->
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"/>
  <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>

  <style>
    :root {
      --mad-blue:#1d3a8a;
      --open:#22c55e;
      --closed:#ef4444;
    }

    body {
      margin:0;
      font-family:Segoe UI,Tahoma,sans-serif;
      background:#f4f7ff;
    }

    header {
      background:#fff;
      padding:10px 15px;
      display:flex;
      align-items:center;
      justify-content:space-between;
      box-shadow:0 2px 8px rgba(0,0,0,.1);
      position:sticky;
      top:0;
      z-index:1000;
    }

    header img {
      height:45px;
    }

    #map {
      height:320px;
      margin:15px;
      border-radius:20px;
      overflow:hidden;
    }

    .container {
      max-width:600px;
      margin:auto;
      padding:0 15px 40px;
    }

    .card {
      background:#fff;
      border-radius:20px;
      padding:20px;
      margin-bottom:20px;
      box-shadow:0 5px 20px rgba(0,0,0,.05);
      text-align:center;
    }

    .status {
      font-weight:bold;
      margin-bottom:5px;
    }

    .open {color:var(--open)}
    .closed {color:var(--closed)}

    .nearest {
      color:var(--open);
      font-weight:bold;
      margin-bottom:10px;
    }

    .actions a {
      display:inline-block;
      margin:5px;
      padding:10px 15px;
      border-radius:10px;
      text-decoration:none;
      font-weight:bold;
      background:#eef2ff;
      color:var(--mad-blue);
    }
  </style>
</head>

<body>

<header>
  <img src="logo.png" alt="MAD">
  <select id="langSelect" onchange="renderBranches()">
    <option value="ar" selected>Ø§Ù„Ø¹Ø±Ø¨ÙŠØ©</option>
    <option value="he">×¢×‘×¨×™×ª</option>
  </select>
</header>

<div id="map"></div>

<div class="container" id="branches"></div>

<script>
/* ================== DATA ================== */
let db = { branches: [] };
let userLocation = null;
let map;

/* ================== LOAD DATA ================== */
async function loadData(){
  const res = await fetch('branches.json');
  db.branches = await res.json();
  initMap();
  renderBranches();
}

/* ================== LOCATION ================== */
function getUserLocation(){
  return new Promise((resolve,reject)=>{
    navigator.geolocation.getCurrentPosition(
      p=>resolve({lat:p.coords.latitude,lng:p.coords.longitude}),
      ()=>reject()
    );
  });
}

/* ================== DISTANCE ================== */
function distance(lat1,lng1,lat2,lng2){
  const R=6371;
  const dLat=(lat2-lat1)*Math.PI/180;
  const dLng=(lng2-lng1)*Math.PI/180;
  const a=Math.sin(dLat/2)**2+
    Math.cos(lat1*Math.PI/180)*Math.cos(lat2*Math.PI/180)*
    Math.sin(dLng/2)**2;
  return R*(2*Math.atan2(Math.sqrt(a),Math.sqrt(1-a)));
}

/* ================== OPEN / CLOSE ================== */
function isOpenNow(){
  const h=new Date().getHours();
  return h>=10 && h<22;
}

/* ================== MAP ================== */
const greenIcon=L.icon({
  iconUrl:'https://maps.gstatic.com/mapfiles/ms2/micons/green-dot.png',
  iconSize:[32,32],
  iconAnchor:[16,32]
});
const redIcon=L.icon({
  iconUrl:'https://maps.gstatic.com/mapfiles/ms2/micons/red-dot.png',
  iconSize:[32,32],
  iconAnchor:[16,32]
});
const blueIcon=L.icon({
  iconUrl:'https://maps.gstatic.com/mapfiles/ms2/micons/blue-dot.png',
  iconSize:[32,32],
  iconAnchor:[16,32]
});

async function initMap(){
  map=L.map('map').setView([32.0853,34.7818],9);
  L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png',{
    attribution:'Â© OpenStreetMap'
  }).addTo(map);

  try{
    userLocation=await getUserLocation();
    L.marker([userLocation.lat,userLocation.lng],{icon:blueIcon})
      .addTo(map).bindPopup('ğŸ“ Ù…ÙˆÙ‚Ø¹Ùƒ');
  }catch{}

  drawBranchesOnMap();
}

/* ================== DRAW BRANCHES ================== */
function drawBranchesOnMap(){
  const lang=document.getElementById('langSelect').value;
  let nearest=null,min=Infinity;

  if(userLocation){
    db.branches.forEach(b=>{
      if(!isOpenNow())return;
      const d=distance(userLocation.lat,userLocation.lng,b.lat,b.lng);
      if(d<min){min=d;nearest=b;}
    });
  }

  db.branches.forEach(b=>{
    const open=isOpenNow();
    const icon=open?greenIcon:redIcon;
    const marker=L.marker([b.lat,b.lng],{icon}).addTo(map)
      .bindPopup(`
        <b>${lang==='ar'?b.name_ar:b.name_he}</b><br>
        ${open?'ğŸŸ¢ Ù…ÙØªÙˆØ­':'ğŸ”´ Ù…ØºÙ„Ù‚'}<br><br>
        <a href="${b.waze_maps}" target="_blank">ğŸ§­ Waze</a><br>
        <a href="tel:${b.phone}">ğŸ“ Ø§ØªØµØ§Ù„</a>
      `);

    if(nearest && b.id===nearest.id){
      marker.openPopup();
      map.setView([b.lat,b.lng],13);
    }
  });
}

/* ================== LIST ================== */
function renderBranches(){
  const box=document.getElementById('branches');
  const lang=document.getElementById('langSelect').value;
  box.innerHTML='';

  let nearestId=null,min=Infinity;
  if(userLocation){
    db.branches.forEach(b=>{
      const d=distance(userLocation.lat,userLocation.lng,b.lat,b.lng);
      if(d<min && isOpenNow()){min=d;nearestId=b.id;}
    });
  }

  db.branches.forEach(b=>{
    const open=isOpenNow();
    box.innerHTML+=`
      <div class="card">
        ${b.id===nearestId?'<div class="nearest">ğŸ“ Ø£Ù‚Ø±Ø¨ ÙØ±Ø¹ Ù„Ùƒ</div>':''}
        <div class="status ${open?'open':'closed'}">
          ${open?'ğŸŸ¢ Ù…ÙØªÙˆØ­ Ø§Ù„Ø¢Ù†':'ğŸ”´ Ù…ØºÙ„Ù‚ Ø§Ù„Ø¢Ù†'}
        </div>
        <h2>${lang==='ar'?b.name_ar:b.name_he}</h2>
        <div class="actions">
          <a href="${b.waze_maps}" target="_blank">Waze</a>
          <a href="tel:${b.phone}">Ø§ØªØµØ§Ù„</a>
        </div>
      </div>`;
  });
}

loadData();
</script>

</body>
</html>
