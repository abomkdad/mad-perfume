<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no" />
  <title>MAD PARFUMEUR | Our Branches</title>

  <!-- Fonts -->
  <link href="https://fonts.googleapis.com/css2?family=Playfair+Display:ital,wght@0,400;0,700;0,900;1,400;1,900&family=Inter:wght@300;400;600;800&family=Amiri:wght@400;700&family=Assistant:wght@300;400;600;700;800&display=swap" rel="stylesheet">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">

  <!-- Tailwind CSS (CDN) -->
  <script src="https://cdn.tailwindcss.com"></script>

  <!-- Lucide for icons -->
  <script src="https://unpkg.com/lucide@latest"></script>

  <!-- Leaflet Map CSS -->
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"
     integrity="sha256-p4NxAoJBhIIN+hmNHrzRCf9tD/miZyoHS5obTRR9BMY="
     crossorigin=""/>

  <!-- Tracking Scripts -->
  <script>
    !function(f,b,e,v,n,t,s){if(f.fbq)return;n=f.fbq=function(){n.callMethod?
    n.callMethod.apply(n,arguments):n.queue.push(arguments)};if(!f._fbq)f._fbq=n;
    n.push=n;n.loaded=!0;n.version='2.0';n.queue=[];t=b.createElement(e);t.async=!0;
    t.src=v;s=b.getElementsByTagName(e)[0];s.parentNode.insertBefore(t,s)}(window,document,'script',
    'https://connect.facebook.net/en_US/fbevents.js');
    fbq('init', '1072283127290819');
    fbq('track', 'PageView');
  </script>

  <script>
    !function (w, d, t) {
      w.TiktokAnalyticsObject=t;var ttq=w[t]=w[t]||[];
      ttq.methods=["page","track","identify","instances","debug","on","off","once","ready","alias","group","enableCookie","disableCookie","holdConsent","revokeConsent","grantConsent"];
      ttq.setAndDefer=function(t,e){t[e]=function(){t.push([e].concat(Array.prototype.slice.call(arguments,0)))}};for(var i=0;i<ttq.methods.length;i++)ttq.setAndDefer(ttq,ttq.methods[i]);
      ttq.instance=function(t){for(var e=ttq._i[t]||[],n=0;n<ttq.methods.length;n++)ttq.setAndDefer(e,ttq.methods[n]);return e};
      ttq.load=function(e,n){var r="https://analytics.tiktok.com/i18n/pixel/events.js",o=n&&n.partner;ttq._i=ttq._i||{},ttq._i[e]=[],ttq._i[e]._u=r,ttq._t=ttq._t||{},ttq._t[e]=+new Date,ttq._o=ttq._o||{},ttq._o[e]=n||{};
      n=document.createElement("script");n.type="text/javascript",n.async=!0,n.src=r+"?sdkid="+e+"&lib="+t;e=document.getElementsByTagName("script")[0];e.parentNode.insertBefore(n,e)};
      ttq.load('D2D02JBC77U4ENLN9SBG');
      ttq.page();
    }(window, document, 'ttq');

    function trackLead(actionName) {
      try { if(window.fbq) fbq('track', 'Lead', { content_name: actionName }); } catch(e){}
      try { if(window.ttq) ttq.track('Lead', { content_name: actionName }); } catch(e){}
    }

    function trackView(actionName) {
      try { if(window.fbq) fbq('track', 'ViewContent', { content_name: actionName }); } catch(e){}
      try { if(window.ttq) ttq.track('ViewContent', { content_name: actionName }); } catch(e){}
    }
  </script>

  <style>
    :root{
      --primary:#d97706;
      --primary-light:#fbbf24;
      --bg-dark:#020202;
      --glass:rgba(10,10,10,.85);
      --border-glass:rgba(255,255,255,.1);
      --live-green:#10b981;
      --live-red:#ef4444;
      --gold: #d4af37;
    }
    *{ box-sizing:border-box; }

    body{
      background-color:var(--bg-dark);
      color:#f4f4f4;
      font-family:'Assistant','Inter',sans-serif;
      overflow-x:hidden;
      font-size:16px;
      opacity:0; /* Starts hidden */
      transition:opacity .5s ease;
      padding-bottom: 70px; /* Space for Trust Bar */
    }
    .font-serif{font-family:'Playfair Display',serif;}

    /* Loader */
    .page-loader{
      position:fixed;inset:0;z-index:9999;
      background:#020202;
      display:flex;align-items:center;justify-content:center;flex-direction:column;gap:16px;
    }
    .loader-dot{width:10px;height:10px;border-radius:99px;background:var(--primary);box-shadow:0 0 18px rgba(217,119,6,.55);animation:pulse 1.2s infinite;}
    @keyframes pulse{0%{opacity:1;transform:scale(1)}50%{opacity:.4;transform:scale(.8)}100%{opacity:1;transform:scale(1)}}

    /* Header Video */
    .video-header{position:relative;height:auto;min-height:85vh;width:100%;overflow:hidden;display:flex;align-items:center;justify-content:center;text-align:center;}
    .video-bg{position:absolute;top:0;left:0;width:100%;height:100%;object-fit:cover;z-index:0;opacity:.6;}
    .video-overlay{position:absolute;inset:0;background:linear-gradient(to top,#020202 5%,rgba(0,0,0,.3) 60%,#020202 100%);z-index:1;}
    .header-content{position:relative;z-index:10;padding:20px;width:100%; max-width: 800px;}

    /* --- New Header Elements CSS --- */
    .logo img { height: 70px; margin: 0 auto 15px; display: block; filter: drop-shadow(0 0 10px rgba(212, 175, 55, 0.3)); }
    .brand-name { font-family: 'Playfair Display', serif; font-size: 2rem; font-weight: 900; color: #fff; letter-spacing: 2px; margin-bottom: 30px; text-shadow: 0 4px 10px rgba(0,0,0,0.5); }

    .action-grid {
      display: grid;
      grid-template-columns: repeat(2, 1fr);
      gap: 12px;
      margin-bottom: 30px;
    }
    .action-item {
      background: rgba(255,255,255,0.08);
      border: 1px solid rgba(255,255,255,0.15);
      border-radius: 16px;
      padding: 15px 10px;
      text-align: center;
      color: #fff;
      text-decoration: none;
      transition: all 0.3s ease;
      backdrop-filter: blur(5px);
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      min-height: 110px;
    }
    .action-item:hover { background: rgba(212, 175, 55, 0.2); border-color: var(--gold); transform: translateY(-3px); }
    .action-item i { font-size: 24px; margin-bottom: 8px; color: var(--gold); }
    .action-item span { font-weight: 800; font-size: 0.95rem; display: block; line-height: 1.2; }
    .action-item .desc { font-size: 0.7rem; opacity: 0.8; margin-top: 4px; color: #ddd; }
    .action-item .hotline { font-family: 'Inter', sans-serif; font-weight: 900; font-size: 0.8rem; margin-top: 6px; color: var(--gold); letter-spacing: 0.5px; }

    /* GPS Button */
    .container { width: 100%; padding: 0 16px; position: relative; z-index: 5; }
    .gps-trigger {
      background: linear-gradient(135deg, #111 0%, #222 100%);
      border: 1px solid var(--gold);
      color: var(--gold);
      width: 100%;
      max-width: 400px;
      margin: 0 auto 10px;
      padding: 16px;
      border-radius: 50px;
      font-weight: 900;
      font-size: 1.1rem;
      display: flex;
      align-items: center;
      justify-content: center;
      gap: 10px;
      cursor: pointer;
      box-shadow: 0 4px 15px rgba(212, 175, 55, 0.15);
      transition: all 0.3s;
    }
    .gps-trigger:hover { box-shadow: 0 0 20px rgba(212, 175, 55, 0.4); transform: scale(1.02); background: #000; }
    .gps-sub { text-align: center; color: #888; font-size: 0.8rem; margin-bottom: 30px; }

    /* Branch Card */
    .branch-card {
      background: rgba(255,255,255,0.03);
      border: 1px solid var(--border-glass);
      border-radius: 20px;
      padding: 24px;
      display: flex;
      flex-direction: column;
      gap: 16px;
      transition: all 0.3s ease;
      position: relative;
      overflow: hidden;
    }
    .branch-card:hover {
      border-color: var(--primary);
      background: rgba(255,255,255,0.05);
      transform: translateY(-5px);
    }
    .branch-header { display: flex; justify-content: space-between; align-items: flex-start; }
    .branch-title { font-size: 1.5rem; font-weight: 900; color: #fff; line-height: 1.2; font-family: 'Playfair Display', serif; }
    .status-pill {
      font-size: 0.75rem; font-weight: 800; padding: 4px 10px; border-radius: 99px;
      display: flex; align-items: center; gap: 6px; white-space: nowrap;
    }
    .status-pill.open { background: rgba(16, 185, 129, 0.2); color: #34d399; border: 1px solid rgba(16, 185, 129, 0.3); }
    .status-pill.closed { background: rgba(239, 68, 68, 0.2); color: #f87171; border: 1px solid rgba(239, 68, 68, 0.3); }
    .dot { width: 8px; height: 8px; border-radius: 50%; }
    .status-pill.open .dot { background: #34d399; box-shadow: 0 0 8px #34d399; animation: pulse 2s infinite; }
    .status-pill.closed .dot { background: #f87171; }

    .hours-text {
      font-size: 0.85rem;
      color: #ccc;
      display: flex;
      flex-direction: column;
      gap: 4px;
      background: rgba(255,255,255,0.03);
      padding: 10px;
      border-radius: 8px;
    }

    .social-grid { display: flex; gap: 10px; flex-wrap: wrap; margin-top: auto; }
    .s-btn {
      flex: 1; height: 44px; border-radius: 12px;
      display: flex; align-items: center; justify-content: center;
      font-size: 1.2rem; color: #fff; border: 1px solid rgba(255,255,255,0.1);
      background: rgba(255,255,255,0.05); transition: 0.2s;
      min-width: 44px; max-width: 60px;
      text-decoration: none;
    }
    .s-btn:hover { background: var(--primary); color: #000; border-color: var(--primary); }

    .waze-btn { background: #33ccff20; color: #33ccff; border-color: #33ccff40; flex-grow: 2; max-width: none; font-size: 1rem; font-weight: bold; gap: 8px; }
    .waze-btn:hover { background: #33ccff; color: #000; }

    .wa-btn { background: #25D36620; color: #25D366; border-color: #25D36640; flex-grow: 2; max-width: none; font-size: 1rem; font-weight: bold; gap: 8px; }
    .wa-btn:hover { background: #25D366; color: #fff; }

    /* ✅ NEW: Offer button */
    .offer-btn {
      background: rgba(212,175,55,0.14);
      color: var(--gold);
      border-color: rgba(212,175,55,0.35);
      flex-grow: 2;
      max-width: none;
      font-size: 1rem;
      font-weight: 900;
      gap: 8px;
    }
    .offer-btn:hover { background: var(--gold); color: #000; }

    /* Trust Bar & Overlay */
    .trust-bar {
      position: fixed; bottom: 0; left: 0; width: 100%;
      background: rgba(10,10,10,0.95);
      border-top: 1px solid var(--gold);
      padding: 10px 20px;
      display: flex; justify-content: space-between; align-items: center;
      z-index: 990; backdrop-filter: blur(10px);
      cursor: pointer;
    }
    .trust-bar .btn.bg-wa {
      background: #25D366; color: #fff; border-radius: 20px; display: flex; align-items: center; font-weight: bold;
    }
    #trust-overlay {
      position: fixed; top: 0; left: 0; width: 100%; height: 100%;
      background: #000; z-index: 1000; display: none;
      flex-direction: column;
    }
    .overlay-close {
      position: absolute; top: 20px; right: 20px; width: 40px; height: 40px;
      background: rgba(255,255,255,0.1); border-radius: 50%; border: none;
      color: #fff; font-size: 24px; cursor: pointer; z-index: 1001;
    }
    .overlay-close::after { content: '×'; }
    .overlay-content { flex: 1; width: 100%; height: 100%; }
    .overlay-content iframe { width: 100%; height: 100%; border: none; }

    /* Map */
    #map { height: 500px; width: 100%; border-radius: 20px; z-index: 1; }
    .leaflet-popup-content-wrapper { background: #111; color: #fff; border: 1px solid var(--primary); border-radius: 12px; }
    .leaflet-popup-tip { background: var(--primary); }
    .map-btn {
      display: inline-block; background: var(--primary); color: #000;
      padding: 6px 12px; border-radius: 6px; font-weight: bold; margin-top: 8px;
      text-decoration: none; font-size: 0.9rem;
    }
  </style>
</head>

<body dir="rtl">

  <!-- LOADER -->
  <div id="page-loader" class="page-loader">
    <div class="loader-dot"></div>
    <div class="text-white font-black tracking-widest text-xs uppercase">Loading</div>
  </div>

  <!-- LANGUAGE TOGGLE -->
  <div class="fixed top-6 right-6 z-50 flex gap-3">
    <button onclick="setLang('ar')" class="w-10 h-10 flex items-center justify-center bg-black/60 backdrop-blur rounded-full border border-white/20 text-sm font-bold text-white hover:border-amber-500 hover:text-amber-500 transition">AR</button>
    <button onclick="setLang('he')" class="w-10 h-10 flex items-center justify-center bg-black/60 backdrop-blur rounded-full border border-white/20 text-sm font-bold text-white hover:border-amber-500 hover:text-amber-500 transition">HE</button>
  </div>

  <!-- HEADER -->
  <header class="video-header">
    <video autoplay muted loop playsinline class="video-bg">
      <source src="https://madparfumeurglobal.com/wp-content/uploads/2025/10/download.mp4" type="video/mp4">
    </video>
    <div class="video-overlay"></div>

    <div class="header-content">
      <div class="logo"><img src="https://abomkdad.github.io/Digital-Business-Card/logo.png" alt="MAD Logo"></div>
      <div class="brand-name">MAD PARFUMEUR ISRAEL</div>

      <div class="action-grid">
        <a href="tel:*9935" class="action-item" id="csBtn" onclick="trackLead('Customer Service Call')">
          <i class="fas fa-phone-alt"></i>
          <span id="l-cs"></span>
          <div class="desc" id="l-cs-desc"></div>
          <div class="hotline">*9935</div>
        </a>

        <a id="wa-corp-btn" href="https://wa.me/972524033442" target="_blank" class="action-item" onclick="trackLead('Corporate WhatsApp')">
          <i class="fab fa-whatsapp"></i>
          <span id="l-wa"></span>
          <div class="desc" id="l-wa-desc"></div>
          <div class="hotline">972524033442</div>
        </a>

        <a href="https://madperfume.co.il/" target="_blank" class="action-item" id="storeBtn" onclick="trackView('Store Link')">
          <i class="fas fa-shopping-bag"></i>
          <span id="l-store"></span>
          <div class="desc" id="l-store-desc"></div>
          <div class="hotline">madperfume.co.il</div>
        </a>

        <a href="https://www.mad-parfumeur.com/frangaize.html" target="_blank" class="action-item" id="franchiseBtn" onclick="trackView('Franchise Link')">
          <i class="fas fa-certificate"></i>
          <span id="l-franchise"></span>
          <div class="desc" id="l-franchise-desc"></div>
          <div class="hotline">Join MAD Family</div>
        </a>
      </div>
    </div>
  </header>

  <!-- CONTAINER WITH GPS & BRANCHES -->
  <div class="container bg-[#050505] min-h-screen py-8">
    <button class="gps-trigger" onclick="requestLocation()">
      <i class="fas fa-location-arrow"></i>
      <span id="l-gps-btn"></span>
    </button>
    <div class="gps-sub" id="l-gps-sub"></div>

    <div id="branches-grid" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 xl:grid-cols-4 gap-6 max-w-7xl mx-auto">
      <!-- Generated by JS -->
    </div>
  </div>

  <!-- MAP SECTION -->
  <section id="locations-map" class="py-16 px-4 bg-black border-t border-white/10">
    <div class="max-w-6xl mx-auto border border-white/10 rounded-3xl p-2 bg-[#111]">
      <div id="map"></div>
    </div>
  </section>

  <!-- TRUST BAR (Floating Bottom) -->
  <div class="trust-bar" id="trustBar" onclick="toggleOverlay(true)">
    <div class="btn bg-wa" style="padding: 5px 12px; font-size:10px; flex-direction: row; gap:5px; height: auto; min-height: unset;">
      <span id="l-cta"></span> <i class="fas fa-chevron-left"></i>
    </div>
    <div style="text-align: right;">
      <div style="color:var(--gold); font-size:12px;">★★★★★</div>
      <div id="l-bar-main" style="font-size: 11px; font-weight: 900; color: var(--gold);"></div>
    </div>
  </div>

  <!-- TRUST OVERLAY -->
  <div id="trust-overlay">
    <button class="overlay-close" onclick="toggleOverlay(false)" id="l-close"></button>
    <div class="overlay-content">
      <iframe src="https://www.mad-parfumeur.com/ifra.html"></iframe>
    </div>
  </div>

  <!-- Leaflet JS -->
  <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js" integrity="sha256-20nQCchB9co0qIjJZRGuk2/Z9VM+kNiyxNV1lvTlZBo=" crossorigin=""></script>

  <script>
    /***********************
     * ✅ EMBEDDED DATA
     ***********************/
    const BRANCH_DB = {
      "brand": "MAD Perfume Israel",
      "branches": [
        { "id": 1, "name_ar": "دالية الكرمل", "name_he": "דלית אל כרמל", "phone": "0525592293", "hours": "يومياً 10:00-22:00", "schedule": { "sun": [["10:00","22:00"]], "mon": [["10:00","22:00"]], "tue": [["10:00","22:00"]], "wed": [["10:00","22:00"]], "thu": [["10:00","22:00"]], "fri": [["10:00","22:00"]], "sat": [["10:00","22:00"]] }, "lat": 32.6946, "lng": 35.0452, "social": { "tiktok": "https://www.tiktok.com/@madperfum_daliytalkarmel?_r=1&_t=ZS-92xp7xFmUx0", "instagram": "https://www.instagram.com/madperfume_daliyat.al.karmel?igsh=MXJ5OGMyY29uMWx4cQ==", "facebook": "https://www.facebook.com/share/14PaVKwDWQW/", "snapchat": "https://snapchat.com/t/jbtN32Xe", "youtube": "https://www.youtube.com/watch?v=NVCKAp2-6HM", "email": "info@madperfume.co.il", "waze": "https://ul.waze.com/ul?ll=32.6946,35.0452&navigate=yes" } }
        // ... (باقي الفروع عندك كما هي بدون أي تغيير)
      ]
    };

    let lang = "ar";
    let map = null;

    const TEXTS = {
      ar: {
        l_cs: "خدمة الزبائن",
        l_cs_desc: "للاستفسارات العامة",
        l_wa: "واتساب الإدارة",
        l_wa_desc: "للشكاوى والاقتراحات",
        l_store: "المتجر الإلكتروني",
        l_store_desc: "تسوق الآن",
        l_franchise: "هل تريد ان تفتح فرع خاص بك",
        l_franchise_desc: "ابدأ مسيرة نجاحك",
        l_gps_btn: "أقرب فرع لي",
        l_cta: "معايير الجودة",
        l_bar_main: "IFRA معتمد عالمياً",
        open: "مفتوح الآن",
        closed: "مغلق",
        navWaze: "افتح في Waze",
        closedLabel: "مغلق",
        offerBtn: "العروض",
        weekDays: { sun: "الأحد", mon: "الاثنين", tue: "الثلاثاء", wed: "الأربعاء", thu: "الخميس", fri: "الجمعة", sat: "السبت" }
      },
      he: {
        l_cs: "שירות לקוחות",
        l_cs_desc: "לפניות כלליות",
        l_wa: "וואטסאפ הנהלה",
        l_wa_desc: "לתלונות והצעות",
        l_store: "חנות אונליין",
        l_store_desc: "קנה עכשיו",
        l_franchise: "רוצה לפתוח סניף משלך?",
        l_franchise_desc: "התחל את מסע ההצלחה שלך",
        l_gps_btn: "הסניף הקרוב אליי",
        l_cta: "תקני איכות",
        l_bar_main: "IFRA מוסמך עולמית",
        open: "פתוח עכשיו",
        closed: "סגור",
        navWaze: "פתח ב-Waze",
        closedLabel: "סגור",
        offerBtn: "מבצעים",
        weekDays: { sun: "ראשון", mon: "שני", tue: "שלישי", wed: "רביעי", thu: "חמישי", fri: "שישי", sat: "שבת" }
      }
    };

    function normalizePhoneForWhatsApp(phone){
      const p = (phone || "").toString().replace(/\D/g,"");
      if(!p) return "";
      if(p.startsWith("972") || p.startsWith("970")) return p;
      if(p.startsWith("059") || p.startsWith("056")) return "970" + p.substring(1);
      if(p.startsWith("05")) return "972" + p.substring(1);
      if(p.startsWith("0")) return "972" + p.substring(1);
      return p;
    }

    /* ✅ NEW: detect language (URL > localStorage > browser) */
    function detectLang(){
      try {
        const params = new URLSearchParams(window.location.search);
        const urlLang = (params.get("lang") || "").toLowerCase();
        if(urlLang === "ar" || urlLang === "he") return urlLang;

        const saved = (localStorage.getItem("lang") || "").toLowerCase();
        if(saved === "ar" || saved === "he") return saved;

        const nav = (navigator.language || "").toLowerCase();
        if(nav.startsWith("ar")) return "ar";
        if(nav.startsWith("he") || nav.startsWith("iw")) return "he";
        return "he"; // default
      } catch(e){
        return "he";
      }
    }

    function init(){
      lang = detectLang();
      setLang(lang, true);

      document.getElementById("page-loader").style.display = "none";
      document.body.style.opacity = "1";
    }

    function setLang(l, isInit=false){
      lang = (l === "ar") ? "ar" : "he";

      document.documentElement.dir = (lang === "ar") ? "rtl" : "ltr";
      document.body.dir = (lang === "ar") ? "rtl" : "ltr";
      document.documentElement.lang = lang;

      /* ✅ NEW: save language */
      try { localStorage.setItem("lang", lang); } catch(e){}

      /* keep lang in URL for branches page */
      try {
        const u = new URL(window.location.href);
        u.searchParams.set("lang", lang);
        history.replaceState({}, "", u.toString());
      } catch (e) { console.warn("URL update blocked"); }

      renderAll();
      if(!isInit) trackLead("Change Language");
    }

    function renderAll(){
      const t = TEXTS[lang];

      document.getElementById("l-cs").innerText = t.l_cs;
      document.getElementById("l-cs-desc").innerText = t.l_cs_desc;
      document.getElementById("l-wa").innerText = t.l_wa;
      document.getElementById("l-wa-desc").innerText = t.l_wa_desc;
      document.getElementById("l-store").innerText = t.l_store;
      document.getElementById("l-store-desc").innerText = t.l_store_desc;
      document.getElementById("l-franchise").innerText = t.l_franchise;
      document.getElementById("l-franchise-desc").innerText = t.l_franchise_desc;
      document.getElementById("l-gps-btn").innerText = t.l_gps_btn;
      document.getElementById("l-cta").innerText = t.l_cta;
      document.getElementById("l-bar-main").innerText = t.l_bar_main;

      renderBranchesGrid();
      initMap();
    }

    function generateScheduleHtml(schedule) {
      if (!schedule) return "";
      const t = TEXTS[lang];
      const days = ['sun', 'mon', 'tue', 'wed', 'thu', 'fri', 'sat'];

      const getTime = (d) => {
        const slots = schedule[d];
        if (!slots || !slots.length || (slots[0][0] === "00:00" && slots[0][1] === "00:00")) return null;
        return slots.map(s => `${s[0]} - ${s[1]}`).join(', ');
      };

      let groups = [];
      let currentGroup = null;

      days.forEach(day => {
        const time = getTime(day);
        const dayName = t.weekDays[day];

        if (currentGroup && currentGroup.time === time) {
          currentGroup.endDay = dayName;
        } else {
          if (currentGroup) groups.push(currentGroup);
          currentGroup = { startDay: dayName, endDay: dayName, time: time };
        }
      });
      if (currentGroup) groups.push(currentGroup);

      return groups.map(g => {
        const dayLabel = (g.startDay === g.endDay) ? g.startDay : `${g.startDay} - ${g.endDay}`;
        const timeLabel = g.time ? g.time : t.closedLabel;
        return `<div class="flex justify-between w-full"><span class="font-bold text-amber-500">${dayLabel}:</span> <span>${timeLabel}</span></div>`;
      }).join("");
    }

    function renderBranchesGrid(){
      const container = document.getElementById("branches-grid");
      const branches = BRANCH_DB.branches || [];
      const t = TEXTS[lang];

      container.innerHTML = branches.map(b => {
        const name = (lang === 'ar') ? b.name_ar : b.name_he;
        const isOpen = checkIsOpen(b.schedule);
        const statusClass = isOpen ? 'open' : 'closed';
        const statusText = isOpen ? t.open : t.closed;

        const socials = buildSocialButtons(b);

        const scheduleHtml = generateScheduleHtml(b.schedule);

        return `
          <div class="branch-card">
            <div class="branch-header">
              <div class="branch-title">${name}</div>
              <div class="status-pill ${statusClass}">
                <div class="dot"></div>
                <span>${statusText}</span>
              </div>
            </div>

            <div class="hours-text">
              ${scheduleHtml}
            </div>

            <div class="social-grid">
              ${socials}
            </div>
          </div>
        `;
      }).join("");

      if (window.lucide) lucide.createIcons();
    }

    function checkIsOpen(schedule){
      if(!schedule) return false;
      const now = new Date();
      const days = ["sun","mon","tue","wed","thu","fri","sat"];
      const currentDay = days[now.getDay()];
      const currentTime = now.getHours()*60 + now.getMinutes();

      const slots = schedule[currentDay] || [];
      let open = false;

      slots.forEach(slot => {
        const st = slot[0] || "00:00";
        const en = slot[1] || "00:00";
        const [sh, sm] = st.split(":").map(n=>parseInt(n,10));
        const [eh, em] = en.split(":").map(n=>parseInt(n,10));
        const startMins = (sh*60) + (sm||0);
        let endMins = (eh*60) + (em||0);
        if(String(en).startsWith("24")) endMins = 1440;
        if(currentTime >= startMins && currentTime < endMins) open = true;
      });
      return open;
    }

    /* ✅ UPDATED: add Offer link per branch (branch=ID) */
    function buildSocialButtons(b){
      const s = b.social || {};
      const t = TEXTS[lang];
      let html = "";
      const waPhone = normalizePhoneForWhatsApp(b.phone);

      const offerUrl = `https://www.mad-parfumeur.com/offer.html?branch=${encodeURIComponent(b.id)}`;
      html += `
        <a href="${offerUrl}" target="_blank" class="s-btn offer-btn"
           onclick="try{localStorage.setItem('lang','${lang}')}catch(e){}; trackLead('Open Offer Page');">
          <i class="fas fa-tags"></i> ${t.offerBtn}
        </a>
      `;

      if(waPhone){
        html += `<a href="https://wa.me/${waPhone}" target="_blank" class="s-btn wa-btn" onclick="trackLead('WhatsApp Branch')"><i class="fab fa-whatsapp"></i> WhatsApp</a>`;
      }

      const wazeUrl = s.waze || `https://waze.com/ul?ll=${b.lat},${b.lng}&navigate=yes`;
      html += `<a href="${wazeUrl}" target="_blank" class="s-btn waze-btn" onclick="trackLead('Waze Branch')"><i class="fab fa-waze"></i> Waze</a>`;

      if(b.phone){
        html += `<a href="tel:${b.phone}" class="s-btn" onclick="trackLead('Call Branch')"><i class="fas fa-phone"></i></a>`;
      }

      if(s.instagram) html += `<a href="${s.instagram}" target="_blank" class="s-btn" onclick="trackView('Instagram')"><i class="fab fa-instagram"></i></a>`;
      if(s.tiktok) html += `<a href="${s.tiktok}" target="_blank" class="s-btn" onclick="trackView('TikTok')"><i class="fab fa-tiktok"></i></a>`;
      if(s.facebook) html += `<a href="${s.facebook}" target="_blank" class="s-btn" onclick="trackView('Facebook')"><i class="fab fa-facebook-f"></i></a>`;
      if(s.youtube) html += `<a href="${s.youtube}" target="_blank" class="s-btn" onclick="trackView('YouTube')"><i class="fab fa-youtube"></i></a>`;
      if(s.snapchat) html += `<a href="${s.snapchat}" target="_blank" class="s-btn" onclick="trackView('Snapchat')"><i class="fab fa-snapchat"></i></a>`;

      return html;
    }

    function initMap() {
      if (map !== null) { map.remove(); }
      const defaultCenter = [32.0, 35.0];
      map = L.map('map').setView(defaultCenter, 8);

      L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
        attribution: '&copy; OpenStreetMap contributors'
      }).addTo(map);

      const branches = BRANCH_DB.branches || [];
      const t = TEXTS[lang];

      branches.forEach(b => {
        if (b.lat && b.lng) {
          const name = (lang === 'ar') ? b.name_ar : b.name_he;
          const wazeUrl = b.social && b.social.waze ? b.social.waze : `https://waze.com/ul?ll=${b.lat},${b.lng}&navigate=yes`;

          const marker = L.marker([b.lat, b.lng]).addTo(map);
          const popupContent = `
            <div>
              <h3 style="font-weight:900; margin-bottom:5px;">${name}</h3>
              <a href="${wazeUrl}" target="_blank" class="map-btn" onclick="trackLead('Waze Map')">
                <i class="fab fa-waze"></i> ${t.navWaze}
              </a>
            </div>
          `;
          marker.bindPopup(popupContent);
        }
      });
    }

    function requestLocation() {
      if (navigator.geolocation) {
        document.getElementById("l-gps-sub").innerText = (lang === 'ar' ? "جاري تحديد الموقع..." : "מאתר מיקום...");
        navigator.geolocation.getCurrentPosition(
          (position) => {
            const userLat = position.coords.latitude;
            const userLng = position.coords.longitude;

            const branches = BRANCH_DB.branches || [];
            branches.forEach(b => {
              if (b.lat && b.lng) {
                b.distance = getDistanceFromLatLonInKm(userLat, userLng, b.lat, b.lng);
              } else {
                b.distance = 99999;
              }
            });

            branches.sort((a, b) => a.distance - b.distance);

            renderBranchesGrid();

            if(map) {
              map.setView([userLat, userLng], 9);
              L.marker([userLat, userLng]).addTo(map).bindPopup(lang==='ar' ? "موقعك الحالي" : "המיקום שלך").openPopup();
            }

            document.getElementById("l-gps-sub").innerText = (lang === 'ar' ? "تم ترتيب الفروع حسب الأقرب إليك" : "הסניפים סודרו לפי הקרוב ביותר אליך");
            trackLead('GPS Location Used');
          },
          (error) => {
            console.error("Error getting location:", error);
            document.getElementById("l-gps-sub").innerText = (lang === 'ar' ? "تعذر تحديد الموقع. تأكد من تفعيل الـ GPS." : "לא ניתן לאתר מיקום. ודא שה-GPS פעיל.");
          }
        );
      } else {
        alert("Geolocation is not supported by this browser.");
      }
    }

    function getDistanceFromLatLonInKm(lat1, lon1, lat2, lon2) {
      var R = 6371;
      var dLat = deg2rad(lat2-lat1);
      var dLon = deg2rad(lon2-lon1);
      var a =
        Math.sin(dLat/2) * Math.sin(dLat/2) +
        Math.cos(deg2rad(lat1)) * Math.cos(deg2rad(lat2)) * Math.sin(dLon/2) * Math.sin(dLon/2)
        ;
      var c = 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1-a));
      var d = R * c;
      return d;
    }

    function deg2rad(deg) { return deg * (Math.PI/180) }

    function toggleOverlay(show) {
      const overlay = document.getElementById("trust-overlay");
      if (show) {
        overlay.style.display = "flex";
        trackView("Open Trust Overlay");
      } else {
        overlay.style.display = "none";
      }
    }

    init();
  </script>
</body>
</html>
