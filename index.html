<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>MAD PARFUMEUR</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/PapaParse/5.3.0/papaparse.min.js"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    
    <style>
        /* LUXURY DARK THEME */
        :root { --bg:#0f0f0f; --card:#1a1a1a; --gold:#d4af37; --text:#fff; --sub:#b0b0b0; }
        body { margin:0; font-family:'Segoe UI',sans-serif; background:var(--bg); color:var(--text); padding-bottom:50px; }
        
        /* HEADER */
        header { 
            background: #000; 
            padding: 0; 
            text-align: center; 
            border-bottom: 2px solid var(--gold); 
            position: sticky; top: 0; z-index: 900;
            box-shadow: 0 4px 20px rgba(0,0,0,0.5);
        }
        
        .header-link { display: block; width: 100%; height: 100%; }
        
        .header-banner {
            width: 100%;
            height: auto;
            max-width: 1200px;
            display: block;
            margin: 0 auto;
            object-fit: cover;
        }

        .container { max-width:1000px; margin:20px auto; padding:0 15px; }
        
        /* Elements */
        .btn-gold { border:1px solid var(--gold); color:var(--gold); padding:8px 20px; border-radius:50px; text-decoration:none; display:inline-flex; align-items:center; gap:8px; transition:0.2s; background:transparent; cursor:pointer; }
        .btn-gold:hover { background:var(--gold); color:#000; }
        
        .branch-hero { background:linear-gradient(145deg,#1a1a1a,#222); border:1px solid #333; border-top:3px solid var(--gold); border-radius:12px; padding:25px; text-align:center; margin-bottom:25px; }
        .branch-hero h2 { margin:0; font-size:1.8rem; }
        
        .social-bar { display:flex; justify-content:center; gap:12px; margin-top:20px; flex-wrap:wrap; }
        .social-btn { width:40px; height:40px; border-radius:50%; display:flex; align-items:center; justify-content:center; background:#2a2a2a; color:#aaa; border:1px solid #333; text-decoration:none; transition:0.2s; }
        .social-btn:hover { border-color:var(--gold); color:var(--gold); }
        
        /* Service Actions Area */
        .actions { 
            display:flex; justify-content:center; gap:10px; margin-top:20px; flex-wrap:wrap; 
            border-top: 1px solid #333; padding-top: 20px; /* فاصل جمالي */
        }
        
        .btn-svc { 
            background:#000; border:1px solid var(--gold); color:var(--gold); 
            padding:10px 15px; border-radius:6px; text-decoration:none; 
            font-weight:bold; display:flex; align-items:center; gap:8px; font-size:0.85rem; 
            transition: 0.3s;
        }
        .btn-svc:hover { background:var(--gold); color:#000; }

        .filters { display:flex; gap:10px; margin-bottom:20px; }
        .filters select { flex:1; padding:12px; background:#222; border:1px solid #444; color:#fff; border-radius:8px; outline:none; }

        /* Grid */
        .products-grid { display:grid; grid-template-columns:repeat(auto-fill,minmax(160px,1fr)); gap:15px; }
        .product-card { background:var(--card); border-radius:10px; overflow:hidden; border:1px solid #333; display:flex; flex-direction:column; }
        .p-img-box { width:100%; height:180px; background:#fff; display:flex; align-items:center; justify-content:center; padding:10px; box-sizing:border-box; }
        .p-img { max-width:100%; max-height:100%; object-fit:contain; }
        .p-info { padding:15px; text-align:center; flex-grow:1; display:flex; flex-direction:column; }
        .p-title { font-size:0.95rem; margin-bottom:5px; flex-grow:1; color:#eee; }
        .p-price { color:var(--gold); font-weight:bold; margin-bottom:10px; }
        .btn-ask { background:transparent; border:1px solid #444; color:#aaa; width:100%; padding:8px; border-radius:6px; text-decoration:none; display:flex; align-items:center; justify-content:center; gap:5px; font-size:0.85rem; transition:0.2s; }
        .btn-ask:hover { border-color:#25D366; color:#25D366; }

        .branch-item { display:flex; justify-content:space-between; align-items:center; background:var(--card); padding:18px; margin-bottom:12px; border-radius:8px; text-decoration:none; border-right:3px solid var(--gold); color:#fff; }
        .branch-item:hover { background:#252525; }

        .hidden { display:none!important; }
        #loader { position:fixed; inset:0; background:#000; z-index:2000; display:flex; flex-direction:column; align-items:center; justify-content:center; transition:opacity 0.3s; }
        .spinner { width:30px; height:30px; border:3px solid #333; border-top-color:var(--gold); border-radius:50%; animation:s 0.8s infinite linear; margin-bottom:15px; }
        @keyframes s { to { transform:rotate(360deg); } }
        
        .load-more-container { text-align:center; margin:30px 0; }
        .btn-more { background:var(--gold); color:#000; border:none; padding:12px 40px; border-radius:50px; font-weight:bold; cursor:pointer; }
    </style>
</head>
<body>

<header>
    <a href="?" class="header-link">
        <img src="https://madparfumeurglobal.com/wp-content/uploads/2024/09/1920x600-1.jpg" alt="MAD PARFUMEUR" class="header-banner">
    </a>
</header>

<div id="loader"><div class="spinner"></div><span style="color:#666;font-size:0.8rem">SYSTEM LOADING...</span></div>

<div class="container">
    <div id="list-view" class="hidden">
        <h3 style="text-align:center; color:var(--sub); font-weight:normal; margin-bottom:20px;">SELECT YOUR BOUTIQUE</h3>
        <div id="branches-list"></div>
    </div>

    <div id="detail-view" class="hidden">
        <button onclick="goHome()" class="btn-gold" style="margin-bottom:20px;"><i class="fas fa-arrow-right"></i> القائمة</button>

        <div class="branch-hero">
            <h2 id="b-name"></h2>
            <div id="b-name-he" style="color:var(--gold); margin-bottom:10px;"></div>
            <div style="color:#888; font-size:0.9rem"><i class="far fa-clock"></i> <span id="b-hours"></span></div>
            
            <div id="social-container" class="social-bar"></div>
            
            <div class="actions">
                <a href="tel:*9935" class="btn-svc">
                    <i class="fas fa-phone-alt"></i> *9935
                </a>
                <a href="mailto:info@madperfume.co.il" class="btn-svc">
                    <i class="fas fa-envelope"></i> Email
                </a>
                <a href="https://madperfume.co.il/" target="_blank" class="btn-svc">
                    <i class="fas fa-globe"></i> Web
                </a>
            </div>
        </div>

        <div class="filters">
            <select id="cat-select"><option value="">كل الفئات</option></select>
            <select id="sort-select"><option value="">ترتيب تلقائي</option><option value="asc">السعر: الأقل</option><option value="desc">السعر: الأعلى</option></select>
        </div>

        <div id="products-grid" class="products-grid"></div>
        
        <div id="load-more-area" class="load-more-container hidden">
            <button id="btn-load-more" class="btn-more">عرض المزيد</button>
        </div>
        
        <div id="fallback-area" class="load-more-container hidden">
             <p style="color:#777; margin-bottom:15px">انتهت منتجات هذا الفرع.</p>
             <button id="btn-show-global" class="btn-more" style="background:#333; color:#fff; border:1px solid #555">عرض باقي منتجات المتجر</button>
        </div>
    </div>
</div>

<script>
    // === AUTO LANGUAGE ===
    function detectLanguage() {
        const params = new URLSearchParams(window.location.search);
        if (params.get('lang')) return params.get('lang') === 'he' ? 'he' : 'ar';
        const browserLang = navigator.language || navigator.userLanguage;
        if (browserLang && browserLang.startsWith('he')) return 'he';
        return 'ar';
    }
    const LANG = detectLanguage();
    document.documentElement.lang = LANG;
    document.documentElement.dir = LANG === 'he' ? 'ltr' : 'rtl';

    // === CONFIG ===
    const URLS = { b: 'branches.csv', p: 'products.csv' };
    const VERSION = 'v4.2'; 
    const BATCH_SIZE = 24;

    let DATA = { b: [], p: [] };
    let VIEW = { list: [], renderedCount: 0, phone: '' };

    async function start() {
        const stored = localStorage.getItem('mad_data_' + VERSION);
        if(stored) {
            DATA = JSON.parse(stored);
            console.log('⚡ Loaded from Local Storage');
            finishLoad();
            return;
        }

        try {
            const [rb, rp] = await Promise.all([ fetchCSV(URLS.b), fetchCSV(URLS.p) ]);
            DATA = { b: rb, p: rp };
            localStorage.setItem('mad_data_' + VERSION, JSON.stringify(DATA));
            console.log('⬇ Loaded from Files');
            finishLoad();
        } catch(e) { 
            console.error(e); 
            document.getElementById('loader').innerHTML = '<p style="color:red">يرجى رفع ملفات branches.csv و products.csv</p>';
        }
    }

    function fetchCSV(u) {
        return new Promise((r, j) => Papa.parse(u, { 
            download:true, header:true, skipEmptyLines:true, transformHeader:h=>h.trim(), 
            complete:x=>r(x.data), error:e=>j(e) 
        }));
    }

    function finishLoad() {
        document.getElementById('loader').style.opacity = '0';
        setTimeout(() => document.getElementById('loader').classList.add('hidden'), 300);
        const p = new URLSearchParams(location.search);
        const id = p.get('id');
        if(id) showBranch(id); else showList();
    }

    // === VIEWS ===
    function showList() {
        document.getElementById('list-view').classList.remove('hidden');
        const box = document.getElementById('branches-list');
        box.innerHTML = '';
        DATA.b.forEach(b => {
            if(!b.ID) return;
            box.innerHTML += `
            <a href="?id=${b.ID}&lang=${LANG}" class="branch-item" onclick="nav(event, '${b.ID}')">
                <div>${b['اسم الفرع عربي']} <small style="color:#777;display:block;font-size:0.8rem">${b['اسم الفرع عبري']}</small></div>
                <i class="fas fa-chevron-${LANG==='he'?'right':'left'}" style="color:var(--gold)"></i>
            </a>`;
        });
    }

    function showBranch(id) {
        const b = DATA.b.find(x => x.ID == id);
        if(!b) { goHome(); return; }
        
        document.getElementById('detail-view').classList.remove('hidden');
        document.getElementById('b-name').innerText = b['اسم الفرع عربي'];
        document.getElementById('b-name-he').innerText = b['اسم الفرع عبري'];
        document.getElementById('b-hours').innerText = b['ساعات الدوام عربي']||b['ساعات الدوام عبري'];
        
        const soc = document.getElementById('social-container');
        soc.innerHTML = '';
        let ph = (b['الهاتف']||'').replace(/\D/g,'').replace(/^0/,'972');
        VIEW.phone = ph;
        
        const icon = (u,c) => { if(u && u.length>5) soc.innerHTML += `<a href="${u}" target="_blank" class="social-btn"><i class="${c}"></i></a>`; };
        icon(b['رابط Waze / Maps'], 'fas fa-location-arrow');
        icon(b['WhatsApp']||`https://wa.me/${ph}`, 'fab fa-whatsapp');
        icon(b['Instagram'], 'fab fa-instagram');
        icon(b['Facebook'], 'fab fa-facebook-f');
        icon(b['TikTok'], 'fab fa-tiktok');

        const specific = DATA.p.filter(x => x['Internal Label'] && x['Internal Label'].toString().includes(id));
        const fallbackArea = document.getElementById('fallback-area');
        const showGlobalBtn = document.getElementById('btn-show-global');

        if(specific.length > 0) {
            VIEW.list = specific;
            if(specific.length < 8) {
                fallbackArea.classList.remove('hidden');
                showGlobalBtn.onclick = () => {
                    VIEW.list = DATA.p.filter(x => x['Title']);
                    fallbackArea.classList.add('hidden');
                    updateFilters();
                }
            } else { fallbackArea.classList.add('hidden'); }
        } else {
            VIEW.list = DATA.p.filter(x => x['Title']);
            fallbackArea.classList.add('hidden');
        }
        updateFilters();
    }

    function updateFilters() {
        const sel = document.getElementById('cat-select');
        sel.innerHTML = '<option value="">' + (LANG==='he'?'כל הקטגוריות':'كل الفئات') + '</option>';
        const cats = [...new Set(VIEW.list.map(x => x['Category (g:product_type)']).filter(Boolean))];
        cats.forEach(c => sel.innerHTML += `<option>${c}</option>`);

        sel.onchange = applyFilter;
        document.getElementById('sort-select').onchange = applyFilter;
        applyFilter();
    }

    function applyFilter() {
        const cat = document.getElementById('cat-select').value;
        const sort = document.getElementById('sort-select').value;
        let final = VIEW.list.filter(x => !cat || x['Category (g:product_type)'] === cat);
        if(sort === 'asc') final.sort((a,b) => parseFloat(a.Price)-parseFloat(b.Price));
        if(sort === 'desc') final.sort((a,b) => parseFloat(b.Price)-parseFloat(a.Price));

        VIEW.activeList = final;
        VIEW.renderedCount = 0;
        document.getElementById('products-grid').innerHTML = '';
        document.getElementById('load-more-area').classList.add('hidden');
        renderBatch();
    }

    function renderBatch() {
        const grid = document.getElementById('products-grid');
        const total = VIEW.activeList.length;
        const next = Math.min(total, VIEW.renderedCount + BATCH_SIZE);
        
        if(total === 0) { grid.innerHTML = '<p style="grid-column:1/-1;text-align:center;color:#666">لا توجد منتجات</p>'; return; }

        for(let i = VIEW.renderedCount; i < next; i++) {
            const p = VIEW.activeList[i];
            const img = (p.Image||'').split('|')[0] || 'https://via.placeholder.com/200';
            const wa = `https://wa.me/${VIEW.phone}?text=${encodeURIComponent('مرحباً، هل العطر '+p.Title+' متوفر؟')}`;
            const btnTxt = LANG==='he' ? 'בדיקת זמינות' : 'هل متوفر؟';

            grid.innerHTML += `
            <div class="product-card">
                <div class="p-img-box"><img src="${img}" class="p-img" loading="lazy"></div>
                <div class="p-info">
                    <div class="p-title">${p.Title}</div>
                    <div class="p-price">${p.Price||''} ${LANG==='he'?'₪':'شيكل'}</div>
                    <a href="${wa}" target="_blank" class="btn-ask"><i class="fab fa-whatsapp"></i> ${btnTxt}</a>
                </div>
            </div>`;
        }
        VIEW.renderedCount = next;
        const loadBtn = document.getElementById('load-more-area');
        if(VIEW.renderedCount < total) {
            loadBtn.classList.remove('hidden');
            document.getElementById('btn-load-more').onclick = renderBatch;
        } else { loadBtn.classList.add('hidden'); }
    }

    window.nav = (e, id) => { e.preventDefault(); const u = `?id=${id}&lang=${LANG}`; history.pushState({path:u},'',u); document.getElementById('list-view').classList.add('hidden'); showBranch(id); };
    window.goHome = () => { const u = `?lang=${LANG}`; history.pushState({path:u},'',u); document.getElementById('detail-view').classList.add('hidden'); showList(); };
    window.onpopstate = () => { document.getElementById('detail-view').classList.add('hidden'); document.getElementById('list-view').classList.add('hidden'); const i = new URLSearchParams(location.search).get('id'); if(i) showBranch(i); else showList(); };

    start();
</script>
</body>
</html>
