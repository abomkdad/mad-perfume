<script>
// ================= روابط البيانات =================
const SHEET_BRANCHES = 'https://docs.google.com/spreadsheets/d/e/2PACX-1vQzL_F54ThIR-jtJoX9mU4gc6FPo2FzMWsvaPY9K9CDJ_qdHFf3VAqncUj51mEa3A/pub?output=csv';
const SHEET_PRODUCTS = 'https://docs.google.com/spreadsheets/d/e/2PACX-1vSEkstd7ZCKTNYZL_8TC2ofQ9Z91JJ2IM0awOPLgegDweraKayLGitwiLY7A382iQ/pub?output=csv';

// ================= إعدادات اللغة =================
function getLang() {
  const p = new URLSearchParams(location.search);
  return p.get('lang') === 'he' ? 'he' : 'ar';
}
const currentLang = getLang();
document.documentElement.lang = currentLang;
document.documentElement.dir = currentLang === 'he' ? 'ltr' : 'rtl';

const UI = {
  ar: { back: 'كل الفروع', buy: 'شراء', price: 'شيكل', loading: 'جاري التحميل...', noProducts: 'لا توجد منتجات متاحة حالياً' },
  he: { back: 'כל הסניפים', buy: 'לרכישה', price: '₪', loading: 'טוען...', noProducts: 'אין מוצרים זמינים כרגע' }
};

document.getElementById('backBtn').innerHTML = `<i class="fas fa-arrow-${currentLang==='he'?'left':'right'}"></i> ${UI[currentLang].back}`;
document.getElementById('loader').innerText = UI[currentLang].loading;

// ================= التشغيل الرئيسي =================
const urlParams = new URLSearchParams(window.location.search);
const branchId = urlParams.get('id');

if (branchId) {
  initBranchPage(branchId);
} else {
  initBranchesList();
}

// --------------------------------------------------
// دالة جلب البيانات (محسنة)
// --------------------------------------------------
function fetchCSV(url) {
  return new Promise((resolve) => {
    Papa.parse(url, {
      download: true,
      header: true,
      skipEmptyLines: true,
      // هذا السطر مهم جداً: يزيل المسافات الزائدة من عناوين الأعمدة
      transformHeader: function(h) { return h.trim(); }, 
      complete: (res) => {
        console.log(`Loaded ${res.data.length} rows from ${url}`); // للفحص
        resolve(res.data);
      },
      error: (err) => {
        console.error("CSV Error:", err);
        resolve([]); 
      }
    });
  });
}

// --------------------------------------------------
// صفحة قائمة الفروع
// --------------------------------------------------
function initBranchesList() {
  showLoader(true);
  fetchCSV(SHEET_BRANCHES).then(data => {
    showLoader(false);
    const container = document.getElementById('branchesContainer');
    container.innerHTML = '';
    
    data.forEach(branch => {
      if(!branch.ID) return;
      container.innerHTML += `
        <a href="?id=${branch.ID}&lang=${currentLang}" class="branch-list-item">
          <div style="font-weight:bold; font-size:1.1rem;">${branch['اسم الفرع عربي']}</div>
          <div style="color:#777;">${branch['اسم الفرع عبري']}</div>
        </a>`;
    });
  });
}

// --------------------------------------------------
// صفحة الفرع والمنتجات
// --------------------------------------------------
let allProducts = []; // متغير عام للمنتجات

function initBranchPage(id) {
  showLoader(true);
  document.getElementById('backBtn').classList.remove('hidden');

  Promise.all([
    fetchCSV(SHEET_BRANCHES),
    fetchCSV(SHEET_PRODUCTS)
  ]).then(([branchesData, productsData]) => {
    showLoader(false);
    
    // 1. عرض بيانات الفرع
    const branch = branchesData.find(b => b.ID == id);
    if (!branch) {
      alert("الفرع غير موجود (Branch not found)");
      window.location.href = "?";
      return;
    }
    renderBranchDetails(branch);

    // 2. تصفية المنتجات
    console.log("Total products before filter:", productsData.length);
    
    allProducts = productsData.filter(p => {
        // تأكد من وجود عنوان للمنتج (تجاوز الأسطر الفارغة)
        if (!p['Title']) return false;
        
        // تصفية حسب الفرع (إذا كان العمود موجوداً)
        // إذا كنت تريد إظهار كل المنتجات دائماً، قم بتعليق السطرين التاليين:
        const labels = p['Internal Label'] || '';
        if (labels && !labels.includes(id)) return false; 
        
        return true; 
    });

    console.log("Products after filter:", allProducts.length);

    if (allProducts.length === 0) {
       // في حال لم يظهر شيء، قد يكون بسبب التصفية، نعرض تنبيهاً في الكونسول
       console.warn("No products found for this branch ID. Check 'Internal Label' column.");
    }

    initFilters(allProducts);
    applyFilters(); // عرض المنتجات

    document.getElementById('singleBranchContainer').classList.remove('hidden');
  });
}

function renderBranchDetails(b) {
  document.getElementById('bNameAr').innerText = b['اسم الفرع عربي'];
  document.getElementById('bNameHe').innerText = b['اسم الفرع عبري'];
  document.getElementById('bHours').innerText = b['ساعات الدوام عربي'] || b['ساعات الدوام عبري'];
  document.getElementById('bPhone').innerText = b['الهاتف'];
  
  document.getElementById('linkWaze').href = b['رابط Waze / Maps'];
  
  let wa = b['WhatsApp'];
  if(!wa && b['الهاتف']) {
     const clean = b['الهاتف'].replace(/\D/g, '').replace(/^0/, '972');
     wa = `https://wa.me/${clean}`;
  }
  document.getElementById('linkWa').href = wa;
}

// --------------------------------------------------
// أدوات المتجر
// --------------------------------------------------
function initFilters(list) {
  const select = document.getElementById('selCategory');
  select.innerHTML = `<option value="">${currentLang==='he'?'כל הקטגוריות':'كل الفئات'}</option>`;
  
  // استخراج الفئات الفريدة
  const categories = [...new Set(list.map(p => p['Category (g:product_type)']).filter(Boolean))];
  
  categories.forEach(cat => {
    const opt = document.createElement('option');
    opt.value = cat;
    opt.innerText = cat;
    select.appendChild(opt);
  });

  document.getElementById('selCategory').onchange = applyFilters;
  document.getElementById('selSort').onchange = applyFilters;
}

function applyFilters() {
  const catVal = document.getElementById('selCategory').value;
  const sortVal = document.getElementById('selSort').value;

  let filtered = allProducts.filter(p => {
    if (catVal && p['Category (g:product_type)'] !== catVal) return false;
    return true;
  });

  if (sortVal === 'asc') {
    filtered.sort((a, b) => parseFloat(a['Price']) - parseFloat(b['Price']));
  } else if (sortVal === 'desc') {
    filtered.sort((a, b) => parseFloat(b['Price']) - parseFloat(a['Price']));
  }

  renderProducts(filtered);
}

function renderProducts(list) {
  const grid = document.getElementById('productsGrid');
  grid.innerHTML = '';

  if(list.length === 0) {
    grid.innerHTML = `<p style="grid-column:1/-1;text-align:center;padding:20px;">${UI[currentLang].noProducts}</p>`;
    return;
  }

  list.forEach(p => {
    let img = p['Image'];
    if(!img && p['Additional Images']) img = p['Additional Images'].split('|')[0].trim();
    if(!img) img = 'https://via.placeholder.com/200x200?text=No+Image';

    const html = `
      <div class="product-card">
        <div>
          <img src="${img}" class="product-img" loading="lazy">
          <div class="product-cat">${p['Category (g:product_type)'] || ''}</div>
          <div class="product-title">${p['Title']}</div>
          <div class="product-price">${p['Price']} ${UI[currentLang].price}</div>
        </div>
        <a href="${p['Product Link']}" target="_blank" class="btn btn-buy">
          ${UI[currentLang].buy} <i class="fas fa-shopping-bag"></i>
        </a>
      </div>
    `;
    grid.innerHTML += html;
  });
}

function showLoader(show) {
  const l = document.getElementById('loader');
  if(show) l.classList.remove('hidden');
  else l.classList.add('hidden');
}
</script>
