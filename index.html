<!DOCTYPE html>
<html lang="he" dir="rtl">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width,initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
  <title>MAD PARFUMEUR | Official Portal</title>
  <link href="https://fonts.googleapis.com/css2?family=Assistant:wght@400;700;800&family=Cairo:wght@400;700;900&display=swap" rel="stylesheet">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">

  <!-- =========================
       ✅ PIXELS (NO UI CHANGES)
       Meta + TikTok + Snap
  ========================== -->

  <!-- Meta Pixel Code -->
  <script>
    !function(f,b,e,v,n,t,s){
      if(f.fbq)return; n=f.fbq=function(){n.callMethod?
      n.callMethod.apply(n,arguments):n.queue.push(arguments)};
      if(!f._fbq)f._fbq=n; n.push=n; n.loaded=!0; n.version='2.0';
      n.queue=[]; t=b.createElement(e); t.async=!0;
      t.src=v; s=b.getElementsByTagName(e)[0];
      s.parentNode.insertBefore(t,s)
    }(window, document,'script','https://connect.facebook.net/en_US/fbevents.js');
    fbq('init', '1072283127290819');
    fbq('track', 'PageView');
  </script>
  <noscript>
    <img height="1" width="1" style="display:none"
      src="https://www.facebook.com/tr?id=1072283127290819&ev=PageView&noscript=1"/>
  </noscript>
  <!-- End Meta Pixel Code -->

  <!-- TikTok Pixel Code -->
  <script>
    !function (w, d, t) {
      w.TiktokAnalyticsObject = t;
      var ttq = w[t] = w[t] || [];
      ttq.methods = ["page","track","identify","instances","debug","on","off","once","ready","alias","group","enableCookie","disableCookie"];
      ttq.setAndDefer = function (t, e) { t[e] = function () { t.push([e].concat(Array.prototype.slice.call(arguments, 0))) } };
      for (var i = 0; i < ttq.methods.length; i++) ttq.setAndDefer(ttq, ttq.methods[i]);
      ttq.instance = function (t) {
        var e = ttq._i[t] || [];
        for (var n = 0; n < ttq.methods.length; n++) ttq.setAndDefer(e, ttq.methods[n]);
        return e
      };
      ttq.load = function (e, n) {
        var i = "https://analytics.tiktok.com/i18n/pixel/events.js";
        ttq._i = ttq._i || {};
        ttq._i[e] = [];
        ttq._i[e]._u = i;
        ttq._t = ttq._t || {};
        ttq._t[e] = +new Date;
        ttq._o = ttq._o || {};
        ttq._o[e] = n || {};
        var o = document.createElement("script");
        o.type = "text/javascript";
        o.async = !0;
        o.src = i + "?sdkid=" + e + "&lib=" + t;
        var a = document.getElementsByTagName("script")[0];
        a.parentNode.insertBefore(o, a)
      };
      ttq.load('D2D02JBC77U4ENLN9SBG');
      ttq.page();
    }(window, document, 'ttq');
  </script>
  <!-- End TikTok Pixel Code -->

  <!-- Snap Pixel Code -->
  <script type="text/javascript">
    (function(e,t,n){
      if(e.snaptr)return;
      var a=e.snaptr=function(){a.handleRequest?a.handleRequest.apply(a,arguments):a.queue.push(arguments)};
      a.queue=[];
      var s='script';
      var r=t.createElement(s); r.async=!0;
      r.src=n;
      var u=t.getElementsByTagName(s)[0];
      u.parentNode.insertBefore(r,u);
    })(window,document,'https://sc-static.net/scevent.min.js');

    snaptr('init', 'b143822e-1c3c-40ff-93f7-edadee74e626');
    snaptr('track', 'PAGE_VIEW');
  </script>
  <noscript>
    <img height="1" width="1" style="display:none;" alt=""
      src="https://tr.snapchat.com/v2/pixel?id=b143822e-1c3c-40ff-93f7-edadee74e626&ev=PAGE_VIEW&noscript=1" />
  </noscript>
  <!-- End Snap Pixel Code -->

  <style>
    :root {
      --gold: #d4af37; --dark-bg: #0a0a0a; --card-bg: #161616;
      --wa-green: #25D366; --waze-blue: #33CCFF; --text-main: #ffffff; --btn-gray: #333333;
    }
    * { box-sizing: border-box; margin: 0; padding: 0; }
    body { background-color: var(--dark-bg); color: var(--text-main); font-family: 'Assistant', 'Cairo', sans-serif; direction: rtl; padding-bottom: 120px; }

    header {
      background: linear-gradient(rgba(0,0,0,0.8), rgba(0,0,0,0.9)),
        url('https://madparfumeurglobal.com/wp-content/uploads/2025/10/1920x600-BERGAY.jpg') center/cover;
      padding: 30px 15px 40px; text-align: center; border-bottom: 2px solid var(--gold);
    }
    .logo img { width: 80px; margin-bottom: 10px; }
    .brand-name { font-size: 20px; font-weight: 900; margin-bottom: 15px; color: var(--gold); }

    .online-store-float {
      position: fixed; top: 20px; left: 20px; z-index: 1001;
      background: var(--gold); color: #000; padding: 10px 15px;
      border-radius: 50px; text-decoration: none; font-weight: 900;
      font-size: 13px; display: flex; align-items: center; gap: 8px;
      box-shadow: 0 4px 15px rgba(0,0,0,0.5); border: 2px solid #000;
    }

    .action-grid { display: grid; grid-template-columns: 1fr 1fr 1fr; gap: 10px; max-width: 650px; margin: 0 auto; }
    .action-item {
      background: var(--btn-gray); border: 1px solid rgba(212,175,55,0.4);
      padding: 12px 5px; border-radius: 15px; text-decoration: none; color: white;
      display: flex; flex-direction: column; align-items: center; justify-content: center;
    }
    .action-item i { font-size: 18px; color: var(--gold); margin-bottom: 6px; }
    .action-item span { font-size: 11px; font-weight: 900; }
    .action-item .hotline { font-size: 10px; color: var(--gold); font-weight: 900; }

    .container { max-width: 800px; margin: -25px auto 50px; padding: 0 15px; }

    .gps-trigger {
      background: var(--gold); color: #000; border: none; padding: 12px 20px;
      border-radius: 30px; font-weight: 900; font-size: 14px; cursor: pointer;
      display: flex; align-items: center; justify-content: center; gap: 10px;
      margin: 0 auto 25px; box-shadow: 0 6px 20px rgba(212,175,55,0.4);
    }

    .branch-card {
      background: var(--card-bg); border-radius: 20px; padding: 20px;
      margin-bottom: 15px; border-right: 5px solid var(--gold);
      box-shadow: 0 10px 30px rgba(0,0,0,0.5);
    }
    .br-header { display: flex; justify-content: space-between; align-items: flex-start; margin-bottom: 15px; }
    .br-title { font-size: 18px; font-weight: 800; color: var(--gold); }
    .status-pill { font-size: 10px; padding: 4px 10px; border-radius: 20px; font-weight: 800; border: 1px solid; }
    .distance-tag { font-size: 10px; color: var(--gold); margin-top: 4px; display: block; }

    .btn-group { display: grid; grid-template-columns: 1fr 1fr 1fr; gap: 8px; }
    .btn { padding: 10px 5px; border-radius: 10px; text-decoration: none; color: white; font-weight: 800; font-size: 11px; text-align: center; display: flex; flex-direction: column; align-items: center; gap: 4px; }
    .bg-wa { background: var(--wa-green); }
    .bg-waze { background: var(--waze-blue); color: #000; }
    .bg-enter { background: var(--btn-gray); }

    .trust-bar {
      position: fixed; bottom: 15px; left: 50%; transform: translateX(-50%);
      width: 95%; max-width: 800px; background: #2a2a2a; border-radius: 50px;
      padding: 10px 20px; display: flex; justify-content: space-between; align-items: center;
      z-index: 999; border: 1px solid rgba(212,175,55,0.3); box-shadow: 0 10px 40px rgba(0,0,0,0.9);
      cursor: pointer;
    }

    #trust-overlay {
      display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%;
      background: #000; z-index: 10000; flex-direction: column;
    }
    .overlay-close {
      position: absolute; top: 20px; right: 20px; background: var(--gold); color: #000;
      padding: 10px 20px; border-radius: 30px; font-weight: 900; cursor: pointer; border: none; z-index: 10001;
    }
    .overlay-content { width: 100%; height: 100%; padding-top: 70px; }
    .overlay-content iframe { width: 100%; height: 100%; border: none; background: white; }
  </style>
</head>

<body>

  <a href="https://madperfume.co.il/" target="_blank" class="online-store-float" id="storeFloat">
    <i class="fas fa-shopping-cart"></i>
    <span id="l-store-btn"></span>
  </a>

  <header>
    <div class="logo"><img src="https://abomkdad.github.io/Digital-Business-Card/logo.png"></div>
    <div class="brand-name">MAD PARFUMEUR ISRAEL</div>
    <div class="action-grid">
      <a href="tel:*9935" class="action-item" id="csBtn">
        <i class="fas fa-phone-alt"></i>
        <span id="l-cs"></span>
        <div class="hotline">*9935</div>
      </a>
      <a id="wa-corp-btn" href="#" class="action-item">
        <i class="fab fa-whatsapp"></i>
        <span id="l-wa"></span>
        <div class="hotline">050-978-7730</div>
      </a>
      <a href="https://www.mad-parfumeur.com/frangaize.html" target="_blank" class="action-item" id="agentBtn">
        <i class="fas fa-certificate"></i>
        <span id="l-agent"></span>
        <div class="hotline">Official Agent</div>
      </a>
    </div>
  </header>

  <div class="container">
    <button class="gps-trigger" onclick="requestLocation()">
      <i class="fas fa-location-arrow"></i>
      <span id="l-gps-btn"></span>
    </button>
    <div id="branchesList">...</div>
  </div>

  <div class="trust-bar" id="trustBar" onclick="toggleOverlay(true)">
    <div class="btn bg-wa" style="padding: 5px 12px; font-size:10px; flex-direction: row; gap:5px; height: auto;">
      <span id="l-cta"></span> <i class="fas fa-chevron-left"></i>
    </div>
    <div style="text-align: right;">
      <div style="color:var(--gold); font-size:12px;">★★★★★</div>
      <div id="l-bar-main" style="font-size: 11px; font-weight: 900; color: var(--gold);"></div>
    </div>
  </div>

  <div id="trust-overlay">
    <button class="overlay-close" onclick="toggleOverlay(false)" id="l-close"></button>
    <div class="overlay-content">
      <iframe src="https://www.mad-parfumeur.com/ifra.html"></iframe>
    </div>
  </div>

  <script>
    /* =========================
       ✅ SAFE DOM SETTERS
    ========================== */
    const $id = (id) => document.getElementById(id);
    function setText(id, value) { const el = $id(id); if (el) el.textContent = value; }
    function setHref(id, value) { const el = $id(id); if (el) el.href = value; }

    const userLang = (navigator.language || '').startsWith("he") ? "he" : "ar";
    const t = ({
      ar: {
        cs: "خدمة الزبائن", wa: "واتساب الشركة", agent: "وكيل معتمد", store: "المتجر أونلاين",
        gps_btn: "تحديد الفرع الأقرب لي", bar_main: "عطور أصلية بمعايير عالمية", cta: "اكتشف الفرق",
        open: "مفتوح الآن", closed: "مغلق حالياً", enter: "دخول الفرع", wa_btn: "واتساب",
        dist: "على بعد {d} كم", wa_msg: "مرحباً MAD، أريد الاستفسار عن عطوركم.", close: "إغلاق ✕"
      },
      he: {
        cs: "שירות לקוחות", wa: "וואטסאפ חברה", agent: "משווק מורשה", store: "חנות אונליין",
        gps_btn: "מצא את הסניף הקרוב אלי", bar_main: "בשמים מקוריים בסטנדרט עולמי", cta: "גלה את ההבדל",
        open: "פתוח עכשיו", closed: "סגור כעת", enter: "כניסה לסניף", wa_btn: "וואטסאפ",
        dist: "במרחק {d} ק\"מ", wa_msg: "שלום MAD، אני מעוניין לקבל פרטים על הבשמים שלכם.", close: "סגור ✕"
      }
    })[userLang];

    setText('l-cs', t.cs);
    setText('l-wa', t.wa);
    setText('l-agent', t.agent);
    setText('l-store-btn', t.store);
    setText('l-gps-btn', t.gps_btn);
    setText('l-bar-main', t.bar_main);
    setText('l-cta', t.cta);
    setText('l-close', t.close);

    setHref('wa-corp-btn', `https://wa.me/972509787730?text=${encodeURIComponent(t.wa_msg)}`);

    /* =========================
       ✅ PRECISE TRACKING MAP
       فتح الصفحة: (already) PageView + ttq.page + PAGE_VIEW
       مشاهدة: Meta ViewContent / TikTok ViewContent / Snap VIEW_CONTENT
       ليد:   Meta Lead / TikTok Lead / Snap SIGN_UP
    ========================== */

    function eid() {
      return 'e' + Date.now().toString(36) + Math.random().toString(36).slice(2,8);
    }

    function trackView(action, extra = {}) {
      const eventID = eid();
      const payload = Object.assign({
        action,
        lang: userLang,
        page: location.pathname,
        url: location.href
      }, extra || {});

      // Meta: ViewContent
      try { if (typeof fbq === 'function') fbq('track', 'ViewContent', payload, { eventID }); } catch(e) {}

      // TikTok: ViewContent
      try { if (typeof ttq !== 'undefined' && ttq && typeof ttq.track === 'function') ttq.track('ViewContent', payload); } catch(e) {}

      // Snap: VIEW_CONTENT
      try { if (typeof snaptr === 'function') snaptr('track', 'VIEW_CONTENT', payload); } catch(e) {}
    }

    function trackLead(action, extra = {}) {
      const eventID = eid();
      const payload = Object.assign({
        action,
        lang: userLang,
        page: location.pathname,
        url: location.href
      }, extra || {});

      // Meta: Lead
      try { if (typeof fbq === 'function') fbq('track', 'Lead', payload, { eventID }); } catch(e) {}

      // TikTok: Lead
      try { if (typeof ttq !== 'undefined' && ttq && typeof ttq.track === 'function') ttq.track('Lead', payload); } catch(e) {}

      // Snap: SIGN_UP (lead-like)
      try { if (typeof snaptr === 'function') snaptr('track', 'SIGN_UP', payload); } catch(e) {}
    }

    // ✅ Page open (فتح الصفحة) is already tracked by pixels (PageView/page/PAGE_VIEW)
    // If you also want "view_portal" as ViewContent, uncomment next line:
    // trackView('view_portal');

    /* =========================
       ✅ Click Tracking (exact per your list)
    ========================== */
    document.addEventListener('click', function(e) {
      const a = e.target.closest('a');
      if (!a) return;

      const href = (a.getAttribute('href') || '').trim();

      // Detect branch name (if clicked inside a branch card)
      let branchName = '';
      const card = a.closest('.branch-card');
      if (card) {
        const title = card.querySelector('.br-title');
        branchName = title ? title.textContent.trim() : '';
      }

      // 1) مشاهدة متجر اونلاين
      if (a.id === 'storeFloat' || a.classList.contains('online-store-float')) {
        trackView('view_store', { href });
        return;
      }

      // 2) مشاهدة وكيل معتمد
      if (a.id === 'agentBtn' || href.includes('/frangaize.html')) {
        trackView('view_official_agent', { href });
        return;
      }

      // 3) خدمة الزباين = ليد
      if (a.id === 'csBtn' || href.startsWith('tel:')) {
        trackLead('lead_customer_service', { href });
        return;
      }

      // 4) واتساب الشركة = ليد
      if (a.id === 'wa-corp-btn') {
        trackLead('lead_whatsapp_company', { href });
        return;
      }

      // Branch dynamic buttons
      const isBranchWA = a.classList.contains('bg-wa') && href.includes('wa.me');
      const isWaze = a.classList.contains('bg-waze');
      const isEnter = a.classList.contains('bg-enter');

      // 5) واتساب الفرع = ليد
      if (isBranchWA) {
        trackLead('lead_whatsapp_branch', { href, branch: branchName });
        return;
      }

      // 6) ويز = ليد
      if (isWaze) {
        trackLead('lead_waze', { href, branch: branchName });
        return;
      }

      // 7) دخول الفرع = مشاهدة
      if (isEnter) {
        trackView('view_enter_branch', { href, branch: branchName });
        return;
      }
    }, true);

    /* =========================
       ✅ Branch loading (same as before)
    ========================== */
    let allBranches = [];

    async function fetchBranchesJson() {
      const candidates = [
        `branches.json?v=${Date.now()}`,
        `/branches.json?v=${Date.now()}`
      ];
      for (const url of candidates) {
        try {
          const res = await fetch(url, { cache: 'no-store' });
          if (!res.ok) continue;
          const data = await res.json();
          return { data, used: url };
        } catch (e) {}
      }
      throw new Error('branches.json not found');
    }

    async function loadInitial() {
      try {
        const container = $id('branchesList');
        if (container) container.innerHTML = '...';

        const out = await fetchBranchesJson();
        const data = out.data;

        const branches = Array.isArray(data) ? data : (data && data.branches ? data.branches : []);
        allBranches = branches;

        render(allBranches);
      } catch(e) {
        console.error(e);
      }
    }

    function requestLocation() {
      if (navigator.geolocation) {
        navigator.geolocation.getCurrentPosition(
          pos => {
            const uLat = pos.coords.latitude, uLng = pos.coords.longitude;
            allBranches.forEach(b => {
              if (typeof b.lat !== 'number' || typeof b.lng !== 'number') return;
              const dLat = (b.lat-uLat)*Math.PI/180, dLon = (b.lng-uLng)*Math.PI/180;
              const a = Math.sin(dLat/2)**2 + Math.cos(uLat*Math.PI/180)*Math.cos(b.lat*Math.PI/180)*Math.sin(dLon/2)**2;
              b.dist = 6371 * (2 * Math.atan2(Math.sqrt(a), Math.sqrt(1-a)));
            });
            allBranches.sort((a,b) => (a.dist ?? 1e9) - (b.dist ?? 1e9));
            render(allBranches);
          },
          err => console.error(err),
          { enableHighAccuracy: true, timeout: 8000, maximumAge: 0 }
        );
      }
    }

    function render(list) {
      const container = $id('branchesList');
      if (!container) return;
      container.innerHTML = '';

      (list || []).forEach(b => {
        const isOpen = isBranchOpen(b);
        const distHtml = b.dist ? `<span class="distance-tag">${t.dist.replace('{d}', b.dist.toFixed(1))}</span>` : '';

        const name = b && b[`name_${userLang}`] ? b[`name_${userLang}`] : (b && b.name ? b.name : '');
        const phone = (b && b.phone ? String(b.phone) : '').replace(/\D/g, '');
        const waze = b && b.social && b.social.waze ? b.social.waze : '#';
        const id = b && (b.id ?? '') !== '' ? b.id : '';

        const card = document.createElement('div');
        card.className = 'branch-card';
        card.innerHTML = `
          <div class="br-header">
            <div>
              <div class="br-title">${name}</div>
              ${distHtml}
            </div>
            <div class="status-pill" style="border-color:${isOpen ? 'var(--wa-green)' : '#ff4d4d'}; color:${isOpen ? 'var(--wa-green)' : '#ff4d4d'}">
              ● ${isOpen ? t.open : t.closed}
            </div>
          </div>
          <div class="btn-group">
            <a href="https://wa.me/${phone}?text=${encodeURIComponent(t.wa_msg)}" class="btn bg-wa"><i class="fab fa-whatsapp"></i>${t.wa_btn}</a>
            <a href="${waze}" target="_blank" class="btn bg-waze"><i class="fab fa-waze"></i>Waze</a>
            <a href="offer.html?branch=${encodeURIComponent(id)}" class="btn bg-enter"><i class="fas fa-gift"></i>${t.enter}</a>
          </div>
        `;
        container.appendChild(card);
      });
    }

    function isBranchOpen(b) {
      const now = new Date();
      const days = ['sun', 'mon', 'tue', 'wed', 'thu', 'fri', 'sat'];
      const day = days[now.getDay()];
      const current = now.getHours() * 60 + now.getMinutes();
      if (!b || !b.schedule || !b.schedule[day]) return false;

      return b.schedule[day].some(r => {
        const [sH, sM] = r[0].split(':').map(Number);
        const [eH, eM] = r[1].split(':').map(Number);
        return current >= (sH*60+sM) && current < (eH*60+eM);
      });
    }

    function toggleOverlay(show) {
      const ov = $id('trust-overlay');
      if (!ov) return;
      ov.style.display = show ? 'flex' : 'none';
      document.body.style.overflow = show ? 'hidden' : 'auto';
    }

    loadInitial();
  </script>

</body>
</html>
