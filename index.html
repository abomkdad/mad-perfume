<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>MAD PARFUMEUR - Luxury Store</title>
    
    <script src="https://cdnjs.cloudflare.com/ajax/libs/PapaParse/5.3.0/papaparse.min.js"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    
    <style>
        /* ================= LUXURY DARK THEME ================= */
        :root { 
            --bg-color: #121212;
            --card-bg: #1e1e1e;
            --gold: #d4af37;
            --gold-light: #f3e5ab;
            --text-main: #ffffff;
            --text-sub: #b0b0b0;
            --wa-green: #25D366;
            --waze-blue: #33ccff;
        }
        
        body { 
            margin: 0; 
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; 
            background-color: var(--bg-color); 
            color: var(--text-main); 
            padding-bottom: 80px; 
        }
        
        /* Header Fakhama */
        header { 
            background: #000; 
            border-bottom: 2px solid var(--gold);
            padding: 20px; 
            text-align: center; 
            position: sticky; 
            top: 0; 
            z-index: 1000; 
            box-shadow: 0 4px 30px rgba(0,0,0,0.5); 
        }
        header h1 { 
            margin: 0; 
            font-size: 1.6rem; 
            letter-spacing: 3px; 
            color: var(--gold); 
            text-transform: uppercase; 
            font-weight: 300;
        }

        .container { max-width: 1000px; margin: 30px auto; padding: 0 15px; }
        
        /* General Buttons - Gold Style */
        .btn-gold-outline {
            display: inline-flex; align-items: center; justify-content: center; gap: 8px;
            background: transparent; border: 1px solid var(--gold); color: var(--gold);
            padding: 10px 20px; border-radius: 50px; text-decoration: none;
            transition: 0.3s; font-size: 0.9rem; margin-bottom: 20px;
        }
        .btn-gold-outline:hover { background: var(--gold); color: #000; }

        /* Branch Hero Section */
        .branch-hero {
            background: linear-gradient(145deg, #1a1a1a, #222);
            border: 1px solid #333;
            border-top: 4px solid var(--gold);
            border-radius: 15px;
            padding: 30px 20px;
            text-align: center;
            margin-bottom: 30px;
            box-shadow: 0 10px 40px rgba(0,0,0,0.4);
            position: relative;
        }
        .branch-hero h2 { margin: 0; font-size: 2rem; color: var(--text-main); font-weight: 400; }
        .branch-hero .he-name { color: var(--gold); font-size: 1rem; margin-bottom: 15px; letter-spacing: 1px; }
        
        /* Social Icons - Minimalist Luxury */
        .social-bar {
            display: flex; justify-content: center; gap: 15px; margin-top: 25px; flex-wrap: wrap;
        }
        .social-btn {
            width: 45px; height: 45px; border-radius: 50%;
            display: flex; align-items: center; justify-content: center;
            font-size: 1.2rem; text-decoration: none;
            background: #333; color: var(--text-sub);
            border: 1px solid #444; transition: 0.3s;
        }
        .social-btn:hover { border-color: var(--gold); color: var(--gold); transform: translateY(-3px); }
        
        /* Service Buttons (*9935 & Site) */
        .service-actions {
            display: flex; justify-content: center; gap: 15px; margin-top: 25px; flex-wrap: wrap;
        }
        .btn-service {
            background: #000; border: 1px solid var(--gold); color: var(--gold);
            padding: 12px 25px; border-radius: 8px; text-decoration: none;
            font-weight: bold; display: flex; align-items: center; gap: 10px;
            transition: 0.3s;
        }
        .btn-service:hover { background: var(--gold); color: #000; }

        /* Filters */
        .filters { display: flex; gap: 15px; margin-bottom: 25px; }
        .filters select { 
            flex: 1; padding: 12px; background: #222; 
            border: 1px solid #444; color: var(--text-main); 
            border-radius: 8px; outline: none;
        }

        /* Products Grid */
        .products-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(170px, 1fr)); gap: 20px; }
        .product-card { 
            background: var(--card-bg); border-radius: 12px; overflow: hidden; 
            box-shadow: 0 5px 15px rgba(0,0,0,0.3); transition: 0.3s;
            display: flex; flex-direction: column; border: 1px solid #333;
        }
        .product-card:hover { transform: translateY(-5px); border-color: var(--gold); }
        
        .p-img-container {
            width: 100%; height: 200px; background: #fff; /* الصور تحتاج خلفية بيضاء لتبدو نظيفة */
            display: flex; align-items: center; justify-content: center; padding: 10px;
        }
        .p-img { max-width: 100%; max-height: 100%; object-fit: contain; }

        .p-info { padding: 15px; text-align: center; flex-grow: 1; display: flex; flex-direction: column; }
        .p-title { font-size: 1rem; color: #fff; margin-bottom: 5px; font-weight: normal; flex-grow: 1; }
        .p-price { color: var(--gold); font-size: 1.1rem; font-weight: bold; margin-bottom: 15px; }

        .btn-ask {
            background: transparent; border: 1px solid #444; color: #aaa;
            width: 100%; padding: 10px; border-radius: 6px; text-decoration: none;
            display: flex; align-items: center; justify-content: center; gap: 8px;
            transition: 0.3s; font-size: 0.9rem;
        }
        .btn-ask:hover { border-color: var(--wa-green); color: var(--wa-green); background: rgba(37, 211, 102, 0.05); }

        /* List View (Home) */
        .branch-item {
            display: block; background: var(--card-bg); padding: 20px; margin-bottom: 15px;
            border-radius: 10px; text-decoration: none; border-right: 4px solid var(--gold);
            display: flex; justify-content: space-between; align-items: center;
            transition: 0.3s;
        }
        .branch-item:hover { background: #252525; }
        .branch-item div { color: #fff; font-size: 1.1rem; }
        .branch-item small { color: #777; display: block; margin-top: 5px; }

        /* Loader */
        #loader { position: fixed; inset: 0; background: #000; z-index: 2000; display: flex; align-items: center; justify-content: center; color: var(--gold); flex-direction: column; }
        .spinner { width: 40px; height: 40px; border: 3px solid #333; border-top: 3px solid var(--gold); border-radius: 50%; animation: spin 1s infinite linear; margin-bottom: 15px; }
        @keyframes spin { 100% { transform: rotate(360deg); } }
        .hidden { display: none !important; }

        /* Toggle Button */
        .show-all-btn-container { text-align: center; margin: 20px 0; }
        .btn-show-all { background: var(--gold); color: #000; padding: 10px 30px; border-radius: 50px; font-weight: bold; border: none; cursor: pointer; }
    </style>
</head>
<body>

    <header><h1>MAD PARFUMEUR</h1></header>
    
    <div id="loader">
        <div class="spinner"></div>
        <span>LOADING...</span>
    </div>

    <div class="container">
        
        <div id="list-view" class="hidden">
            <h3 style="text-align:center; color:var(--text-sub); margin-bottom:30px;">SELECT YOUR BOUTIQUE</h3>
            <div id="branches-list"></div>
        </div>

        <div id="detail-view" class="hidden">
            <a href="?lang=ar" class="btn-gold-outline">
                <i class="fas fa-arrow-right"></i> قائمة الفروع
            </a>

            <div class="branch-hero">
                <h2 id="b-name"></h2>
                <div id="b-name-he" class="he-name"></div>
                <div style="color:#888; margin-bottom:20px;">
                    <i class="far fa-clock"></i> <span id="b-hours"></span>
                </div>

                <div id="social-container" class="social-bar"></div>

                <div class="service-actions">
                    <a href="tel:*9935" class="btn-service">
                        <i class="fas fa-headset"></i> خدمة الزبائن *9935
                    </a>
                    <a href="https://madperfume.co.il/" target="_blank" class="btn-service">
                        <i class="fas fa-globe"></i> الموقع الرسمي
                    </a>
                </div>
            </div>

            <div class="filters">
                <select id="cat-select"><option value="">كل الفئات (All Collections)</option></select>
                <select id="sort-select">
                    <option value="">ترتيب تلقائي</option>
                    <option value="asc">السعر: من الأقل للأعلى</option>
                    <option value="desc">السعر: من الأعلى للأقل</option>
                </select>
            </div>

            <div id="products-grid" class="products-grid"></div>

            <div id="show-all-container" class="show-all-btn-container hidden">
                <button id="btn-show-all" class="btn-show-all">عرض باقي منتجات المتجر</button>
            </div>
        </div>

    </div>

<script>
    // ================= SETUP =================
    const URL_BRANCHES = 'https://docs.google.com/spreadsheets/d/e/2PACX-1vQzL_F54ThIR-jtJoX9mU4gc6FPo2FzMWsvaPY9K9CDJ_qdHFf3VAqncUj51mEa3A/pub?output=csv';
    const URL_PRODUCTS = 'https://docs.google.com/spreadsheets/d/e/2PACX-1vSEkstd7ZCKTNYZL_8TC2ofQ9Z91JJ2IM0awOPLgegDweraKayLGitwiLY7A382iQ/pub?output=csv';

    const p = new URLSearchParams(location.search);
    const LANG = p.get('lang') === 'he' ? 'he' : 'ar';
    document.documentElement.lang = LANG;
    document.documentElement.dir = LANG === 'he' ? 'ltr' : 'rtl';

    let allProductsData = [];
    let currentDisplayedProducts = [];
    let currentBranchPhone = '';

    // ================= LOAD DATA =================
    function loadCSV(url) {
        return new Promise(resolve => {
            Papa.parse(url, {
                download: true, header: true, skipEmptyLines: true, transformHeader: h => h.trim(),
                complete: res => resolve(res.data), error: () => resolve([])
            });
        });
    }

    Promise.all([loadCSV(URL_BRANCHES), loadCSV(URL_PRODUCTS)]).then(([branches, products]) => {
        document.getElementById('loader').classList.add('hidden');
        allProductsData = products;
        
        const branchId = p.get('id');
        if(branchId) showBranch(branchId, branches);
        else showList(branches);
    });

    // ================= RENDER LIST =================
    function showList(branches) {
        document.getElementById('list-view').classList.remove('hidden');
        const container = document.getElementById('branches-list');
        branches.forEach(b => {
            if(!b.ID) return;
            container.innerHTML += `
            <a href="?id=${b.ID}&lang=${LANG}" class="branch-item">
                <div>${b['اسم الفرع عربي']} <small>${b['اسم الفرع عبري']}</small></div>
                <i class="fas fa-chevron-${LANG==='he'?'right':'left'}" style="color:var(--gold)"></i>
            </a>`;
        });
    }

    // ================= RENDER BRANCH =================
    function showBranch(id, branches) {
        const b = branches.find(x => x.ID == id);
        if(!b) return location.href = '?';

        document.getElementById('detail-view').classList.remove('hidden');
        
        // Info
        document.getElementById('b-name').innerText = b['اسم الفرع عربي'];
        document.getElementById('b-name-he').innerText = b['اسم الفرع عبري'];
        document.getElementById('b-hours').innerText = b['ساعات الدوام عربي'] || b['ساعات الدوام عبري'];

        // Social Icons
        const soc = document.getElementById('social-container');
        let cleanPhone = (b['الهاتف'] || '').replace(/\D/g,'').replace(/^0/,'972');
        currentBranchPhone = cleanPhone;

        const addIcon = (url, icon) => {
            if(url && url.length > 5) soc.innerHTML += `<a href="${url}" target="_blank" class="social-btn"><i class="${icon}"></i></a>`;
        };
        addIcon(b['رابط Waze / Maps'], 'fas fa-location-arrow'); // Waze
        addIcon(b['WhatsApp'] || `https://wa.me/${cleanPhone}`, 'fab fa-whatsapp'); // WA
        addIcon(b['Instagram'], 'fab fa-instagram');
        addIcon(b['Facebook'], 'fab fa-facebook-f');
        addIcon(b['TikTok'], 'fab fa-tiktok');

        // === SMART FILTER LOGIC (Fixing Tiberias) ===
        // 1. Get Branch Specific Products
        let branchSpecific = allProductsData.filter(p => {
            if(!p['Title']) return false;
            const label = p['Internal Label'];
            return label && label.toString().includes(id.toString());
        });

        // 2. Decide what to show
        let showAllBtn = document.getElementById('show-all-container');
        
        if (branchSpecific.length === 0) {
            // No specific products -> Show ALL
            currentDisplayedProducts = allProductsData.filter(p => p['Title']);
            showAllBtn.classList.add('hidden');
        } else if (branchSpecific.length < 10) {
            // Few specific products (Like Tiberias) -> Show Specific + "Show All" Button
            currentDisplayedProducts = branchSpecific;
            showAllBtn.classList.remove('hidden');
            
            // Activate button to merge all
            document.getElementById('btn-show-all').onclick = function() {
                currentDisplayedProducts = allProductsData.filter(p => p['Title']);
                showAllBtn.classList.add('hidden');
                updateFiltersAndRender();
            };
        } else {
            // Many specific products -> Just show them
            currentDisplayedProducts = branchSpecific;
            showAllBtn.classList.add('hidden');
        }

        updateFiltersAndRender();
    }

    function updateFiltersAndRender() {
        // Update Categories based on current list
        const catSelect = document.getElementById('cat-select');
        catSelect.innerHTML = '<option value="">كل الفئات (All Collections)</option>';
        
        const cats = [...new Set(currentDisplayedProducts.map(p => p['Category (g:product_type)']).filter(Boolean))];
        cats.forEach(c => {
            const opt = document.createElement('option');
            opt.value = c; opt.innerText = c;
            catSelect.appendChild(opt);
        });

        // Render
        renderProducts();
        
        // Bind Events
        catSelect.onchange = renderProducts;
        document.getElementById('sort-select').onchange = renderProducts;
    }

    function renderProducts() {
        const grid = document.getElementById('products-grid');
        const cat = document.getElementById('cat-select').value;
        const sort = document.getElementById('sort-select').value;

        let list = currentDisplayedProducts.filter(p => !cat || p['Category (g:product_type)'] === cat);

        if(sort === 'asc') list.sort((a,b) => parseFloat(a['Price']) - parseFloat(b['Price']));
        if(sort === 'desc') list.sort((a,b) => parseFloat(b['Price']) - parseFloat(a['Price']));

        grid.innerHTML = '';
        if(list.length === 0) {
            grid.innerHTML = '<p style="grid-column:1/-1; text-align:center; color:#666;">لا توجد منتجات</p>';
            return;
        }

        list.forEach(p => {
            let img = (p['Image'] || '').split('|')[0] || 'https://via.placeholder.com/200';
            
            let btnText = LANG === 'he' ? 'בדיקת זמינות' : 'هل متوفر؟';
            let waMsg = `مرحباً، هل العطر ${p['Title']} متوفر في الفرع؟`;
            const waLink = `https://wa.me/${currentBranchPhone}?text=${encodeURIComponent(waMsg)}`;

            grid.innerHTML += `
            <div class="product-card">
                <div class="p-img-container">
                    <img src="${img}" class="p-img" loading="lazy" alt="${p['Title']}">
                </div>
                <div class="p-info">
                    <div class="p-title">${p['Title']}</div>
                    <div class="p-price">${p['Price'] || ''} ${LANG==='he'?'₪':'شيكل'}</div>
                    <a href="${waLink}" target="_blank" class="btn-ask">
                        <i class="fab fa-whatsapp"></i> ${btnText}
                    </a>
                </div>
            </div>`;
        });
    }
</script>

</body>
</html>
