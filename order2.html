<!doctype html>
<html lang="he" dir="rtl">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width,initial-scale=1"/>
  <title>MAD FINAL PRO</title>
  
  <script src="https://cdn.jsdelivr.net/npm/jsbarcode@3.11.5/dist/JsBarcode.all.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/qrcodejs@1.0.0/qrcode.min.js"></script>
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">

  <style>
    :root { 
      --bg: #101014; --card: #1c1c24; --primary: #5c7cfa; 
      --accent: #fab005; --danger: #fa5252; --text: #e9ecef;
    }

    body { margin: 0; font-family: 'Segoe UI', Tahoma, sans-serif; background: var(--bg); color: var(--text); height: 100vh; display: flex; flex-direction: column; overflow: hidden; }
    
    /* --- Ø§Ù„ØªÙ†Ø¨ÙŠÙ‡Ø§Øª --- */
    #alert-bar { 
      display: none; background: var(--danger); color: white; text-align: center; 
      padding: 10px; font-weight: bold; font-size: 1.2rem; animation: blink 1s infinite;
      cursor: pointer;
    }
    @keyframes blink { 50% { opacity: 0.5; } }

    /* --- Ø§Ù„Ù‡ÙŠØ¯Ø± ÙˆØ§Ù„ØªØ¨ÙˆÙŠØ¨Ø§Øª --- */
    .header { 
      background: rgba(28, 28, 36, 0.95); padding: 15px 25px; border-bottom: 2px solid var(--primary);
      display: flex; gap: 20px; align-items: center; justify-content: space-between;
    }
    
    .tabs { display: flex; background: #2c2c35; padding: 4px; border-radius: 8px; }
    .tab { 
      padding: 8px 20px; cursor: pointer; border-radius: 6px; font-weight: bold; 
      color: #888; transition: 0.3s; display: flex; align-items: center; gap: 8px;
    }
    .tab.active { background: var(--primary); color: #fff; }
    .count-badge { background: rgba(0,0,0,0.3); padding: 2px 8px; border-radius: 10px; font-size: 0.8rem; }

    .search-box { 
      flex: 1; max-width: 400px; padding: 10px; border-radius: 8px; border: 1px solid #444; 
      background: #101014; color: white; font-weight: bold; 
    }

    .btn { cursor: pointer; border: none; padding: 10px 20px; border-radius: 6px; font-weight: bold; color: white; transition: 0.2s; display: flex; align-items: center; gap: 8px; }
    .btn-all { background: var(--accent); color: #000; }
    .btn-refresh { background: #333; }

    /* --- Ø§Ù„Ø´Ø¨ÙƒØ© --- */
    .workspace { flex: 1; overflow-y: auto; padding: 20px; }
    .grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(300px, 1fr)); gap: 15px; }

    .card { 
      background: var(--card); border: 1px solid #2a2a35; border-radius: 12px; padding: 15px; 
      cursor: pointer; position: relative; transition: transform 0.2s; border-right: 5px solid transparent;
    }
    .card:hover { transform: translateY(-5px); background: #252530; border-color: var(--primary); }
    .card.rush { border-right-color: var(--danger); }
    .card.status-ready { opacity: 0.6; border-right-color: var(--accent); } /* Ù„Ù„Ø£Ø±Ø´ÙŠÙ */

    .card-head { display: flex; justify-content: space-between; color: #777; font-size: 0.9rem; margin-bottom: 5px; }
    .card-name { font-size: 1.3rem; font-weight: bold; color: #fff; margin-bottom: 5px; }
    .card-info { font-size: 0.9rem; color: #aaa; line-height: 1.4; }
    .card-price { position: absolute; bottom: 15px; left: 15px; font-size: 1.2rem; font-weight: bold; color: #20c997; }

    /* --- Ø§Ù„Ù…ÙˆØ¯Ø§Ù„ --- */
    .modal-overlay { display: none; position: fixed; inset: 0; background: rgba(0,0,0,0.95); z-index: 1000; justify-content: center; align-items: center; }
    .modal-box { width: 95%; max-width: 1100px; height: 85vh; background: #fff; color: #000; display: flex; border-radius: 10px; overflow: hidden; }
    .editor { width: 35%; background: #f8f9fa; padding: 25px; overflow-y: auto; display: flex; flex-direction: column; gap: 12px; }
    .preview { width: 65%; background: #e9ecef; display: flex; align-items: center; justify-content: center; }
    
    .inp-group label { display: block; font-weight: bold; font-size: 0.85rem; margin-bottom: 3px; }
    .inp-group input, .inp-group textarea { width: 100%; padding: 10px; border: 1px solid #ced4da; border-radius: 6px; font-weight: bold; box-sizing: border-box; }
    .btn-print-big { width: 100%; padding: 15px; background: #000; color: #fff; font-size: 1.2rem; margin-top: auto; border: none; cursor: pointer; font-weight: bold; }

    /* --- Ø§Ù„Ù…Ù„ØµÙ‚ --- */
    .label-canvas { 
      width: 100mm; height: 100mm; background: #fff; color: #000; padding: 3mm; 
      box-sizing: border-box; border: 1px solid #ccc; display: flex; flex-direction: column; 
      overflow: hidden; position: relative; page-break-after: always; direction: rtl;
    }
    .lbl-head { display: flex; justify-content: space-between; height: 20mm; border-bottom: 1px solid #000; }
    .lbl-logo img { width: 35mm; }
    .lbl-meta { text-align: left; font-size: 9pt; font-weight: bold; }
    .lbl-promo { background: #000; color: #fff; text-align: center; font-weight: 900; font-size: 10pt; padding: 3px; margin: 2mm 0; }
    .lbl-info { font-size: 11pt; line-height: 1.3; font-weight: 600; }
    .lbl-content { border: 2px dashed #000; background: #f1f3f5; padding: 5px; margin: 2mm 0; font-size: 9pt; height: 16mm; overflow: hidden; font-weight: bold; }
    .lbl-price { border: 3px solid #000; font-size: 20pt; font-weight: 900; text-align: center; padding: 0; margin-bottom: 2mm; }
    .lbl-footer { display: flex; justify-content: space-between; align-items: flex-end; margin-top: auto; border-top: 1px solid #000; padding-top: 1mm; }
    .lbl-wa { font-size: 8pt; font-weight: 800; width: 65%; }

    #printArea { display: none; }
    @media print {
      body * { visibility: hidden !important; }
      #printArea, #printArea * { visibility: visible !important; }
      #printArea { display: block !important; position: absolute; left: 0; top: 0; width: 100%; }
      @page { size: 100mm 100mm; margin: 0; }
      .label-canvas { border: none; }
    }
  </style>
</head>
<body>

<audio id="bell" src="https://assets.mixkit.co/active_storage/sfx/2869/2869-preview.mp3"></audio>

<div id="alert-bar" onclick="this.style.display='none'">ğŸ”” ÙŠÙˆØ¬Ø¯ Ø·Ù„Ø¨Ø§Øª Ø¬Ø¯ÙŠØ¯Ø©! (Ø§Ø¶ØºØ· Ù„Ù„Ø¥Ø®ÙØ§Ø¡)</div>

<div class="header">
  <div style="font-weight:900; font-size:1.4rem">MAD <span style="color:var(--primary)">PRO</span></div>
  
  <div class="tabs">
    <div class="tab active" id="tab-pending" onclick="setTab('pending')">
      <span>Ù‚ÙŠØ¯ Ø§Ù„ØªØ¬Ù‡ÙŠØ²</span>
      <span class="count-badge" id="count-pending">0</span>
    </div>
    <div class="tab" id="tab-all" onclick="setTab('all')">
      <span>Ø§Ù„Ø£Ø±Ø´ÙŠÙ (Ø§Ù„ÙƒÙ„)</span>
      <span class="count-badge" id="count-all">0</span>
    </div>
  </div>

  <input class="search-box" id="search" placeholder="Ø¨Ø­Ø« Ø°ÙƒÙŠ: 050 / 972 / Ø§Ø³Ù…..." oninput="render()">
  
  <div style="display:flex; gap:10px">
    <button class="btn btn-refresh" onclick="loadData()">ØªØ­Ø¯ÙŠØ« â†»</button>
    <button class="btn btn-all" onclick="printAll()">Ø·Ø¨Ø§Ø¹Ø© Ø§Ù„Ù‚Ø§Ø¦Ù…Ø© ğŸ–¨ï¸</button>
  </div>
</div>

<div class="workspace">
  <div class="grid" id="grid"></div>
</div>

<div class="modal-overlay" id="editor">
  <div class="modal-box">
    <div class="editor" dir="rtl">
      <div style="display:flex; justify-content:space-between">
        <h2>ØªØ¹Ø¯ÙŠÙ„ Ø§Ù„Ø·Ù„Ø¨</h2>
        <button onclick="closeModal()" style="border:none;background:none;font-size:1.5rem;cursor:pointer">âœ•</button>
      </div>
      <div class="inp-group"><label>Ø§Ù„Ø§Ø³Ù…:</label><input id="e_name" oninput="updatePreview()"></div>
      <div class="inp-group"><label>Ø§Ù„Ù‡Ø§ØªÙ:</label><input id="e_phone" oninput="updatePreview()"></div>
      <div class="inp-group"><label>Ø§Ù„Ø¹Ù†ÙˆØ§Ù†:</label><input id="e_city" oninput="updatePreview()"></div>
      <div class="inp-group"><label>Ø§Ù„Ø´Ø­Ù†:</label><input id="e_del" oninput="updatePreview()"></div>
      <div class="inp-group"><label>Ø§Ù„Ù…Ø­ØªÙˆÙ‰:</label><textarea id="e_content" oninput="updatePreview()"></textarea></div>
      <div class="inp-group"><label>Ø§Ù„Ø³Ø¹Ø± (â‚ª):</label><input id="e_price" type="number" style="font-size:1.2rem;color:green" oninput="updatePreview()"></div>
      <button class="btn-print-big" onclick="printSingle()">Ø·Ø¨Ø§Ø¹Ø© (Enter) ğŸ–¨ï¸</button>
    </div>
    <div class="preview">
      <div id="livePreview" style="box-shadow: 0 10px 40px rgba(0,0,0,0.5);"></div>
    </div>
  </div>
</div>

<div id="printArea"></div>

<script>
  const SCRIPT_URL = "https://script.google.com/macros/s/AKfycbyLjLFa8AaH82Ip7m747WC-KSUUEaU_M70S0I9Mda14XbnmcuEfZ7pBnF_zzJYZuXmZ/exec";
  const PASS = "12345678";
  
  let orders = [];
  let currentTab = 'pending'; // 'pending' or 'all'
  let currentIndex = null;
  let lastPendingCount = 0;

  // 1. Ù…Ù†Ø·Ù‚ Ù…Ø¹Ø§Ù„Ø¬Ø© Ø§Ù„Ø£Ø±Ù‚Ø§Ù…
  function normalizeILPSPhone(input) {
    let d = String(input || "").replace(/[^0-9]/g, "");
    if (!d) return { ok: false, reason: "EMPTY", e164: "", display: "" };
    if (d.startsWith("00")) d = d.slice(2);
    if (d.startsWith("9720")) d = "972" + d.slice(4);
    if (d.startsWith("9700")) d = "970" + d.slice(4);
    if (d.startsWith("972") || d.startsWith("970")) return { ok: true, e164: "+" + d, display: d };
    if (d.startsWith("0")) {
      if (d.startsWith("059")) return { ok: true, e164: "+970" + d.slice(1), display: d };
      return { ok: true, e164: "+972" + d.slice(1), display: d };
    }
    if (d.startsWith("5")) {
       if (d.startsWith("59")) return { ok: true, e164: "+970" + d, display: "0" + d };
       return { ok: true, e164: "+972" + d, display: "0" + d };
    }
    return { ok: false, e164: "+" + d, display: d };
  }

  // Init
  (function(){
    if(localStorage.getItem('mad_auth') !== PASS) {
      if(prompt("Password:") === PASS) localStorage.setItem('mad_auth', PASS);
      else { document.body.innerHTML = "<h3>Access Denied</h3>"; return; }
    }
    loadData();
    setInterval(loadData, 20000); // ØªØ­Ø¯ÙŠØ« ØªÙ„Ù‚Ø§Ø¦ÙŠ ÙƒÙ„ 20 Ø«Ø§Ù†ÙŠØ©
  })();

  async function loadData() {
    try {
      const res = await fetch(`${SCRIPT_URL}?action=get`);
      orders = await res.json();
      
      // Ù…Ù†Ø·Ù‚ Ø§Ù„ØªÙ†Ø¨ÙŠÙ‡
      const pendingList = orders.filter(isPendingOrder);
      if (pendingList.length > lastPendingCount && lastPendingCount !== 0) {
         triggerAlert();
      }
      lastPendingCount = pendingList.length;

      render();
    } catch(e) {}
  }

  function triggerAlert() {
    const bar = document.getElementById('alert-bar');
    bar.style.display = 'block';
    document.getElementById('bell').play().catch(()=>{});
    // Ø¥Ø®ÙØ§Ø¡ ØªÙ„Ù‚Ø§Ø¦ÙŠ Ø¨Ø¹Ø¯ 10 Ø«ÙˆØ§Ù†ÙŠ
    setTimeout(() => { bar.style.display = 'none'; }, 10000);
  }

  function isPendingOrder(o) {
    const st = (o.status || "").toLowerCase();
    return (st.includes("prep") || st.includes("approved")) && !st.includes("ready");
  }

  function setTab(tab) {
    currentTab = tab;
    document.querySelectorAll('.tab').forEach(t => t.classList.remove('active'));
    document.getElementById(`tab-${tab}`).classList.add('active');
    render();
  }

  function render() {
    const pendingList = orders.filter(isPendingOrder);
    const allList = orders; // Ø£Ùˆ Ù‚Ù… Ø¨ØªØµÙÙŠØ© Ù…Ø¹ÙŠÙ†Ø© Ù„Ù„Ø£Ø±Ø´ÙŠÙ
    
    document.getElementById('count-pending').innerText = pendingList.length;
    document.getElementById('count-all').innerText = allList.length;

    let displayList = (currentTab === 'pending') ? pendingList : allList;

    // Ø§Ù„Ø¨Ø­Ø« Ø§Ù„Ø°ÙƒÙŠ
    const q = document.getElementById('search').value.toLowerCase().trim();
    if(q) {
      const qNorm = normalizeILPSPhone(q).e164 || q; 
      const qClean = qNorm.replace('+', '');
      displayList = displayList.filter(o => {
        const oPhoneInfo = normalizeILPSPhone(o.phone);
        const oPhoneE164 = oPhoneInfo.e164.toLowerCase();
        return (o.name || "").toLowerCase().includes(q) ||
               (o.orderId || "").toString().includes(q) ||
               oPhoneE164.includes(qClean) ||
               (o.phone || "").includes(q);
      });
    }

    const grid = document.getElementById('grid');
    if(!displayList.length) {
      grid.innerHTML = '<div style="color:#555;text-align:center;grid-column:1/-1;padding:50px">Ù„Ø§ ØªÙˆØ¬Ø¯ Ø·Ù„Ø¨Ø§Øª Ù„Ù„Ø¹Ø±Ø¶</div>';
      return;
    }

    grid.innerHTML = displayList.map(o => {
      const realIndex = orders.indexOf(o);
      const isRush = (o.delivery||"").includes("High");
      const isReady = (o.status||"").includes("READY");
      
      return `
        <div class="card ${isRush ? 'rush' : ''} ${isReady ? 'status-ready' : ''}" onclick="openEditor(${realIndex})">
          <div class="card-head">
            <span>#${o.orderId}</span>
            <span>${o.delivery || 'Standard'}</span>
          </div>
          <div class="card-name">
            ${isReady ? 'âœ… ' : ''}${o.name}
          </div>
          <div class="card-info">
            ğŸ“ ${o.phone}<br>
            ğŸ“ ${o.city}
          </div>
          <div class="card-price">â‚ª${o.price}</div>
        </div>
      `;
    }).join("");
  }

  // --- Label HTML ---
  function getLabelHTML(data, idSuffix) {
    const date = new Date().toLocaleDateString('he-IL');
    const phoneInfo = normalizeILPSPhone(data.phone);
    // Ù„Ù„Ø¨Ø§Ø±ÙƒÙˆØ¯ Ù†Ø²ÙŠÙ„ +
    const barcodeVal = phoneInfo.e164.replace('+','');

    return `
      <div class="label-canvas" dir="rtl">
        <div class="lbl-head">
          <div class="lbl-logo"><img src="https://www.madparfum.com/logo.svg"></div>
          <div class="lbl-meta">
            DATE: ${date}<br>
            ORD: ${data.orderId}
          </div>
        </div>
        
        <div class="lbl-promo">×¦×œ× ××ª ×”×¨×’×¢ ×•×§×‘×œ ××ª× ×” ğŸ</div>
        
        <div class="lbl-info">
          <div><b>×œ×›×‘×•×“:</b> ${data.name}</div>
          <div><b>×˜×œ×¤×•×Ÿ:</b> <span dir="ltr">${phoneInfo.display}</span></div>
          <div><b>×›×ª×•×‘×ª:</b> ${data.city}</div>
          <div><b>××©×œ×•×—:</b> ${data.delivery}</div>
        </div>

        <div class="lbl-content">
          <b>×ª×›×•×œ×” (Content):</b><br>
          ${(data.offer || "").replace(/\n/g, "<br>")}
        </div>

        <div class="lbl-price">â‚ª ${data.price}</div>

        <div class="lbl-footer">
          <div class="lbl-wa">
            WhatsApp Video = FREE GIFT<br>
            ${phoneInfo.e164}
          </div>
          <div id="qr_${idSuffix}"></div>
        </div>
        <div style="position:absolute; bottom:2mm; width:92%; text-align:center">
           <svg id="bar_${idSuffix}" data-val="${barcodeVal}"></svg>
        </div>
      </div>
    `;
  }

  // --- Editor & Printing ---
  function openEditor(idx) {
    currentIndex = idx;
    const o = orders[idx];
    document.getElementById('e_name').value = o.name;
    document.getElementById('e_phone').value = o.phone;
    document.getElementById('e_city').value = o.city + " " + (o.addr||"");
    document.getElementById('e_del').value = o.delivery || "High Express";
    document.getElementById('e_content').value = o.offer || "";
    document.getElementById('e_price').value = o.price;
    document.getElementById('editor').style.display = 'flex';
    updatePreview();
    
    document.onkeydown = (e) => {
      if(e.key === "Enter" && !e.shiftKey) { e.preventDefault(); printSingle(); }
      if(e.key === "Escape") closeModal();
    };
  }

  function closeModal() {
    document.getElementById('editor').style.display = 'none';
    document.onkeydown = null;
  }

  function getFormData() {
    return {
      orderId: orders[currentIndex].orderId,
      name: document.getElementById('e_name').value,
      phone: document.getElementById('e_phone').value,
      city: document.getElementById('e_city').value,
      delivery: document.getElementById('e_del').value,
      offer: document.getElementById('e_content').value,
      price: document.getElementById('e_price').value
    };
  }

  function updatePreview() {
    const data = getFormData();
    document.getElementById('livePreview').innerHTML = getLabelHTML(data, 'prev');
    generateCodes('prev');
  }

  function generateCodes(suffix) {
    try {
      const barEl = document.getElementById(`bar_${suffix}`);
      if(barEl) {
        JsBarcode(barEl, barEl.getAttribute('data-val'), { format: "CODE128", height: 25, fontSize: 10, displayValue: false, margin:0 });
      }
      const qrEl = document.getElementById(`qr_${suffix}`);
      if(qrEl) {
        qrEl.innerHTML = "";
        const val = barEl ? barEl.getAttribute('data-val') : "972549634449";
        new QRCode(qrEl, { text: `https://wa.me/${val}`, width: 45, height: 45 });
      }
    } catch(e){}
  }

  function printSingle() {
    const data = getFormData();
    const area = document.getElementById('printArea');
    area.innerHTML = getLabelHTML(data, 'print');
    
    setTimeout(() => {
      generateCodes('print');
      setTimeout(async () => {
        window.print();
        const row = orders[currentIndex].rowIndex;
        closeModal();
        await fetch(`${SCRIPT_URL}?action=updateStatus&key=${PASS}&row=${row}&status=READY âœ…`);
        // ØªØ­Ø¯ÙŠØ« Ø§Ù„ÙˆØ§Ø¬Ù‡Ø© (Ø¥Ø²Ø§Ù„Ø© Ø§Ù„Ø·Ù„Ø¨ Ù…Ù† Ø§Ù„Ù‚Ø§Ø¦Ù…Ø© Ø¥Ø°Ø§ ÙƒÙ†Ø§ ÙÙŠ ØªØ¨ÙˆÙŠØ¨ Ù‚ÙŠØ¯ Ø§Ù„ØªØ¬Ù‡ÙŠØ²)
        orders[currentIndex].status = "READY âœ…"; // ØªØ­Ø¯ÙŠØ« Ù…Ø­Ù„ÙŠ
        render();
      }, 500);
    }, 100);
  }

  function printAll() {
    // Ø·Ø¨Ø§Ø¹Ø© ÙÙ‚Ø· Ø§Ù„Ù…Ø¹Ø±ÙˆØ¶ Ø­Ø§Ù„ÙŠØ§Ù‹ ÙÙŠ Ø§Ù„Ø´Ø¨ÙƒØ©
    let listToPrint = [];
    if (currentTab === 'pending') {
      listToPrint = orders.filter(isPendingOrder);
    } else {
      if(!confirm("Ø£Ù†Øª ÙÙŠ ØªØ¨ÙˆÙŠØ¨ Ø§Ù„Ø£Ø±Ø´ÙŠÙØŒ Ù‡Ù„ ØªØ±ÙŠØ¯ Ø·Ø¨Ø§Ø¹Ø© Ø§Ù„ÙƒÙ„ØŸ")) return;
      listToPrint = orders;
    }

    if(!listToPrint.length) return alert("Ù„Ø§ ÙŠÙˆØ¬Ø¯ Ø·Ù„Ø¨Ø§Øª Ù„Ù„Ø·Ø¨Ø§Ø¹Ø©");

    const area = document.getElementById('printArea');
    area.innerHTML = listToPrint.map((o, i) => getLabelHTML(o, `bulk_${i}`)).join("");

    setTimeout(() => {
      listToPrint.forEach((o, i) => generateCodes(`bulk_${i}`));
      setTimeout(() => {
        window.print();
        if(currentTab === 'pending' && confirm("Ù†Ù‚Ù„ ÙƒÙ„ Ù‡Ø°Ù‡ Ø§Ù„Ø·Ù„Ø¨Ø§Øª Ø¥Ù„Ù‰ Ø§Ù„Ø£Ø±Ø´ÙŠÙ (Ø¬Ø§Ù‡Ø²)ØŸ")) {
          listToPrint.forEach(o => {
             o.status = "READY âœ…";
             fetch(`${SCRIPT_URL}?action=updateStatus&key=${PASS}&row=${o.rowIndex}&status=READY âœ…`);
          });
          render();
        }
      }, 1500);
    }, 200);
  }
</script>
</body>
</html>
