<!doctype html>
<html lang="he" dir="rtl">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width,initial-scale=1"/>
  <title>MAD SYSTEM v4.5 | Optimized</title>
  
  <script src="https://cdn.jsdelivr.net/npm/jsbarcode@3.11.5/dist/JsBarcode.all.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/qrcodejs@1.0.0/qrcode.min.js"></script>
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
  <link href="https://fonts.googleapis.com/css2?family=Assistant:wght@400;700;800&family=Rubik:wght@500;700;900&display=swap" rel="stylesheet">

  <style>
    :root { 
      --bg-main: #0f172a; --bg-card: #1e293b; --primary: #3b82f6; 
      --accent: #f59e0b; --success: #10b981; --text-main: #f8fafc;
    }

    body { margin: 0; font-family: 'Assistant', sans-serif; background: var(--bg-main); color: var(--text-main); height: 100vh; display: flex; flex-direction: column; overflow: hidden; }

    /* --- Header & Search --- */
    .header { background: #1e293b; padding: 1rem 2rem; display: flex; align-items: center; border-bottom: 1px solid #334155; }
    .search-container { flex: 1; max-width: 600px; margin: 0 2rem; position: relative; }
    .search-input { width: 100%; padding: 12px 45px 12px 15px; background: #0f172a; border: 1px solid #334155; border-radius: 12px; color: white; font-size: 1.1rem; }
    .search-icon { position: absolute; right: 15px; top: 50%; transform: translateY(-50%); color: #94a3b8; }

    /* --- Workspace --- */
    .workspace { flex: 1; overflow-y: auto; padding: 2rem; }
    .grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(300px, 1fr)); gap: 1.5rem; padding-bottom: 100px; }

    /* --- Card --- */
    .card { background: var(--bg-card); border-radius: 12px; padding: 1.2rem; border: 1px solid #334155; position: relative; cursor: pointer; transition: 0.2s; }
    .card:hover { border-color: var(--primary); transform: translateY(-3px); }
    .card-checkbox { position: absolute; top: 1rem; right: 1rem; width: 22px; height: 22px; cursor: pointer; }
    .price-tag { font-size: 1.5rem; font-weight: 900; color: var(--success); }

    /* --- Floating Bar --- */
    .bulk-bar { position: fixed; bottom: 25px; left: 50%; transform: translateX(-50%) translateY(150px); background: #fff; color: #000; padding: 15px 35px; border-radius: 50px; display: flex; align-items: center; gap: 20px; box-shadow: 0 10px 40px rgba(0,0,0,0.5); transition: 0.4s; z-index: 9999; }
    .bulk-bar.active { transform: translateX(-50%) translateY(0); }
    .btn-print { background: var(--primary); color: white; border: none; padding: 10px 25px; border-radius: 20px; font-weight: 700; cursor: pointer; }

    /* --- Print Styles (100x100mm) --- */
    @media print {
      body * { visibility: hidden; }
      #printArea, #printArea * { visibility: visible; }
      #printArea { position: absolute; left: 0; top: 0; width: 100mm; }
      @page { size: 100mm 100mm; margin: 0; }
      .label-page { 
        width: 100mm; height: 100mm; padding: 6mm; box-sizing: border-box;
        display: flex; flex-direction: column; page-break-after: always;
        background: white !important; color: black !important; font-family: 'Rubik', sans-serif;
      }
    }

    .label-header { display: flex; justify-content: space-between; align-items: flex-start; margin-bottom: 4mm; }
    .label-title { background: #000; color: #fbbf24; text-align: center; padding: 4px; font-weight: 900; border-radius: 4px; font-size: 11pt; margin-bottom: 4mm; }
    .label-row { display: grid; grid-template-columns: 75px 1fr; gap: 2px; font-size: 12.5pt; line-height: 1.3; margin-bottom: 2mm; }
    .label-row b { font-weight: 800; }
    .label-offer { border-top: 1px solid #000; margin-top: 2mm; padding-top: 2mm; font-size: 10.5pt; font-weight: bold; height: 18mm; overflow: hidden; }
    .label-price { border: 3px solid #000; text-align: center; font-size: 26pt; font-weight: 900; border-radius: 8px; margin: 2mm 0; }
    .label-footer { display: flex; justify-content: space-between; align-items: center; margin-top: auto; }
  </style>
</head>
<body>

<header class="header">
  <div style="font-size:1.8rem; font-weight:900;">MAD <span style="color:var(--primary)">V4.5</span></div>
  <div class="search-container">
    <i class="fas fa-search search-icon"></i>
    <input type="text" id="searchInput" class="search-input" placeholder="×—×™×¤×•×© ×œ×¤×™ ×©× ××• ×˜×œ×¤×•×Ÿ (×’× ×¢× ××§×¤×™×)..." oninput="app.render()">
  </div>
  <button onclick="app.loadData()" style="background:#334155; color:white; border:none; padding:10px 20px; border-radius:8px; cursor:pointer;">×¨×¢× ×Ÿ â†»</button>
</header>

<main class="workspace">
  <div id="grid" class="grid"></div>
</main>

<div id="bulkBar" class="bulk-bar">
  <span id="selectedCount" style="font-weight:900">0 × ×‘×—×¨×•</span>
  <button class="btn-print" onclick="app.printSelected()">×”×“×¤×¡ ×ª×•×•×™×•×ª × ×‘×—×¨×•×ª ğŸ–¨ï¸</button>
  <button onclick="app.clearSelection()" style="background:none; border:none; text-decoration:underline; cursor:pointer; color:#666">×‘×™×˜×•×œ</button>
</div>

<div id="printArea"></div>

<script>
class MadSystem {
  constructor() {
    this.scriptUrl = "https://script.google.com/macros/s/AKfycbyLjLFa8AaH82Ip7m747WC-KSUUEaU_M70S0I9Mda14XbnmcuEfZ7pBnF_zzJYZuXmZ/exec";
    this.orders = [];
    this.selected = new Set();
    
    // ××™×œ×•×Ÿ ×ª×¨×’×•× ×œ×¢×‘×¨×™×ª
    this.translateMap = {
      "cash": "××–×•××Ÿ",
      "credit": "××©×¨××™",
      "bit": "×‘×™×˜",
      "delivered": "× ××¡×¨",
      "pending": "×××ª×™×Ÿ",
      "jerusalem": "×™×¨×•×©×œ×™×",
      "tel aviv": "×ª×œ ××‘×™×‘",
      "haifa": "×—×™×¤×”"
      // × ×™×ª×Ÿ ×œ×”×•×¡×™×£ ×›××Ÿ ×¢×¨×™× × ×•×¡×¤×•×ª ×× ×”×Ÿ ××’×™×¢×•×ª ×‘×× ×’×œ×™×ª ××”×“××˜×”
    };

    this.init();
  }

  async init() {
    this.loadData();
    setInterval(() => this.loadData(true), 30000);
  }

  async loadData(silent = false) {
    try {
      const res = await fetch(`${this.scriptUrl}?action=get`);
      this.orders = await res.json();
      this.render();
    } catch(e) { console.error(e); }
  }

  // ×ª×¨×’×•× ×—×›× ×œ×¢×‘×¨×™×ª
  toHebrew(text) {
    if(!text) return "";
    const clean = text.toString().toLowerCase().trim();
    return this.translateMap[clean] || text;
  }

  // × ×™×§×•×™ ××¡×¤×¨ ×˜×œ×¤×•×Ÿ ×œ×—×™×¤×•×© (××¡×™×¨ ××§×¤×™× ×•×¨×•×•×—×™×)
  cleanStr(s) {
    return String(s || "").replace(/[-\s]/g, "");
  }

  render() {
    const rawQuery = document.getElementById('searchInput').value;
    const query = this.cleanStr(rawQuery).toLowerCase();
    const grid = document.getElementById('grid');
    
    const filtered = this.orders.filter(o => {
      const searchData = this.cleanStr(`${o.name}${o.phone}${o.orderId}${o.city}`).toLowerCase();
      return searchData.includes(query);
    });

    grid.innerHTML = filtered.map(o => {
      const idx = this.orders.indexOf(o);
      const isSelected = this.selected.has(idx);
      return `
        <div class="card" onclick="app.toggleSelect(${idx})">
          <input type="checkbox" class="card-checkbox" ${isSelected ? 'checked' : ''} onclick="event.stopPropagation(); app.toggleSelect(${idx})">
          <div style="color:#94a3b8; font-size:0.8rem">#${o.orderId}</div>
          <div style="font-size:1.3rem; font-weight:800; margin:5px 0">${o.name}</div>
          <div style="font-size:1rem; color:#cbd5e1"><i class="fas fa-phone"></i> ${o.phone}</div>
          <div style="font-size:0.9rem; color:#f59e0b; margin-top:5px">ğŸ“ ${this.toHebrew(o.city)}</div>
          <div style="margin:10px 0; font-size:0.85rem; color:#94a3b8; height:40px; overflow:hidden">${o.offer || ''}</div>
          <div style="display:flex; justify-content:space-between; align-items:center; border-top:1px solid #334155; padding-top:10px">
             <span style="font-weight:bold">${this.toHebrew(o.payment)}</span>
             <span class="price-tag">â‚ª${o.price}</span>
          </div>
        </div>
      `;
    }).join("");
  }

  toggleSelect(idx) {
    this.selected.has(idx) ? this.selected.delete(idx) : this.selected.add(idx);
    const bar = document.getElementById('bulkBar');
    document.getElementById('selectedCount').innerText = `${this.selected.size} × ×‘×—×¨×•`;
    this.selected.size > 0 ? bar.classList.add('active') : bar.classList.remove('active');
    this.render();
  }

  clearSelection() {
    this.selected.clear();
    document.getElementById('bulkBar').classList.remove('active');
    this.render();
  }

  generateLabelHtml(o, id) {
    return `
      <div class="label-page" dir="rtl">
        <div class="label-header">
          <img src="https://www.madparfum.com/logo.svg" style="width:38mm">
          <div style="text-align:left; font-size:9pt; font-weight:bold;">
            DATE: ${new Date().toLocaleDateString('he-IL')}<br>
            ORD: ${o.orderId}
          </div>
        </div>
        
        <div class="label-title">×¦×œ× ××ª ×”×¨×’×¢ ×•×§×‘×œ ××ª× ×” ğŸ</div>
        
        <div class="label-row"><b>×œ×›×‘×•×“:</b> <span>${o.name}</span></div>
        <div class="label-row"><b>×˜×œ×¤×•×Ÿ:</b> <span dir="ltr" style="text-align:right">${o.phone}</span></div>
        <div class="label-row"><b>×¢×™×¨:</b> <span>${this.toHebrew(o.city)}</span></div>
        <div class="label-row"><b>×ª×©×œ×•×:</b> <span>${this.toHebrew(o.payment || "××–×•××Ÿ")}</span></div>
        <div class="label-row"><b>×—×‘×¨×”:</b> <span>${o.delivery || "High Express"}</span></div>

        <div class="label-offer">${o.offer || ''}</div>
        
        <div class="label-price">â‚ª${o.price}</div>

        <div class="label-footer">
          <div style="background:#000; color:#fff; padding:5px; border-radius:5px; font-size:7.5pt; width:65%; font-weight:bold">
            1. ×¡×¨×•×§ ××ª ×”×§×•×“<br>2. ×©×œ×— ×¡×¨×˜×•×Ÿ ×œ-WhatsApp<br>3. ×§×‘×œ ××ª× ×”!
          </div>
          <div id="qr_${id}"></div>
        </div>
        <div style="text-align:center; margin-top:3mm">
          <svg id="bar_${id}"></svg>
        </div>
      </div>
    `;
  }

  printSelected() {
    const list = Array.from(this.selected).map(idx => this.orders[idx]);
    const area = document.getElementById('printArea');
    area.innerHTML = list.map((o, i) => this.generateLabelHtml(o, `p${i}`)).join("");
    
    list.forEach((o, i) => {
      const cleanPhone = String(o.phone).replace(/\D/g, "");
      JsBarcode(`#bar_p${i}`, cleanPhone, { height: 25, fontSize: 10, displayValue: false, margin: 0 });
      new QRCode(document.getElementById(`qr_p${i}`), { text: "https://wa.me/972549634449", width: 55, height: 55 });
    });

    setTimeout(() => {
      window.print();
      if(confirm("×œ×¡××Ÿ ××ª ×›×•×œ× ×›-READY?")) {
         list.forEach(o => fetch(`${this.scriptUrl}?action=updateStatus&key=12345678&row=${o.rowIndex}&status=READY âœ…`));
         this.clearSelection();
      }
    }, 500);
  }
}

const app = new MadSystem();
</script>
</body>
</html>
