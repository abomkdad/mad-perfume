<!doctype html>
<html lang="he" dir="rtl">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width,initial-scale=1"/>
  <title>MAD Dashboard | MONITORING</title>
  
  <script src="https://cdn.jsdelivr.net/npm/jsbarcode@3.11.5/dist/JsBarcode.all.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/qrcodejs@1.0.0/qrcode.min.js"></script>

  <style>
    :root { --bg: #f0f2f5; --header: #070b16; --primary: #3b82f6; --success: #10b981; }
    body { margin: 0; font-family: system-ui; background: var(--bg); color: #333; }
    
    /* Header */
    .top-nav { background: var(--header); color: white; padding: 15px; position: sticky; top: 0; z-index: 100; display: flex; justify-content: space-between; align-items: center; }
    .nav-logo { height: 40px; filter: invert(1); }
    
    .container { max-width: 1200px; margin: 0 auto; padding: 20px; }
    
    h2 { border-right: 4px solid var(--primary); padding-right: 10px; margin: 20px 0; font-size: 1.5rem; }

    /* Ø·Ù„Ø¨Ø§Øª Ù‚ÙŠØ¯ Ø§Ù„ØªØ¬Ù‡ÙŠØ² (Ù…ÙØªÙˆØ­Ø©) */
    .active-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(350px, 1fr)); gap: 20px; }
    .active-card { background: white; border-radius: 12px; padding: 20px; box-shadow: 0 4px 6px rgba(0,0,0,0.05); border: 1px solid #ddd; }
    
    /* Ø§Ù„Ø·Ù„Ø¨Ø§Øª Ø§Ù„Ù…Ø¬Ù‡Ø²Ø© (Ø³ÙƒØ± Ø§Ù„ØªÙØ§Ø¹Ù„) */
    .history-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(240px, 1fr)); gap: 15px; background: #e2e8f0; padding: 20px; border-radius: 15px; }
    .history-card { 
      background: white; border: 1px solid #000; padding: 10px; font-size: 9pt; 
      display: flex; flex-direction: column; position: relative; opacity: 0.9;
      pointer-events: none; /* Ø³ÙƒØ± Ø§Ù„ØªÙØ§Ø¹Ù„ */
    }
    .history-card .print-only { pointer-events: auto; position: absolute; top: 5px; left: 5px; background: #eee; border: none; cursor: pointer; border-radius: 4px; padding: 2px 5px; font-size: 8pt; }

    /* Label UI Inside Card */
    .label-header { display: flex; justify-content: space-between; align-items: center; border-bottom: 1px solid #000; margin-bottom: 5px; }
    .label-logo { font-size: 18pt; font-weight: 900; }
    .price-tag { border: 1px solid #000; text-align: center; font-weight: bold; margin: 5px 0; padding: 2px; }

    .btn { cursor: pointer; border: none; border-radius: 6px; padding: 10px 15px; font-weight: bold; transition: 0.2s; }
    .btn-done { background: var(--success); color: white; width: 100%; margin-top: 10px; }

    #printArea { display: none; }
    @media print {
      body * { visibility: hidden !important; }
      #printArea, #printArea * { visibility: visible !important; }
      #printArea { position: absolute; left: 0; top: 0; width: 100mm; display: block !important; }
      @page { size: 100mm 100mm; margin: 0; }
    }
  </style>
</head>
<body>

<div class="top-nav">
  <img src="https://www.madparfum.com/logo.svg" class="nav-logo">
  <div style="display:flex; gap:10px">
    <button class="btn" style="background:#fff; color:#000" onclick="load()">×¨×¢× ×Ÿ â†»</button>
  </div>
</div>

<div class="container">
  
  <h2>ğŸ“ ×”×–×× ×•×ª ×œ×”×›× ×” (×¤×ª×•×—)</h2>
  <div class="active-grid" id="pendingList"></div>

  <hr style="margin: 40px 0; border: 0; border-top: 2px dashed #cbd5e1;">

  <h2>âœ… ×”×–×× ×•×ª ×©×‘×•×¦×¢×• (×ª×¦×•×’×” ×‘×œ×‘×“)</h2>
  <div class="history-grid" id="readyList"></div>

</div>

<div id="printArea"></div>

<script>
  const SCRIPT_URL = "https://script.google.com/macros/s/AKfycbyLjLFa8AaH82Ip7m747WC-KSUUEaU_M70S0I9Mda14XbnmcuEfZ7pBnF_zzJYZuXmZ/exec";
  const DASH_KEY = "12345678";
  let orders = [];

  async function load() {
    const res = await fetch(`${SCRIPT_URL}?action=get`);
    orders = await res.json();
    render();
  }

  function render() {
    const pending = orders.filter(o => (o.status || "").includes("Prep") && !(o.status || "").includes("READY"));
    const ready = orders.filter(o => (o.status || "").includes("READY"));

    // Ø¹Ø±Ø¶ Ø§Ù„Ø·Ù„Ø¨Ø§Øª Ø§Ù„Ù…ÙØªÙˆØ­Ø©
    document.getElementById('pendingList').innerHTML = pending.map(o => `
      <div class="active-card">
        <div style="display:flex; justify-content:space-between; margin-bottom:10px">
          <span style="font-weight:900">#${o.orderId}</span>
          <span style="color:#666">${o.delivery || 'High Express'}</span>
        </div>
        <div style="font-size:1.1rem"><b>×©×:</b> ${o.name}</div>
        <div><b>×˜×œ×¤×•×Ÿ:</b> ${o.phone}</div>
        <div><b>×›×ª×•×‘×ª:</b> ${o.city}</div>
        <div style="margin-top:10px; font-weight:bold; color:var(--success)">â‚ª${o.price}</div>
        <button class="btn btn-done" onclick="markReady(${o.rowIndex})">×¡××Ÿ ×›×‘×•×¦×¢ âœ…</button>
      </div>
    `).join("");

    // Ø¹Ø±Ø¶ Ø§Ù„Ø·Ù„Ø¨Ø§Øª Ø§Ù„Ù…Ø¬Ù‡Ø²Ø© (Ø³ÙƒØ± Ø§Ù„ØªÙØ§Ø¹Ù„)
    document.getElementById('readyList').innerHTML = ready.map(o => `
      <div class="history-card">
        <button class="print-only" onclick="printOrder(${o.rowIndex})">ğŸ–¨ï¸</button>
        <div class="label-header">
          <span style="font-size:7pt">${o.orderId.substring(0,10)}..</span>
          <span class="label-logo">MAD</span>
        </div>
        <div><b>×©×:</b> ${o.name}</div>
        <div><b>×˜×œ×¤×•×Ÿ:</b> ${o.phone}</div>
        <div class="price-tag">â‚ª${o.price}</div>
        <div style="text-align:center; margin-top:auto">
          <svg id="b_${o.rowIndex}"></svg>
        </div>
      </div>
    `).join("");

    // ØªÙˆÙ„ÙŠØ¯ Ø§Ù„Ø¨Ø§Ø±ÙƒÙˆØ¯ Ù„Ù„Ø·Ù„Ø¨Ø§Øª Ø§Ù„Ù…Ø¬Ù‡Ø²Ø© Ù„Ù„Ø¹Ø±Ø¶ ÙÙ‚Ø·
    setTimeout(() => {
      ready.forEach(o => {
        JsBarcode(`#b_${o.rowIndex}`, o.phone || "0", { format: "CODE128", height: 20, fontSize: 8, displayValue: false });
      });
    }, 100);
  }

  async function markReady(row) {
    if(!confirm("×œ×”×¢×‘×™×¨ ×œ×‘×•×¦×¢?")) return;
    await fetch(`${SCRIPT_URL}?action=updateStatus&key=${DASH_KEY}&row=${row}&status=READY âœ…`);
    load();
  }

  function printOrder(row) {
    const o = orders.find(x => x.rowIndex == row);
    // ÙƒÙˆØ¯ Ø§Ù„Ø·Ø¨Ø§Ø¹Ø© 100x100 (Ù†ÙØ³ Ø§Ù„ÙƒÙˆØ¯ Ø§Ù„Ø³Ø§Ø¨Ù‚)
    alert("×”×“×¤×¡×ª ××“×‘×§×” ×¢×‘×•×¨: " + o.name);
  }

  load();
</script>
</body>
</html>
