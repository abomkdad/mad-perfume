<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no" />
  <title>MAD Prep - Big Order Box + Print</title>
  <link rel="icon" type="image/png" href="https://www.mad-parfumeur.com/assets/hero/logo.png">

  <!-- âœ… Barcode -->
  <script src="https://cdn.jsdelivr.net/npm/jsbarcode@3.11.5/dist/JsBarcode.all.min.js"></script>

  <style>
    :root{
      --bg:#071022; --card:#0d1a33; --line:#1e2b47;
      --text:#f8fafc; --muted:#9fb0c6;
      --success:#16a34a; --warn:#f59e0b; --primary:#2563eb; --danger:#ef4444;
      --shadow:0 12px 35px rgba(0,0,0,.45);
      --r:22px;

      /* âœ… Label size (Ø¹Ø¯Ù„Ù‡Ø§ Ø­Ø³Ø¨ Ø§Ù„Ù„ÙŠ Ø¹Ù†Ø¯Ùƒ) */
      --label-w: 100mm;
      --label-h: 100mm;
    }
    *{box-sizing:border-box}
    body{
      margin:0; font-family:system-ui,"Segoe UI",Tahoma,Arial;
      background:radial-gradient(1200px 600px at 20% 0%, rgba(22,163,74,.14), transparent 55%),
                 radial-gradient(1000px 700px at 80% 15%, rgba(245,158,11,.10), transparent 55%),
                 var(--bg);
      color:var(--text); display:flex; justify-content:center;
      padding-bottom:80px;
    }
    .app{width:100%; max-width:900px}
    .top{
      position:sticky; top:0; z-index:999;
      background:rgba(7,16,34,.92); backdrop-filter:blur(10px);
      border-bottom:1px solid var(--line);
      padding:14px;
    }
    .head{display:flex; gap:10px; align-items:center}
    .logo{
      width:46px; height:46px; border-radius:16px; overflow:hidden;
      border:1px solid var(--line); background:#0b1730; box-shadow:var(--shadow);
    }
    .logo img{width:100%; height:100%; object-fit:cover}
    .title{flex:1; line-height:1.1}
    .title b{display:block; font-size:18px}
    .title span{display:block; margin-top:4px; font-size:12px; font-weight:900; color:var(--muted)}
    .iconBtn{
      width:48px; height:48px; border-radius:16px;
      border:1px solid var(--line);
      background:#0b1730; color:var(--text);
      box-shadow:var(--shadow);
      cursor:pointer; font-size:18px; font-weight:1000;
    }
    .row{display:flex; gap:10px; margin-top:10px; flex-wrap:wrap}
    .boxWhite{
      flex:1; min-width:240px;
      background:#fff;
      border-radius:18px;
      border:2px solid rgba(37,99,235,.22);
      padding:12px;
      color:#0b1020;
      box-shadow:var(--shadow);
    }
    .boxWhite label{display:block; font-size:11px; font-weight:1000; margin-bottom:6px}
    .boxWhite select,.boxWhite input{
      width:100%; border:none; outline:none; background:transparent;
      font-size:18px; font-weight:1000; color:#0b1020;
    }
    .search{
      width:100%;
      border-radius:18px; border:1px solid var(--line);
      background:#071331; color:var(--text);
      padding:14px 14px; font-weight:1000;
      outline:none; box-shadow:var(--shadow);
      font-size:16px;
      margin-top:10px;
    }
    .content{padding:14px}
    .card{
      background:linear-gradient(180deg, rgba(13,26,51,.92), rgba(13,26,51,.78));
      border:1px solid var(--line);
      border-radius:var(--r);
      padding:14px;
      box-shadow:var(--shadow);
      margin-bottom:14px;
    }

    /* BIG ORDER BOX */
    .orderBox{
      background:rgba(7,19,49,.78);
      border:2px solid rgba(255,255,255,.10);
      border-radius:20px;
      padding:14px;
    }
    .boxTitle{
      text-align:center;
      font-weight:1100;
      font-size:18px;
      padding-bottom:10px;
      border-bottom:1px solid rgba(255,255,255,.12);
      margin-bottom:10px;
      color:#bfdbfe;
    }
    .infoRow{
      display:flex;
      justify-content:space-between;
      gap:10px;
      padding:10px 0;
      border-bottom:1px solid rgba(255,255,255,.08);
      align-items:center;
    }
    .infoRow:last-child{border-bottom:none}
    .lbl{
      color:var(--muted);
      font-weight:1000;
      font-size:13px;
      min-width:120px;
    }
    .val{
      color:var(--text);
      font-weight:1100;
      font-size:16px;
      text-align:left;
      direction:ltr;
      word-break:break-word;
    }
    .val.rtl{
      direction:rtl;
      text-align:right;
    }
    .offerBox{
      margin-top:12px;
      padding:12px;
      border-radius:18px;
      background:rgba(0,0,0,.18);
      border:1px solid rgba(255,255,255,.10);
      font-weight:1100;
      font-size:18px;
    }

    .btns{
      display:grid;
      grid-template-columns: 1fr 1fr 1fr;
      gap:10px;
      margin-top:12px;
    }
    @media (max-width: 700px){
      .btns{grid-template-columns:1fr}
    }
    .btn{
      border:none; cursor:pointer;
      border-radius:18px; padding:16px 14px;
      font-weight:1100; font-size:18px;
      box-shadow:var(--shadow);
      transition:.12s; user-select:none;
      display:flex; align-items:center; justify-content:center; gap:10px;
    }
    .btn:active{transform:scale(.98)}
    .btnReady{background:var(--success); color:white}
    .btnEdit{background:var(--warn); color:#0b1020}
    .btnPrint{background:var(--primary); color:white}
    .btn:disabled{opacity:.25; cursor:not-allowed}

    .empty{
      text-align:center;
      color:var(--muted);
      padding:20px;
      font-weight:1100;
      background:rgba(13,26,51,.65);
      border:1px solid var(--line);
      border-radius:22px;
      box-shadow:var(--shadow);
    }

    .toast{
      position:fixed; top:-120px; left:50%;
      transform:translateX(-50%);
      background:var(--warn); color:#0b1020;
      font-weight:1000; padding:12px 16px; border-radius:999px;
      box-shadow:var(--shadow);
      transition:.5s; z-index:2000;
    }
    .toast.show{top:16px}

    /* Modal edit */
    .modalWrap{
      position:fixed; inset:0;
      background:rgba(0,0,0,.55);
      display:none; align-items:center; justify-content:center;
      padding:16px; z-index:3000;
    }
    .modal{
      width:100%; max-width:720px;
      background:var(--card);
      border:1px solid var(--line);
      border-radius:24px;
      padding:14px;
      box-shadow:var(--shadow);
    }
    .modal h3{margin:0 0 10px 0; font-size:18px; font-weight:1100}
    .field{
      background:#fff;
      border-radius:18px;
      border:2px solid rgba(37,99,235,.22);
      padding:12px;
      color:#0b1020;
      margin-top:10px;
    }
    .field label{display:block; font-size:11px; font-weight:1100; margin-bottom:6px}
    .field input,.field textarea{
      width:100%; border:none; outline:none; background:transparent;
      font-size:18px; font-weight:1100;
    }
    .field textarea{resize:vertical}
    .modalActions{display:grid; grid-template-columns:1fr 1fr; gap:10px; margin-top:12px}
    .btnClose{background:var(--danger); color:white}
    .btnSave{background:var(--primary); color:white}

    /* âœ… PRINT */
    #print-container{ display:none; }
    @media print{
      @page { size: var(--label-w) var(--label-h); margin: 0; }
      body * { visibility:hidden !important; }
      #print-container, #print-container * { visibility:visible !important; }
      #print-container{
        display:block !important;
        position:fixed; left:0; top:0;
        width: var(--label-w);
        height: var(--label-h);
        background:#fff !important;
        color:#000 !important;
      }
      .print-page{
        width: var(--label-w);
        height: var(--label-h);
        padding: 4mm;
        box-sizing:border-box;
        font-family: Arial, Tahoma, sans-serif;
      }
    }
  </style>
</head>

<body>
  <div class="toast" id="toast">ØªÙ… âœ…</div>

  <div class="app">
    <div class="top">
      <div class="head">
        <div class="logo"><img src="https://www.mad-parfumeur.com/assets/hero/logo.png" alt="MAD"></div>
        <div class="title">
          <b>Ù†Ø³Ø®Ø© Ø§Ù„ØªØ¬Ù‡ÙŠØ² (Ø¨ÙˆÙƒØ³ ÙƒØ¨ÙŠØ± + Ø·Ø¨Ø§Ø¹Ø©)</b>
          <span>ØªØ¸Ù‡Ø± ÙÙ‚Ø· Ø§Ù„Ø·Ù„Ø¨Ø§Øª Ø§Ù„Ù…ÙØ±Ø³Ù„Ø© Ù„Ù„ØªØ¬Ù‡ÙŠØ² â€” (Ø·Ø¨Ø§Ø¹Ø©) Ø«Ù… (ØªÙ… ØªØ¬Ù‡ÙŠØ²)</span>
        </div>
        <button class="iconBtn" onclick="sync()" title="ØªØ­Ø¯ÙŠØ«">â†»</button>
      </div>

      <div class="row">
        <div class="boxWhite">
          <label>ğŸ‘¤ Ø§Ø³Ù… Ø§Ù„Ù…ÙˆØ¸ÙØ©</label>
          <select id="emp" onchange="saveEmp()">
            <option value="">-- Ø§Ø®ØªØ§Ø±ÙŠ Ø§Ø³Ù…Ùƒ --</option>
            <option value="Ø¹Ø¨ÙŠØ± (×¢×‘×™×¨)">Ø¹Ø¨ÙŠØ± (×¢×‘×™×¨)</option>
            <option value="Ø£Ù„Ø§Ø¡ (××œ××)">Ø£Ù„Ø§Ø¡ (××œ××)</option>
            <option value="Ù„ÙŠÙ„Ù‰ (×œ×™×™×œ×)">Ù„ÙŠÙ„Ù‰ (×œ×™×™×œ×)</option>
          </select>
        </div>
      </div>

      <input id="q" class="search" placeholder="Ø¨Ø­Ø«..." oninput="render()">
    </div>

    <div class="content" id="list"></div>
  </div>

  <!-- Print Container -->
  <div id="print-container"></div>

  <!-- Edit Modal -->
  <div class="modalWrap" id="modalWrap" onclick="closeModal(event)">
    <div class="modal" onclick="event.stopPropagation()">
      <h3>âœï¸ ØªØ¹Ø¯ÙŠÙ„ ×”×–×× ×” (Ù„Ù„Ù…ÙˆØ¸Ù)</h3>

      <div class="field"><label>Ø§Ù„Ù…Ø¯ÙŠÙ†Ø© / ×›×ª×•×‘×ª</label><input id="m_city"></div>
      <div class="field"><label>×”×–×× ×” (C)</label><input id="m_offer"></div>
      <div class="field"><label>××—×™×¨ â‚ª</label><input id="m_price" inputmode="numeric"></div>
      <div class="field"><label>×”×¢×¨×•×ª</label><textarea id="m_notes" rows="3"></textarea></div>

      <div class="modalActions">
        <button class="btn btnClose" onclick="closeModal()">Ø¥ØºÙ„Ø§Ù‚</button>
        <button class="btn btnSave" onclick="saveEdit()">âœ… Ø­ÙØ¸ Ø§Ù„ØªØ¹Ø¯ÙŠÙ„</button>
      </div>
    </div>
  </div>

<script>
  const SCRIPT_URL = "https://script.google.com/macros/s/AKfycbw2QxGHOxMv7_uNbMulwO60IHOcKj16rbBJRfoltkwcdb2Bg4zrVjyMt_lf9KgnyyXl/exec";

  let all = [];
  let editing = null;

  function toast(msg){
    const t = document.getElementById("toast");
    t.textContent = msg;
    t.classList.add("show");
    setTimeout(()=>t.classList.remove("show"), 2200);
  }

  function isApproved(s){ s=String(s||""); return s.includes("Approved") || s.includes("×××•×©×¨"); }
  function isReady(s){ s=String(s||""); return s.includes("××•×›×Ÿ"); }
  function isDelivered(s){ s=String(s||""); return s.includes("Delivered"); }
  function isCanceled(s){ s=String(s||""); return s.includes("Canceled") || s.includes("âŒ"); }

  function parseDeliveryFromStatus(s){
    const m = String(s||"").match(/\(××©×œ×•×—:\s*(.*?)\)/);
    return m ? m[1] : "ØºÙŠØ± Ù…Ø­Ø¯Ø¯";
  }

  function saveEmp(){
    localStorage.setItem("mad_emp", document.getElementById("emp").value || "");
    toast("âœ… ØªÙ…");
    render();
  }
  function loadEmp(){
    document.getElementById("emp").value = localStorage.getItem("mad_emp") || "";
  }

  async function sync(){
    try{
      const res = await fetch(`${SCRIPT_URL}?action=get&t=${Date.now()}`, { cache:"no-store" });
      const data = await res.json();
      all = Array.isArray(data) ? data : [];
      render();
    }catch(e){
      all = [];
      render();
      toast("âš ï¸ Ø§ØªØµØ§Ù„");
    }
  }

  function render(){
    const q = (document.getElementById("q").value||"").toLowerCase();
    const emp = document.getElementById("emp").value || "";
    const rev = all.slice().reverse();

    const arr = rev.filter(o=>{
      const s = String(o.status||"");
      if (isDelivered(s) || isCanceled(s) || isReady(s)) return false;
      if (!isApproved(s)) return false;
      const match = String(o.name||"").toLowerCase().includes(q) ||
                    String(o.phone||"").includes(q) ||
                    String(o.offer||"").toLowerCase().includes(q);
      if(q && !match) return false;
      return true;
    });

    if(!arr.length){
      document.getElementById("list").innerHTML = `<div class="empty">Ù„Ø§ ÙŠÙˆØ¬Ø¯ Ø·Ù„Ø¨Ø§Øª Ù„Ù„ØªØ¬Ù‡ÙŠØ² Ø§Ù„Ø¢Ù† âœ…</div>`;
      return;
    }

    document.getElementById("list").innerHTML = arr.map(o=>{
      const delivery = parseDeliveryFromStatus(o.status||"");
      const price = String(o.price||"").replace(/[^\d]/g,"") || "150";
      const orderId = o.orderId || ("ROW-"+o.rowIndex);

      return `
        <div class="card">
          <div class="orderBox">
            <div class="boxTitle">ğŸ“¦ Ù…Ø±Ø¨Ø¹ ×”×–×× ×” (ÙƒÙ„ Ø§Ù„Ù…Ø¹Ù„ÙˆÙ…Ø§Øª)</div>

            <div class="infoRow"><span class="lbl">Ø±Ù‚Ù… ×”×–×× ×”</span><span class="val rtl">${escapeHtml(orderId)}</span></div>
            <div class="infoRow"><span class="lbl">Ø§Ø³Ù… Ø§Ù„Ø¹Ù…ÙŠÙ„</span><span class="val rtl">${escapeHtml(o.name||"-")}</span></div>
            <div class="infoRow"><span class="lbl">×˜×œ×¤×•×Ÿ</span><span class="val">${escapeHtml(o.phone||"-")}</span></div>
            <div class="infoRow"><span class="lbl">Ø§Ù„Ù…Ø¯ÙŠÙ†Ø©/×›×ª×•×‘×ª</span><span class="val rtl">${escapeHtml(o.city||"-")}</span></div>
            <div class="infoRow"><span class="lbl">Ø´Ø±ÙƒØ© ××©×œ×•×—</span><span class="val rtl">${escapeHtml(delivery)}</span></div>
            <div class="infoRow"><span class="lbl">××—×™×¨</span><span class="val rtl">â‚ª${escapeHtml(price)}</span></div>

            <div class="offerBox">ğŸ§¾ ×”×–×× ×”: ${escapeHtml(o.offer||"-")}</div>

            <div class="infoRow" style="border-bottom:none;padding-bottom:0">
              <span class="lbl">×”×¢×¨×•×ª</span>
              <span class="val rtl" style="direction:rtl;text-align:right">${escapeHtml(o.notes||"â€”")}</span>
            </div>
          </div>

          <div class="btns">
            <button class="btn btnPrint" onclick='printOrder(${safeJson(o)})'>ğŸ–¨ï¸ Ø·Ø¨Ø§Ø¹Ø©</button>
            <button class="btn btnEdit" onclick='openEdit(${safeJson(o)})'>âœï¸ ØªØ¹Ø¯ÙŠÙ„</button>
            <button class="btn btnReady" ${emp ? "" : "disabled"} onclick='finalize(${safeJson(o)})'>âœ… ØªÙ… ØªØ¬Ù‡ÙŠØ² ×”×–×× ×”</button>
          </div>

          ${emp ? "" : `<div style="margin-top:10px;color:#f59e0b;font-weight:1100;text-align:center">âš ï¸ Ø§Ø®ØªØ§Ø±ÙŠ Ø§Ø³Ù…Ùƒ Ù„ØªÙØ¹ÙŠÙ„ Ø²Ø± Ø§Ù„ØªØ¬Ù‡ÙŠØ²</div>`}
        </div>
      `;
    }).join("");
  }

  async function finalize(o){
    const emp = document.getElementById("emp").value || "";
    if(!emp){ toast("âŒ Ø§Ø®ØªØ§Ø±ÙŠ Ø§Ø³Ù…Ùƒ"); return; }

    const s = String(o.status||"");
    const m = s.match(/\(××©×œ×•×—:\s*(.*?)\)/);
    const del = m ? m[1] : "ØºÙŠØ± Ù…Ø­Ø¯Ø¯";

    const status = `××•×›×Ÿ ×¢×œ ×™×“×™ ${emp} (××©×œ×•×—: ${del})`;
    await updateStatus(o.rowIndex, o.orderId, status);
    toast("âœ… ØªÙ… ØªØ¬Ù‡ÙŠØ² ×”×–×× ×”");
    setTimeout(sync, 500);
  }

  async function updateStatus(row, orderId, status){
    try{
      await fetch(`${SCRIPT_URL}?action=updateStatus&row=${encodeURIComponent(row)}&orderId=${encodeURIComponent(orderId)}&status=${encodeURIComponent(status)}&t=${Date.now()}`, { cache:"no-store" });
    }catch(e){
      toast("âš ï¸ ÙØ´Ù„ ØªØ­Ø¯ÙŠØ« Ø§Ù„Ø­Ø§Ù„Ø©");
    }
  }

  function openEdit(o){
    editing = { rowIndex: o.rowIndex, orderId: o.orderId };
    const price = String(o.price||"").replace(/[^\d]/g,"") || "150";
    document.getElementById("m_city").value = o.city || "";
    document.getElementById("m_offer").value = o.offer || "";
    document.getElementById("m_price").value = price;
    document.getElementById("m_notes").value = o.notes || "";
    document.getElementById("modalWrap").style.display = "flex";
  }

  function closeModal(){ document.getElementById("modalWrap").style.display = "none"; }

  async function saveEdit(){
    if(!editing) return;

    const city = (document.getElementById("m_city").value||"").trim();
    const offer = (document.getElementById("m_offer").value||"").trim();
    const price = String(document.getElementById("m_price").value||"150").replace(/[^\d]/g,"") || "150";
    const notes = (document.getElementById("m_notes").value||"").trim();

    try{
      await fetch(`${SCRIPT_URL}?action=updateOrder&row=${encodeURIComponent(editing.rowIndex)}&orderId=${encodeURIComponent(editing.orderId)}`
        + `&city=${encodeURIComponent(city)}&offer=${encodeURIComponent(offer)}&price=${encodeURIComponent(price)}&notes=${encodeURIComponent(notes)}`
        + `&address=${encodeURIComponent(city)}&t=${Date.now()}`, { cache:"no-store" });

      toast("âœ… ØªÙ… Ø§Ù„ØªØ¹Ø¯ÙŠÙ„");
      closeModal();
      setTimeout(sync, 500);
    }catch(e){
      toast("âš ï¸ ÙØ´Ù„ Ø§Ù„ØªØ¹Ø¯ÙŠÙ„");
    }
  }

  // âœ… PRINT ORDER (TSC DA220)
  function printOrder(o){
    const delivery = parseDeliveryFromStatus(o.status||"");
    const price = String(o.price||"").replace(/[^\d]/g,"") || "150";
    const orderId = o.orderId || ("ROW-"+o.rowIndex);

    const container = document.getElementById("print-container");
    container.innerHTML = `
      <div class="print-page" dir="rtl">
        <div style="display:flex;align-items:center;justify-content:space-between;border-bottom:2px solid #000;padding-bottom:2mm;">
          <div style="font-size:14pt;font-weight:900;">MAD</div>
          <div style="font-size:10pt;font-weight:700;">Order: ${escapeHtml(orderId)}</div>
        </div>

        <div style="margin-top:3mm;font-size:10.5pt;line-height:1.35">
          <div><b>×©×:</b> ${escapeHtml(o.name||"-")}</div>
          <div><b>×˜×œ×¤×•×Ÿ:</b> ${escapeHtml(o.phone||"-")}</div>
          <div><b>×›×ª×•×‘×ª:</b> ${escapeHtml(o.city||"-")}</div>
          <div><b>××©×œ×•×—:</b> ${escapeHtml(delivery)}</div>
          <div><b>××—×™×¨:</b> â‚ª${escapeHtml(price)}</div>
        </div>

        <div style="margin-top:3mm;border:1.5px solid #000;padding:2mm;background:#f3f4f6;font-size:11pt;font-weight:900;">
          ${escapeHtml(o.offer||"-")}
        </div>

        <div style="margin-top:2mm;font-size:8.5pt;color:#111;">
          <b>×”×¢×¨×•×ª:</b> ${escapeHtml(o.notes||"â€”")}
        </div>

        <div style="margin-top:3mm;text-align:center;">
          <svg id="bcode_gen"></svg>
          <div style="font-size:8pt;margin-top:1mm;">${escapeHtml(o.phone||"")}</div>
        </div>

        <div style="margin-top:2mm;border:1px dashed #d00;color:#d00;padding:1.5mm;text-align:center;font-size:8pt;font-weight:900;">
          ×”×—×œ×¤×” ×¨×§ ×× ×”× ×™×™×œ×•×Ÿ ×œ× × ×¤×ª×—
        </div>
      </div>
    `;

    // Ø¨Ø§Ø±ÙƒÙˆØ¯ (Ù‡Ø§ØªÙ Ø£Ùˆ OrderID)
    try{
      const code = String(o.phone||orderId||"").replace(/\D/g,"") || String(orderId||"");
      JsBarcode("#bcode_gen", code, { format:"CODE128", width:2, height:42, displayValue:false, margin:0 });
    }catch(e){}

    // Ø§Ø·Ø¨Ø¹
    setTimeout(()=>window.print(), 200);
  }

  function escapeHtml(str){
    return String(str ?? "").replace(/[&<>"']/g, s => ({ "&":"&amp;","<":"&lt;",">":"&gt;",'"':"&quot;","'":"&#39;" }[s]));
  }
  function safeJson(obj){
    return JSON.stringify(obj).replace(/</g,"\\u003c").replace(/>/g,"\\u003e").replace(/&/g,"\\u0026");
  }

  loadEmp();
  sync();
  setInterval(sync, 20000);
</script>
</body>
</html>
