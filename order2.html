<!doctype html>
<html lang="ar" dir="rtl">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width,initial-scale=1,maximum-scale=1,user-scalable=0"/>
  <title>MAD Manager v5.4 - Audio Fix</title>
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">

  <style>
    :root {
      --bg: #0a0f1e;
      --card: #161b2c;
      --primary: #3b82f6;
      --success: #10b981;
      --ready: #f59e0b;
      --hebrew: #8b5cf6;
      --danger: #ef4444;
      --text: #f8fafc;
      --muted: #94a3b8;
      --border: rgba(255,255,255,0.08);
      --grad: linear-gradient(135deg, #3b82f6 0%, #2563eb 100%);
    }

    body {
      margin: 0; font-family: 'Segoe UI', Roboto, system-ui, sans-serif;
      background: var(--bg); color: var(--text); padding-bottom: 90px;
      line-height: 1.5;
    }

    .header {
      background: rgba(16, 21, 36, 0.85); backdrop-filter: blur(12px);
      padding: 12px 16px; position: sticky; top: 0; z-index: 100;
      border-bottom: 1px solid var(--border);
    }

    .tab-container {
      display: flex; background: rgba(255,255,255,0.05); border-radius: 12px;
      padding: 4px; margin-top: 10px; gap: 4px;
    }
    .tab-btn {
      flex: 1; padding: 10px; border-radius: 8px; border: none;
      background: transparent; color: var(--muted); font-weight: bold;
      cursor: pointer; transition: 0.3s; font-size: 14px;
      display: flex; align-items: center; justify-content: center; gap: 8px;
    }
    .tab-btn.active {
      background: var(--primary); color: white; box-shadow: 0 4px 12px rgba(59, 130, 246, 0.3);
    }

    .container { padding: 16px; max-width: 600px; margin: 0 auto; }

    .order-card {
      background: var(--card); border-radius: 24px; padding: 20px;
      margin-bottom: 20px; border: 1px solid var(--border);
      box-shadow: 0 10px 25px rgba(0,0,0,0.4);
      transition: transform 0.2s;
    }

    .card-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 12px; }
    .order-id { font-family: monospace; color: var(--muted); background: rgba(255,255,255,0.05); padding: 2px 8px; border-radius: 6px; font-size: 13px; }

    .status-pill { font-size: 11px; padding: 4px 12px; border-radius: 20px; font-weight: 700; text-transform: uppercase; }
    .status-new { background: rgba(59, 130, 246, 0.1); color: #60a5fa; }
    .status-prep { background: rgba(245, 158, 11, 0.1); color: var(--ready); }
    .status-ready { background: rgba(16, 185, 129, 0.1); color: var(--success); }

    .customer-name { font-size: 19px; font-weight: 800; display: block; margin-bottom: 4px; }
    
    .offer-details {
      margin: 12px 0; padding: 12px; background: rgba(59, 130, 246, 0.05);
      border-radius: 12px; color: #93c5fd; font-weight: 600; border-right: 3px solid var(--primary);
      font-size: 14px;
    }

    .meta-line { display: flex; flex-wrap: wrap; gap: 10px; font-size: 12px; color: var(--muted); margin-top: 8px; }
    .meta-tag { background: rgba(255,255,255,0.05); padding: 2px 8px; border-radius: 6px; }

    .actions-grid { display: grid; grid-template-columns: repeat(4, 1fr); gap: 8px; margin-top: 20px; }
    .actions-secondary { display: grid; grid-template-columns: 1fr 1fr; gap: 8px; margin-top: 8px; }

    .btn {
      padding: 10px 4px; border-radius: 14px; border: none; font-weight: 700;
      cursor: pointer; display: flex; flex-direction: column; align-items: center; justify-content: center;
      font-size: 10px; transition: 0.2s; gap: 6px; text-decoration: none;
    }
    .btn i { font-size: 18px; }
    .btn-primary { background: var(--grad); color: white; }
    .btn-success { background: #059669; color: white; }
    .btn-ready { background: var(--ready); color: white; }
    .btn-wa-ar { background: #d97706; color: white; }
    .btn-wa-he { background: #7c3aed; color: white; }
    .btn-outline { background: rgba(255,255,255,0.03); color: white; border: 1px solid var(--border); }

    .modal-overlay {
      position: fixed; inset: 0; background: rgba(0,0,0,0.8); backdrop-filter: blur(8px);
      display: none; align-items: center; justify-content: center; z-index: 2000; padding: 20px;
    }
    .modal-overlay.show { display: flex; }
    .modal-content { background: var(--card); width: 100%; max-width: 450px; padding: 24px; border-radius: 32px; border: 1px solid var(--border); overflow-y: auto; max-height: 90vh; }

    input, select, textarea { width: 100%; padding: 12px; margin-bottom: 12px; border-radius: 12px; border: 1px solid var(--border); background: rgba(0,0,0,0.2); color: white; outline: none; font-size: 15px; box-sizing: border-box; }

    .invoice-box { background: white; color: black; width: 98mm; height: 98mm; padding: 6mm; box-sizing: border-box; display: flex; flex-direction: column; position: relative; border-radius: 2px; }
    .inv-header { text-align: center; border-bottom: 2px solid #000; padding-bottom: 5px; margin-bottom: 8px; }
    .inv-body { font-size: 11px; flex-grow: 1; line-height: 1.4; overflow: hidden; }
    .inv-row { display: flex; margin-bottom: 2px; gap: 5px; }
    .inv-label { font-weight: 800; min-width: 75px; }
    .inv-footer { border-top: 2px solid #000; padding-top: 5px; display: flex; justify-content: space-between; align-items: flex-end; }

    #toast { position: fixed; bottom: 30px; left: 50%; transform: translateX(-50%); background: #10b981; color: white; padding: 14px 28px; border-radius: 50px; font-weight: 700; z-index: 3000; display: none; box-shadow: 0 10px 20px rgba(0,0,0,0.3); }
    #loadingOverlay { position: fixed; inset: 0; background: rgba(6, 9, 20, 0.7); z-index: 4000; display: none; align-items: center; justify-content: center; backdrop-filter: blur(4px); }
    .spinner { width: 44px; height: 44px; border: 4px solid rgba(59, 130, 246, 0.1); border-top-color: var(--primary); border-radius: 50%; animation: spin 0.8s infinite; }
    @keyframes spin { to { transform: rotate(360deg); } }

    @media print {
      body * { visibility: hidden; }
      #invoicePreview, #invoicePreview * { visibility: visible; }
      #invoicePreview { position: fixed; left: 0; top: 0; width: 98mm; height: 98mm; border: none; padding: 6mm; margin: 0; }
      .no-print { display: none !important; }
      @page { size: 98mm 98mm; margin: 0; }
    }
  </style>
</head>
<body onclick="enableAudio()"> <!-- ØªÙØ¹ÙŠÙ„ Ø§Ù„ØµÙˆØª Ø¹Ù†Ø¯ Ø£ÙˆÙ„ Ø¶ØºØ·Ø© Ù„Ù„Ù…Ø³ØªØ®Ø¯Ù… -->

<div id="loadingOverlay"><div class="spinner"></div></div>
<div id="toast">âœ… ØªÙ…Øª Ø§Ù„Ø¹Ù…Ù„ÙŠØ©</div>

<!-- Ù†Ø§ÙØ°Ø© Ù…Ø¹Ø§ÙŠÙ†Ø© Ø§Ù„ÙØ§ØªÙˆØ±Ø© -->
<div class="modal-overlay" id="printModal">
  <div class="invoice-box" id="invoicePreview">
    <div class="inv-header">
      <h1 style="margin:0; font-size: 28px; letter-spacing: 3px; font-weight: 900;">MAD</h1>
      <div style="font-size: 10px; font-weight: 800; color: #333;">PARFUMEUR</div>
      <div style="display: flex; justify-content: space-between; font-size: 9px; font-weight: 900; margin-top:5px; border-top: 1px solid #eee; padding-top: 3px;">
        <span id="p_date_label">ØªØ§Ø±ÙŠØ®: 00.00.0000</span>
        <span id="p_ord_label">Ø·Ù„Ø¨: MAD-00000</span>
      </div>
    </div>
    
    <div class="inv-body" id="p_content_lang"></div>

    <div class="inv-footer">
      <div style="text-align:center;">
        <img id="p_qr" src="" style="width:40px; height:40px; border:1px solid #000;">
        <div id="p_footer_phone" style="font-size:8px; font-weight:900; margin-top:4px;"></div>
      </div>
      <div id="p_promo" style="font-size: 8px; text-align: center; flex: 1; padding: 0 8px; font-weight: 800; line-height: 1.2;"></div>
      <div style="text-align: left;">
        <div id="p_label_total" style="font-size: 10px; font-weight: 700;">Ø§Ù„Ù…Ø¬Ù…ÙˆØ¹:</div>
        <div style="font-size: 22px; font-weight: 900; color: #000;">â‚ª<span id="p_total">0</span></div>
      </div>
    </div>

    <div style="position: absolute; bottom: -75px; left: 0; right: 0; display: flex; gap: 12px; justify-content: center;" class="no-print">
      <button class="btn btn-outline" onclick="closeModal('printModal')" style="flex-direction:row; padding:10px 20px; font-size: 14px;">Ø¥Ù„ØºØ§Ø¡</button>
      <button class="btn btn-primary" onclick="window.print()" style="flex-direction:row; padding:10px 20px; font-size: 14px;"><i class="fa fa-print"></i> Ø·Ø¨Ø§Ø¹Ø©</button>
    </div>
  </div>
</div>

<!-- Ù†Ø§ÙØ°Ø© Ø¥Ø¶Ø§ÙØ©/ØªØ¹Ø¯ÙŠÙ„ Ø·Ù„Ø¨ -->
<div class="modal-overlay" id="orderModal">
  <div class="modal-content">
    <h3 id="modalTitle">Ø¥Ø¶Ø§ÙØ© Ø·Ù„Ø¨ Ø¬Ø¯ÙŠØ¯</h3>
    
    <div class="smart-box" id="smartSection">
        <textarea id="smartInput" placeholder="Ø§Ù„ØµÙ‚ Ù†Øµ Ø§Ù„Ø·Ù„Ø¨ Ù„Ù„ØªØ­Ù„ÙŠÙ„ Ø§Ù„Ø³Ø±ÙŠØ¹..." style="height: 60px; margin-bottom: 8px; font-size: 13px;"></textarea>
        <button class="btn btn-primary" onclick="analyzeText()" style="width: 100%; flex-direction: row; height: 35px; font-size: 13px;">ØªØ­Ù„ÙŠÙ„ Ø°ÙƒÙŠ âš¡</button>
    </div>

    <label>Ø§Ù„Ø§Ø³Ù…</label><input type="text" id="f_name">
    <label>Ø§Ù„Ù‡Ø§ØªÙ</label><input type="tel" id="f_phone">
    <label>Ø§Ù„Ø£ØµÙ†Ø§Ù</label><textarea id="f_offer" rows="2"></textarea>
    <div style="display:grid; grid-template-columns: 1fr 1fr; gap:10px;">
      <input type="number" id="f_price" placeholder="Ø§Ù„Ø³Ø¹Ø±">
      <select id="f_payment">
          <option value="Ø¯ÙØ¹ Ø¹Ù†Ø¯ Ø§Ù„Ø§Ø³ØªÙ„Ø§Ù…">Ø¯ÙØ¹ Ø¹Ù†Ø¯ Ø§Ù„Ø§Ø³ØªÙ„Ø§Ù…</option>
          <option value="Ø´Ø±Ø§Ø¡ Ù…Ù† Ø§Ù„Ù…ÙˆÙ‚Ø¹ - Ù…Ø¯ÙÙˆØ¹">Ø´Ø±Ø§Ø¡ Ù…Ù† Ø§Ù„Ù…ÙˆÙ‚Ø¹ - Ù…Ø¯ÙÙˆØ¹</option>
          <option value="Ø´Ø±Ø§Ø¡ Ø¹Ø¨Ø± Ø§Ù„Ø±Ø§Ø¨Ø·">Ø´Ø±Ø§Ø¡ Ø¹Ø¨Ø± Ø§Ù„Ø±Ø§Ø¨Ø·</option>
      </select>
    </div>
    <input type="text" id="f_city" placeholder="Ø§Ù„Ù…Ø¯ÙŠÙ†Ø©">
    <textarea id="f_notes" rows="2" placeholder="Ù…Ù„Ø§Ø­Ø¸Ø§Øª..."></textarea>
    <select id="f_delivery">
      <option value="">Ø´Ø±ÙƒØ© Ø§Ù„Ø´Ø­Ù†</option>
      <option value="High Express (050-9566919)">High Express</option>
      <option value="Lama (050-5102019)">Lama</option>
      <option value="Marwah (052-7035370)">Marwah</option>
      <option value="Areen (052-5118966)">Areen</option>
      <option value="Pickup">Pickup</option>
    </select>
    <div style="display:grid; grid-template-columns: 1fr 1fr; gap:10px; margin-top:10px;">
      <button class="btn btn-outline" onclick="closeModal('orderModal')">Ø¥Ù„ØºØ§Ø¡</button>
      <button class="btn btn-primary" onclick="saveOrder()">Ø­ÙØ¸ Ø§Ù„Ø·Ù„Ø¨ âœ¨</button>
    </div>
  </div>
</div>

<div class="header">
  <div class="header-top" style="display:flex; justify-content:space-between; align-items:center;">
    <div class="logo" style="font-weight:900; font-size:20px;">MAD <span>MANAGER</span></div>
    <div style="display:flex; gap:10px;">
      <button class="btn btn-outline" onclick="load()" style="width:40px; height:40px;"><i class="fa fa-sync"></i></button>
      <button class="btn btn-primary" onclick="openAddModal()" style="width:40px; height:40px;"><i class="fa fa-plus"></i></button>
    </div>
  </div>
  
  <div class="tab-container">
    <button class="tab-btn active" id="tabPrep" onclick="switchView('prep')"><i class="fa fa-box-open"></i> Ù‚Ø³Ù… Ø§Ù„ØªØ¬Ù‡ÙŠØ²</button>
    <button class="tab-btn" id="tabManager" onclick="switchView('manager')"><i class="fa fa-tasks"></i> Ø§Ù„Ø¥Ø¯Ø§Ø±Ø©</button>
  </div>

  <div style="margin-top:10px;">
    <input type="text" id="searchInput" placeholder="Ø¨Ø­Ø« Ø¨Ø§Ù„Ø§Ø³Ù… Ø£Ùˆ Ø±Ù‚Ù… Ø§Ù„Ù‡Ø§ØªÙ..." oninput="filterOrders()" style="margin-bottom:0; background:rgba(255,255,255,0.05);">
  </div>
</div>

<div class="container" id="ordersList"></div>

<script>
const SCRIPT_URL = "https://script.google.com/macros/s/AKfycbwWi55Q1H1HNdJb61Ht99ZiZodp4B4aaElWSqSuxo37zhKUwRgy8T-NHNPffH4i_Y89Eg/exec";
const DASH_KEY = "12345678";
let allOrders = [];
let lastKnownOrderId = null; 
let currentView = 'prep'; 
let audioEnabled = false;

function showLoading(s) { document.getElementById('loadingOverlay').style.display = s ? 'flex' : 'none'; }
function showToast(m) { const t = document.getElementById('toast'); t.textContent = m; t.style.display = 'block'; setTimeout(() => t.style.display = 'none', 2500); }

// ØªÙØ¹ÙŠÙ„ Ø§Ù„ØµÙˆØª Ù…Ù† Ø®Ù„Ø§Ù„ ØªÙØ§Ø¹Ù„ Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù… (Ø¶Ø±ÙˆØ±ÙŠ Ù„Ù„Ù…ØªØµÙØ­Ø§Øª)
function enableAudio() {
  if (!audioEnabled) {
    console.log("Audio Engine Activated âœ…");
    audioEnabled = true;
    // Ù†Ø·Ù‚ Ù†Øµ ÙØ§Ø±Øº "Ù„ÙØªØ­" Ø§Ù„Ù…Ø­Ø±Ùƒ
    const msg = new SpeechSynthesisUtterance("");
    window.speechSynthesis.speak(msg);
  }
}

function announceNewOrder() {
  if (audioEnabled && 'speechSynthesis' in window) {
    window.speechSynthesis.cancel(); // Ø¥ÙŠÙ‚Ø§Ù Ø£ÙŠ ÙƒÙ„Ø§Ù… Ø³Ø§Ø¨Ù‚
    const msg = new SpeechSynthesisUtterance("Ù„Ø¯ÙŠÙƒ Ø·Ù„Ø¨ÙŠØ© Ø¬Ø¯ÙŠØ¯Ø©");
    msg.lang = 'ar-SA';
    msg.rate = 1.0;
    msg.volume = 1.0;
    window.speechSynthesis.speak(msg);
  }
}

const safe = (v) => (v === undefined || v === null || String(v).toLowerCase()==="undefined") ? "" : String(v).trim();

function formatLocalPhone(p) {
  if(!p) return "";
  let d = String(p).replace(/\D/g, "");
  if (d.startsWith("972")) d = "0" + d.substring(3);
  return d.startsWith("0") ? d : "0" + d;
}

function normalizePhoneForLink(p) { 
  let d = String(p||"").replace(/\D/g, ""); 
  if (d.startsWith("0")) d = "972" + d.substring(1); 
  return d; 
}

function switchView(view) {
  currentView = view;
  document.getElementById('tabManager').classList.toggle('active', view === 'manager');
  document.getElementById('tabPrep').classList.toggle('active', view === 'prep');
  renderOrders(allOrders);
}

async function load(isAuto = false) {
  if(!isAuto) showLoading(true);
  try {
    const res = await fetch(`${SCRIPT_URL}?action=get&_=${Date.now()}`);
    const data = await res.json();
    
    if (data && data.length > 0) {
        // ØªØ±ØªÙŠØ¨ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ù„Ù„Ø­ØµÙˆÙ„ Ø¹Ù„Ù‰ Ø¢Ø®Ø± ID
        const latestOnServer = data[data.length - 1].orderId;
        
        // Ø¥Ø°Ø§ ÙƒØ§Ù† Ù‡Ù†Ø§Ùƒ ID Ø¬Ø¯ÙŠØ¯ØŒ Ø£Ø·Ù„Ù‚ Ø§Ù„Ø¥Ø´Ø¹Ø§Ø±
        if (lastKnownOrderId !== null && latestOnServer != lastKnownOrderId) {
            console.log("New Order Detected: ", latestOnServer);
            announceNewOrder();
        }
        lastKnownOrderId = latestOnServer;
    }

    allOrders = data;
    renderOrders(allOrders);
  } catch(e) { console.error("Sync Error"); }
  if(!isAuto) showLoading(false);
}

// Ù…Ø¤Ù‚Øª Ø§Ù„ØªØ­Ø¯ÙŠØ« Ø§Ù„ØªÙ„Ù‚Ø§Ø¦ÙŠ ÙƒÙ„ 60 Ø«Ø§Ù†ÙŠØ©
setInterval(() => {
    console.log("Auto-Refreshing...");
    load(true);
}, 60000);

function filterOrders() {
    const term = document.getElementById('searchInput').value.toLowerCase();
    const filtered = allOrders.filter(o => safe(o.name).toLowerCase().includes(term) || safe(o.phone).includes(term));
    renderOrders(filtered);
}

function renderOrders(list) {
  const container = document.getElementById('ordersList');
  let displayList = [...list].filter(o => o.rowIndex).reverse();

  if (displayList.length === 0) {
      container.innerHTML = `<div style="text-align:center; padding:50px; color:var(--muted);">Ù„Ø§ ØªÙˆØ¬Ø¯ Ø¨ÙŠØ§Ù†Ø§Øª</div>`;
      return;
  }

  if (currentView === 'prep') {
    displayList = displayList.filter(o => safe(o.status).includes("Ø¨Ø§Ù†ØªØ¸Ø§Ø± Ø§Ù„Ø¥Ø±Ø³Ø§Ù„ Ù„Ù„ØªØ¬Ù‡ÙŠØ²"));
    if (displayList.length === 0) {
      container.innerHTML = `<div style="text-align:center; padding:50px; color:var(--muted);">ğŸ‰ Ù„Ø§ ØªÙˆØ¬Ø¯ Ø·Ù„Ø¨Ø§Øª Ø¨Ø§Ù†ØªØ¸Ø§Ø± Ø§Ù„ØªØ¬Ù‡ÙŠØ² Ø­Ø§Ù„ÙŠØ§Ù‹</div>`;
      return;
    }
  }

  container.innerHTML = displayList.map(o => {
    const s = safe(o.status);
    const isWaitingPrep = s.includes("Ø¨Ø§Ù†ØªØ¸Ø§Ø± Ø§Ù„Ø¥Ø±Ø³Ø§Ù„ Ù„Ù„ØªØ¬Ù‡ÙŠØ²");
    
    return `
    <div class="order-card">
      <div class="card-header">
        <small class="order-id">#${safe(o.orderId) || '---'}</small>
        <span class="status-pill ${isWaitingPrep ? 'status-prep' : 'status-new'}">${s || 'Ø¬Ø¯ÙŠØ¯'}</span>
      </div>
      <div onclick="openEditModal(${o.rowIndex})">
        <span class="customer-name">${safe(o.name)}</span>
        <div style="font-size:14px; color:var(--muted);"><i class="fa fa-phone"></i> ${formatLocalPhone(o.phone)}</div>
        <div class="offer-details">${safe(o.offer)}</div>
        <div class="meta-line">
           <span class="meta-tag">ğŸ“ ${safe(o.city)}</span>
           <span class="meta-tag">â‚ª${safe(o.price)}</span>
           <span class="meta-tag">ğŸšš ${safe(o.delivery).split(' (')[0]}</span>
        </div>
      </div>
      <div class="actions-grid">
        ${currentView === 'manager' ? `
          <button class="btn btn-wa-ar" onclick="sendMsg(${o.rowIndex}, 'ar')"><i class="fa-brands fa-whatsapp"></i><span>Ø¹Ø±Ø¨ÙŠ</span></button>
          <button class="btn btn-wa-he" onclick="sendMsg(${o.rowIndex}, 'he')"><i class="fa-brands fa-whatsapp"></i><span>Ø¹Ø¨Ø±ÙŠ</span></button>
          <button class="btn btn-success" onclick="updateStatus(${o.rowIndex}, 'Ø¨Ø§Ù†ØªØ¸Ø§Ø± Ø§Ù„Ø¥Ø±Ø³Ø§Ù„ Ù„Ù„ØªØ¬Ù‡ÙŠØ²')"><i class="fa fa-check"></i><span>Ø§Ø¹ØªÙ…Ø§Ø¯</span></button>
          <button class="btn btn-outline" onclick="openEditModal(${o.rowIndex})"><i class="fa fa-edit"></i><span>ØªØ¹Ø¯ÙŠÙ„</span></button>
        ` : `
          <button class="btn btn-success" style="grid-column: span 2;" onclick="updateStatus(${o.rowIndex}, 'Ø¬Ø§Ù‡Ø² Ù„Ù„ØªØ³Ù„ÙŠÙ…')"><i class="fa fa-box-check"></i><span>ØªÙ… Ø§Ù„ØªØ¬Ù‡ÙŠØ² âœ…</span></button>
          <button class="btn btn-outline" onclick="openPrintModal(${o.rowIndex}, 'ar')"><i class="fa fa-print"></i><span>ÙˆØµÙ„ Ø¹</span></button>
          <button class="btn btn-outline" onclick="openPrintModal(${o.rowIndex}, 'he')"><i class="fa fa-print"></i><span>ÙˆØµÙ„ Ù‡Ù€</span></button>
        `}
      </div>
      ${currentView === 'manager' ? `
      <div class="actions-secondary">
        <button class="btn btn-outline" onclick="openPrintModal(${o.rowIndex}, 'ar')"><i class="fa fa-print"></i><span>ÙˆØµÙ„ Ø¹Ø±Ø¨ÙŠ</span></button>
        <button class="btn btn-outline" onclick="openPrintModal(${o.rowIndex}, 'he')"><i class="fa fa-print"></i><span>ÙˆØµÙ„ Ø¹Ø¨Ø±ÙŠ</span></button>
      </div>` : ''}
    </div>`;
  }).join('');
}

async function updateStatus(row, newStatus) {
  showLoading(true);
  const o = allOrders.find(x => x.rowIndex == row);
  const p = new URLSearchParams({
    action: "updateOrder", key: DASH_KEY, row: row,
    offer: safe(o.offer), name: safe(o.name), phone: safe(o.phone), 
    city: safe(o.city), notes: safe(o.notes), 
    delivery: safe(o.delivery), payment: safe(o.payment), price: safe(o.price),
    status: newStatus
  });
  try {
    await fetch(`${SCRIPT_URL}?${p.toString()}`);
    showToast("ØªÙ… ØªØ­Ø¯ÙŠØ« Ø§Ù„Ø­Ø§Ù„Ø© âœ¨");
    load();
  } catch(e) { showToast("Ø®Ø·Ø£ ÙÙŠ Ø§Ù„ØªØ­Ø¯ÙŠØ«"); showLoading(false); }
}

async function sendMsg(row, lang) {
  const o = allOrders.find(x => x.rowIndex == row);
  if(!o) return;
  const paymentMethod = safe(o.payment) || "Ø¯ÙØ¹ Ø¹Ù†Ø¯ Ø§Ù„Ø§Ø³ØªÙ„Ø§Ù…";
  const note = safe(o.notes) ? `%0AğŸ“ Ù…Ù„Ø§Ø­Ø¸Ø©: ${safe(o.notes)}` : "";
  const deliveryComp = safe(o.delivery) ? `%0AğŸšš Ø´Ø±ÙƒØ© Ø§Ù„ØªÙˆØµÙŠÙ„: ${safe(o.delivery)}` : "";
  const msg = lang === 'ar' ? 
    `Ø£Ù‡Ù„Ø§Ù‹ Ø¨Ùƒ ${safe(o.name)} ÙÙŠ MAD Parfumeur ğŸ–¤%0AÙŠØ³Ø¹Ø¯Ù†Ø§ ØªØ£ÙƒÙŠØ¯ Ø·Ù„Ø¨Ùƒ Ø§Ù„Ù…Ù…ÙŠØ²!%0AğŸ’ Ø§Ù„Ø¹Ø±Ø¶: ${safe(o.offer)}%0AğŸ“ Ø§Ù„Ø¹Ù†ÙˆØ§Ù†: ${safe(o.city)}%0AğŸ’° Ø§Ù„Ø³Ø¹Ø±: ${safe(o.price)} â‚ª%0AğŸ’³ Ø§Ù„Ø¯ÙØ¹: ${paymentMethod}${deliveryComp}${note}` :
    `×©×œ×•× ${safe(o.name)} ğŸ‘‹, ×ª×•×“×” ×©×”×–×× ×ª ×-MAD Parfumeur%0AğŸ“¦ ×”××•×¦×¨: ${safe(o.offer)}%0AğŸ“ ×›×ª×•×‘×ª: ${safe(o.city)}%0AğŸ’° ××—×™×¨: ${safe(o.price)} â‚ª%0AğŸ’³ ×ª×©×œ×•×: ${paymentMethod}${deliveryComp}`;
  window.open(`https://wa.me/${normalizePhoneForLink(o.phone)}?text=${msg}`, '_blank');
}

function openAddModal() {
  editingRow = null;
  document.getElementById('modalTitle').textContent = "Ø¥Ø¶Ø§ÙØ© Ø·Ù„Ø¨ Ø¬Ø¯ÙŠØ¯";
  document.getElementById('smartSection').style.display = 'block';
  ['smartInput','f_name','f_phone','f_offer','f_price','f_city','f_notes'].forEach(id => document.getElementById(id).value = "");
  document.getElementById('orderModal').classList.add('show');
}

function openEditModal(row) {
  const o = allOrders.find(x => x.rowIndex == row);
  if(!o) return;
  editingRow = row;
  document.getElementById('modalTitle').textContent = "ØªØ¹Ø¯ÙŠÙ„ Ø§Ù„Ø·Ù„Ø¨";
  document.getElementById('smartSection').style.display = 'none';
  document.getElementById('f_name').value = safe(o.name);
  document.getElementById('f_phone').value = formatLocalPhone(o.phone);
  document.getElementById('f_offer').value = safe(o.offer);
  document.getElementById('f_price').value = safe(o.price);
  document.getElementById('f_payment').value = safe(o.payment) || "Ø¯ÙØ¹ Ø¹Ù†Ø¯ Ø§Ù„Ø§Ø³ØªÙ„Ø§Ù…";
  document.getElementById('f_city').value = safe(o.city);
  document.getElementById('f_notes').value = safe(o.notes);
  document.getElementById('f_delivery').value = safe(o.delivery);
  document.getElementById('orderModal').classList.add('show');
}

async function saveOrder() {
  const isAdd = !editingRow;
  showLoading(true);
  const payload = {
    action: isAdd ? "addOrder" : "updateOrder", 
    key: DASH_KEY, row: editingRow || "",
    name: safe(document.getElementById('f_name').value),
    phone: safe(document.getElementById('f_phone').value),
    offer: safe(document.getElementById('f_offer').value),
    price: safe(document.getElementById('f_price').value),
    city: safe(document.getElementById('f_city').value),
    notes: safe(document.getElementById('f_notes').value),
    payment: safe(document.getElementById('f_payment').value),
    delivery: safe(document.getElementById('f_delivery').value),
    status: isAdd ? "NEW" : (allOrders.find(x=>x.rowIndex==editingRow).status || "NEW")
  };
  try {
    const res = await fetch(`${SCRIPT_URL}?` + new URLSearchParams(payload).toString());
    const data = await res.json();
    if(data.result === "SUCCESS") {
      showToast(isAdd ? "ØªÙ…Øª Ø¥Ø¶Ø§ÙØ© Ø§Ù„Ø·Ù„Ø¨ âœ¨" : "ØªÙ… Ø§Ù„Ø­ÙØ¸ âœ¨");
      closeModal('orderModal');
      load();
    }
  } catch(e) { showToast("ÙØ´Ù„ Ø§Ù„Ø­ÙØ¸"); showLoading(false); }
}

function openPrintModal(row, lang) {
    const o = allOrders.find(x => x.rowIndex == row);
    if (!o) return;
    const now = new Date();
    const formattedDate = `${now.getDate()}.${now.getMonth()+1}.${now.getFullYear()}`;
    const cleanP = formatLocalPhone(o.phone);
    
    document.getElementById('p_date_label').textContent = lang === 'ar' ? `ØªØ§Ø±ÙŠØ®: ${formattedDate}` : `×ª××¨×™×š: ${formattedDate}`;
    document.getElementById('p_ord_label').textContent = lang === 'ar' ? `Ø·Ù„Ø¨: MAD-${safe(o.orderId) || "0000"}` : `××¡' ×”×–×× ×”: MAD-${safe(o.orderId) || "0000"}`;
    document.getElementById('p_label_total').textContent = lang === 'ar' ? `Ø§Ù„Ù…Ø¬Ù…ÙˆØ¹:` : `×œ×ª×©×œ×•×:`;
    document.getElementById('p_total').textContent = safe(o.price) || "0";
    document.getElementById('p_footer_phone').textContent = cleanP;
    document.getElementById('p_qr').src = `https://api.qrserver.com/v1/create-qr-code/?size=100x100&data=https://wa.me/${normalizePhoneForLink(o.phone)}`;
    
    const body = document.getElementById('p_content_lang');
    body.style.direction = "rtl";
    
    if (lang === 'ar') {
        document.getElementById('p_promo').innerHTML = "ğŸ ØµÙˆØ± Ø§Ù„Ù„Ø­Ø¸Ø© ÙˆØ§Ø±Ø³Ù„Ù‡Ø§ ÙÙŠØ¯ÙŠÙˆ<br>ÙˆØ§Ø­ØµÙ„ Ø¹Ù„Ù‰ Ù‡Ø¯ÙŠØ© ÙÙˆØ±ÙŠØ©!";
        body.innerHTML = `
            <div class="inv-row"><span class="inv-label">Ø§Ù„Ø§Ø³Ù…:</span> <span>${safe(o.name)}</span></div>
            <div class="inv-row"><span class="inv-label">Ø§Ù„Ù‡Ø§ØªÙ:</span> <span>${cleanP}</span></div>
            <div class="inv-row"><span class="inv-label">Ø§Ù„Ù…Ø¯ÙŠÙ†Ø©:</span> <span>${safe(o.city)}</span></div>
            <div class="inv-row"><span class="inv-label">Ø§Ù„ØªÙˆØµÙŠÙ„:</span> <span>${safe(o.delivery).split(' (')[0]}</span></div>
            <div class="inv-row"><span class="inv-label">Ø§Ù„Ø¯ÙØ¹:</span> <span>${safe(o.payment)}</span></div>
            <div style="margin-top:5px; border-top:1px dashed #ccc; padding-top:5px;">
                <div class="inv-label">Ø§Ù„Ø·Ù„Ø¨ÙŠØ©:</div>
                <div style="font-weight:700;">${safe(o.offer)}</div>
            </div>
            ${safe(o.notes) ? `<div style="margin-top:3px; font-size:9px;">ğŸ“ ${safe(o.notes)}</div>` : ''}
        `;
    } else {
        document.getElementById('p_promo').innerHTML = "ğŸ ×¦×œ××• ××ª ×”×¨×’×¢ ×•×©×œ×—×• ×•×™×“××•<br>×œ×§×‘×œ×ª ××ª× ×” ××™×™×“×™×ª!";
        body.innerHTML = `
            <div class="inv-row"><span class="inv-label">×©×:</span> <span>${safe(o.name)}</span></div>
            <div class="inv-row"><span class="inv-label">×˜×œ×¤×•×Ÿ:</span> <span>${cleanP}</span></div>
            <div class="inv-row"><span class="inv-label">×¢×™×¨:</span> <span>${safe(o.city)}</span></div>
            <div class="inv-row"><span class="inv-label">××©×œ×•×—:</span> <span>${safe(o.delivery).split(' (')[0]}</span></div>
            <div class="inv-row"><span class="inv-label">×ª×©×œ×•×:</span> <span>${safe(o.payment)}</span></div>
            <div style="margin-top:5px; border-top:1px dashed #ccc; padding-top:5px;">
                <div class="inv-label">×¤×¨×™×˜×™×:</div>
                <div style="font-weight:700;">${safe(o.offer)}</div>
            </div>
            ${safe(o.notes) ? `<div style="margin-top:3px; font-size:9px;">ğŸ“ ${safe(o.notes)}</div>` : ''}
        `;
    }
    
    document.getElementById('printModal').classList.add('show');
}

function analyzeText() {
    const raw = document.getElementById('smartInput').value;
    if(!raw.trim()) return showToast("Ø§Ù„ØµÙ‚ Ù†ØµØ§Ù‹ Ø£ÙˆÙ„Ø§Ù‹");
    const phoneMatch = raw.match(/(?:05|972|5)\d{8,11}/);
    if(phoneMatch) document.getElementById('f_phone').value = formatLocalPhone(phoneMatch[0]);
    const priceMatch = raw.match(/(\d{2,4})\s*(?:â‚ª|shekel|ILS|Ø§Ù„Ø³Ø¹Ø±)/i);
    if(priceMatch) document.getElementById('f_price').value = priceMatch[1];
    const nameLine = raw.split('\n')[0].trim();
    if(nameLine.length < 30) document.getElementById('f_name').value = nameLine;
    document.getElementById('f_offer').value = raw.substring(0, 100).trim();
    showToast("ØªÙ… Ø§Ù„ØªØ­Ù„ÙŠÙ„ âœ¨");
}

function closeModal(id) { document.getElementById(id).classList.remove('show'); }
window.onload = load;
</script>
</body>
</html>
