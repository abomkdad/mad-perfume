<!doctype html>
<html lang="he" dir="rtl">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width,initial-scale=1"/>
  <title>MAD Bulk Center | Ø·Ø¨Ø§Ø¹Ø© Ø§Ù„ÙƒÙ„</title>
  
  <script src="https://cdn.jsdelivr.net/npm/jsbarcode@3.11.5/dist/JsBarcode.all.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/qrcodejs@1.0.0/qrcode.min.js"></script>

  <style>
    :root { 
      --bg: #111827; 
      --surface: #1f2937; 
      --primary: #3b82f6; 
      --accent: #f59e0b;
      --text: #f3f4f6;
    }

    body { margin: 0; font-family: 'Segoe UI', system-ui, sans-serif; background: var(--bg); color: var(--text); padding-bottom: 50px; }
    
    /* Header */
    .header { 
      background: rgba(0,0,0,0.8); backdrop-filter: blur(10px); 
      position: sticky; top: 0; z-index: 100; padding: 15px 20px; border-bottom: 2px solid var(--primary);
      display: flex; justify-content: space-between; align-items: center;
    }
    .header h2 { margin: 0; display: flex; align-items: center; gap: 10px; }
    .badge-count { background: var(--primary); padding: 2px 10px; border-radius: 20px; font-size: 0.9rem; }

    /* Actions Bar */
    .actions { display: flex; gap: 15px; }
    .btn { cursor: pointer; border: none; padding: 10px 20px; border-radius: 8px; font-weight: bold; font-size: 1rem; transition: 0.2s; display: flex; align-items: center; gap: 8px; }
    .btn-print-all { background: var(--accent); color: #000; }
    .btn-print-all:hover { background: #d97706; }
    .btn-refresh { background: #374151; color: #fff; }

    /* Grid Layout */
    .grid { 
      display: grid; grid-template-columns: repeat(auto-fill, minmax(300px, 1fr)); 
      gap: 20px; padding: 20px; max-width: 1400px; margin: 0 auto;
    }

    /* Order Card (Preview on Screen) */
    .card { 
      background: var(--surface); border: 1px solid #374151; border-radius: 12px; 
      padding: 15px; display: flex; flex-direction: column; position: relative;
    }
    .card-header { display: flex; justify-content: space-between; margin-bottom: 10px; border-bottom: 1px solid #374151; padding-bottom: 5px; }
    .card-body { flex: 1; font-size: 0.95rem; line-height: 1.6; }
    .card-footer { margin-top: 15px; display: flex; gap: 10px; }
    
    .item-list { 
      background: #000; color: #fbbf24; padding: 8px; border-radius: 6px; 
      margin-top: 10px; font-size: 0.9rem; min-height: 40px; 
    }

    /* ------------------------------------------------ */
    /* LABEL DESIGN (100x100)             */
    /* ------------------------------------------------ */
    .label-wrapper { 
      width: 100mm; height: 100mm; background: #fff; color: #000; padding: 3mm; 
      box-sizing: border-box; border: 1px solid #eee; overflow: hidden;
      display: flex; flex-direction: column; position: relative;
      page-break-after: always; /* Critical for Print All */
      direction: rtl;
    }

    .lbl-head { display: flex; justify-content: space-between; align-items: flex-start; height: 25mm; }
    .lbl-logo img { width: 35mm; }
    .lbl-meta { font-size: 9pt; font-weight: bold; text-align: left; }

    .lbl-promo { 
      background: #000; color: #fff; text-align: center; font-weight: bold; 
      padding: 3px; font-size: 11pt; margin-bottom: 2mm; border-radius: 4px;
    }

    .lbl-info { font-size: 11pt; line-height: 1.3; margin-bottom: 1mm; }
    .lbl-info b { display: inline-block; width: 60px; }

    .lbl-content { 
      border: 1px dashed #000; background: #f9fafb; padding: 4px; 
      font-size: 9pt; height: 16mm; overflow: hidden; margin: 2mm 0;
    }

    .lbl-price { 
      border: 2px solid #000; font-size: 18pt; font-weight: 900; 
      text-align: center; padding: 2px; margin-bottom: 2mm; 
    }

    .lbl-footer { display: flex; justify-content: space-between; align-items: flex-end; margin-top: auto; }
    .lbl-wa { font-size: 8pt; font-weight: bold; max-width: 65%; border-top: 1px solid #000; padding-top: 1mm; }

    /* Print Settings */
    #printArea { display: none; }
    @media print {
      body * { visibility: hidden !important; }
      #printArea, #printArea * { visibility: visible !important; }
      #printArea { position: absolute; left: 0; top: 0; width: 100%; }
      @page { size: 100mm 100mm; margin: 0; }
      .label-wrapper { border: none; } /* Remove border when printing */
    }
  </style>
</head>
<body>

<div class="header">
  <h2>
    ğŸ“¦ MAD PREP
    <span class="badge-count" id="count">0</span>
  </h2>
  <div class="actions">
    <button class="btn btn-refresh" onclick="load()">×¨×¢× ×Ÿ (Refresh) â†»</button>
    <button class="btn btn-print-all" onclick="printAll()">ğŸ–¨ï¸ Ø·Ø¨Ø§Ø¹Ø© Ø§Ù„ÙƒÙ„ (Print All)</button>
  </div>
</div>

<div class="grid" id="grid"></div>

<div id="printArea"></div>

<script>
  const SCRIPT_URL = "https://script.google.com/macros/s/AKfycbyLjLFa8AaH82Ip7m747WC-KSUUEaU_M70S0I9Mda14XbnmcuEfZ7pBnF_zzJYZuXmZ/exec";
  const DASH_KEY = "12345678";
  let orders = [];

  // Ø§Ù„ØªØ­Ù‚Ù‚ ÙˆØ§Ù„ØªØ­Ù…ÙŠÙ„
  if(prompt("Password:") === DASH_KEY) load();
  else document.body.innerHTML = "Access Denied";

  async function load() {
    document.getElementById('grid').innerHTML = '<div style="color:#fff; padding:20px">Ø¬Ø§Ø±ÙŠ Ø§Ù„ØªØ­Ù…ÙŠÙ„...</div>';
    try {
      const res = await fetch(`${SCRIPT_URL}?action=get`);
      const all = await res.json();
      // ØªØµÙÙŠØ© Ø§Ù„Ø·Ù„Ø¨Ø§Øª Ø§Ù„Ø¬Ø§Ù‡Ø²Ø© (Ø¹Ø±Ø¶ Ø§Ù„Ø·Ù„Ø¨Ø§Øª Ø§Ù„Ø¬Ø¯ÙŠØ¯Ø© ÙÙ‚Ø·)
      orders = all.filter(o => {
        const s = (o.status || "").toLowerCase();
        return (s.includes("prep") || s.includes("approved")) && !s.includes("ready");
      });
      render();
    } catch(e) { alert("Error loading"); }
  }

  function render() {
    document.getElementById('count').innerText = orders.length;
    const grid = document.getElementById('grid');
    
    if(orders.length === 0) {
      grid.innerHTML = '<div style="color:#aaa; grid-column:1/-1; text-align:center; padding:50px">âœ… Ù„Ø§ ØªÙˆØ¬Ø¯ Ø·Ù„Ø¨Ø§Øª Ù„Ù„ØªØ¬Ù‡ÙŠØ²</div>';
      return;
    }

    grid.innerHTML = orders.map(o => `
      <div class="card">
        <div class="card-header">
          <span style="font-weight:900; color:var(--accent)">#${o.orderId}</span>
          <span>${o.delivery || 'High Express'}</span>
        </div>
        <div class="card-body">
          <div style="font-size:1.2rem; font-weight:bold; margin-bottom:5px">${o.name}</div>
          <div>ğŸ“ ${o.phone}</div>
          <div>ğŸ“ ${o.city} ${o.addr || ''}</div>
          
          <div class="item-list">
            <b>Ù…Ø­ØªÙˆÙ‰ Ø§Ù„Ø·Ø±Ø¯:</b><br>
            ${o.offer || 'Ù„Ø§ ÙŠÙˆØ¬Ø¯ ÙˆØµÙ'}
          </div>

          <div style="font-size:1.5rem; color:var(--primary); font-weight:bold; margin-top:10px">
            â‚ª${o.price}
          </div>
        </div>
        <div class="card-footer">
          <button class="btn" style="background:#fff; color:#000; flex:1" onclick="printSingle(${o.rowIndex})">ğŸ–¨ï¸ Ø·Ø¨Ø§Ø¹Ø©</button>
          <button class="btn" style="background:var(--primary); color:#fff" onclick="editOrder(${o.rowIndex})">âœï¸ ØªØ¹Ø¯ÙŠÙ„</button>
        </div>
      </div>
    `).join("");
  }

  // --- HTML Ù„ØªØµÙ…ÙŠÙ… Ø§Ù„Ù…Ù„ØµÙ‚ ---
  function getLabelHTML(o, idSuffix) {
    const date = new Date().toLocaleDateString('he-IL');
    return `
      <div class="label-wrapper">
        <div class="lbl-head">
          <div class="lbl-logo"><img src="https://www.madparfum.com/logo.svg"></div>
          <div class="lbl-meta">
            DATE: ${date}<br>
            ID: ${o.orderId}
          </div>
        </div>

        <div class="lbl-promo">×¦×œ× ××ª ×”×¨×’×¢ ×•×§×‘×œ ××ª× ×” ğŸ</div>

        <div class="lbl-info">
          <div><b>×œ×›×‘×•×“:</b> ${o.name}</div>
          <div><b>×˜×œ×¤×•×Ÿ:</b> ${o.phone}</div>
          <div><b>×›×ª×•×‘×ª:</b> ${o.city}</div>
          <div><b>××©×œ×•×—:</b> ${o.delivery || 'High Express'}</div>
        </div>

        <div class="lbl-content">
          <b>×ª×›×•×œ×” (Content):</b> ${o.offer || ''}
        </div>

        <div class="lbl-price">â‚ª ${o.price}</div>

        <div class="lbl-footer">
          <div class="lbl-wa">
            WhatsApp Video = FREE GIFT<br>
            +972 54-963-4449
          </div>
          <div id="qr_${idSuffix}"></div>
        </div>
        <div style="text-align:center; position:absolute; bottom:2mm; width:95%">
           <svg id="bar_${idSuffix}"></svg>
        </div>
      </div>
    `;
  }

  // --- Ø·Ø¨Ø§Ø¹Ø© Ø·Ù„Ø¨ ÙˆØ§Ø­Ø¯ ---
  function printSingle(rowIndex) {
    const o = orders.find(x => x.rowIndex === rowIndex);
    const area = document.getElementById('printArea');
    area.innerHTML = getLabelHTML(o, 'single');
    
    // Generate Codes
    setTimeout(() => {
      JsBarcode("#bar_single", o.phone || "0000", { format: "CODE128", height: 25, fontSize: 10, displayValue: false });
      new QRCode(document.getElementById("qr_single"), { text: "https://wa.me/972549634449", width: 45, height: 45 });
      window.print();
      
      // Ø³Ø¤Ø§Ù„ Ù„ØªØ­Ø¯ÙŠØ« Ø§Ù„Ø­Ø§Ù„Ø©
      if(confirm("Ù‡Ù„ ØªÙ… Ø§Ù„Ø·Ø¨Ø§Ø¹Ø© Ø¨Ù†Ø¬Ø§Ø­ØŸ Ù†Ù‚Ù„ Ø§Ù„Ø·Ù„Ø¨ Ø¥Ù„Ù‰ 'Ù…Ø¬Ù‡Ø²'ØŸ")) {
        markReady(rowIndex);
      }
    }, 300);
  }

  // --- Ø·Ø¨Ø§Ø¹Ø© Ø§Ù„ÙƒÙ„ (Ø§Ù„Ù…ÙŠØ²Ø© Ø§Ù„Ø¬Ø¯ÙŠØ¯Ø©) ---
  function printAll() {
    if(!confirm(`Ù‡Ù„ Ø£Ù†Øª Ù…ØªØ£ÙƒØ¯ Ù…Ù† Ø·Ø¨Ø§Ø¹Ø© ${orders.length} Ù…Ù„ØµÙ‚ Ø¯ÙØ¹Ø© ÙˆØ§Ø­Ø¯Ø©ØŸ`)) return;

    const area = document.getElementById('printArea');
    // ØªØ¬Ù…ÙŠØ¹ ÙƒÙ„ Ø§Ù„Ù…Ù„ØµÙ‚Ø§Øª ÙÙŠ Ø§Ù„ØµÙØ­Ø©
    area.innerHTML = orders.map((o, index) => getLabelHTML(o, index)).join("");

    // ØªÙˆÙ„ÙŠØ¯ Ø§Ù„Ø¨Ø§Ø±ÙƒÙˆØ¯Ø§Øª Ù„Ù„Ø¬Ù…ÙŠØ¹
    setTimeout(() => {
      orders.forEach((o, index) => {
        try {
          JsBarcode(`#bar_${index}`, o.phone || "0000", { format: "CODE128", height: 25, fontSize: 10, displayValue: false });
          new QRCode(document.getElementById(`qr_${index}`), { text: "https://wa.me/972549634449", width: 45, height: 45 });
        } catch(e) {}
      });
      
      window.print();

      // ØªØ­Ø¯ÙŠØ« Ø¬Ù…Ø§Ø¹ÙŠ Ù„Ù„Ø­Ø§Ù„Ø© (Ø§Ø®ØªÙŠØ§Ø±ÙŠ)
      if(confirm("Ù‡Ù„ ØªØ±ÙŠØ¯ ØªØ­Ø¯ÙŠØ¯ ÙƒÙ„ Ù‡Ø°Ù‡ Ø§Ù„Ø·Ù„Ø¨Ø§Øª ÙƒÙ€ 'Ø¬Ø§Ù‡Ø²Ø©' (Ready) Ø§Ù„Ø¢Ù†ØŸ")) {
        orders.forEach(o => {
          fetch(`${SCRIPT_URL}?action=updateStatus&key=${DASH_KEY}&row=${o.rowIndex}&status=READY âœ…`);
        });
        setTimeout(load, 2000); // Ø¥Ø¹Ø§Ø¯Ø© ØªØ­Ù…ÙŠÙ„ Ø¨Ø¹Ø¯ Ø«Ø§Ù†ÙŠØªÙŠÙ†
      }
    }, 1000); // Ø§Ù†ØªØ¸Ø§Ø± Ø«Ø§Ù†ÙŠØ© Ù„Ø¶Ù…Ø§Ù† ØªØ­Ù…ÙŠÙ„ Ø§Ù„ØµÙˆØ± ÙˆØ§Ù„Ø¨Ø§Ø±ÙƒÙˆØ¯Ø§Øª
  }

  // --- ÙˆØ¸Ø§Ø¦Ù Ù…Ø³Ø§Ø¹Ø¯Ø© ---
  async function markReady(row) {
    await fetch(`${SCRIPT_URL}?action=updateStatus&key=${DASH_KEY}&row=${row}&status=READY âœ…`);
    load(); // ØªØ­Ø¯ÙŠØ« Ø§Ù„Ø´Ø§Ø´Ø©
  }

  function editOrder(row) {
    const o = orders.find(x => x.rowIndex === row);
    const newVal = prompt("ØªØ¹Ø¯ÙŠÙ„ Ù…Ø­ØªÙˆÙ‰ Ø§Ù„Ø·Ø±Ø¯ (Items):", o.offer);
    if(newVal !== null) {
      // Ù‡Ù†Ø§ ÙŠÙ…ÙƒÙ†Ùƒ Ø¥Ø¶Ø§ÙØ© ÙƒÙˆØ¯ Ù„Ø­ÙØ¸ Ø§Ù„ØªØ¹Ø¯ÙŠÙ„ ÙÙŠ Ø´ÙŠØª Ø¬ÙˆØ¬Ù„ Ø¥Ø°Ø§ Ø£Ø±Ø¯ØªØŒ 
      // Ø£Ùˆ ÙÙ‚Ø· ØªØ¹Ø¯ÙŠÙ„Ù‡ Ù…Ø­Ù„ÙŠØ§Ù‹ Ù„Ù„Ø·Ø¨Ø§Ø¹Ø© Ø§Ù„Ø­Ø§Ù„ÙŠØ©:
      o.offer = newVal;
      render(); // Ø¥Ø¹Ø§Ø¯Ø© Ø±Ø³Ù… Ø§Ù„Ø´Ø§Ø´Ø©
    }
  }
</script>
</body>
</html>
