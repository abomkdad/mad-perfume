<!doctype html>
<html lang="ar" dir="rtl">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width,initial-scale=1"/>
  <title>MAD Prep | Ù…Ø­Ø±Ø± Ø§Ù„Ù…Ù„ØµÙ‚Ø§Øª</title>
  
  <script src="https://cdn.jsdelivr.net/npm/jsbarcode@3.11.5/dist/JsBarcode.all.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/qrcodejs@1.0.0/qrcode.min.js"></script>

  <style>
    :root {
      --bg: #070b16;
      --card: #1e293b;
      --primary: #3b82f6;
      --success: #10b981;
      --text: #f8fafc;
    }

    body { margin: 0; font-family: 'Segoe UI', Tahoma, sans-serif; background: var(--bg); color: var(--text); }
    .container { max-width: 900px; margin: 0 auto; padding: 20px; }
    
    /* Dashboard UI */
    .top-nav { background: rgba(30, 41, 59, 0.8); backdrop-filter: blur(10px); padding: 15px; position: sticky; top: 0; z-index: 50; border-bottom: 1px solid rgba(255,255,255,0.1); }
    .search-input { width: 100%; padding: 12px; border-radius: 10px; border: 1px solid #334155; background: #0f172a; color: white; margin-top: 10px; }
    .order-card { background: var(--card); border-radius: 15px; padding: 20px; margin-bottom: 15px; display: flex; justify-content: space-between; align-items: center; }
    .btn { cursor: pointer; border: none; border-radius: 8px; padding: 10px 20px; font-weight: bold; transition: 0.3s; }
    .btn-edit { background: var(--primary); color: white; }
    .btn-done { background: var(--success); color: white; margin-right: 10px; }

    /* Modal (Ø§Ù„Ù…Ø±Ø¨Ø¹ Ø§Ù„Ø£Ø¨ÙŠØ¶ Ù„Ù„ØªØ¹Ø¯ÙŠÙ„ Ù‚Ø¨Ù„ Ø§Ù„Ø·Ø¨Ø§Ø¹Ø©) */
    #editModal { 
      display: none; position: fixed; inset: 0; background: rgba(0,0,0,0.85); 
      z-index: 1000; justify-content: center; align-items: center; overflow-y: auto; 
    }
    .modal-content { 
      background: white; color: black; width: 100mm; padding: 20px; border-radius: 8px; 
      box-shadow: 0 0 50px rgba(0,0,0,0.5); position: relative;
    }
    .modal-content input, .modal-content textarea { 
      width: 100%; border: 1px solid #ddd; padding: 5px; margin-bottom: 8px; font-size: 11pt; font-weight: bold;
    }
    .modal-actions { display: flex; gap: 10px; margin-top: 15px; }
    .btn-print-now { background: #000; color: #fff; flex: 1; }
    .btn-cancel { background: #64748b; color: #fff; }

    /* Ø§Ù„Ø´ÙƒÙ„ Ø§Ù„Ù†Ù‡Ø§Ø¦ÙŠ Ù„Ù„Ù…Ù„ØµÙ‚ (Ø§Ù„Ù…Ø·Ø§Ø¨Ù‚ Ù„Ù„ØµÙˆØ±Ø©) */
    .label-preview { 
      width: 100mm; height: 100mm; background: #fff; color: #000; 
      padding: 5mm; box-sizing: border-box; border: 1px solid #eee; display: flex; flex-direction: column;
    }
    .label-header { display: flex; justify-content: space-between; align-items: center; border-bottom: 2px solid #000; padding-bottom: 5px; margin-bottom: 10px; }
    .mad-logo { font-size: 24pt; font-weight: 900; }
    .field-row { display: flex; justify-content: flex-start; margin-bottom: 4px; font-size: 11pt; }
    .field-label { font-weight: bold; margin-left: 8px; min-width: 60px; }
    .price-box { border: 2px solid #000; padding: 8px; text-align: center; font-size: 16pt; font-weight: 900; margin: 10px 0; }
    .barcode-area { text-align: center; margin-top: auto; }
    .policy-text { border: 1px dashed #000; padding: 5px; text-align: center; font-size: 9pt; font-weight: bold; margin-top: 10px; }

    /* Ø§Ù„Ø·Ø¨Ø§Ø¹Ø© Ø§Ù„Ø­Ù‚ÙŠÙ‚ÙŠØ© */
    @media print {
      body * { visibility: hidden !important; }
      #labelToPrint, #labelToPrint * { visibility: visible !important; }
      #labelToPrint { position: absolute; left: 0; top: 0; width: 100mm; height: 100mm; display: block !important; }
      @page { size: 100mm 100mm; margin: 0; }
    }
  </style>
</head>
<body>

<div class="top-nav">
  <div class="container">
    <div style="display:flex; justify-content:space-between">
      <span style="font-weight:900; font-size:1.5rem">MAD PREP âš¡</span>
      <button class="btn btn-edit" onclick="load()">ØªØ­Ø¯ÙŠØ« â†»</button>
    </div>
    <input type="text" id="searchBox" class="search-input" placeholder="Ø§Ø¨Ø­Ø« Ø¹Ù† Ø§Ø³Ù… Ø§Ù„Ø¹Ù…ÙŠÙ„ Ø£Ùˆ Ø±Ù‚Ù… Ø§Ù„Ø·Ù„Ø¨..." oninput="render()">
  </div>
</div>

<div class="container" id="orderList"></div>

<div id="editModal">
  <div class="modal-content" dir="rtl">
    <h3 style="margin-top:0; border-bottom:1px solid #eee; padding-bottom:10px">Ù…Ø±Ø§Ø¬Ø¹Ø© ÙˆØªØ¹Ø¯ÙŠÙ„ Ø§Ù„Ù…Ù„ØµÙ‚</h3>
    
    <div id="labelToPrint" class="label-preview">
      <div class="label-header">
        <div style="font-size: 10pt; font-weight: bold;">Order: <span id="m_orderId"></span></div>
        <div class="mad-logo">MAD</div>
      </div>

      <div class="field-row"><span class="field-label">Ø§Ù„Ø§Ø³Ù…:</span> <input id="i_name"></div>
      <div class="field-row"><span class="field-label">Ø§Ù„Ù‡Ø§ØªÙ:</span> <input id="i_phone"></div>
      <div class="field-row"><span class="field-label">Ø§Ù„Ø¹Ù†ÙˆØ§Ù†:</span> <input id="i_addr"></div>
      <div class="field-row"><span class="field-label">Ø§Ù„ØªÙˆØµÙŠÙ„:</span> <input id="i_delivery"></div>
      
      <div class="price-box">
        â‚ª <input id="i_price" style="width:60px; border:none; text-align:center; font-size:16pt"> = <span id="m_price_val"></span>
      </div>

      <div style="font-size: 9pt;">Ù…Ù„Ø§Ø­Ø¸Ø§Øª: <input id="i_notes" style="font-weight: normal; font-size: 9pt;"></div>

      <div class="barcode-area">
        <svg id="barcodeImg"></svg>
        <div id="qrCodeImg" style="display: flex; justify-content: center; margin-top: 5px;"></div>
      </div>

      <div class="policy-text">
        × ×™×ª×Ÿ ×œ×”×—×œ×™×£ ×¨×§ ×× ×”× ×™×™×œÙˆÙ† ×œ× × ×¤×ª×— <br>
        Ø§Ù„Ø§Ø³ØªØ¨Ø¯Ø§Ù„ ÙÙ‚Ø· Ø¥Ø°Ø§ Ù„Ù… ÙŠØªÙ… ÙØªØ­ Ø§Ù„Ù†Ø§ÙŠÙ„ÙˆÙ†
      </div>
    </div>

    <div class="modal-actions">
      <button class="btn btn-print-now" onclick="executePrint()">Ø·Ø¨Ø§Ø¹Ø© Ø§Ù„Ø¢Ù† ğŸ–¨ï¸</button>
      <button class="btn btn-cancel" onclick="closeModal()">Ø¥Ù„ØºØ§Ø¡</button>
    </div>
  </div>
</div>

<script>
  const SCRIPT_URL = "https://script.google.com/macros/s/AKfycbyLjLFa8AaH82Ip7m747WC-KSUUEaU_M70S0I9Mda14XbnmcuEfZ7pBnF_zzJYZuXmZ/exec";
  const DASH_KEY = "12345678";
  let currentOrders = [];
  let activeRow = null;

  async function load() {
    document.getElementById('orderList').innerHTML = "Ø¬Ø§Ø±ÙŠ Ø§Ù„ØªØ­Ù…ÙŠÙ„...";
    const res = await fetch(`${SCRIPT_URL}?action=get`);
    currentOrders = await res.json();
    render();
  }

  function render() {
    const q = document.getElementById('searchBox').value.toLowerCase();
    const filtered = currentOrders.filter(o => {
      const isPending = (o.status || "").includes("Prep") || (o.status || "").includes("Approved");
      const matches = `${o.name} ${o.orderId} ${o.phone}`.toLowerCase().includes(q);
      return isPending && matches;
    });

    document.getElementById('orderList').innerHTML = filtered.map(o => `
      <div class="order-card">
        <div>
          <div style="font-weight:bold; font-size:1.1rem">${o.name}</div>
          <div style="font-size:0.9rem; opacity:0.7">Ø±Ù‚Ù… Ø§Ù„Ø·Ù„Ø¨: ${o.orderId} | Ø§Ù„Ù‡Ø§ØªÙ: ${o.phone}</div>
        </div>
        <div style="display:flex">
          <button class="btn btn-edit" onclick="openEdit(${o.rowIndex})">ØªØ¬Ù‡ÙŠØ² Ø§Ù„Ù…Ù„ØµÙ‚ ğŸ·ï¸</button>
          <button class="btn btn-done" onclick="markDone(${o.rowIndex})">ØªÙ… âœ…</button>
        </div>
      </div>
    `).join("");
  }

  function openEdit(rowIndex) {
    const o = currentOrders.find(x => x.rowIndex == rowIndex);
    activeRow = rowIndex;
    
    // ØªØ¹Ø¨Ø¦Ø© Ø§Ù„Ù…Ø±Ø¨Ø¹ Ø§Ù„Ø£Ø¨ÙŠØ¶
    document.getElementById('m_orderId').innerText = o.orderId;
    document.getElementById('i_name').value = o.name;
    document.getElementById('i_phone').value = o.phone;
    document.getElementById('i_addr').value = o.city + " " + (o.addr || "");
    document.getElementById('i_delivery').value = o.delivery || "High Express";
    document.getElementById('i_price').value = o.price;
    document.getElementById('m_price_val').innerText = o.price;
    document.getElementById('i_notes').value = "order_confirmation_he";

    // ØªÙˆÙ„ÙŠØ¯ Ø§Ù„Ø¨Ø§Ø±ÙƒÙˆØ¯
    JsBarcode("#barcodeImg", o.phone || "0000", { format: "CODE128", height: 30, displayValue: true });
    
    // ØªÙˆÙ„ÙŠØ¯ Ø§Ù„Ù€ QR
    const qrDiv = document.getElementById("qrCodeImg");
    qrDiv.innerHTML = "";
    new QRCode(qrDiv, { text: `Order: ${o.orderId}\nCustomer: ${o.name}`, width: 50, height: 50 });

    document.getElementById('editModal').style.display = "flex";
  }

  function closeModal() { document.getElementById('editModal').style.display = "none"; }

  function executePrint() {
    window.print();
    closeModal();
  }

  async function markDone(row) {
    if(!confirm("Ù†Ù‚Ù„ Ø§Ù„Ø·Ù„Ø¨ Ø¥Ù„Ù‰ 'Ù…Ø¬Ù‡Ø²'ØŸ")) return;
    await fetch(`${SCRIPT_URL}?action=updateStatus&key=${DASH_KEY}&row=${row}&status=READY âœ…`);
    load();
  }

  load(); // Ø§Ù„Ø¨Ø¯Ø¡ Ø¹Ù†Ø¯ Ø§Ù„ØªØ­Ù…ÙŠÙ„
</script>

</body>
</html>
