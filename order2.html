<!doctype html>
<html lang="he" dir="rtl">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width,initial-scale=1"/>
  <title>MAD SYSTEM v4.0 | Premium Edition</title>
  
  <script src="https://cdn.jsdelivr.net/npm/jsbarcode@3.11.5/dist/JsBarcode.all.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/qrcodejs@1.0.0/qrcode.min.js"></script>
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
  <link href="https://fonts.googleapis.com/css2?family=Assistant:wght@300;400;600;800&family=Rubik:wght@400;700&display=swap" rel="stylesheet">

  <style>
    :root { 
      --bg-main: #0f172a;
      --bg-card: #1e293b;
      --primary: #3b82f6; 
      --primary-hover: #2563eb;
      --accent: #f59e0b;
      --success: #10b981;
      --danger: #ef4444;
      --text-main: #f8fafc;
      --text-muted: #94a3b8;
      --font-main: 'Assistant', sans-serif;
    }

    body { 
      margin: 0; 
      font-family: var(--font-main); 
      background: var(--bg-main); 
      color: var(--text-main); 
      height: 100vh; 
      display: flex; 
      flex-direction: column; 
      overflow: hidden; 
    }

    /* --- Header Section --- */
    .header { 
      background: #1e293b; 
      padding: 1rem 2rem; 
      display: flex; 
      align-items: center; 
      justify-content: space-between;
      box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1);
      border-bottom: 1px solid #334155;
    }
    .brand { font-size: 1.8rem; font-weight: 800; letter-spacing: -1px; }
    .brand span { color: var(--primary); }

    .search-container { flex: 1; max-width: 500px; margin: 0 2rem; position: relative; }
    .search-input {
      width: 100%;
      padding: 12px 45px 12px 15px;
      background: #0f172a;
      border: 1px solid #334155;
      border-radius: 12px;
      color: white;
      font-size: 1rem;
      transition: all 0.3s;
    }
    .search-input:focus { border-color: var(--primary); box-shadow: 0 0 0 3px rgba(59, 130, 246, 0.2); }
    .search-icon { position: absolute; right: 15px; top: 50%; transform: translateY(-50%); color: var(--text-muted); }

    /* --- Main Content --- */
    .workspace { flex: 1; overflow-y: auto; padding: 2rem; }
    .grid { 
      display: grid; 
      grid-template-columns: repeat(auto-fill, minmax(320px, 1fr)); 
      gap: 1.5rem; 
      padding-bottom: 100px; 
    }

    /* --- Card Style --- */
    .card {
      background: var(--bg-card);
      border-radius: 16px;
      padding: 1.5rem;
      border: 1px solid #334155;
      transition: all 0.2s ease;
      position: relative;
      cursor: pointer;
      display: flex;
      flex-direction: column;
      gap: 10px;
    }
    .card:hover { transform: translateY(-5px); border-color: var(--primary); box-shadow: 0 10px 20px rgba(0,0,0,0.2); }
    .card.selected { border-color: var(--primary); background: #263345; }

    .card-checkbox {
      position: absolute; top: 1.2rem; right: 1.2rem; 
      width: 20px; height: 20px; accent-color: var(--primary);
    }

    .status-badge {
      display: inline-block; padding: 4px 10px; border-radius: 20px; font-size: 0.75rem; font-weight: 700;
      background: rgba(245, 158, 11, 0.1); color: var(--accent); width: fit-content;
    }
    .status-ready { background: rgba(16, 185, 129, 0.1); color: var(--success); }

    .card-id { font-size: 0.85rem; color: var(--text-muted); font-weight: 600; }
    .card-name { font-size: 1.3rem; font-weight: 800; margin: 5px 0; }
    .card-info { display: flex; align-items: center; gap: 10px; font-size: 0.95rem; color: #cbd5e1; }
    .card-info i { color: var(--primary); width: 16px; }

    .card-offer {
      background: rgba(15, 23, 42, 0.5); padding: 10px; border-radius: 8px;
      font-size: 0.9rem; margin: 10px 0; min-height: 50px; border-right: 3px solid var(--primary);
    }

    .card-footer { display: flex; justify-content: space-between; align-items: center; margin-top: auto; padding-top: 15px; border-top: 1px solid #334155; }
    .price-tag { font-size: 1.4rem; font-weight: 900; color: var(--success); }

    /* --- Floating Action Bar --- */
    .bulk-bar {
      position: fixed; bottom: 30px; left: 50%; transform: translateX(-50%) translateY(200px);
      background: white; color: #0f172a; padding: 12px 30px; border-radius: 50px;
      display: flex; align-items: center; gap: 20px; box-shadow: 0 15px 30px rgba(0,0,0,0.4);
      transition: 0.4s cubic-bezier(0.18, 0.89, 0.32, 1.28); z-index: 1000;
    }
    .bulk-bar.active { transform: translateX(-50%) translateY(0); }
    .btn-print-bulk { background: var(--primary); color: white; border: none; padding: 10px 25px; border-radius: 25px; font-weight: 700; cursor: pointer; }

    /* --- Modal --- */
    .modal { display: none; position: fixed; inset: 0; background: rgba(0,0,0,0.8); z-index: 2000; align-items: center; justify-content: center; padding: 20px; }
    .modal-content { background: white; width: 100%; max-width: 1000px; height: 85vh; border-radius: 20px; overflow: hidden; display: flex; color: #334155; }

    /* --- Label Design (For Print) --- */
    #printArea { display: none; }
    @media print {
      body * { visibility: hidden; }
      #printArea, #printArea * { visibility: visible; }
      #printArea { display: block !important; position: absolute; left: 0; top: 0; width: 100%; }
      @page { size: 100mm 100mm; margin: 0; }
      .label-page { 
        width: 100mm; height: 100mm; padding: 5mm; position: relative; 
        page-break-after: always; display: flex; flex-direction: column;
      }
    }

    .label-page { background: white; color: black; font-family: 'Rubik', sans-serif; direction: rtl; border: 1px solid #eee; }
    /* ... (Same label styles as before, slightly cleaned up) ... */
  </style>
</head>
<body>

<audio id="bell" src="https://assets.mixkit.co/active_storage/sfx/2869/2869-preview.mp3"></audio>

<header class="header">
  <div class="brand">MAD <span>V4.0</span></div>
  
  <div class="search-container">
    <i class="fas fa-search search-icon"></i>
    <input type="text" id="searchInput" class="search-input" placeholder="×—×™×¤×•×© ×œ×¤×™ ×©×, ×˜×œ×¤×•×Ÿ, ×¢×™×¨ ××• ××¡×¤×¨ ×”×–×× ×”..." oninput="app.render()">
  </div>

  <div style="display: flex; gap: 10px;">
    <button onclick="app.loadData()" class="btn-print-bulk" style="background: #334155;">
      <i class="fas fa-sync-alt"></i> ×¨×¢× ×Ÿ × ×ª×•× ×™×
    </button>
  </div>
</header>

<main class="workspace">
  <div id="grid" class="grid"></div>
</main>

<div id="bulkBar" class="bulk-bar">
  <span id="selectedCount" style="font-weight:700">0 ×”×–×× ×•×ª × ×‘×—×¨×•</span>
  <button class="btn-print-bulk" onclick="app.printSelected()">×”×“×¤×¡ ××¡×•×× ×™× <i class="fas fa-print"></i></button>
  <button onclick="app.clearSelection()" style="background:none; border:none; cursor:pointer; color: #64748b; text-decoration: underline;">×‘×™×˜×•×œ</button>
</div>

<div id="editorModal" class="modal">
  <div class="modal-content">
      <div style="flex: 1; padding: 2rem; overflow-y: auto; background: #f8fafc;">
          <h2 style="margin-bottom: 1.5rem; color: #1e293b;">×¢×¨×™×›×ª ×¤×¨×˜×™ ××©×œ×•×—</h2>
          <div style="display: grid; gap: 15px;">
              <div><label>×©× ×œ×§×•×—:</label><input id="e_name" class="search-input" style="background:white; color:black; border-color:#cbd5e1" oninput="app.updatePreview()"></div>
              <div><label>×˜×œ×¤×•×Ÿ:</label><input id="e_phone" class="search-input" style="background:white; color:black; border-color:#cbd5e1" oninput="app.updatePreview()"></div>
              <div><label>×›×ª×•×‘×ª ×•×¢×™×¨:</label><input id="e_city" class="search-input" style="background:white; color:black; border-color:#cbd5e1" oninput="app.updatePreview()"></div>
              <div style="display:flex; gap:10px">
                  <div style="flex:1"><label>×—×‘×¨×ª ×©×œ×™×—×•×ª:</label><input id="e_del" class="search-input" style="background:white; color:black; border-color:#cbd5e1" oninput="app.updatePreview()"></div>
                  <div style="flex:1"><label>×ª×©×œ×•×:</label><input id="e_pay" class="search-input" style="background:white; color:black; border-color:#cbd5e1" oninput="app.updatePreview()"></div>
              </div>
              <div><label>×¤×™×¨×•×˜ ××•×¦×¨×™×:</label><textarea id="e_offer" class="search-input" style="background:white; color:black; border-color:#cbd5e1; height:80px" oninput="app.updatePreview()"></textarea></div>
              <div><label>×¡×›×•× ×œ×’×‘×™×™×”:</label><input id="e_price" type="number" class="search-input" style="background:white; color:#10b981; font-weight:bold; font-size:1.2rem; border-color:#cbd5e1" oninput="app.updatePreview()"></div>
          </div>
          <div style="margin-top: 2rem; display: flex; gap: 10px;">
              <button onclick="app.closeModal()" style="flex:1; padding:12px; border-radius:10px; border:1px solid #cbd5e1; cursor:pointer;">×‘×™×˜×•×œ</button>
              <button onclick="app.printFromModal()" style="flex:2; padding:12px; border-radius:10px; background:#0f172a; color:white; font-weight:700; cursor:pointer;">×©××•×¨ ×•×”×“×¤×¡ ×ª×•×•×™×ª</button>
          </div>
      </div>
      <div style="flex: 1.2; background: #e2e8f0; display: flex; align-items: center; justify-content: center; padding: 20px;">
          <div id="livePreview" style="transform: scale(0.85); box-shadow: 0 20px 40px rgba(0,0,0,0.2);"></div>
      </div>
  </div>
</div>

<div id="printArea"></div>

<script>
class MadSystem {
    constructor() {
        this.scriptUrl = "https://script.google.com/macros/s/AKfycbyLjLFa8AaH82Ip7m747WC-KSUUEaU_M70S0I9Mda14XbnmcuEfZ7pBnF_zzJYZuXmZ/exec";
        this.orders = [];
        this.selectedIndices = new Set();
        this.editingIndex = null;
        this.init();
    }

    async init() {
        const auth = localStorage.getItem('mad_auth_v4');
        if (auth !== "1234") {
            const pass = prompt("× × ×œ×”×–×™×Ÿ ×¡×™×¡××ª ××¢×¨×›×ª:");
            if (pass === "1234") localStorage.setItem('mad_auth_v4', "1234");
            else return;
        }
        await this.loadData();
        setInterval(() => this.loadData(true), 30000);
    }

    async loadData(silent = false) {
        if (!silent) document.getElementById('grid').innerHTML = '<div style="grid-column:1/-1; text-align:center; padding:50px; font-size:1.2rem;">×˜×•×¢×Ÿ ×”×–×× ×•×ª ×—×“×©×•×ª...</div>';
        try {
            const res = await fetch(`${this.scriptUrl}?action=get`);
            const data = await res.json();
            
            // Check for new orders to play sound
            if (this.orders.length > 0 && data.length > this.orders.length) {
                document.getElementById('bell').play();
            }
            
            this.orders = data;
            this.render();
        } catch (e) {
            console.error("Fetch error:", e);
        }
    }

    render() {
        const query = document.getElementById('searchInput').value.toLowerCase();
        const grid = document.getElementById('grid');
        
        const filtered = this.orders.filter(o => {
            const searchStr = `${o.name} ${o.phone} ${o.city} ${o.orderId}`.toLowerCase();
            return searchStr.includes(query);
        });

        grid.innerHTML = filtered.map(o => {
            const idx = this.orders.indexOf(o);
            const isReady = (o.status || "").includes("READY");
            const isSelected = this.selectedIndices.has(idx);

            return `
                <div class="card ${isSelected ? 'selected' : ''}" onclick="app.openEditor(${idx})" style="opacity: ${isReady ? 0.7 : 1}">
                    <input type="checkbox" class="card-checkbox" ${isSelected ? 'checked' : ''} 
                           onclick="event.stopPropagation(); app.toggleSelect(${idx})">
                    
                    <div class="card-id">#${o.orderId}</div>
                    <div class="status-badge ${isReady ? 'status-ready' : ''}">
                        ${isReady ? '<i class="fas fa-check-circle"></i> ××•×›×Ÿ ×œ××©×œ×•×—' : '<i class="fas fa-clock"></i> ×××ª×™×Ÿ ×œ×˜×™×¤×•×œ'}
                    </div>
                    
                    <div class="card-name">${o.name}</div>
                    <div class="card-info"><i class="fas fa-phone"></i> ${this.formatPhone(o.phone)}</div>
                    <div class="card-info"><i class="fas fa-map-marker-alt"></i> ${o.city || '×œ× ×¦×•×™×Ÿ'}</div>
                    
                    <div class="card-offer">${o.offer || '×œ×œ× ×¤×™×¨×•×˜ ××•×¦×¨×™×'}</div>
                    
                    <div class="card-footer">
                        <div style="font-size: 0.8rem; font-weight: 700; color: var(--accent)">${o.delivery || 'High Express'}</div>
                        <div class="price-tag">â‚ª${o.price}</div>
                    </div>
                </div>
            `;
        }).join("");
    }

    formatPhone(p) {
        let num = String(p).replace(/\D/g, "");
        if (num.startsWith("972")) num = "0" + num.slice(3);
        if (num.length === 9 && num.startsWith("5")) num = "0" + num;
        return num.length === 10 ? `${num.slice(0,3)}-${num.slice(3,6)}-${num.slice(6)}` : num;
    }

    toggleSelect(idx) {
        if (this.selectedIndices.has(idx)) this.selectedIndices.delete(idx);
        else this.selectedIndices.add(idx);
        this.updateBulkBar();
        this.render();
    }

    updateBulkBar() {
        const bar = document.getElementById('bulkBar');
        const count = this.selectedIndices.size;
        document.getElementById('selectedCount').innerText = `${count} ×”×–×× ×•×ª × ×‘×—×¨×•`;
        count > 0 ? bar.classList.add('active') : bar.classList.remove('active');
    }

    clearSelection() {
        this.selectedIndices.clear();
        this.updateBulkBar();
        this.render();
    }

    openEditor(idx) {
        this.editingIndex = idx;
        const o = this.orders[idx];
        
        document.getElementById('e_name').value = o.name || "";
        document.getElementById('e_phone').value = o.phone || "";
        document.getElementById('e_city').value = o.city || "";
        document.getElementById('e_offer').value = o.offer || "";
        document.getElementById('e_price').value = o.price || "";
        document.getElementById('e_del').value = o.delivery || "High Express";
        document.getElementById('e_pay').value = o.payment || "××–×•××Ÿ";

        document.getElementById('editorModal').style.display = 'flex';
        this.updatePreview();
    }

    closeModal() { document.getElementById('editorModal').style.display = 'none'; }

    updatePreview() {
        const data = this.getFormData();
        document.getElementById('livePreview').innerHTML = this.generateLabelHtml(data, 'prev');
        this.generateCodes('prev', data.phone);
    }

    getFormData() {
        return {
            orderId: this.orders[this.editingIndex].orderId,
            name: document.getElementById('e_name').value,
            phone: document.getElementById('e_phone').value,
            city: document.getElementById('e_city').value,
            offer: document.getElementById('e_offer').value,
            price: document.getElementById('e_price').value,
            delivery: document.getElementById('e_del').value,
            payment: document.getElementById('e_pay').value
        };
    }

    generateLabelHtml(o, id) {
        return `
            <div class="label-page">
                <div style="display:flex; justify-content:space-between; align-items:flex-start;">
                    <img src="https://www.madparfum.com/logo.svg" style="width:130px">
                    <div style="text-align:left; font-size:10pt; font-weight:bold;">
                        ×ª××¨×™×š: ${new Date().toLocaleDateString('he-IL')}<br>
                        ×”×–×× ×”: ${o.orderId}
                    </div>
                </div>
                <div style="background:black; color:#fbbf24; text-align:center; padding:5px; font-weight:900; margin:10px 0; border-radius:4px;">×¦×œ× ××ª ×”×¨×’×¢ ×•×§×‘×œ ××ª× ×” ğŸ</div>
                <div style="display:grid; grid-template-columns: 80px 1fr; gap:5px; font-size:12pt; line-height:1.4">
                    <b>×œ×›×‘×•×“:</b> <span>${o.name}</span>
                    <b>×˜×œ×¤×•×Ÿ:</b> <span dir="ltr" style="text-align:right">${this.formatPhone(o.phone)}</span>
                    <b>×¢×™×¨:</b> <span>${o.city}</span>
                    <b>×—×‘×¨×”:</b> <span>${o.delivery}</span>
                    <b>×ª×©×œ×•×:</b> <span>${o.payment}</span>
                </div>
                <div style="border-top:1px dashed black; margin:10px 0; padding-top:10px; font-size:10pt; font-weight:bold; height:60px; overflow:hidden;">
                    ${o.offer}
                </div>
                <div style="border:3px solid black; text-align:center; font-size:24pt; font-weight:900; border-radius:10px; padding:5px; margin-bottom:10px;">
                   â‚ª${o.price}
                </div>
                <div style="display:flex; justify-content:space-between; align-items:flex-end; margin-top:auto">
                    <div style="background:black; color:white; padding:8px; border-radius:8px; font-size:8pt; width:65%">
                        1. ×¡×¨×•×§ ××ª ×”×§×•×“<br>2. ×©×œ×— ×¡×¨×˜×•×Ÿ ×œ-WhatsApp<br>3. ×§×‘×œ ××ª× ×” ××™×™×“×™×ª!
                    </div>
                    <div id="qr_${id}"></div>
                </div>
                <div style="text-align:center; margin-top:10px"><svg id="bar_${id}"></svg></div>
            </div>
        `;
    }

    generateCodes(id, phone) {
        setTimeout(() => {
            const cleanPhone = String(phone).replace(/\D/g, "");
            JsBarcode(`#bar_${id}`, cleanPhone || "000000", { height: 30, displayValue: false, margin: 0 });
            new QRCode(document.getElementById(`qr_${id}`), { text: "https://wa.me/972549634449", width: 60, height: 60 });
        }, 100);
    }

    async printFromModal() {
        const data = this.getFormData();
        this.printList([data]);
        
        // Update Status to DB
        const rowIndex = this.orders[this.editingIndex].rowIndex;
        fetch(`${this.scriptUrl}?action=updateStatus&key=12345678&row=${rowIndex}&status=READY âœ…`);
        
        this.orders[this.editingIndex].status = "READY âœ…";
        this.closeModal();
        this.render();
    }

    printSelected() {
        const list = Array.from(this.selectedIndices).map(idx => this.orders[idx]);
        if (confirm(`×œ×”×“×¤×™×¡ ${list.length} ×ª×•×•×™×•×ª?`)) {
            this.printList(list);
            if (confirm("×”×× ×œ×¡××Ÿ ××ª ×›×•×œ×Ÿ ×›'××•×›×Ÿ ×œ××©×œ×•×—'?")) {
                list.forEach(o => {
                    fetch(`${this.scriptUrl}?action=updateStatus&key=12345678&row=${o.rowIndex}&status=READY âœ…`);
                    o.status = "READY âœ…";
                });
                this.clearSelection();
            }
        }
    }

    printList(list) {
        const container = document.getElementById('printArea');
        container.innerHTML = list.map((o, i) => this.generateLabelHtml(o, `prnt_${i}`)).join("");
        list.forEach((o, i) => this.generateCodes(`prnt_${i}`, o.phone));
        
        setTimeout(() => {
            window.print();
        }, 800);
    }
}

const app = new MadSystem();
</script>

</body>
</html>
