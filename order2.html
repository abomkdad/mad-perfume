<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Prep - MAD System</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+Arabic:wght@400;700;900&family=Assistant:wght@400;700;800&display=swap" rel="stylesheet">
  <style>
    body { font-family: "Noto Sans Arabic", "Assistant", system-ui, sans-serif; }
    .card { border:1px solid rgba(255,255,255,.08); background:rgba(17,24,39,.65); }
    .muted { opacity:.8; }
  </style>
</head>
<body class="min-h-screen bg-slate-950 text-white">
  <div class="max-w-5xl mx-auto p-4">
    <div class="flex items-center justify-between gap-3 mb-4">
      <div>
        <h1 class="text-xl font-black">Ù†Ø³Ø®Ø© Ø§Ù„ØªØ¬Ù‡ÙŠØ² (Ø³Ù‡Ù„ Ø¬Ø¯Ù‹Ø§)</h1>
        <p class="text-sm muted">ÙŠØ¹Ø±Ø¶ ÙÙ‚Ø· Ø§Ù„Ø·Ù„Ø¨Ø§Øª Ø§Ù„Ù…Ø¹ØªÙ…Ø¯Ø© Ù„Ù„ØªØ¬Ù‡ÙŠØ². Ø²Ø± ÙˆØ§Ø­Ø¯: <b>ØªÙ… ØªØ¬Ù‡ÙŠØ² Ø§Ù„Ø·Ù„Ø¨</b>.</p>
      </div>
      <div class="flex gap-2">
        <button id="btnNotif" class="px-3 py-2 rounded-xl bg-white/10 hover:bg-white/15">ØªÙØ¹ÙŠÙ„ Ø¥Ø´Ø¹Ø§Ø±Ø§Øª</button>
        <button id="btnRefresh" class="px-3 py-2 rounded-xl bg-white/10 hover:bg-white/15">ØªØ­Ø¯ÙŠØ«</button>
      </div>
    </div>

    <div class="bg-white/5 rounded-2xl p-3 mb-4">
      <label class="text-sm muted">Ø±Ø§Ø¨Ø· Ø§Ù„Ù€ API (Ø³ÙƒØ±ÙŠØ¨Øª Ø¬ÙˆØ¬Ù„)</label>
      <input id="api" class="mt-2 w-full px-3 py-3 rounded-xl bg-slate-900 border border-white/10 outline-none"
        value="https://script.google.com/macros/s/AKfycbyLjLFa8AaH82Ip7m747WC-KSUUEaU_M70S0I9Mda14XbnmcuEfZ7pBnF_zzJYZuXmZ/exec" />
      <p class="text-xs muted mt-2">Ø¥Ø°Ø§ ØºÙŠØ±Øª Ø§Ù„Ø³ÙƒØ±Ø¨Øª/Ù†Ø´Ø±Øª Ù…Ù† Ø¬Ø¯ÙŠØ¯: Ø¨Ø¯Ù‘Ù„ Ø§Ù„Ø±Ø§Ø¨Ø· Ù‡Ù†Ø§.</p>
    </div>

    <div id="list" class="space-y-4"></div>
  </div>

  <audio id="beep" preload="auto">
    <source src="data:audio/wav;base64,UklGRiQAAABXQVZFZm10IBAAAAABAAEAQB8AAIA+AAACABAAZGF0YQAAAAA=" type="audio/wav">
  </audio>

<script>
  const $ = (id)=>document.getElementById(id);
  let lastCount = 0;

  function isApprovedForPrep(status=""){
    status = (status||"").toLowerCase();
    return status.includes("approved") || status.includes("sent to prep") || status.includes("Ù„Ù„ØªØ¬Ù‡ÙŠØ²") || status.includes("Ø§Ø¹ØªÙ…Ø§Ø¯");
  }
  function isReady(status=""){
    status = (status||"").toLowerCase();
    return status.includes("ØªÙ… ØªØ¬Ù‡ÙŠØ²") || status.includes("ready") || status.includes("××•×›×Ÿ");
  }

  async function fetchOrders(){
    const url = `${$("api").value}?action=get&t=${Date.now()}`;
    const res = await fetch(url);
    return await res.json();
  }

  function detectLang(name=""){
    if (/[Ø¡-ÙŠ]/.test(name)) return "ar";
    if (/[×-×ª]/.test(name)) return "he";
    return "he";
  }

  function openPrint(order){
    const lang = detectLang(order.name||"");
    const dir = "rtl"; // both ar/he RTL
    const font = lang==="ar" ? "Noto Sans Arabic" : "Assistant";

    const html = `
<!doctype html><html dir="${dir}"><head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width,initial-scale=1"/>
<link href="https://fonts.googleapis.com/css2?family=Noto+Sans+Arabic:wght@700;900&family=Assistant:wght@700;800&display=swap" rel="stylesheet">
<style>
  @page { size: 100mm 100mm; margin: 0; } /* default label 100x100 */
  body { margin:0; font-family:${font}, system-ui; }
  .box { width:100mm; height:100mm; padding:6mm; box-sizing:border-box; }
  .t1{ font-size:18pt; font-weight:900; }
  .t2{ font-size:12pt; font-weight:800; margin-top:2mm; }
  .t3{ font-size:10pt; margin-top:2mm; line-height:1.2; }
  .hr{ margin:3mm 0; border-top:2px solid #000; }
</style></head>
<body onload="window.print(); setTimeout(()=>window.close(),300);">
  <div class="box">
    <div class="t1">MAD</div>
    <div class="t2">${order.orderId || ""}</div>
    <div class="hr"></div>
    <div class="t2">${order.name || ""}</div>
    <div class="t2">${order.phone || ""}</div>
    <div class="t3">${order.addr || order.city || ""}</div>
    <div class="hr"></div>
    <div class="t2">${order.offer || ""}</div>
    <div class="t2">${order.price ? ("â‚ª" + order.price) : ""}</div>
  </div>
</body></html>`;
    const w = window.open("", "_blank", "width=420,height=420");
    w.document.open(); w.document.write(html); w.document.close();
  }

  async function updateStatus(rowIndex, status){
    const url = `${$("api").value}?action=updateStatus&row=${encodeURIComponent(rowIndex)}&status=${encodeURIComponent(status)}&t=${Date.now()}`;
    const res = await fetch(url);
    return await res.json();
  }

  async function updateOrder(rowIndex, payload){
    const qs = new URLSearchParams({ action:"updateOrder", row:rowIndex, ...payload, t:Date.now() });
    const url = `${$("api").value}?${qs.toString()}`;
    const res = await fetch(url);
    return await res.json();
  }

  function card(order){
    const wrapper = document.createElement("div");
    wrapper.className = "card rounded-2xl p-4";
    wrapper.innerHTML = `
      <div class="flex items-center justify-between gap-2">
        <div class="text-sm muted">#${order.rowIndex} â€¢ ${order.orderId || ""}</div>
        <div class="text-xs px-2 py-1 rounded-lg bg-white/10">${order.source || ""}</div>
      </div>

      <div class="grid grid-cols-1 md:grid-cols-2 gap-3 mt-3">
        <div class="bg-white/5 rounded-xl p-3">
          <div class="text-xs muted mb-1">Ø§Ø³Ù… Ø§Ù„Ø¹Ù…ÙŠÙ„</div>
          <input class="w-full px-3 py-3 rounded-xl bg-slate-900 border border-white/10" value="${order.name||""}" data-k="name">
        </div>

        <div class="bg-white/5 rounded-xl p-3">
          <div class="text-xs muted mb-1">Ø§Ù„Ù‡Ø§ØªÙ</div>
          <input class="w-full px-3 py-3 rounded-xl bg-slate-900 border border-white/10 text-lg font-black" value="${order.phone||""}" data-k="phone">
        </div>

        <div class="bg-white/5 rounded-xl p-3 md:col-span-2">
          <div class="text-xs muted mb-1">Ø§Ù„Ø¹Ù†ÙˆØ§Ù†</div>
          <input class="w-full px-3 py-3 rounded-xl bg-slate-900 border border-white/10" value="${order.addr||order.city||""}" data-k="addr">
        </div>

        <div class="bg-white/5 rounded-xl p-3 md:col-span-2">
          <div class="text-xs muted mb-1">(C) Ø§Ù„Ø·Ù„Ø¨</div>
          <input class="w-full px-3 py-3 rounded-xl bg-slate-900 border border-white/10 text-base font-bold" value="${order.offer||""}" data-k="offer">
        </div>

        <div class="bg-white/5 rounded-xl p-3">
          <div class="text-xs muted mb-1">Ø§Ù„Ø³Ø¹Ø±</div>
          <input class="w-full px-3 py-3 rounded-xl bg-slate-900 border border-white/10 text-xl font-black" value="${order.price||""}" data-k="price">
        </div>

        <div class="bg-white/5 rounded-xl p-3">
          <div class="text-xs muted mb-1">Ù…Ù„Ø§Ø­Ø¸Ø§Øª</div>
          <input class="w-full px-3 py-3 rounded-xl bg-slate-900 border border-white/10" value="${order.notes||""}" data-k="extraNotes">
        </div>
      </div>

      <div class="grid grid-cols-1 md:grid-cols-3 gap-3 mt-4">
        <button class="btnSave px-4 py-4 rounded-2xl bg-indigo-600 hover:bg-indigo-500 font-black">ğŸ’¾ Ø­ÙØ¸ Ø§Ù„ØªØ¹Ø¯ÙŠÙ„</button>
        <button class="btnPrint px-4 py-4 rounded-2xl bg-slate-800 hover:bg-slate-700 font-black">ğŸ–¨ï¸ Ø·Ø¨Ø§Ø¹Ø© Ù…Ù„ØµÙ‚</button>
        <button class="btnReady px-4 py-4 rounded-2xl bg-emerald-600 hover:bg-emerald-500 font-black">âœ… ØªÙ… ØªØ¬Ù‡ÙŠØ² Ø§Ù„Ø·Ù„Ø¨</button>
      </div>

      <div class="mt-3 text-sm muted">Ø§Ù„Ø­Ø§Ù„Ø©: <b>${order.status||""}</b></div>
    `;

    wrapper.querySelector(".btnPrint").onclick = ()=>openPrint(order);

    wrapper.querySelector(".btnSave").onclick = async ()=>{
      const inputs = [...wrapper.querySelectorAll("input[data-k]")];
      const payload = {};
      inputs.forEach(i=>payload[i.dataset.k]=i.value);
      payload.city = payload.addr || order.city || "-";
      payload.payment = order.payment || "";
      payload.proc = order.proc || "Direct";
      payload.deliveryCompany = order.deliveryCompany || "";
      payload.source = order.source || "";
      await updateOrder(order.rowIndex, payload);
      await load();
      alert("ØªÙ… Ø§Ù„Ø­ÙØ¸ âœ…");
    };

    wrapper.querySelector(".btnReady").onclick = async ()=>{
      await updateStatus(order.rowIndex, "READY âœ… (ØªÙ… ØªØ¬Ù‡ÙŠØ² Ø§Ù„Ø·Ù„Ø¨)");
      await load();
      alert("ØªÙ… âœ…");
    };

    return wrapper;
  }

  async function load(){
    const list = $("list");
    list.innerHTML = `<div class="text-center muted py-10">Ø¬Ø§Ø±ÙŠ Ø§Ù„ØªØ­Ù…ÙŠÙ„...</div>`;
    let data = await fetchOrders();
    if (!Array.isArray(data)) data = [];
    const filtered = data.filter(o => isApprovedForPrep(o.status) && !isReady(o.status));

    // notifications
    if (filtered.length > lastCount) {
      try { $("beep").play(); } catch(e){}
      if (Notification.permission === "granted") {
        new Notification("MAD System", { body: "ÙˆØµÙ„Øª Ø·Ù„Ø¨ÙŠØ© Ø¬Ø¯ÙŠØ¯Ø© Ù„Ù„ØªØ¬Ù‡ÙŠØ² âœ…" });
      }
    }
    lastCount = filtered.length;

    list.innerHTML = "";
    if (!filtered.length) {
      list.innerHTML = `<div class="text-center muted py-10">Ù„Ø§ ØªÙˆØ¬Ø¯ Ø·Ù„Ø¨Ø§Øª Ù„Ù„ØªØ¬Ù‡ÙŠØ² Ø§Ù„Ø¢Ù†.</div>`;
      return;
    }
    filtered.forEach(o=>list.appendChild(card(o)));
  }

  $("btnRefresh").onclick = load;
  $("btnNotif").onclick = async ()=>{
    if (!("Notification" in window)) return alert("Ø§Ù„Ù…ØªØµÙØ­ Ù„Ø§ ÙŠØ¯Ø¹Ù… Ø¥Ø´Ø¹Ø§Ø±Ø§Øª");
    const p = await Notification.requestPermission();
    alert(p === "granted" ? "ØªÙ… ØªÙØ¹ÙŠÙ„ Ø§Ù„Ø¥Ø´Ø¹Ø§Ø±Ø§Øª âœ…" : "ØªÙ… Ø§Ù„Ø±ÙØ¶");
  };

  // auto refresh every 8s
  setInterval(load, 8000);
  load();
</script>
</body>
</html>
