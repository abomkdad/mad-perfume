<!doctype html>
<html lang="he" dir="rtl">
<head>
  <meta charset="utf-8"/>
  <title>MAD SYSTEM v5.2 | Final Stable</title>
  
  <script src="https://cdn.jsdelivr.net/npm/jsbarcode@3.11.5/dist/JsBarcode.all.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/qrcodejs@1.0.0/qrcode.min.js"></script>
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">

  <style>
    :root { --bg: #0f172a; --card: #1e293b; --blue: #3b82f6; --text: #f8fafc; --green: #10b981; --red: #ef4444; --orange: #f59e0b; }
    body { font-family: system-ui, sans-serif; background: var(--bg); color: var(--text); margin: 0; direction: rtl; }
    
    header { background: var(--card); padding: 15px 25px; display: flex; justify-content: space-between; align-items: center; border-bottom: 2px solid #334155; position: sticky; top: 0; z-index: 100; }
    
    .search-box { flex: 1; max-width: 400px; position: relative; margin: 0 20px; }
    .search-box input { width: 100%; padding: 10px 15px; border-radius: 8px; border: 1px solid #334155; background: #0f172a; color: white; font-size: 16px; }

    .grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(320px, 1fr)); gap: 20px; padding: 20px; }
    
    .card { background: var(--card); border-radius: 15px; overflow: hidden; border: 1px solid #334155; transition: 0.3s; position: relative; display: flex; flex-direction: column; }
    .card:hover { border-color: var(--blue); transform: translateY(-5px); box-shadow: 0 10px 20px rgba(0,0,0,0.3); }
    .card.selected { border: 2px solid var(--blue); background: #263345; }

    .status-badge { position: absolute; top: 10px; left: 10px; padding: 4px 10px; border-radius: 20px; font-size: 11px; font-weight: bold; }
    .status-waiting { background: var(--orange); color: #000; }
    .status-ready { background: var(--green); color: #fff; }

    .card-content { padding: 15px; flex-grow: 1; }
    .card-id { font-size: 12px; color: #94a3b8; font-weight: bold; }
    .card-name { font-size: 22px; font-weight: bold; margin: 5px 0; color: #fff; }
    .card-detail { font-size: 14px; color: #cbd5e1; margin: 5px 0; display: flex; align-items: center; gap: 8px; }
    .card-items { background: rgba(0,0,0,0.2); padding: 8px; border-radius: 6px; margin-top: 10px; font-size: 13px; color: #94a3b8; border: 1px solid #334155; }
    
    .card-price { font-size: 26px; font-weight: 900; color: var(--green); margin-top: 10px; padding-top: 10px; border-top: 1px dashed #334155; }

    .card-actions { display: grid; grid-template-columns: 1fr 1fr 1fr; border-top: 1px solid #334155; background: #161e2e; }
    .btn-action { border: none; background: transparent; color: #cbd5e1; padding: 12px 5px; cursor: pointer; font-size: 13px; transition: 0.2s; display: flex; flex-direction: column; align-items: center; gap: 5px; border-left: 1px solid #334155; }
    .btn-action:last-child { border-left: none; }
    .btn-action:hover { background: #1e293b; color: #fff; }
    
    .btn-print:hover { color: var(--blue); }
    .btn-edit:hover { color: #fbbf24; }
    .btn-select:hover { color: var(--green); }

    .bulk-bar { position: fixed; bottom: 20px; left: 50%; transform: translateX(-50%); background: white; color: black; padding: 15px 30px; border-radius: 50px; display: none; align-items: center; gap: 20px; box-shadow: 0 10px 30px rgba(0,0,0,0.5); z-index: 1000; }
    .bulk-bar.active { display: flex; }

    @media print {
      body * { visibility: hidden; }
      #printArea, #printArea * { visibility: visible; }
      #printArea { position: absolute; left: 0; top: 0; width: 100%; display: block !important; }
      @page { size: 100mm 100mm; margin: 0; }
      .label { width: 100mm; height: 100mm; padding: 5mm; background: white !important; color: black !important; display: flex; flex-direction: column; page-break-after: always; border: 1px solid #000; box-sizing: border-box; }
    }
    #printArea { display: none; }
  </style>
</head>
<body>

<header>
  <div style="font-size: 24px; font-weight: 900;">MAD <span style="color:var(--blue)">V5.2</span></div>
  <div class="search-box">
    <input type="text" id="searchInput" placeholder="×—×™×¤×•×© ×œ×¤×™ ×©× ××• ×˜×œ×¤×•×Ÿ..." oninput="app.render()">
  </div>
  <div id="syncIndicator" style="font-size: 12px; color: var(--green);">×¡× ×›×¨×•×Ÿ ×¤×¢×™×œ â—</div>
</header>

<div id="debugStatus" style="background: #334155; font-size: 12px; padding: 5px 20px; text-align: center;">××ª×—×‘×¨...</div>

<div class="grid" id="grid"></div>

<div class="bulk-bar" id="bulkBar">
  <span id="selectedCount" style="font-weight: bold;">0 × ×‘×—×¨×•</span>
  <button onclick="app.printSelected()" style="background: #000; color: #fff; border: none; padding: 8px 20px; border-radius: 20px; cursor: pointer; font-weight: bold;">×”×“×¤×¡ × ×‘×—×¨×™× ğŸ–¨ï¸</button>
  <button onclick="app.clearSelection()" style="background: none; border: none; text-decoration: underline; cursor: pointer;">×‘×™×˜×•×œ</button>
</div>

<div id="printArea"></div>

<audio id="notifSound" src="https://assets.mixkit.co/active_storage/sfx/2869/2869-preview.mp3"></audio>

<script>
class MadSystem {
  constructor() {
    this.scriptUrl = "https://script.google.com/macros/s/AKfycbyLjLFa8AaH82Ip7m747WC-KSUUEaU_M70S0I9Mda14XbnmcuEfZ7pBnF_zzJYZuXmZ/exec";
    this.orders = [];
    this.selected = new Set();
    this.loadData();
    
    // ×¨×¢× ×•×Ÿ ××•×˜×•××˜×™ ×›×œ 5 ×©× ×™×•×ª
    setInterval(() => this.loadData(true), 5000);
  }

  async loadData(isSilent = false) {
    const debug = document.getElementById('debugStatus');
    if(!isSilent) debug.innerHTML = "×˜×•×¢×Ÿ × ×ª×•× ×™×...";
    
    try {
      const res = await fetch(`${this.scriptUrl}?action=get`);
      const newData = await res.json();
      
      if (this.orders.length > 0 && newData.length > this.orders.length) {
        this.notifyNewOrder();
      }

      // ××™×•×Ÿ: ×××ª×™×Ÿ ×œ×˜×™×¤×•×œ (×××ª×™×Ÿ) ×™×•×¤×™×¢ ×¨××©×•×Ÿ
      this.orders = newData.sort((a, b) => {
        const statusA = (a.status || "×××ª×™×Ÿ").trim();
        const statusB = (b.status || "×××ª×™×Ÿ").trim();
        if (statusA === "×××ª×™×Ÿ" && statusB !== "×××ª×™×Ÿ") return -1;
        if (statusA !== "×××ª×™×Ÿ" && statusB === "×××ª×™×Ÿ") return 1;
        return 0;
      });

      debug.innerHTML = `âœ… ××¢×•×“×›×Ÿ: ${new Date().toLocaleTimeString()} | ${this.orders.length} ×”×–×× ×•×ª`;
      this.render();
    } catch (e) {
      debug.innerHTML = `âŒ ×©×’×™××ª ×¡× ×›×¨×•×Ÿ`;
    }
  }

  notifyNewOrder() {
    document.getElementById('notifSound').play().catch(e => {});
    const indicator = document.getElementById('syncIndicator');
    indicator.style.color = "var(--red)";
    indicator.innerHTML = "×”×–×× ×” ×—×“×©×” ×”×’×™×¢×”! ğŸ””";
    setTimeout(() => {
        indicator.style.color = "var(--green)";
        indicator.innerHTML = "×¡× ×›×¨×•×Ÿ ×¤×¢×™×œ â—";
    }, 4000);
  }

  fixLang(val) {
    if(!val) return "---";
    const map = { 
        "cash": "××–×•××Ÿ", "credit": "××©×¨××™", "bit": "×‘×™×˜", 
        "pending": "×××ª×™×Ÿ", "waiting": "×××ª×™×Ÿ", "ready": "××•×›×Ÿ" 
    };
    const cleaned = val.toString().toLowerCase().trim();
    return map[cleaned] || val;
  }

  render() {
    const query = document.getElementById('searchInput').value.toLowerCase().replace(/[-\s]/g, "");
    const grid = document.getElementById('grid');
    
    const filtered = this.orders.filter(o => {
      const name = String(o.name || o.customer || "").toLowerCase();
      const phone = String(o.phone || o.tel || "").replace(/[-\s]/g, "");
      return name.includes(query) || phone.includes(query);
    });

    grid.innerHTML = filtered.map(o => {
      const uniqueId = o.orderId || o.id;
      const isSelected = this.selected.has(uniqueId);
      const isReady = (o.status || "").includes("××•×›×Ÿ") || (o.status === "ready");
      
      return `
        <div class="card ${isSelected ? 'selected' : ''}">
          <span class="status-badge ${isReady ? 'status-ready' : 'status-waiting'}">
            ${isReady ? '××•×›×Ÿ' : '×××ª×™×Ÿ ×œ×ª×”×œ×™×š'}
          </span>
          <div class="card-content">
            <div class="card-id">#${uniqueId}</div>
            <div class="card-name">${o.name || o.customer || '×œ×œ× ×©×'}</div>
            <div class="card-detail"><i class="fas fa-phone"></i> ${o.phone || o.tel || '---'}</div>
            <div class="card-detail"><i class="fas fa-map-marker-alt"></i> ${this.fixLang(o.city || o.address)}</div>
            <div class="card-detail"><i class="fas fa-credit-card"></i> ${this.fixLang(o.payment)}</div>
            
            <div class="card-items">
                <strong>××•×¦×¨×™×:</strong><br>
                ${o.items || o.products || '×œ× ×¦×•×™× ×• ××•×¦×¨×™×'}
            </div>

            <div class="card-price">â‚ª${o.price || '0'}</div>
          </div>
          
          <div class="card-actions">
            <button class="btn-action btn-print" onclick="app.printSingle('${uniqueId}')">
              <i class="fas fa-print"></i> ×”×“×¤×¡×”
            </button>
            <button class="btn-action btn-edit" onclick="app.toggleStatus('${uniqueId}')">
              <i class="fas fa-sync"></i> ${isReady ? '×©× ×” ×œ×××ª×™×Ÿ' : '×¡××Ÿ ×›××¢×•×“×›×Ÿ'}
            </button>
            <button class="btn-action btn-select" onclick="app.toggleSelect('${uniqueId}')">
              <i class="fas ${isSelected ? 'fa-check-circle' : 'fa-plus-circle'}"></i> 
              ${isSelected ? '× ×‘×—×¨' : '×‘×—×¨'}
            </button>
          </div>
        </div>
      `;
    }).join("");
  }

  toggleSelect(id) {
    this.selected.has(id) ? this.selected.delete(id) : this.selected.add(id);
    this.updateBulkBar();
    this.render();
  }

  updateBulkBar() {
    const bar = document.getElementById('bulkBar');
    document.getElementById('selectedCount').innerText = `${this.selected.size} ×”×–×× ×•×ª × ×‘×—×¨×• ×œ×”×“×¤×¡×”`;
    this.selected.size > 0 ? bar.classList.add('active') : bar.classList.remove('active');
  }

  clearSelection() {
    this.selected.clear();
    this.updateBulkBar();
    this.render();
  }

  async toggleStatus(id) {
    // ×›××Ÿ × ×©×œ×—×ª ×‘×§×©×” ×œ×¢×“×›×•×Ÿ ×”×¡×˜×˜×•×¡ ×‘-Google Sheets
    const debug = document.getElementById('debugStatus');
    debug.innerHTML = "××¢×“×›×Ÿ ×¡×˜×˜×•×¡ ×‘×©×¨×ª...";
    try {
        await fetch(`${this.scriptUrl}?action=update&id=${id}`);
        this.loadData(true);
    } catch(e) {
        alert("×©×’×™××” ×‘×¢×“×›×•×Ÿ ×”×¡×˜×˜×•×¡");
    }
  }

  printSingle(id) {
    const o = this.orders.find(ord => (ord.orderId || ord.id) == id);
    const area = document.getElementById('printArea');
    area.innerHTML = this.generateLabel(o);
    setTimeout(() => { window.print(); }, 300);
  }

  printSelected() {
    const area = document.getElementById('printArea');
    const list = this.orders.filter(o => this.selected.has(o.orderId || o.id));
    
    if(list.length === 0) return;

    area.innerHTML = list.map(o => this.generateLabel(o)).join("");
    setTimeout(() => {
      window.print();
      this.clearSelection();
    }, 500);
  }

  generateLabel(o) {
    return `
      <div class="label" dir="rtl">
        <div style="display:flex; justify-content:space-between; border-bottom:4px solid black; padding-bottom:10px; margin-bottom:10px;">
          <b style="font-size:28pt;">MAD PARFUM</b>
          <span style="font-size:18pt;">#${o.orderId || o.id || ''}</span>
        </div>
        <div style="font-size:20pt; margin-top:5px;"><b>×œ×›×‘×•×“:</b> ${o.name || o.customer || ''}</div>
        <div style="font-size:20pt;"><b>×˜×œ×¤×•×Ÿ:</b> ${o.phone || o.tel || ''}</div>
        <div style="font-size:20pt;"><b>×¢×™×¨:</b> ${this.fixLang(o.city || o.address)}</div>
        <div style="font-size:20pt; border-bottom:1px solid #ccc; padding-bottom:10px;"><b>×ª×©×œ×•×:</b> ${this.fixLang(o.payment)}</div>
        
        <div style="font-size:14pt; margin-top:10px; flex-grow:1;">
            <b>×¤×™×¨×•×˜ ×”×–×× ×”:</b><br>
            ${o.items || o.products || ''}
        </div>

        <div style="border:5px solid black; font-size:45pt; font-weight:900; text-align:center; margin-top:auto; border-radius:15px; background:#000; color:#fff !important;">
          â‚ª${o.price || '0'}
        </div>
      </div>
    `;
  }
}

const app = new MadSystem();
</script>
</body>
</html>
