<!doctype html>
<html lang="he" dir="rtl">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width,initial-scale=1"/>
  <title>MAD SMART SYSTEM</title>
  
  <script src="https://cdn.jsdelivr.net/npm/jsbarcode@3.11.5/dist/JsBarcode.all.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/qrcodejs@1.0.0/qrcode.min.js"></script>

  <style>
    :root { 
      --bg: #1a1a2e; --card: #16213e; --primary: #0f3460; 
      --accent: #e94560; --text: #f1f1f1; --success: #22c55e;
    }

    body { margin: 0; font-family: 'Segoe UI', Tahoma, sans-serif; background: var(--bg); color: var(--text); height: 100vh; display: flex; flex-direction: column; overflow: hidden; }
    
    /* Header */
    .header { 
      background: rgba(0,0,0,0.8); padding: 10px 20px; border-bottom: 3px solid var(--accent);
      display: flex; gap: 20px; align-items: center; justify-content: space-between;
    }
    .search-container { flex: 1; display: flex; gap: 10px; max-width: 600px; }
    .search-box { 
      width: 100%; padding: 12px; border-radius: 8px; border: 1px solid #444; 
      background: #0f3460; color: white; font-size: 1.1rem; outline: none; transition: 0.3s;
    }
    .search-box:focus { border-color: var(--accent); background: #1a1a2e; }

    .btn { cursor: pointer; border: none; padding: 10px 20px; border-radius: 6px; font-weight: bold; color: white; transition: 0.2s; font-size: 1rem; }
    .btn-refresh { background: #333; }
    .btn-all { background: var(--accent); }
    .btn-all:hover { opacity: 0.8; }

    /* Workspace Grid */
    .workspace { flex: 1; overflow-y: auto; padding: 20px; }
    .grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(300px, 1fr)); gap: 15px; }

    .card { 
      background: var(--card); border: 1px solid #2a2a40; border-radius: 12px; padding: 15px; 
      cursor: pointer; position: relative; transition: transform 0.2s; border-right: 5px solid transparent;
    }
    .card:hover { transform: translateY(-5px); background: #1f2b4d; border-color: var(--accent); }
    .card.rush { border-right-color: var(--accent); } 

    .card-head { display: flex; justify-content: space-between; color: #888; font-size: 0.9rem; margin-bottom: 5px; }
    .card-name { font-size: 1.3rem; font-weight: bold; color: #fff; margin-bottom: 5px; }
    .card-sub { font-size: 0.95rem; color: #ccc; line-height: 1.4; }
    .card-price { position: absolute; bottom: 15px; left: 15px; font-size: 1.2rem; font-weight: bold; color: var(--success); }

    /* Modal */
    .modal-overlay { display: none; position: fixed; inset: 0; background: rgba(0,0,0,0.95); z-index: 1000; justify-content: center; align-items: center; }
    .modal-box { width: 90%; max-width: 1000px; height: 80vh; background: #fff; color: #000; display: flex; border-radius: 10px; overflow: hidden; }
    
    .editor { width: 40%; background: #f4f4f4; padding: 20px; overflow-y: auto; display: flex; flex-direction: column; gap: 10px; }
    .preview { width: 60%; background: #ddd; display: flex; align-items: center; justify-content: center; padding: 20px; flex-direction: column; }

    .inp-group label { display: block; font-weight: bold; font-size: 0.9rem; }
    .inp-group input, .inp-group textarea { width: 100%; padding: 8px; border: 1px solid #ccc; border-radius: 5px; box-sizing: border-box; font-weight: bold; }
    
    .btn-print-big { width: 100%; padding: 15px; background: #000; color: #fff; font-size: 1.2rem; margin-top: auto; border: none; cursor: pointer; font-weight: bold; }

    /* ---------------------------------------------------- */
    /* LABEL DESIGN (10x10cm) - FIXED FOR PRINTING */
    /* ---------------------------------------------------- */
    .label-canvas { 
      width: 100mm; height: 100mm; background: #fff; color: #000; padding: 3mm; 
      box-sizing: border-box; border: 1px solid #ccc; display: flex; flex-direction: column; 
      overflow: hidden; position: relative; page-break-after: always; direction: rtl;
    }
    
    .lbl-head { display: flex; justify-content: space-between; height: 20mm; border-bottom: 1px solid #000; }
    .lbl-logo img { width: 35mm; }
    .lbl-meta { text-align: left; font-size: 9pt; font-weight: bold; }
    
    .lbl-promo { background: #000; color: #fff; text-align: center; font-weight: 900; font-size: 10pt; padding: 3px; margin: 2mm 0; }
    
    .lbl-info { font-size: 11pt; line-height: 1.3; font-weight: 600; }
    .lbl-content { border: 2px dashed #000; background: #eee; padding: 5px; margin: 2mm 0; font-size: 9pt; height: 16mm; overflow: hidden; font-weight: bold; }
    .lbl-price { border: 3px solid #000; font-size: 20pt; font-weight: 900; text-align: center; padding: 0; margin-bottom: 2mm; }
    
    .lbl-footer { display: flex; justify-content: space-between; align-items: flex-end; margin-top: auto; border-top: 1px solid #000; padding-top: 1mm; }
    .lbl-wa { font-size: 8pt; font-weight: 800; width: 65%; }

    /* Print Logic */
    #printArea { display: none; }
    @media print {
      body * { visibility: hidden !important; }
      #printArea, #printArea * { visibility: visible !important; }
      #printArea { 
        display: block !important; position: absolute; left: 0; top: 0; width: 100%; height: 100%; 
        background: white; z-index: 9999;
      }
      @page { size: 100mm 100mm; margin: 0; }
      .label-canvas { border: none; }
    }
  </style>
</head>
<body>

<div class="header">
  <div style="font-weight:900; font-size:1.5rem">MAD <span style="color:var(--accent)">SMART</span></div>
  <div class="search-container">
    <input class="search-box" id="search" placeholder="Ø¨Ø­Ø« Ø°ÙƒÙŠ: Ø±Ù‚Ù… Ù‡Ø§ØªÙ / Ø§Ø³Ù… / ÙƒÙˆØ¯..." oninput="render()">
  </div>
  <div style="display:flex; gap:10px">
    <button class="btn btn-refresh" onclick="loadData()">ØªØ­Ø¯ÙŠØ« â†»</button>
    <button class="btn btn-all" onclick="printAll()">Ø·Ø¨Ø§Ø¹Ø© Ø§Ù„ÙƒÙ„ ğŸ–¨ï¸</button>
  </div>
</div>

<div class="workspace">
  <div class="grid" id="grid"></div>
</div>

<div class="modal-overlay" id="editor">
  <div class="modal-box">
    <div class="editor" dir="rtl">
      <div style="display:flex; justify-content:space-between">
        <h2>ØªØ¹Ø¯ÙŠÙ„ Ø§Ù„Ø·Ù„Ø¨</h2>
        <button onclick="closeModal()" style="border:none;background:none;font-size:1.5rem;cursor:pointer">âœ•</button>
      </div>
      <div class="inp-group"><label>Ø§Ù„Ø§Ø³Ù…:</label><input id="e_name" oninput="updatePreview()"></div>
      <div class="inp-group"><label>Ø§Ù„Ù‡Ø§ØªÙ:</label><input id="e_phone" oninput="updatePreview()"></div>
      <div class="inp-group"><label>Ø§Ù„Ø¹Ù†ÙˆØ§Ù†:</label><input id="e_city" oninput="updatePreview()"></div>
      <div class="inp-group"><label>Ø§Ù„Ø´Ø­Ù†:</label><input id="e_del" oninput="updatePreview()"></div>
      <div class="inp-group"><label>Ø§Ù„Ù…Ø­ØªÙˆÙ‰:</label><textarea id="e_content" oninput="updatePreview()"></textarea></div>
      <div class="inp-group"><label>Ø§Ù„Ø³Ø¹Ø± (â‚ª):</label><input id="e_price" type="number" style="font-size:1.2rem;color:green" oninput="updatePreview()"></div>
      <button class="btn-print-big" onclick="printSingle()">Ø·Ø¨Ø§Ø¹Ø© (Enter) ğŸ–¨ï¸</button>
    </div>
    <div class="preview">
      <div id="livePreview" style="box-shadow: 0 10px 40px rgba(0,0,0,0.5);"></div>
    </div>
  </div>
</div>

<div id="printArea"></div>

<script>
  const SCRIPT_URL = "https://script.google.com/macros/s/AKfycbyLjLFa8AaH82Ip7m747WC-KSUUEaU_M70S0I9Mda14XbnmcuEfZ7pBnF_zzJYZuXmZ/exec";
  const PASSWORD = "12345678";
  let orders = [];
  let currentIndex = null;

  /* =========================================
     1. Phone Normalization Logic (The Core)
     ========================================= */
  function normalizeILPSPhone(input) {
    let d = String(input || "").replace(/[^0-9]/g, "");
    if (!d) return { ok: false, reason: "EMPTY", e164: "", display: "" };

    if (d.startsWith("00")) d = d.slice(2);
    if (d.startsWith("9720")) d = "972" + d.slice(4);
    if (d.startsWith("9700")) d = "970" + d.slice(4);

    // If starts with 972/970
    if (d.startsWith("972") || d.startsWith("970")) {
      return { ok: true, e164: "+" + d, display: d };
    }

    // If starts with 0
    if (d.startsWith("0")) {
      // 059 -> 970
      if (d.startsWith("059")) return { ok: true, e164: "+970" + d.slice(1), display: d };
      // 05x -> 972
      if (d.startsWith("05")) return { ok: true, e164: "+972" + d.slice(1), display: d };
      // Fallback
      return { ok: true, e164: "+972" + d.slice(1), display: d };
    }

    // If starts with 5 (missing 0)
    if (d.startsWith("5")) {
       if (d.startsWith("59")) return { ok: true, e164: "+970" + d, display: "0" + d };
       return { ok: true, e164: "+972" + d, display: "0" + d };
    }

    return { ok: false, e164: "+" + d, display: d };
  }

  // Init
  (function(){
    if(prompt("ÙƒÙ„Ù…Ø© Ø§Ù„Ø³Ø±:") !== PASSWORD) document.body.innerHTML = "Access Denied";
    else loadData();
  })();

  async function loadData() {
    try {
      const res = await fetch(`${SCRIPT_URL}?action=get`);
      const all = await res.json();
      orders = all.filter(o => {
        const s = (o.status || "").toLowerCase();
        return (s.includes("prep") || s.includes("approved")) && !s.includes("ready");
      });
      render();
    } catch(e) { console.error(e); }
  }

  /* =========================================
     2. Smart Search Logic
     ========================================= */
  function render() {
    const q = document.getElementById('search').value.toLowerCase().trim();
    // Normalize the search query itself if it looks like a phone
    const qNorm = normalizeILPSPhone(q).e164 || q; 
    const qClean = qNorm.replace('+', ''); // Search both +972 and 972

    const grid = document.getElementById('grid');
    
    // Filter
    const filtered = orders.filter(o => {
      if(!q) return true;
      
      // Normalize Order Phone
      const oPhoneInfo = normalizeILPSPhone(o.phone);
      const oPhoneE164 = oPhoneInfo.e164.toLowerCase();
      
      // Check: Name OR OrderID OR Normalized Phone
      return (o.name || "").toLowerCase().includes(q) ||
             (o.orderId || "").toString().includes(q) ||
             oPhoneE164.includes(qClean) || // Match +972...
             (o.phone || "").includes(q);   // Match raw input
    });

    document.querySelector('.header div').innerHTML = `MAD <span style="color:var(--accent)">SMART</span> (${filtered.length})`;

    if(filtered.length === 0) {
      grid.innerHTML = '<div style="color:white;text-align:center;grid-column:1/-1;padding:50px">Ù„Ø§ ØªÙˆØ¬Ø¯ Ù†ØªØ§Ø¦Ø¬ / Ù„Ø§ ÙŠÙˆØ¬Ø¯ Ø·Ù„Ø¨Ø§Øª</div>';
      return;
    }

    grid.innerHTML = filtered.map((o, i) => {
      // Find real index in main array
      const realIndex = orders.indexOf(o);
      const isRush = (o.delivery||"").includes("High");
      return `
        <div class="card ${isRush ? 'rush' : ''}" onclick="openEditor(${realIndex})">
          <div class="card-head">
            <span>#${o.orderId}</span>
            <span>${o.delivery || 'Standard'}</span>
          </div>
          <div class="card-name">${o.name}</div>
          <div class="card-sub">
            ğŸ“ ${o.phone}<br>
            ğŸ“ ${o.city}
          </div>
          <div class="card-price">â‚ª${o.price}</div>
        </div>
      `;
    }).join("");
  }

  /* =========================================
     3. Label Template (10x10)
     ========================================= */
  function getLabelHTML(data, idSuffix) {
    const date = new Date().toLocaleDateString('he-IL');
    
    // Use the Logic function!
    const phoneInfo = normalizeILPSPhone(data.phone);
    const waLink = `https://wa.me/${phoneInfo.e164.replace('+','')}`; 
    // Barcode: use clean digits (remove +)
    const barcodeVal = phoneInfo.e164.replace('+','');

    return `
      <div class="label-canvas" dir="rtl">
        <div class="lbl-head">
          <div class="lbl-logo"><img src="https://www.madparfum.com/logo.svg"></div>
          <div class="lbl-meta">
            DATE: ${date}<br>
            ORD: ${data.orderId}
          </div>
        </div>
        
        <div class="lbl-promo">×¦×œ× ××ª ×”×¨×’×¢ ×•×§×‘×œ ××ª× ×” ğŸ</div>
        
        <div class="lbl-info">
          <div><b>×œ×›×‘×•×“:</b> ${data.name}</div>
          <div><b>×˜×œ×¤×•×Ÿ:</b> <span dir="ltr">${phoneInfo.display}</span></div>
          <div><b>×›×ª×•×‘×ª:</b> ${data.city}</div>
          <div><b>××©×œ×•×—:</b> ${data.delivery}</div>
        </div>

        <div class="lbl-content">
          <b>×ª×›×•×œ×” (Content):</b><br>
          ${(data.offer || "").replace(/\n/g, "<br>")}
        </div>

        <div class="lbl-price">â‚ª ${data.price}</div>

        <div class="lbl-footer">
          <div class="lbl-wa">
            WhatsApp Video = FREE GIFT<br>
            ${phoneInfo.e164}
          </div>
          <div id="qr_${idSuffix}"></div>
        </div>
        <div style="position:absolute; bottom:2mm; width:92%; text-align:center">
           <svg id="bar_${idSuffix}" data-val="${barcodeVal}"></svg>
        </div>
      </div>
    `;
  }

  // --- Editor & Print Single ---
  function openEditor(idx) {
    currentIndex = idx;
    const o = orders[idx];
    
    document.getElementById('e_name').value = o.name;
    document.getElementById('e_phone').value = o.phone;
    document.getElementById('e_city').value = o.city + " " + (o.addr||"");
    document.getElementById('e_del').value = o.delivery || "High Express";
    document.getElementById('e_content').value = o.offer || "";
    document.getElementById('e_price').value = o.price;

    document.getElementById('editor').style.display = 'flex';
    updatePreview();

    document.onkeydown = (e) => {
      if(e.key === "Enter" && !e.shiftKey) { e.preventDefault(); printSingle(); }
      if(e.key === "Escape") closeModal();
    };
  }

  function closeModal() {
    document.getElementById('editor').style.display = 'none';
    document.onkeydown = null;
  }

  function updatePreview() {
    const data = getFormData();
    document.getElementById('livePreview').innerHTML = getLabelHTML(data, 'prev');
    generateCodes('prev');
  }

  function getFormData() {
    return {
      orderId: orders[currentIndex].orderId,
      name: document.getElementById('e_name').value,
      phone: document.getElementById('e_phone').value,
      city: document.getElementById('e_city').value,
      delivery: document.getElementById('e_del').value,
      offer: document.getElementById('e_content').value,
      price: document.getElementById('e_price').value
    };
  }

  /* =========================================
     4. Robust Print Logic (With Delays)
     ========================================= */
  function generateCodes(suffix) {
    // Generate QR
    const qrEl = document.getElementById(`qr_${suffix}`);
    if(qrEl) {
      qrEl.innerHTML = "";
      // Extract link from HTML logic or rebuild
      const phoneVal = document.getElementById(`bar_${suffix}`)?.getAttribute('data-val');
      if(phoneVal) {
        new QRCode(qrEl, { text: `https://wa.me/${phoneVal}`, width: 45, height: 45 });
      }
    }
    // Generate Barcode
    try {
      const barEl = document.getElementById(`bar_${suffix}`);
      if(barEl) {
        JsBarcode(barEl, barEl.getAttribute('data-val'), { format: "CODE128", height: 25, fontSize: 10, displayValue: false, margin:0 });
      }
    } catch(e){}
  }

  function printSingle() {
    const data = getFormData();
    const area = document.getElementById('printArea');
    area.innerHTML = getLabelHTML(data, 'print');
    
    // 1. Render HTML
    // 2. Wait small time -> Generate Codes
    // 3. Wait small time -> Print
    
    setTimeout(() => {
      generateCodes('print');
      
      setTimeout(async () => {
        window.print();
        
        // Update Server
        const row = orders[currentIndex].rowIndex;
        closeModal();
        await fetch(`${SCRIPT_URL}?action=updateStatus&key=${PASSWORD}&row=${row}&status=READY âœ…`);
        
        // Remove from list visually
        orders.splice(currentIndex, 1);
        render();
        
      }, 500); // 500ms delay for codes to render
    }, 100);
  }

  function printAll() {
    if(!orders.length) return alert("Ù„Ø§ ÙŠÙˆØ¬Ø¯ Ø·Ù„Ø¨Ø§Øª");
    if(!confirm(`Ø·Ø¨Ø§Ø¹Ø© ${orders.length} Ø·Ù„Ø¨ Ø¯ÙØ¹Ø© ÙˆØ§Ø­Ø¯Ø©ØŸ`)) return;

    const area = document.getElementById('printArea');
    area.innerHTML = orders.map((o, i) => getLabelHTML(o, `bulk_${i}`)).join("");

    setTimeout(() => {
      // Generate all codes
      orders.forEach((o, i) => generateCodes(`bulk_${i}`));

      setTimeout(() => {
        window.print();
        
        if(confirm("ØªÙ…Øª Ø§Ù„Ø·Ø¨Ø§Ø¹Ø©. Ù‡Ù„ Ø£Ù†Ù‚Ù„ Ø§Ù„ÙƒÙ„ Ø¥Ù„Ù‰ (Ø¬Ø§Ù‡Ø²)ØŸ")) {
          orders.forEach(o => fetch(`${SCRIPT_URL}?action=updateStatus&key=${PASSWORD}&row=${o.rowIndex}&status=READY âœ…`));
          orders = [];
          render();
        }
      }, 1500); // Longer delay for bulk
    }, 200);
  }

</script>
</body>
</html>
