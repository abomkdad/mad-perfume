<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no" />
  <title>MAD Prep</title>

  <link rel="icon" type="image/png" href="https://www.mad-parfumeur.com/assets/hero/logo.png">
  <script src="https://cdn.jsdelivr.net/npm/jsbarcode@3.11.5/dist/JsBarcode.all.min.js"></script>

  <style>
    :root{
      --bg:#0b1220;
      --card:#111c33;
      --line:#22304d;
      --text:#f8fafc;
      --muted:#9fb0c6;
      --primary:#60a5fa;
      --success:#22c55e;
      --warn:#f59e0b;
      --shadow: 0 10px 30px rgba(0,0,0,.35);
      --radius:18px;
    }
    *{ box-sizing:border-box; }
    body{
      margin:0;
      font-family: system-ui, -apple-system, Segoe UI, Roboto, Arial;
      background:var(--bg);
      color:var(--text);
      display:flex;
      justify-content:center;
      padding-bottom:70px;
    }
    .app{ width:100%; max-width:650px; }
    .top{
      position:sticky; top:0; z-index:999;
      background:rgba(11,18,32,.92);
      backdrop-filter: blur(8px);
      border-bottom:1px solid var(--line);
      padding:14px;
    }
    .head{
      display:flex; gap:10px; align-items:center;
    }
    .logo{
      width:42px;height:42px;border-radius:12px;
      background:#0f172a;
      border:1px solid var(--line);
      overflow:hidden;
      box-shadow: var(--shadow);
      flex:0 0 auto;
    }
    .logo img{ width:100%; height:100%; object-fit:cover; }
    .title{ flex:1; line-height:1.1; }
    .title b{ display:block; font-size:18px; }
    .title span{ display:block; color:var(--muted); font-weight:1000; font-size:12px; margin-top:4px; }

    .row{
      display:grid;
      grid-template-columns:1fr 1fr;
      gap:10px;
      margin-top:10px;
    }
    .box{
      background:#ffffff;
      border-radius:16px;
      border:2px solid rgba(96,165,250,.45);
      padding:10px;
      color:#000;
      box-shadow: var(--shadow);
    }
    .box label{
      display:block; font-size:11px; font-weight:1000; margin-bottom:6px; color:#0b1220;
    }
    .box select, .box input{
      width:100%;
      border:none;
      outline:none;
      background:transparent;
      font-size:18px;
      font-weight:1000;
      color:#000;
    }

    .search{
      width:100%;
      margin-top:10px;
      border-radius:16px;
      border:1px solid var(--line);
      background:#081127;
      color:var(--text);
      padding:14px;
      font-weight:900;
      outline:none;
      box-shadow: var(--shadow);
    }
    .search::placeholder{ color:#6b7d98; font-weight:900; }

    .content{ padding:14px; }
    .card{
      background:var(--card);
      border:1px solid var(--line);
      border-radius:var(--radius);
      padding:14px;
      box-shadow: var(--shadow);
      margin-bottom:12px;
    }
    .name{
      font-size:20px; font-weight:1000;
    }
    .meta{
      margin-top:8px;
      display:flex; flex-wrap:wrap; gap:8px;
      color:var(--muted);
      font-weight:900;
      font-size:12px;
    }
    .offer{
      margin-top:10px;
      background:#0a1430;
      border:1px solid var(--line);
      border-radius:16px;
      padding:12px;
      font-weight:1000;
      font-size:14px;
    }

    .actions{
      display:grid;
      grid-template-columns:1fr 1fr;
      gap:10px;
      margin-top:12px;
    }
    .btn{
      border:none; cursor:pointer;
      border-radius:16px;
      padding:16px;
      font-weight:1000;
      font-size:16px;
      color:var(--text);
      box-shadow: var(--shadow);
      transition:.15s;
      user-select:none;
    }
    .btn:active{ transform:scale(.98); }
    .btnPrint{ background:#1e3a8a; }
    .btnReady{ background:#16a34a; }
    .btn:disabled{ opacity:.25; cursor:not-allowed; }

    .bar{
      position:fixed;
      bottom:0; left:50%;
      transform:translateX(-50%);
      width:100%;
      max-width:650px;
      display:flex; gap:10px;
      padding:10px 14px;
      background:rgba(11,18,32,.95);
      border-top:1px solid var(--line);
      z-index:1000;
    }
    .bar button{
      flex:1;
      border:none; cursor:pointer;
      border-radius:16px;
      padding:14px;
      font-weight:1000;
      font-size:16px;
      color:var(--text);
      background:rgba(96,165,250,.18);
      border:1px solid rgba(96,165,250,.35);
      box-shadow: var(--shadow);
    }

    .toast{
      position:fixed;
      top:-120px;
      left:50%;
      transform:translateX(-50%);
      background:var(--warn);
      color:#000;
      font-weight:1000;
      padding:14px 18px;
      border-radius:999px;
      box-shadow: var(--shadow);
      transition:.5s;
      z-index:3000;
    }
    .toast.show{ top:18px; }

    .empty{
      text-align:center;
      color:var(--muted);
      padding:26px 10px;
      font-weight:1000;
    }

    #print-container{ display:none; }
    @media print {
      body * { visibility:hidden; }
      #print-container, #print-container * { visibility:visible; }
      #print-container { display:block !important; position:absolute; left:0; top:0; width:100%; }
      .print-page { width:100mm; height:100mm; margin:0 auto; padding:5mm; box-sizing:border-box; background:white; color:black; }
    }
  </style>
</head>

<body>
  <div class="toast" id="toast">ØªÙ… âœ…</div>

  <div class="app">
    <div class="top">
      <div class="head">
        <div class="logo"><img src="https://www.mad-parfumeur.com/assets/hero/logo.png" alt="MAD"></div>
        <div class="title">
          <b>Ù†Ø³Ø®Ø© Ø§Ù„ØªØ¬Ù‡ÙŠØ² âœ…</b>
          <span>ØªØ¸Ù‡Ø± Ø§Ù„Ø·Ù„Ø¨Ø§Øª Ø§Ù„Ù…Ø¹ØªÙ…Ø¯Ø© ÙÙ‚Ø· â€” Ø²Ø±Ù‘ÙŠÙ†: Ø·Ø¨Ø§Ø¹Ø© + ØªÙ… Ø§Ù„ØªØ¬Ù‡ÙŠØ²</span>
        </div>
      </div>

      <div class="row">
        <div class="box">
          <label>ğŸ‘¤ Ø§Ø³Ù… Ø§Ù„Ù…ÙˆØ¸ÙØ© (Ø§Ø®ØªØ§Ø±ÙŠ Ù…Ø±Ø© ÙˆØ§Ø­Ø¯Ø©)</label>
          <select id="emp" onchange="saveEmp()">
            <option value="">-- Ø§Ø®ØªØ§Ø±ÙŠ Ø§Ø³Ù…Ùƒ --</option>
            <option value="Ø¹Ø¨ÙŠØ± (×¢×‘×™×¨)">Ø¹Ø¨ÙŠØ± (×¢×‘×™×¨)</option>
            <option value="Ø£Ù„Ø§Ø¡ (××œ××)">Ø£Ù„Ø§Ø¡ (××œ××)</option>
            <option value="Ù„ÙŠÙ„Ù‰ (×œ×™×™×œ×)">Ù„ÙŠÙ„Ù‰ (×œ×™×™×œ×)</option>
          </select>
        </div>

        <div class="box">
          <label>ğŸ”„ ØªØ­Ø¯ÙŠØ«</label>
          <button style="width:100%; border:none; background:transparent; font-size:18px; font-weight:1000; cursor:pointer;" onclick="sync()">
            Ø§Ø¶ØºØ· Ù„Ù„ØªØ­Ø¯ÙŠØ« Ø§Ù„Ø¢Ù†
          </button>
        </div>
      </div>

      <input id="q" class="search" placeholder="Ø§Ø¨Ø­Ø« Ø¨Ø§Ù„Ø§Ø³Ù… Ø£Ùˆ Ø§Ù„Ù‡Ø§ØªÙ..." oninput="render()">
    </div>

    <div class="content">
      <div id="list"></div>
    </div>

    <div class="bar">
      <button onclick="sync()">â†» ØªØ­Ø¯ÙŠØ« Ø§Ù„Ø¢Ù†</button>
      <button onclick="scrollToTop()">â¬†ï¸ Ø£Ø¹Ù„Ù‰</button>
    </div>
  </div>

  <div id="print-container"></div>

<script>
  // âœ… Ø±Ø§Ø¨Ø· Ø§Ù„Ù€ Apps Script Web App
  const SCRIPT_URL = "https://script.google.com/macros/s/AKfycbw2QxGHOxMv7_uNbMulwO60IHOcKj16rbBJRfoltkwcdb2Bg4zrVjyMt_lf9KgnyyXl/exec";

  let all = [];
  let statusLocal = JSON.parse(localStorage.getItem("mad_status_map") || "{}");

  function toast(msg){
    const t = document.getElementById("toast");
    t.textContent = msg;
    t.classList.add("show");
    setTimeout(()=>t.classList.remove("show"), 2500);
  }

  function saveEmp(){
    const v = document.getElementById("emp").value;
    localStorage.setItem("mad_emp_name", v);
    toast(v ? "âœ… ØªÙ… Ø­ÙØ¸ Ø§Ø³Ù…Ùƒ" : "âš ï¸ Ø§Ø®ØªØ§Ø±ÙŠ Ø§Ø³Ù…Ùƒ");
    render();
  }

  function loadEmp(){
    const v = localStorage.getItem("mad_emp_name") || "";
    document.getElementById("emp").value = v;
  }

  async function sync(){
    try{
      const res = await fetch(`${SCRIPT_URL}?action=get&t=${Date.now()}`, { cache:"no-store" });
      const data = await res.json();
      all = Array.isArray(data) ? data : [];
      render();
    }catch(e){
      console.error(e);
      toast("âŒ Ù…Ø´ÙƒÙ„Ø© Ø§ØªØµØ§Ù„");
    }
  }

  function getS(o){
    return String(statusLocal[o.orderId] || o.status || "");
  }
  function setS(orderId, s){
    statusLocal[orderId] = s;
    localStorage.setItem("mad_status_map", JSON.stringify(statusLocal));
  }

  function getPrice(o){
    const p = o.price || "150";
    const only = String(p).replace(/[^\d]/g,"");
    return only || "150";
  }

  function normalizePhone(p){
    let d = String(p||"").replace(/[^\d]/g,"");
    if (d.startsWith("00")) d = d.slice(2);
    if (d.startsWith("9720")) d = "972" + d.slice(4);
    if (d.startsWith("0")) {
      if (d.startsWith("059") && d.length >= 10) d = "970" + d.slice(1);
      else if (d.startsWith("05") && d.length >= 10) d = "972" + d.slice(1);
      else if (d.length >= 9) d = "972" + d.slice(1);
    }
    if (d.length === 9 && d.startsWith("5")) d = "972" + d;
    if (d.length === 9 && d.startsWith("59")) d = "970" + d;
    return d;
  }

  function extractDeliveryFromStatus(s){
    const m = String(s||"").match(/\(××©×œ×•×—:\s*(.*?)\)/);
    return m ? m[1] : "ØºÙŠØ± Ù…Ø­Ø¯Ø¯";
  }

  async function updateStatus(rowIndex, orderId, status){
    setS(orderId, status);
    render();
    try{
      await fetch(`${SCRIPT_URL}?action=updateStatus&row=${encodeURIComponent(rowIndex)}&orderId=${encodeURIComponent(orderId)}&status=${encodeURIComponent(status)}&t=${Date.now()}`, { cache:"no-store" });
      toast("âœ… ØªÙ…");
    }catch(e){
      toast("âš ï¸ ØªÙ… Ù…Ø­Ù„ÙŠÙ‹Ø§ (ØªØ­Ù‚Ù‚ Ù…Ù† Ø§Ù„Ø³ÙƒØ±Ø¨Øª)");
    }
  }

  function printSticker(o){
    const delivery = extractDeliveryFromStatus(getS(o));
    const price = getPrice(o);

    const c = document.getElementById("print-container");
    c.innerHTML = `
      <div class="print-page" dir="rtl">
        <div style="text-align:center; border-bottom:2px solid #000; font-weight:bold; font-size:16pt;">MAD - ØªØ¬Ù‡ÙŠØ²</div>
        <div style="font-size:12pt; margin:10px 0;">
          <b>Ø§Ø³Ù…:</b> ${escapeHtml(o.name)}<br>
          <b>Ù‡Ø§ØªÙ:</b> ${escapeHtml(o.phone)}<br>
          <b>Ø¹Ù†ÙˆØ§Ù†:</b> ${escapeHtml(o.city || "-")}<br>
          <b>Ø³Ø¹Ø±:</b> â‚ª${escapeHtml(price)}<br>
          <b>ØªÙˆØµÙŠÙ„:</b> ${escapeHtml(delivery)}
        </div>
        <div style="border:1.5px solid #000; padding:5px; background:#eee;">${escapeHtml(o.offer)}</div>
        <div style="font-size:8pt; border:1px solid red; color:red; text-align:center; font-weight:bold; margin-top:8px;">×”×—×œ×¤×” ××š ×•×¨×§ ×‘×ª× ××™ ×©×”× ×™×™×œ×•×Ÿ ×œ× × ×¤×ª×—</div>
        <div style="text-align:center; margin-top:10px;"><svg id="bcode_gen"></svg></div>
      </div>
    `;
    JsBarcode("#bcode_gen", String(o.phone||""), { format:"CODE128", width:1.8, height:40, displayValue:false });
    setTimeout(()=>window.print(), 350);
  }

  function card(o){
    const q = (document.getElementById("q").value || "").toLowerCase();
    const name = String(o.name || "-");
    const phone = String(o.phone || "-");
    const city = String(o.city || "-");
    const offer = String(o.offer || "-");
    const row = o.rowIndex;
    const orderId = o.orderId || "";
    const s = getS(o);

    // âœ… ÙÙ‚Ø· Ø§Ù„Ø·Ù„Ø¨Ø§Øª Ø§Ù„Ù…Ø¹ØªÙ…Ø¯Ø© (Approved) ÙˆØ§Ù„Ù„ÙŠ Ù…Ø´ Ø¬Ø§Ù‡Ø²Ø©/Ù…Ø³Ù„Ù…Ø©/Ù…Ù„ØºÙŠØ©
    const isApproved = s.includes("Approved") || s.includes("×××•×©×¨");
    const isReady = s.includes("××•×›×Ÿ");
    const isDelivered = s.includes("Delivered");
    const isCanceled = s.includes("Canceled") || s.includes("âŒ");
    if(!isApproved || isReady || isDelivered || isCanceled) return "";

    const match = name.toLowerCase().includes(q) || phone.includes(q) || offer.toLowerCase().includes(q);
    if(q && !match) return "";

    const emp = document.getElementById("emp").value || "";
    const delivery = extractDeliveryFromStatus(s);
    const price = getPrice(o);

    return `
      <div class="card">
        <div class="name">${escapeHtml(name)}</div>
        <div class="meta">
          <span>ğŸ“ ${escapeHtml(phone)}</span>
          <span>ğŸ“ ${escapeHtml(city)}</span>
          <span>ğŸšš ${escapeHtml(delivery)}</span>
          <span>ğŸ’° â‚ª${escapeHtml(price)}</span>
        </div>

        <div class="offer">ğŸ“¦ ${escapeHtml(offer)}</div>

        <div class="actions">
          <button class="btn btnPrint" onclick='printSticker(${safeJson(o)})'>ğŸ–¨ï¸ Ø·Ø¨Ø§Ø¹Ø© Ù…Ù„ØµÙ‚</button>
          <button class="btn btnReady" ${emp ? "" : "disabled"}
            onclick="finalizeReady('${row}','${escapeAttr(orderId)}','${escapeAttr(delivery)}')">
            âœ… ØªÙ… Ø§Ù„ØªØ¬Ù‡ÙŠØ²
          </button>
        </div>

        ${emp ? "" : `<div style="margin-top:10px; color:var(--warn); font-weight:1000;">âš ï¸ Ø§Ø®ØªØ§Ø±ÙŠ Ø§Ø³Ù…Ùƒ Ø¨Ø§Ù„Ø£Ø¹Ù„Ù‰ Ù„ÙŠØªÙØ¹Ù„ Ø²Ø± (ØªÙ… Ø§Ù„ØªØ¬Ù‡ÙŠØ²)</div>`}
      </div>
    `;
  }

  function finalizeReady(rowIndex, orderId, delivery){
    const emp = document.getElementById("emp").value || "";
    if(!emp){ toast("âŒ Ø§Ø®ØªØ§Ø±ÙŠ Ø§Ø³Ù…Ùƒ"); return; }
    const status = `××•×›×Ÿ ×¢×œ ×™×“×™ ${emp} (××©×œ×•×—: ${delivery})`;
    updateStatus(rowIndex, orderId, status);
  }

  function render(){
    const list = document.getElementById("list");
    const cards = all.slice().reverse().map(card).filter(Boolean).join("");
    list.innerHTML = cards || `<div class="empty">Ù„Ø§ ÙŠÙˆØ¬Ø¯ Ø·Ù„Ø¨Ø§Øª Ù…Ø¹ØªÙ…Ø¯Ø© Ø§Ù„Ø¢Ù† âœ…</div>`;
  }

  function scrollToTop(){
    window.scrollTo({ top:0, behavior:"smooth" });
  }

  function escapeHtml(str){
    return String(str ?? "").replace(/[&<>"']/g, s => ({
      "&":"&amp;","<":"&lt;",">":"&gt;",'"':"&quot;","'":"&#39;"
    }[s]));
  }
  function escapeAttr(str){
    return String(str ?? "").replace(/'/g, "\\'").replace(/"/g, '\\"');
  }
  function safeJson(obj){
    // stringify order safely for onclick
    return JSON.stringify(obj).replace(/</g,"\\u003c").replace(/>/g,"\\u003e").replace(/&/g,"\\u0026");
  }

  // Start
  loadEmp();
  sync();
  setInterval(sync, 25000);
</script>
</body>
</html>
