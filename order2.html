<!doctype html>
<html lang="ar" dir="rtl">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width,initial-scale=1"/>
  <title>MAD Prep | Ø·Ø¨Ø§Ø¹Ø© Ø¬Ù…Ø§Ø¹ÙŠØ©</title>
  
  <script src="https://cdn.jsdelivr.net/npm/jsbarcode@3.11.5/dist/JsBarcode.all.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/qrcodejs@1.0.0/qrcode.min.js"></script>

  <style>
    :root {
      --bg: #070b16; --card: #1e293b; --primary: #3b82f6; --success: #10b981; --text: #f8fafc;
    }
    body { margin: 0; font-family: 'Segoe UI', Tahoma, sans-serif; background: var(--bg); color: var(--text); }
    .container { max-width: 900px; margin: 0 auto; padding: 20px; }
    .top-nav { background: rgba(30, 41, 59, 0.8); backdrop-filter: blur(10px); padding: 15px; position: sticky; top: 0; z-index: 50; border-bottom: 1px solid rgba(255,255,255,0.1); }
    .search-input { width: 100%; padding: 12px; border-radius: 10px; border: 1px solid #334155; background: #0f172a; color: white; margin-top: 10px; }
    .order-card { background: var(--card); border-radius: 15px; padding: 20px; margin-bottom: 15px; display: flex; justify-content: space-between; align-items: center; }
    .btn { cursor: pointer; border: none; border-radius: 8px; padding: 10px 20px; font-weight: bold; transition: 0.3s; }
    .btn-edit { background: var(--primary); color: white; }
    .btn-all { background: #f59e0b; color: #000; margin-right: 10px; }
    .btn-done { background: var(--success); color: white; }

    /* Modal Styling */
    #editModal { display: none; position: fixed; inset: 0; background: rgba(0,0,0,0.85); z-index: 1000; justify-content: center; align-items: center; overflow-y: auto; }
    .modal-content { background: white; color: black; width: 110mm; padding: 20px; border-radius: 8px; box-shadow: 0 0 50px rgba(0,0,0,0.5); }
    .modal-content input { width: 100%; border: 1px solid #ddd; padding: 5px; margin-bottom: 8px; font-weight: bold; }

    /* Label Design */
    .label-preview { 
      width: 100mm; height: 100mm; background: #fff; color: #000; padding: 5mm; 
      box-sizing: border-box; border: 1px solid #eee; display: flex; flex-direction: column;
      page-break-after: always; /* Ù„Ù„ÙØµÙ„ Ø¨ÙŠÙ† Ø§Ù„Ù…Ù„ØµÙ‚Ø§Øª Ø¹Ù†Ø¯ Ø·Ø¨Ø§Ø¹Ø© Ø§Ù„ÙƒÙ„ */
    }
    .label-header { display: flex; justify-content: space-between; align-items: center; border-bottom: 2px solid #000; padding-bottom: 5px; margin-bottom: 10px; }
    .mad-logo { font-size: 24pt; font-weight: 900; }
    .price-box { border: 2px solid #000; padding: 8px; text-align: center; font-size: 16pt; font-weight: 900; margin: 10px 0; }
    .barcode-area { text-align: center; margin-top: auto; }
    .policy-text { border: 1px dashed #000; padding: 5px; text-align: center; font-size: 9pt; font-weight: bold; margin-top: 10px; }

    @media print {
      body * { visibility: hidden !important; }
      #printArea, #printArea * { visibility: visible !important; }
      #printArea { position: absolute; left: 0; top: 0; width: 100mm; display: block !important; }
      @page { size: 100mm 100mm; margin: 0; }
    }
  </style>
</head>
<body>

<div class="top-nav">
  <div class="container">
    <div style="display:flex; justify-content:space-between; align-items:center">
      <span style="font-weight:900; font-size:1.5rem">MAD PREP âš¡</span>
      <div style="display:flex">
        <button class="btn btn-all" onclick="printAllOrders()">ğŸ–¨ï¸ Ø·Ø¨Ø§Ø¹Ø© Ø§Ù„ÙƒÙ„</button>
        <button class="btn btn-edit" onclick="load()">ØªØ­Ø¯ÙŠØ« â†»</button>
      </div>
    </div>
    <input type="text" id="searchBox" class="search-input" placeholder="Ø§Ø¨Ø­Ø« Ø¹Ù† Ø§Ø³Ù… Ø§Ù„Ø¹Ù…ÙŠÙ„ Ø£Ùˆ Ø±Ù‚Ù… Ø§Ù„Ø·Ù„Ø¨..." oninput="render()">
  </div>
</div>

<div class="container" id="orderList"></div>

<div id="printArea"></div>

<div id="editModal">
  <div class="modal-content" dir="rtl" id="modalEditor">
    </div>
</div>

<script>
  const SCRIPT_URL = "https://script.google.com/macros/s/AKfycbyLjLFa8AaH82Ip7m747WC-KSUUEaU_M70S0I9Mda14XbnmcuEfZ7pBnF_zzJYZuXmZ/exec";
  const DASH_KEY = "12345678";
  let currentOrders = [];

  async function load() {
    document.getElementById('orderList').innerHTML = "Ø¬Ø§Ø±ÙŠ Ø§Ù„ØªØ­Ù…ÙŠÙ„...";
    const res = await fetch(`${SCRIPT_URL}?action=get`);
    currentOrders = await res.json();
    render();
  }

  function getPrepOrders() {
    return currentOrders.filter(o => {
      const st = (o.status || "");
      return (st.includes("Prep") || st.includes("Approved")) && !st.includes("READY");
    });
  }

  function render() {
    const q = document.getElementById('searchBox').value.toLowerCase();
    const filtered = getPrepOrders().filter(o => `${o.name} ${o.orderId}`.toLowerCase().includes(q));

    document.getElementById('orderList').innerHTML = filtered.map(o => `
      <div class="order-card">
        <div>
          <div style="font-weight:bold">${o.name}</div>
          <div style="font-size:0.8rem">ID: ${o.orderId} | â‚ª${o.price}</div>
        </div>
        <button class="btn btn-edit" onclick="openEdit(${o.rowIndex})">ØªØ¬Ù‡ÙŠØ² ğŸ·ï¸</button>
      </div>
    `).join("");
  }

  function createLabelHtml(o, isEditable = false) {
    const idSuffix = isEditable ? 'edit' : o.rowIndex;
    return `
      <div class="label-preview" dir="rtl">
        <div class="label-header">
          <div style="font-size: 10pt; font-weight: bold;">Order: ${o.orderId}</div>
          <div class="mad-logo">MAD</div>
        </div>
        <div style="margin-bottom:5px"><b>Ø§Ù„Ø§Ø³Ù…:</b> ${isEditable ? `<input id="i_name" value="${o.name}">` : o.name}</div>
        <div style="margin-bottom:5px"><b>Ø§Ù„Ù‡Ø§ØªÙ:</b> ${isEditable ? `<input id="i_phone" value="${o.phone}">` : o.phone}</div>
        <div style="margin-bottom:5px"><b>Ø§Ù„Ø¹Ù†ÙˆØ§Ù†:</b> ${isEditable ? `<input id="i_addr" value="${o.city} ${o.addr||''}">` : (o.city + " " + (o.addr||''))}</div>
        <div class="price-box">â‚ª ${isEditable ? `<input id="i_price" style="width:60px; text-align:center" value="${o.price}">` : o.price}</div>
        <div class="barcode-area">
          <svg id="bar_${idSuffix}"></svg>
        </div>
        <div class="policy-text">× ×™×ª×Ÿ ×œ×”×—×œ×™×£ ×¨×§ ×× ×”× ×™×™×œ×•×Ÿ ×œ× × ×¤×ª×— | Ø§Ù„ØªØ¨Ø¯ÙŠÙ„ ÙÙ‚Ø· Ø¥Ø°Ø§ Ù„Ù… ÙŠÙØªØ­ Ø§Ù„Ù†Ø§ÙŠÙ„ÙˆÙ†</div>
      </div>
    `;
  }

  function openEdit(rowIndex) {
    const o = currentOrders.find(x => x.rowIndex == rowIndex);
    const modal = document.getElementById('modalEditor');
    modal.innerHTML = `
      ${createLabelHtml(o, true)}
      <div style="display:flex; gap:10px; margin-top:15px">
        <button class="btn btn-done" style="flex:1" onclick="printSingle()">Ø·Ø¨Ø§Ø¹Ø© Ø§Ù„Ø¢Ù† ğŸ–¨ï¸</button>
        <button class="btn btn-edit" style="background:#64748b" onclick="document.getElementById('editModal').style.display='none'">Ø¥Ù„ØºØ§Ø¡</button>
      </div>
    `;
    document.getElementById('editModal').style.display = "flex";
    JsBarcode("#bar_edit", o.phone || "0000", { format: "CODE128", height: 30, displayValue: true });
  }

  function printSingle() {
    const pa = document.getElementById('printArea');
    pa.innerHTML = document.querySelector('.label-preview').outerHTML;
    window.print();
    document.getElementById('editModal').style.display = 'none';
  }

  function printAllOrders() {
    const ordersToPrint = getPrepOrders();
    if(ordersToPrint.length === 0) return alert("Ù„Ø§ ØªÙˆØ¬Ø¯ Ø·Ù„Ø¨Ø§Øª Ù„Ù„ØªØ¬Ù‡ÙŠØ²");
    
    const pa = document.getElementById('printArea');
    pa.innerHTML = ordersToPrint.map(o => createLabelHtml(o)).join("");
    
    // ØªÙˆÙ„ÙŠØ¯ Ø§Ù„Ø¨Ø§Ø±ÙƒÙˆØ¯Ø§Øª Ù„ÙƒÙ„ Ù…Ù„ØµÙ‚
    setTimeout(() => {
      ordersToPrint.forEach(o => {
        JsBarcode(`#bar_${o.rowIndex}`, o.phone || "0000", { format: "CODE128", height: 30, displayValue: true });
      });
      window.print();
    }, 500);
  }

  load();
</script>
</body>
</html>
