<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no" />
  <title>MAD Prep - Simple</title>
  <link rel="icon" type="image/png" href="https://www.mad-parfumeur.com/assets/hero/logo.png">
  <style>
    :root{
      --bg:#0b1220; --card:#111c33; --line:#22304d; --text:#f8fafc; --muted:#9fb0c6;
      --success:#16a34a; --primary:#2563eb; --warn:#d97706; --shadow:0 10px 30px rgba(0,0,0,.35); --r:18px;
    }
    *{box-sizing:border-box}
    body{margin:0;font-family:system-ui,Segoe UI,Arial;background:var(--bg);color:var(--text);display:flex;justify-content:center;padding-bottom:70px}
    .app{width:100%;max-width:680px}
    .top{position:sticky;top:0;z-index:999;background:rgba(11,18,32,.93);backdrop-filter:blur(8px);border-bottom:1px solid var(--line);padding:14px}
    .head{display:flex;gap:10px;align-items:center}
    .logo{width:44px;height:44px;border-radius:14px;overflow:hidden;border:1px solid var(--line);box-shadow:var(--shadow);background:#0f172a}
    .logo img{width:100%;height:100%;object-fit:cover}
    .title{flex:1;line-height:1.1}
    .title b{display:block;font-size:18px}
    .title span{display:block;margin-top:4px;font-size:12px;font-weight:900;color:var(--muted)}
    .row{display:flex;gap:10px;margin-top:10px}
    .box{flex:1;background:#fff;border-radius:16px;border:2px solid rgba(37,99,235,.35);padding:10px;color:#000;box-shadow:var(--shadow)}
    .box label{display:block;font-size:11px;font-weight:1000;margin-bottom:6px}
    .box select{width:100%;border:none;outline:none;background:transparent;font-size:16px;font-weight:1000}
    .btn{border:none;cursor:pointer;border-radius:16px;padding:14px;font-weight:1000;font-size:16px;color:var(--text);box-shadow:var(--shadow);transition:.12s;user-select:none}
    .btn:active{transform:scale(.98)}
    .btnPrimary{background:var(--primary)}
    .search{width:100%;margin-top:10px;border-radius:16px;border:1px solid var(--line);background:#081127;color:var(--text);padding:14px;font-weight:900;outline:none;box-shadow:var(--shadow)}
    .content{padding:14px}
    .card{background:var(--card);border:1px solid var(--line);border-radius:var(--r);padding:14px;box-shadow:var(--shadow);margin-bottom:12px}
    .name{font-size:20px;font-weight:1000}
    .meta{margin-top:8px;display:flex;flex-wrap:wrap;gap:8px;color:var(--muted);font-weight:900;font-size:12px}
    .offer{margin-top:10px;background:#0a1430;border:1px solid var(--line);border-radius:16px;padding:12px;font-weight:1000}
    .actions{display:grid;grid-template-columns:1fr 1fr;gap:10px;margin-top:12px}
    .btnReady{background:var(--success)}
    .btnEdit{background:var(--warn)}
    .btn:disabled{opacity:.25;cursor:not-allowed}
    .empty{text-align:center;color:var(--muted);padding:20px;font-weight:1000}
    .toast{position:fixed;top:-120px;left:50%;transform:translateX(-50%);background:#f59e0b;color:#000;font-weight:1000;padding:12px 16px;border-radius:999px;box-shadow:var(--shadow);transition:.5s;z-index:2000}
    .toast.show{top:16px}
    /* modal */
    .modalWrap{position:fixed;inset:0;background:rgba(0,0,0,.55);display:none;align-items:center;justify-content:center;padding:16px;z-index:3000}
    .modal{width:100%;max-width:560px;background:var(--card);border:1px solid var(--line);border-radius:22px;padding:14px;box-shadow:var(--shadow)}
    .modal h3{margin:0 0 12px 0;font-size:18px;font-weight:1000}
    .field{margin-top:10px;background:#fff;border-radius:16px;border:2px solid rgba(37,99,235,.35);padding:10px;color:#000}
    .field label{display:block;font-size:11px;font-weight:1000;margin-bottom:6px}
    .field input,.field textarea{width:100%;border:none;outline:none;background:transparent;font-size:16px;font-weight:1000}
  </style>
</head>
<body>
  <div class="toast" id="toast">ØªÙ… âœ…</div>

  <div class="app">
    <div class="top">
      <div class="head">
        <div class="logo"><img src="https://www.mad-parfumeur.com/assets/hero/logo.png" alt="MAD"></div>
        <div class="title">
          <b>Ù†Ø³Ø®Ø© Ø§Ù„ØªØ¬Ù‡ÙŠØ² (Ø³Ù‡Ù„ Ø¬Ø¯Ù‹Ø§)</b>
          <span>ØªØ¸Ù‡Ø± Ø§Ù„Ø·Ù„Ø¨Ø§Øª Ø§Ù„Ù…ÙØ±Ø³Ù„Ø© Ù„Ù„ØªØ¬Ù‡ÙŠØ² ÙÙ‚Ø·</span>
        </div>
        <button class="btn btnPrimary" onclick="sync()">â†»</button>
      </div>

      <div class="row">
        <div class="box">
          <label>ğŸ‘¤ Ø§Ø³Ù… Ø§Ù„Ù…ÙˆØ¸ÙØ©</label>
          <select id="emp" onchange="saveEmp()">
            <option value="">-- Ø§Ø®ØªØ§Ø±ÙŠ Ø§Ø³Ù…Ùƒ --</option>
            <option value="Ø¹Ø¨ÙŠØ± (×¢×‘×™×¨)">Ø¹Ø¨ÙŠØ± (×¢×‘×™×¨)</option>
            <option value="Ø£Ù„Ø§Ø¡ (××œ××)">Ø£Ù„Ø§Ø¡ (××œ××)</option>
            <option value="Ù„ÙŠÙ„Ù‰ (×œ×™×™×œ×)">Ù„ÙŠÙ„Ù‰ (×œ×™×™×œ×)</option>
          </select>
        </div>
      </div>

      <input id="q" class="search" placeholder="Ø¨Ø­Ø«..." oninput="render()">
    </div>

    <div class="content" id="list"></div>
  </div>

  <!-- Edit Modal -->
  <div class="modalWrap" id="modalWrap" onclick="closeModal(event)">
    <div class="modal" onclick="event.stopPropagation()">
      <h3>âœï¸ ØªØ¹Ø¯ÙŠÙ„ Ø§Ù„Ø·Ù„Ø¨ (Ù…ÙˆØ¸Ù)</h3>
      <div class="field"><label>Ù…Ø¯ÙŠÙ†Ø© / Ø¹Ù†ÙˆØ§Ù†</label><input id="m_city"></div>
      <div class="field"><label>Ø§Ù„Ø·Ù„Ø¨ (C)</label><input id="m_offer"></div>
      <div class="field"><label>Ù…Ù„Ø§Ø­Ø¸Ø§Øª</label><textarea id="m_notes" rows="3"></textarea></div>

      <div class="actions" style="margin-top:12px">
        <button class="btn btnEdit" onclick="closeModal()">Ø¥ØºÙ„Ø§Ù‚</button>
        <button class="btn btnReady" onclick="saveEdit()">âœ… Ø­ÙØ¸</button>
      </div>
    </div>
  </div>

<script>
  const SCRIPT_URL = "https://script.google.com/macros/s/AKfycbzNkx4pMGWNhH8BBBI_7qC61iYUgLjRlfJ877cwiQtKQaY5sXqq9Pmcg8zeCDaM9G9r/exec";
  let all = [];
  let editing = null; // {rowIndex, orderId}

  function toast(msg){
    const t = document.getElementById("toast");
    t.textContent = msg;
    t.classList.add("show");
    setTimeout(()=>t.classList.remove("show"), 2200);
  }

  function saveEmp(){
    localStorage.setItem("mad_emp", document.getElementById("emp").value || "");
    toast("âœ… ØªÙ…");
    render();
  }
  function loadEmp(){
    document.getElementById("emp").value = localStorage.getItem("mad_emp") || "";
  }

  async function sync(){
    try{
      const res = await fetch(`${SCRIPT_URL}?action=get&t=${Date.now()}`, { cache:"no-store" });
      const data = await res.json();
      all = Array.isArray(data) ? data : [];
      render();
    }catch(e){
      all = [];
      render();
      toast("âš ï¸ Ø§ØªØµØ§Ù„");
    }
  }

  function isApproved(s){ s=String(s||""); return s.includes("Approved") || s.includes("×××•×©×¨"); }
  function isReady(s){ s=String(s||""); return s.includes("××•×›×Ÿ"); }
  function isDelivered(s){ s=String(s||""); return s.includes("Delivered"); }
  function isCanceled(s){ s=String(s||""); return s.includes("Canceled") || s.includes("âŒ"); }

  async function updateStatus(row, orderId, status){
    try{
      await fetch(`${SCRIPT_URL}?action=updateStatus&row=${encodeURIComponent(row)}&orderId=${encodeURIComponent(orderId)}&status=${encodeURIComponent(status)}&t=${Date.now()}`, { cache:"no-store" });
      toast("âœ… ØªÙ…");
      setTimeout(sync, 400);
    }catch(e){
      toast("âš ï¸ ÙØ´Ù„");
    }
  }

  function openEdit(o){
    editing = { rowIndex: o.rowIndex, orderId: o.orderId };
    document.getElementById("m_city").value = o.city || "";
    document.getElementById("m_offer").value = o.offer || "";
    document.getElementById("m_notes").value = o.notes || "";
    document.getElementById("modalWrap").style.display = "flex";
  }
  function closeModal(){ document.getElementById("modalWrap").style.display = "none"; }

  async function saveEdit(){
    const city = (document.getElementById("m_city").value||"").trim();
    const offer = (document.getElementById("m_offer").value||"").trim();
    const notes = (document.getElementById("m_notes").value||"").trim();
    if(!editing) return;

    try{
      await fetch(`${SCRIPT_URL}?action=updateOrder&row=${encodeURIComponent(editing.rowIndex)}&orderId=${encodeURIComponent(editing.orderId)}&city=${encodeURIComponent(city)}&offer=${encodeURIComponent(offer)}&notes=${encodeURIComponent(notes)}&t=${Date.now()}`, { cache:"no-store" });
      toast("âœ… ØªÙ… Ø§Ù„ØªØ¹Ø¯ÙŠÙ„");
      closeModal();
      setTimeout(sync, 500);
    }catch(e){
      toast("âš ï¸ ÙØ´Ù„");
    }
  }

  function finalize(o){
    const emp = document.getElementById("emp").value || "";
    if(!emp){ toast("âŒ Ø§Ø®ØªØ§Ø±ÙŠ Ø§Ø³Ù…Ùƒ"); return; }
    // keep delivery inside status
    const s = String(o.status||"");
    const m = s.match(/\(××©×œ×•×—:\s*(.*?)\)/);
    const del = m ? m[1] : "ØºÙŠØ± Ù…Ø­Ø¯Ø¯";
    const status = `××•×›×Ÿ ×¢×œ ×™×“×™ ${emp} (××©×œ×•×—: ${del})`;
    updateStatus(o.rowIndex, o.orderId, status);
  }

  function render(){
    const q = (document.getElementById("q").value||"").toLowerCase();
    const emp = document.getElementById("emp").value || "";

    const arr = all.slice().reverse().filter(o=>{
      const s = String(o.status||"");
      if (isDelivered(s) || isCanceled(s) || isReady(s)) return false;
      if (!isApproved(s)) return false; // âœ… ÙÙ‚Ø· Ø§Ù„Ù„ÙŠ Ø£Ø±Ø³Ù„Ù‡Ø§ Ø§Ù„Ù…Ø¯ÙŠØ± Ù„Ù„ØªØ¬Ù‡ÙŠØ²
      const match = String(o.name||"").toLowerCase().includes(q) ||
                    String(o.phone||"").includes(q) ||
                    String(o.offer||"").toLowerCase().includes(q);
      if(q && !match) return false;
      return true;
    });

    if(!arr.length){
      document.getElementById("list").innerHTML = `<div class="empty">Ù„Ø§ ÙŠÙˆØ¬Ø¯ Ø·Ù„Ø¨Ø§Øª Ù„Ù„ØªØ¬Ù‡ÙŠØ² Ø§Ù„Ø¢Ù† âœ…</div>`;
      return;
    }

    document.getElementById("list").innerHTML = arr.map(o=>`
      <div class="card">
        <div class="name">${escapeHtml(o.name||"-")}</div>
        <div class="meta">
          <span>ğŸ“ ${escapeHtml(o.phone||"-")}</span>
          <span>ğŸ“ ${escapeHtml(o.city||"-")}</span>
        </div>
        <div class="offer">ğŸ“¦ ${escapeHtml(o.offer||"-")}</div>

        <div class="actions">
          <button class="btn btnReady" ${emp ? "" : "disabled"} onclick='finalize(${safeJson(o)})'>âœ… ØªÙ… ØªØ¬Ù‡ÙŠØ² Ø§Ù„Ø·Ù„Ø¨</button>
          <button class="btn btnEdit" onclick='openEdit(${safeJson(o)})'>âœï¸ ØªØ¹Ø¯ÙŠÙ„</button>
        </div>

        ${emp ? "" : `<div class="meta" style="margin-top:10px;color:#f59e0b;font-weight:1000">âš ï¸ Ø§Ø®ØªØ§Ø±ÙŠ Ø§Ø³Ù…Ùƒ Ù„ØªÙØ¹ÙŠÙ„ Ø²Ø± Ø§Ù„ØªØ¬Ù‡ÙŠØ²</div>`}
      </div>
    `).join("");
  }

  function escapeHtml(str){
    return String(str ?? "").replace(/[&<>"']/g, s => ({ "&":"&amp;","<":"&lt;",">":"&gt;",'"':"&quot;","'":"&#39;" }[s]));
  }
  function safeJson(obj){
    return JSON.stringify(obj).replace(/</g,"\\u003c").replace(/>/g,"\\u003e").replace(/&/g,"\\u0026");
  }

  loadEmp();
  sync();
  setInterval(sync, 20000);
</script>
</body>
</html>
