<!doctype html>
<html lang="ar" dir="rtl">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width,initial-scale=1"/>
  <title>MAD Prep | Ù†Ø¸Ø§Ù… Ø§Ù„Ù…Ù„ØµÙ‚Ø§Øª Ø§Ù„Ø°ÙƒÙŠ</title>
  
  <script src="https://cdn.jsdelivr.net/npm/jsbarcode@3.11.5/dist/JsBarcode.all.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/qrcodejs@1.0.0/qrcode.min.js"></script>

  <style>
    :root {
      --bg: #0f172a;
      --surface: #1e293b;
      --primary: #3b82f6;
      --success: #10b981;
      --text-main: #f8fafc;
      --border: rgba(255,255,255,0.1);
      /* Ù…Ù‚Ø§Ø³ Ø§Ù„Ù…Ù„ØµÙ‚ Ø§Ù„Ø¬Ø¯ÙŠØ¯ */
      --label-size: 100mm;
    }

    body { margin: 0; font-family: system-ui, -apple-system, sans-serif; background: var(--bg); color: var(--text-main); }
    .container { max-width: 800px; margin: 0 auto; padding: 20px; }
    
    /* Header */
    .top { position: sticky; top: 0; z-index: 100; background: rgba(15, 23, 42, 0.9); backdrop-filter: blur(10px); border-bottom: 1px solid var(--border); padding: 15px 0; }
    .header-row { display: flex; justify-content: space-between; align-items: center; margin-bottom: 10px; }
    
    /* Inputs */
    input { background: var(--surface); border: 1px solid var(--border); color: #fff; padding: 12px; border-radius: 10px; width: 100%; box-sizing: border-box; }
    
    /* Cards */
    .card { background: var(--surface); border-radius: 15px; padding: 20px; margin-bottom: 15px; border: 1px solid var(--border); }
    .card-title { font-size: 1.2rem; font-weight: bold; color: var(--primary); margin-bottom: 10px; }
    .info-line { margin-bottom: 5px; opacity: 0.9; }
    .btn { cursor: pointer; border: none; border-radius: 8px; padding: 12px 20px; font-weight: bold; transition: 0.2s; width: 100%; margin-top: 10px; }
    .btn-print { background: #fff; color: #000; }
    .btn-done { background: var(--success); color: #fff; }

    /* ---------- Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª Ø§Ù„Ø·Ø¨Ø§Ø¹Ø© (100x100) ---------- */
    #printArea { display: none; }
    
    @media print {
      @page { size: 100mm 100mm; margin: 0; }
      body * { visibility: hidden !important; }
      #printArea, #printArea * { visibility: visible !important; }
      #printArea { 
        display: block !important; 
        position: absolute; left: 0; top: 0; 
        width: 100mm; height: 100mm; 
        background: #fff !important; color: #000 !important;
        padding: 5mm; box-sizing: border-box;
      }
      .label-wrapper { 
        display: flex; flex-direction: column; align-items: center; 
        text-align: center; height: 100%; border: 1px solid #000; padding: 2mm;
      }
      .logo { width: 40mm; margin-bottom: 2mm; }
      .order-info { width: 100%; text-align: right; font-size: 12pt; font-weight: bold; margin-top: 2mm; border-top: 1px solid #000; padding-top: 2mm; }
      .barcode-svg { width: 60mm; height: 15mm; }
      .qr-code-box { margin-top: 2mm; }
      .policy-note { font-size: 9pt; font-weight: bold; margin-top: auto; border-top: 1px dashed #000; width: 100%; padding-top: 1mm; }
    }
  </style>
</head>
<body>

<div class="top">
  <div class="container">
    <div class="header-row">
      <div style="font-weight: 900; font-size: 1.4rem;">MAD PREP ğŸ·ï¸</div>
      <div id="stat">ØªØ­Ù…ÙŠÙ„...</div>
    </div>
    <input id="q" placeholder="Ø¨Ø­Ø« Ø¨Ø§Ø³Ù… Ø§Ù„Ø¹Ù…ÙŠÙ„ Ø£Ùˆ Ø±Ù‚Ù… Ø§Ù„Ø·Ù„Ø¨..." oninput="render()"/>
  </div>
</div>

<div class="container" id="list"></div>

<div id="printArea"></div>

<script>
  const SCRIPT_URL = "https://script.google.com/macros/s/AKfycbyLjLFa8AaH82Ip7m747WC-KSUUEaU_M70S0I9Mda14XbnmcuEfZ7pBnF_zzJYZuXmZ/exec";
  const DASH_KEY   = "12345678";
  let orders = [];

  (function(){
    const p = prompt("ÙƒÙ„Ù…Ø© Ø§Ù„Ø³Ø±:");
    if(p !== DASH_KEY) { document.body.innerHTML = "Ø®Ø·Ø£"; return; }
    load();
  })();

  async function load(){
    const res = await fetch(`${SCRIPT_URL}?action=get`);
    orders = await res.json();
    render();
  }

  function render(){
    const q = document.getElementById("q").value.toLowerCase();
    const items = orders.filter(o => {
      const st = String(o.status || "");
      return (st.includes("Prep") || st.includes("Approved")) && !st.includes("READY");
    }).filter(o => !q || `${o.name} ${o.orderId}`.toLowerCase().includes(q));

    document.getElementById("stat").textContent = `${items.length} Ø·Ù„Ø¨Ø§Øª`;
    
    document.getElementById("list").innerHTML = items.map(o => `
      <div class="card">
        <div class="card-title">Ø·Ù„Ø¨ Ø±Ù‚Ù…: ${o.orderId}</div>
        <div class="info-line">ğŸ‘¤ Ø§Ù„Ø§Ø³Ù…: ${o.name}</div>
        <div class="info-line">ğŸ“ Ø§Ù„Ø¹Ù†ÙˆØ§Ù†: ${o.city}</div>
        <div class="info-line">ğŸ›ï¸ Ø§Ù„Ù…Ù†ØªØ¬: ${o.offer}</div>
        <div class="info-line" style="color:var(--success); font-weight:bold">ğŸ’° Ø§Ù„Ù…Ø¨Ù„Øº: â‚ª${o.price}</div>
        <button class="btn btn-print" onclick="preparePrint(${o.rowIndex})">ğŸ–¨ï¸ Ø·Ø¨Ø§Ø¹Ø© Ù…Ù„ØµÙ‚ 100x100</button>
        <button class="btn btn-done" onclick="markReady(${o.rowIndex})">âœ… ØªÙ… Ø§Ù„ØªØ¬Ù‡ÙŠØ²</button>
      </div>
    `).join("");
  }

  function preparePrint(rowIndex){
    const o = orders.find(x => x.rowIndex == rowIndex);
    const pa = document.getElementById("printArea");
    
    // Ù…Ø­ØªÙˆÙ‰ Ø§Ù„Ù€ QR Code
    const qrText = `Order: ${o.orderId}\nName: ${o.name}\nPhone: ${o.phone}\nAddress: ${o.city}\nOffer: ${o.offer}\nPrice: â‚ª${o.price}`;

    pa.innerHTML = `
      <div class="label-wrapper" dir="rtl">
        <img src="https://www.madparfum.com/logo.svg" class="logo">
        
        <div class="order-info">
          <div>Ø±Ù‚Ù… Ø§Ù„Ø·Ù„Ø¨: ${o.orderId}</div>
          <div style="font-size: 14pt;">Ø§Ù„Ø§Ø³Ù…: ${o.name}</div>
          <div>Ø§Ù„Ù‡Ø§ØªÙ: ${o.phone}</div>
          <div>Ø§Ù„Ù…Ù†ØªØ¬: ${o.offer}</div>
          <div style="font-size: 16pt;">Ù„Ù„Ø¯ÙØ¹: â‚ª${o.price}</div>
        </div>

        <svg class="barcode-svg" id="b${o.rowIndex}"></svg>
        
        <div id="q${o.rowIndex}" class="qr-code-box"></div>

        <div class="policy-note">
           ×”×—×œ×¤×” ××ª×‘×¦×¢×ª ×¨×§ ×× ×”× ×™×™×œ×•×Ÿ ×œ× × ×¤×ª×— (Ø§Ù„ØªØ¨Ø¯ÙŠÙ„ ÙÙ‚Ø· Ø¥Ø°Ø§ Ù„Ù… ÙŠÙØªØ­ Ø§Ù„Ù†Ø§ÙŠÙ„ÙˆÙ†)
        </div>
      </div>
    `;

    // ØªÙˆÙ„ÙŠØ¯ Ø§Ù„Ø¨Ø§Ø±ÙƒÙˆØ¯ (Ø±Ù‚Ù… Ø§Ù„Ø¹Ù…ÙŠÙ„/Ø§Ù„Ù‡Ø§ØªÙ)
    JsBarcode(`#b${o.rowIndex}`, o.phone || "0000", {
      format: "CODE128",
      displayValue: true,
      fontSize: 14
    });

    // ØªÙˆÙ„ÙŠØ¯ Ø§Ù„Ù€ QR Code
    new QRCode(document.getElementById(`q${o.rowIndex}`), {
      text: qrText,
      width: 70,
      height: 70
    });

    // ØªØ£Ø®ÙŠØ± Ø¨Ø³ÙŠØ· Ù„Ø¶Ù…Ø§Ù† ØªØ­Ù…ÙŠÙ„ Ø§Ù„ØµÙˆØ± ÙˆØ§Ù„Ø¨Ø§Ø±ÙƒÙˆØ¯ Ø«Ù… Ø§Ù„Ø·Ø¨Ø§Ø¹Ø©
    setTimeout(() => { window.print(); }, 500);
  }

  async function markReady(row){
    if(!confirm("ØªØ£ÙƒÙŠØ¯ Ø§Ù„ØªØ¬Ù‡ÙŠØ²ØŸ")) return;
    await fetch(`${SCRIPT_URL}?action=updateStatus&key=${DASH_KEY}&row=${row}&status=READY âœ…`);
    load();
  }
</script>
</body>
</html>
