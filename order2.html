<!doctype html>
<html lang="he" dir="rtl">
<head>
  <meta charset="utf-8"/>
  <title>MAD SYSTEM v5.0 | Ø§Ù„Ù†Ø³Ø®Ø© Ø§Ù„Ù…Ø¨Ø³Ø·Ø©</title>
  
  <script src="https://cdn.jsdelivr.net/npm/jsbarcode@3.11.5/dist/JsBarcode.all.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/qrcodejs@1.0.0/qrcode.min.js"></script>
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">

  <style>
    /* ØªØµÙ…ÙŠÙ… Ø§Ù„ÙˆØ§Ø¬Ù‡Ø© - Ø£Ù„ÙˆØ§Ù† Ù…Ø±ÙŠØ­Ø© Ù„Ù„Ø¹ÙŠÙ† */
    body { font-family: system-ui, -apple-system, sans-serif; background: #0f172a; color: white; margin: 0; padding: 0; direction: rtl; }
    header { background: #1e293b; padding: 20px; display: flex; align-items: center; gap: 20px; border-bottom: 2px solid #334155; }
    
    /* ØµÙ†Ø¯ÙˆÙ‚ Ø§Ù„Ø¨Ø­Ø« */
    .search-bar { flex: 1; position: relative; }
    .search-bar input { width: 100%; padding: 12px; border-radius: 10px; border: none; font-size: 18px; }

    /* Ø´Ø¨ÙƒØ© Ø§Ù„Ø·Ù„Ø¨Ø§Øª */
    .grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(280px, 1fr)); gap: 20px; padding: 20px; }
    .card { background: #1e293b; padding: 15px; border-radius: 12px; border: 1px solid #334155; cursor: pointer; transition: 0.3s; position: relative; }
    .card:hover { border-color: #3b82f6; background: #263345; }
    .card input[type="checkbox"] { position: absolute; top: 15px; left: 15px; width: 20px; height: 20px; }
    
    .price { color: #10b981; font-size: 24px; font-weight: bold; }

    /* Ø´Ø±ÙŠØ· Ø§Ù„Ø¥Ø¬Ø±Ø§Ø¡Ø§Øª Ø§Ù„Ø£Ø³ÙÙ„ */
    .action-bar { position: fixed; bottom: 20px; left: 50%; transform: translateX(-50%); background: white; color: black; padding: 15px 30px; border-radius: 50px; display: none; gap: 20px; box-shadow: 0 10px 30px rgba(0,0,0,0.5); z-index: 100; }
    .action-bar.show { display: flex; align-items: center; }
    .btn-print { background: #3b82f6; color: white; border: none; padding: 10px 20px; border-radius: 20px; font-weight: bold; cursor: pointer; }

    /* Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª Ø§Ù„Ø·Ø¨Ø§Ø¹Ø© - Ù‚ÙŠØ§Ø³ 10x10 Ø³Ù… */
    @media print {
      body * { visibility: hidden; }
      #printArea, #printArea * { visibility: visible; }
      #printArea { position: absolute; left: 0; top: 0; width: 100mm; }
      @page { size: 100mm 100mm; margin: 0; }
      .label { 
        width: 100mm; height: 100mm; padding: 5mm; box-sizing: border-box;
        background: white !important; color: black !important;
        display: flex; flex-direction: column; page-break-after: always;
        border: 1px solid #eee;
      }
    }

    /* Ø´ÙƒÙ„ Ø§Ù„ØªÙŠÙƒØª (Ø§Ù„Ù…Ù„ØµÙ‚) */
    .label { font-family: Arial, sans-serif; color: black; direction: rtl; }
    .label-header { display: flex; justify-content: space-between; margin-bottom: 5px; }
    .label-row { font-size: 14pt; margin-bottom: 4px; border-bottom: 1px solid #eee; padding-bottom: 2px; }
    .label-price { font-size: 32pt; font-weight: 900; text-align: center; border: 4px solid black; margin: 5px 0; border-radius: 10px; }
    .label-footer { display: flex; justify-content: space-between; align-items: center; margin-top: auto; }
    #printArea { display: none; }
  </style>
</head>
<body>

<header>
  <h2 style="margin:0">MAD <span style="color:#3b82f6">V5</span></h2>
  <div class="search-bar">
    <input type="text" id="search" placeholder="Ø§Ø¨Ø­Ø« Ø¨Ø§Ù„Ø§Ø³Ù… Ø£Ùˆ Ø§Ù„Ù‡Ø§ØªÙ (ÙŠØªØ¬Ø§Ù‡Ù„ Ø§Ù„Ø´Ø±Ø·Ø§Øª)..." oninput="app.render()">
  </div>
  <button onclick="app.fetchData()" style="padding:10px; cursor:pointer">ØªØ­Ø¯ÙŠØ« â†»</button>
</header>

<div class="grid" id="grid"></div>

<div class="action-bar" id="actionBar">
  <span id="count">0 Ø·Ù„Ø¨Ø§Øª Ù…Ø®ØªØ§Ø±Ø©</span>
  <button class="btn-print" onclick="app.printAll()">Ø·Ø¨Ø§Ø¹Ø© Ø§Ù„Ù…Ù„ØµÙ‚Ø§Øª ğŸ–¨ï¸</button>
  <button onclick="app.clear()" style="background:none; border:none; color:gray; text-decoration:underline; cursor:pointer">Ø¥Ù„ØºØ§Ø¡</button>
</div>

<div id="printArea"></div>

<script>
class MadSystem {
  constructor() {
    this.url = "https://script.google.com/macros/s/AKfycbyLjLFa8AaH82Ip7m747WC-KSUUEaU_M70S0I9Mda14XbnmcuEfZ7pBnF_zzJYZuXmZ/exec";
    this.data = [];
    this.selected = new Set();
    
    // Ù‚Ø§Ù…ÙˆØ³ Ø§Ù„ØªØ±Ø¬Ù…Ø© Ø§Ù„ØªÙ„Ù‚Ø§Ø¦ÙŠØ©
    this.dict = {
      "cash": "Ù…Ø²ÙˆÙ…ÙŠÙ† (Ù†Ù‚Ø¯)", "credit": "Ø§Ø¦ØªÙ…Ø§Ù†", "bit": "Ø¨ÙŠØª", "cod": "Ø¯ÙØ¹ Ø¹Ù†Ø¯ Ø§Ù„Ø§Ø³ØªÙ„Ø§Ù…",
      "jerusalem": "Ø§Ù„Ù‚Ø¯Ø³", "haifa": "Ø­ÙŠÙØ§", "tel aviv": "ØªÙ„ Ø£Ø¨ÙŠØ¨", "nazareth": "Ø§Ù„Ù†Ø§ØµØ±Ø©"
    };

    this.fetchData();
  }

  async fetchData() {
    try {
      const r = await fetch(`${this.url}?action=get`);
      this.data = await r.json();
      this.render();
    } catch(e) { alert("Ø®Ø·Ø£ ÙÙŠ Ø¬Ù„Ø¨ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª"); }
  }

  // ØªØ±Ø¬Ù…Ø© Ø£ÙŠ ÙƒÙ„Ù…Ø© Ù„Ù„Ø¹Ø±Ø¨ÙŠØ©
  translate(txt) {
    if(!txt) return "ØºÙŠØ± Ù…Ø­Ø¯Ø¯";
    let k = txt.toString().toLowerCase().trim();
    return this.dict[k] || txt;
  }

  // ØªÙ†Ø¸ÙŠÙ Ø§Ù„Ù†Øµ Ù…Ù† Ø§Ù„Ø±Ù…ÙˆØ² Ù„Ù„Ø¨Ø­Ø« Ø§Ù„Ø°ÙƒÙŠ
  clean(s) { return String(s || "").replace(/[^a-zA-Z0-9Ø£-×ª]/g, ""); }

  render() {
    const q = this.clean(document.getElementById('search').value).toLowerCase();
    const container = document.getElementById('grid');
    
    const list = this.data.filter(item => {
      const searchKey = this.clean(item.name + item.phone + item.city).toLowerCase();
      return searchKey.includes(q);
    });

    container.innerHTML = list.map(item => {
      const id = this.data.indexOf(item);
      const isSel = this.selected.has(id);
      return `
        <div class="card" onclick="app.toggle(${id})">
          <input type="checkbox" ${isSel ? 'checked' : ''}>
          <div style="font-size:12px; color:#94a3b8">#${item.orderId}</div>
          <div style="font-size:20px; font-weight:bold; margin:5px 0">${item.name}</div>
          <div style="color:#cbd5e1">ğŸ“ ${item.phone}</div>
          <div style="color:#f59e0b">ğŸ“ ${this.translate(item.city)}</div>
          <div style="margin-top:10px; display:flex; justify-content:space-between; align-items:center">
            <span style="font-weight:bold">${this.translate(item.payment)}</span>
            <span class="price">â‚ª${item.price}</span>
          </div>
        </div>
      `;
    }).join("");
  }

  toggle(id) {
    this.selected.has(id) ? this.selected.delete(id) : this.selected.add(id);
    const bar = document.getElementById('actionBar');
    document.getElementById('count').innerText = `${this.selected.size} Ø·Ù„Ø¨Ø§Øª Ù…Ø®ØªØ§Ø±Ø©`;
    this.selected.size > 0 ? bar.classList.add('show') : bar.classList.remove('show');
    this.render();
  }

  clear() {
    this.selected.clear();
    document.getElementById('actionBar').classList.remove('show');
    this.render();
  }

  // Ù‚Ø§Ù„Ø¨ Ø§Ù„Ù…Ù„ØµÙ‚ Ù„Ù„Ø·Ø¨Ø§Ø¹Ø©
  createLabel(item, i) {
    return `
      <div class="label">
        <div class="label-header">
          <b style="font-size:18pt">MAD PARFUM</b>
          <span>#${item.orderId}</span>
        </div>
        <div style="background:black; color:yellow; text-align:center; padding:3px; font-weight:bold; margin-bottom:10px">ØµÙˆØ± Ø§Ù„Ù„Ø­Ø¸Ø© ÙˆØ§Ø­ØµÙ„ Ø¹Ù„Ù‰ Ù‡Ø¯ÙŠØ© ğŸ</div>
        <div class="label-row"><b>Ø§Ù„Ø§Ø³Ù…:</b> ${item.name}</div>
        <div class="label-row"><b>Ø§Ù„Ù‡Ø§ØªÙ:</b> <span dir="ltr">${item.phone}</span></div>
        <div class="label-row"><b>Ø§Ù„Ø¨Ù„Ø¯:</b> ${this.translate(item.city)}</div>
        <div class="label-row"><b>Ø§Ù„Ø¯ÙØ¹:</b> ${this.translate(item.payment)}</div>
        <div style="height:50px; overflow:hidden; font-size:11pt; margin-top:5px; border-top:1px dashed #ccc">${item.offer || ''}</div>
        <div class="label-price">â‚ª${item.price}</div>
        <div class="label-footer">
          <div style="font-size:9pt; width:60%">Ø³Ø¬Ù„ ÙÙŠØ¯ÙŠÙˆ Ù„Ù„Ù…Ù†ØªØ¬ ÙˆØ£Ø±Ø³Ù„Ù‡ Ù„Ù„ÙˆØ§ØªØ³Ø§Ø¨ Ø§Ù„Ø®Ø§Øµ Ø¨Ù†Ø§ ÙˆØ§Ø±Ø¨Ø­!</div>
          <div id="qr_${i}"></div>
        </div>
        <div style="text-align:center; margin-top:5px"><svg id="barcode_${i}"></svg></div>
      </div>
    `;
  }

  printAll() {
    const list = Array.from(this.selected).map(id => this.data[id]);
    const area = document.getElementById('printArea');
    area.innerHTML = list.map((item, i) => this.createLabel(item, i)).join("");

    list.forEach((item, i) => {
      // ØªÙˆÙ„ÙŠØ¯ Ø§Ù„Ø¨Ø§Ø±ÙƒÙˆØ¯
      JsBarcode(`#barcode_${i}`, item.phone.replace(/\D/g,''), {height: 30, displayValue: false});
      // ØªÙˆÙ„ÙŠØ¯ Ø§Ù„Ù€ QR
      new QRCode(document.getElementById(`qr_${i}`), {text: "https://wa.me/972549634449", width: 50, height: 50});
    });

    setTimeout(() => {
      window.print();
      this.clear();
    }, 500);
  }
}

const app = new MadSystem();
</script>
</body>
</html>
