<!doctype html>
<html lang="he" dir="rtl">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width,initial-scale=1"/>
  <title>MAD FINAL SYSTEM</title>
  
  <script src="https://cdn.jsdelivr.net/npm/jsbarcode@3.11.5/dist/JsBarcode.all.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/qrcodejs@1.0.0/qrcode.min.js"></script>
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">

  <style>
    :root { 
      --bg: #111116;       /* Ø®Ù„ÙÙŠØ© Ø³ÙˆØ¯Ø§Ø¡ */
      --card: #1c1c24;     /* Ù„ÙˆÙ† Ø§Ù„ÙƒØ±ÙˆØª */
      --primary: #3b82f6;  /* Ø£Ø²Ø±Ù‚ */
      --accent: #f59e0b;   /* Ø°Ù‡Ø¨ÙŠ Ù„Ù„Ø·Ø¨Ø§Ø¹Ø© */
      --text: #ffffff;     
      --green: #10b981;    /* Ù„Ù„Ø³Ø¹Ø± */
      --danger: #ef4444;   /* Ù„Ù„ØªÙ†Ø¨ÙŠÙ‡Ø§Øª */
    }

    body { margin: 0; font-family: 'Segoe UI', Tahoma, sans-serif; background: var(--bg); color: var(--text); height: 100vh; display: flex; flex-direction: column; overflow: hidden; }

    /* --- Ø´Ø±ÙŠØ· Ø§Ù„ØªÙ†Ø¨ÙŠÙ‡ Ø§Ù„Ø£Ø­Ù…Ø± --- */
    #alert-bar { 
      display: none; background: var(--danger); color: white; text-align: center; 
      padding: 12px; font-weight: 900; font-size: 1.1rem; cursor: pointer;
      animation: flash 1s infinite; position: sticky; top: 0; z-index: 9999;
    }
    @keyframes flash { 50% { opacity: 0.5; } }

    /* --- Ø§Ù„Ù‡ÙŠØ¯Ø± (Ø§Ù„Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„Ø¹Ù„ÙˆÙŠØ©) --- */
    .header { 
      background: #18181b; padding: 15px 25px; border-bottom: 1px solid #333;
      display: flex; align-items: center; justify-content: space-between;
    }
    .brand { font-size: 1.5rem; font-weight: 900; letter-spacing: 1px; color: #fff; }
    
    .tabs { display: flex; background: #27272a; padding: 5px; border-radius: 8px; gap: 5px; }
    .tab { 
      padding: 8px 20px; cursor: pointer; border-radius: 6px; font-weight: bold; color: #a1a1aa; 
      transition: 0.3s; display: flex; align-items: center; gap: 8px;
    }
    .tab.active { background: var(--primary); color: #fff; }
    .badge { background: #000; padding: 2px 8px; border-radius: 10px; font-size: 0.8rem; }

    .search-wrap { flex: 1; max-width: 400px; margin: 0 20px; }
    .search-inp { 
      width: 100%; padding: 10px 15px; border-radius: 8px; border: 1px solid #3f3f46; 
      background: #000; color: #fff; font-weight: bold; outline: none;
    }
    .search-inp:focus { border-color: var(--primary); }

    .btn { cursor: pointer; border: none; padding: 10px 20px; border-radius: 6px; font-weight: bold; color: white; transition: 0.2s; display: flex; align-items: center; gap: 8px; }
    .btn-all { background: var(--accent); color: #000; }
    .btn-refresh { background: #27272a; border: 1px solid #3f3f46; }

    /* --- Ù…Ù†Ø·Ù‚Ø© Ø§Ù„Ø¹Ù…Ù„ (Ø§Ù„Ø´Ø¨ÙƒØ©) --- */
    .workspace { flex: 1; overflow-y: auto; padding: 20px; }
    .grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(320px, 1fr)); gap: 15px; }

    /* --- ØªØµÙ…ÙŠÙ… Ø§Ù„ÙƒØ±Øª (Ø­Ø³Ø¨ Ø§Ù„ØµÙˆØ±Ø© Ø§Ù„Ù…Ø±ÙÙ‚Ø©) --- */
    .card { 
      background: var(--card); border: 1px solid #27272a; border-radius: 10px; padding: 15px; 
      position: relative; cursor: pointer; transition: transform 0.2s; 
      display: flex; flex-direction: column; gap: 8px;
    }
    .card:hover { transform: translateY(-4px); border-color: var(--primary); background: #202029; }
    
    .card-top { display: flex; justify-content: space-between; font-size: 0.85rem; color: #71717a; font-weight: bold; border-bottom: 1px solid #27272a; padding-bottom: 8px; }
    .card-name { font-size: 1.2rem; font-weight: 800; color: #fff; }
    .card-phone { font-family: monospace; font-size: 1rem; color: #a1a1aa; direction: ltr; text-align: right; }
    
    .card-products { 
      background: #101014; padding: 8px; border-radius: 6px; font-size: 0.9rem; 
      color: #e4e4e7; line-height: 1.4; max-height: 60px; overflow: hidden; 
    }
    
    .card-footer { display: flex; justify-content: space-between; align-items: center; margin-top: auto; }
    .price-tag { color: var(--green); font-size: 1.3rem; font-weight: 900; }
    .status-tag { font-size: 0.8rem; padding: 3px 8px; border-radius: 4px; background: #27272a; color: #aaa; }
    .status-ready { background: var(--green); color: #fff; }

    /* --- Ù†Ø§ÙØ°Ø© Ø§Ù„ØªØ¹Ø¯ÙŠÙ„ (Modal) --- */
    .modal-overlay { display: none; position: fixed; inset: 0; background: rgba(0,0,0,0.9); z-index: 1000; justify-content: center; align-items: center; }
    .modal-box { width: 95%; max-width: 1100px; height: 90vh; background: #fff; color: #000; display: flex; border-radius: 12px; overflow: hidden; }
    .editor-pane { width: 35%; background: #f4f4f5; padding: 20px; overflow-y: auto; display: flex; flex-direction: column; gap: 10px; }
    .preview-pane { width: 65%; background: #e4e4e7; display: flex; align-items: center; justify-content: center; padding: 20px; flex-direction: column; }
    
    .inp-group label { display: block; font-weight: 700; font-size: 0.85rem; margin-bottom: 4px; }
    .inp-group input, .inp-group textarea { width: 100%; padding: 10px; border: 1px solid #d4d4d8; border-radius: 6px; font-weight: 600; box-sizing: border-box; }
    
    .btn-print-modal { width: 100%; padding: 15px; background: #000; color: #fff; font-size: 1.2rem; margin-top: auto; border: none; cursor: pointer; font-weight: bold; border-radius: 8px; }

    /* --- ØªØµÙ…ÙŠÙ… Ø§Ù„Ù…Ù„ØµÙ‚ (10x10) - Ù…Ø·Ø§Ø¨Ù‚ Ù„Ù„ØµÙˆØ±Ø© ØªÙ…Ø§Ù…Ø§Ù‹ --- */
    .label-page { 
      width: 100mm; height: 100mm; background: #fff; color: #000; padding: 3mm; 
      box-sizing: border-box; border: 1px solid #ddd; display: flex; flex-direction: column; 
      position: relative; overflow: hidden; page-break-after: always; direction: rtl;
    }
    
    .l-head { display: flex; justify-content: space-between; height: 20mm; align-items: flex-start; }
    .l-logo img { width: 35mm; }
    .l-meta { text-align: left; font-size: 9pt; font-weight: 800; line-height: 1.2; }
    
    /* Ø§Ù„Ø¨Ø§Ù†Ø± Ø§Ù„Ø£Ø³ÙˆØ¯ ÙˆØ§Ù„Ø°Ù‡Ø¨ÙŠ */
    .l-banner { 
      background: #18181b; color: #fbbf24; text-align: center; font-weight: 900; 
      font-size: 11pt; padding: 4px; margin: 1mm 0 3mm 0; border-radius: 4px;
      display: flex; align-items: center; justify-content: center; gap: 5px;
    }
    
    .l-info { font-size: 11pt; line-height: 1.35; margin-bottom: 2mm; }
    .l-info b { font-weight: 800; min-width: 50px; display: inline-block; }
    
    /* Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„Ù…Ù†ØªØ¬Ø§Øª */
    .l-products { 
      font-size: 9.5pt; font-weight: bold; line-height: 1.2; 
      margin-bottom: 2mm; max-height: 15mm; overflow: hidden;
    }
    
    /* Ù…Ø±Ø¨Ø¹ Ø§Ù„Ø³Ø¹Ø± Ø§Ù„ÙƒØ¨ÙŠØ± */
    .l-price-box { 
      border: 3px solid #000; font-size: 22pt; font-weight: 900; 
      text-align: center; padding: 2px; margin-bottom: 2mm; 
    }
    
    .l-footer { display: flex; justify-content: space-between; align-items: flex-end; margin-top: auto; border-top: 1px solid #000; padding-top: 2mm; }
    .l-wa-text { 
      font-size: 7.5pt; font-weight: 800; width: 68%; line-height: 1.2; 
      background: #18181b; color: #fbbf24; padding: 5px; border-radius: 4px;
    }

    #printArea { display: none; }
    @media print {
      body * { visibility: hidden !important; }
      #printArea, #printArea * { visibility: visible !important; }
      #printArea { position: absolute; left: 0; top: 0; width: 100%; }
      @page { size: 100mm 100mm; margin: 0; }
      .label-page { border: none; } 
    }
  </style>
</head>
<body>

<audio id="bell" src="https://assets.mixkit.co/active_storage/sfx/2869/2869-preview.mp3"></audio>

<div id="alert-bar" onclick="this.style.display='none'">ğŸ”” ÙŠÙˆØ¬Ø¯ Ø·Ù„Ø¨Ø§Øª Ø¬Ø¯ÙŠØ¯Ø©! (Ø§Ø¶ØºØ· Ù„Ù„Ø¥Ø®ÙØ§Ø¡)</div>

<div class="header">
  <div class="brand">MAD <span style="color:var(--primary)">SYSTEM</span></div>
  
  <div class="tabs">
    <div class="tab active" id="tab-pending" onclick="setTab('pending')">
      <span>Ù‚ÙŠØ¯ Ø§Ù„ØªØ¬Ù‡ÙŠØ²</span>
      <span class="badge" id="count-pending">0</span>
    </div>
    <div class="tab" id="tab-all" onclick="setTab('all')">
      <span>Ø§Ù„Ø£Ø±Ø´ÙŠÙ (Ø§Ù„ÙƒÙ„)</span>
      <span class="badge" id="count-all">0</span>
    </div>
  </div>

  <div class="search-wrap">
    <input class="search-inp" id="search" placeholder="Ø¨Ø­Ø« Ø°ÙƒÙŠ: 050 / Ø§Ø³Ù…..." oninput="render()">
  </div>

  <div style="display:flex; gap:10px">
    <button class="btn btn-refresh" onclick="loadData()">ØªØ­Ø¯ÙŠØ« â†»</button>
    <button class="btn btn-all" onclick="printAll()">Ø·Ø¨Ø§Ø¹Ø© Ø§Ù„Ù‚Ø§Ø¦Ù…Ø© ğŸ–¨ï¸</button>
  </div>
</div>

<div class="workspace">
  <div class="grid" id="grid"></div>
</div>

<div class="modal-overlay" id="editor">
  <div class="modal-box">
    <div class="editor-pane" dir="rtl">
      <div style="display:flex; justify-content:space-between">
        <h2 style="margin:0">ØªØ¹Ø¯ÙŠÙ„ Ø§Ù„Ø·Ù„Ø¨</h2>
        <button onclick="closeModal()" style="border:none;background:none;font-size:1.5rem;cursor:pointer">âœ•</button>
      </div>
      
      <div class="inp-group"><label>Ø§Ù„Ø§Ø³Ù…:</label><input id="e_name" oninput="updatePreview()"></div>
      <div class="inp-group"><label>Ø§Ù„Ù‡Ø§ØªÙ (Ø³ÙŠØªÙ… ØªØ­ÙˆÙŠÙ„Ù‡ ØªÙ„Ù‚Ø§Ø¦ÙŠØ§Ù‹):</label><input id="e_phone" oninput="updatePreview()"></div>
      <div class="inp-group"><label>Ø§Ù„Ø¹Ù†ÙˆØ§Ù†:</label><input id="e_city" oninput="updatePreview()"></div>
      <div class="inp-group"><label>Ø´Ø±ÙƒØ© Ø§Ù„Ø´Ø­Ù†:</label><input id="e_del" oninput="updatePreview()"></div>
      
      <div class="inp-group">
        <label>Ø§Ù„Ù…Ù†ØªØ¬Ø§Øª (Items):</label>
        <textarea id="e_offer" oninput="updatePreview()" style="height:80px"></textarea>
      </div>
      
      <div class="inp-group"><label>Ø§Ù„Ø³Ø¹Ø± (â‚ª):</label><input id="e_price" type="number" style="font-size:1.2rem;color:green" oninput="updatePreview()"></div>
      
      <button class="btn-print-modal" onclick="printSingle()">Ø·Ø¨Ø§Ø¹Ø© (Enter) ğŸ–¨ï¸</button>
    </div>
    
    <div class="preview-pane">
      <div id="livePreview" style="box-shadow: 0 10px 40px rgba(0,0,0,0.5);"></div>
    </div>
  </div>
</div>

<div id="printArea"></div>

<script>
  // Ø±Ø§Ø¨Ø· Ø§Ù„Ø³ÙƒØ±Ø¨Øª ÙˆÙƒÙ„Ù…Ø© Ø§Ù„Ù…Ø±ÙˆØ±
  const SCRIPT_URL = "https://script.google.com/macros/s/AKfycbyLjLFa8AaH82Ip7m747WC-KSUUEaU_M70S0I9Mda14XbnmcuEfZ7pBnF_zzJYZuXmZ/exec";
  const PASS = "12345678";
  
  let orders = [];
  let currentTab = 'pending';
  let currentIndex = null;
  let lastCount = 0;

  // 1. Ø§Ù„Ø¯Ø§Ù„Ø© Ø§Ù„Ø³Ø­Ø±ÙŠØ© Ù„Ø¥ØµÙ„Ø§Ø­ Ø§Ù„Ø£Ø±Ù‚Ø§Ù… (Ø¨Ø¯ÙˆÙ† 972)
  // ØªØ­ÙˆÙ„ Ø£ÙŠ Ø±Ù‚Ù… Ù„ØµÙŠØºØ© Ù…Ø­Ù„ÙŠØ© 05X-XXXXXXX
  function formatPhone(input) {
    let p = String(input || "").replace(/[^0-9]/g, ""); // Ø­Ø°Ù Ø£ÙŠ Ø±Ù…ÙˆØ²
    if (!p) return "";

    // Ø­Ø§Ù„Ø§Øª Ø¯ÙˆÙ„ÙŠØ©
    if (p.startsWith("972")) p = "0" + p.slice(3);
    if (p.startsWith("970")) p = "0" + p.slice(3);
    
    // Ø¥Ø°Ø§ Ø¨Ø¯Ø£ Ø¨Ù€ 5 ÙˆÙƒØ§Ù† 9 Ø£Ø±Ù‚Ø§Ù… (Ù†Ø³ÙŠ Ø§Ù„ØµÙØ±)
    if (p.startsWith("5") && p.length === 9) p = "0" + p;

    // ØªÙ†Ø³ÙŠÙ‚ Ù…Ø¹ Ø´ÙØ±Ø·Ø© Ù„Ù„Ø¬Ù…Ø§Ù„ (Ø§Ø®ØªÙŠØ§Ø±ÙŠ)
    if (p.length === 10) {
      return p.slice(0,3) + "-" + p.slice(3);
    }
    return p;
  }

  // 2. Ø§Ù„ØªØ­Ù‚Ù‚ ÙˆØ§Ù„ØªØ­Ù…ÙŠÙ„
  (function(){
    if(localStorage.getItem('mad_auth') !== PASS) {
      if(prompt("ÙƒÙ„Ù…Ø© Ø§Ù„Ø³Ø±:") === PASS) localStorage.setItem('mad_auth', PASS);
      else { document.body.innerHTML = "<h3 style='color:white;text-align:center;margin-top:50px'>Ø¯Ø®ÙˆÙ„ Ù…Ø±ÙÙˆØ¶</h3>"; return; }
    }
    loadData();
    setInterval(loadData, 20000); // ØªØ­Ø¯ÙŠØ« ÙƒÙ„ 20 Ø«Ø§Ù†ÙŠØ©
  })();

  async function loadData() {
    try {
      const res = await fetch(`${SCRIPT_URL}?action=get`);
      orders = await res.json();
      
      // Ø§Ù„ØªÙ†Ø¨ÙŠÙ‡ Ø¹Ù†Ø¯ Ø²ÙŠØ§Ø¯Ø© Ø§Ù„Ø·Ù„Ø¨Ø§Øª Ø§Ù„Ø¬Ø¯ÙŠØ¯Ø©
      const newPending = orders.filter(o => isPending(o)).length;
      if(newPending > lastCount && lastCount !== 0) triggerAlert();
      lastCount = newPending;

      render();
    } catch(e) {}
  }

  function isPending(o) {
    const st = (o.status || "").toLowerCase();
    return (st.includes("prep") || st.includes("approved")) && !st.includes("ready");
  }

  function triggerAlert() {
    const b = document.getElementById('alert-bar');
    b.style.display = 'block';
    document.getElementById('bell').play().catch(()=>{});
    setTimeout(() => b.style.display='none', 8000);
  }

  function setTab(t) {
    currentTab = t;
    document.querySelectorAll('.tab').forEach(x => x.classList.remove('active'));
    document.getElementById('tab-'+t).classList.add('active');
    render();
  }

  // 3. Ø¹Ø±Ø¶ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª
  function render() {
    const pendingList = orders.filter(isPending);
    const allList = orders;

    document.getElementById('count-pending').innerText = pendingList.length;
    document.getElementById('count-all').innerText = allList.length;

    let list = currentTab === 'pending' ? pendingList : allList;
    const q = document.getElementById('search').value.toLowerCase().trim();

    // Ø§Ù„Ø¨Ø­Ø« Ø§Ù„Ø°ÙƒÙŠ
    if(q) {
      list = list.filter(o => {
        const p = formatPhone(o.phone).replace(/-/g, ""); // Ø±Ù‚Ù… Ù†Ø¸ÙŠÙ
        const qClean = q.replace(/-/g, "");
        return (o.name||"").toLowerCase().includes(q) ||
               (o.orderId||"").toString().includes(q) ||
               p.includes(qClean);
      });
    }

    const grid = document.getElementById('grid');
    if(!list.length) {
      grid.innerHTML = '<div style="grid-column:1/-1;text-align:center;padding:50px;color:#555">Ù„Ø§ ØªÙˆØ¬Ø¯ Ø·Ù„Ø¨Ø§Øª</div>';
      return;
    }

    grid.innerHTML = list.map(o => {
      const idx = orders.indexOf(o);
      const isReady = (o.status||"").includes("READY");
      
      // Ù‡Ù†Ø§ Ù†Ø¹Ø±Ø¶ Ø´Ø±ÙƒØ© Ø§Ù„ØªÙˆØµÙŠÙ„ ÙˆØ§Ù„Ù…Ù†ØªØ¬Ø§Øª ÙƒÙ…Ø§ Ø·Ù„Ø¨Øª
      return `
        <div class="card" onclick="openEditor(${idx})" style="${isReady ? 'opacity:0.6' : ''}">
          <div class="card-top">
            <span>#${o.orderId}</span>
            <span style="color:var(--accent)">${o.delivery || 'High Express'}</span>
          </div>
          <div class="card-name">${o.name}</div>
          <div class="card-phone">${formatPhone(o.phone)}</div>
          <div class="card-products">ğŸ“¦ ${o.offer || 'Ù„Ø§ ÙŠÙˆØ¬Ø¯ ÙˆØµÙ'}</div>
          
          <div class="card-footer">
            <span class="status-tag ${isReady ? 'status-ready' : ''}">
              ${isReady ? 'ØªÙ… Ø§Ù„ØªØ¬Ù‡ÙŠØ² (Ø¬Ø§Ù‡Ø²)' : 'Ù‚ÙŠØ¯ Ø§Ù„Ø§Ù†ØªØ¸Ø§Ø±'}
            </span>
            <span class="price-tag">â‚ª${o.price}</span>
          </div>
        </div>
      `;
    }).join("");
  }

  // 4. ØªØµÙ…ÙŠÙ… Ø§Ù„Ù…Ù„ØµÙ‚ (Ù…Ø·Ø§Ø¨Ù‚ Ù„Ù„ØµÙˆØ±Ø© LOGO 10)
  function getLabelHTML(o, idSuffix) {
    const date = new Date().toLocaleDateString('he-IL');
    const localPhone = formatPhone(o.phone);
    const cleanPhone = localPhone.replace(/-/g, ""); // Ù„Ù„Ø¨Ø§Ø±ÙƒÙˆØ¯
    const waLink = `https://wa.me/972${cleanPhone.substring(1)}`; // ÙˆØ§ØªØ³Ø§Ø¨ Ø¯ÙˆÙ„ÙŠ

    return `
      <div class="label-page" dir="rtl">
        <div class="l-head">
          <div class="l-logo"><img src="https://www.madparfum.com/logo.svg"></div>
          <div class="l-meta">
            DATE: ${date}<br>
            ORD: ${o.orderId}
          </div>
        </div>

        <div class="l-banner">
          <i class="fas fa-gift"></i> ×¦×œ× ××ª ×”×¨×’×¢ ×•×§×‘×œ ××ª× ×”
        </div>

        <div class="l-info">
          <div><b>×œ×›×‘×•×“:</b> ${o.name}</div>
          <div><b>×˜×œ×¤×•×Ÿ:</b> <span dir="ltr" style="font-family:monospace">${localPhone}</span></div>
          <div><b>×›×ª×•×‘×ª:</b> ${o.city}</div>
          <div><b>××©×œ×•×—:</b> ${o.delivery}</div>
        </div>

        <div class="l-products">
          <b>×¤×¨×™×˜×™×:</b> ${o.offer || ""}
        </div>

        <div class="l-price-box">
          ×œ×ª×©×œ×•×: â‚ª${o.price}
        </div>

        <div class="l-footer">
          <div class="l-wa-text">
             1. ×¡×¨×•×§ ××ª ×”×§×•×“ <br>
             2. ×©×œ×— ×¡×¨×˜×•×Ÿ ×œ-WhatsApp <br>
             3. ×§×‘×œ ××ª× ×”!
          </div>
          <div id="qr_${idSuffix}"></div>
        </div>
        
        <div style="position:absolute; bottom:2mm; width:94%; text-align:center">
           <svg id="bar_${idSuffix}" data-val="${cleanPhone}"></svg>
        </div>
      </div>
    `;
  }

  // 5. Ø§Ù„Ù…Ø­Ø±Ø± ÙˆØ§Ù„Ø·Ø¨Ø§Ø¹Ø©
  function openEditor(idx) {
    currentIndex = idx;
    const o = orders[idx];
    document.getElementById('e_name').value = o.name;
    document.getElementById('e_phone').value = o.phone; // Ø³ÙŠØªÙ… Ø§Ù„ØªÙ†Ø³ÙŠÙ‚ ÙÙŠ Ø§Ù„Ù…Ø¹Ø§ÙŠÙ†Ø©
    document.getElementById('e_city').value = o.city + " " + (o.addr||"");
    document.getElementById('e_del').value = o.delivery || "High Express";
    document.getElementById('e_offer').value = o.offer || "";
    document.getElementById('e_price').value = o.price;
    
    document.getElementById('editor').style.display = 'flex';
    updatePreview();
    
    document.onkeydown = (e) => {
      if(e.key === "Enter" && !e.shiftKey) { e.preventDefault(); printSingle(); }
      if(e.key === "Escape") closeModal();
    }
  }

  function closeModal() {
    document.getElementById('editor').style.display = 'none';
    document.onkeydown = null;
  }

  function updatePreview() {
    const data = {
      orderId: orders[currentIndex].orderId,
      name: document.getElementById('e_name').value,
      phone: document.getElementById('e_phone').value,
      city: document.getElementById('e_city').value,
      delivery: document.getElementById('e_del').value,
      offer: document.getElementById('e_offer').value,
      price: document.getElementById('e_price').value
    };
    document.getElementById('livePreview').innerHTML = getLabelHTML(data, 'prev');
    genCodes('prev', data.phone);
  }

  function genCodes(suffix, phoneInput) {
    // ØªÙˆÙ„ÙŠØ¯ Ø§Ù„Ø£ÙƒÙˆØ§Ø¯
    setTimeout(() => {
      try {
        // Ø¨Ø§Ø±ÙƒÙˆØ¯ Ø¨Ø§Ù„Ø±Ù‚Ù… Ø§Ù„Ù…Ø­Ù„ÙŠ Ø§Ù„Ù†Ø¸ÙŠÙ
        const cleanP = formatPhone(phoneInput).replace(/-/g, "");
        const barEl = document.getElementById(`bar_${suffix}`);
        if(barEl) JsBarcode(barEl, cleanP, { format: "CODE128", height: 25, fontSize: 10, displayValue: true, margin:0 });
        
        // QR ÙŠÙØªØ­ ÙˆØ§ØªØ³Ø§Ø¨ Ø§Ù„Ø´Ø±ÙƒØ©
        const qrEl = document.getElementById(`qr_${suffix}`);
        if(qrEl) {
          qrEl.innerHTML = "";
          new QRCode(qrEl, { text: "https://wa.me/972549634449", width: 45, height: 45 });
        }
      } catch(e){}
    }, 50);
  }

  function printSingle() {
    const data = {
      orderId: orders[currentIndex].orderId,
      name: document.getElementById('e_name').value,
      phone: document.getElementById('e_phone').value,
      city: document.getElementById('e_city').value,
      delivery: document.getElementById('e_del').value,
      offer: document.getElementById('e_offer').value,
      price: document.getElementById('e_price').value
    };
    
    const area = document.getElementById('printArea');
    area.innerHTML = getLabelHTML(data, 'print');
    
    setTimeout(() => {
      genCodes('print', data.phone);
      setTimeout(async () => {
        window.print();
        
        // ØªØ­Ø¯ÙŠØ« Ø§Ù„Ø­Ø§Ù„Ø©
        const row = orders[currentIndex].rowIndex;
        closeModal();
        await fetch(`${SCRIPT_URL}?action=updateStatus&key=${PASS}&row=${row}&status=READY âœ…`);
        
        // ØªØ­Ø¯ÙŠØ« Ù…Ø­Ù„ÙŠ
        orders[currentIndex].status = "READY âœ…";
        render();
      }, 500);
    }, 100);
  }

  function printAll() {
    // Ø·Ø¨Ø§Ø¹Ø© Ø§Ù„Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„Ø­Ø§Ù„ÙŠØ© ÙÙ‚Ø· (Ù‚ÙŠØ¯ Ø§Ù„ØªØ¬Ù‡ÙŠØ² Ø£Ùˆ Ø§Ù„ÙƒÙ„)
    const list = currentTab === 'pending' ? orders.filter(isPending) : orders;
    
    if(!list.length) return alert("Ø§Ù„Ù‚Ø§Ø¦Ù…Ø© ÙØ§Ø±ØºØ©!");
    if(!confirm(`Ø·Ø¨Ø§Ø¹Ø© ${list.length} Ù…Ù„ØµÙ‚ Ø¯ÙØ¹Ø© ÙˆØ§Ø­Ø¯Ø©ØŸ`)) return;

    const area = document.getElementById('printArea');
    area.innerHTML = list.map((o, i) => getLabelHTML(o, `bulk_${i}`)).join("");

    setTimeout(() => {
      list.forEach((o, i) => genCodes(`bulk_${i}`, o.phone));
      setTimeout(() => {
        window.print();
        if(currentTab === 'pending' && confirm("Ù†Ù‚Ù„ ÙƒÙ„ Ø§Ù„Ù…Ø·Ø¨ÙˆØ¹ Ø¥Ù„Ù‰ (Ø¬Ø§Ù‡Ø²)ØŸ")) {
          list.forEach(o => {
             o.status = "READY âœ…";
             fetch(`${SCRIPT_URL}?action=updateStatus&key=${PASS}&row=${o.rowIndex}&status=READY âœ…`);
          });
          render();
        }
      }, 2000); // ÙˆÙ‚Øª Ø£Ø·ÙˆÙ„ Ù„Ù„ÙƒÙ…ÙŠØ§Øª Ø§Ù„ÙƒØ¨ÙŠØ±Ø©
    }, 200);
  }
</script>
</body>
</html>
