<!doctype html>
<html lang="he" dir="rtl">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width,initial-scale=1"/>
  <title>MAD System | ×¢×•×¨×š ××“×‘×§×•×ª ×—×›×</title>
  
  <script src="https://cdn.jsdelivr.net/npm/jsbarcode@3.11.5/dist/JsBarcode.all.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/qrcodejs@1.0.0/qrcode.min.js"></script>

  <style>
    :root { --bg: #070b16; --card: #1e293b; --primary: #3b82f6; --success: #10b981; --text: #f8fafc; }
    body { margin: 0; font-family: system-ui, sans-serif; background: var(--bg); color: var(--text); }
    .container { max-width: 1100px; margin: 0 auto; padding: 20px; }
    
    /* Ø§Ù„ØªØµÙ…ÙŠÙ… Ø§Ù„Ø¹Ù„ÙˆÙŠ */
    .top-bar { background: rgba(30, 41, 59, 0.9); padding: 15px; position: sticky; top: 0; z-index: 100; border-bottom: 2px solid var(--primary); display: flex; justify-content: space-between; align-items: center; }
    
    .grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(320px, 1fr)); gap: 20px; margin-top: 20px; }
    .order-card { background: var(--card); border-radius: 12px; padding: 15px; border: 1px solid rgba(255,255,255,0.1); }
    
    .btn { cursor: pointer; border: none; border-radius: 6px; padding: 10px; font-weight: bold; flex: 1; transition: 0.2s; }
    .btn-edit { background: var(--primary); color: white; }
    .btn-done { background: var(--success); color: white; }

    /* Ù†Ø§ÙØ°Ø© Ø§Ù„ØªØ¹Ø¯ÙŠÙ„ (Modal) */
    #editModal { display: none; position: fixed; inset: 0; background: rgba(0,0,0,0.9); z-index: 1000; justify-content: center; align-items: center; overflow-y: auto; padding: 20px; }
    .modal-content { background: white; color: black; width: 100mm; padding: 15px; border-radius: 8px; box-shadow: 0 0 40px rgba(0,0,0,0.5); }
    .modal-content label { display: block; font-size: 9pt; font-weight: bold; margin-top: 8px; color: #555; }
    .modal-content input, .modal-content textarea { width: 100%; padding: 6px; border: 1px solid #ccc; border-radius: 4px; font-size: 10pt; font-weight: bold; }

    /* ØªØµÙ…ÙŠÙ… Ø§Ù„Ù…Ù„ØµÙ‚ Ø§Ù„Ù…Ø¹ØªÙ…Ø¯ (100x100) */
    .label-box { 
      width: 100mm; height: 100mm; background: #fff; color: #000; padding: 4mm; 
      box-sizing: border-box; border: 1px solid #000; display: flex; flex-direction: column;
      position: relative; margin-top: 15px;
    }
    .label-header { display: flex; justify-content: space-between; font-size: 10pt; font-weight: bold; margin-bottom: 2mm; }
    .label-header img { width: 35mm; }
    
    .promo-banner { background: #000; color: #fff; text-align: center; padding: 4px; font-size: 11pt; font-weight: bold; margin: 2mm 0; border-radius: 3px; }
    
    .info-line { font-size: 11pt; line-height: 1.5; margin-bottom: 1mm; }
    .info-line b { width: 75px; display: inline-block; }

    .content-box { border: 1px dashed #000; padding: 5px; margin: 2mm 0; font-size: 10pt; background: #f9f9f9; }
    .payment-box { border: 2px solid #000; text-align: center; font-size: 18pt; font-weight: 900; margin: 2mm 0; padding: 4px; }
    
    .footer { display: flex; justify-content: space-between; align-items: flex-end; margin-top: auto; }
    .wa-info { font-size: 8pt; font-weight: bold; max-width: 60%; }

    #printArea { display: none; }
    @media print {
      body * { visibility: hidden !important; }
      #printArea, #printArea * { visibility: visible !important; }
      #printArea { position: absolute; left: 0; top: 0; width: 100mm; display: block !important; }
      @page { size: 100mm 100mm; margin: 0; }
    }
  </style>
</head>
<body>

<div class="top-bar">
  <h2 style="margin:0">×¢×•×¨×š ×”×–×× ×•×ª MAD</h2>
  <button class="btn btn-edit" style="max-width:150px" onclick="load()">×¨×¢× ×Ÿ â†»</button>
</div>

<div class="container">
  <div class="grid" id="orderList"></div>
</div>

<div id="editModal">
  <div class="modal-content" dir="rtl">
    <h3 style="margin-top:0">×¢×¨×™×›×ª ×¤×¨×˜×™ ×”×–×× ×” ×•×¤×¨×™×˜×™×</h3>
    
    <label>×©× ×œ×§×•×—:</label> <input id="i_name">
    <label>×˜×œ×¤×•×Ÿ:</label> <input id="i_phone">
    <label>×›×ª×•×‘×ª ××œ××”:</label> <input id="i_addr">
    <label>×—×‘×¨×ª ×©×œ×™×—×•×™×•×ª:</label> <input id="i_del" value="High Express">
    <label>×¡×›×•× ×œ×ª×©×œ×•×:</label> <input id="i_price">
    <label>×ª×›×•×œ×ª ×”×˜×¢× ×” (××—×ª×•×™ Ø§Ù„Ø·Ø±Ø¯):</label> 
    <textarea id="i_content" rows="3" placeholder="×¤×¨×˜ ××ª ×”××•×¦×¨×™× ×›××Ÿ..."></textarea>

    <div style="display:flex; gap:10px; margin-top:15px">
      <button class="btn btn-done" onclick="saveAndPrint()">×©××•×¨ ×•×”×“×¤×¡ ğŸ–¨ï¸</button>
      <button class="btn" style="background:#64748b; color:white" onclick="closeModal()">×‘×™×˜×•×œ</button>
    </div>
  </div>
</div>

<div id="printArea"></div>

<script>
  const SCRIPT_URL = "https://script.google.com/macros/s/AKfycbyLjLFa8AaH82Ip7m747WC-KSUUEaU_M70S0I9Mda14XbnmcuEfZ7pBnF_zzJYZuXmZ/exec";
  const DASH_KEY = "12345678";
  let orders = [];
  let editingRow = null;

  async function load() {
    document.getElementById('orderList').innerHTML = "×˜×•×¢×Ÿ × ×ª×•× ×™×...";
    const res = await fetch(`${SCRIPT_URL}?action=get`);
    orders = await res.json();
    render();
  }

  function render() {
    const pending = orders.filter(o => (o.status || "").includes("Prep") && !(o.status || "").includes("READY"));
    document.getElementById('orderList').innerHTML = pending.map(o => `
      <div class="order-card">
        <div style="font-weight:900; color:var(--primary)">ID: ${o.orderId}</div>
        <div style="margin:10px 0">
          <b>${o.name}</b><br>
          <small>${o.city}</small>
        </div>
        <button class="btn btn-edit" onclick="openEdit(${o.rowIndex})">×¢×¨×•×š ×•×”×“×¤×¡ ××“×‘×§×” ğŸ·ï¸</button>
      </div>
    `).join("");
  }

  function openEdit(row) {
    editingRow = row;
    const o = orders.find(x => x.rowIndex == row);
    document.getElementById('i_name').value = o.name;
    document.getElementById('i_phone').value = o.phone;
    document.getElementById('i_addr').value = o.city + " " + (o.addr || "");
    document.getElementById('i_price').value = o.price;
    document.getElementById('i_content').value = o.offer || "";
    document.getElementById('editModal').style.display = 'flex';
  }

  function closeModal() { document.getElementById('editModal').style.display = 'none'; }

  function saveAndPrint() {
    const o = orders.find(x => x.rowIndex == editingRow);
    const date = new Date().toLocaleDateString('he-IL');
    
    const pa = document.getElementById('printArea');
    pa.innerHTML = `
      <div class="label-box" dir="rtl">
        <div class="label-header">
          <img src="https://www.madparfum.com/logo.svg">
          <div style="text-align:left">×ª××¨×™×š: ${date}<br>×”×–×× ×”: ${o.orderId}</div>
        </div>

        <div class="promo-banner">×¦×œ× ××ª ×”×¨×’×¢ ×•×§×‘×œ ××ª× ×” ğŸ</div>

        <div class="info-line"><b>×œ×›×‘×•×“:</b> ${document.getElementById('i_name').value}</div>
        <div class="info-line"><b>×˜×œ×¤×•×Ÿ:</b> ${document.getElementById('i_phone').value}</div>
        <div class="info-line"><b>×›×ª×•×‘×ª:</b> ${document.getElementById('i_addr').value}</div>
        <div class="info-line"><b>××©×œ×•×—:</b> ${document.getElementById('i_del').value}</div>

        <div class="content-box">
          <b>××—×ª×•×™ Ø§Ù„Ø·Ø±Ø¯:</b><br>
          ${document.getElementById('i_content').value.replace(/\n/g, '<br>')}
        </div>

        <div class="payment-box">×œ×ª×©×œ×•×: â‚ª${document.getElementById('i_price').value}</div>

        <div class="footer">
          <div class="wa-info">
            ×©×œ×— ×•×™×“××• ×”××œ×¦×” ×œ-WhatsApp ×•×§×‘×œ ××ª× ×”!<br>
            +972 54-963-4449
          </div>
          <div id="qr_box"></div>
        </div>

        <div style="text-align:center; margin-top:2mm">
          <svg id="bar_box"></svg>
        </div>
      </div>
    `;

    // Ø¥Ù†Ø´Ø§Ø¡ Ø§Ù„Ø¨Ø§Ø±ÙƒÙˆØ¯ ÙˆØ§Ù„Ù€ QR
    setTimeout(() => {
      JsBarcode("#bar_box", document.getElementById('i_phone').value, { format: "CODE128", height: 30, fontSize: 10 });
      new QRCode(document.getElementById("qr_box"), { text: "https://wa.me/972549634449", width: 50, height: 50 });
      window.print();
      closeModal();
    }, 300);
  }

  load();
</script>
</body>
</html>
