<!doctype html>
<html lang="he" dir="rtl">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width,initial-scale=1"/>
  <title>MAD SYSTEM v3.0 (Bulk Select)</title>
  
  <script src="https://cdn.jsdelivr.net/npm/jsbarcode@3.11.5/dist/JsBarcode.all.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/qrcodejs@1.0.0/qrcode.min.js"></script>
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
  <link href="https://fonts.googleapis.com/css2?family=Rubik:wght@300;400;500;700;900&display=swap" rel="stylesheet">

  <style>
    :root { 
      --bg-dark: #0f172a; --bg-card: #1e293b; --primary: #3b82f6; 
      --accent: #f59e0b; --success: #10b981; --text: #f8fafc; --muted: #94a3b8;
      --font: 'Rubik', sans-serif;
    }

    body { margin: 0; font-family: var(--font); background: var(--bg-dark); color: var(--text); height: 100vh; display: flex; flex-direction: column; overflow: hidden; }
    * { box-sizing: border-box; outline: none; }

    /* --- Scrollbar --- */
    ::-webkit-scrollbar { width: 6px; }
    ::-webkit-scrollbar-track { background: var(--bg-dark); }
    ::-webkit-scrollbar-thumb { background: #334155; border-radius: 10px; }

    /* --- Header --- */
    .header { 
      background: rgba(30, 41, 59, 0.95); padding: 15px 25px; border-bottom: 1px solid #334155; 
      display: flex; align-items: center; justify-content: space-between; z-index: 100;
    }
    .brand { font-size: 1.5rem; font-weight: 900; color: #fff; }
    
    .search-box { 
      flex: 1; max-width: 400px; margin: 0 20px; position: relative;
    }
    .search-inp { 
      width: 100%; padding: 10px 15px 10px 40px; border-radius: 8px; border: 1px solid #334155; 
      background: #0f172a; color: white; font-family: var(--font);
    }
    .search-icon { position: absolute; right: 12px; top: 50%; transform: translateY(-50%); color: var(--muted); }

    /* --- Workspace --- */
    .workspace { flex: 1; overflow-y: auto; padding: 20px; position: relative; }
    .grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(300px, 1fr)); gap: 15px; padding-bottom: 80px; }

    /* --- Card Design --- */
    .card { 
      background: var(--bg-card); border: 1px solid #334155; border-radius: 10px; padding: 15px; 
      position: relative; transition: 0.2s; display: flex; flex-direction: column; gap: 8px;
    }
    .card:hover { border-color: var(--primary); transform: translateY(-3px); background: #263345; }
    
    /* Checkbox Styles */
    .card-select {
      position: absolute; top: 15px; right: 15px; width: 22px; height: 22px; cursor: pointer; accent-color: var(--primary); z-index: 10;
    }

    .card-top { display: flex; justify-content: space-between; font-size: 0.8rem; color: var(--muted); margin-bottom: 5px; padding-left: 25px; /* space for checkbox */ }
    
    .card-name { font-size: 1.2rem; font-weight: 700; color: #fff; }
    .card-detail { display: flex; align-items: center; gap: 8px; font-size: 0.9rem; color: #cbd5e1; }
    .card-detail i { width: 20px; color: var(--accent); text-align: center; }
    
    .card-body { 
      background: rgba(0,0,0,0.2); padding: 8px; border-radius: 6px; font-size: 0.85rem; 
      color: var(--muted); margin: 8px 0; max-height: 60px; overflow: hidden;
    }

    .card-footer { display: flex; justify-content: space-between; align-items: flex-end; margin-top: auto; border-top: 1px solid #334155; padding-top: 10px; }
    .price { color: var(--success); font-size: 1.3rem; font-weight: 800; }
    .payment-tag { font-size: 0.75rem; background: #334155; padding: 2px 8px; border-radius: 4px; color: #fff; }

    /* --- Bulk Action Bar --- */
    .bulk-bar {
      position: fixed; bottom: 20px; left: 50%; transform: translateX(-50%) translateY(150%);
      background: #000; color: #fff; padding: 15px 30px; border-radius: 50px;
      box-shadow: 0 10px 30px rgba(0,0,0,0.5); display: flex; align-items: center; gap: 20px;
      z-index: 500; transition: 0.3s cubic-bezier(0.175, 0.885, 0.32, 1.275); border: 1px solid #333;
    }
    .bulk-bar.active { transform: translateX(-50%) translateY(0); }
    .btn-bulk { background: var(--accent); color: #000; border: none; padding: 8px 20px; border-radius: 20px; font-weight: bold; cursor: pointer; }

    /* --- Modal & Print --- */
    .modal-overlay { display: none; position: fixed; inset: 0; background: rgba(0,0,0,0.85); z-index: 1000; justify-content: center; align-items: center; }
    .modal-box { width: 95%; max-width: 1100px; height: 90vh; background: #fff; border-radius: 12px; display: flex; overflow: hidden; }
    
    /* Print CSS (10x10 Label) */
    .label-page { 
      width: 100mm; height: 100mm; background: #fff; color: #000; padding: 4mm; 
      box-sizing: border-box; border: 1px solid #ddd; display: flex; flex-direction: column; 
      overflow: hidden; page-break-after: always; direction: rtl; position: relative;
    }
    .l-header { display: flex; justify-content: space-between; height: 18mm; }
    .l-logo img { width: 35mm; }
    .l-meta { font-size: 9pt; font-weight: 800; }
    
    .l-banner { background: #000; color: #fbbf24; text-align: center; padding: 3px; font-weight: 900; margin: 2mm 0; border-radius: 4px; font-size: 10pt; }
    
    .l-grid { display: grid; grid-template-columns: 70px 1fr; gap: 2px; font-size: 10.5pt; margin-bottom: 3mm; line-height: 1.2; }
    .l-label { font-weight: 800; }
    
    .l-products { font-size: 9pt; font-weight: bold; height: 14mm; overflow: hidden; border-bottom: 1px dashed #000; margin-bottom: 2mm; }
    .l-price { border: 2px solid #000; text-align: center; font-size: 20pt; font-weight: 900; padding: 2px; border-radius: 6px; }
    
    .l-footer { margin-top: auto; display: flex; justify-content: space-between; align-items: flex-end; }
    .wa-box { background: #000; color: #fff; font-size: 7pt; padding: 4px; border-radius: 4px; width: 65%; font-weight: bold; }
    
    @media print {
      body * { visibility: hidden; }
      #printArea, #printArea * { visibility: visible; }
      #printArea { position: absolute; left: 0; top: 0; width: 100%; }
      @page { size: 100mm 100mm; margin: 0; }
    }
  </style>
</head>
<body>

<audio id="bell" src="https://assets.mixkit.co/active_storage/sfx/2869/2869-preview.mp3"></audio>

<div class="header">
  <div class="brand">MAD <span style="color:var(--primary)">V3</span></div>
  
  <div class="search-box">
    <i class="fas fa-search search-icon"></i>
    <input class="search-inp" id="search" placeholder="×—×™×¤×•×© ×œ×¤×™ ×©×, ×˜×œ×¤×•×Ÿ ××• ×¢×™×¨..." oninput="app.render()">
  </div>

  <button onclick="app.loadData()" style="background:none; border:1px solid #334155; color:#fff; padding:8px 15px; border-radius:6px; cursor:pointer;">
    ×¨×¢× ×Ÿ â†»
  </button>
</div>

<div class="workspace">
  <div class="grid" id="grid"></div>
</div>

<div class="bulk-bar" id="bulkBar">
  <span id="selectedCount">0 × ×‘×—×¨×•</span>
  <button class="btn-bulk" onclick="app.printSelected()">×”×“×¤×¡ ××¡×•×× ×™× ğŸ–¨ï¸</button>
  <button onclick="app.clearSelection()" style="background:none;border:none;color:#aaa;cursor:pointer;text-decoration:underline">×‘×™×˜×•×œ</button>
</div>

<div class="modal-overlay" id="editorModal">
  <div class="modal-box">
    <div style="width:35%; background:#f8fafc; padding:30px; display:flex; flex-direction:column; gap:15px; color:#000; overflow-y:auto;" dir="rtl">
      <h2 style="margin:0">×¢×¨×™×›×” ××”×™×¨×”</h2>
      
      <label>×©×:</label><input id="e_name" class="search-inp" style="background:#fff;color:#000;border-color:#ccc" oninput="app.updatePreview()">
      <label>×˜×œ×¤×•×Ÿ:</label><input id="e_phone" class="search-inp" style="background:#fff;color:#000;border-color:#ccc" oninput="app.updatePreview()">
      <label>×¢×™×¨ + ×›×ª×•×‘×ª:</label><input id="e_city" class="search-inp" style="background:#fff;color:#000;border-color:#ccc" oninput="app.updatePreview()">
      
      <div style="display:grid; grid-template-columns: 1fr 1fr; gap:10px">
        <div><label>×—×‘×¨×ª ×©×œ×™×—×•×™×•×ª:</label><input id="e_del" class="search-inp" style="background:#fff;color:#000;border-color:#ccc" oninput="app.updatePreview()"></div>
        <div><label>×©×™×˜×ª ×ª×©×œ×•×:</label><input id="e_pay" class="search-inp" style="background:#fff;color:#000;border-color:#ccc" oninput="app.updatePreview()"></div>
      </div>

      <label>×¤×¨×™×˜×™×:</label><textarea id="e_offer" style="width:100%;height:80px;padding:10px;border-radius:6px;border:1px solid #ccc" oninput="app.updatePreview()"></textarea>
      <label>××—×™×¨ ×œ×ª×©×œ×•×:</label><input type="number" id="e_price" class="search-inp" style="background:#fff;color:green;font-weight:bold;font-size:1.2rem;border-color:#ccc" oninput="app.updatePreview()">

      <div style="margin-top:auto; display:flex; gap:10px">
        <button onclick="app.closeModal()" style="flex:1; padding:15px; background:#ddd; border:none; border-radius:8px; cursor:pointer">×‘×™×˜×•×œ</button>
        <button onclick="app.printFromModal()" style="flex:2; padding:15px; background:#000; color:#fff; border:none; border-radius:8px; font-weight:bold; cursor:pointer">×”×“×¤×¡ ×•×©××•×¨</button>
      </div>
    </div>
    
    <div style="width:65%; background:#e2e8f0; display:flex; justify-content:center; align-items:center; padding:20px;">
      <div id="livePreview" style="transform:scale(0.9); box-shadow:0 20px 50px rgba(0,0,0,0.3)"></div>
    </div>
  </div>
</div>

<div id="printArea"></div>

<script>
class MadSystem {
  constructor() {
    this.scriptUrl = "https://script.google.com/macros/s/AKfycbyLjLFa8AaH82Ip7m747WC-KSUUEaU_M70S0I9Mda14XbnmcuEfZ7pBnF_zzJYZuXmZ/exec";
    this.orders = [];
    this.selectedIds = new Set(); // Stores indices of selected cards
    this.editingIndex = null;
    this.init();
  }

  init() {
    if(localStorage.getItem('mad_auth') !== "12345678") {
      if(prompt("Password:") === "12345678") localStorage.setItem('mad_auth', "12345678");
      else return;
    }
    this.loadData();
    setInterval(() => this.loadData(true), 20000);
  }

  async loadData(silent = false) {
    if(!silent) document.getElementById('grid').innerHTML = '<div style="color:white;text-align:center;padding:50px">×˜×•×¢×Ÿ × ×ª×•× ×™×...</div>';
    try {
      const res = await fetch(`${this.scriptUrl}?action=get`);
      this.orders = await res.json();
      this.render();
      if(!silent && this.orders.length > 0) document.getElementById('bell').play().catch(()=>{});
    } catch(e) { console.error(e); }
  }

  formatPhone(p) {
    p = String(p || "").replace(/[^0-9]/g, "");
    if(p.startsWith("972")) p = "0" + p.slice(3);
    if(p.startsWith("5") && p.length === 9) p = "0" + p;
    return p.length === 10 ? p.slice(0,3) + "-" + p.slice(3) : p;
  }

  // --- Core Rendering ---
  render() {
    const q = document.getElementById('search').value.toLowerCase();
    const grid = document.getElementById('grid');
    
    // Filter Logic
    const list = this.orders.filter((o, i) => {
      const txt = (o.name + o.phone + o.city + o.orderId).toLowerCase();
      return txt.includes(q);
    });

    if(list.length === 0) {
      grid.innerHTML = '<div style="grid-column:1/-1;text-align:center;color:#555">×œ× × ××¦××• ×ª×•×¦××•×ª</div>';
      return;
    }

    grid.innerHTML = list.map(o => {
      const i = this.orders.indexOf(o); // Get original index
      const isSelected = this.selectedIds.has(i);
      const isReady = (o.status||"").includes("READY");
      
      // Data Mapping (Based on user request)
      // Delivery (K), Status (L), Payment (N)
      const delivery = o.delivery || "High Express"; 
      const status = o.status || "×××ª×™×Ÿ";
      const payment = o.payment || "××–×•××Ÿ";
      const city = o.city || "---";

      return `
        <div class="card" style="${isReady ? 'opacity:0.6' : ''}; border-right:4px solid ${isReady ? 'var(--success)' : 'var(--accent)'}">
          <input type="checkbox" class="card-select" 
                 ${isSelected ? 'checked' : ''} 
                 onclick="event.stopPropagation(); app.toggleSelect(${i})">
          
          <div class="card-top" onclick="app.openEditor(${i})">
            <span>#${o.orderId}</span>
            <span style="color:var(--accent); font-weight:bold">${delivery}</span>
          </div>

          <div class="card-name" onclick="app.openEditor(${i})">${o.name}</div>
          
          <div class="card-detail"><i class="fas fa-phone"></i> ${this.formatPhone(o.phone)}</div>
          <div class="card-detail"><i class="fas fa-city"></i> ${city}</div>

          <div class="card-body" onclick="app.openEditor(${i})">
            ${o.offer || '××™×Ÿ ×¤×™×¨×•×˜ ××•×¦×¨×™×'}
          </div>

          <div class="card-footer" onclick="app.openEditor(${i})">
            <div>
               <div class="payment-tag"><i class="far fa-credit-card"></i> ${payment}</div>
               <div style="font-size:0.75rem; color:${isReady?'#10b981':'#f59e0b'}; margin-top:4px">${status}</div>
            </div>
            <div class="price">â‚ª${o.price}</div>
          </div>
        </div>
      `;
    }).join("");
  }

  // --- Selection Logic ---
  toggleSelect(index) {
    if(this.selectedIds.has(index)) this.selectedIds.delete(index);
    else this.selectedIds.add(index);
    this.updateBulkBar();
  }

  clearSelection() {
    this.selectedIds.clear();
    this.updateBulkBar();
    this.render(); // Re-render to uncheck boxes
  }

  updateBulkBar() {
    const bar = document.getElementById('bulkBar');
    const count = this.selectedIds.size;
    document.getElementById('selectedCount').innerText = `${count} ×”×–×× ×•×ª × ×‘×—×¨×•`;
    
    if(count > 0) bar.classList.add('active');
    else bar.classList.remove('active');
  }

  // --- Editor Modal ---
  openEditor(index) {
    this.editingIndex = index;
    const o = this.orders[index];
    
    // Fill fields
    ['name','phone','city','offer','price'].forEach(k => document.getElementById('e_'+k).value = o[k]||"");
    document.getElementById('e_del').value = o.delivery || "High Express";
    document.getElementById('e_pay').value = o.payment || "××–×•××Ÿ";

    document.getElementById('editorModal').style.display = 'flex';
    this.updatePreview();
  }

  closeModal() {
    document.getElementById('editorModal').style.display = 'none';
  }

  updatePreview() {
    const data = this.getModalData();
    document.getElementById('livePreview').innerHTML = this.generateLabelHtml(data, 'prev');
    this.genCodes('prev', data.phone);
  }

  getModalData() {
    const o = this.orders[this.editingIndex];
    return {
      orderId: o.orderId,
      name: document.getElementById('e_name').value,
      phone: document.getElementById('e_phone').value,
      city: document.getElementById('e_city').value,
      delivery: document.getElementById('e_del').value,
      payment: document.getElementById('e_pay').value,
      offer: document.getElementById('e_offer').value,
      price: document.getElementById('e_price').value
    };
  }

  // --- Printing ---
  generateLabelHtml(o, idSuffix) {
    const date = new Date().toLocaleDateString('he-IL');
    const phone = this.formatPhone(o.phone);
    const cleanPhone = phone.replace(/-/g,"");

    return `
      <div class="label-page" dir="rtl">
        <div class="l-header">
           <div class="l-logo"><img src="https://www.madparfum.com/logo.svg"></div>
           <div class="l-meta">
             DATE: ${date}<br>
             ORD: ${o.orderId}
           </div>
        </div>
        
        <div class="l-banner">×¦×œ× ××ª ×”×¨×’×¢ ×•×§×‘×œ ××ª× ×” ğŸ</div>
        
        <div class="l-grid">
           <div class="l-label">×œ×›×‘×•×“:</div> <div>${o.name}</div>
           <div class="l-label">×˜×œ×¤×•×Ÿ:</div> <div style="font-family:monospace;direction:ltr;text-align:right">${phone}</div>
           <div class="l-label">×¢×™×¨:</div> <div>${o.city}</div>
           <div class="l-label">×—×‘×¨×”:</div> <div>${o.delivery}</div>
           <div class="l-label">×ª×©×œ×•×:</div> <div>${o.payment || ""}</div>
        </div>

        <div class="l-products">${o.offer}</div>
        
        <div class="l-price">â‚ª${o.price}</div>

        <div class="l-footer">
          <div class="wa-box">
             1. ×¡×¨×•×§ ××ª ×”×§×•×“ <br>2. ×©×œ×— ×¡×¨×˜×•×Ÿ ×œ-WhatsApp <br>3. ×§×‘×œ ××ª× ×”!
          </div>
          <div id="qr_${idSuffix}"></div>
        </div>
        
        <div style="text-align:center; margin-top:5px">
           <svg id="bar_${idSuffix}"></svg>
        </div>
      </div>
    `;
  }

  genCodes(suffix, phone) {
    setTimeout(() => {
      try {
        const clean = String(phone).replace(/[^0-9]/g, "");
        JsBarcode(`#bar_${suffix}`, clean, {format:"CODE128", height:25, fontSize:10, displayValue:false, margin:0});
        document.getElementById(`qr_${suffix}`).innerHTML = "";
        new QRCode(document.getElementById(`qr_${suffix}`), {text:"https://wa.me/972549634449", width:50, height:50});
      } catch(e){}
    }, 100);
  }

  printFromModal() {
    this.printList([this.getModalData()]);
    // Simulate updating status locally
    setTimeout(() => {
       const o = this.orders[this.editingIndex];
       o.status = "READY âœ…";
       this.closeModal();
       this.render();
       fetch(`${this.scriptUrl}?action=updateStatus&key=12345678&row=${o.rowIndex}&status=READY âœ…`);
    }, 1000);
  }

  printSelected() {
    if(this.selectedIds.size === 0) return;
    const list = [];
    this.selectedIds.forEach(idx => list.push(this.orders[idx]));
    
    if(confirm(`×œ×”×“×¤×™×¡ ${list.length} ×”×–×× ×•×ª?`)) {
      this.printList(list);
      // Optional: Mark all as ready
      if(confirm("×œ×¡××Ÿ ×”×›×œ ×›-READY?")) {
        list.forEach(o => {
           o.status = "READY âœ…";
           fetch(`${this.scriptUrl}?action=updateStatus&key=12345678&row=${o.rowIndex}&status=READY âœ…`);
        });
        this.clearSelection();
      }
    }
  }

  printList(list) {
    const area = document.getElementById('printArea');
    area.innerHTML = list.map((o, i) => this.generateLabelHtml(o, `p_${i}`)).join("");
    
    list.forEach((o, i) => this.genCodes(`p_${i}`, o.phone));
    
    setTimeout(() => {
      window.print();
    }, 1000);
  }
}

const app = new MadSystem();
</script>
</body>
</html>
