<!doctype html>
<html lang="he" dir="rtl">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width,initial-scale=1"/>
  <title>MAD FINAL FIX</title>
  
  <script src="https://cdn.jsdelivr.net/npm/jsbarcode@3.11.5/dist/JsBarcode.all.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/qrcodejs@1.0.0/qrcode.min.js"></script>
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">

  <style>
    :root { --bg: #000000; --card: #18181b; --primary: #3b82f6; --text: #fff; --accent: #f59e0b; }
    
    body { margin: 0; font-family: 'Segoe UI', Tahoma, sans-serif; background: var(--bg); color: var(--text); height: 100vh; display: flex; flex-direction: column; overflow: hidden; }

    /* --- Ø§Ù„Ù‡ÙŠØ¯Ø± --- */
    .header { background: #111; padding: 15px 20px; border-bottom: 1px solid #333; display: flex; justify-content: space-between; align-items: center; }
    .brand { font-size: 1.5rem; font-weight: 900; color: #fff; letter-spacing: 1px; }
    
    .tabs { display: flex; gap: 10px; background: #222; padding: 5px; border-radius: 8px; }
    .tab { padding: 8px 15px; cursor: pointer; border-radius: 5px; color: #888; font-weight: bold; }
    .tab.active { background: var(--primary); color: #fff; }
    
    .search-box { flex: 1; max-width: 400px; margin: 0 20px; padding: 10px; border-radius: 5px; border: 1px solid #444; background: #000; color: #fff; font-weight: bold; }

    .btn { padding: 10px 20px; border-radius: 5px; font-weight: bold; cursor: pointer; border: none; color: #fff; display: flex; align-items: center; gap: 5px; }
    .btn-all { background: var(--accent); color: #000; }
    .btn-refresh { background: #333; }

    /* --- Ù…Ù†Ø·Ù‚Ø© Ø§Ù„Ø¹Ù…Ù„ --- */
    .workspace { flex: 1; overflow-y: auto; padding: 20px; }
    .grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(320px, 1fr)); gap: 15px; }

    .card { background: var(--card); border: 1px solid #333; border-radius: 10px; padding: 15px; cursor: pointer; position: relative; border-right: 4px solid transparent; }
    .card:hover { border-color: var(--primary); background: #222; }
    
    .card-top { display: flex; justify-content: space-between; color: #777; font-size: 0.9rem; margin-bottom: 5px; }
    .card-name { font-size: 1.2rem; font-weight: 800; color: #fff; margin-bottom: 5px; }
    .card-phone { font-family: monospace; color: #aaa; direction: ltr; text-align: right; }
    .card-offer { background: #000; padding: 8px; border-radius: 5px; font-size: 0.9rem; margin-top: 10px; color: #ddd; max-height: 50px; overflow: hidden; }
    .card-price { position: absolute; bottom: 15px; left: 15px; font-size: 1.2rem; font-weight: bold; color: #10b981; }

    /* --- Ø§Ù„Ù…ÙˆØ¯Ø§Ù„ --- */
    .modal-overlay { display: none; position: fixed; inset: 0; background: rgba(0,0,0,0.9); z-index: 1000; justify-content: center; align-items: center; }
    .modal-box { width: 95%; max-width: 1100px; height: 90vh; background: #fff; color: #000; border-radius: 10px; display: flex; overflow: hidden; }
    .editor { width: 35%; background: #f4f4f5; padding: 20px; overflow-y: auto; display: flex; flex-direction: column; gap: 10px; }
    .preview { width: 65%; background: #e4e4e7; display: flex; align-items: center; justify-content: center; }
    
    .inp-group label { display: block; font-weight: bold; font-size: 0.85rem; }
    .inp-group input, .inp-group textarea { width: 100%; padding: 10px; border: 1px solid #ccc; border-radius: 5px; box-sizing: border-box; font-weight: bold; }
    .btn-print-big { width: 100%; padding: 15px; background: #000; color: #fff; font-size: 1.2rem; margin-top: auto; border: none; cursor: pointer; font-weight: bold; }

    /* --- Ø§Ù„Ù…Ù„ØµÙ‚ --- */
    .label-page { 
      width: 100mm; height: 100mm; background: #fff; color: #000; padding: 3mm; 
      box-sizing: border-box; border: 1px solid #ddd; display: flex; flex-direction: column; 
      position: relative; overflow: hidden; page-break-after: always; direction: rtl;
    }
    .l-head { display: flex; justify-content: space-between; height: 20mm; align-items: flex-start; }
    .l-logo img { width: 35mm; }
    .l-meta { text-align: left; font-size: 9pt; font-weight: 800; line-height: 1.2; }
    
    .l-banner { 
      background: #18181b; color: #fbbf24; text-align: center; font-weight: 900; 
      font-size: 11pt; padding: 4px; margin: 1mm 0 3mm 0; border-radius: 4px;
      display: flex; align-items: center; justify-content: center; gap: 5px;
    }
    
    .l-info { font-size: 11pt; line-height: 1.35; margin-bottom: 2mm; }
    .l-info b { font-weight: 800; min-width: 50px; display: inline-block; }
    .l-products { font-size: 9.5pt; font-weight: bold; line-height: 1.2; margin-bottom: 2mm; max-height: 15mm; overflow: hidden; }
    .l-price-box { border: 3px solid #000; font-size: 22pt; font-weight: 900; text-align: center; padding: 2px; margin-bottom: 2mm; }
    
    .l-footer { display: flex; justify-content: space-between; align-items: flex-end; margin-top: auto; border-top: 1px solid #000; padding-top: 2mm; }
    .l-wa-text { font-size: 7.5pt; font-weight: 800; width: 68%; line-height: 1.2; background: #18181b; color: #fbbf24; padding: 5px; border-radius: 4px; }

    /* --- Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª Ø§Ù„Ø·Ø¨Ø§Ø¹Ø© Ø§Ù„Ù…ØµØ­Ø­Ø© --- */
    #printArea { display: none; }
    
    @media print {
      /* Ø¥Ø®ÙØ§Ø¡ ÙƒÙ„ Ø´ÙŠØ¡ Ù…Ø§ Ø¹Ø¯Ø§ Ù…Ù†Ø·Ù‚Ø© Ø§Ù„Ø·Ø¨Ø§Ø¹Ø© */
      body > *:not(#printArea) { display: none !important; }
      #printArea { display: block !important; position: absolute; top: 0; left: 0; width: 100%; }
      body { background: #fff; height: auto; overflow: visible; }
      @page { size: 100mm 100mm; margin: 0; }
      .label-page { border: none; }
    }
  </style>
</head>
<body>

<div class="header">
  <div class="brand">MAD SYSTEM</div>
  <div class="tabs">
    <div class="tab active" id="tab-pending" onclick="setTab('pending')">Ù‚ÙŠØ¯ Ø§Ù„ØªØ¬Ù‡ÙŠØ² <span id="c-pending">0</span></div>
    <div class="tab" id="tab-all" onclick="setTab('all')">Ø§Ù„Ø£Ø±Ø´ÙŠÙ <span id="c-all">0</span></div>
  </div>
  <input class="search-box" id="search" placeholder="Ø¨Ø­Ø«..." oninput="render()">
  <div style="display:flex; gap:10px">
    <button class="btn btn-refresh" onclick="loadData()">ØªØ­Ø¯ÙŠØ« â†»</button>
    <button class="btn btn-all" onclick="printAll()">Ø·Ø¨Ø§Ø¹Ø© Ø§Ù„Ù‚Ø§Ø¦Ù…Ø© ğŸ–¨ï¸</button>
  </div>
</div>

<div class="workspace">
  <div class="grid" id="grid"></div>
</div>

<div class="modal-overlay" id="editor">
  <div class="modal-box">
    <div class="editor" dir="rtl">
      <div style="display:flex; justify-content:space-between">
        <h2>ØªØ¹Ø¯ÙŠÙ„ Ø§Ù„Ø·Ù„Ø¨</h2>
        <button onclick="closeModal()" style="border:none;background:none;font-size:2rem;cursor:pointer">&times;</button>
      </div>
      <div class="inp-group"><label>Ø§Ù„Ø§Ø³Ù…</label><input id="e_name" oninput="updatePreview()"></div>
      <div class="inp-group"><label>Ø§Ù„Ù‡Ø§ØªÙ (ØªÙ„Ù‚Ø§Ø¦ÙŠ)</label><input id="e_phone" oninput="updatePreview()"></div>
      <div class="inp-group"><label>Ø§Ù„Ø¹Ù†ÙˆØ§Ù†</label><input id="e_city" oninput="updatePreview()"></div>
      <div class="inp-group"><label>Ø§Ù„Ø´Ø­Ù†</label><input id="e_del" oninput="updatePreview()"></div>
      <div class="inp-group"><label>Ø§Ù„Ù…Ù†ØªØ¬Ø§Øª</label><textarea id="e_offer" oninput="updatePreview()" style="height:80px"></textarea></div>
      <div class="inp-group"><label>Ø§Ù„Ø³Ø¹Ø± â‚ª</label><input id="e_price" type="number" oninput="updatePreview()" style="font-size:1.2rem; color:green"></div>
      <button class="btn-print-big" onclick="printSingle()">Ø·Ø¨Ø§Ø¹Ø© (Enter) ğŸ–¨ï¸</button>
    </div>
    <div class="preview">
      <div id="livePreview"></div>
    </div>
  </div>
</div>

<div id="printArea"></div>

<script>
  const SCRIPT_URL = "https://script.google.com/macros/s/AKfycbyLjLFa8AaH82Ip7m747WC-KSUUEaU_M70S0I9Mda14XbnmcuEfZ7pBnF_zzJYZuXmZ/exec";
  const PASS = "12345678";
  
  let orders = [];
  let currentTab = 'pending';
  let currentIndex = null;

  // 1. ØªØ­ÙˆÙŠÙ„ Ø§Ù„Ø±Ù‚Ù… Ù„Ù€ 05X-XXXXXXX
  function formatPhone(input) {
    let p = String(input || "").replace(/[^0-9]/g, "");
    if(!p) return "";
    
    // Ø¥Ø²Ø§Ù„Ø© Ø§Ù„Ù…Ù‚Ø¯Ù…Ø§Øª Ø§Ù„Ø¯ÙˆÙ„ÙŠØ©
    if(p.startsWith("972")) p = "0" + p.slice(3);
    if(p.startsWith("970")) p = "0" + p.slice(3);
    
    // Ø¥ØµÙ„Ø§Ø­ Ø£Ø®Ø·Ø§Ø¡ Ø§Ù„ÙƒØªØ§Ø¨Ø© (Ù†Ø³ÙŠØ§Ù† Ø§Ù„ØµÙØ±)
    if(p.startsWith("5") && p.length === 9) p = "0" + p;
    
    // Ø§Ù„ØªÙ†Ø³ÙŠÙ‚ Ø§Ù„Ø¬Ù…Ø§Ù„ÙŠ
    if(p.length === 10) return p.slice(0,3) + "-" + p.slice(3);
    return p;
  }

  // 2. Ø§Ù„ØªØ­Ù…ÙŠÙ„
  (function(){
    if(localStorage.getItem('mad_auth') !== PASS) {
      if(prompt("Password:") === PASS) localStorage.setItem('mad_auth', PASS);
      else { document.body.innerHTML="Access Denied"; return; }
    }
    loadData();
    setInterval(loadData, 20000);
  })();

  async function loadData() {
    try {
      const res = await fetch(`${SCRIPT_URL}?action=get`);
      orders = await res.json();
      render();
    } catch(e) {}
  }

  function setTab(t) {
    currentTab = t;
    document.querySelectorAll('.tab').forEach(e => e.classList.remove('active'));
    document.getElementById('tab-'+t).classList.add('active');
    render();
  }

  function render() {
    const pendingList = orders.filter(o => {
      const st = (o.status || "").toLowerCase();
      return (st.includes("prep") || st.includes("approved")) && !st.includes("ready");
    });
    
    document.getElementById('c-pending').innerText = pendingList.length;
    document.getElementById('c-all').innerText = orders.length;
    
    let list = currentTab === 'pending' ? pendingList : orders;
    const q = document.getElementById('search').value.toLowerCase().trim();
    
    if(q) {
      list = list.filter(o => {
        const pClean = formatPhone(o.phone).replace(/-/g, "");
        return (o.name||"").toLowerCase().includes(q) || 
               (o.orderId||"").toString().includes(q) ||
               pClean.includes(q);
      });
    }

    const grid = document.getElementById('grid');
    if(!list.length) {
      grid.innerHTML = '<div style="grid-column:1/-1;text-align:center;padding:50px;color:#555">Ù„Ø§ ØªÙˆØ¬Ø¯ Ø·Ù„Ø¨Ø§Øª</div>';
      return;
    }

    grid.innerHTML = list.map(o => {
      const idx = orders.indexOf(o);
      const isReady = (o.status||"").includes("READY");
      return `
        <div class="card" onclick="openEditor(${idx})" style="opacity:${isReady?0.6:1}">
          <div class="card-top">
            <span>#${o.orderId}</span>
            <span>${o.delivery || 'Standard'}</span>
          </div>
          <div class="card-name">${o.name}</div>
          <div class="card-phone">${formatPhone(o.phone)}</div>
          <div class="card-offer">ğŸ“¦ ${o.offer || '...'}</div>
          <div class="card-price">â‚ª${o.price}</div>
        </div>
      `;
    }).join("");
  }

  // 3. ØªØµÙ…ÙŠÙ… Ø§Ù„Ù…Ù„ØµÙ‚
  function getLabelHTML(o, idSuffix) {
    const date = new Date().toLocaleDateString('he-IL');
    const localPhone = formatPhone(o.phone);
    const cleanPhone = localPhone.replace(/-/g, ""); // Ù„Ù„Ø¨Ø§Ø±ÙƒÙˆØ¯
    
    return `
      <div class="label-page" dir="rtl">
        <div class="l-head">
          <div class="l-logo"><img src="https://www.madparfum.com/logo.svg"></div>
          <div class="l-meta">
            DATE: ${date}<br>
            ORD: ${o.orderId}
          </div>
        </div>
        <div class="l-banner">
          <i class="fas fa-gift"></i> ×¦×œ× ××ª ×”×¨×’×¢ ×•×§×‘×œ ××ª× ×”
        </div>
        <div class="l-info">
          <div><b>×œ×›×‘×•×“:</b> ${o.name}</div>
          <div><b>×˜×œ×¤×•×Ÿ:</b> <span dir="ltr" style="font-family:monospace; font-weight:900">${localPhone}</span></div>
          <div><b>×›×ª×•×‘×ª:</b> ${o.city}</div>
          <div><b>××©×œ×•×—:</b> ${o.delivery}</div>
        </div>
        <div class="l-products">
          <b>×¤×¨×™×˜×™×:</b> ${o.offer || ""}
        </div>
        <div class="l-price-box">
          ×œ×ª×©×œ×•×: â‚ª${o.price}
        </div>
        <div class="l-footer">
          <div class="l-wa-text">
             1. ×¡×¨×•×§ ××ª ×”×§×•×“ <br>
             2. ×©×œ×— ×¡×¨×˜×•×Ÿ ×œ-WhatsApp <br>
             3. ×§×‘×œ ××ª× ×”!
          </div>
          <div id="qr_${idSuffix}"></div>
        </div>
        <div style="position:absolute; bottom:2mm; width:94%; text-align:center">
           <svg id="bar_${idSuffix}" data-val="${cleanPhone}"></svg>
        </div>
      </div>
    `;
  }

  // 4. Ø§Ù„Ù…Ø­Ø±Ø± ÙˆØ§Ù„Ø·Ø¨Ø§Ø¹Ø©
  function openEditor(idx) {
    currentIndex = idx;
    const o = orders[idx];
    document.getElementById('e_name').value = o.name;
    document.getElementById('e_phone').value = o.phone;
    document.getElementById('e_city').value = o.city + " " + (o.addr||"");
    document.getElementById('e_del').value = o.delivery || "High Express";
    document.getElementById('e_offer').value = o.offer || "";
    document.getElementById('e_price').value = o.price;
    
    document.getElementById('editor').style.display = 'flex';
    updatePreview();
    
    document.onkeydown = (e) => {
      if(e.key === "Enter" && !e.shiftKey) { e.preventDefault(); printSingle(); }
      if(e.key === "Escape") closeModal();
    }
  }

  function closeModal() {
    document.getElementById('editor').style.display = 'none';
    document.onkeydown = null;
  }

  function updatePreview() {
    const d = getFormData();
    document.getElementById('livePreview').innerHTML = getLabelHTML(d, 'prev');
    genCodes('prev', d.phone);
  }

  function getFormData() {
    return {
      orderId: orders[currentIndex].orderId,
      name: document.getElementById('e_name').value,
      phone: document.getElementById('e_phone').value,
      city: document.getElementById('e_city').value,
      delivery: document.getElementById('e_del').value,
      offer: document.getElementById('e_offer').value,
      price: document.getElementById('e_price').value
    };
  }

  function genCodes(s, phone) {
    // Ø§Ù„ØªØ£Ø®ÙŠØ± Ø¶Ø±ÙˆØ±ÙŠ Ù„Ø¶Ù…Ø§Ù† ÙˆØ¬ÙˆØ¯ Ø§Ù„Ø¹Ù†ØµØ± ÙÙŠ DOM
    setTimeout(() => {
      try {
        const cleanP = formatPhone(phone).replace(/-/g, "");
        const barEl = document.getElementById(`bar_${s}`);
        if(barEl) JsBarcode(barEl, cleanP, { format: "CODE128", height: 25, fontSize: 10, displayValue: true, margin:0 });
        
        const qrEl = document.getElementById(`qr_${s}`);
        if(qrEl) {
          qrEl.innerHTML = "";
          // Ø±Ù‚Ù… Ø§Ù„ÙˆØ§ØªØ³Ø§Ø¨ Ø«Ø§Ø¨Øª +972
          new QRCode(qrEl, { text: "https://wa.me/972549634449", width: 45, height: 45 });
        }
      } catch(e) { console.log(e); }
    }, 50);
  }

  function printSingle() {
    const d = getFormData();
    const area = document.getElementById('printArea');
    area.innerHTML = getLabelHTML(d, 'print');
    
    setTimeout(() => {
      genCodes('print', d.phone);
      setTimeout(async () => {
        window.print();
        
        // Ø§Ù„ØªØ­Ø¯ÙŠØ«
        const r = orders[currentIndex].rowIndex;
        closeModal();
        await fetch(`${SCRIPT_URL}?action=updateStatus&key=${PASS}&row=${r}&status=READY âœ…`);
        orders[currentIndex].status = "READY âœ…";
        render();
      }, 500);
    }, 100);
  }

  function printAll() {
    const list = currentTab === 'pending' ? orders.filter(o => {
      const st = (o.status || "").toLowerCase();
      return (st.includes("prep") || st.includes("approved")) && !st.includes("ready");
    }) : orders;
    
    if(!list.length) return alert("Ø§Ù„Ù‚Ø§Ø¦Ù…Ø© ÙØ§Ø±ØºØ©!");
    if(!confirm(`Ø·Ø¨Ø§Ø¹Ø© ${list.length} Ù…Ù„ØµÙ‚ØŸ`)) return;

    const area = document.getElementById('printArea');
    area.innerHTML = list.map((o, i) => getLabelHTML(o, `bulk_${i}`)).join("");

    setTimeout(() => {
      list.forEach((o, i) => genCodes(`bulk_${i}`, o.phone));
      setTimeout(() => {
        window.print();
        if(currentTab === 'pending' && confirm("Ù†Ù‚Ù„ Ø¥Ù„Ù‰ Ø¬Ø§Ù‡Ø²ØŸ")) {
          list.forEach(o => {
             o.status = "READY âœ…";
             fetch(`${SCRIPT_URL}?action=updateStatus&key=${PASS}&row=${o.rowIndex}&status=READY âœ…`);
          });
          render();
        }
      }, 1500);
    }, 200);
  }
</script>
</body>
</html>
