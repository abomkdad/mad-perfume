<!doctype html>
<html lang="ar" dir="rtl">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1,maximum-scale=1,user-scalable=no"/>
  <title>MAD Preparer</title>
  <script src="https://cdn.jsdelivr.net/npm/jsbarcode@3.11.5/dist/JsBarcode.all.min.js"></script>
  <style>
    :root{--bg:#070d18;--card:#0f1a33;--line:#1f2f55;--muted:#9fb0d1;--ok:#10b981;--blue:#3b82f6;--orange:#f59e0b;}
    body{margin:0;background:var(--bg);color:#fff;font-family:system-ui,-apple-system,Segoe UI,Tahoma;padding-bottom:90px}
    header{position:sticky;top:0;background:rgba(15,26,51,.95);backdrop-filter:blur(10px);border-bottom:1px solid var(--line);z-index:9}
    .wrap{max-width:520px;margin:0 auto;padding:12px}
    h1{margin:0;font-size:16px}
    input,select,textarea{width:100%;box-sizing:border-box;border:1px solid var(--line);background:#0b1220;color:#fff;border-radius:14px;padding:14px;font-size:15px;outline:none}
    textarea{min-height:80px;resize:vertical}
    .pill{display:flex;gap:8px;flex-wrap:wrap;margin-top:10px}
    .pill span{background:#0b1220;border:1px solid var(--line);padding:6px 10px;border-radius:999px;font-size:12px;color:#cfe0ff}
    .card{background:var(--card);border:1px solid var(--line);border-radius:20px;padding:14px;margin:12px 0}
    .big{background:#ffffff;color:#000;border-radius:18px;padding:14px;margin-top:10px}
    .big .row{display:flex;justify-content:space-between;gap:10px;padding:10px 0;border-bottom:1px solid #e5e7eb}
    .big .row:last-child{border-bottom:none}
    .lab{font-weight:900;color:#111827}
    .val{font-weight:800;text-align:left;direction:ltr}
    .btns{display:grid;grid-template-columns:1fr 1fr;gap:10px;margin-top:12px}
    .btn{border:none;border-radius:16px;padding:16px 12px;font-weight:1000;cursor:pointer;font-size:15px}
    .bgreen{background:var(--ok);color:#052014}
    .bblue{background:var(--blue);color:#fff}
    .borange{background:var(--orange);color:#2a1700}
    /* print */
    #printArea{display:none}
    @media print{
      body *{visibility:hidden}
      #printArea, #printArea *{visibility:visible}
      #printArea{display:block;position:absolute;left:0;top:0;width:100%}
      .label{width:100mm;height:100mm;margin:0 auto;padding:6mm;box-sizing:border-box;background:#fff;color:#000;border:1px solid #000}
      .label h2{margin:0 0 6px;font-size:14pt}
      .label .t{font-size:11pt;margin:4px 0}
      .label .box{border:1px solid #000;padding:6px;margin-top:6px;font-weight:900}
      .label .warn{margin-top:6px;color:#b91c1c;font-weight:900;font-size:9pt;border:1px dashed #b91c1c;padding:6px;text-align:center}
    }
    /* login */
    .lock{position:fixed;inset:0;background:rgba(0,0,0,.75);display:flex;align-items:center;justify-content:center;z-index:9999}
    .lockbox{width:min(420px,92%);background:#0f172a;border:1px solid var(--line);border-radius:18px;padding:16px}
    .lockbox h2{margin:0 0 10px;font-size:16px}
    .lockbox p{margin:0 0 12px;color:var(--muted);font-size:12px}
  </style>
</head>
<body>

<!-- LOGIN -->
<div class="lock" id="lock">
  <div class="lockbox">
    <h2>ğŸ”’ Ø¯Ø®ÙˆÙ„ Ø§Ù„ØªØ¬Ù‡ÙŠØ²</h2>
    <p>ÙƒÙ„Ù…Ø© Ø§Ù„Ø³Ø± Ù…Ø·Ù„ÙˆØ¨Ø©.</p>
    <input id="pw" placeholder="ÙƒÙ„Ù…Ø© Ø§Ù„Ø³Ø±" type="password" />
    <div class="btns">
      <button class="btn bblue" onclick="login()">Ø¯Ø®ÙˆÙ„</button>
      <button class="btn borange" onclick="document.getElementById('pw').value=''">Ù…Ø³Ø­</button>
    </div>
  </div>
</div>

<header>
  <div class="wrap">
    <div style="display:flex;justify-content:space-between;align-items:center;gap:10px">
      <h1>ğŸ“¦ Ù†Ø³Ø®Ø© Ø§Ù„ØªØ¬Ù‡ÙŠØ² (Ø³Ù‡Ù„ Ø¬Ø¯Ø§Ù‹)</h1>
      <div class="btns" style="grid-template-columns:1fr 1fr; margin:0; width:210px">
        <button class="btn bblue" onclick="sync()">âŸ²</button>
        <button class="btn borange" onclick="logout()">Ø®Ø±ÙˆØ¬</button>
      </div>
    </div>

    <div class="pill">
      <span>Ø·Ù„Ø¨Ø§Øª Ù„Ù„ØªØ¬Ù‡ÙŠØ²: <b id="cPrep">0</b></span>
    </div>

    <div style="margin-top:10px">
      <select id="emp" onchange="saveEmp()">
        <option value="">-- Ø§Ø®ØªØ± Ø§Ø³Ù… Ø§Ù„Ù…ÙˆØ¸Ù --</option>
        <option value="Ø¹Ø¨ÙŠØ± (×¢×‘×™×¨)">Ø¹Ø¨ÙŠØ± (×¢×‘×™×¨)</option>
        <option value="Ø£Ù„Ø§Ø¡ (××œ××)">Ø£Ù„Ø§Ø¡ (××œ××)</option>
        <option value="Ù„ÙŠÙ„Ù‰ (×œ×™×™×œ×)">Ù„ÙŠÙ„Ù‰ (×œ×™×™×œ×)</option>
      </select>
    </div>

    <div style="margin-top:10px">
      <input id="q" placeholder="Ø¨Ø­Ø« Ø³Ø±ÙŠØ¹ (Ø§Ø³Ù…/Ù‡Ø§ØªÙ/ÙƒÙˆØ¯)" oninput="render()">
    </div>
  </div>
</header>

<div class="wrap">
  <div id="list"></div>
</div>

<div id="printArea"></div>

<script>
  const APP_PASSWORD = "12345678";
  const SCRIPT_URL = "https://script.google.com/macros/s/AKfycbw2QxGHOxMv7_uNbMulwO60IHOcKj16rbBJRfoltkwcdb2Bg4zrVjyMt_lf9KgnyyXl/exec";

  let orders = [];

  function login(){
    const v = document.getElementById("pw").value;
    if(v === APP_PASSWORD){
      localStorage.setItem("mad_auth_prep","1");
      document.getElementById("lock").style.display="none";
      loadEmp(); sync();
    }else alert("ÙƒÙ„Ù…Ø© Ø§Ù„Ø³Ø± Ø®Ø·Ø£");
  }
  function logout(){
    localStorage.removeItem("mad_auth_prep");
    location.reload();
  }
  (function boot(){
    if(localStorage.getItem("mad_auth_prep")==="1"){
      document.getElementById("lock").style.display="none";
      loadEmp(); sync();
    }
  })();

  function loadEmp(){
    const v = localStorage.getItem("mad_emp") || "";
    document.getElementById("emp").value = v;
  }
  function saveEmp(){
    localStorage.setItem("mad_emp", document.getElementById("emp").value || "");
  }

  function isHebrewText(s){ return /[\u0590-\u05FF]/.test(s||""); }
  function isArabicText(s){ return /[\u0600-\u06FF]/.test(s||""); }
  function normStatus(s){ return String(s||"").toLowerCase(); }
  function isReady(s){ return /××•×›×Ÿ|ready|Ø¬Ø§Ù‡Ø²/.test(normStatus(s)); }
  function isDelivered(s){ return /delivered|ØªÙ…\s*Ø§Ù„ØªØ³Ù„ÙŠÙ…|× ××¡×¨/.test(normStatus(s)); }
  function isCanceled(s){ return /canceled|Ù…Ù„Øº|Ø¥Ù„ØºØ§Ø¡|×‘×•×˜×œ/.test(normStatus(s)); }
  function isApproved(s){
    const t = normStatus(s);
    return /approved|×××•×©×¨|Ø§Ø¹ØªÙ…Ø§Ø¯|ØªÙ…\s*Ø§Ø±Ø³Ø§Ù„\s*Ù‡Ø°Ø§\s*Ø§Ù„Ø·Ù„Ø¨\s*Ù„Ù„ØªØ¬Ù‡ÙŠØ²|Ù‚ÙŠØ¯\s*Ø§Ù„ØªØ¬Ù‡ÙŠØ²/.test(t);
  }
  function extractPrice(offer, notes){
    const t = (offer||"") + " " + (notes||"");
    let m = t.match(/â‚ª\s*([0-9]{2,6})/); if(m) return m[1];
    m = t.match(/=\s*â‚ª\s*([0-9]{2,6})/); if(m) return m[1];
    m = t.match(/Price:\s*([0-9]{2,6})/i); if(m) return m[1];
    return "150";
  }
  function offerNoPrice(offer){
    return String(offer||"").replace(/\s*=\s*â‚ª?\s*\d{2,6}\s*$/,"").trim();
  }
  function esc(s){ return String(s||"").replace(/&/g,"&amp;").replace(/</g,"&lt;").replace(/>/g,"&gt;").replace(/"/g,"&quot;"); }
  function toWaPhone(p){
    const d = String(p||"").replace(/\D/g,"");
    if(d.startsWith("0") && d.length>=9) return ("972"+d.slice(1));
    return d;
  }

  async function sync(){
    try{
      const r = await fetch(`${SCRIPT_URL}?action=get&t=${Date.now()}`);
      const d = await r.json();
      orders = Array.isArray(d)? d : [];
      render();
    }catch(e){ console.log(e); }
  }

  function render(){
    const q = (document.getElementById("q").value||"").toLowerCase();
    const prep = [...orders].reverse()
      .filter(o => isApproved(o.status||"") && !isReady(o.status||"") && !isDelivered(o.status||"") && !isCanceled(o.status||""))
      .filter(o => (`${o.name||""} ${o.phone||""} ${o.offer||""} ${o.orderId||""}`).toLowerCase().includes(q));

    document.getElementById("cPrep").innerText = prep.length;
    document.getElementById("list").innerHTML = prep.map(card).join("") || `<div class="card">Ù„Ø§ ØªÙˆØ¬Ø¯ Ø·Ù„Ø¨Ø§Øª Ù„Ù„ØªØ¬Ù‡ÙŠØ² Ø§Ù„Ø¢Ù† âœ…</div>`;
  }

  function card(o){
    const row = o.rowIndex;
    const price = extractPrice(o.offer, o.notes);
    const offerPure = offerNoPrice(o.offer);
    const he = isHebrewText(o.name) || /\bhe\b/i.test(o.offer||"");

    return `
      <div class="card">
        <div class="big">
          <div class="row"><div class="lab">Ø±Ù‚Ù… Ø§Ù„Ø·Ù„Ø¨</div><div class="val">${esc(o.orderId||"")}</div></div>
          <div class="row"><div class="lab">Ø§Ø³Ù… Ø§Ù„Ø²Ø¨ÙˆÙ†</div><div class="val" style="direction:rtl;text-align:right">${esc(o.name||"")}</div></div>
          <div class="row"><div class="lab">Ø§Ù„Ù‡Ø§ØªÙ</div><div class="val">${esc(o.phone||"")}</div></div>
          <div class="row"><div class="lab">Ø§Ù„Ù…Ø¯ÙŠÙ†Ø© / Ø§Ù„Ø¹Ù†ÙˆØ§Ù†</div><div class="val" style="direction:rtl;text-align:right">${esc(o.city||"-")}</div></div>
          <div class="row"><div class="lab">Ø§Ù„Ø·Ù„Ø¨</div><div class="val" style="direction:rtl;text-align:right">${esc(offerPure)}</div></div>
          <div class="row"><div class="lab">Ø§Ù„Ø³Ø¹Ø±</div><div class="val">â‚ª${esc(price)}</div></div>
          <div class="row"><div class="lab">Ù…Ù„Ø§Ø­Ø¸Ø§Øª</div><div class="val" style="direction:rtl;text-align:right">${esc(o.notes||"")}</div></div>
        </div>

        <div class="btns">
          <button class="btn bblue" onclick="printLabel('${esc(o.orderId)}','${esc(o.name)}','${esc(o.phone)}','${esc(o.city)}','${esc(offerPure)}','${esc(price)}','${he ? "he":"ar"}')">ğŸ–¨ï¸ Ø·Ø¨Ø§Ø¹Ø©</button>
          <button class="btn borange" onclick="editMini(${row},'${esc(o.orderId)}')">âœï¸ ØªØ¹Ø¯ÙŠÙ„</button>
        </div>

        <div class="btns">
          <button class="btn bgreen" onclick="markReady(${row},'${esc(o.orderId)}')">âœ… ØªÙ… ØªØ¬Ù‡ÙŠØ² Ø§Ù„Ø·Ù„Ø¨</button>
          <button class="btn bblue" onclick="openWA('${esc(o.phone)}','${esc(o.name)}','${esc(o.orderId)}')">ğŸ’¬ ÙˆØ§ØªØ³Ø§Ø¨</button>
        </div>

        <div id="edit_${row}" style="display:none; margin-top:10px">
          <input id="e_offer_${row}" placeholder="ØªØ¹Ø¯ÙŠÙ„ Ø§Ù„Ø·Ù„Ø¨" value="${esc(offerPure)}">
          <input id="e_price_${row}" placeholder="ØªØ¹Ø¯ÙŠÙ„ Ø§Ù„Ø³Ø¹Ø± â‚ª" value="${esc(price)}">
          <textarea id="e_notes_${row}" placeholder="ØªØ¹Ø¯ÙŠÙ„ Ø§Ù„Ù…Ù„Ø§Ø­Ø¸Ø§Øª">${esc(o.notes||"")}</textarea>
          <div class="btns">
            <button class="btn bblue" onclick="saveMini(${row},'${esc(o.orderId)}')">ğŸ’¾ Ø­ÙØ¸</button>
            <button class="btn borange" onclick="document.getElementById('edit_${row}').style.display='none'">Ø¥ØºÙ„Ø§Ù‚</button>
          </div>
        </div>
      </div>
    `;
  }

  function editMini(row){
    const el = document.getElementById(`edit_${row}`);
    el.style.display = (el.style.display==="none") ? "block" : "none";
  }

  async function saveMini(row, orderId){
    const offer = document.getElementById(`e_offer_${row}`).value.trim();
    const price = document.getElementById(`e_price_${row}`).value.trim();
    const notes = document.getElementById(`e_notes_${row}`).value.trim();

    const qs = new URLSearchParams({
      action:"updateOrder",
      row:String(row),
      orderId,
      offer,
      price,
      notes
    });

    await fetch(`${SCRIPT_URL}?${qs.toString()}`);
    await sync();
  }

  async function markReady(row, orderId){
    const emp = document.getElementById("emp").value || localStorage.getItem("mad_emp") || "";
    if(!emp) return alert("Ø§Ø®ØªØ§Ø± Ø§Ø³Ù… Ø§Ù„Ù…ÙˆØ¸Ù Ø£ÙˆÙ„Ø§Ù‹");
    const status = `Ù…×•×›×Ÿ ×¢×œ ×™×“×™ ${emp}`;
    const qs = new URLSearchParams({action:"updateStatus", row:String(row), orderId, status});
    await fetch(`${SCRIPT_URL}?${qs.toString()}`);
    await sync();
  }

  function openWA(phone, name, orderId){
    const wa = toWaPhone(phone);
    const msg = `MAD âœ…\n${name}\nOrder: ${orderId}`;
    window.open(`https://wa.me/${wa}?text=${encodeURIComponent(msg)}`,'_blank');
  }

  function printLabel(orderId, name, phone, city, offer, price, lang){
    const area = document.getElementById("printArea");
    const isHe = (lang==="he");

    const title = isHe ? "××¢×¨×›×ª MAD" : "MAD SYSTEM";
    const nLab = isHe ? "×©×" : "Ø§Ù„Ø§Ø³Ù…";
    const pLab = isHe ? "×˜×œ×¤×•×Ÿ" : "Ø§Ù„Ù‡Ø§ØªÙ";
    const aLab = isHe ? "×›×ª×•×‘×ª" : "Ø§Ù„Ø¹Ù†ÙˆØ§Ù†";
    const oLab = isHe ? "×”×–×× ×”" : "Ø§Ù„Ø·Ù„Ø¨";
    const prLab = isHe ? "×¡×›×•×" : "Ø§Ù„Ø³Ø¹Ø±";
    const warn = isHe ? "×”×—×œ×¤×” ×¨×§ ×× ×”× ×™×™×œ×•×Ÿ ×œ× × ×¤×ª×—" : "Ø§Ù„Ø§Ø³ØªØ¨Ø¯Ø§Ù„ ÙÙ‚Ø· Ø¥Ø°Ø§ Ù„Ù… ÙŠØªÙ… ÙØªØ­ Ø§Ù„Ù†Ø§ÙŠÙ„ÙˆÙ†";

    area.innerHTML = `
      <div class="label" dir="${isHe?'rtl':'rtl'}">
        <h2 style="text-align:center">${title}</h2>
        <div class="t"><b>${nLab}:</b> ${name}</div>
        <div class="t"><b>${pLab}:</b> ${phone}</div>
        <div class="t"><b>${aLab}:</b> ${city}</div>
        <div class="box"><b>${oLab}:</b> ${offer}</div>
        <div class="t"><b>${prLab}:</b> â‚ª${price}</div>
        <div style="text-align:center;margin-top:10px"><svg id="bcode"></svg></div>
        <div class="warn">${warn}</div>
      </div>
    `;

    try{
      JsBarcode("#bcode", String(orderId||phone), { format:"CODE128", width:2, height:55, displayValue:false });
    }catch(e){}

    setTimeout(()=>window.print(), 300);
  }

  // auto refresh
  setInterval(sync, 25000);
</script>
</body>
</html>
