<!doctype html>
<html lang="he" dir="rtl">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width,initial-scale=1"/>
  <title>MAD FINAL SYSTEM | 10x10</title>
  
  <script src="https://cdn.jsdelivr.net/npm/jsbarcode@3.11.5/dist/JsBarcode.all.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/qrcodejs@1.0.0/qrcode.min.js"></script>

  <style>
    :root { 
      --bg: #0f172a;       /* Ø®Ù„ÙÙŠØ© Ø¯Ø§ÙƒÙ†Ø© */
      --card: #1e293b;     /* Ù„ÙˆÙ† Ø§Ù„Ø¨Ø·Ø§Ù‚Ø© */
      --text: #f1f5f9;     /* Ù„ÙˆÙ† Ø§Ù„Ù†Øµ */
      --primary: #3b82f6;  /* Ø§Ù„Ø£Ø²Ø±Ù‚ Ø§Ù„Ø±Ø¦ÙŠØ³ÙŠ */
      --gold: #f59e0b;     /* Ù„Ù„ØªÙ…ÙŠÙŠØ² */
      --danger: #ef4444;   /* Ù„Ù„Ø·Ù„Ø¨Ø§Øª Ø§Ù„Ù…Ø³ØªØ¹Ø¬Ù„Ø© */
    }

    body { margin: 0; font-family: 'Segoe UI', system-ui, sans-serif; background: var(--bg); color: var(--text); height: 100vh; display: flex; flex-direction: column; overflow: hidden; }
    
    /* --- Ø§Ù„Ù‡ÙŠØ¯Ø± (Ø§Ù„Ø´Ø±ÙŠØ· Ø§Ù„Ø¹Ù„ÙˆÙŠ) --- */
    .header { 
      height: 70px; background: rgba(15, 23, 42, 0.95); border-bottom: 2px solid var(--primary);
      display: flex; align-items: center; justify-content: space-between; padding: 0 25px; box-shadow: 0 4px 15px rgba(0,0,0,0.3);
    }
    .brand { font-size: 1.6rem; font-weight: 900; letter-spacing: 1px; color: #fff; display: flex; align-items: center; gap: 10px; }
    .count-badge { background: var(--primary); padding: 4px 12px; border-radius: 20px; font-size: 1rem; }
    
    .actions { display: flex; gap: 15px; }
    .btn { cursor: pointer; border: none; padding: 12px 24px; border-radius: 8px; font-weight: bold; font-size: 1rem; transition: all 0.2s; display: flex; align-items: center; gap: 8px; }
    .btn:active { transform: scale(0.96); }
    .btn-all { background: var(--gold); color: #000; box-shadow: 0 0 15px rgba(245, 158, 11, 0.3); }
    .btn-all:hover { background: #d97706; }
    .btn-refresh { background: #334155; color: #fff; border: 1px solid #475569; }

    /* --- Ù…Ù†Ø·Ù‚Ø© Ø§Ù„Ø¹Ù…Ù„ (Ø§Ù„Ø´Ø¨ÙƒØ©) --- */
    .workspace { flex: 1; overflow-y: auto; padding: 25px; }
    .grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(320px, 1fr)); gap: 20px; padding-bottom: 50px; }
    
    .card { 
      background: var(--card); border: 1px solid #334155; border-radius: 12px; padding: 18px; 
      position: relative; cursor: pointer; transition: transform 0.2s, border-color 0.2s;
      border-right: 5px solid transparent; display: flex; flex-direction: column; gap: 8px;
    }
    .card:hover { transform: translateY(-4px); border-color: var(--primary); background: #263344; }
    .card.express { border-right-color: var(--danger); } /* ØªÙ…ÙŠÙŠØ² Ø§Ù„Ø´Ø­Ù† Ø§Ù„Ø³Ø±ÙŠØ¹ */
    
    .card-top { display: flex; justify-content: space-between; font-size: 0.9rem; color: #94a3b8; font-weight: bold; }
    .card-name { font-size: 1.3rem; font-weight: 800; color: #fff; }
    .card-info { font-size: 0.95rem; color: #cbd5e1; line-height: 1.5; }
    .card-content { background: #000; color: var(--gold); padding: 8px; border-radius: 6px; font-size: 0.85rem; margin-top: 5px; min-height: 40px; }
    .card-price { position: absolute; bottom: 18px; left: 18px; font-size: 1.4rem; font-weight: 900; color: #10b981; }

    /* --- Ù†Ø§ÙØ°Ø© Ø§Ù„ØªØ¹Ø¯ÙŠÙ„ (Modal) --- */
    .modal-overlay { 
      display: none; position: fixed; inset: 0; background: rgba(0,0,0,0.92); z-index: 1000; 
      justify-content: center; align-items: center; backdrop-filter: blur(8px);
    }
    .modal-box { 
      width: 950px; height: 650px; background: #fff; color: #000; border-radius: 16px; 
      display: flex; overflow: hidden; box-shadow: 0 20px 60px rgba(0,0,0,0.5);
    }
    .editor-panel { width: 35%; padding: 25px; background: #f8fafc; border-left: 1px solid #e2e8f0; display: flex; flex-direction: column; gap: 12px; overflow-y: auto; }
    .preview-panel { width: 65%; background: #e2e8f0; display: flex; justify-content: center; align-items: center; padding: 20px; flex-direction: column; }
    
    .field-group label { display: block; font-size: 0.8rem; font-weight: 700; margin-bottom: 4px; color: #475569; }
    .field-group input, .field-group textarea { width: 100%; padding: 10px; border: 2px solid #cbd5e1; border-radius: 8px; font-weight: 600; font-family: inherit; box-sizing: border-box; transition: 0.2s; }
    .field-group input:focus, .field-group textarea:focus { border-color: var(--primary); outline: none; }
    .field-group textarea { height: 70px; resize: none; }
    
    .btn-print-single { background: #000; color: #fff; width: 100%; padding: 16px; font-size: 1.2rem; margin-top: auto; border-radius: 8px; cursor: pointer; border: none; font-weight: bold; }
    .btn-print-single:hover { background: #333; }

    /* --- ØªØµÙ…ÙŠÙ… Ø§Ù„Ù…Ù„ØµÙ‚ 10x10 Ø³Ù… (Ù‚Ù„Ø¨ Ø§Ù„Ù†Ø¸Ø§Ù…) --- */
    .label-page { 
      width: 100mm; height: 100mm; background: #fff; color: #000; padding: 4mm; 
      box-sizing: border-box; border: 1px solid #ddd; display: flex; flex-direction: column; 
      position: relative; overflow: hidden; page-break-after: always; direction: rtl;
    }
    
    .lbl-head { display: flex; justify-content: space-between; align-items: flex-start; height: 22mm; border-bottom: 1px solid #000; padding-bottom: 2px; }
    .lbl-logo img { width: 32mm; }
    .lbl-meta { text-align: left; font-size: 9pt; font-weight: bold; line-height: 1.2; }
    
    .lbl-promo { background: #000; color: #fff; text-align: center; font-weight: 900; font-size: 11pt; padding: 3px; margin: 2mm 0; border-radius: 4px; }
    
    .lbl-info { font-size: 11pt; line-height: 1.3; font-weight: 500; }
    .lbl-info b { font-weight: 900; min-width: 60px; display: inline-block; }
    
    .lbl-content { 
      border: 2px dashed #000; background: #f1f5f9; padding: 5px; margin: 2mm 0; 
      font-size: 10pt; height: 16mm; overflow: hidden; font-weight: bold; line-height: 1.2;
    }
    
    .lbl-price { border: 3px solid #000; font-size: 22pt; font-weight: 900; text-align: center; padding: 0px; margin-bottom: 2mm; }
    
    .lbl-footer { display: flex; justify-content: space-between; align-items: flex-end; margin-top: auto; border-top: 1px solid #000; padding-top: 2mm; }
    .lbl-wa-text { font-size: 8pt; font-weight: 800; width: 65%; line-height: 1.2; }

    #printArea { display: none; }

    /* --- Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª Ø§Ù„Ø·Ø¨Ø§Ø¹Ø© --- */
    @media print {
      body * { visibility: hidden !important; }
      #printArea, #printArea * { visibility: visible !important; }
      #printArea { position: absolute; left: 0; top: 0; width: 100%; }
      @page { size: 100mm 100mm; margin: 0; }
      .label-page { border: none; box-shadow: none; } 
    }
  </style>
</head>
<body>

<div class="header">
  <div class="brand">
    ğŸ“¦ MAD SYSTEM
    <span class="count-badge" id="count">0</span>
  </div>
  <div class="actions">
    <button class="btn btn-refresh" onclick="loadData()">ØªØ­Ø¯ÙŠØ« (Refresh) â†»</button>
    <button class="btn btn-all" onclick="printAll()">ğŸ–¨ï¸ Ø·Ø¨Ø§Ø¹Ø© Ø§Ù„ÙƒÙ„ (Print All)</button>
  </div>
</div>

<div class="workspace">
  <div class="grid" id="grid"></div>
</div>

<div class="modal-overlay" id="editor">
  <div class="modal-box">
    <div class="editor-panel" dir="rtl">
      <div style="display:flex; justify-content:space-between; margin-bottom:10px">
        <h2 style="margin:0">ØªØ¹Ø¯ÙŠÙ„ ÙˆØ·Ø¨Ø§Ø¹Ø©</h2>
        <button onclick="closeModal()" style="background:none; border:none; font-size:1.5rem; cursor:pointer">âœ•</button>
      </div>
      
      <div class="field-group"><label>Ø§Ø³Ù… Ø§Ù„Ø¹Ù…ÙŠÙ„:</label><input id="in_name" oninput="updatePreview()"></div>
      <div class="field-group"><label>Ø±Ù‚Ù… Ø§Ù„Ù‡Ø§ØªÙ:</label><input id="in_phone" oninput="updatePreview()"></div>
      <div class="field-group"><label>Ø§Ù„Ø¹Ù†ÙˆØ§Ù†:</label><input id="in_city" oninput="updatePreview()"></div>
      <div class="field-group"><label>Ø´Ø±ÙƒØ© Ø§Ù„Ø´Ø­Ù†:</label><input id="in_del" oninput="updatePreview()"></div>
      <div class="field-group"><label>Ù…Ø­ØªÙˆÙ‰ Ø§Ù„Ø·Ø±Ø¯ (Ù‡Ø§Ù…):</label><textarea id="in_content" oninput="updatePreview()"></textarea></div>
      <div class="field-group"><label>Ø§Ù„Ø³Ø¹Ø± (â‚ª):</label><input id="in_price" type="number" style="font-size:1.2rem; color:#16a34a" oninput="updatePreview()"></div>
      
      <button class="btn-print-single" onclick="printSingle()">Ø·Ø¨Ø§Ø¹Ø© ÙˆØ¥Ù†Ù‡Ø§Ø¡ (Enter) ğŸ–¨ï¸</button>
    </div>
    
    <div class="preview-panel">
      <div id="livePreview" style="box-shadow: 0 10px 30px rgba(0,0,0,0.2);"></div>
      <div style="margin-top:10px; color:#666; font-size:0.9rem">Ù‡Ø°Ø§ Ù‡Ùˆ Ø´ÙƒÙ„ Ø§Ù„Ù…Ù„ØµÙ‚ Ø§Ù„Ù†Ù‡Ø§Ø¦ÙŠ (10x10)</div>
    </div>
  </div>
</div>

<div id="printArea"></div>

<script>
  // ================= Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª Ø§Ù„Ù†Ø¸Ø§Ù… =================
  const SCRIPT_URL = "https://script.google.com/macros/s/AKfycbyLjLFa8AaH82Ip7m747WC-KSUUEaU_M70S0I9Mda14XbnmcuEfZ7pBnF_zzJYZuXmZ/exec";
  const PASSWORD = "12345678";
  
  let orders = [];
  let currentIndex = null;
  
  // Ø§Ù„ØªØ´ØºÙŠÙ„ Ø§Ù„Ø£ÙˆÙ„ÙŠ
  (function init() {
    if(prompt("Password:") !== PASSWORD) {
      document.body.innerHTML = "<h1 style='color:white;text-align:center;margin-top:100px'>Access Denied ğŸš«</h1>";
      return;
    }
    loadData();
    setInterval(loadData, 30000); // ØªØ­Ø¯ÙŠØ« ØªÙ„Ù‚Ø§Ø¦ÙŠ ÙƒÙ„ 30 Ø«Ø§Ù†ÙŠØ©
  })();

  // 1. Ø¬Ù„Ø¨ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª
  async function loadData() {
    try {
      const res = await fetch(`${SCRIPT_URL}?action=get`);
      const all = await res.json();
      // ØªØµÙÙŠØ© Ø§Ù„Ø·Ù„Ø¨Ø§Øª (ÙÙ‚Ø· Prep/Approved ÙˆØºÙŠØ± Ø§Ù„Ø¬Ø§Ù‡Ø²Ø©)
      orders = all.filter(o => {
        const s = (o.status || "").toLowerCase();
        return (s.includes("prep") || s.includes("approved")) && !s.includes("ready");
      });
      render();
    } catch(e) { console.error("Error loading data"); }
  }

  // 2. Ø±Ø³Ù… Ø§Ù„Ø´Ø¨ÙƒØ©
  function render() {
    document.getElementById('count').innerText = orders.length;
    const grid = document.getElementById('grid');
    
    if(!orders.length) {
      grid.innerHTML = `<div style="grid-column:1/-1; text-align:center; padding:50px; color:#64748b; font-size:1.5rem">âœ… Ø§Ù„Ø¹Ù…Ù„ Ù†Ø¸ÙŠÙ! Ù„Ø§ ØªÙˆØ¬Ø¯ Ø·Ù„Ø¨Ø§Øª Ø¬Ø¯ÙŠØ¯Ø©.</div>`;
      return;
    }

    grid.innerHTML = orders.map((o, i) => {
      const isExpress = (o.delivery || "").toLowerCase().includes("high");
      return `
        <div class="card ${isExpress ? 'express' : ''}" onclick="openEditor(${i})">
          <div class="card-top">
            <span>#${o.orderId}</span>
            <span>${o.delivery || 'Standard'}</span>
          </div>
          <div class="card-name">${o.name}</div>
          <div class="card-info">
            ğŸ“ ${o.phone}<br>
            ğŸ“ ${o.city}<br>
          </div>
          <div class="card-content">ğŸ“¦ ${o.offer || '...'}</div>
          <div class="card-price">â‚ª${o.price}</div>
        </div>
      `;
    }).join("");
  }

  // 3. ØªØµÙ…ÙŠÙ… Ø§Ù„Ù…Ù„ØµÙ‚ (HTML Template)
  function createLabelHTML(data, idSuffix) {
    const date = new Date().toLocaleDateString('he-IL');
    return `
      <div class="label-page" dir="rtl">
        <div class="lbl-head">
          <div class="lbl-logo"><img src="https://www.madparfum.com/logo.svg"></div>
          <div class="lbl-meta">
            DATE: ${date}<br>
            ORD: ${data.orderId}
          </div>
        </div>
        
        <div class="lbl-promo">×¦×œ× ××ª ×”×¨×’×¢ ×•×§×‘×œ ××ª× ×” ğŸ</div>
        
        <div class="lbl-info">
          <div><b>×œ×›×‘×•×“:</b> ${data.name}</div>
          <div><b>×˜×œ×¤×•×Ÿ:</b> ${data.phone}</div>
          <div><b>×›×ª×•×‘×ª:</b> ${data.city}</div>
          <div><b>××©×œ×•×—:</b> ${data.delivery}</div>
        </div>

        <div class="lbl-content">
          <b>×ª×›×•×œ×” (Content):</b><br>
          ${(data.offer || "").replace(/\n/g, "<br>")}
        </div>

        <div class="lbl-price">â‚ª ${data.price}</div>

        <div class="lbl-footer">
          <div class="lbl-wa-text">
            WhatsApp Video = FREE GIFT<br>
            +972 54-963-4449
          </div>
          <div id="qr_${idSuffix}"></div>
        </div>
        <div style="position:absolute; bottom:2mm; width:92%; text-align:center">
           <svg id="bar_${idSuffix}"></svg>
        </div>
      </div>
    `;
  }

  // 4. Ø§Ù„Ù…Ø­Ø±Ø± ÙˆØ§Ù„Ù…Ø¹Ø§ÙŠÙ†Ø©
  function openEditor(idx) {
    currentIndex = idx;
    const o = orders[idx];
    
    document.getElementById('in_name').value = o.name;
    document.getElementById('in_phone').value = o.phone;
    document.getElementById('in_city').value = o.city + " " + (o.addr || "");
    document.getElementById('in_del').value = o.delivery || "High Express";
    document.getElementById('in_content').value = o.offer || "";
    document.getElementById('in_price').value = o.price;

    document.getElementById('editor').style.display = 'flex';
    updatePreview();

    // Ø§Ø®ØªØµØ§Ø± Enter
    document.onkeydown = function(e) {
      if(e.key === "Enter" && !e.shiftKey) {
        e.preventDefault();
        printSingle();
      }
      if(e.key === "Escape") closeModal();
    }
  }

  function closeModal() {
    document.getElementById('editor').style.display = 'none';
    document.onkeydown = null;
  }

  function updatePreview() {
    const data = getEditorData();
    document.getElementById('livePreview').innerHTML = createLabelHTML(data, 'prev');
    generateCodes(data.phone, 'prev');
  }

  function getEditorData() {
    return {
      orderId: orders[currentIndex].orderId,
      name: document.getElementById('in_name').value,
      phone: document.getElementById('in_phone').value,
      city: document.getElementById('in_city').value,
      delivery: document.getElementById('in_del').value,
      offer: document.getElementById('in_content').value,
      price: document.getElementById('in_price').value
    };
  }

  function generateCodes(phone, suffix) {
    setTimeout(() => {
      try {
        JsBarcode(`#bar_${suffix}`, phone || "0000", { format: "CODE128", height: 25, fontSize: 10, displayValue: false, margin:0 });
        const qrDiv = document.getElementById(`qr_${suffix}`);
        qrDiv.innerHTML = "";
        new QRCode(qrDiv, { text: "https://wa.me/972549634449", width: 45, height: 45 });
      } catch(e) {}
    }, 50);
  }

  // 5. Ø§Ù„Ø·Ø¨Ø§Ø¹Ø© Ø§Ù„ÙØ±Ø¯ÙŠØ©
  async function printSingle() {
    const data = getEditorData();
    const area = document.getElementById('printArea');
    area.innerHTML = createLabelHTML(data, 'print');
    generateCodes(data.phone, 'print');
    
    setTimeout(async () => {
      window.print();
      const row = orders[currentIndex].rowIndex;
      closeModal();
      
      // Ø¥Ø²Ø§Ù„Ø© ÙÙˆØ±ÙŠØ© Ù…Ù† Ø§Ù„Ø´Ø§Ø´Ø©
      orders.splice(currentIndex, 1);
      render();
      
      // ØªØ­Ø¯ÙŠØ« Ø§Ù„Ø³ÙŠØ±ÙØ±
      await fetch(`${SCRIPT_URL}?action=updateStatus&key=${PASSWORD}&row=${row}&status=READY âœ…`);
    }, 500);
  }

  // 6. Ø§Ù„Ø·Ø¨Ø§Ø¹Ø© Ø§Ù„Ø¬Ù…Ø§Ø¹ÙŠØ© (Bulk Print)
  function printAll() {
    if(!orders.length) return alert("Ù„Ø§ ØªÙˆØ¬Ø¯ Ø·Ù„Ø¨Ø§Øª!");
    if(!confirm(`Ù‡Ù„ ØªØ±ÙŠØ¯ Ø·Ø¨Ø§Ø¹Ø© ${orders.length} Ù…Ù„ØµÙ‚ Ø¯ÙØ¹Ø© ÙˆØ§Ø­Ø¯Ø©ØŸ`)) return;

    const area = document.getElementById('printArea');
    area.innerHTML = orders.map((o, i) => createLabelHTML(o, `bulk_${i}`)).join("");

    // ØªÙˆÙ„ÙŠØ¯ Ø§Ù„Ø£ÙƒÙˆØ§Ø¯ Ù„Ù„Ø¬Ù…ÙŠØ¹
    setTimeout(() => {
      orders.forEach((o, i) => generateCodes(o.phone, `bulk_${i}`));
      
      setTimeout(async () => {
        window.print();
        
        if(confirm("ØªÙ…Øª Ø§Ù„Ø·Ø¨Ø§Ø¹Ø©! Ù‡Ù„ Ø£Ù†Ù‚Ù„ Ø§Ù„ÙƒÙ„ Ø¥Ù„Ù‰ 'Ø¬Ø§Ù‡Ø²' ÙˆØ£Ù†Ø¸Ù Ø§Ù„Ø´Ø§Ø´Ø©ØŸ")) {
          // ØªØ­Ø¯ÙŠØ« Ø§Ù„Ø³ÙŠØ±ÙØ± Ù„ÙƒÙ„ Ø§Ù„Ø·Ù„Ø¨Ø§Øª
          orders.forEach(o => {
            fetch(`${SCRIPT_URL}?action=updateStatus&key=${PASSWORD}&row=${o.rowIndex}&status=READY âœ…`);
          });
          // ØªÙ†Ø¸ÙŠÙ Ø§Ù„Ø´Ø§Ø´Ø© ÙÙˆØ±Ø§Ù‹
          orders = [];
          render();
        }
      }, 1000); // Ø§Ù†ØªØ¸Ø§Ø± Ø«Ø§Ù†ÙŠ Ù„Ø¶Ù…Ø§Ù† ØªØ­Ù…ÙŠÙ„ Ø§Ù„ØµÙˆØ± ÙˆØ§Ù„Ø¨Ø§Ø±ÙƒÙˆØ¯
    }, 100);
  }

</script>
</body>
</html>
