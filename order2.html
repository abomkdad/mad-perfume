<!doctype html>
<html lang="he" dir="rtl">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width,initial-scale=1,maximum-scale=1,user-scalable=0"/>
  <title>MAD Prep | מדבקות 10x10</title>
  
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">

  <style>
    /* الإعدادات العامة للواجهة */
    :root { --bg: #f1f5f9; --card: #ffffff; --primary: #000; }
    body { margin: 0; font-family: 'Segoe UI', Arial; background: var(--bg); }
    .header { background: #000; color: #fff; padding: 15px; display: flex; justify-content: space-between; align-items: center; position: sticky; top: 0; z-index: 10;}
    .container { padding: 12px; max-width: 500px; margin: auto; }
    .prep-card { background: #fff; border-radius: 12px; padding: 15px; margin-bottom: 12px; border: 1px solid #ddd; }
    .item-list { background: #000; color: #fff; padding: 10px; border-radius: 8px; font-weight: 900; font-size: 20px; margin: 10px 0; text-align: center; }
    .btn { width: 100%; padding: 15px; border-radius: 10px; border: none; font-weight: bold; cursor: pointer; margin-bottom: 8px; font-size: 16px; display: flex; align-items: center; justify-content: center; gap: 10px; }
    .btn-print { background: #2563eb; color: #fff; }
    .btn-ready { background: #16a34a; color: #fff; }

    /* =========================================
       إعدادات الطباعة الإجبارية (10سم * 10سم)
       ========================================= */
    @media print {
      /* إخفاء كل شيء في الصفحة ما عدا منطقة الملصق */
      body * { visibility: hidden; }
      #printSection, #printSection * { visibility: visible; }
      
      @page {
        size: 100mm 100mm; /* حجم الورقة إجباري */
        margin: 0;        /* إلغاء الهوامش */
      }

      #printSection {
        position: fixed;
        left: 0; top: 0;
        width: 100mm;
        height: 100mm;
        padding: 5mm;
        box-sizing: border-box;
        background: #fff;
        color: #000;
        visibility: visible;
        display: flex !important;
        flex-direction: column;
        justify-content: space-between;
        border: none;
        page-break-after: avoid;
        page-break-before: avoid;
      }
      
      .no-print { display: none !important; }
    }

    /* شكل الملصق المجهز للطباعة (مخفي في الواجهة) */
    #printSection {
      display: none;
      direction: rtl;
      font-family: Arial, sans-serif;
    }
    .label-header { border-bottom: 3px solid #000; padding-bottom: 5px; text-align: center; }
    .label-body { flex-grow: 1; padding: 5mm 0; }
    .label-footer { border-top: 2px solid #000; padding-top: 3px; text-align: center; font-size: 12px; font-weight: bold; }
    .big-id { font-size: 32px; font-weight: 900; display: block; margin-bottom: 5px; }
    .delivery-badge { border: 2px solid #000; padding: 2px 8px; font-size: 18px; font-weight: 900; display: inline-block; }
  </style>
</head>
<body>

<div class="header">
  <div style="font-weight:900;">MAD <span style="color:#22c55e">PREP</span></div>
  <button onclick="load()" style="background:none; border:none; color:#fff;"><i class="fa fa-sync"></i></button>
</div>

<div class="container" id="ordersList">
  <div style="text-align:center; padding:50px;">טוען הזמנות...</div>
</div>

<div id="printSection">
  <div class="label-header">
    <div style="font-size: 26px; font-weight: 900;">MAD Parfumeur</div>
    <div id="p_delivery" class="delivery-badge"></div>
  </div>
  
  <div class="label-body">
    <span class="big-id">#<span id="p_id"></span></span>
    
    <div style="font-size: 18px; line-height: 1.4;">
      <strong>לקוח:</strong> <span id="p_name"></span><br>
      <strong>טלפון:</strong> <span id="p_phone"></span><br>
      <strong>כתובת:</strong> <span id="p_addr"></span>
    </div>

    <div style="margin-top: 10px; border: 2px solid #000; padding: 5px; background: #eee;">
      <strong>מוצרים:</strong><br>
      <div id="p_offer" style="font-size: 22px; font-weight: 900; word-wrap: break-word;"></div>
    </div>
  </div>

  <div style="text-align: center; font-size: 20px; font-weight: 900; margin-bottom: 5px;">
    לתשלום: <span id="p_price"></span> ₪ | <span id="p_payment"></span>
  </div>

  <div class="label-footer">
    MAD Parfumeur | www.mad-parfumeur.com | *9935
  </div>
</div>

<script>
const SCRIPT_URL = "https://script.google.com/macros/s/AKfycbyLjLFa8AaH82Ip7m747WC-KSUUEaU_M70S0I9Mda14XbnmcuEfZ7pBnF_zzJYZuXmZ/exec";
const DASH_KEY = "12345678";

async function load() {
  try {
    const res = await fetch(`${SCRIPT_URL}?action=get&_=${Date.now()}`);
    const data = await res.json();
    // إظهار فقط الطلبات المعتمدة (Approved)
    const filtered = data.filter(o => (o.status || "").includes('Approved'));
    render(filtered);
  } catch (e) { alert("שגיאת חיבור"); }
}

function render(orders) {
  const container = document.getElementById('ordersList');
  if(orders.length === 0) {
    container.innerHTML = `<div style="text-align:center; padding:40px; color:#64748b;">אין הזמנות חדשות להכנה ✅</div>`;
    return;
  }
  
  container.innerHTML = orders.map(o => `
    <div class="prep-card">
      <div style="display:flex; justify-content:space-between; align-items:center;">
        <span style="font-size:22px; font-weight:900;">#${o.orderId}</span>
        <span style="font-weight:bold; color:#2563eb;">${o.delivery || 'משלוח'}</span>
      </div>
      <div style="margin:10px 0;">
        <strong>${o.name}</strong> | ${o.phone}
      </div>
      <div class="item-list">${o.offer}</div>
      <button class="btn btn-print" onclick="printLabel(${o.rowIndex})"><i class="fa fa-print"></i> הדפס מדבקה 10x10</button>
      <button class="btn btn-ready" onclick="markReady(${o.rowIndex})"><i class="fa fa-check"></i> סיים הכנה</button>
    </div>
  `).join('');
}

function printLabel(rowIndex) {
  // جلب البيانات من مصفوفة الطلبات الأصلية المخزنة (أو طلبها من السيرفر)
  // للتبسيط سنقوم بالبحث في العناصر الظاهرة أو إعادة جلب البيانات
  fetch(`${SCRIPT_URL}?action=get`).then(r => r.json()).then(data => {
    const o = data.find(x => x.rowIndex == rowIndex);
    if(!o) return;

    document.getElementById('p_id').textContent = o.orderId;
    document.getElementById('p_name').textContent = o.name;
    document.getElementById('p_phone').textContent = o.phone;
    document.getElementById('p_addr').textContent = o.addr || o.city || "";
    document.getElementById('p_offer').textContent = o.offer;
    document.getElementById('p_price').textContent = o.price;
    document.getElementById('p_delivery').textContent = o.delivery || "משלוח";
    
    // تحويل الدفع للعبرية
    let pay = o.payment;
    if(pay === "نقداً" || pay === "Cash") pay = "מזומן";
    else if(pay === "مدفوع" || pay === "Paid") pay = "שולם";
    document.getElementById('p_payment').textContent = pay;

    window.print();
  });
}

async function markReady(row) {
  if(!confirm("האם סיימת לארוז? ההזמנה תעבור לסטטוס מוכן")) return;
  const url = `${SCRIPT_URL}?action=updateStatus&key=${DASH_KEY}&row=${row}&status=${encodeURIComponent("READY ✅ (מוכן / مجهز)")}`;
  await fetch(url);
  load();
}

window.onload = load;
</script>

</body>
</html>
