<!doctype html>
<html lang="he" dir="rtl">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width,initial-scale=1"/>
  <title>MAD Ops Center | ××¢×¨×›×ª ×ª×¤×¢×•×œ</title>
  
  <script src="https://cdn.jsdelivr.net/npm/jsbarcode@3.11.5/dist/JsBarcode.all.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/qrcodejs@1.0.0/qrcode.min.js"></script>

  <style>
    :root { 
      --bg: #111827; 
      --card-bg: #1f2937; 
      --text: #f9fafb;
      --accent: #3b82f6; 
      --express: #ef4444; /* Ù„ÙˆÙ† Ù„Ù„Ø´Ø­Ù† Ø§Ù„Ø³Ø±ÙŠØ¹ */
      --success: #10b981;
    }

    body { margin: 0; font-family: system-ui, -apple-system, sans-serif; background: var(--bg); color: var(--text); height: 100vh; overflow: hidden; display: flex; flex-direction: column; }
    
    /* Header - Ø´Ø±ÙŠØ· Ø¹Ù„ÙˆÙŠ Ø«Ø§Ø¨Øª */
    .header { 
      height: 60px; background: #000; border-bottom: 2px solid var(--accent); 
      display: flex; align-items: center; justify-content: space-between; padding: 0 20px;
    }
    .stats { display: flex; gap: 20px; font-weight: bold; font-size: 1.1rem; }
    .stat-box { background: #333; padding: 5px 15px; border-radius: 5px; }
    .refresh-timer { width: 50px; height: 4px; background: var(--accent); position: absolute; bottom: 0; left: 0; transition: width 1s linear; }

    /* Main Grid - Ø´Ø¨ÙƒØ© Ø§Ù„Ø·Ù„Ø¨Ø§Øª */
    .grid-container { 
      flex: 1; overflow-y: auto; padding: 20px; 
      display: grid; grid-template-columns: repeat(auto-fill, minmax(280px, 1fr)); 
      grid-auto-rows: max-content; gap: 15px;
    }

    /* Order Card - Ø¨Ø·Ø§Ù‚Ø© Ø§Ù„Ø·Ù„×‘ */
    .card { 
      background: var(--card-bg); border-radius: 8px; padding: 15px; 
      border-left: 5px solid #555; cursor: pointer; transition: transform 0.1s; position: relative;
    }
    .card:hover { transform: translateY(-2px); background: #374151; }
    .card.express { border-left-color: var(--express); } /* ØªÙ…ÙŠÙŠØ² Ø§Ù„Ø´Ø­Ù† Ø§Ù„Ø³Ø±ÙŠØ¹ */
    
    .card-top { display: flex; justify-content: space-between; margin-bottom: 8px; font-size: 0.9rem; opacity: 0.8; }
    .card-name { font-size: 1.2rem; font-weight: 800; margin-bottom: 5px; }
    .card-info { font-size: 0.95rem; line-height: 1.4; color: #d1d5db; }
    .card-price { position: absolute; bottom: 15px; left: 15px; font-weight: bold; color: var(--success); font-size: 1.1rem; }

    /* Modal - Ù†Ø§ÙØ°Ø© Ø§Ù„Ø¹Ù…Ù„ÙŠØ§Øª */
    .modal-overlay { 
      display: none; position: fixed; inset: 0; background: rgba(0,0,0,0.9); z-index: 999; 
      align-items: center; justify-content: center; backdrop-filter: blur(5px);
    }
    .workspace { 
      width: 95%; max-width: 1100px; height: 85vh; background: #fff; color: #000; 
      border-radius: 10px; display: flex; overflow: hidden;
    }
    
    /* Left Side: Controls */
    .controls-panel { width: 40%; background: #f3f4f6; padding: 20px; display: flex; flex-direction: column; gap: 15px; border-left: 1px solid #ddd; overflow-y: auto; }
    .controls-panel label { font-weight: bold; font-size: 0.9rem; margin-bottom: 4px; display: block; }
    .controls-panel input, .controls-panel textarea { width: 100%; padding: 10px; border: 1px solid #ccc; border-radius: 6px; font-size: 1rem; box-sizing: border-box; }
    .controls-panel textarea { height: 100px; resize: none; }
    
    .action-btn { 
      padding: 15px; border: none; border-radius: 8px; font-size: 1.2rem; font-weight: bold; cursor: pointer; color: white; width: 100%; margin-top: 10px; 
      display: flex; align-items: center; justify-content: center; gap: 10px;
    }
    .btn-print { background: #000; }
    .btn-print:hover { background: #333; }

    /* Right Side: Live Preview */
    .preview-panel { width: 60%; background: #e5e7eb; display: flex; align-items: center; justify-content: center; padding: 20px; }
    
    /* 100x100 Label CSS */
    .label-canvas { 
      width: 100mm; height: 100mm; background: #fff; padding: 4mm; box-sizing: border-box; 
      border: 1px solid #ccc; box-shadow: 0 10px 30px rgba(0,0,0,0.2);
      display: flex; flex-direction: column; position: relative;
    }
    .l-header { display: flex; justify-content: space-between; align-items: flex-start; margin-bottom: 2mm; }
    .l-brand img { width: 35mm; }
    .l-meta { font-size: 9pt; font-weight: bold; text-align: left; }
    .l-promo { background: #000; color: #fff; text-align: center; font-weight: bold; padding: 3px; font-size: 10pt; margin-bottom: 2mm; }
    .l-body { font-size: 11pt; line-height: 1.3; flex-grow: 1; }
    .l-content { border: 1px dashed #000; background: #f9fafb; padding: 4px; font-size: 9pt; margin: 2mm 0; min-height: 15mm; }
    .l-pay { border: 2px solid #000; font-size: 18pt; font-weight: 900; text-align: center; padding: 4px; margin-bottom: 2mm; }
    .l-footer { display: flex; justify-content: space-between; align-items: flex-end; margin-top: auto; border-top: 1px solid #000; padding-top: 2mm; }
    
    @media print {
      body * { visibility: hidden !important; }
      #printArea, #printArea * { visibility: visible !important; }
      #printArea { position: fixed; top: 0; left: 0; width: 100mm; height: 100mm; display: block !important; }
      @page { size: 100mm 100mm; margin: 0; }
    }
  </style>
</head>
<body>

<div class="header">
  <div style="display:flex; align-items:center; gap:15px">
    <h2 style="margin:0; color:#fff">MAD OPS âš¡</h2>
    <input id="q" placeholder="×—×™×¤×•×© ××”×™×¨ (Search)..." style="padding:8px; border-radius:5px; border:none" oninput="render()">
  </div>
  <div class="stats">
    <div class="stat-box" style="color:var(--express)">Express: <span id="count-ex">0</span></div>
    <div class="stat-box">Total: <span id="count-all">0</span></div>
    <button onclick="forceRefresh()" style="background:#444; color:#fff; border:none; padding:5px 10px; cursor:pointer; border-radius:5px">â†»</button>
  </div>
  <div class="refresh-timer" id="timerBar"></div>
</div>

<div class="grid-container" id="grid"></div>

<div class="modal-overlay" id="modal">
  <div class="workspace">
    <div class="controls-panel" dir="rtl">
      <div style="display:flex; justify-content:space-between; align-items:center">
        <h2>×¢×¨×™×›×” ×•×”×“×¤×¡×”</h2>
        <button onclick="closeModal()" style="background:transparent; border:none; font-size:1.5rem; cursor:pointer">âœ•</button>
      </div>

      <div>
        <label>×œ×§×•×— (Name):</label>
        <input id="in_name" oninput="updatePreview()">
      </div>
      <div>
        <label>×˜×œ×¤×•×Ÿ (Phone):</label>
        <input id="in_phone" oninput="updatePreview()">
      </div>
      <div style="display:flex; gap:10px">
         <div style="flex:1">
           <label>×¢×™×¨ (City):</label>
           <input id="in_city" oninput="updatePreview()">
         </div>
         <div style="flex:1">
           <label>××©×œ×•×— (Delivery):</label>
           <input id="in_del" oninput="updatePreview()">
         </div>
      </div>
      <div>
        <label>×ª×›×•×œ×” (Package Content):</label>
        <textarea id="in_content" oninput="updatePreview()"></textarea>
      </div>
      <div>
        <label>×¡×›×•× (Price â‚ª):</label>
        <input id="in_price" type="number" style="font-size:1.5rem; font-weight:bold; color:green" oninput="updatePreview()">
      </div>

      <div style="margin-top:auto">
        <button class="action-btn btn-print" onclick="printAndFinish()">
          <span>×”×“×¤×¡ ×•×¡×™×™× (ENTER)</span> ğŸ–¨ï¸
        </button>
        <div style="text-align:center; margin-top:5px; font-size:0.8rem; color:#666">
          Ø³ÙŠØªÙ… Ù†Ù‚Ù„ Ø§Ù„Ø·Ù„Ø¨ ØªÙ„Ù‚Ø§Ø¦ÙŠØ§Ù‹ Ø¥Ù„Ù‰ "Ø¬Ø§Ù‡Ø²" Ø¨Ø¹Ø¯ Ø§Ù„Ø·Ø¨Ø§Ø¹Ø©
        </div>
      </div>
    </div>

    <div class="preview-panel">
      <div id="liveLabel" class="label-canvas" dir="rtl">
        </div>
    </div>
  </div>
</div>

<div id="printArea"></div>

<script>
  const SCRIPT_URL = "https://script.google.com/macros/s/AKfycbyLjLFa8AaH82Ip7m747WC-KSUUEaU_M70S0I9Mda14XbnmcuEfZ7pBnF_zzJYZuXmZ/exec";
  const DASH_KEY = "12345678";
  
  let allOrders = [];
  let currentOrder = null;
  let isModalOpen = false;
  let timerWidth = 0;

  // Ø§Ù„Ù…ØµØ§Ø¯Ù‚Ø© Ø§Ù„Ø¨Ø³ÙŠØ·Ø©
  if(prompt("Password:") !== DASH_KEY) document.body.innerHTML="Access Denied";
  else init();

  function init() {
    loadData();
    // ØªØ­Ø¯ÙŠØ« ØªÙ„Ù‚Ø§Ø¦ÙŠ ÙƒÙ„ 15 Ø«Ø§Ù†ÙŠØ©
    setInterval(() => {
      if(!isModalOpen) loadData(); // Ù„Ø§ ØªØ­Ø¯Ø« Ø¥Ø°Ø§ ÙƒØ§Ù† Ø§Ù„Ù…ÙˆØ¸Ù ÙŠØ¹Ù…Ù„ Ø¹Ù„Ù‰ Ø·Ù„Ø¨
    }, 15000);
    
    // Ø´Ø±ÙŠØ· Ø§Ù„Ù…Ø¤Ù‚Øª
    setInterval(() => {
      if(isModalOpen) return;
      timerWidth += 1; // ØªÙ‚Ø±ÙŠØ¨ÙŠ
      if(timerWidth > 100) timerWidth = 0;
      document.getElementById('timerBar').style.width = timerWidth + "%";
    }, 150);

    // Ø§Ø®ØªØµØ§Ø±Ø§Øª Ø§Ù„ÙƒÙŠØ¨ÙˆØ±Ø¯
    document.addEventListener('keydown', (e) => {
      if(!isModalOpen) return;
      if(e.key === "Enter" && !e.shiftKey) {
         e.preventDefault(); // Ù…Ù†Ø¹ Ù†Ø²ÙˆÙ„ Ø³Ø·Ø± ÙÙŠ Ø§Ù„Ù€ textarea
         printAndFinish();
      }
      if(e.key === "Escape") closeModal();
    });
  }

  async function loadData() {
    try {
      timerWidth = 0;
      const res = await fetch(`${SCRIPT_URL}?action=get`);
      const data = await res.json();
      // ÙÙ„ØªØ±Ø©: ÙÙ‚Ø· (Prep/Approved) ÙˆÙ„ÙŠØ³ (Ready)
      allOrders = data.filter(o => {
        const s = (o.status || "").toLowerCase();
        return (s.includes("prep") || s.includes("approved")) && !s.includes("ready");
      });
      render();
    } catch(e) { console.log("Sync error"); }
  }

  function forceRefresh() {
    document.getElementById('grid').innerHTML = '<div style="color:white; padding:20px">Updating...</div>';
    loadData();
  }

  function render() {
    const q = document.getElementById('q').value.toLowerCase();
    const grid = document.getElementById('grid');
    
    // Ø¥Ø­ØµØ§Ø¦ÙŠØ§Øª
    document.getElementById('count-all').innerText = allOrders.length;
    document.getElementById('count-ex').innerText = allOrders.filter(o => (o.delivery||"").toLowerCase().includes("high")).length;

    const filtered = allOrders.filter(o => 
      !q || (o.name+o.phone+o.orderId).toLowerCase().includes(q)
    );

    grid.innerHTML = filtered.map(o => {
      const isExpress = (o.delivery || "").toLowerCase().includes("high");
      return `
      <div class="card ${isExpress ? 'express' : ''}" onclick="openModal(${o.rowIndex})">
        <div class="card-top">
          <span>#${o.orderId}</span>
          <span>${o.city}</span>
        </div>
        <div class="card-name">${o.name}</div>
        <div class="card-info">
          <div>ğŸ“ ${o.phone}</div>
          <div style="color:${isExpress ? '#f87171' : '#9ca3af'}">ğŸšš ${o.delivery || 'Standard'}</div>
        </div>
        <div class="card-price">â‚ª${o.price}</div>
      </div>
      `;
    }).join("");
  }

  // --- Ù…Ù†Ø·Ù‚ Ø§Ù„Ù†Ø§ÙØ°Ø© Ø§Ù„Ù…Ù†Ø¨Ø«Ù‚Ø© (Modal) ---

  function openModal(rowIndex) {
    currentOrder = allOrders.find(x => x.rowIndex == rowIndex);
    if(!currentOrder) return;

    // ØªØ¹Ø¨Ø¦Ø© Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª
    document.getElementById('in_name').value = currentOrder.name;
    document.getElementById('in_phone').value = currentOrder.phone;
    document.getElementById('in_city').value = currentOrder.city + " " + (currentOrder.addr || "");
    document.getElementById('in_del').value = currentOrder.delivery || "High Express";
    document.getElementById('in_price').value = currentOrder.price;
    document.getElementById('in_content').value = currentOrder.offer || "";

    isModalOpen = true;
    document.getElementById('modal').style.display = "flex";
    updatePreview();
    
    // Ø§Ù„ØªØ±ÙƒÙŠØ² Ø¹Ù„Ù‰ Ø²Ø± Ø§Ù„Ø·Ø¨Ø§Ø¹Ø© Ù…Ø¨Ø§Ø´Ø±Ø© Ù„Ù„Ø³Ø±Ø¹Ø©
    setTimeout(() => document.querySelector('.btn-print').focus(), 100);
  }

  function closeModal() {
    isModalOpen = false;
    document.getElementById('modal').style.display = "none";
    currentOrder = null;
  }

  function updatePreview() {
    const data = {
      name: document.getElementById('in_name').value,
      phone: document.getElementById('in_phone').value,
      city: document.getElementById('in_city').value,
      delivery: document.getElementById('in_del').value,
      price: document.getElementById('in_price').value,
      content: document.getElementById('in_content').value,
      orderId: currentOrder.orderId
    };

    const date = new Date().toLocaleDateString('he-IL');
    const labelHtml = `
      <div class="l-header">
        <img src="https://www.madparfum.com/logo.svg">
        <div class="l-meta">
          DATE: ${date}<br>
          ORD: ${data.orderId}
        </div>
      </div>
      
      <div class="l-promo">×¦×œ× ××ª ×”×¨×’×¢ ×•×§×‘×œ ××ª× ×” ğŸ</div>
      
      <div class="l-body">
        <div><b>×œ×›×‘×•×“:</b> ${data.name}</div>
        <div><b>×˜×œ×¤×•×Ÿ:</b> ${data.phone}</div>
        <div><b>×›×ª×•×‘×ª:</b> ${data.city}</div>
        <div><b>××©×œ×•×—:</b> ${data.delivery}</div>
      </div>

      <div class="l-content">
        <b>×ª×›×•×œ×” (Content):</b><br>
        ${data.content.replace(/\n/g, "<br>")}
      </div>

      <div class="l-pay">â‚ª ${data.price}</div>

      <div class="l-footer">
        <div style="font-size:8pt; font-weight:bold; width:65%">
          WhatsApp Video = FREE GIFT<br>
          +972 54-963-4449
        </div>
        <div id="qr_target"></div>
      </div>
      <div style="text-align:center; margin-top:2mm">
         <svg id="bar_target"></svg>
      </div>
    `;

    document.getElementById('liveLabel').innerHTML = labelHtml;

    // Render codes
    try {
      JsBarcode("#bar_target", data.phone || "0000", { format: "CODE128", height: 25, fontSize: 10, displayValue: false });
      document.getElementById("qr_target").innerHTML = "";
      new QRCode(document.getElementById("qr_target"), { text: "https://wa.me/972549634449", width: 45, height: 45 });
    } catch(e) {}
  }

  async function printAndFinish() {
    if(!currentOrder) return;
    
    // 1. ÙˆØ¶Ø¹ Ø§Ù„Ù…Ù„ØµÙ‚ ÙÙŠ Ù…Ù†Ø·Ù‚Ø© Ø§Ù„Ø·Ø¨Ø§Ø¹Ø©
    const labelContent = document.getElementById('liveLabel').innerHTML;
    const printArea = document.getElementById('printArea');
    printArea.innerHTML = `<div class="label-canvas" dir="rtl" style="border:none; box-shadow:none">${labelContent}</div>`;
    
    // 2. Ø£Ù…Ø± Ø§Ù„Ø·Ø¨Ø§Ø¹Ø©
    window.print();

    // 3. Ø¥ØºÙ„Ø§Ù‚ Ø§Ù„Ù†Ø§ÙØ°Ø© ÙˆØªØ­Ø¯ÙŠØ« Ø§Ù„Ø­Ø§Ù„Ø© ÙÙŠ Ø§Ù„Ø®Ù„ÙÙŠØ©
    const rowToRemove = currentOrder.rowIndex;
    closeModal();
    
    // Ø¥Ø²Ø§Ù„Ø© ÙˆÙ‡Ù…ÙŠØ© Ù…Ù† Ø§Ù„Ø´Ø§Ø´Ø© ÙÙˆØ±Ø§Ù‹ (Ù„Ø¹Ø¯Ù… Ø§Ù†ØªØ¸Ø§Ø± Ø§Ù„Ø³ÙŠØ±ÙØ±)
    allOrders = allOrders.filter(o => o.rowIndex !== rowToRemove);
    render();

    // 4. Ø¥Ø±Ø³Ø§Ù„ Ø§Ù„ØªØ­Ø¯ÙŠØ« Ù„Ù„Ø³ÙŠØ±ÙØ±
    await fetch(`${SCRIPT_URL}?action=updateStatus&key=${DASH_KEY}&row=${rowToRemove}&status=READY âœ…`);
    
    // ØªØ­Ø¯ÙŠØ« Ø­Ù‚ÙŠÙ‚ÙŠ
    loadData();
  }
</script>
</body>
</html>
