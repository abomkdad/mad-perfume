/**
 * MAD System Backend - V30 ✅ (Prep + Confirm + Edit)
 * Actions:
 *  - GET  ?action=get
 *  - GET  ?action=updateOrder&key=12345678&row=5&...
 *  - GET  ?action=updateStatus&key=12345678&row=5&status=...
 *  - GET  ?action=sendCustomerConfirm&key=12345678&row=5
 */

const SPREADSHEET_ID = "1Ht_W4sPbV_K8UMWa69_ZjtVQQT305JAvlUVBCfoq4Qg";
const SHEET_TAB_NAME = "Sheet1";

const DASH_KEY = "12345678";
const DELIVERY_DAYS = "3";

// ⚠️ مؤقتاً حسب طلبك — غيّره بعد التشغيل
const WABA_API_KEY = "nSXZrRGBZswsmAn5jOStM2lHAK";

function doGet(e){
  const p = (e && e.parameter) ? e.parameter : {};
  const action = String(p.action || "");

  if(action === "get") return handleGet_();
  if(action === "updateOrder") return handleUpdateOrder_(p);
  if(action === "updateStatus") return handleUpdateStatus_(p);
  if(action === "sendCustomerConfirm") return handleSendCustomerConfirm_(p);

  return ContentService.createTextOutput("MAD Backend V30 Online ✅").setMimeType(ContentService.MimeType.TEXT);
}

/* ================= GET: get ================= */
function handleGet_(){
  try{
    const sh = openSheet_();
    const data = sh.getDataRange().getValues();

    const out = [];
    for(let i=1;i<data.length;i++){
      const name = data[i][3];
      if(!name) continue;

      const offer = String(data[i][2]||"");
      const notes = String(data[i][6]||"");
      const status = String(data[i][7]||"");

      out.push({
        rowIndex: i+1,
        date: data[i][0],
        orderId: data[i][1],
        offer,
        name,
        phone: data[i][4],
        city: data[i][5],
        notes,
        status,
        source: data[i][8] || "",
        price: extractPrice_(offer, notes),
        payment: extractField_(notes, "Pay"),
        proc: extractField_(notes, "Proc"),
        addr: extractField_(notes, "Addr"),
        delivery: extractField_(notes, "Del")
      });
    }
    return json_(out);
  }catch(err){
    return json_({error:String(err)});
  }
}

/* ================= GET: updateStatus ================= */
function handleUpdateStatus_(p){
  if(String(p.key||"") !== DASH_KEY) return json_({result:"ERROR", message:"Bad key"});
  const row = parseInt(String(p.row||""),10);
  const status = String(p.status||"").trim();
  if(!row || row<2 || !status) return json_({result:"ERROR", message:"Missing row/status"});

  const lock = LockService.getScriptLock();
  if(!lock.tryLock(10000)) return json_({result:"ERROR", message:"Lock busy"});
  try{
    const sh = openSheet_();
    sh.getRange(row,8).setValue(status); // H

    // لو الحالة تدل "ارسال للتجهيز" نضيف FLAG:PREP_SENT بالنوتس
    if(/sent to prep|approved|تم ارسال للتجهيز|prep/i.test(status)){
      addFlagToNotes_(sh, row, "FLAG:PREP_SENT");
    }

    SpreadsheetApp.flush();
    return json_({result:"SUCCESS", message:"Updated"});
  }catch(err){
    return json_({result:"ERROR", message:String(err)});
  }finally{
    try{ lock.releaseLock(); }catch(e){}
  }
}

/* ================= GET: updateOrder ================= */
function handleUpdateOrder_(p){
  if(String(p.key||"") !== DASH_KEY) return json_({result:"ERROR", message:"Bad key"});
  const row = parseInt(String(p.row||""),10);
  if(!row || row<2) return json_({result:"ERROR", message:"Invalid row"});

  const lock = LockService.getScriptLock();
  if(!lock.tryLock(10000)) return json_({result:"ERROR", message:"Lock busy"});
  try{
    const sh = openSheet_();

    const name = safe_(p.name);
    const phone = normalizePhone_(p.phone);
    const city  = safe_(p.city);
    const addr  = safe_(p.addr);
    const offer = safe_(p.offer);

    const price = safe_(p.price);
    const pay   = safe_(p.payment);
    const proc  = safe_(p.proc);
    const del   = safe_(p.delivery);

    const extraNotes = safe_(p.extraNotes);

    const offerWithPrice = appendPriceToOffer_(offer, price);
    const notes = buildNotes_(price, pay, proc, addr, del, extraNotes);

    if(name) sh.getRange(row,4).setValue(name);
    if(offerWithPrice) sh.getRange(row,3).setValue(offerWithPrice);
    if(phone) sh.getRange(row,5).setValue(phone);
    sh.getRange(row,6).setValue(city || "-");
    sh.getRange(row,7).setValue(notes);

    SpreadsheetApp.flush();
    return json_({result:"SUCCESS", message:"Order updated"});
  }catch(err){
    return json_({result:"ERROR", message:String(err)});
  }finally{
    try{ lock.releaseLock(); }catch(e){}
  }
}

/* ================= GET: sendCustomerConfirm ================= */
function handleSendCustomerConfirm_(p){
  if(String(p.key||"") !== DASH_KEY) return json_({result:"ERROR", message:"Bad key"});
  const row = parseInt(String(p.row||""),10);
  if(!row || row<2) return json_({result:"ERROR", message:"Invalid row"});

  const lock = LockService.getScriptLock();
  if(!lock.tryLock(10000)) return json_({result:"ERROR", message:"Lock busy"});
  try{
    const sh = openSheet_();
    const r = sh.getRange(row,1,1,8).getValues()[0];

    const orderId = String(r[1]||"");
    const offer   = String(r[2]||"");
    const name    = String(r[3]||"Customer");
    const phone   = normalizePhone_(r[4]||"");
    const city    = String(r[5]||"-");
    const notes   = String(r[6]||"");
    const status  = String(r[7]||"");

    if(!phone) return json_({result:"ERROR", message:"No customer phone"});

    const price = extractPrice_(offer, notes) || "150";
    const pay   = extractField_(notes, "Pay") || "Cash";
    const proc  = extractField_(notes, "Proc") || "Direct";
    const addr  = extractField_(notes, "Addr") || city;

    const lang = detectLang_(name, offer, notes); // he/ar
    const tpl = (lang === "he") ? "order_confirmation_he" : "arabic_v3";

    const paymentWithPrice = `${pay} (${price} ₪)`;
    const params = [name, offer, paymentWithPrice, addr, proc, DELIVERY_DAYS];

    const res = sendTemplate_(phone, lang, tpl, params);
    if(!res.success) return json_({result:"ERROR", message:res.error});

    addFlagToNotes_(sh, row, "FLAG:CUST_SENT");

    // (اختياري) نضيف كمان عبارة لطيفة بالنوتس
    addFlagToNotes_(sh, row, "تم ارسال للعميل");

    SpreadsheetApp.flush();
    return json_({result:"SUCCESS", message:"Customer confirmed"});
  }catch(err){
    return json_({result:"ERROR", message:String(err)});
  }finally{
    try{ lock.releaseLock(); }catch(e){}
  }
}

/* ================= Helpers ================= */
function openSheet_(){
  const ss = SpreadsheetApp.openById(SPREADSHEET_ID);
  const sh = ss.getSheetByName(SHEET_TAB_NAME);
  if(!sh) throw new Error("Sheet not found: "+SHEET_TAB_NAME);
  return sh;
}
function json_(o){
  return ContentService.createTextOutput(JSON.stringify(o)).setMimeType(ContentService.MimeType.JSON);
}
function safe_(v){
  try{ return decodeURIComponent(String(v||"").replace(/\+/g," ")).trim(); }
  catch(e){ return String(v||"").trim(); }
}
function normalizePhone_(p){
  if(!p) return "";
  let d = String(p).replace(/[^\d]/g,"");
  if(d.startsWith("00")) d = d.slice(2);
  if(d.startsWith("9720")) d = "972" + d.slice(4);

  if(d.startsWith("0")){
    if(d.startsWith("059") && d.length>=10) d = "970" + d.slice(1);
    else if(d.startsWith("05") && d.length>=10) d = "972" + d.slice(1);
    else if(d.length>=9) d = "972" + d.slice(1);
  }
  if(d.length===9 && d.startsWith("5")) d = "972"+d;
  if(d.length===9 && d.startsWith("59")) d = "970"+d;
  return d;
}
function extractField_(notes, key){
  const s = String(notes||"");
  const m = s.match(new RegExp(key + "\\s*:\\s*([^|]+)", "i"));
  return m ? String(m[1]).trim() : "";
}
function extractPrice_(offer, notes){
  const s = (String(offer||"") + " " + String(notes||"")).replace(/[,]/g," ");
  const m1 = s.match(/₪\s*(\d{2,5})/);
  if(m1) return m1[1];
  const m2 = s.match(/Price\s*:\s*(\d{2,5})/i);
  if(m2) return m2[1];
  const m3 = s.match(/\b(\d{2,5})\b/);
  return m3 ? m3[1] : "";
}
function appendPriceToOffer_(offer, price){
  const o = String(offer||"").trim();
  const p = String(price||"").trim();
  if(!o) return "";
  if(!p) return o;
  if(o.includes("₪")) return o;
  return `${o} — ₪${p}`;
}
function buildNotes_(price, pay, proc, addr, del, extra){
  const parts = [];
  if(price) parts.push(`Price: ${price} ₪`);
  if(pay) parts.push(`Pay: ${pay}`);
  if(proc) parts.push(`Proc: ${proc}`);
  if(addr) parts.push(`Addr: ${addr}`);
  if(del)  parts.push(`Del: ${del}`);
  let base = parts.join(" | ");
  if(extra) base = base ? (base + " | " + extra) : extra;
  return base;
}
function addFlagToNotes_(sh, row, flagText){
  const cell = sh.getRange(row,7); // G
  const prev = String(cell.getValue()||"");
  const f = String(flagText||"").trim();
  if(!f) return;
  if(prev.includes(f)) return;
  cell.setValue(prev ? (prev + " | " + f) : f);
}
function detectLang_(name, offer, notes){
  const s = String(name||"") + " " + String(offer||"") + " " + String(notes||"");
  if(/[\u0590-\u05FF]/.test(s)) return "he";
  return "ar";
}

/* ========== WhatsApp send template ========== */
function sendTemplate_(to, lang, tpl, params){
  try{
    if(!WABA_API_KEY) return {success:false, error:"No API key"};
    const res = UrlFetchApp.fetch("https://waba-v2.360dialog.io/messages", {
      method:"post",
      headers:{ "D360-API-KEY": WABA_API_KEY, "Content-Type":"application/json" },
      payload: JSON.stringify({
        messaging_product:"whatsapp",
        to:String(to),
        type:"template",
        template:{
          name: tpl,
          language:{ code: lang },
          components:[{ type:"body", parameters: params.map(x=>({type:"text", text:String(x)})) }]
        }
      }),
      muteHttpExceptions:true
    });
    const code = res.getResponseCode();
    return {success: code>=200 && code<300, error: res.getContentText()};
  }catch(e){
    return {success:false, error:String(e)};
  }
}
