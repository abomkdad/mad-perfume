<!doctype html>
<html lang="he" dir="rtl">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width,initial-scale=1"/>
  <title>MAD MASTER SYSTEM</title>
  
  <script src="https://cdn.jsdelivr.net/npm/jsbarcode@3.11.5/dist/JsBarcode.all.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/qrcodejs@1.0.0/qrcode.min.js"></script>
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">

  <style>
    :root { 
      --bg: #1e1e2e; --surface: #2b2b3b; --primary: #7289da; 
      --success: #43b581; --danger: #f04747; --warning: #faa61a; --text: #fff;
    }

    body { margin: 0; font-family: 'Segoe UI', Tahoma, sans-serif; background: var(--bg); color: var(--text); height: 100vh; display: flex; flex-direction: column; overflow: hidden; }

    /* --- Ø§Ù„Ø´Ø±ÙŠØ· Ø§Ù„Ø¹Ù„ÙˆÙŠ --- */
    .top-bar { 
      background: rgba(0,0,0,0.3); padding: 15px 25px; border-bottom: 2px solid var(--primary);
      display: flex; justify-content: space-between; align-items: center;
    }
    .tabs { display: flex; gap: 10px; background: #181825; padding: 5px; border-radius: 8px; }
    .tab { padding: 8px 20px; cursor: pointer; border-radius: 6px; font-weight: bold; color: #aaa; transition: 0.3s; }
    .tab.active { background: var(--primary); color: #fff; }
    
    .search-box { background: #181825; border: 1px solid #444; color: #fff; padding: 10px; border-radius: 6px; width: 300px; }

    /* --- Ù…Ù†Ø·Ù‚Ø© Ø§Ù„Ø¹Ù…Ù„ --- */
    .workspace { flex: 1; padding: 20px; overflow-y: auto; }
    .grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(320px, 1fr)); gap: 20px; }

    /* --- Ø¨Ø·Ø§Ù‚Ø© Ø§Ù„Ø·Ù„Ø¨ --- */
    .card { 
      background: var(--surface); border-radius: 12px; padding: 15px; border: 1px solid #3a3a4a; 
      position: relative; transition: 0.2s; cursor: pointer; border-right: 5px solid transparent;
    }
    .card:hover { transform: translateY(-3px); background: #323242; }
    .card.status-prep { border-right-color: var(--warning); } /* Ù‚ÙŠØ¯ Ø§Ù„ØªØ¬Ù‡ÙŠØ² */
    .card.status-ready { border-right-color: var(--success); opacity: 0.7; } /* Ø¬Ø§Ù‡Ø² */
    .card.status-cancel { border-right-color: var(--danger); opacity: 0.5; } /* Ù…Ù„ØºÙŠ */

    .card-badges { display: flex; gap: 5px; margin-bottom: 10px; }
    .badge { padding: 3px 8px; border-radius: 4px; font-size: 0.75rem; font-weight: bold; }
    .badge-rush { background: var(--danger); color: white; }
    .badge-exchange { background: var(--warning); color: black; }

    .card-title { font-size: 1.2rem; font-weight: 800; margin-bottom: 5px; }
    .card-info { font-size: 0.9rem; color: #bbb; line-height: 1.5; }
    .card-price { position: absolute; bottom: 15px; left: 15px; font-size: 1.2rem; font-weight: bold; color: var(--success); }

    /* --- Ø§Ù„Ù†Ø§ÙØ°Ø© Ø§Ù„Ù…Ù†Ø¨Ø«Ù‚Ø© (Modal) --- */
    .modal-overlay { display: none; position: fixed; inset: 0; background: rgba(0,0,0,0.9); z-index: 1000; justify-content: center; align-items: center; }
    .modal-container { width: 95%; max-width: 1100px; height: 85vh; background: #fff; color: #000; border-radius: 10px; display: flex; overflow: hidden; }
    
    /* ÙŠÙ…ÙŠÙ†: Ø£Ø¯ÙˆØ§Øª Ø§Ù„ØªØ­ÙƒÙ… */
    .controls { width: 35%; background: #f4f5f7; padding: 25px; overflow-y: auto; display: flex; flex-direction: column; gap: 12px; border-left: 1px solid #ddd; }
    .controls h2 { margin-top: 0; border-bottom: 2px solid #ddd; padding-bottom: 10px; }
    
    .form-group label { display: block; font-weight: bold; font-size: 0.9rem; margin-bottom: 3px; }
    .form-group input, .form-group textarea, .form-group select { width: 100%; padding: 10px; border: 1px solid #ccc; border-radius: 6px; font-family: inherit; font-weight: bold; box-sizing: border-box; }
    .form-group textarea { height: 80px; resize: none; }

    .action-buttons { margin-top: auto; display: flex; flex-direction: column; gap: 10px; }
    .btn { padding: 15px; border: none; border-radius: 8px; font-weight: bold; cursor: pointer; font-size: 1rem; color: #fff; display: flex; justify-content: center; align-items: center; gap: 8px; }
    .btn-print { background: #000; }
    .btn-cancel { background: var(--danger); }
    .btn-close { background: #666; }

    /* ÙŠØ³Ø§Ø±: Ù…Ø¹Ø§ÙŠÙ†Ø© Ø§Ù„Ù…Ù„ØµÙ‚ */
    .preview-area { width: 65%; background: #e0e0e0; display: flex; justify-content: center; align-items: center; flex-direction: column; }

    /* --- ØªØµÙ…ÙŠÙ… Ø§Ù„Ù…Ù„ØµÙ‚ 10x10 --- */
    .label-box { 
      width: 100mm; height: 100mm; background: #fff; color: #000; padding: 3mm; box-sizing: border-box; 
      border: 1px solid #000; display: flex; flex-direction: column; overflow: hidden; page-break-after: always; direction: rtl;
    }
    
    /* Ø´Ø±ÙŠØ· Ø§Ù„ØªØ¨Ø¯ÙŠÙ„ (ÙŠØ¸Ù‡Ø± ÙÙ‚Ø· Ø¹Ù†Ø¯ Ø§Ù„ØªØ¨Ø¯ÙŠÙ„) */
    .exchange-alert { 
      display: none; background: #000; color: #fff; text-align: center; font-size: 14pt; font-weight: 900; 
      padding: 5px; margin-bottom: 2mm; border: 2px dashed #000; 
    }
    .is-exchange .exchange-alert { display: block; } /* ØªÙØ¹ÙŠÙ„ Ø§Ù„ØªØ¨Ø¯ÙŠÙ„ */
    .is-exchange .lbl-promo { display: none; } /* Ø¥Ø®ÙØ§Ø¡ Ø§Ù„Ø¥Ø¹Ù„Ø§Ù† Ø§Ù„Ø¹Ø§Ø¯ÙŠ */

    .lbl-head { display: flex; justify-content: space-between; height: 20mm; }
    .lbl-logo img { width: 32mm; }
    .lbl-meta { text-align: left; font-size: 9pt; font-weight: bold; }
    
    .lbl-promo { background: #000; color: #fff; text-align: center; font-weight: 900; font-size: 10pt; padding: 2px; margin: 2mm 0; }
    
    .lbl-body { font-size: 11pt; line-height: 1.3; }
    .lbl-content { border: 2px dashed #000; background: #f0f0f0; padding: 4px; margin: 2mm 0; font-size: 9pt; height: 15mm; overflow: hidden; font-weight: bold; }
    .lbl-price { border: 3px solid #000; font-size: 20pt; font-weight: 900; text-align: center; padding: 2px; margin-bottom: 2mm; }
    
    .lbl-footer { display: flex; justify-content: space-between; align-items: flex-end; margin-top: auto; border-top: 1px solid #000; padding-top: 2mm; }

    #printArea { display: none; }
    @media print {
      body * { visibility: hidden !important; }
      #printArea, #printArea * { visibility: visible !important; }
      #printArea { position: absolute; left: 0; top: 0; width: 100%; }
      @page { size: 100mm 100mm; margin: 0; }
      .label-box { border: none; }
    }
  </style>
</head>
<body>

<div class="top-bar">
  <div style="font-size:1.5rem; font-weight:900; color:var(--primary)">MAD MANAGER âš¡</div>
  
  <div class="tabs">
    <div class="tab active" onclick="setTab('pending')" id="tab-pending">Ù…Ø·Ù„ÙˆØ¨ Ù„Ù„ØªØ¬Ù‡ÙŠØ² (Pending)</div>
    <div class="tab" onclick="setTab('all')" id="tab-all">ÙƒÙ„ Ø§Ù„Ø£Ø±Ø´ÙŠÙ (History)</div>
  </div>

  <input class="search-box" id="searchInput" placeholder="Ø¨Ø­Ø« (Ø§Ø³Ù… / Ø±Ù‚Ù… / Ù‡Ø§ØªÙ)..." oninput="render()">
  
  <button class="tab" style="background:var(--success); color:#fff; border:none" onclick="printAllPending()">
    <i class="fas fa-print"></i> Ø·Ø¨Ø§Ø¹Ø© ÙƒÙ„ Ø§Ù„Ø¬Ø¯ÙŠØ¯
  </button>
</div>

<div class="workspace">
  <div class="grid" id="grid"></div>
</div>

<div class="modal-overlay" id="editorModal">
  <div class="modal-container">
    <div class="controls" dir="rtl">
      <h2>ğŸ“ Ù…Ø¹Ø§Ù„Ø¬Ø© Ø§Ù„Ø·Ù„Ø¨</h2>
      
      <div class="form-group">
        <label>Ù†ÙˆØ¹ Ø§Ù„Ø¹Ù…Ù„ÙŠØ© (Type):</label>
        <select id="e_type" onchange="updatePreview()" style="background:#fff3cd">
          <option value="normal">Ø´Ø­Ù†Ø© Ø¹Ø§Ø¯ÙŠØ© (Regular)</option>
          <option value="exchange">â™»ï¸ ØªØ¨Ø¯ÙŠÙ„/Ø¥Ø±Ø¬Ø§Ø¹ (Exchange)</option>
        </select>
      </div>

      <div class="form-group"><label>Ø§Ù„Ø§Ø³Ù…:</label><input id="e_name" oninput="updatePreview()"></div>
      <div class="form-group"><label>Ø§Ù„Ù‡Ø§ØªÙ:</label><input id="e_phone" oninput="updatePreview()"></div>
      <div class="form-group"><label>Ø§Ù„Ø¹Ù†ÙˆØ§Ù†:</label><input id="e_addr" oninput="updatePreview()"></div>
      <div class="form-group"><label>Ø´Ø±ÙƒØ© Ø§Ù„Ø´Ø­Ù†:</label><input id="e_del" oninput="updatePreview()"></div>
      
      <div class="form-group">
        <label>Ù…Ø­ØªÙˆÙ‰ Ø§Ù„Ø·Ø±Ø¯ (Items):</label>
        <textarea id="e_content" oninput="updatePreview()"></textarea>
      </div>
      
      <div class="form-group"><label>Ø§Ù„Ø³Ø¹Ø± (â‚ª):</label><input id="e_price" type="number" style="font-size:1.2rem;color:green" oninput="updatePreview()"></div>

      <div class="action-buttons">
        <button class="btn btn-print" onclick="printSingle()">
          <i class="fas fa-print"></i> Ø·Ø¨Ø§Ø¹Ø© ÙˆØ¥Ù†Ù‡Ø§Ø¡ (Enter)
        </button>
        <button class="btn btn-cancel" onclick="cancelOrder()">
          <i class="fas fa-ban"></i> Ø¥Ù„ØºØ§Ø¡ Ø§Ù„Ø·Ù„Ø¨ (Cancel)
        </button>
        <button class="btn btn-close" onclick="closeModal()">Ø¥ØºÙ„Ø§Ù‚</button>
      </div>
    </div>

    <div class="preview-area">
      <div id="livePreview" style="box-shadow: 0 0 20px rgba(0,0,0,0.2);"></div>
      <div style="margin-top:15px; color:#555">Ù…Ø¹Ø§ÙŠÙ†Ø© Ø­ÙŠØ© Ù„Ù„Ù…Ù„ØµÙ‚ (10x10)</div>
    </div>
  </div>
</div>

<div id="printArea"></div>

<script>
  const SCRIPT_URL = "https://script.google.com/macros/s/AKfycbyLjLFa8AaH82Ip7m747WC-KSUUEaU_M70S0I9Mda14XbnmcuEfZ7pBnF_zzJYZuXmZ/exec";
  const PASS = "12345678";
  
  let allOrders = [];
  let currentTab = 'pending';
  let currentIndex = null;
  let isEditing = false;

  // Ø§Ù„ØªØ­Ù‚Ù‚ ÙˆØ§Ù„ØªØ­Ù…ÙŠÙ„
  if(localStorage.getItem('mad_auth') !== PASS) {
    if(prompt("ÙƒÙ„Ù…Ø© Ø§Ù„Ø³Ø±:") === PASS) localStorage.setItem('mad_auth', PASS);
    else document.body.innerHTML = "Access Denied";
  }
  
  loadData();
  setInterval(() => { if(!isEditing) loadData(); }, 15000); // ØªØ­Ø¯ÙŠØ« ØªÙ„Ù‚Ø§Ø¦ÙŠ

  async function loadData() {
    try {
      const res = await fetch(`${SCRIPT_URL}?action=get`);
      allOrders = await res.json();
      render();
    } catch(e) {}
  }

  function setTab(tab) {
    currentTab = tab;
    document.querySelectorAll('.tab').forEach(el => el.classList.remove('active'));
    document.getElementById(`tab-${tab}`).classList.add('active');
    render();
  }

  function render() {
    const q = document.getElementById('searchInput').value.toLowerCase();
    const grid = document.getElementById('grid');
    
    // ÙÙ„ØªØ±Ø© Ø­Ø³Ø¨ Ø§Ù„ØªØ¨ÙˆÙŠØ¨
    let filtered = allOrders.filter(o => {
      const st = (o.status || "").toLowerCase();
      if (currentTab === 'pending') return (st.includes("prep") || st.includes("approved")) && !st.includes("ready") && !st.includes("cancel");
      return true; // History shows all
    });

    // ÙÙ„ØªØ±Ø© Ø§Ù„Ø¨Ø­Ø«
    if(q) filtered = filtered.filter(o => JSON.stringify(o).toLowerCase().includes(q));

    grid.innerHTML = filtered.map((o, i) => {
      // Ø¥ÙŠØ¬Ø§Ø¯ Ø§Ù„Ù…Ø¤Ø´Ø± Ø§Ù„Ø£ØµÙ„ÙŠ ÙÙŠ Ø§Ù„Ù…ØµÙÙˆÙØ© Ø§Ù„ÙƒØ§Ù…Ù„Ø©
      const realIndex = allOrders.indexOf(o);
      const isExpress = (o.delivery || "").toLowerCase().includes("high");
      
      // ØªØ­Ø¯ÙŠØ¯ Ø­Ø§Ù„Ø© Ø§Ù„Ø¨Ø·Ø§Ù‚Ø© Ù„Ù„Ø£Ù„ÙˆØ§Ù†
      let statusClass = "status-prep";
      if ((o.status||"").includes("READY")) statusClass = "status-ready";
      if ((o.status||"").includes("CANCEL")) statusClass = "status-cancel";

      return `
        <div class="card ${statusClass}" onclick="openEditor(${realIndex})">
          <div class="card-badges">
            <span class="badge" style="background:#555">#${o.orderId}</span>
            ${isExpress ? '<span class="badge badge-rush">Ù…Ø³ØªØ¹Ø¬Ù„</span>' : ''}
            ${(o.status||"").includes("READY") ? '<span class="badge" style="background:green">Ø¬Ø§Ù‡Ø²</span>' : ''}
          </div>
          <div class="card-title">${o.name}</div>
          <div class="card-info">
            ğŸ“ ${o.city}<br>
            ğŸ“ ${o.phone}<br>
            ğŸ“¦ ${o.offer ? o.offer.substring(0,30) : ''}
          </div>
          <div class="card-price">â‚ª${o.price}</div>
        </div>
      `;
    }).join("");
  }

  // --- HTML Ø§Ù„Ù…Ù„ØµÙ‚ ---
  function getLabelHTML(data, idSuffix, isExchange) {
    const date = new Date().toLocaleDateString('he-IL');
    const exchangeClass = isExchange ? "is-exchange" : "";
    
    return `
      <div class="label-box ${exchangeClass}" dir="rtl">
        
        <div class="exchange-alert">
           âš ï¸ ××™×¡×•×£ ×•×”×—×–×¨×” (ØªØ¨Ø¯ÙŠÙ„) âš ï¸
        </div>

        <div class="lbl-head">
          <div class="lbl-logo"><img src="https://www.madparfum.com/logo.svg"></div>
          <div class="lbl-meta">
            DATE: ${date}<br>
            ORD: ${data.orderId}
          </div>
        </div>

        <div class="lbl-promo">×¦×œ× ××ª ×”×¨×’×¢ ×•×§×‘×œ ××ª× ×” ğŸ</div>

        <div class="lbl-body">
          <div><b>×œ×›×‘×•×“:</b> ${data.name}</div>
          <div><b>×˜×œ×¤×•×Ÿ:</b> ${data.phone}</div>
          <div><b>×›×ª×•×‘×ª:</b> ${data.city}</div>
          <div><b>××©×œ×•×—:</b> ${data.delivery}</div>
        </div>

        <div class="lbl-content">
          <b>×ª×›×•×œ×” (Content):</b><br>
          ${(data.offer || "").replace(/\n/g, "<br>")}
        </div>

        <div class="lbl-price">â‚ª ${data.price}</div>

        <div class="lbl-footer">
          <div style="font-size:8pt; font-weight:bold; width:65%">
            WhatsApp Video = FREE GIFT<br>
            +972 54-963-4449
          </div>
          <div id="qr_${idSuffix}"></div>
        </div>
        <div style="text-align:center; position:absolute; bottom:2mm; width:92%">
           <svg id="bar_${idSuffix}"></svg>
        </div>
      </div>
    `;
  }

  // --- Ø§Ù„Ù…Ø­Ø±Ø± ---
  function openEditor(idx) {
    isEditing = true;
    currentIndex = idx;
    const o = allOrders[idx];
    
    document.getElementById('e_name').value = o.name;
    document.getElementById('e_phone').value = o.phone;
    document.getElementById('e_addr').value = o.city + " " + (o.addr || "");
    document.getElementById('e_del').value = o.delivery || "High Express";
    document.getElementById('e_content').value = o.offer || "";
    document.getElementById('e_price').value = o.price;
    document.getElementById('e_type').value = "normal"; // Ø§ÙØªØ±Ø§Ø¶ÙŠ

    document.getElementById('editorModal').style.display = 'flex';
    updatePreview();

    // Ø§Ø®ØªØµØ§Ø±Ø§Øª
    document.onkeydown = (e) => {
      if(e.key === "Enter" && !e.shiftKey) { e.preventDefault(); printSingle(); }
      if(e.key === "Escape") closeModal();
    };
  }

  function closeModal() {
    isEditing = false;
    document.getElementById('editorModal').style.display = 'none';
    document.onkeydown = null;
  }

  function updatePreview() {
    const data = getFormData();
    const isExc = document.getElementById('e_type').value === 'exchange';
    
    document.getElementById('livePreview').innerHTML = getLabelHTML(data, 'prev', isExc);
    
    setTimeout(() => {
      try {
        JsBarcode("#bar_prev", data.phone, { format: "CODE128", height: 25, fontSize: 10, displayValue: false, margin:0 });
        const q = document.getElementById("qr_prev"); q.innerHTML="";
        new QRCode(q, { text: "https://wa.me/972549634449", width: 45, height: 45 });
      } catch(e){}
    }, 50);
  }

  function getFormData() {
    return {
      orderId: allOrders[currentIndex].orderId,
      name: document.getElementById('e_name').value,
      phone: document.getElementById('e_phone').value,
      city: document.getElementById('e_addr').value,
      delivery: document.getElementById('e_del').value,
      offer: document.getElementById('e_content').value,
      price: document.getElementById('e_price').value
    };
  }

  // --- Ø¹Ù…Ù„ÙŠØ§Øª Ø§Ù„Ø·Ø¨Ø§Ø¹Ø© ÙˆØ§Ù„Ø¥Ù„ØºØ§Ø¡ ---
  async function printSingle() {
    const data = getFormData();
    const isExc = document.getElementById('e_type').value === 'exchange';
    
    const area = document.getElementById('printArea');
    area.innerHTML = getLabelHTML(data, 'print', isExc);
    
    // ØªÙˆÙ„ÙŠØ¯ Ø§Ù„Ø£ÙƒÙˆØ§Ø¯
    setTimeout(() => {
      JsBarcode("#bar_print", data.phone, { format: "CODE128", height: 25, fontSize: 10, displayValue: false, margin:0 });
      new QRCode(document.getElementById("qr_print"), { text: "https://wa.me/972549634449", width: 45, height: 45 });
      
      window.print();
      
      // ØªØ­Ø¯ÙŠØ« Ø§Ù„Ø­Ø§Ù„Ø©
      const row = allOrders[currentIndex].rowIndex;
      closeModal();
      setStatus(row, "READY âœ…");
    }, 300);
  }

  async function cancelOrder() {
    if(!confirm("Ù‡Ù„ Ø£Ù†Øª Ù…ØªØ£ÙƒØ¯ Ù…Ù† Ø¥Ù„ØºØ§Ø¡ Ù‡Ø°Ø§ Ø§Ù„Ø·Ù„Ø¨ØŸ")) return;
    const row = allOrders[currentIndex].rowIndex;
    closeModal();
    setStatus(row, "CANCELLED âŒ");
  }

  function printAllPending() {
    // Ù†Ø£Ø®Ø° ÙÙ‚Ø· Ø§Ù„Ø·Ù„Ø¨Ø§Øª ÙÙŠ Ø§Ù„ØªØ¨ÙˆÙŠØ¨ Ø§Ù„Ø­Ø§Ù„ÙŠ (Pending)
    const list = allOrders.filter(o => {
       const st = (o.status || "").toLowerCase();
       return (st.includes("prep") || st.includes("approved")) && !st.includes("ready") && !st.includes("cancel");
    });

    if(!list.length) return alert("Ù„Ø§ ÙŠÙˆØ¬Ø¯ Ø·Ù„Ø¨Ø§Øª Ø¬Ø¯ÙŠØ¯Ø© Ù„Ù„Ø·Ø¨Ø§Ø¹Ø©!");
    if(!confirm(`Ø·Ø¨Ø§Ø¹Ø© ${list.length} Ù…Ù„ØµÙ‚ Ø¯ÙØ¹Ø© ÙˆØ§Ø­Ø¯Ø©ØŸ`)) return;

    const area = document.getElementById('printArea');
    area.innerHTML = list.map((o, i) => getLabelHTML(o, `bulk_${i}`, false)).join("");

    setTimeout(() => {
      list.forEach((o, i) => {
        try {
          JsBarcode(`#bar_bulk_${i}`, o.phone, { format: "CODE128", height: 25, fontSize: 10, displayValue: false, margin:0 });
          new QRCode(document.getElementById(`qr_bulk_${i}`), { text: "https://wa.me/972549634449", width: 45, height: 45 });
        } catch(e){}
      });

      setTimeout(() => {
        window.print();
        if(confirm("ØªÙ…Øª Ø§Ù„Ø·Ø¨Ø§Ø¹Ø©! Ù†Ù‚Ù„ Ø§Ù„ÙƒÙ„ Ø¥Ù„Ù‰ Ø¬Ø§Ù‡Ø²ØŸ")) {
          list.forEach(o => fetch(`${SCRIPT_URL}?action=updateStatus&key=${PASS}&row=${o.rowIndex}&status=READY âœ…`));
          setTimeout(loadData, 2000);
        }
      }, 1500);
    }, 100);
  }

  async function setStatus(row, status) {
    // ØªØ­Ø¯ÙŠØ« Ù…Ø­Ù„ÙŠ Ø³Ø±ÙŠØ¹
    const o = allOrders.find(x => x.rowIndex === row);
    if(o) o.status = status;
    render();
    // ØªØ­Ø¯ÙŠØ« Ø§Ù„Ø³ÙŠØ±ÙØ±
    await fetch(`${SCRIPT_URL}?action=updateStatus&key=${PASS}&row=${row}&status=${encodeURIComponent(status)}`);
  }

</script>
</body>
</html>
