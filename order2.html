<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
  <title>MAD Prep</title>

  <script src="https://cdn.jsdelivr.net/npm/jsbarcode@3.11.5/dist/JsBarcode.all.min.js"></script>

  <style>
    :root{
      --bg:#0b1220; --card:#0f1b34; --line:#22314f; --txt:#f3f6ff; --muted:#9fb0d0;
      --green:#10b981; --blue:#3b82f6; --yellow:#f59e0b;
    }
    body{margin:0;background:var(--bg);color:var(--txt);font-family:system-ui,-apple-system,"Segoe UI",Tahoma,Arial; padding-bottom:90px;}
    .wrap{max-width:720px;margin:0 auto;padding:12px;}
    .top{position:sticky;top:0;background:rgba(11,18,32,.92);backdrop-filter:blur(10px);border-bottom:1px solid var(--line);z-index:5}
    .bar{display:flex;gap:10px;align-items:center;justify-content:space-between;padding:10px 0}
    .search{width:100%;padding:12px;border-radius:14px;border:1px solid var(--line);background:var(--card);color:var(--txt);outline:none;font-weight:900}
    .select{width:100%;padding:12px;border-radius:14px;border:1px solid var(--line);background:var(--card);color:var(--txt);outline:none;font-weight:900}
    .box{
      background:var(--card); border:1px solid var(--line); border-radius:22px;
      padding:14px; margin:12px 0;
    }
    .bigline{font-size:20px;font-weight:1000}
    .grid{display:grid;grid-template-columns:1fr 1fr;gap:10px;margin-top:10px}
    .kv{background:#0b1630;border:1px solid var(--line);border-radius:16px;padding:12px}
    .k{color:var(--muted);font-size:12px;font-weight:900}
    .v{font-size:16px;font-weight:1000;margin-top:4px}
    .btns{display:grid;grid-template-columns:1fr 1fr;gap:10px;margin-top:12px}
    .btn{border:0;border-radius:16px;padding:14px;font-weight:1000;cursor:pointer}
    .b-print{background:var(--blue);color:white}
    .b-ready{background:var(--green);color:#062217}
    .hint{color:var(--muted);font-size:12px;font-weight:800;margin-top:6px}
    .fixednav{position:fixed;bottom:0;left:0;right:0;background:rgba(11,18,32,.92);backdrop-filter:blur(10px);border-top:1px solid var(--line)}
    .fixednav .wrap{display:flex;gap:10px}
    .big{flex:1;padding:14px;border-radius:16px;background:var(--yellow);color:#201205;font-weight:1000;border:0;cursor:pointer}

    #print-container { display:none; }
    @media print{
      body *{visibility:hidden;}
      #print-container, #print-container *{visibility:visible;}
      #print-container{display:block !important; position:absolute; left:0; top:0; width:100%;}
      .print-page{width:100mm;height:100mm;margin:0 auto;padding:5mm;box-sizing:border-box;background:white;color:black;}
    }
  </style>
</head>
<body>

<div class="top">
  <div class="wrap">
    <div class="bar">
      <div style="font-size:16px;font-weight:1000">MAD â€¢ Prep</div>
      <div style="font-weight:1000;color:var(--yellow)" id="count">0</div>
    </div>

    <select id="emp" class="select" onchange="saveEmp()">
      <option value="">Ø§Ø®ØªØ± Ø§Ø³Ù… Ø§Ù„Ù…ÙˆØ¸Ù (Ø¥Ø¬Ø¨Ø§Ø±ÙŠ Ù„Ù„ØªØ¬Ù‡ÙŠØ²)</option>
      <option value="Ø¹Ø¨ÙŠØ± (×¢×‘×™×¨)">Ø¹Ø¨ÙŠØ± (×¢×‘×™×¨)</option>
      <option value="Ø£Ù„Ø§Ø¡ (××œ××)">Ø£Ù„Ø§Ø¡ (××œ××)</option>
      <option value="Ù„ÙŠÙ„Ù‰ (×œ×™×™×œ×)">Ù„ÙŠÙ„Ù‰ (×œ×™×™×œ×)</option>
    </select>

    <div style="height:8px"></div>
    <input id="q" class="search" placeholder="Ø¨Ø­Ø« Ø¨Ø§Ù„Ø§Ø³Ù… Ø£Ùˆ Ø§Ù„ØªÙ„ÙÙˆÙ†..." oninput="render()"/>
    <div class="hint">ÙŠØ¸Ù‡Ø± Ù‡Ù†Ø§ ÙÙ‚Ø· Ø§Ù„Ø·Ù„Ø¨Ø§Øª Ø§Ù„Ù…Ø¹ØªÙ…Ø¯Ø© (Approved) â€” Ø²Ø± ÙˆØ§Ø­Ø¯ Ù„Ù„ØªØ¬Ù‡ÙŠØ² + Ø²Ø± Ø·Ø¨Ø§Ø¹Ø©</div>
  </div>
</div>

<div class="wrap" id="list"></div>

<div class="fixednav">
  <div class="wrap">
    <button class="big" onclick="sync()">ğŸ”„ ØªØ­Ø¯ÙŠØ«</button>
  </div>
</div>

<div id="print-container"></div>

<script>
  const SCRIPT_URL = "https://script.google.com/macros/s/AKfycby0g7TGGLlpl6jgv9mTds67X5hhch9nagpmpPhjatBUrUfm3kVbPDcGvoNIcpa12Rcf/exec";
  const DASH_KEY = "12345678";

  let orders = [];

  function saveEmp(){
    localStorage.setItem("mad_emp", document.getElementById("emp").value);
  }
  function loadEmp(){
    const v = localStorage.getItem("mad_emp") || "";
    document.getElementById("emp").value = v;
  }

  function isApproved(s){ s=String(s||""); return s.includes("Approved") || s.includes("×××•×©×¨") || s.includes("Sent to Prep"); }
  function isReady(s){ s=String(s||""); return s.includes("××•×›×Ÿ") || s.toLowerCase().includes("ready"); }
  function isDelivered(s){ s=String(s||""); return s.includes("Delivered"); }

  async function sync(){
    try{
      const res = await fetch(`${SCRIPT_URL}?action=get&t=${Date.now()}`);
      orders = await res.json();
      render();
    }catch(e){
      console.error(e);
      alert("Ù…Ø´ÙƒÙ„Ø© ÙÙŠ Ø¬Ù„Ø¨ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª");
    }
  }

  function render(){
    const q = (document.getElementById("q").value||"").toLowerCase().trim();
    let a = [...(orders||[])].reverse();

    a = a.filter(o=>{
      const s=o.status||"";
      if(isDelivered(s)) return false;
      return isApproved(s) && !isReady(s);
    });

    if(q){
      a = a.filter(o=>(String(o.name||"").toLowerCase().includes(q) || String(o.phone||"").includes(q)));
    }

    document.getElementById("count").innerText = a.length;

    const list = document.getElementById("list");
    if(!a.length){
      list.innerHTML = `<div class="hint" style="text-align:center;padding:30px">Ù„Ø§ ØªÙˆØ¬Ø¯ Ø·Ù„Ø¨Ø§Øª Ù„Ù„ØªØ¬Ù‡ÙŠØ²</div>`;
      return;
    }

    list.innerHTML = a.map(o=>box(o)).join("");
  }

  function detectArabic(name){
    return /[\u0600-\u06FF]/.test(String(name||""));
  }

  async function updateStatus(row, status){
    await fetch(`${SCRIPT_URL}?action=updateStatus&key=${encodeURIComponent(DASH_KEY)}&row=${encodeURIComponent(row)}&status=${encodeURIComponent(status)}&t=${Date.now()}`);
    await sync();
  }

  function box(o){
    const addr = o.addr || o.city || "-";
    const delivery = o.delivery || "Ù„Ù… ÙŠØ­Ø¯Ø¯";
    const price = o.price || "150";

    return `
      <div class="box">
        <div class="bigline">${o.name || "-"}</div>
        <div class="hint">ğŸ†” ${o.orderId || ""} â€¢ ğŸ“ ${o.phone || ""}</div>

        <div class="grid">
          <div class="kv"><div class="k">Ø§Ù„Ø¹Ù†ÙˆØ§Ù†</div><div class="v">${escapeHtml(addr)}</div></div>
          <div class="kv"><div class="k">Ø´Ø±ÙƒØ© Ø§Ù„ØªÙˆØµÙŠÙ„</div><div class="v">${escapeHtml(delivery)}</div></div>
          <div class="kv"><div class="k">Ø§Ù„Ø·Ù„Ø¨ (Ø§Ù„Ø¹Ø·ÙˆØ±)</div><div class="v">${escapeHtml(o.offer||"")}</div></div>
          <div class="kv"><div class="k">Ø§Ù„Ø³Ø¹Ø±</div><div class="v">â‚ª${escapeHtml(price)}</div></div>
        </div>

        <div class="btns">
          <button class="btn b-print" onclick='printSticker(${JSON.stringify(o).replace(/"/g,"&quot;")})'>ğŸ–¨ï¸ Ø·Ø¨Ø§Ø¹Ø© (TSC)</button>
          <button class="btn b-ready" onclick="markReady(${o.rowIndex})">ğŸ“¦ ØªÙ… ØªØ¬Ù‡ÙŠØ² Ø§Ù„Ø·Ù„Ø¨</button>
        </div>
      </div>
    `;
  }

  function markReady(row){
    const emp = document.getElementById("emp").value;
    if(!emp){ alert("Ù„Ø§Ø²Ù… ØªØ®ØªØ§Ø± Ø§Ø³Ù… Ø§Ù„Ù…ÙˆØ¸Ù"); return; }
    const o = orders.find(x=>x.rowIndex==row);
    if(!o) return;
    const delivery = o.delivery || "";
    const status = `××•×›×Ÿ ×¢×œ ×™×“×™ ${emp}${delivery ? ` (××©×œ×•×—: ${delivery})` : ""}`;
    updateStatus(row, status);
  }

  function printSticker(o){
    const isAr = detectArabic(o.name);
    const delivery = o.delivery || "";
    const price = o.price || "150";

    const labels = isAr
      ? {title:"MAD System", name:"Ø§Ù„Ø§Ø³Ù…", phone:"Ø§Ù„Ù‡Ø§ØªÙ", del:"Ø§Ù„ØªÙˆØµÙŠÙ„", offer:"Ø§Ù„Ø·Ù„Ø¨", price:"Ø§Ù„Ø³Ø¹Ø±", rule:"Ø§Ù„Ø§Ø³ØªØ¨Ø¯Ø§Ù„ ÙÙ‚Ø· Ø¥Ø°Ø§ Ù„Ù… ÙŠÙÙØªØ­ Ø§Ù„Ù†Ø§ÙŠÙ„ÙˆÙ†"}
      : {title:"××¢×¨×›×ª MAD", name:"×©×", phone:"×˜×œ×¤×•×Ÿ", del:"××©×œ×•×—", offer:"×”×–×× ×”", price:"××—×™×¨", rule:"×”×—×œ×¤×” ×¨×§ ×× ×”× ×™×™×œ×•×Ÿ ×œ× × ×¤×ª×—"};

    const container = document.getElementById("print-container");
    container.innerHTML = `
      <div class="print-page" dir="rtl">
        <div style="text-align:center;border-bottom:2px solid #000;font-weight:900;font-size:16pt">${labels.title}</div>
        <div style="font-size:12pt;margin:10px 0;line-height:1.6">
          <b>${labels.name}:</b> ${escapeHtml(o.name)}<br>
          <b>${labels.phone}:</b> ${escapeHtml(o.phone)}<br>
          <b>${labels.del}:</b> ${escapeHtml(delivery)}<br>
          <b>${labels.price}:</b> â‚ª${escapeHtml(price)}
        </div>
        <div style="border:1.5px solid #000;padding:6px;background:#eee;font-size:12pt"><b>${labels.offer}:</b> ${escapeHtml(o.offer||"")}</div>
        <div style="font-size:8pt;border:1px solid red;color:red;text-align:center;font-weight:900;margin-top:10px;padding:6px">
          ${labels.rule}
        </div>
        <div style="text-align:center;margin-top:10px"><svg id="bcode_gen"></svg></div>
      </div>
    `;
    JsBarcode("#bcode_gen", String(o.phone||"").replace(/\D/g,""), { format:"CODE128", width:1.8, height:40, displayValue:false });
    setTimeout(()=>window.print(), 300);
  }

  function escapeHtml(s){
    return String(s||"").replace(/[&<>"']/g, m => ({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'}[m]));
  }

  loadEmp();
  sync();
</script>
</body>
</html>
