<!doctype html>
<html lang="he" dir="rtl">
<head>
  <meta charset="utf-8"/>
  <title>MAD SYSTEM v5.1 | ×‘×“×™×§×ª ×—×™×‘×•×¨</title>
  
  <script src="https://cdn.jsdelivr.net/npm/jsbarcode@3.11.5/dist/JsBarcode.all.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/qrcodejs@1.0.0/qrcode.min.js"></script>
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">

  <style>
    body { font-family: system-ui, sans-serif; background: #0f172a; color: white; margin: 0; direction: rtl; }
    header { background: #1e293b; padding: 20px; border-bottom: 2px solid #334155; text-align: center; }
    
    .status-bar { padding: 10px; text-align: center; font-size: 14px; background: #334155; }
    .status-online { color: #10b981; }
    .status-offline { color: #ef4444; }

    .grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(280px, 1fr)); gap: 20px; padding: 20px; }
    .card { background: #1e293b; padding: 15px; border-radius: 12px; border: 1px solid #334155; cursor: pointer; position: relative; }
    .card:hover { border-color: #3b82f6; }
    
    /* ×¢×™×¦×•×‘ ×”×“×¤×¡×” 10x10 */
    @media print {
      body * { visibility: hidden; }
      #printArea, #printArea * { visibility: visible; }
      #printArea { position: absolute; left: 0; top: 0; width: 100mm; }
      @page { size: 100mm 100mm; margin: 0; }
      .label { width: 100mm; height: 100mm; padding: 5mm; background: white !important; color: black !important; display: flex; flex-direction: column; page-break-after: always; border: 1px solid #000; }
    }
    #printArea { display: none; }
  </style>
</head>
<body>

<header>
  <h2>××¢×¨×›×ª MAD - × ×™×”×•×œ ××©×œ×•×—×™×</h2>
  <div class="status-bar" id="connStatus">×‘×•×“×§ ×—×™×‘×•×¨ ×œ××¡×“ ×”× ×ª×•× ×™×...</div>
</header>

<div style="padding: 20px; text-align: center;">
  <input type="text" id="search" placeholder="×—×™×¤×•×© ×œ×¤×™ ×©× ××• ×˜×œ×¤×•×Ÿ..." oninput="app.render()" 
         style="width: 80%; max-width: 500px; padding: 12px; border-radius: 8px; border: none; font-size: 16px;">
  <button onclick="app.fetchData()" style="padding: 12px 20px; cursor: pointer; background: #3b82f6; color: white; border: none; border-radius: 8px; margin-right: 10px;">×¨×¢× ×Ÿ × ×ª×•× ×™× â†»</button>
</div>

<div class="grid" id="grid"></div>

<div id="printArea"></div>

<script>
class MadSystem {
  constructor() {
    // *** ×©×™× ×œ×‘! ×”×“×‘×§ ×›××Ÿ ××ª ×”×§×™×©×•×¨ ×©×§×™×‘×œ×ª ××’×•×’×œ (Deployment URL) ***
    this.url = "https://script.google.com/macros/s/AKfycbyLjLFa8AaH82Ip7m747WC-KSUUEaU_M70S0I9Mda14XbnmcuEfZ7pBnF_zzJYZuXmZ/exec";
    
    this.data = [];
    this.fetchData();
  }

  async fetchData() {
    const statusDiv = document.getElementById('connStatus');
    statusDiv.innerHTML = "×˜×•×¢×Ÿ × ×ª×•× ×™×...";
    
    try {
      const response = await fetch(`${this.url}?action=get`);
      this.data = await response.json();
      
      if (this.data.length === 0) {
          statusDiv.innerHTML = '<span class="status-offline">×”×—×™×‘×•×¨ ×”×¦×œ×™×—, ××š ××™×Ÿ × ×ª×•× ×™× ×‘×˜×‘×œ×”.</span>';
      } else {
          statusDiv.innerHTML = `<span class="status-online">××—×•×‘×¨! × ××¦××• ${this.data.length} ×”×–×× ×•×ª.</span>`;
      }
      this.render();
    } catch(e) {
      console.error(e);
      statusDiv.innerHTML = '<span class="status-offline">×©×’×™××ª ×—×™×‘×•×¨! ×•×•×“× ×©×›×ª×•×‘×ª ×”-URL ×ª×§×™× ×” ×•×©×™×© ×”×¨×©××•×ª.</span>';
    }
  }

  render() {
    const q = document.getElementById('search').value.toLowerCase();
    const container = document.getElementById('grid');
    
    const filtered = this.data.filter(item => {
        const name = (item.name || "").toLowerCase();
        const phone = (item.phone || "").replace(/-/g, "");
        return name.includes(q) || phone.includes(q);
    });

    if (filtered.length === 0 && q === "") {
        container.innerHTML = '<div style="grid-column: 1/-1; text-align: center; padding: 40px;">×××ª×™×Ÿ ×œ× ×ª×•× ×™×...</div>';
        return;
    }

    container.innerHTML = filtered.map((item, index) => `
        <div class="card" onclick="app.printSingle(${this.data.indexOf(item)})">
          <div style="font-weight: bold; font-size: 18px;">${item.name}</div>
          <div style="color: #94a3b8;">ğŸ“ ${item.phone}</div>
          <div style="color: #f59e0b;">ğŸ“ ${item.city || "×œ× ×¦×•×™×Ÿ"}</div>
          <div style="margin-top: 10px; font-weight: bold; color: #10b981;">â‚ª${item.price}</div>
          <div style="font-size: 12px; margin-top: 5px; color: #64748b;">×œ×—×¥ ×œ×”×“×¤×¡×ª ×ª×•×•×™×ª</div>
        </div>
    `).join("");
  }

  printSingle(index) {
    const item = this.data[index];
    const area = document.getElementById('printArea');
    
    area.innerHTML = `
      <div class="label">
        <h1 style="text-align:center; margin:0; border-bottom: 2px solid black;">MAD PARFUM</h1>
        <div style="font-size: 16pt; margin-top: 10px;"><b>×œ×›×‘×•×“:</b> ${item.name}</div>
        <div style="font-size: 16pt;"><b>×˜×œ×¤×•×Ÿ:</b> ${item.phone}</div>
        <div style="font-size: 16pt;"><b>×¢×™×¨:</b> ${item.city || ""}</div>
        <div style="font-size: 16pt;"><b>×ª×©×œ×•×:</b> ${item.payment || "××–×•××Ÿ"}</div>
        <div style="border: 5px solid black; font-size: 35pt; font-weight: 900; text-align: center; margin-top: auto; border-radius: 10px;">
          â‚ª${item.price}
        </div>
        <div style="text-align: center; margin-top: 10px;">
           <svg id="barcode"></svg>
        </div>
      </div>
    `;
    
    JsBarcode("#barcode", item.phone.replace(/\D/g,''), {height: 40, displayValue: false});
    
    setTimeout(() => {
        window.print();
    }, 500);
  }
}

const app = new MadSystem();
</script>
</body>
</html>
