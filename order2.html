<!doctype html>
<html lang="ar" dir="rtl">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width,initial-scale=1"/>
  <title>MAD Prep | Ù†Ø¸Ø§Ù… Ø§Ù„ØªØ¬Ù‡ÙŠØ² Ø§Ù„Ø°ÙƒÙŠ</title>

  <style>
    :root {
      --bg: #0f172a;
      --surface: #1e293b;
      --primary: #3b82f6;
      --success: #10b981;
      --warning: #f59e0b;
      --danger: #ef4444;
      --text-main: #f8fafc;
      --text-muted: #94a3b8;
      --border: rgba(255,255,255,0.1);
      
      /* Label Sizes */
      --label-w: 60mm;
      --label-h: 40mm;
    }

    body {
      margin: 0;
      font-family: 'Segoe UI', Roboto, Helvetica, Arial, sans-serif;
      background: var(--bg);
      color: var(--text-main);
      line-height: 1.6;
    }

    /* Header Styling */
    .top {
      position: sticky;
      top: 0;
      z-index: 100;
      background: rgba(15, 23, 42, 0.8);
      backdrop-filter: blur(12px);
      border-bottom: 1px solid var(--border);
      padding: 1rem 0;
    }

    .container {
      max-width: 900px;
      margin: 0 auto;
      padding: 0 20px;
    }

    .header-content {
      display: flex;
      flex-direction: column;
      gap: 15px;
    }

    .header-top-row {
      display: flex;
      justify-content: space-between;
      align-items: center;
    }

    .brand {
      display: flex;
      align-items: center;
      gap: 10px;
    }

    .brand h1 {
      font-size: 1.25rem;
      margin: 0;
      font-weight: 800;
      background: linear-gradient(to left, #fff, #3b82f6);
      -webkit-background-clip: text;
      -webkit-text-fill-color: transparent;
    }

    .search-bar {
      display: flex;
      gap: 10px;
      width: 100%;
    }

    input, select {
      background: var(--surface);
      border: 1px solid var(--border);
      color: #fff;
      padding: 12px 15px;
      border-radius: 12px;
      font-size: 0.95rem;
      transition: all 0.3s;
    }

    input:focus {
      border-color: var(--primary);
      box-shadow: 0 0 0 3px rgba(59, 130, 246, 0.2);
      outline: none;
    }

    .btn {
      cursor: pointer;
      border: none;
      border-radius: 12px;
      padding: 10px 18px;
      font-weight: 700;
      display: inline-flex;
      align-items: center;
      justify-content: center;
      gap: 8px;
      transition: transform 0.2s, opacity 0.2s;
    }

    .btn:active { transform: scale(0.96); }

    .btn-primary { background: var(--primary); color: white; }
    .btn-success { background: var(--success); color: white; }
    .btn-outline { background: transparent; border: 1px solid var(--border); color: #fff; }
    .btn-ghost { background: rgba(255,255,255,0.05); color: var(--text-muted); }

    /* Order Card Styling */
    .orders-list { margin-top: 20px; }

    .card {
      background: var(--surface);
      border: 1px solid var(--border);
      border-radius: 20px;
      padding: 20px;
      margin-bottom: 20px;
      box-shadow: 0 10px 25px -5px rgba(0,0,0,0.3);
      position: relative;
      overflow: hidden;
    }

    .card-header {
      display: flex;
      justify-content: space-between;
      margin-bottom: 15px;
      border-bottom: 1px solid var(--border);
      padding-bottom: 15px;
    }

    .order-number {
      font-size: 1.1rem;
      font-weight: 800;
      color: var(--primary);
    }

    .status-badge {
      font-size: 0.75rem;
      padding: 4px 12px;
      border-radius: 20px;
      background: rgba(59, 130, 246, 0.1);
      border: 1px solid rgba(59, 130, 246, 0.2);
    }

    .info-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
      gap: 15px;
      margin-bottom: 20px;
    }

    .info-item .label {
      font-size: 0.8rem;
      color: var(--text-muted);
      margin-bottom: 4px;
    }

    .info-item .value {
      font-weight: 600;
      font-size: 1rem;
    }

    .price-tag {
      font-size: 1.2rem;
      color: var(--success);
      font-weight: 800;
    }

    .card-actions {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 12px;
    }

    .secondary-actions {
      display: flex;
      gap: 10px;
      margin-top: 15px;
    }

    .empty-state {
      text-align: center;
      padding: 50px;
      opacity: 0.5;
    }

    /* Print Label Styles */
    #printArea { display: none; }
    @media print {
      body * { visibility: hidden !important; }
      #printArea, #printArea * { visibility: visible !important; }
      #printArea { display: block; position: fixed; inset: 0; }
      .labelSheet {
        width: var(--label-w); height: var(--label-h);
        padding: 4mm; background: #fff; color: #000;
        border: 1px solid #eee; box-sizing: border-box;
      }
      .lp1 { font-size: 14pt; font-weight: bold; margin-bottom: 2mm; border-bottom: 1pt solid #000; }
      .lp2 { font-size: 11pt; font-weight: bold; }
      .lp3 { font-size: 10pt; }
    }

    @media (max-width: 600px) {
      .card-actions { grid-template-columns: 1fr; }
    }
  </style>
</head>
<body>

  <div class="top">
    <div class="container">
      <div class="header-content">
        <div class="header-top-row">
          <div class="brand">
            <h1>MAD PREP âš¡</h1>
            <span class="status-badge" id="stat">ØªØ­Ù…ÙŠÙ„...</span>
          </div>
          <button class="btn btn-ghost" onclick="load()">â†» ØªØ­Ø¯ÙŠØ«</button>
        </div>
        
        <div class="search-bar">
          <input id="q" placeholder="Ø§Ø¨Ø­Ø« Ø¹Ù† Ø§Ø³Ù…ØŒ Ù‡Ø§ØªÙØŒ Ø£Ùˆ Ø±Ù‚Ù… Ø·Ù„Ø¨..." style="flex:1" oninput="render()"/>
          <select id="labelSize" onchange="applyLabelSize()">
            <option value="100x100">100Ã—100</option>
            <option value="50x30">50Ã—30</option>
            <option value="100x50">100Ã—50</option>
          </select>
        </div>
      </div>
    </div>
  </div>

  <div class="container orders-list" id="list">
    </div>

  <div id="printArea"></div>

<script>
  const SCRIPT_URL = "https://script.google.com/macros/s/AKfycbyLjLFa8AaH82Ip7m747WC-KSUUEaU_M70S0I9Mda14XbnmcuEfZ7pBnF_zzJYZuXmZ/exec";
  const DASH_KEY   = "12345678";

  let orders = [];
  let authed = false;

  (function(){
    const pass = prompt("ÙƒÙ„Ù…Ø© Ø§Ù„Ø³Ø±:");
    if(pass !== DASH_KEY){
      document.body.innerHTML = "<div style='padding:50px; text-align:center'><h2>âŒ ØºÙŠØ± Ù…ØµØ±Ø­ Ù„Ùƒ Ø¨Ø§Ù„Ø¯Ø®ÙˆÙ„</h2></div>";
      return;
    }
    authed = true;
    applyLabelSize();
    load();
  })();

  function applyLabelSize(){
    const v = document.getElementById("labelSize").value;
    const root = document.documentElement;
    const [w, h] = v.split('x');
    root.style.setProperty("--label-w", w + "mm");
    root.style.setProperty("--label-h", h + "mm");
  }

  async function load(){
    if(!authed) return;
    document.getElementById("stat").textContent = "Ø¬Ø§Ø±ÙŠ Ø§Ù„ØªØ­Ø¯ÙŠØ«...";
    try {
      const res = await fetch(`${SCRIPT_URL}?action=get`);
      orders = await res.json();
      render();
    } catch(e) {
      document.getElementById("stat").textContent = "Ø®Ø·Ø£ ÙÙŠ Ø§Ù„Ø§ØªØµØ§Ù„";
    }
  }

  function render(){
    const q = document.getElementById("q").value.trim().toLowerCase();
    const list = document.getElementById("list");

    const items = orders
      .filter(o => {
        const st = String(o.status || "");
        const isPrep = st.includes("Approved") || st.includes("Sent to Prep") || st.includes("Ø§Ù„ØªØ¬Ù‡ÙŠØ²") || st.includes("Prep");
        const isFinished = st.includes("READY") || st.includes("Ù…Ø¬Ù‡Ø²") || st.includes("CANCEL");
        return isPrep && !isFinished;
      })
      .filter(o => !q || `${o.orderId} ${o.name} ${o.phone}`.toLowerCase().includes(q))
      .sort((a,b) => (b.rowIndex||0) - (a.rowIndex||0));

    document.getElementById("stat").textContent = `${items.length} Ø·Ù„Ø¨Ø§Øª`;

    if(!items.length) {
      list.innerHTML = `<div class="empty-state"><h3>ÙƒÙ„ Ø´ÙŠØ¡ Ø¬Ø§Ù‡Ø²! âœ…</h3><p>Ù„Ø§ ØªÙˆØ¬Ø¯ Ø·Ù„Ø¨Ø§Øª Ø¬Ø¯ÙŠØ¯Ø© Ø¨Ø§Ù†ØªØ¸Ø§Ø± Ø§Ù„ØªØ¬Ù‡ÙŠØ² Ø­Ø§Ù„ÙŠØ§Ù‹.</p></div>`;
      return;
    }

    list.innerHTML = items.map(o => `
      <div class="card" id="c${o.rowIndex}">
        <div class="card-header">
          <div class="order-number">ğŸ“¦ ${esc(o.orderId)}</div>
          <div class="status-badge">${esc(o.status)}</div>
        </div>
        
        <div class="info-grid">
          <div class="info-item">
            <div class="label">Ø§Ù„Ø¹Ù…ÙŠÙ„</div>
            <div class="value">${esc(o.name)}</div>
            <div class="value" style="font-size:0.9rem; opacity:0.7">${esc(o.phone)}</div>
          </div>
          <div class="info-item">
            <div class="label">Ø§Ù„Ø¹Ù†ÙˆØ§Ù†</div>
            <div class="value">${esc(o.city)}</div>
          </div>
          <div class="info-item">
            <div class="label">Ø§Ù„Ù…Ù†ØªØ¬</div>
            <div class="value" style="color:var(--primary)">${esc(o.offer)}</div>
          </div>
          <div class="info-item">
            <div class="label">Ø§Ù„Ù…Ø¨Ù„Øº Ø§Ù„Ù…Ø³ØªØ­Ù‚</div>
            <div class="price-tag">â‚ª${esc(o.price || '0')}</div>
            <div class="label">${esc(o.payment)}</div>
          </div>
        </div>

        <div class="card-actions">
          <button class="btn btn-primary" onclick="printLabel(${o.rowIndex})">ğŸ–¨ï¸ Ø·Ø¨Ø§Ø¹Ø© Ø§Ù„Ù…Ù„ØµÙ‚</button>
          <button class="btn btn-success" onclick="markReady(${o.rowIndex})">âœ… ØªÙ… Ø§Ù„ØªØ¬Ù‡ÙŠØ²</button>
        </div>

        <div class="secondary-actions">
          <button class="btn btn-ghost" onclick="copySummary(${o.rowIndex})">ğŸ“‹ Ù†Ø³Ø®</button>
          <button class="btn btn-outline" style="font-size:0.8rem" onclick="alert('Ø´Ø±ÙƒØ© Ø§Ù„Ø´Ø­Ù†: ${esc(o.delivery)}')">â„¹ï¸ ØªÙØ§ØµÙŠÙ„ Ø§Ù„Ø´Ø­Ù†</button>
        </div>
      </div>
    `).join("");
  }

  async function markReady(row){
    if(!confirm("Ù‡Ù„ Ø£Ù†Øª Ù…ØªØ£ÙƒØ¯ Ù…Ù† Ù†Ù‚Ù„ Ø§Ù„Ø·Ù„Ø¨ Ù„Ù‚Ø§Ø¦Ù…Ø© (Ø§Ù„Ù…Ø¬Ù‡Ø²)ØŸ")) return;
    const status = "READY âœ… (Ù…Ø¬Ù‡Ø²)";
    const url = `${SCRIPT_URL}?action=updateStatus&key=${encodeURIComponent(DASH_KEY)}&row=${row}&status=${encodeURIComponent(status)}`;
    
    // UI Feedback
    const card = document.getElementById("c"+row);
    card.style.opacity = "0.4";
    card.style.pointerEvents = "none";

    await fetch(url);
    await load();
  }

  function printLabel(row){
    const o = orders.find(x => x.rowIndex == row);
    const pa = document.getElementById("printArea");
    const isHeb = /[\u0590-\u05FF]/.test(o.name);
    
    pa.innerHTML = `
      <div class="labelSheet" dir="rtl">
        <div class="lp1">MAD PARFUMEUR</div>
        <div class="lp2">${isHeb ? '×”×–×× ×”' : 'Ø·Ù„Ø¨'}: ${esc(o.orderId)}</div>
        <div style="margin:2mm 0; border-top:1px dashed #000"></div>
        <div class="lp2">${esc(o.name)}</div>
        <div class="lp3">${esc(o.phone)}</div>
        <div class="lp3">${esc(o.city)} | ${esc(o.addr || '')}</div>
        <div class="lp2" style="margin-top:2mm">${esc(o.offer)}</div>
        <div class="lp2">â‚ª${esc(o.price)} (${esc(o.payment)})</div>
      </div>
    `;
    window.print();
  }

  function copySummary(row){
    const o = orders.find(x => x.rowIndex == row);
    const txt = `Order: ${o.orderId}\nName: ${o.name}\nPhone: ${o.phone}\nOffer: ${o.offer}\nPrice: ${o.price}`;
    navigator.clipboard.writeText(txt);
    alert("ØªÙ… Ù†Ø³Ø® Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª");
  }

  function esc(s){
    if(!s) return "â€”";
    return String(s).replace(/[&<>"']/g, m => ({ "&":"&amp;","<":"&lt;",">":"&gt;",'"':"&quot;","'":"&#39;" }[m]));
  }
</script>
</body>
</html>
