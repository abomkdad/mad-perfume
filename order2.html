<!doctype html>
<html lang="he" dir="rtl">
<head>
  <meta charset="utf-8"/>
  <title>MAD SYSTEM v5.2 | Final Stable</title>
  
  <script src="https://cdn.jsdelivr.net/npm/jsbarcode@3.11.5/dist/JsBarcode.all.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/qrcodejs@1.0.0/qrcode.min.js"></script>
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">

  <style>
    :root { --bg: #0f172a; --card: #1e293b; --blue: #3b82f6; --text: #f8fafc; --green: #10b981; --red: #ef4444; }
    body { font-family: system-ui, sans-serif; background: var(--bg); color: var(--text); margin: 0; direction: rtl; }
    
    header { background: var(--card); padding: 15px 25px; display: flex; justify-content: space-between; align-items: center; border-bottom: 2px solid #334155; position: sticky; top: 0; z-index: 100; }
    
    .search-box { flex: 1; max-width: 400px; position: relative; margin: 0 20px; }
    .search-box input { width: 100%; padding: 10px 15px; border-radius: 8px; border: 1px solid #334155; background: #0f172a; color: white; font-size: 16px; }

    .grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(320px, 1fr)); gap: 20px; padding: 20px; }
    
    /* ØªØµÙ…ÙŠÙ… Ø§Ù„Ø¨Ø·Ø§Ù‚Ø© Ø§Ù„Ø¬Ø¯ÙŠØ¯ */
    .card { background: var(--card); border-radius: 15px; overflow: hidden; border: 1px solid #334155; transition: 0.3s; position: relative; display: flex; flex-direction: column; }
    .card:hover { border-color: var(--blue); transform: translateY(-5px); box-shadow: 0 10px 20px rgba(0,0,0,0.3); }
    .card.selected { border: 2px solid var(--blue); background: #263345; }

    .card-content { padding: 15px; flex-grow: 1; }
    .card-id { font-size: 12px; color: #94a3b8; font-weight: bold; }
    .card-name { font-size: 22px; font-weight: bold; margin: 5px 0; color: #fff; }
    .card-detail { font-size: 14px; color: #cbd5e1; margin: 5px 0; display: flex; align-items: center; gap: 8px; }
    
    .card-price { font-size: 26px; font-weight: 900; color: var(--green); margin-top: 10px; padding-top: 10px; border-top: 1px dashed #334155; }

    /* Ø£Ø²Ø±Ø§Ø± Ø§Ù„ØªØ­ÙƒÙ… Ø£Ø³ÙÙ„ Ø§Ù„Ø¨Ø·Ø§Ù‚Ø© */
    .card-actions { display: grid; grid-template-columns: 1fr 1fr 1fr; border-top: 1px solid #334155; background: #161e2e; }
    .btn-action { border: none; background: transparent; color: #cbd5e1; padding: 12px 5px; cursor: pointer; font-size: 13px; transition: 0.2s; display: flex; flex-direction: column; align-items: center; gap: 5px; border-left: 1px solid #334155; }
    .btn-action:last-child { border-left: none; }
    .btn-action:hover { background: #1e293b; color: #fff; }
    
    .btn-print:hover { color: var(--blue); }
    .btn-edit:hover { color: #fbbf24; }
    .btn-select:hover { color: var(--green); }
    .card.selected .btn-select { background: var(--blue); color: white; }

    .bulk-bar { position: fixed; bottom: 20px; left: 50%; transform: translateX(-50%); background: white; color: black; padding: 15px 30px; border-radius: 50px; display: none; align-items: center; gap: 20px; box-shadow: 0 10px 30px rgba(0,0,0,0.5); z-index: 1000; }
    .bulk-bar.active { display: flex; }

    @media print {
      body * { visibility: hidden; }
      #printArea, #printArea * { visibility: visible; }
      #printArea { position: absolute; left: 0; top: 0; width: 100%; display: block !important; }
      @page { size: 100mm 100mm; margin: 0; }
      .label { width: 100mm; height: 100mm; padding: 5mm; background: white !important; color: black !important; display: flex; flex-direction: column; page-break-after: always; border: 1px solid #000; box-sizing: border-box; }
    }
    #printArea { display: none; }
  </style>
</head>
<body>

<header>
  <div style="font-size: 24px; font-weight: 900;">MAD <span style="color:var(--blue)">V5.2</span></div>
  
  <div class="search-box">
    <input type="text" id="searchInput" placeholder="×—×™×¤×•×© ×œ×¤×™ ×©× ××• ×˜×œ×¤×•×Ÿ..." oninput="app.render()">
  </div>

  <button onclick="app.loadData()" style="background: var(--blue); color: white; border: none; padding: 10px 20px; border-radius: 8px; cursor: pointer; font-weight: bold;">
    ×¨×¢× ×Ÿ × ×ª×•× ×™× â†»
  </button>
</header>

<div id="debugStatus" style="background: #334155; font-size: 12px; padding: 5px 20px; text-align: center;">×˜×•×¢×Ÿ...</div>

<div class="grid" id="grid"></div>

<div class="bulk-bar" id="bulkBar">
  <span id="selectedCount" style="font-weight: bold;">0 × ×‘×—×¨×•</span>
  <button onclick="app.printSelected()" style="background: #000; color: #fff; border: none; padding: 8px 20px; border-radius: 20px; cursor: pointer; font-weight: bold;">×”×“×¤×¡ ×”×›×œ ğŸ–¨ï¸</button>
  <button onclick="app.clearSelection()" style="background: none; border: none; text-decoration: underline; cursor: pointer;">×‘×™×˜ÙˆÙ„</button>
</div>

<div id="printArea"></div>

<script>
class MadSystem {
  constructor() {
    this.scriptUrl = "https://script.google.com/macros/s/AKfycbyLjLFa8AaH82Ip7m747WC-KSUUEaU_M70S0I9Mda14XbnmcuEfZ7pBnF_zzJYZuXmZ/exec";
    this.orders = [];
    this.selected = new Set();
    this.loadData();
  }

  async loadData() {
    const debug = document.getElementById('debugStatus');
    debug.innerHTML = "×× ×¡×” ×œ×”×ª×—×‘×¨ Ù„-Google Sheets...";
    try {
      const res = await fetch(`${this.scriptUrl}?action=get`);
      this.orders = await res.json();
      debug.innerHTML = this.orders.length > 0 ? `âœ… × ××¦××• ${this.orders.length} ×”×–×× ×•×ª` : `âš ï¸ ×”×˜×‘×œ×” ×¨×™×§×”`;
      this.render();
    } catch (e) {
      debug.innerHTML = `âŒ ×©×’×™××ª ×”×ª×—×‘×¨×•×ª ×œ× ×ª×•× ×™×`;
    }
  }

  fixLang(val) {
    if(!val) return "";
    const map = { "cash": "××–×•××Ÿ", "credit": "××©×¨×ÙŠ", "bit": "×‘×™×˜", "pending": "×××ª×™×Ÿ" };
    return map[val.toString().toLowerCase().trim()] || val;
  }

  render() {
    const query = document.getElementById('searchInput').value.toLowerCase().replace(/[-\s]/g, "");
    const grid = document.getElementById('grid');
    
    const filtered = this.orders.filter(o => {
      const name = String(o.name || o.customer || "").toLowerCase();
      const phone = String(o.phone || o.tel || "").replace(/[-\s]/g, "");
      return name.includes(query) || phone.includes(query);
    });

    grid.innerHTML = filtered.map(o => {
      const idx = this.orders.indexOf(o);
      const isSelected = this.selected.has(idx);
      return `
        <div class="card ${isSelected ? 'selected' : ''}">
          <div class="card-content">
            <div class="card-id">#${o.orderId || o.id || '---'}</div>
            <div class="card-name">${o.name || o.customer || '×œ×œ× ×©×'}</div>
            <div class="card-detail"><i class="fas fa-phone"></i> ${o.phone || o.tel || '---'}</div>
            <div class="card-detail"><i class="fas fa-map-marker-alt"></i> ${this.fixLang(o.city || o.address)}</div>
            <div class="card-detail"><i class="fas fa-credit-card"></i> ${this.fixLang(o.payment)}</div>
            <div class="card-price">â‚ª${o.price || '0'}</div>
          </div>
          
          <div class="card-actions">
            <button class="btn-action btn-print" onclick="app.printSingle(${idx})">
              <i class="fas fa-print"></i> ×”×“×¤×¡×”
            </button>
            <button class="btn-action btn-edit" onclick="app.editOrder(${idx})">
              <i class="fas fa-edit"></i> ×¢×¨×™×›×”
            </button>
            <button class="btn-action btn-select" onclick="app.toggleSelect(${idx})">
              <i class="fas ${isSelected ? 'fa-check-circle' : 'fa-plus-circle'}"></i> 
              ${isSelected ? '× ×‘×—×¨' : '×‘×—×¨'}
            </button>
          </div>
        </div>
      `;
    }).join("");
  }

  toggleSelect(idx) {
    this.selected.has(idx) ? this.selected.delete(idx) : this.selected.add(idx);
    this.updateBulkBar();
    this.render();
  }

  updateBulkBar() {
    const bar = document.getElementById('bulkBar');
    document.getElementById('selectedCount').innerText = `${this.selected.size} ×”×–×× ×•×ª × ×‘×—×¨×•`;
    this.selected.size > 0 ? bar.classList.add('active') : bar.classList.remove('active');
  }

  clearSelection() {
    this.selected.clear();
    this.updateBulkBar();
    this.render();
  }

  printSingle(idx) {
    const o = this.orders[idx];
    const area = document.getElementById('printArea');
    area.innerHTML = this.generateLabel(o);
    setTimeout(() => { window.print(); }, 300);
  }

  editOrder(idx) {
    const o = this.orders[idx];
    alert("×¢×¨×™×›×ª ×”×–×× ×” #" + (o.orderId || o.id) + "\n(× ×™×ª×Ÿ ×œ×”×•×¡×™×£ ×›××Ÿ ×˜×•×¤×¡ ×¢×¨×™×›×”)");
    // Ù‡Ù†Ø§ ÙŠÙ…ÙƒÙ†Ùƒ ÙØªØ­ Ù†Ø§ÙØ°Ø© Modal Ù„ØªØ¹Ø¯ÙŠÙ„ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª
  }

  printSelected() {
    const area = document.getElementById('printArea');
    const list = Array.from(this.selected).map(idx => this.orders[idx]);
    area.innerHTML = list.map(o => this.generateLabel(o)).join("");
    setTimeout(() => {
      window.print();
      this.clearSelection();
    }, 500);
  }

  generateLabel(o) {
    return `
      <div class="label" dir="rtl">
        <div style="display:flex; justify-content:space-between; border-bottom:2px solid black; padding-bottom:5px;">
          <b style="font-size:20pt;">MAD PARFUM</b>
          <span>#${o.orderId || o.id || ''}</span>
        </div>
        <div style="font-size:16pt; margin-top:10px;"><b>×œ×›×‘×•×“:</b> ${o.name || o.customer || ''}</div>
        <div style="font-size:16pt;"><b>×˜×œà¦«à§‹à¦¨:</b> ${o.phone || o.tel || ''}</div>
        <div style="font-size:16pt;"><b>×¢×™×¨:</b> ${this.fixLang(o.city || o.address)}</div>
        <div style="font-size:16pt;"><b>×ª×©×œ×•×:</b> ${this.fixLang(o.payment)}</div>
        <div style="border:4px solid black; font-size:38pt; font-weight:900; text-align:center; margin-top:auto; border-radius:10px;">
          â‚ª${o.price || '0'}
        </div>
      </div>
    `;
  }
}

const app = new MadSystem();
</script>
</body>
</html>
