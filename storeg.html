<!doctype html>
<html lang="ar" dir="rtl">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1,maximum-scale=1,user-scalable=no" />
  <title>MAD | Catalog</title>
  <meta name="description" content="MAD Parfumeur Catalog - Live from Google Sheets" />

  <!-- Fonts (Ø®ÙÙŠÙ) -->
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Cairo:wght@400;700;800;900&family=Assistant:wght@400;700;800&display=swap" rel="stylesheet">

  <style>
    :root{
      --bg:#0b0b0d;
      --card:#121217;
      --muted:#a7a7b6;
      --text:#f4f4f8;
      --line:rgba(255,255,255,.08);
      --accent:#2dd4bf;
      --accent2:#f59e0b;
      --danger:#fb7185;
      --ok:#34d399;
      --shadow: 0 18px 45px rgba(0,0,0,.35);
      --radius:18px;
    }
    *{box-sizing:border-box}
    body{
      margin:0;
      font-family:"Cairo","Assistant",system-ui,-apple-system,Segoe UI,Roboto,Arial,sans-serif;
      background:
        radial-gradient(1200px 600px at 70% -10%, rgba(245,158,11,.12), transparent 60%),
        radial-gradient(900px 500px at 10% 0%, rgba(45,212,191,.10), transparent 55%),
        var(--bg);
      color:var(--text);
    }
    a{color:inherit;text-decoration:none}
    .wrap{max-width:1200px;margin:0 auto;padding:18px}
    .topbar{
      position:sticky; top:0; z-index:50;
      backdrop-filter: blur(12px);
      background: rgba(11,11,13,.68);
      border-bottom:1px solid var(--line);
    }
    .topbar-inner{
      display:flex; gap:12px; align-items:center; justify-content:space-between;
      padding:14px 18px;
      max-width:1200px;margin:0 auto;
    }
    .brand{
      display:flex; gap:10px; align-items:center;
      min-width: 220px;
    }
    .logo{
      width:40px;height:40px;border-radius:12px;
      background:
        radial-gradient(16px 16px at 30% 35%, rgba(255,255,255,.20), transparent 60%),
        linear-gradient(135deg, rgba(245,158,11,.85), rgba(45,212,191,.55));
      box-shadow: var(--shadow);
      border:1px solid rgba(255,255,255,.10);
      flex:0 0 auto;
    }
    .brand h1{margin:0;font-size:16px;line-height:1.1;font-weight:900;letter-spacing:.4px}
    .brand .sub{font-size:12px;color:var(--muted);margin-top:2px}
    .controls{
      display:flex; gap:10px; align-items:center; flex:1;
      justify-content:center;
    }
    .search{
      flex:1; max-width:520px; position:relative;
    }
    .search input{
      width:100%;
      padding:12px 42px 12px 12px;
      border-radius:14px;
      background: rgba(255,255,255,.06);
      border:1px solid var(--line);
      color:var(--text);
      outline:none;
    }
    .search input::placeholder{color:rgba(255,255,255,.45)}
    .search .icon{
      position:absolute; right:12px; top:50%; transform:translateY(-50%);
      opacity:.75; font-size:16px;
    }
    .pill{
      display:inline-flex; gap:8px; align-items:center;
      padding:10px 12px;
      border-radius:14px;
      border:1px solid var(--line);
      background: rgba(255,255,255,.06);
      color:var(--text);
      cursor:pointer;
      user-select:none;
      white-space:nowrap;
    }
    .pill input{accent-color: var(--accent)}
    select.pill{
      padding:10px 12px;
      appearance:none;
      -webkit-appearance:none;
    }

    .cats{
      display:flex; gap:10px; align-items:center;
      overflow:auto;
      padding:12px 18px 14px;
      max-width:1200px;margin:0 auto;
    }
    .cat{
      flex:0 0 auto;
      padding:9px 12px;
      border-radius:999px;
      border:1px solid var(--line);
      background: rgba(255,255,255,.05);
      color:rgba(255,255,255,.88);
      cursor:pointer;
      transition:.15s transform,.15s background,.15s border-color;
      font-weight:800;
      font-size:13px;
    }
    .cat:hover{transform:translateY(-1px);background:rgba(255,255,255,.08)}
    .cat.active{
      background: rgba(45,212,191,.14);
      border-color: rgba(45,212,191,.35);
      color: #eafffb;
    }

    .meta{
      display:flex; gap:12px; align-items:center; justify-content:space-between;
      margin:14px 0 10px;
      color:var(--muted);
      font-size:13px;
    }
    .grid{
      display:grid;
      grid-template-columns: repeat(4, minmax(0,1fr));
      gap:14px;
      padding-bottom:30px;
    }
    @media (max-width:1100px){ .grid{grid-template-columns:repeat(3,1fr)} .brand{min-width:200px}}
    @media (max-width:820px){ .grid{grid-template-columns:repeat(2,1fr)} .brand{min-width:auto} .controls{justify-content:flex-end} }
    @media (max-width:520px){ .grid{grid-template-columns:1fr} .controls{flex-direction:column; align-items:stretch} .search{max-width:none} }

    .card{
      border:1px solid var(--line);
      border-radius: var(--radius);
      background: linear-gradient(180deg, rgba(255,255,255,.06), rgba(255,255,255,.03));
      box-shadow: var(--shadow);
      overflow:hidden;
      display:flex;
      flex-direction:column;
      min-height: 320px;
    }
    .imgbox{
      position:relative;
      aspect-ratio: 4/3;
      background: rgba(0,0,0,.25);
      border-bottom:1px solid var(--line);
      overflow:hidden;
    }
    .imgbox img{
      width:100%;
      height:100%;
      object-fit:contain;
      display:block;
      filter: drop-shadow(0 10px 22px rgba(0,0,0,.35));
      transform: translateZ(0);
    }
    .badges{
      position:absolute; top:10px; left:10px;
      display:flex; gap:8px; flex-wrap:wrap;
      max-width: calc(100% - 20px);
    }
    .badge{
      padding:6px 10px;
      border-radius:999px;
      font-size:12px;
      font-weight:900;
      border:1px solid rgba(255,255,255,.12);
      background: rgba(0,0,0,.35);
      backdrop-filter: blur(10px);
    }
    .badge.gold{border-color: rgba(245,158,11,.45); background: rgba(245,158,11,.12)}
    .badge.sale{border-color: rgba(45,212,191,.45); background: rgba(45,212,191,.10)}
    .badge.out{border-color: rgba(251,113,133,.45); background: rgba(251,113,133,.10)}
    .content{
      padding:12px 12px 14px;
      display:flex;
      flex-direction:column;
      gap:10px;
      flex:1;
    }
    .title{
      display:flex;
      justify-content:space-between;
      gap:10px;
      align-items:flex-start;
    }
    .code{
      font-weight:900;
      font-size:16px;
      line-height:1.2;
      letter-spacing:.2px;
      word-break:break-word;
    }
    .catname{
      font-size:12px;
      color:var(--muted);
      margin-top:2px;
      font-weight:800;
      text-transform:uppercase;
      letter-spacing:.6px;
    }
    .price{
      text-align:left;
      font-weight:900;
      font-size:16px;
      color:#fef3c7;
      white-space:nowrap;
    }
    .price small{
      display:block;
      font-size:11px;
      color:rgba(255,255,255,.55);
      font-weight:800;
      margin-top:3px;
    }
    .row{
      display:flex; gap:10px; align-items:center; justify-content:space-between;
      color:var(--muted);
      font-size:13px;
    }
    .hint{
      padding:9px 10px;
      border-radius:14px;
      background: rgba(255,255,255,.05);
      border:1px solid var(--line);
      color: rgba(255,255,255,.78);
      font-size:13px;
      line-height:1.35;
      min-height: 38px;
    }
    .actions{
      margin-top:auto;
      display:flex; gap:10px;
    }
    .btn{
      flex:1;
      padding:11px 12px;
      border-radius:14px;
      border:1px solid rgba(255,255,255,.10);
      background: rgba(255,255,255,.06);
      color:var(--text);
      font-weight:900;
      cursor:pointer;
      transition:.15s transform,.15s background,.15s border-color,.15s opacity;
    }
    .btn:hover{transform:translateY(-1px); background: rgba(255,255,255,.09)}
    .btn.wa{
      background: linear-gradient(135deg, rgba(45,212,191,.18), rgba(245,158,11,.12));
      border-color: rgba(45,212,191,.30);
    }
    .btn:disabled{
      opacity:.45;
      cursor:not-allowed;
      transform:none;
    }

    .notice{
      margin:18px 0 12px;
      padding:12px 14px;
      border-radius:16px;
      border:1px solid var(--line);
      background: rgba(255,255,255,.05);
      color: rgba(255,255,255,.85);
      line-height:1.5;
    }
    .notice b{color:#fff}
    .footer{
      padding:18px 0 38px;
      color:rgba(255,255,255,.45);
      font-size:12px;
      text-align:center;
    }
  </style>

  <!-- âœ… (Ø§Ø®ØªÙŠØ§Ø±ÙŠ) Meta + TikTok Pixel: Ø®Ù„ÙŠ ØªØªØ¨Ø¹Ùƒ Lead ÙÙ‚Ø· Ø¹Ù†Ø¯ Ø§Ù„Ø¶ØºØ· Ø¹Ù„Ù‰ Ø²Ø± ÙˆØ§ØªØ³Ø§Ø¨ -->
  <!--
  <script>
    !function(f,b,e,v,n,t,s){if(f.fbq)return;n=f.fbq=function(){n.callMethod?
    n.callMethod.apply(n,arguments):n.queue.push(arguments)};if(!f._fbq)f._fbq=n;
    n.push=n;n.loaded=!0;n.version='2.0';n.queue=[];t=b.createElement(e);t.async=!0;
    t.src=v;s=b.getElementsByTagName(e)[0];s.parentNode.insertBefore(t,s)}(window,document,'script',
    'https://connect.facebook.net/en_US/fbevents.js');
    fbq('init','YOUR_PIXEL_ID');
    fbq('track','PageView');
  </script>
  <script>
    !function (w, d, t) {
      w.TiktokAnalyticsObject=t;var ttq=w[t]=w[t]||[];ttq.methods=
      ["page","track","identify","instances","debug","on","off","once","ready","alias","group","enableCookie","disableCookie"];
      ttq.setAndDefer=function(t,e){t[e]=function(){t.push([e].concat(Array.prototype.slice.call(arguments,0)))}};
      for(var i=0;i<ttq.methods.length;i++)ttq.setAndDefer(ttq,ttq.methods[i]);
      ttq.instance=function(t){for(var e=ttq._i[t]||[],n=0;n<ttq.methods.length;n++)ttq.setAndDefer(e,ttq.methods[n]);return e};
      ttq.load=function(e,n){var i="https://analytics.tiktok.com/i18n/pixel/events.js";ttq._i=ttq._i||{};
      ttq._i[e]=[];ttq._i[e]._u=i;ttq._t=ttq._t||{};ttq._t[e]=+new Date;ttq._o=ttq._o||{};
      ttq._o[e]=n||{};var o=document.createElement("script");o.type="text/javascript";o.async=!0;o.src=i+"?sdkid="+e+"&lib="+t;
      var a=document.getElementsByTagName("script")[0];a.parentNode.insertBefore(o,a)};
      ttq.load('YOUR_TIKTOK_PIXEL_ID'); ttq.page();
    }(window, document, 'ttq');
  </script>
  -->
</head>

<body>
  <div class="topbar">
    <div class="topbar-inner">
      <div class="brand">
        <div class="logo" aria-hidden="true"></div>
        <div>
          <h1>MAD | Catalog</h1>
          <div class="sub" id="subline">Live from Google Sheets</div>
        </div>
      </div>

      <div class="controls">
        <div class="search">
          <span class="icon">âŒ•</span>
          <input id="q" type="search" placeholder="Ø§Ø¨Ø­Ø« Ø¨Ø§Ù„ÙƒÙˆØ¯ Ø£Ùˆ Ø§Ù„Ø§Ø³Ù…... (Ù…Ø«Ø§Ù„: A115 / GOLD / Bruno)" autocomplete="off" />
        </div>

        <label class="pill" title="Ø¹Ø±Ø¶ Ø§Ù„Ù…ØªÙˆÙØ± ÙÙ‚Ø·">
          <input id="inStockOnly" type="checkbox" />
          <span>Ù…ØªÙˆÙØ± ÙÙ‚Ø·</span>
        </label>

        <select id="sort" class="pill" title="ØªØ±ØªÙŠØ¨">
          <option value="smart">ØªØ±ØªÙŠØ¨ Ø°ÙƒÙŠ</option>
          <option value="code">Ø­Ø³Ø¨ Ø§Ù„ÙƒÙˆØ¯</option>
          <option value="priceAsc">Ø§Ù„Ø³Ø¹Ø± â†‘</option>
          <option value="priceDesc">Ø§Ù„Ø³Ø¹Ø± â†“</option>
          <option value="qtyDesc">Ø§Ù„Ù…Ø®Ø²ÙˆÙ† â†“</option>
        </select>
      </div>
    </div>

    <div class="cats" id="cats"></div>
  </div>

  <div class="wrap">
    <div class="notice" id="notice">
      <b>Ø¬Ø§Ù‡Ø².</b> Ù‡Ø°Ø§ Ø§Ù„Ù†Ø¸Ø§Ù… ÙŠÙ‚Ø±Ø£ Ø§Ù„Ù…Ù†ØªØ¬Ø§Øª Ù…Ø¨Ø§Ø´Ø±Ø© Ù…Ù† Ø§Ù„Ø´ÙŠØª ÙˆÙŠØ¹Ø±Ø¶Ù‡Ø§ Ù‡Ù†Ø§.
      Ø¥Ø°Ø§ Ø¨Ø¯Ùƒ Ø±Ù‚Ù… ÙˆØ§ØªØ³Ø§Ø¨ Ù„Ù„ÙØ±Ø¹ Ø¨Ø§Ù„Ø±Ø§Ø¨Ø·: <b>?phone=9725XXXXXXX</b>
    </div>

    <div class="meta">
      <div id="metaLeft">...</div>
      <div id="metaRight"></div>
    </div>

    <div class="grid" id="grid"></div>

    <div class="footer">
      Â© MAD â€” Live Catalog (No Backend)
    </div>
  </div>

  <script>
    /***********************
     * âœ… CONFIG
     ***********************/
    const CONFIG = {
      SHEET_ID: "PUT_YOUR_SHEET_ID_HERE",
      GID: "0",
      DEFAULT_WA_PHONE: "972500000000", // Ø¨Ø¯ÙˆÙ† +
      CACHE_KEY: "mad_catalog_cache_v1",
      CACHE_TTL_MS: 10 * 60 * 1000, // 10 Ø¯Ù‚Ø§Ø¦Ù‚
      PLACEHOLDER_IMG: "data:image/svg+xml;charset=utf-8," + encodeURIComponent(`
        <svg xmlns="http://www.w3.org/2000/svg" width="800" height="600">
          <defs>
            <linearGradient id="g" x1="0" x2="1" y1="0" y2="1">
              <stop stop-color="#f59e0b" stop-opacity="0.45"/>
              <stop offset="1" stop-color="#2dd4bf" stop-opacity="0.35"/>
            </linearGradient>
          </defs>
          <rect width="100%" height="100%" fill="#0b0b0d"/>
          <rect x="40" y="40" width="720" height="520" rx="28" fill="url(#g)" opacity="0.35"/>
          <text x="50%" y="50%" fill="rgba(255,255,255,.85)" font-size="34" font-family="Arial" text-anchor="middle" dominant-baseline="middle">
            MAD â€¢ Image Missing
          </text>
        </svg>
      `)
    };

    /***********************
     * Helpers
     ***********************/
    const $ = (sel) => document.querySelector(sel);

    function getParam(name, fallback=null){
      const u = new URL(location.href);
      return u.searchParams.get(name) ?? fallback;
    }

    function safeText(v){
      if(v === null || v === undefined) return "";
      return String(v).replace(/\s+/g, " ").trim();
    }

    function normCode(code){
      // ØªÙ†Ø¸ÙŠÙ Ø§Ù„ÙƒÙˆØ¯: Ø¥Ø²Ø§Ù„Ø© Ù…Ø³Ø§ÙØ§Øª Ø²Ø§Ø¦Ø¯Ø© + ØªÙˆØ­ÙŠØ¯
      let c = safeText(code);
      c = c.replace(/\u200f|\u200e/g, ""); // remove RTL marks if any
      c = c.replace(/\s+/g, " ").trim();
      return c;
    }

    function toNumber(x){
      const n = Number(x);
      return Number.isFinite(n) ? n : null;
    }

    function money(n){
      if(n === null || n === undefined) return "";
      // ILS formatting Ø¨Ø³ÙŠØ·
      return "â‚ª" + Math.round(n).toString();
    }

    function trackLead(source){
      // âœ… Ù†Ø±Ø³Ù„ Lead ÙÙ‚Ø· Ø¹Ù†Ø¯ Ø§Ù„Ø¶ØºØ· Ø¹Ù„Ù‰ ÙˆØ§ØªØ³Ø§Ø¨ (Ø­Ø³Ø¨ Ø·Ù„Ø¨Ùƒ)
      try{ if(window.fbq) fbq('track','Lead',{source}); }catch(e){}
      try{ if(window.ttq) ttq.track('Lead',{source}); }catch(e){}
    }

    /***********************
     * GViz Fetch + Parse
     ***********************/
    function buildGvizUrl(){
      const tq = encodeURIComponent("select A,B,C,D,E,F,I,L,M,K"); // Ù†Ø¬ÙŠØ¨ Ø£Ø¹Ù…Ø¯Ø© Ù…Ù‡Ù…Ø© + K ÙƒÙ†Ø³Ø®Ø© ÙƒÙˆØ¯ Ø§Ø­ØªÙŠØ§Ø·
      return `https://docs.google.com/spreadsheets/d/${CONFIG.SHEET_ID}/gviz/tq?gid=${CONFIG.GID}&tq=${tq}`;
    }

    function parseGvizResponse(text){
      // Ø§Ù„Ù†Øµ Ø¹Ù†Ø¯Ùƒ ÙŠØ¨Ø¯Ø£ Ø¨Ù€ /*O_o*/ Ø«Ù… google.visualization.Query.setResponse(...)
      const start = text.indexOf("setResponse(");
      if(start === -1) throw new Error("GViz response not found");
      const jsonStart = text.indexOf("{", start);
      const jsonEnd = text.lastIndexOf("})");
      const payload = text.slice(jsonStart, jsonEnd+1);
      const data = JSON.parse(payload);

      const cols = data.table.cols || [];
      const rows = data.table.rows || [];

      // Map col id => index
      const idx = {};
      cols.forEach((c, i) => { idx[c.id] = i; });

      const getCell = (r, colId) => {
        const i = idx[colId];
        if(i === undefined) return null;
        const cell = r.c?.[i];
        return cell?.v ?? null;
      };

      const items = [];
      for(const r of rows){
        // Ø£Ø³Ø§Ø³ÙŠ: A ÙƒÙˆØ¯ØŒ B ÙƒØ§ØªÙŠØ¬ÙˆØ±ÙŠ/ÙˆØµÙØŒ C Ø³Ø¹Ø± Ø¯Ø§Ø®Ù„ÙŠØŒ D ØµÙˆØ±Ø©ØŒ F Ø³Ø¹Ø± Ù…ÙˆÙ‚Ø¹ØŒ I ÙƒÙ…ÙŠØ©ØŒ L Ù…Ù„Ø§Ø­Ø¸Ø© (Ø¹Ø±Ø¶/Ø®Ø§Ù„Øµ)
        const codeA = getCell(r, "A");
        const codeK = getCell(r, "K");
        const code = normCode(codeA || codeK);

        const cat = safeText(getCell(r, "B")).toUpperCase() || "OTHER";
        const price = toNumber(getCell(r, "C"));
        const img = safeText(getCell(r, "D"));
        const websitePrice = toNumber(getCell(r, "F"));
        const qty = toNumber(getCell(r, "I"));
        const note = safeText(getCell(r, "L"));
        const expiry = safeText(getCell(r, "M"));

        // ØªØ¬Ø§Ù‡Ù„ ØµÙÙˆÙ Ù…ÙƒØ³ÙˆØ±Ø© (Ù…Ø«Ù„ ØµÙ ÙÙŠÙ‡ Ø¹Ù…ÙˆØ¯ D Ù…Ø­Ø´ÙŠ Ù†Øµ ØªØ§Ø¨ ÙƒØ§Ù…Ù„)
        // Ø¥Ø°Ø§ Ø±Ø§Ø¨Ø· Ø§Ù„ØµÙˆØ±Ø© ÙŠØ­ØªÙˆÙŠ \t Ø£Ùˆ "WOMEN\t" Ù†Ø¹ØªØ¨Ø±Ù‡ ÙØ§Ø³Ø¯
        if(img.includes("\t") || img.includes("WOMEN\t") || img.includes("MEN\t") || img.length > 400){
          // Ù†Ø­Ø§ÙˆÙ„ Ù†ØµÙ„Ø­: Ø¥Ø°Ø§ ÙÙŠÙ‡ "http" Ø¯Ø§Ø®Ù„ Ø§Ù„Ù†Øµ Ù†Ù‚ØªØ·Ø¹ Ø£ÙˆÙ„ Ø±Ø§Ø¨Ø·
          const m = img.match(/https?:\/\/\S+/);
          const fixedImg = m ? m[0].trim() : "";
          if(!fixedImg){
            // Ø¥Ø°Ø§ Ù…Ø§ Ù‚Ø¯Ø±Ù†Ø§ Ù†ØµÙ„Ø­Ù‡ØŒ Ù†Ø®Ù„ÙŠ ØµÙˆØ±Ø© placeholder
          }
        }

        const finalImg = (img && !img.includes("\t") && img.startsWith("http")) ? img : CONFIG.PLACEHOLDER_IMG;

        const isGold = /GOLD|Ø°Ù‡Ø¨ÙŠ/i.test(code) || /Ø°Ù‡Ø¨ÙŠ/i.test(note);
        const isSale = /Ø§Ø¹Ù…Ù„Ùˆ Ø¹Ù„ÙŠ Ø¹Ø±Ø¶|Ø¹Ø±Ø¶/i.test(note);
        const isOut = (qty !== null && qty <= 0) || /Ø®Ø§Ù„Øµ/i.test(note);

        if(!code && !finalImg) continue;

        items.push({
          code,
          category: cat || "OTHER",
          price,
          websitePrice,
          qty: qty ?? null,
          note,
          expiry,
          img: finalImg,
          flags: { gold:isGold, sale:isSale, out:isOut }
        });
      }

      // Ø­Ø°Ù ØªÙƒØ±Ø§Ø±Ø§Øª (Ø¥Ù† ÙˆØ¬Ø¯Øª) Ø­Ø³Ø¨ code + category
      const seen = new Set();
      const unique = [];
      for(const p of items){
        const key = (p.category + "|" + p.code).toLowerCase();
        if(seen.has(key)) continue;
        seen.add(key);
        unique.push(p);
      }
      return unique;
    }

    async function loadProducts(){
      // Cache
      try{
        const cached = JSON.parse(localStorage.getItem(CONFIG.CACHE_KEY) || "null");
        if(cached && cached.t && (Date.now()-cached.t) < CONFIG.CACHE_TTL_MS && Array.isArray(cached.items)){
          return cached.items;
        }
      }catch(e){}

      const url = buildGvizUrl();
      const res = await fetch(url, { cache: "no-store" });
      const text = await res.text();
      const items = parseGvizResponse(text);

      try{
        localStorage.setItem(CONFIG.CACHE_KEY, JSON.stringify({ t: Date.now(), items }));
      }catch(e){}

      return items;
    }

    /***********************
     * UI State
     ***********************/
    let ALL = [];
    let ACTIVE_CAT = "ALL";

    function catOrderKey(cat){
      // ØªØ±ØªÙŠØ¨Ùƒ: NISHE Ø£ÙˆÙ„Ø§Ù‹ Ø«Ù… MEN Ø«Ù… WOMEN Ø«Ù… Ø§Ù„Ø¨Ø§Ù‚ÙŠ
      if(cat === "NISHE" || cat === "NICHE") return 1;
      if(cat === "MEN") return 2;
      if(cat === "WOMEN") return 3;
      return 9;
    }

    function buildCategories(items){
      const map = new Map();
      for(const p of items){
        const c = p.category || "OTHER";
        map.set(c, (map.get(c) || 0) + 1);
      }
      const cats = Array.from(map.entries())
        .map(([name,count]) => ({name,count}))
        .sort((a,b) => {
          const ka = catOrderKey(a.name), kb = catOrderKey(b.name);
          if(ka !== kb) return ka - kb;
          return a.name.localeCompare(b.name);
        });

      // prepend ALL
      const total = items.length;
      return [{name:"ALL",count:total}, ...cats];
    }

    function renderCategories(cats){
      const el = $("#cats");
      el.innerHTML = "";
      for(const c of cats){
        const btn = document.createElement("button");
        btn.className = "cat" + (c.name === ACTIVE_CAT ? " active" : "");
        btn.textContent = `${c.name} (${c.count})`;
        btn.onclick = () => {
          ACTIVE_CAT = c.name;
          // highlight
          document.querySelectorAll(".cat").forEach(x=>x.classList.remove("active"));
          btn.classList.add("active");
          render();
        };
        el.appendChild(btn);
      }
    }

    function smartSort(a,b){
      // Ø°ÙƒÙŠ: Ø§Ù„Ù…ØªÙˆÙØ± Ø£ÙˆÙ„Ø§Ù‹ØŒ Ø¹Ø±ÙˆØ¶/Ø°Ù‡Ø¨ÙŠØŒ Ø«Ù… ÙƒÙˆØ¯
      const ao = a.flags.out ? 1 : 0;
      const bo = b.flags.out ? 1 : 0;
      if(ao !== bo) return ao - bo;

      const as = a.flags.sale ? 0 : 1;
      const bs = b.flags.sale ? 0 : 1;
      if(as !== bs) return as - bs;

      const ag = a.flags.gold ? 0 : 1;
      const bg = b.flags.gold ? 0 : 1;
      if(ag !== bg) return ag - bg;

      return (a.code || "").localeCompare(b.code || "");
    }

    function getEffectivePrice(p){
      // Ù†ÙØ¶Ù„ websitePrice Ù„Ùˆ Ù…ÙˆØ¬ÙˆØ¯ØŒ ÙˆØ¥Ù„Ø§ price
      return (p.websitePrice ?? p.price ?? null);
    }

    function applyFilters(){
      const q = safeText($("#q").value).toLowerCase();
      const inStockOnly = $("#inStockOnly").checked;
      const sort = $("#sort").value;

      let items = ALL.slice();

      if(ACTIVE_CAT !== "ALL"){
        items = items.filter(p => (p.category || "OTHER") === ACTIVE_CAT);
      }

      if(q){
        items = items.filter(p => {
          const hay = `${p.code} ${p.category} ${p.note}`.toLowerCase();
          return hay.includes(q);
        });
      }

      if(inStockOnly){
        items = items.filter(p => !p.flags.out);
      }

      // Sort
      if(sort === "smart") items.sort(smartSort);
      else if(sort === "code") items.sort((a,b)=> (a.code||"").localeCompare(b.code||""));
      else if(sort === "priceAsc") items.sort((a,b)=> (getEffectivePrice(a) ?? 1e18) - (getEffectivePrice(b) ?? 1e18));
      else if(sort === "priceDesc") items.sort((a,b)=> (getEffectivePrice(b) ?? -1) - (getEffectivePrice(a) ?? -1));
      else if(sort === "qtyDesc") items.sort((a,b)=> (b.qty ?? -1) - (a.qty ?? -1));

      return items;
    }

    function buildWhatsAppLink(p){
      const phone = getParam("phone", CONFIG.DEFAULT_WA_PHONE);
      const priceTxt = getEffectivePrice(p) ? `Ø§Ù„Ø³Ø¹Ø±: ${money(getEffectivePrice(p))}` : "";
      const stockTxt = (p.qty !== null) ? `Ø§Ù„Ù…Ø®Ø²ÙˆÙ†: ${p.qty}` : "";
      const catTxt = p.category ? `Ø§Ù„ÙØ¦Ø©: ${p.category}` : "";
      const noteTxt = p.note ? `Ù…Ù„Ø§Ø­Ø¸Ø©: ${p.note}` : "";
      const msg = [
        "Ù…Ø±Ø­Ø¨Ø§ MAD ğŸ‘‹",
        "Ø¨Ø¯ÙŠ Ø£Ø·Ù„Ø¨ Ø§Ù„Ù…Ù†ØªØ¬ Ø§Ù„ØªØ§Ù„ÙŠ:",
        `Ø§Ù„ÙƒÙˆØ¯: ${p.code}`,
        catTxt,
        priceTxt,
        stockTxt,
        noteTxt
      ].filter(Boolean).join("\n");

      const enc = encodeURIComponent(msg);
      return `https://api.whatsapp.com/send/?phone=${encodeURIComponent(phone)}&text=${enc}&type=phone_number&app_absent=0`;
    }

    function renderCard(p){
      const price = getEffectivePrice(p);
      const card = document.createElement("div");
      card.className = "card";

      const imgbox = document.createElement("div");
      imgbox.className = "imgbox";

      const badges = document.createElement("div");
      badges.className = "badges";

      if(p.flags.gold){
        const b = document.createElement("span");
        b.className = "badge gold";
        b.textContent = "GOLD";
        badges.appendChild(b);
      }
      if(p.flags.sale){
        const b = document.createElement("span");
        b.className = "badge sale";
        b.textContent = "Ø¹Ø±Ø¶";
        badges.appendChild(b);
      }
      if(p.flags.out){
        const b = document.createElement("span");
        b.className = "badge out";
        b.textContent = "Ø®Ø§Ù„Øµ";
        badges.appendChild(b);
      }

      const img = document.createElement("img");
      img.loading = "lazy";
      img.decoding = "async";
      img.src = p.img || CONFIG.PLACEHOLDER_IMG;
      img.alt = p.code || "MAD";
      img.onerror = () => { img.src = CONFIG.PLACEHOLDER_IMG; };

      imgbox.appendChild(badges);
      imgbox.appendChild(img);

      const content = document.createElement("div");
      content.className = "content";

      const title = document.createElement("div");
      title.className = "title";

      const left = document.createElement("div");
      const code = document.createElement("div");
      code.className = "code";
      code.textContent = p.code || "â€”";
      const cat = document.createElement("div");
      cat.className = "catname";
      cat.textContent = p.category || "OTHER";
      left.appendChild(code);
      left.appendChild(cat);

      const right = document.createElement("div");
      right.className = "price";
      right.innerHTML = price ? `${money(price)}<small>${p.websitePrice ? "Website" : "Price"}</small>` : `â€”<small>no price</small>`;

      title.appendChild(left);
      title.appendChild(right);

      const row = document.createElement("div");
      row.className = "row";
      const qty = document.createElement("div");
      qty.textContent = (p.qty === null) ? "ÙƒÙ…ÙŠØ©: ØºÙŠØ± Ù…Ø¹Ø±ÙˆÙ" : `ÙƒÙ…ÙŠØ©: ${p.qty}`;
      const exp = document.createElement("div");
      exp.textContent = p.expiry ? `Ø§Ù†ØªÙ‡Ø§Ø¡: ${p.expiry}` : "";
      row.appendChild(qty);
      row.appendChild(exp);

      const hint = document.createElement("div");
      hint.className = "hint";
      hint.textContent = p.note ? p.note : "Ø¬Ø§Ù‡Ø² Ù„Ù„Ø·Ù„Ø¨ Ø§Ù„Ø¢Ù† Ø¹Ø¨Ø± ÙˆØ§ØªØ³Ø§Ø¨.";

      const actions = document.createElement("div");
      actions.className = "actions";

      const wa = document.createElement("button");
      wa.className = "btn wa";
      wa.textContent = "Ø§Ø·Ù„Ø¨ ÙˆØ§ØªØ³Ø§Ø¨";
      wa.disabled = !!p.flags.out;
      wa.onclick = () => {
        trackLead("WhatsApp");
        window.open(buildWhatsAppLink(p), "_blank", "noopener");
      };

      const copy = document.createElement("button");
      copy.className = "btn";
      copy.textContent = "Ù†Ø³Ø® Ø§Ù„ÙƒÙˆØ¯";
      copy.onclick = async () => {
        try{
          await navigator.clipboard.writeText(p.code || "");
          copy.textContent = "ØªÙ… Ø§Ù„Ù†Ø³Ø® âœ“";
          setTimeout(()=> copy.textContent="Ù†Ø³Ø® Ø§Ù„ÙƒÙˆØ¯", 900);
        }catch(e){
          copy.textContent = "ÙØ´Ù„ Ø§Ù„Ù†Ø³Ø®";
          setTimeout(()=> copy.textContent="Ù†Ø³Ø® Ø§Ù„ÙƒÙˆØ¯", 900);
        }
      };

      actions.appendChild(wa);
      actions.appendChild(copy);

      content.appendChild(title);
      content.appendChild(row);
      content.appendChild(hint);
      content.appendChild(actions);

      card.appendChild(imgbox);
      card.appendChild(content);

      return card;
    }

    function render(){
      const items = applyFilters();
      const grid = $("#grid");
      grid.innerHTML = "";

      const inStockCount = items.filter(p=>!p.flags.out).length;
      const totalShown = items.length;

      $("#metaLeft").textContent = `Ø§Ù„Ù…Ø¹Ø±ÙˆØ¶: ${totalShown} | Ù…ØªÙˆÙØ±: ${inStockCount}`;
      const phone = getParam("phone", CONFIG.DEFAULT_WA_PHONE);
      $("#metaRight").textContent = `WhatsApp: ${phone}`;

      for(const p of items){
        grid.appendChild(renderCard(p));
      }

      if(items.length === 0){
        const n = document.createElement("div");
        n.className = "notice";
        n.textContent = "Ù„Ø§ ÙŠÙˆØ¬Ø¯ Ù†ØªØ§Ø¦Ø¬ Ø­Ø³Ø¨ Ø§Ù„ÙÙ„Ø§ØªØ± Ø§Ù„Ø­Ø§Ù„ÙŠØ©.";
        grid.appendChild(n);
      }
    }

    /***********************
     * Init
     ***********************/
    (async function init(){
      try{
        // Allow override from URL
        const gid = getParam("gid", null);
        const sid = getParam("sheet", null);
        if(gid) CONFIG.GID = gid;
        if(sid) CONFIG.SHEET_ID = sid;

        if(CONFIG.SHEET_ID.includes("PUT_YOUR_SHEET_ID_HERE")){
          $("#notice").innerHTML = "<b>ØªÙ†Ø¨ÙŠÙ‡:</b> Ù„Ø§Ø²Ù… ØªØ­Ø· <b>SHEET_ID</b> Ùˆ <b>GID</b> Ø¯Ø§Ø®Ù„ CONFIG Ø¨Ø§Ù„Ø£Ø¹Ù„Ù‰.";
          $("#subline").textContent = "Waiting for Sheet ID";
          return;
        }

        $("#subline").textContent = `Sheet: ${CONFIG.SHEET_ID.slice(0,10)}â€¦ | GID: ${CONFIG.GID}`;

        ALL = await loadProducts();

        // Build cats
        const cats = buildCategories(ALL);
        // default category: NISHE if exists
        const hasN = cats.some(c=>c.name==="NISHE" || c.name==="NICHE");
        ACTIVE_CAT = hasN ? (cats.find(c=>c.name==="NISHE") ? "NISHE" : "NICHE") : "ALL";
        renderCategories(cats);

        // Activate correct button
        document.querySelectorAll(".cat").forEach(btn=>{
          if(btn.textContent.startsWith(ACTIVE_CAT + " ")){ btn.classList.add("active"); }
        });

        // events
        $("#q").addEventListener("input", () => render());
        $("#inStockOnly").addEventListener("change", () => render());
        $("#sort").addEventListener("change", () => render());

        // first render
        render();

      }catch(err){
        console.error(err);
        $("#notice").innerHTML = "<b>Ø®Ø·Ø£:</b> ÙØ´Ù„ ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ø¯Ø§ØªØ§ Ù…Ù† Google Sheets. ØªØ£ÙƒØ¯ Ù…Ù† Ø£Ù† Ø§Ù„Ø´ÙŠØª Public ÙˆØ£Ù† SHEET_ID/GID ØµØ­ÙŠØ­ÙŠÙ†.";
      }
    })();
  </script>
</body>
</html>
