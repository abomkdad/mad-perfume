<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>MAD | Staff Order Tool</title>

  <script src="https://cdn.tailwindcss.com"></script>
  <style>
    body { font-family: Arial, sans-serif; background:#f6f7f9; }
    .glass { backdrop-filter: blur(10px); background: rgba(255,255,255,.75); }
    .shadow-soft { box-shadow: 0 10px 30px rgba(0,0,0,.08); }
    .card { transition: .15s transform; }
    .card:hover { transform: scale(1.02); }
    .chip { white-space: nowrap; }
  </style>
</head>

<body class="min-h-screen">

  <!-- Top Bar -->
  <div class="sticky top-0 z-30 border-b bg-white/80 glass">
    <div class="max-w-7xl mx-auto px-4 py-3 flex items-center justify-between gap-3">
      <div class="flex items-center gap-3">
        <img src="https://www.mad-parfumeur.com/assets/hero/logo.png" alt="MAD" class="h-10 w-10 rounded-xl object-contain bg-white border">
        <div>
          <div class="font-black text-lg leading-5" id="t_title">MAD - ØµÙØ­Ø© Ø§Ù„Ù…ÙˆØ¸Ù</div>
          <div class="text-xs text-gray-600" id="t_sub">Ø§Ø®ØªÙŠØ§Ø± Ù…Ù†ØªØ¬Ø§Øª + Ø³Ù„Ø© + ÙÙˆØ±Ù… + Ø¥Ø±Ø³Ø§Ù„ ÙˆØ§ØªØ³Ø§Ø¨</div>
        </div>
      </div>

      <div class="flex items-center gap-2">
        <button id="langBtn" class="px-4 py-2 rounded-xl bg-black text-white text-sm shadow-soft">Ø¹Ø±Ø¨ÙŠ / ×¢×‘×¨×™×ª</button>

        <button id="cartBtn" class="relative px-4 py-2 rounded-xl bg-green-600 text-white text-sm shadow-soft">
          <span id="t_cart">Ø§Ù„Ø³Ù„Ø©</span>
          <span id="cartCountBadge" class="absolute -top-2 -right-2 bg-black text-white text-xs px-2 py-1 rounded-full">0</span>
        </button>
      </div>
    </div>
  </div>

  <!-- Main -->
  <div class="max-w-7xl mx-auto px-4 pt-6 pb-24">

    <!-- Controls -->
    <div class="bg-white rounded-3xl shadow-soft border p-4">
      <div class="grid grid-cols-1 md:grid-cols-4 gap-3 items-end">
        <div class="md:col-span-2">
          <div class="text-xs text-gray-500 font-semibold" id="t_search">Ø¨Ø­Ø«</div>
          <input id="search" class="mt-2 w-full border rounded-2xl p-3" placeholder="Ø§Ø¨Ø­Ø« Ø¨Ø§Ù„Ø§Ø³Ù… / Ø§Ù„ÙƒÙˆØ¯..." />
          <div class="mt-2 text-xs text-gray-500">
            <span id="t_status">Status:</span> <span id="status">Auto loading...</span>
          </div>
        </div>

        <div>
          <div class="text-xs text-gray-500 font-semibold" id="t_wa">WhatsApp (Ø®Ø¯Ù…Ø© Ø§Ù„Ø¹Ù…Ù„Ø§Ø¡)</div>
          <input id="waNumber" class="mt-2 w-full border rounded-2xl p-3" value="972524033442" />
          <div class="mt-2 text-xs text-gray-500" id="t_wa_note">Ø¨Ø¯ÙˆÙ† +</div>
        </div>

        <div class="flex gap-2">
          <button id="reloadBtn" class="w-full px-4 py-3 rounded-2xl bg-blue-600 text-white font-bold">Reload RSS</button>
          <button id="clearBtn" class="w-full px-4 py-3 rounded-2xl bg-gray-100 font-bold" id="t_clear">Clear</button>
        </div>
      </div>

      <div class="mt-4 flex flex-col md:flex-row gap-2 md:items-center md:justify-between">
        <div class="text-sm text-gray-600">
          <span class="font-semibold" id="t_products">Products:</span> <span id="countAll">0</span>
          <span class="mx-2">|</span>
          <span class="font-semibold" id="t_selected">Selected:</span> <span id="countSel">0</span>
        </div>

        <div class="flex flex-wrap gap-2">
          <button id="openBundleBtn" class="px-4 py-3 rounded-2xl bg-black text-white font-bold">Open Bundle</button>
          <button id="copyBundleBtn" class="px-4 py-3 rounded-2xl bg-gray-900 text-white font-bold">Copy Bundle Link</button>
        </div>
      </div>

      <div class="mt-3 grid grid-cols-1 md:grid-cols-6 gap-2">
        <input id="bundleLink" class="md:col-span-5 w-full border rounded-2xl p-3" placeholder="Bundle link will appear here..." readonly />
        <button id="genBundleBtn" class="md:col-span-1 px-4 py-3 rounded-2xl bg-green-600 text-white font-bold">Generate</button>
      </div>

      <div class="mt-2 text-xs text-gray-500">
        âš ï¸ ÙˆØ§ØªØ³Ø§Ø¨ Ø¹Ø¨Ø± Ø±Ø§Ø¨Ø· wa.me ÙŠØ¹Ø±Ø¶ Preview Ù„ØµÙˆØ±Ø© ÙˆØ§Ø­Ø¯Ø© ÙÙ‚Ø·. Ø¥Ø±Ø³Ø§Ù„ ØµÙˆØ± ÙØ¹Ù„ÙŠØ© ÙŠØªÙ… Ø¹Ø¨Ø± Ø²Ø± â€œShare Imagesâ€ (ÙŠÙØ¶Ù„ Ù…Ù† Ø§Ù„Ù…ÙˆØ¨Ø§ÙŠÙ„).
      </div>
    </div>

    <!-- Categories -->
    <div class="mt-4">
      <div class="font-bold" id="t_categories">Ø§Ù„ØªØµÙ†ÙŠÙØ§Øª</div>
      <div id="categories" class="mt-3 flex flex-wrap gap-2"></div>
    </div>

    <!-- Products -->
    <div id="products" class="mt-4 grid grid-cols-2 md:grid-cols-4 lg:grid-cols-5 gap-4"></div>

  </div>

  <!-- Cart Drawer -->
  <div id="cartOverlay" class="fixed inset-0 bg-black/40 hidden z-40"></div>
  <div id="cartDrawer" class="fixed top-0 right-0 h-full w-full max-w-md bg-white z-50 translate-x-full transition-transform duration-200 shadow-soft">
    <div class="p-4 border-b flex items-center justify-between">
      <div>
        <div class="font-black text-lg" id="t_cart_title">Ø³Ù„Ø© Ø§Ù„Ù…ÙˆØ¸Ù</div>
        <div class="text-xs text-gray-600" id="t_cart_sub">Ø­Ø°Ù/ÙƒÙ…ÙŠØ© + ÙÙˆØ±Ù… + Ø¥Ø±Ø³Ø§Ù„</div>
      </div>
      <button id="closeCart" class="px-3 py-2 rounded-xl bg-gray-100">âœ•</button>
    </div>

    <div class="p-4 space-y-4 overflow-y-auto" style="height: calc(100% - 190px);">
      <div class="flex gap-2">
        <button id="clearCart" class="w-full px-4 py-3 rounded-xl bg-gray-100 font-semibold">Ù…Ø³Ø­ Ø§Ù„Ø³Ù„Ø©</button>
        <button id="openBundle2" class="w-full px-4 py-3 rounded-xl bg-black text-white font-semibold">Ø¹Ø±Ø¶ Ø§Ù„Ø¨Ø§Ù†Ø¯Ù„</button>
      </div>

      <div class="text-sm text-gray-600">
        <span id="t_cart_selected">Selected:</span> <span id="countSel2">0</span>
      </div>

      <div id="cartItems" class="space-y-3"></div>

      <!-- Order Form -->
      <div class="rounded-2xl border p-3 bg-gray-50">
        <div class="font-black mb-2" id="t_form">ÙÙˆØ±Ù… Ø§Ù„Ø·Ù„Ø¨</div>
        <div class="space-y-2">
          <input id="custName" class="w-full border rounded-xl p-3" placeholder="Ø§Ø³Ù… Ø§Ù„Ø²Ø¨ÙˆÙ†" />
          <input id="custPhone" class="w-full border rounded-xl p-3" placeholder="ØªÙ„ÙÙˆÙ†" inputmode="tel" />
          <textarea id="custAddress" class="w-full border rounded-xl p-3" rows="3" placeholder="Ø§Ù„Ø¹Ù†ÙˆØ§Ù†"></textarea>

          <div class="border rounded-xl p-3 bg-white">
            <div class="text-sm font-bold mb-2" id="t_pay">Ø·Ø±ÙŠÙ‚Ø© Ø§Ù„Ø¯ÙØ¹</div>
            <label class="flex items-center gap-2 text-sm"><input type="radio" name="pay" value="COD" checked /> <span id="t_cod">Ø§Ù„Ø¯ÙØ¹ Ø¹Ù†Ø¯ Ø§Ù„Ø§Ø³ØªÙ„Ø§Ù…</span></label>
            <label class="flex items-center gap-2 text-sm mt-2"><input type="radio" name="pay" value="CARD" /> <span id="t_card">Ø¨Ø·Ø§Ù‚Ø© / ØªØ­ÙˆÙŠÙ„</span></label>
          </div>
        </div>
      </div>

      <!-- Totals -->
      <div class="rounded-2xl border p-3 bg-white">
        <div class="flex items-center justify-between text-sm">
          <span id="t_subtotal">Ø§Ù„Ù…Ø¬Ù…ÙˆØ¹ Ø§Ù„ÙØ±Ø¹ÙŠ</span>
          <span class="font-black">â‚ª<span id="subtotal">0</span></span>
        </div>
        <div class="flex items-center justify-between text-sm mt-2">
          <span id="t_ship">Ø§Ù„ØªÙˆØµÙŠÙ„</span>
          <span class="font-black">â‚ª<span id="shipping">50</span></span>
        </div>
        <div class="h-px bg-gray-200 my-3"></div>
        <div class="flex items-center justify-between text-base">
          <span class="font-black" id="t_total">Ø§Ù„Ø¥Ø¬Ù…Ø§Ù„ÙŠ</span>
          <span class="font-black text-lg">â‚ª<span id="total">50</span></span>
        </div>
      </div>

      <!-- Actions -->
      <div class="grid grid-cols-1 md:grid-cols-2 gap-2">
        <button id="sendWhatsApp" class="px-4 py-4 rounded-2xl bg-green-600 text-white font-black shadow-soft">
          Ø¥Ø±Ø³Ø§Ù„ ÙˆØ§ØªØ³Ø§Ø¨ (Ù†Øµ + Ø±Ø§Ø¨Ø·)
        </button>
        <button id="shareImages" class="px-4 py-4 rounded-2xl bg-gray-900 text-white font-black shadow-soft">
          Share Images (Ù…ÙˆØ¨Ø§ÙŠÙ„)
        </button>
      </div>

      <div class="text-xs text-gray-500">
        âœ… Share Images ÙŠØ¹Ù…Ù„ Ø£ÙØ¶Ù„ Ø¹Ù„Ù‰ Ø§Ù„Ù…ÙˆØ¨Ø§ÙŠÙ„ (Chrome / Safari). Ø¥Ø°Ø§ Ù…Ø§ Ø§Ø´ØªØºÙ„ Ø¨Ø³Ø¨Ø¨ CORSØŒ Ø±Ø­ ÙŠØ¹Ø·ÙŠÙƒ Ø±Ø³Ø§Ù„Ø©.
      </div>

    </div>

    <div class="absolute bottom-0 left-0 right-0 p-4 border-t bg-white">
      <div class="text-xs text-gray-500">
        Ø³ÙŠØªÙ… Ø§Ù„Ø¥Ø±Ø³Ø§Ù„ Ù„Ù„Ø±Ù‚Ù… Ø§Ù„Ù…ÙˆØ¬ÙˆØ¯ Ø¨Ø§Ù„Ø£Ø¹Ù„Ù‰.
      </div>
    </div>
  </div>

<script>
/* =========================
   CONFIG
========================= */
const DELIVERY_FEE = 50;
const DEFAULT_WA = "972524033442";

/* =========================
   STATE
========================= */
let LANG = (navigator.language || "").toLowerCase().includes("he") ? "he" : "ar";
let PRODUCTS = [];
let FILTERED = [];
let SELECTED = new Map(); // id -> qty
let CURRENT_CATEGORY = "ALL";

/* =========================
   HELPERS
========================= */
function T(ar, he){ return (LANG==="he") ? he : ar; }
function escapeHtml(s){ return (s||"").replace(/[&<>"']/g, m => ({ "&":"&amp;","<":"&lt;",">":"&gt;",'"':"&quot;","'":"&#039;" }[m])); }
function normalizeWa(v){ return (v||"").toString().replace(/\D/g,"").trim(); }

function getTextByLocalName(parent, localName){
  const nodes = parent.getElementsByTagName("*");
  const target = localName.toLowerCase();
  for (let i=0;i<nodes.length;i++){
    const ln = (nodes[i].localName || "").toLowerCase();
    if (ln === target) return (nodes[i].textContent || "").trim();
  }
  return "";
}

function parsePrice(priceText){
  if(!priceText) return 0;
  const n = parseFloat(String(priceText).replace(/[^\d.]/g,""));
  return isNaN(n) ? 0 : n;
}

function translateCategory(cat){
  if(LANG==="ar"){
    if(cat.includes("×’×‘×¨×™×")) return "Ø¹Ø·ÙˆØ± Ø±Ø¬Ø§Ù„";
    if(cat.includes("× ×©×™×")) return "Ø¹Ø·ÙˆØ± Ù†Ø³Ø§Ø¡";
    if(cat.includes("××‘×¦×¢×™×")) return "Ø¹Ø±ÙˆØ¶";
    if(cat.includes("× ×™×©×”") || cat.includes("× ×™×©")) return "Ù†ÙŠØ´";
    if(cat.includes("×¡×œ×§×˜×™×‘")) return "Ø³ÙŠÙ„ÙŠÙƒØªÙ";
    return cat;
  }
  return cat;
}

/* =========================
   TEXTS
========================= */
function setTexts(){
  document.documentElement.lang = LANG;
  document.documentElement.dir = (LANG==="he") ? "ltr" : "rtl";

  document.getElementById("t_title").textContent = T("MAD - ØµÙØ­Ø© Ø§Ù„Ù…ÙˆØ¸Ù","MAD - ×¢××•×“ ×¢×•×‘×“×™×");
  document.getElementById("t_sub").textContent = T("Ø§Ø®ØªÙŠØ§Ø± Ù…Ù†ØªØ¬Ø§Øª + Ø³Ù„Ø© + ÙÙˆØ±Ù… + Ø¥Ø±Ø³Ø§Ù„ ÙˆØ§ØªØ³Ø§Ø¨","×‘×—×™×¨×ª ××•×¦×¨×™× + ×¢×’×œ×” + ×˜×•×¤×¡ + ×©×œ×™×—×”");
  document.getElementById("t_cart").textContent = T("Ø§Ù„Ø³Ù„Ø©","×¢×’×œ×”");
  document.getElementById("t_search").textContent = T("Ø¨Ø­Ø«","×—×™×¤×•×©");
  document.getElementById("search").placeholder = T("Ø§Ø¨Ø­Ø« Ø¨Ø§Ù„Ø§Ø³Ù… / Ø§Ù„ÙƒÙˆØ¯...","×—×¤×© ×œ×¤×™ ×©× / ×§×•×“...");
  document.getElementById("t_status").textContent = "Status:";
  document.getElementById("t_wa").textContent = T("WhatsApp (Ø®Ø¯Ù…Ø© Ø§Ù„Ø¹Ù…Ù„Ø§Ø¡)","WhatsApp (×©×™×¨×•×ª ×œ×§×•×—×•×ª)");
  document.getElementById("t_wa_note").textContent = T("Ø¨Ø¯ÙˆÙ† +","×œ×œ× +");
  document.getElementById("reloadBtn").textContent = "Reload RSS";
  document.getElementById("clearBtn").textContent = T("Clear","× ×§×”");
  document.getElementById("t_products").textContent = T("Products:","××•×¦×¨×™×:");
  document.getElementById("t_selected").textContent = T("Selected:","× ×‘×—×¨×•:");
  document.getElementById("t_categories").textContent = T("Ø§Ù„ØªØµÙ†ÙŠÙØ§Øª","×§×˜×’×•×¨×™×•×ª");

  document.getElementById("t_cart_title").textContent = T("Ø³Ù„Ø© Ø§Ù„Ù…ÙˆØ¸Ù","×¢×’×œ×ª ×¢×•×‘×“×™×");
  document.getElementById("t_cart_sub").textContent = T("Ø­Ø°Ù/ÙƒÙ…ÙŠØ© + ÙÙˆØ±Ù… + Ø¥Ø±Ø³Ø§Ù„","××—×™×§×”/×›××•×ª + ×˜×•×¤×¡ + ×©×œ×™×—×”");
  document.getElementById("t_cart_selected").textContent = T("Selected:","× ×‘×—×¨×•:");
  document.getElementById("t_form").textContent = T("ÙÙˆØ±Ù… Ø§Ù„Ø·Ù„Ø¨","×˜×•×¤×¡ ×”×–×× ×”");
  document.getElementById("custName").placeholder = T("Ø§Ø³Ù… Ø§Ù„Ø²Ø¨ÙˆÙ†","×©× ×œ×§×•×—");
  document.getElementById("custPhone").placeholder = T("ØªÙ„ÙÙˆÙ†","×˜×œ×¤×•×Ÿ");
  document.getElementById("custAddress").placeholder = T("Ø§Ù„Ø¹Ù†ÙˆØ§Ù†","×›×ª×•×‘×ª");
  document.getElementById("t_pay").textContent = T("Ø·Ø±ÙŠÙ‚Ø© Ø§Ù„Ø¯ÙØ¹","×××¦×¢×™ ×ª×©×œ×•×");
  document.getElementById("t_cod").textContent = T("Ø§Ù„Ø¯ÙØ¹ Ø¹Ù†Ø¯ Ø§Ù„Ø§Ø³ØªÙ„Ø§Ù…","×ª×©×œ×•× ×‘×¢×ª ××¡×™×¨×”");
  document.getElementById("t_card").textContent = T("Ø¨Ø·Ø§Ù‚Ø© / ØªØ­ÙˆÙŠÙ„","×›×¨×˜×™×¡ / ×”×¢×‘×¨×”");
  document.getElementById("t_subtotal").textContent = T("Ø§Ù„Ù…Ø¬Ù…ÙˆØ¹ Ø§Ù„ÙØ±Ø¹ÙŠ","×¡×›×•× ×‘×™× ×™×™×");
  document.getElementById("t_ship").textContent = T("Ø§Ù„ØªÙˆØµÙŠÙ„","××©×œ×•×—");
  document.getElementById("t_total").textContent = T("Ø§Ù„Ø¥Ø¬Ù…Ø§Ù„ÙŠ","×¡×”×´×›");
}
document.getElementById("langBtn").onclick = ()=>{
  LANG = (LANG==="ar") ? "he" : "ar";
  setTexts();
  renderCategories();
  applyFilters();
  renderCart();
};

/* =========================
   LOAD RSS
========================= */
async function loadRSS(){
  const status = document.getElementById("status");
  status.textContent = "Loading...";
  try{
    const res = await fetch("products.rss", { cache:"no-store" });
    const ct = res.headers.get("content-type") || "unknown";
    if(!res.ok) throw new Error("HTTP " + res.status);

    const text = await res.text();
    const xml = new DOMParser().parseFromString(text, "application/xml");
    const err = xml.getElementsByTagName("parsererror");
    if(err && err.length) throw new Error("XML parse error");

    const items = Array.from(xml.getElementsByTagName("item"));
    PRODUCTS = items.map(item=>{
      const priceRaw = getTextByLocalName(item, "price") || getTextByLocalName(item, "sale_price") || "";
      return {
        id: getTextByLocalName(item, "id"),
        title: getTextByLocalName(item, "title"),
        image: getTextByLocalName(item, "image_link"),
        link: getTextByLocalName(item, "link"),
        category: getTextByLocalName(item, "product_type") || "Uncategorized",
        price_raw: priceRaw,
        price: parsePrice(priceRaw)
      };
    }).filter(p=>p.id && p.title);

    document.getElementById("countAll").textContent = PRODUCTS.length.toString();
    status.textContent = `OK âœ… (${PRODUCTS.length})`;
    CURRENT_CATEGORY = "ALL";

    renderCategories();
    applyFilters();
    syncSelectedBadges();
  }catch(e){
    console.error(e);
    document.getElementById("status").textContent = "Failed âŒ";
    alert("ÙØ´Ù„ ØªØ­Ù…ÙŠÙ„ products.rss\n" + e.message);
  }
}

document.getElementById("reloadBtn").onclick = loadRSS;

/* =========================
   CATEGORIES
========================= */
function renderCategories(){
  const container = document.getElementById("categories");
  container.innerHTML = "";

  const cats = Array.from(new Set(PRODUCTS.map(p => p.category))).sort((a,b)=>a.localeCompare(b));
  container.appendChild(makeCatBtn("ALL", T("ÙƒÙ„ Ø§Ù„Ù…Ù†ØªØ¬Ø§Øª","×›×œ ×”××•×¦×¨×™×")));
  cats.forEach(cat => container.appendChild(makeCatBtn(cat, translateCategory(cat))));

  highlightCategory();
}

function makeCatBtn(cat, label){
  const b = document.createElement("button");
  b.className = "chip px-4 py-2 rounded-full bg-gray-200";
  b.textContent = label;
  b.dataset.cat = cat;
  b.onclick = () => {
    CURRENT_CATEGORY = cat;
    applyFilters();
    highlightCategory();
  };
  return b;
}

function highlightCategory(){
  document.querySelectorAll("#categories button").forEach(b => {
    const active = b.dataset.cat === CURRENT_CATEGORY;
    b.className = "chip px-4 py-2 rounded-full " + (active ? "bg-black text-white" : "bg-gray-200");
  });
}

/* =========================
   FILTER + RENDER
========================= */
document.getElementById("search").addEventListener("input", applyFilters);

function applyFilters(){
  const q = (document.getElementById("search").value || "").trim().toLowerCase();

  FILTERED = PRODUCTS.filter(p => {
    const catOk = (CURRENT_CATEGORY === "ALL") ? true : (p.category === CURRENT_CATEGORY);
    const qOk = !q ? true : (p.title.toLowerCase().includes(q) || p.id.toLowerCase().includes(q));
    return catOk && qOk;
  });

  renderProducts(FILTERED);
}

function renderProducts(list){
  const container = document.getElementById("products");
  container.innerHTML = "";

  list.forEach(p=>{
    const inCart = SELECTED.has(p.id);
    const qty = SELECTED.get(p.id) || 1;

    const card = document.createElement("div");
    card.className = "card bg-white rounded-3xl shadow-soft border overflow-hidden";

    card.innerHTML = `
      <div class="bg-gray-50">
        <img src="${escapeHtml(p.image)}" class="w-full h-44 object-contain" alt="">
      </div>
      <div class="p-3">
        <div class="text-xs text-gray-500 font-semibold">${escapeHtml(p.id)}</div>
        <div class="mt-1 font-bold text-sm leading-snug min-h-[40px]">${escapeHtml(p.title)}</div>

        <div class="mt-2 flex items-center justify-between">
          <div class="text-sm font-black">â‚ª${(p.price||0).toFixed(0)}</div>
          <div class="text-xs text-gray-500">${escapeHtml(translateCategory(p.category))}</div>
        </div>

        <div class="mt-3 flex gap-2">
          <button class="w-full px-3 py-3 rounded-2xl ${inCart ? "bg-black text-white" : "bg-green-600 text-white"} font-bold text-sm">
            ${inCart ? "âœ“ " + T("Ø¨Ø§Ù„Ø³Ù„Ø©","×‘×¢×’×œ×”") : "+ " + T("Ø£Ø¶Ù","×”×•×¡×£")}
          </button>
          <a class="px-3 py-3 rounded-2xl bg-gray-100 text-black text-sm font-bold" href="${escapeHtml(p.link)}" target="_blank">
            ${escapeHtml(T("Ø±Ø§Ø¨Ø·","×§×™×©×•×¨"))}
          </a>
        </div>

        ${inCart ? `
        <div class="mt-2 flex items-center justify-between">
          <div class="text-xs text-gray-500">${T("Ø§Ù„ÙƒÙ…ÙŠØ©","×›××•×ª")}</div>
          <div class="flex items-center gap-2">
            <button class="px-3 py-1 rounded-lg bg-gray-100 font-bold" data-act="dec">-</button>
            <div class="min-w-[28px] text-center font-black">${qty}</div>
            <button class="px-3 py-1 rounded-lg bg-gray-100 font-bold" data-act="inc">+</button>
            <button class="px-3 py-1 rounded-lg bg-red-600 text-white font-bold" data-act="rm">${T("Ø­Ø°Ù","××—×§")}</button>
          </div>
        </div>` : ``}
      </div>
    `;

    const mainBtn = card.querySelector("button");
    mainBtn.onclick = ()=>{
      if(SELECTED.has(p.id)) SELECTED.delete(p.id);
      else SELECTED.set(p.id, 1);
      syncSelectedBadges();
      renderProducts(FILTERED);
      renderCart();
    };

    const dec = card.querySelector('[data-act="dec"]');
    const inc = card.querySelector('[data-act="inc"]');
    const rm  = card.querySelector('[data-act="rm"]');
    if(dec) dec.onclick = ()=>{
      const now = SELECTED.get(p.id) || 1;
      if(now <= 1) SELECTED.delete(p.id);
      else SELECTED.set(p.id, now-1);
      syncSelectedBadges(); renderProducts(FILTERED); renderCart();
    };
    if(inc) inc.onclick = ()=>{
      const now = SELECTED.get(p.id) || 1;
      SELECTED.set(p.id, now+1);
      syncSelectedBadges(); renderProducts(FILTERED); renderCart();
    };
    if(rm) rm.onclick = ()=>{
      SELECTED.delete(p.id);
      syncSelectedBadges(); renderProducts(FILTERED); renderCart();
    };

    container.appendChild(card);
  });
}

/* =========================
   CART DRAWER
========================= */
const cartBtn = document.getElementById("cartBtn");
const cartDrawer = document.getElementById("cartDrawer");
const cartOverlay = document.getElementById("cartOverlay");
const closeCart = document.getElementById("closeCart");

cartBtn.onclick = openCart;
cartOverlay.onclick = closeCartFn;
closeCart.onclick = closeCartFn;

function openCart(){
  cartOverlay.classList.remove("hidden");
  cartDrawer.classList.remove("translate-x-full");
  renderCart();
}
function closeCartFn(){
  cartOverlay.classList.add("hidden");
  cartDrawer.classList.add("translate-x-full");
}

document.getElementById("clearBtn").onclick = ()=>{ SELECTED.clear(); syncSelectedBadges(); renderProducts(FILTERED); renderCart(); };
document.getElementById("clearCart").onclick = ()=>{ SELECTED.clear(); syncSelectedBadges(); renderProducts(FILTERED); renderCart(); };

function syncSelectedBadges(){
  const count = SELECTED.size;
  document.getElementById("countSel").textContent = count.toString();
  document.getElementById("countSel2").textContent = count.toString();
  document.getElementById("cartCountBadge").textContent = count.toString();
}

function calcSubtotal(){
  const map = new Map(PRODUCTS.map(p=>[p.id,p]));
  let sum = 0;
  for(const [id, qty] of SELECTED.entries()){
    const p = map.get(id);
    if(!p) continue;
    sum += (p.price||0) * qty;
  }
  return sum;
}

function renderTotals(){
  const sub = calcSubtotal();
  document.getElementById("subtotal").textContent = sub.toFixed(0);
  document.getElementById("shipping").textContent = DELIVERY_FEE.toFixed(0);
  document.getElementById("total").textContent = (sub + DELIVERY_FEE).toFixed(0);
}

function renderCart(){
  const wrap = document.getElementById("cartItems");
  wrap.innerHTML = "";
  if(SELECTED.size===0){
    wrap.innerHTML = `<div class="p-4 rounded-2xl bg-gray-50 border text-gray-700 text-sm">${escapeHtml(T("Ø§Ù„Ø³Ù„Ø© ÙØ§Ø±ØºØ©â€¦","×”×¢×’×œ×” ×¨×™×§×”â€¦"))}</div>`;
    renderTotals();
    return;
  }

  const map = new Map(PRODUCTS.map(p=>[p.id,p]));

  for(const [id, qty] of SELECTED.entries()){
    const p = map.get(id);
    if(!p) continue;

    const row = document.createElement("div");
    row.className = "flex gap-3 p-3 rounded-2xl border bg-white shadow-soft";
    row.innerHTML = `
      <img src="${escapeHtml(p.image)}" class="w-16 h-16 rounded-xl object-contain bg-gray-50 border" alt="">
      <div class="flex-1">
        <div class="text-xs text-gray-500 font-semibold">${escapeHtml(p.id)}</div>
        <div class="font-bold text-sm">${escapeHtml(p.title)}</div>
        <div class="mt-1 text-sm font-black">â‚ª${(p.price||0).toFixed(0)} <span class="text-xs text-gray-500 font-normal">x${qty}</span></div>
        <div class="mt-2 flex items-center gap-2">
          <button class="px-3 py-1 rounded-lg bg-gray-100 font-bold" data-act="dec">-</button>
          <div class="min-w-[28px] text-center font-black">${qty}</div>
          <button class="px-3 py-1 rounded-lg bg-gray-100 font-bold" data-act="inc">+</button>
        </div>
      </div>
      <button class="px-3 py-2 rounded-xl bg-red-600 text-white text-xs font-bold h-fit" data-act="rm">${escapeHtml(T("Ø­Ø°Ù","××—×§"))}</button>
    `;

    row.querySelector('[data-act="dec"]').onclick = ()=>{
      const now = SELECTED.get(id) || 1;
      if(now<=1) SELECTED.delete(id); else SELECTED.set(id, now-1);
      syncSelectedBadges(); renderProducts(FILTERED); renderCart();
    };
    row.querySelector('[data-act="inc"]').onclick = ()=>{
      const now = SELECTED.get(id) || 1;
      SELECTED.set(id, now+1);
      syncSelectedBadges(); renderCart();
    };
    row.querySelector('[data-act="rm"]').onclick = ()=>{
      SELECTED.delete(id);
      syncSelectedBadges(); renderProducts(FILTERED); renderCart();
    };

    wrap.appendChild(row);
  }

  renderTotals();
}

/* =========================
   BUNDLE LINK
========================= */
function buildBundleUrl(ids){
  const base = location.origin + location.pathname.replace(/[^/]+$/, "") + "bundle.html";
  const idsParam = encodeURIComponent(ids.join(","));
  const wa = normalizeWa(document.getElementById("waNumber").value || "") || DEFAULT_WA;
  return `${base}?ids=${idsParam}&lang=${encodeURIComponent(LANG)}&wa=${encodeURIComponent(wa)}`;
}

function generateBundle(){
  if(SELECTED.size===0) return alert(T("Ø§Ø®ØªØ± Ù…Ù†ØªØ¬Ø§Øª Ø£ÙˆÙ„Ø§Ù‹","×‘×—×¨ ××•×¦×¨×™× ×§×•×“×"));
  let ids = Array.from(SELECTED.keys());
  const MAX_IDS = 60;
  if(ids.length > MAX_IDS){
    alert(T(`Ø¹Ø¯Ø¯ ÙƒØ¨ÙŠØ± (${ids.length}). Ø³ÙŠØªÙ… Ø£Ø®Ø° Ø£ÙˆÙ„ ${MAX_IDS} ÙÙ‚Ø·.`,`×™×•×ª×¨ ××“×™ (${ids.length}). × ×™×§×— ×¨×§ ${MAX_IDS}.`));
    ids = ids.slice(0, MAX_IDS);
  }
  const url = buildBundleUrl(ids);
  document.getElementById("bundleLink").value = url;
  return url;
}

document.getElementById("genBundleBtn").onclick = generateBundle;
document.getElementById("openBundleBtn").onclick = ()=>{ const u = generateBundle(); if(u) window.open(u,"_blank"); };
document.getElementById("openBundle2").onclick = ()=>{ const u = generateBundle(); if(u) window.open(u,"_blank"); };

document.getElementById("copyBundleBtn").onclick = async ()=>{
  const u = generateBundle();
  if(!u) return;
  try{ await navigator.clipboard.writeText(u); alert(T("ØªÙ… Ø§Ù„Ù†Ø³Ø® âœ…","×”×•×¢×ª×§ âœ…")); }
  catch{ alert(T("Ø§Ù†Ø³Ø® ÙŠØ¯ÙˆÙŠÙ‹Ø§","×”×¢×ª×§ ×™×“× ×™×ª")); }
};

/* =========================
   SEND WHATSAPP (TEXT + BUNDLE)
========================= */
function getPay(){
  const el = document.querySelector('input[name="pay"]:checked');
  return el ? el.value : "COD";
}

document.getElementById("sendWhatsApp").onclick = ()=>{
  if(SELECTED.size===0) return alert(T("Ø§Ø®ØªØ± Ù…Ù†ØªØ¬Ø§Øª Ø£ÙˆÙ„Ø§Ù‹","×‘×—×¨ ××•×¦×¨×™× ×§×•×“×"));

  const name = (document.getElementById("custName").value || "").trim();
  const phone = (document.getElementById("custPhone").value || "").trim();
  const addr = (document.getElementById("custAddress").value || "").trim();
  const pay = getPay();

  if(!name || !phone || !addr){
    alert(T("Ø§Ù…Ù„Ø£ Ø§Ù„Ø§Ø³Ù… ÙˆØ§Ù„ØªÙ„ÙÙˆÙ† ÙˆØ§Ù„Ø¹Ù†ÙˆØ§Ù†","××œ× ×©×, ×˜×œ×¤×•×Ÿ ×•×›×ª×•×‘×ª"));
    openCart();
    return;
  }

  const wa = normalizeWa(document.getElementById("waNumber").value || "") || DEFAULT_WA;
  const ids = Array.from(SELECTED.keys());
  const bundleUrl = buildBundleUrl(ids);

  const map = new Map(PRODUCTS.map(p=>[p.id,p]));
  let msg = T("ğŸ›’ Ø·Ù„Ø¨ Ù…ÙˆØ¸Ù\n","ğŸ›’ ×”×–×× ×ª ×¢×•×‘×“\n");
  msg += "----------------------\n";
  msg += T(`ğŸ‘¤ Ø§Ù„Ø§Ø³Ù…: ${name}\n`,`ğŸ‘¤ ×©×: ${name}\n`);
  msg += T(`ğŸ“ Ø§Ù„ØªÙ„ÙÙˆÙ†: ${phone}\n`,`ğŸ“ ×˜×œ×¤×•×Ÿ: ${phone}\n`);
  msg += T(`ğŸ“ Ø§Ù„Ø¹Ù†ÙˆØ§Ù†: ${addr}\n`,`ğŸ“ ×›×ª×•×‘×ª: ${addr}\n`);
  msg += T(`ğŸ’³ Ø§Ù„Ø¯ÙØ¹: ${pay==="COD" ? "Ø§Ù„Ø¯ÙØ¹ Ø¹Ù†Ø¯ Ø§Ù„Ø§Ø³ØªÙ„Ø§Ù…" : "Ø¨Ø·Ø§Ù‚Ø©/ØªØ­ÙˆÙŠÙ„"}\n`,
           `ğŸ’³ ×ª×©×œ×•×: ${pay==="COD" ? "×‘×¢×ª ××¡×™×¨×”" : "×›×¨×˜×™×¡/×”×¢×‘×¨×”"}\n`);
  msg += "----------------------\n";
  msg += T("ğŸ§¾ Ø§Ù„Ù…Ù†ØªØ¬Ø§Øª:\n","ğŸ§¾ ××•×¦×¨×™×:\n");

  for(const [id, qty] of SELECTED.entries()){
    const p = map.get(id);
    if(!p) continue;
    msg += `â€¢ ${p.title} (x${qty}) â€” â‚ª${(((p.price||0)*qty)).toFixed(0)}\n`;
  }

  const sub = calcSubtotal();
  msg += "----------------------\n";
  msg += T(`Ø§Ù„Ù…Ø¬Ù…ÙˆØ¹ Ø§Ù„ÙØ±Ø¹ÙŠ: â‚ª${sub.toFixed(0)}\n`,`×¡×›×•× ×‘×™× ×™×™×: â‚ª${sub.toFixed(0)}\n`);
  msg += T(`Ø§Ù„ØªÙˆØµÙŠÙ„: â‚ª${DELIVERY_FEE}\n`,`××©×œ×•×—: â‚ª${DELIVERY_FEE}\n`);
  msg += T(`Ø§Ù„Ø¥Ø¬Ù…Ø§Ù„ÙŠ: â‚ª${(sub+DELIVERY_FEE).toFixed(0)}\n`,`×¡×”×´×›: â‚ª${(sub+DELIVERY_FEE).toFixed(0)}\n`);
  msg += "----------------------\n";
  msg += T("ğŸ“¦ Ø±Ø§Ø¨Ø· Ø§Ù„Ø¨Ø§Ù†Ø¯Ù„ (ØµÙˆØ±):\n","ğŸ“¦ ×§×™×©×•×¨ ×œ×‘×× ×“×œ (×ª××•× ×•×ª):\n");
  msg += bundleUrl;

  window.open(`https://wa.me/${wa}?text=${encodeURIComponent(msg)}`, "_blank");
};

/* =========================
   SHARE IMAGES (MOBILE)
========================= */
async function fetchAsFile(url, filename){
  const res = await fetch(url, { mode:"cors" });
  const blob = await res.blob();
  const ext = (blob.type && blob.type.includes("png")) ? "png" : "jpg";
  return new File([blob], `${filename}.${ext}`, { type: blob.type || "image/jpeg" });
}

document.getElementById("shareImages").onclick = async ()=>{
  if(SELECTED.size===0) return alert(T("Ø§Ø®ØªØ± Ù…Ù†ØªØ¬Ø§Øª Ø£ÙˆÙ„Ø§Ù‹","×‘×—×¨ ××•×¦×¨×™× ×§×•×“×"));

  if(!navigator.share){
    alert(T("Ø§Ù„Ù…Ø´Ø§Ø±ÙƒØ© ØºÙŠØ± Ù…Ø¯Ø¹ÙˆÙ…Ø© Ø¹Ù„Ù‰ Ù‡Ø°Ø§ Ø§Ù„Ø¬Ù‡Ø§Ø². Ø§ÙØªØ­ Ø§Ù„ØµÙØ­Ø© Ù…Ù† Ø§Ù„Ù…ÙˆØ¨Ø§ÙŠÙ„.","×©×™×ª×•×£ ×œ× × ×ª××š ×‘××›×©×™×¨ ×”×–×”. ×¤×ª×— ×‘××•×‘×™×™×œ."));
    return;
  }

  try{
    const map = new Map(PRODUCTS.map(p=>[p.id,p]));
    const files = [];
    for(const [id] of SELECTED.entries()){
      const p = map.get(id);
      if(!p || !p.image) continue;
      // Ø­Ø¯ Ø¹Ù…Ù„ÙŠ: 10 ØµÙˆØ± Ù„Ù„Ù…Ø´Ø§Ø±ÙƒØ© Ø¯ÙØ¹Ø© ÙˆØ§Ø­Ø¯Ø©
      if(files.length >= 10) break;
      files.push(await fetchAsFile(p.image, id));
    }

    if(files.length===0){
      alert(T("Ù„Ø§ ØªÙˆØ¬Ø¯ ØµÙˆØ± Ù‚Ø§Ø¨Ù„Ø© Ù„Ù„Ù…Ø´Ø§Ø±ÙƒØ©","××™×Ÿ ×ª××•× ×•×ª ×œ×©×™×ª×•×£"));
      return;
    }

    await navigator.share({
      title: "MAD Products",
      text: T("ØµÙˆØ± Ø§Ù„Ù…Ù†ØªØ¬Ø§Øª Ø§Ù„Ù…Ø®ØªØ§Ø±Ø©","×ª××•× ×•×ª ×”××•×¦×¨×™× ×©× ×‘×—×¨×•"),
      files
    });
  }catch(e){
    console.error(e);
    alert(T("ÙØ´Ù„ Ø¥Ø±Ø³Ø§Ù„ Ø§Ù„ØµÙˆØ±. ØºØ§Ù„Ø¨Ø§Ù‹ Ø¨Ø³Ø¨Ø¨ CORS Ø£Ùˆ Ø§Ù„Ø¬Ù‡Ø§Ø² Ù…Ù†Ø¹ Ù…Ø´Ø§Ø±ÙƒØ© Ø§Ù„Ù…Ù„ÙØ§Øª.","× ×›×©×œ ×œ×©×ª×£ ×ª××•× ×•×ª (×›× ×¨××” CORS ××• ×—×¡×™××”)."));
  }
};

/* =========================
   INIT
========================= */
document.getElementById("waNumber").value = normalizeWa(new URL(location.href).searchParams.get("wa")) || DEFAULT_WA;
document.getElementById("waNumber").addEventListener("input", (e)=>{ e.target.value = normalizeWa(e.target.value); });

setTexts();
window.addEventListener("load", loadRSS);
</script>
</body>
</html>
