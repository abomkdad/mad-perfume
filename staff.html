<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
  <meta charset="UTF-8" />
  <meta property="og:image" content="https://www.mad-parfumeur.com/assets/hero/logo2.webp" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0, viewport-fit=cover, maximum-scale=1.0, user-scalable=no" />
  <meta name="theme-color" content="#0f1116" />
  <title>MAD Staff | إدارة الروابط</title>

  <script src="https://cdn.tailwindcss.com"></script>

  <style>
    body { font-family: 'Segoe UI', system-ui, -apple-system, Arial, sans-serif; background-color: #e9eaec; }
    /* Mobile-only feel (حتى على الكمبيوتر تظهر كجوال) */
    .app {
      max-width: 520px;
      margin: 0 auto;
      min-height: 100dvh;
      background: #f3f4f6;
      box-shadow: 0 10px 40px rgba(0,0,0,.12);
    }
    @media (max-width: 560px){
      body { background:#f3f4f6; }
      .app { max-width:none; box-shadow:none; }
    }

    .glass { backdrop-filter: blur(12px); background: rgba(15, 17, 22, 0.95); }
    .glassLight { backdrop-filter: blur(10px); background: rgba(255, 255, 255, 0.92); border: 1px solid rgba(255, 255, 255, 0.35); }
    .goldText { background: linear-gradient(90deg, #f6e27a, #c5a059, #fff2b6); -webkit-background-clip:text; background-clip:text; color: transparent; }
    .btnGold { background: linear-gradient(135deg, #f6e27a, #c5a059); color:#111; }
    .no-scrollbar::-webkit-scrollbar { display: none; }
    .no-scrollbar { scrollbar-width: none; }
    .tap:active { transform: scale(0.98); }
  </style>
</head>

<body class="min-h-screen">
  <div class="app pb-10" style="padding-bottom: calc(2.5rem + env(safe-area-inset-bottom));">

    <div class="sticky top-0 z-40 glass px-4 py-3 border-b border-white/10" style="padding-top: calc(0.75rem + env(safe-area-inset-top));">
      <div class="flex items-center justify-between mb-3">
        <div class="flex items-center gap-2">
          <img src="https://www.mad-parfumeur.com/assets/hero/logo.png" class="h-8 object-contain brightness-0 invert" alt="MAD">
          <div class="font-black text-white text-sm leading-none">
            <span class="goldText">MAD</span>
            <span id="t_header">روابط الإدارة</span>
          </div>
        </div>

        <button id="langBtn"
          class="bg-white/10 text-white px-3 py-1 rounded-full text-[10px] font-bold border border-white/20 tap">
          عربي / עברית
        </button>
      </div>

      <div class="glassLight rounded-2xl p-3 shadow-lg space-y-3">
        <input id="search"
          class="w-full bg-white border border-gray-200 rounded-xl px-4 py-2 text-sm outline-none"
          placeholder="بحث باسم المنتج...">

        <div class="grid grid-cols-1 gap-2">
          <div class="flex items-center gap-1 bg-gray-50 p-1 rounded-xl border border-gray-100">
            <input id="catLink" readonly class="bg-transparent flex-1 text-[10px] px-2 text-gray-500 truncate" placeholder="اختر قسماً أولاً...">
            <button id="copyCatBtn" class="bg-emerald-600 text-white px-4 py-1.5 rounded-lg text-[10px] font-bold tap">
              نسخ القسم
            </button>
          </div>

          <div class="flex items-center gap-1 bg-gray-50 p-1 rounded-xl border border-gray-100">
            <input id="bundleLink" readonly class="bg-transparent flex-1 text-[10px] px-2 text-gray-500 truncate" placeholder="رابط الباقة...">
            <button id="copyBundleBtn" class="btnGold px-4 py-1.5 rounded-lg text-[10px] font-bold tap">
              نسخ الباقة
            </button>
          </div>
        </div>
      </div>

      <div id="categories" class="flex overflow-x-auto gap-2 py-3 no-scrollbar"></div>
    </div>

    <div id="products" class="grid grid-cols-2 gap-3 p-3"></div>

  </div>

<script>
/* =========================
   Staff Language (NOT auto device)
   - Default AR
   - Can set by URL: ?lang=he
   - Saved in localStorage per employee device
   ========================= */
const I18N = {
  ar: {
    header: "روابط الإدارة",
    searchPh: "بحث باسم المنتج...",
    catPh: "اختر قسماً أولاً...",
    bundlePh: "رابط الباقة...",
    copyCat: "نسخ القسم",
    copyBundle: "نسخ الباقة",
    add: "إضافة",
    all: "الكل",
    copied: "تم النسخ بنجاح ✅",
    emptyCat: "الرابط فارغ! اختر قسماً أولاً.",
    emptyBundle: "الرابط فارغ! اختر منتجات أولاً.",
    loadErr: "خطأ في تحميل البيانات"
  },
  he: {
    header: "קישורי ניהול",
    searchPh: "חיפוש לפי שם מוצר...",
    catPh: "בחר קטגוריה קודם...",
    bundlePh: "קישור למארז...",
    copyCat: "העתק קטגוריה",
    copyBundle: "העתק מארז",
    add: "הוסף",
    all: "הכל",
    copied: "הועתק בהצלחה ✅",
    emptyCat: "הקישור ריק! בחר קטגוריה קודם.",
    emptyBundle: "הקישור ריק! בחר מוצרים קודם.",
    loadErr: "שגיאה בטעינת נתונים"
  }
};

function getLang() {
  const qp = new URLSearchParams(location.search);
  const fromUrl = (qp.get("lang") || "").toLowerCase();
  if (fromUrl === "he" || fromUrl === "ar") return fromUrl;

  const saved = (localStorage.getItem("mad_staff_lang") || "").toLowerCase();
  if (saved === "he" || saved === "ar") return saved;

  return "ar"; // default
}
function setLang(lang) {
  LANG = (lang === "he") ? "he" : "ar";
  localStorage.setItem("mad_staff_lang", LANG);

  // update URL without reload
  const u = new URL(location.href);
  u.searchParams.set("lang", LANG);
  history.replaceState({}, "", u.toString());

  applyTexts();
  renderCategories();
  applyFilters();
  updateLinks();
}

let LANG = getLang();
const RSS_PATH = "products.rss";
const WA_AGENT = "972524033442";

let PRODUCTS = [];
let CURRENT_CAT = "ALL";
let SELECTED = new Map();

function T(){ return I18N[LANG] || I18N.ar; }
function escHtml(s){
  return String(s||"")
    .replaceAll("&","&amp;")
    .replaceAll("<","&lt;")
    .replaceAll(">","&gt;")
    .replaceAll('"',"&quot;")
    .replaceAll("'","&#039;");
}

function applyTexts(){
  const t = T();
  document.documentElement.lang = LANG;
  document.documentElement.dir = "rtl"; // Hebrew + Arabic RTL

  document.getElementById("t_header").textContent = t.header;

  document.getElementById("search").placeholder = t.searchPh;
  document.getElementById("catLink").placeholder = t.catPh;
  document.getElementById("bundleLink").placeholder = t.bundlePh;

  document.getElementById("copyCatBtn").textContent = t.copyCat;
  document.getElementById("copyBundleBtn").textContent = t.copyBundle;
}

async function init() {
  applyTexts();

  try {
    const res = await fetch(RSS_PATH + "?v=" + Date.now(), { cache: "no-store" });
    const xml = new DOMParser().parseFromString(await res.text(), "application/xml");

    PRODUCTS = Array.from(xml.querySelectorAll("item")).map(i => {
      const getG = (tt) => i.querySelector(tt)?.textContent || i.querySelector(`g\\:${tt}`)?.textContent || "";
      return {
        id: (getG("id") || "").trim(),
        title: (getG("title") || "").trim(),
        image: (getG("image_link") || "").trim(),
        type: (getG("product_type") || "General").trim()
      };
    }).filter(p => p.id && p.title);

    renderCategories();
    applyFilters();
    updateLinks();
  } catch (e) {
    alert(T().loadErr);
  }
}

function renderCategories() {
  const t = T();
  const container = document.getElementById("categories");
  const cats = ["ALL", ...new Set(PRODUCTS.map(p => p.type))];

  container.innerHTML = cats.map(c => {
    const isActive = (CURRENT_CAT === c);
    const label = (c === "ALL") ? t.all : c;

    return `
      <button onclick='switchCat(${JSON.stringify(c)})'
        class="whitespace-nowrap px-5 py-2 rounded-full text-xs font-black border transition-all tap
        ${isActive ? "bg-black text-white border-black" : "bg-white text-gray-600 border-gray-200"}">
        ${escHtml(label)}
      </button>
    `;
  }).join("");
}

function applyFilters() {
  const t = T();
  const q = (document.getElementById("search").value || "").toLowerCase().trim();
  const filtered = PRODUCTS.filter(p =>
    (CURRENT_CAT === "ALL" || p.type === CURRENT_CAT) &&
    p.title.toLowerCase().includes(q)
  );

  document.getElementById("products").innerHTML = filtered.map(p => {
    const qty = SELECTED.get(p.id) || 0;

    return `
      <div class="bg-white rounded-2xl p-2 flex flex-col shadow-sm border border-gray-100">
        <img src="${p.image}" class="w-full aspect-square object-contain mix-blend-multiply" loading="lazy" alt="${escHtml(p.title)}">
        <p class="text-[10px] font-black h-7 my-2 text-center leading-tight overflow-hidden">${escHtml(p.title)}</p>

        <div class="flex gap-1 mt-auto">
          <button onclick='changeQty(${JSON.stringify(p.id)}, 1)'
            class="flex-1 btnGold py-1.5 rounded-lg text-[10px] font-black tap">
            ${t.add}
          </button>

          ${qty ? `<span class="bg-amber-100 px-2 rounded-lg flex items-center text-xs font-black">${qty}</span>` : ""}
        </div>
      </div>
    `;
  }).join("");
}

window.switchCat = (c) => {
  CURRENT_CAT = c;
  renderCategories();
  applyFilters();
  updateLinks();
};

window.changeQty = (id, delta) => {
  const next = (SELECTED.get(id) || 0) + delta;
  if (next <= 0) SELECTED.delete(id);
  else SELECTED.set(id, next);

  updateLinks();
  applyFilters();
};

function basePath() {
  // folder of current file
  const p = location.pathname;
  const folder = p.substring(0, p.lastIndexOf("/") + 1);
  return location.origin + folder;
}

function updateLinks() {
  const base = basePath();

  // Category link
  document.getElementById("catLink").value =
    (CURRENT_CAT === "ALL")
      ? ""
      : `${base}customer.html?cat=${encodeURIComponent(CURRENT_CAT)}&lang=${LANG}&wa=${WA_AGENT}`;

  // Bundle link
  const ids = [];
  SELECTED.forEach((qty, id) => {
    for (let i = 0; i < qty; i++) ids.push(id);
  });

  document.getElementById("bundleLink").value =
    ids.length
      ? `${base}bundle.html?ids=${encodeURIComponent(ids.join(","))}&lang=${LANG}&wa=${WA_AGENT}`
      : "";
}

async function copyVal(inputId) {
  const t = T();
  const el = document.getElementById(inputId);
  if (!el.value) {
    alert(inputId === "catLink" ? t.emptyCat : t.emptyBundle);
    return;
  }
  try {
    await navigator.clipboard.writeText(el.value);
    alert(t.copied);
  } catch (err) {
    el.focus();
    el.select();
    document.execCommand("copy");
    alert(t.copied);
  }
}

document.getElementById("copyCatBtn").onclick = () => copyVal("catLink");
document.getElementById("copyBundleBtn").onclick = () => copyVal("bundleLink");
document.getElementById("search").oninput = applyFilters;

document.getElementById("langBtn").onclick = () => {
  setLang(LANG === "ar" ? "he" : "ar");
};

// start
init();
</script>

</body>
</html>
