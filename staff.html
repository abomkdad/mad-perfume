<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
  <meta charset="UTF-8" />
  <meta property="og:image" content="https://www.mad-parfumeur.com/assets/hero/logo2.webp" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no" />
  <title>MAD Staff - Mobile Optimized</title>
  <script src="https://cdn.tailwindcss.com"></script>

  <style>
    body { font-family: 'Segoe UI', Roboto, Helvetica, Arial, sans-serif; background-color: #f3f4f6; }
    .glass { backdrop-filter: blur(12px); -webkit-backdrop-filter: blur(12px); background: rgba(15, 17, 22, 0.95); }
    .glassLight { backdrop-filter: blur(10px); -webkit-backdrop-filter: blur(10px); background: rgba(255, 255, 255, 0.9); border: 1px solid rgba(255, 255, 255, 0.3); }
    .shadowLux { box-shadow: 0 10px 30px -5px rgba(0,0,0,0.1); }
    .goldText { background: linear-gradient(90deg, #f6e27a, #c5a059, #fff2b6); -webkit-background-clip:text; background-clip:text; color: transparent; }
    .btnGold { background: linear-gradient(135deg, #f6e27a, #c5a059); color:#111; }
    .btnDark { background: #161a22; color:#fff; }
    .no-scrollbar::-webkit-scrollbar { display: none; }
    .no-scrollbar { -ms-overflow-style: none; scrollbar-width: none; }
    .card { transition: transform 0.1s ease; }
    .card:active { transform: scale(0.97); }
    .toastWrap { position: fixed; top: 20px; left: 50%; transform: translateX(-50%); z-index: 9999; width: 90%; max-width: 400px; pointer-events: none; }
    .toast { pointer-events: auto; border-radius: 20px; padding: 15px; border: 1px solid rgba(0,0,0,0.05); }
  </style>
</head>

<body class="min-h-screen pb-10">

  <div class="toastWrap hidden" id="toastWrap">
    <div class="toast glassLight shadowLux flex items-center justify-between gap-3">
      <div>
        <div class="font-black text-sm" id="toastTitle">OK</div>
        <div class="text-xs text-gray-600" id="toastMsg">...</div>
      </div>
      <button class="w-8 h-8 flex items-center justify-center rounded-full bg-black text-white text-lg" onclick="hideToast()">×</button>
    </div>
  </div>

  <div class="sticky top-0 z-40">
    <div class="glass px-4 py-3 border-b border-white/10">
      <div class="flex items-center justify-between mb-3">
        <div class="flex items-center gap-2">
          <img src="https://www.mad-parfumeur.com/assets/hero/logo.png" class="w-8 h-8 object-contain" alt="MAD">
          <div class="font-black text-white text-sm leading-none"><span class="goldText">MAD</span> <span id="t_title">روابط</span></div>
        </div>
        <button id="langBtn" class="bg-white/10 text-white px-3 py-1 rounded-full text-[10px] font-bold border border-white/20">AR / HE</button>
      </div>

      <div class="glassLight rounded-2xl p-3 shadowLux">
        <div class="space-y-3">
          <input id="search" class="w-full bg-white border border-gray-200 rounded-xl px-4 py-2 text-sm outline-none focus:ring-2 focus:ring-amber-500" placeholder="بحث..." />
          
          <div class="grid grid-cols-1 gap-2">
            <div class="flex items-center gap-1 bg-gray-50 p-1 rounded-xl border border-gray-100">
              <input id="catLink" readonly class="bg-transparent flex-1 text-[10px] px-2 text-gray-500 truncate" placeholder="رابط القسم..." />
              <button id="copyCatBtn" class="bg-emerald-600 text-white px-3 py-1.5 rounded-lg text-[10px] font-bold">نسخ</button>
              <button id="openCatBtn" class="bg-black text-white p-1.5 rounded-lg">
                <svg class="w-3 h-3" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path d="M10 6H6a2 2 0 00-2 2v10a2 2 0 002 2h10a2 2 0 002-2v-4M14 4h6m0 0v6m0-6L10 14" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"></path></svg>
              </button>
            </div>
            <div class="flex items-center gap-1 bg-gray-50 p-1 rounded-xl border border-gray-100">
              <input id="bundleLink" readonly class="bg-transparent flex-1 text-[10px] px-2 text-gray-500 truncate" placeholder="رابط الباقة..." />
              <button id="copyBundleBtn" class="btnGold px-3 py-1.5 rounded-lg text-[10px] font-bold">نسخ</button>
              <button id="openBundleBtn" class="bg-black text-white p-1.5 rounded-lg">
                <svg class="w-3 h-3" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path d="M10 6H6a2 2 0 00-2 2v10a2 2 0 002 2h10a2 2 0 002-2v-4M14 4h6m0 0v6m0-6L10 14" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"></path></svg>
              </button>
            </div>
          </div>

          <div class="flex items-center justify-between text-[10px] font-bold text-gray-400 uppercase px-1">
             <div><span id="t_now">القسم:</span> <span id="catNow" class="text-black">ALL</span></div>
             <div><span id="t_sel">المختارة:</span> <span id="countSel" class="text-amber-600">0</span></div>
          </div>
        </div>
      </div>
    </div>
    <div id="categories" class="flex overflow-x-auto gap-2 px-4 py-3 no-scrollbar bg-gray-50 border-b border-gray-200"></div>
  </div>

  <div class="max-w-7xl mx-auto px-3 mt-4">
    <div id="products" class="grid grid-cols-2 sm:grid-cols-3 gap-3"></div>
  </div>

<script>
const RSS_PATH = "products.rss";
const BUNDLE_PAGE = "bundle.html";
const CUSTOMER_PAGE = "customer.html";
const WA_AGENT_FIXED = "972524033442";

let LANG = (navigator.language || "").toLowerCase().includes("he") ? "he" : "ar";
let PRODUCTS = [];
let FILTERED = [];
let CURRENT_CATEGORY = "ALL";
let SELECTED = new Map();

function T(ar, he){ return (LANG==="he") ? he : ar; }

function setTexts(){
  document.documentElement.lang = LANG;
  document.documentElement.dir = (LANG==="he") ? "ltr" : "rtl";
  document.getElementById("t_title").textContent = T("- روابط سريعة","- קישורים מהירים");
  document.getElementById("search").placeholder = T("بحث باسم المنتج أو الكود...","חיפוש שם או קוד...");
  document.getElementById("t_now").textContent = T("القسم:","קטגוריה:");
  document.getElementById("t_sel").textContent = T("المختارة:","נבחרו:");
  document.getElementById("copyCatBtn").textContent = T("نسخ","העתק");
  document.getElementById("copyBundleBtn").textContent = T("نسخ","העתק");
}

function showToast(title, msg){
  document.getElementById("toastTitle").textContent = title;
  document.getElementById("toastMsg").textContent = msg;
  document.getElementById("toastWrap").classList.remove("hidden");
  setTimeout(hideToast, 3000);
}
function hideToast(){ document.getElementById("toastWrap").classList.add("hidden"); }

async function loadRSS(){
  try {
    const res = await fetch(RSS_PATH, { cache:"no-store" });
    const text = await res.text();
    const xml = new DOMParser().parseFromString(text, "application/xml");
    const items = Array.from(xml.getElementsByTagName("item"));
    
    PRODUCTS = items.map(item => {
      const getTag = (tag) => {
        const el = item.getElementsByTagName(tag)[0] || item.getElementsByTagName(`g:${tag}`)[0];
        return el ? el.textContent.trim() : "";
      };
      return {
        id: getTag("id"),
        title: getTag("title"),
        image: getTag("image_link"),
        category: getTag("product_type") || "General"
      };
    }).filter(p => p.id);

    renderCategories();
    applyFilters();
    updateLinks(); // تحديث الروابط فور التحميل
  } catch (e) {
    showToast("Error", "فشل تحميل البيانات");
  }
}

function renderCategories(){
  const container = document.getElementById("categories");
  container.innerHTML = "";
  const cats = ["ALL", ...new Set(PRODUCTS.map(p=>p.category))];
  cats.forEach(c => {
    const b = document.createElement("button");
    b.className = `whitespace-nowrap px-4 py-1.5 rounded-full text-xs font-bold transition-all ${CURRENT_CATEGORY === c ? 'bg-black text-white shadow-md' : 'bg-white text-gray-600 border border-gray-200'}`;
    b.textContent = c === "ALL" ? T("الكل", "הכל") : c;
    b.onclick = () => { 
      CURRENT_CATEGORY = c; 
      document.getElementById("catNow").textContent = c; 
      renderCategories(); 
      applyFilters(); 
      updateLinks(); 
    };
    container.appendChild(b);
  });
}

function applyFilters(){
  const q = document.getElementById("search").value.toLowerCase();
  FILTERED = PRODUCTS.filter(p => {
    const catOk = CURRENT_CATEGORY === "ALL" || p.category === CURRENT_CATEGORY;
    const qOk = p.title.toLowerCase().includes(q) || p.id.toLowerCase().includes(q);
    return catOk && qOk;
  });
  renderProducts();
}

function renderProducts(){
  const container = document.getElementById("products");
  container.innerHTML = "";
  FILTERED.forEach(p => {
    const qty = SELECTED.get(p.id) || 0;
    const div = document.createElement("div");
    div.className = "card glassLight rounded-2xl overflow-hidden shadow-sm flex flex-col";
    div.innerHTML = `
      <div class="relative aspect-square bg-white p-2">
        <img src="${p.image}" class="w-full h-full object-contain" loading="lazy">
        <div class="absolute top-1 left-1 bg-black/50 text-white text-[8px] px-1.5 py-0.5 rounded-md">${p.id}</div>
        ${qty > 0 ? `<div class="absolute top-1 right-1 bg-amber-500 text-white text-[10px] w-5 h-5 flex items-center justify-center rounded-full font-bold shadow-lg">${qty}</div>` : ''}
      </div>
      <div class="p-2 flex flex-col flex-1">
        <div class="text-[11px] font-bold line-clamp-2 mb-2 h-8 text-gray-800">${p.title}</div>
        <div class="flex gap-1 mt-auto">
          <button onclick="changeQty('${p.id}', 1)" class="flex-1 btnGold py-1.5 rounded-lg text-[10px] font-black">إضافة</button>
          <button onclick="changeQty('${p.id}', -1)" class="w-8 bg-gray-100 text-gray-400 py-1.5 rounded-lg text-[10px] font-black">×</button>
        </div>
      </div>
    `;
    container.appendChild(div);
  });
}

window.changeQty = (id, delta) => {
  let q = (SELECTED.get(id) || 0) + delta;
  if (q <= 0) SELECTED.delete(id);
  else SELECTED.set(id, q);
  document.getElementById("countSel").textContent = Array.from(SELECTED.values()).reduce((a, b) => a + b, 0);
  renderProducts();
  updateLinks();
};

function updateLinks(){
  const base = location.origin + location.pathname.replace(/[^/]+$/, "");
  
  // Cat Link: يتم إنشاؤه دائماً بناءً على CURRENT_CATEGORY المختار
  const catUrl = (CURRENT_CATEGORY === "ALL") ? "" : `${base}${CUSTOMER_PAGE}?cat=${encodeURIComponent(CURRENT_CATEGORY)}&lang=${LANG}&wa=${WA_AGENT_FIXED}`;
  document.getElementById("catLink").value = catUrl;

  // Bundle Link: يتم إنشاؤه فقط إذا كان هناك منتجات في SELECTED
  const ids = [];
  SELECTED.forEach((qty, id) => { for(let i=0; i<qty; i++) ids.push(id); });
  const bundleUrl = ids.length ? `${base}${BUNDLE_PAGE}?ids=${ids.join(",")}&lang=${LANG}&wa=${WA_AGENT_FIXED}` : "";
  document.getElementById("bundleLink").value = bundleUrl;
}

async function copyVal(id){
  const v = document.getElementById(id).value;
  if(!v) {
    const msg = (id === "catLink") ? T("اختر كاتيجوري أولاً", "בחר קטגוריה קודם") : T("أضف منتجات للسلة أولاً", "הוסף מוצרים לעגלה קודם");
    return showToast("تنبيه", msg);
  }
  await navigator.clipboard.writeText(v);
  showToast("تم ✅", T("تم نسخ الرابط بنجاح", "הקישור הועתק בהצלחה"));
}

document.getElementById("copyCatBtn").onclick = () => copyVal("catLink");
document.getElementById("copyBundleBtn").onclick = () => copyVal("bundleLink");
document.getElementById("openCatBtn").onclick = () => { const v = document.getElementById("catLink").value; if(v) window.open(v, "_blank"); else showToast("تنبيه", T("اختر كاتيجوري أولاً", "בחר קטגוריה קודם")); };
document.getElementById("openBundleBtn").onclick = () => { const v = document.getElementById("bundleLink").value; if(v) window.open(v, "_blank"); else showToast("تنبيه", T("أضف منتجات أولاً", "הוסף מוצרים קודם")); };
document.getElementById("search").oninput = applyFilters;
document.getElementById("langBtn").onclick = () => { LANG = LANG === "ar" ? "he" : "ar"; setTexts(); renderCategories(); applyFilters(); updateLinks(); };

setTexts();
loadRSS();
</script>
</body>
</html>
