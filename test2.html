<!DOCTYPE html>
<html lang="he">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width,initial-scale=1.0">
<title>MAD PARFUMEUR | Our Branches</title>

<link href="https://fonts.googleapis.com/css2?family=Cinzel:wght@700&family=Assistant:wght@400;700&display=swap" rel="stylesheet">
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">

<style>
:root {
    --gold: #D4AF37;
    --gold-glow: rgba(212, 175, 55, 0.4);
    --black: #0a0a0a;
    --card-bg: #141414;
}

* { box-sizing: border-box; margin: 0; padding: 0; }
body { 
    background-color: var(--black); 
    color: #fff; 
    font-family: 'Assistant', sans-serif; 
    direction: rtl;
    opacity: 0; transition: opacity 0.5s;
}

/* Header */
header {
    text-align: center;
    padding: 50px 20px;
    background: linear-gradient(to bottom, #1a1a1a, #0a0a0a);
    border-bottom: 1px solid #333;
}
.logo-img { max-width: 180px; margin-bottom: 20px; }
.main-title { font-family: 'Cinzel'; color: var(--gold); font-size: 1.8rem; margin-bottom: 10px; }

/* Search Box */
.search-container { max-width: 500px; margin: -25px auto 30px; padding: 0 20px; }
.search-box {
    width: 100%; padding: 15px 25px; border-radius: 50px;
    background: #1a1a1a; border: 1px solid var(--gold);
    color: #fff; outline: none; box-shadow: 0 10px 20px rgba(0,0,0,0.5);
}

/* Branches List */
.branches-container { max-width: 800px; margin: 0 auto; padding: 20px; }
.branch-card {
    background: var(--card-bg);
    border: 1px solid #333;
    border-radius: 20px;
    margin-bottom: 20px;
    padding: 20px;
    display: flex;
    justify-content: space-between;
    align-items: center;
    text-decoration: none;
    color: inherit;
    transition: 0.3s;
    position: relative;
    overflow: hidden;
}
.branch-card:hover { 
    border-color: var(--gold); 
    box-shadow: 0 0 15px var(--gold-glow);
    transform: translateY(-3px);
}

.br-info-side { display: flex; flex-direction: column; gap: 5px; }
.br-name { font-family: 'Cinzel'; font-size: 1.3rem; color: var(--gold); }
.br-meta { font-size: 0.85rem; opacity: 0.7; display: flex; gap: 15px; }
.status-pill { font-size: 0.75rem; padding: 4px 12px; border-radius: 20px; border: 1px solid; width: fit-content; margin-top: 5px; }
.open { color: #25D366; border-color: #25D366; }
.closed { color: #ff4d4d; border-color: #ff4d4d; }

.dist-tag { font-size: 0.75rem; color: var(--gold); font-weight: 700; margin-bottom: 5px; display: block; }

.arrow-side { color: var(--gold); font-size: 1.5rem; padding-left: 10px; }

/* Loader */
#loader { text-align: center; padding: 50px; color: var(--gold); }
</style>
</head>
<body>

<header>
    <img src="logo.png" alt="MAD" class="logo-img">
    <h1 class="main-title" id="title-text">MAD PARFUMEUR</h1>
    <p id="sub-text" style="opacity: 0.6;"></p>
</header>

<div class="search-container">
    <input type="text" id="searchInput" class="search-box">
</div>

<div id="loader"><i class="fas fa-spinner fa-spin"></i></div>

<main id="branches-list" class="branches-container"></main>

<script>
const lang = navigator.language.startsWith('ar') ? 'ar' : 'he';
const TXT = {
    ar: { title: "فروعنا", sub: "اختر الفرع الأقرب إليك", search: "ابحث عن فرع أو مدينة...", open: "مفتوح الآن", closed: "مغلق حالياً", km: "كم بعيد" },
    he: { title: "הסניפים שלנו", sub: "בחרו את הסניף הקרוב אליכם", search: "חפש סניף או עיר...", open: "פתוח עכשיו", closed: "סגור כעת", km: 'ק"מ ממך' }
};

let allBranches = [];

/** 1. جلب البيانات **/
async function init() {
    document.getElementById('title-text').textContent = TXT[lang].title;
    document.getElementById('sub-text').textContent = TXT[lang].sub;
    document.getElementById('searchInput').placeholder = TXT[lang].search;

    try {
        const res = await fetch('test.json');
        const data = await res.json();
        allBranches = data.branches;

        // فلترة النسخة العبرية
        let list = (lang === 'he') ? allBranches.filter(b => b.is_west_bank !== true) : allBranches;

        // محاولة ترتيب الموقع في الخلفية
        navigator.geolocation.getCurrentPosition(pos => {
            const uLat = pos.coords.latitude;
            const uLng = pos.coords.longitude;
            list.forEach(b => {
                if(b.lat && b.lng) b.dist = calcDist(uLat, uLng, b.lat, b.lng);
                else b.dist = Infinity;
            });
            list.sort((a, b) => a.dist - b.dist);
            render(list);
        }, () => render(list)); // إذا رفض الموقع نعرض بالترتيب العادي

        document.getElementById('loader').style.display = 'none';
        document.body.style.opacity = "1";
    } catch (e) { console.error(e); }
}

/** 2. حساب المسافة **/
function calcDist(lat1, lon1, lat2, lon2) {
    const R = 6371;
    const dLat = (lat2 - lat1) * Math.PI / 180;
    const dLon = (lon2 - lon1) * Math.PI / 180;
    const a = Math.sin(dLat/2) * Math.sin(dLat/2) +
              Math.cos(lat1 * Math.PI / 180) * Math.cos(lat2 * Math.PI / 180) * Math.sin(dLon/2) * Math.sin(dLon/2);
    return R * 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1-a));
}

/** 3. فحص حالة الفرع **/
function checkOpen(b) {
    const now = new Date();
    const days = ['sun','mon','tue','wed','thu','fri','sat'];
    const today = days[now.getDay()];
    const mins = now.getHours() * 60 + now.getMinutes();
    return b.schedule[today]?.some(r => {
        const s = r[0].split(':'), e = r[1].split(':');
        return mins >= (+s[0]*60 + +s[1]) && mins < (+e[0]*60 + +e[1]);
    });
}

/** 4. عرض القائمة **/
function render(list) {
    const container = document.getElementById('branches-list');
    container.innerHTML = '';

    list.forEach(b => {
        const isOpen = checkOpen(b);
        const card = document.createElement('a');
        card.className = 'branch-card';
        card.href = `branch.html?branch=${b.id}`; // توجيه لصفحة "جاهز"

        card.innerHTML = `
            <div class="br-info-side">
                ${b.dist && b.dist !== Infinity ? `<span class="dist-tag">${b.dist.toFixed(1)} ${TXT[lang].km}</span>` : ''}
                <div class="br-name">${b[`name_${lang}`]}</div>
                <div class="br-meta">
                    <span><i class="fas fa-map-marker-alt"></i> ${b.city || ''}</span>
                </div>
                <div class="status-pill ${isOpen ? 'open' : 'closed'}">
                    ${isOpen ? TXT[lang].open : TXT[lang].closed}
                </div>
            </div>
            <div class="arrow-side">
                <i class="fas fa-chevron-left"></i>
            </div>
        `;
        container.appendChild(card);
    });
}

/** 5. البحث **/
document.getElementById('searchInput').addEventListener('input', e => {
    const term = e.target.value.toLowerCase();
    let filtered = allBranches.filter(b => 
        b.name_ar.toLowerCase().includes(term) || b.name_he.toLowerCase().includes(term)
    );
    if (lang === 'he') filtered = filtered.filter(b => b.is_west_bank !== true);
    render(filtered);
});

init();
</script>
</body>
</html>
