<!DOCTYPE html>
<html lang="he">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width,initial-scale=1.0">
<title>MAD PARFUMEUR | Our Branches</title>

<script>
!function(f,b,e,v,n,t,s){if(f.fbq)return;n=f.fbq=function(){
n.callMethod?n.callMethod.apply(n,arguments):n.queue.push(arguments)};
if(!f._fbq)f._fbq=n;n.push=n;n.loaded=!0;n.version='2.0';
n.queue=[];t=b.createElement(e);t.async=!0;
t.src=v;s=b.getElementsByTagName(e)[0];
s.parentNode.insertBefore(t,s)}(window, document,'script',
'https://connect.facebook.net/en_US/fbevents.js');
fbq('init','1072283127290819');
fbq('track','PageView');
</script>

<link href="https://fonts.googleapis.com/css2?family=Cairo:wght@400;700;900&display=swap" rel="stylesheet">
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">

<style>
:root{--bg:#0a0a0a;--card:#141414;--gold:#d4af37;--text:#fff;--muted:#aaa}
body{margin:0;background:var(--bg);color:var(--text);font-family:'Cairo',sans-serif; direction: rtl;}
header{
background:linear-gradient(rgba(0,0,0,.85),rgba(0,0,0,.85)),
url("https://madparfumeurglobal.com/wp-content/uploads/2025/10/1920x600-BERGAY.jpg") center/cover;
padding:40px 15px;text-align:center;border-bottom:3px solid var(--gold)}
.logo img{width:90px}
.brand-name{font-size:24px;font-weight:900;letter-spacing:2px; margin: 15px 0;}

.cs-wrapper{ display:flex; gap:15px; justify-content:center; flex-wrap:wrap; margin-top:20px; }
.cs-section{
width:160px; padding:15px; border:1px solid var(--gold); border-radius:15px;
background:rgba(212,175,55,.15); text-decoration:none; color:#fff; text-align:center; transition: 0.3s;
}
.cs-section:hover { background:rgba(212,175,55,.3); transform: translateY(-3px); }
.cs-num{ color:var(--gold); font-size:22px; font-weight:900; margin-top:6px; }

.container{max-width:800px;margin:auto;padding:20px 15px}
.branch-card{
background:var(--card); border-radius:15px; padding:20px; margin-bottom:20px;
border-right:4px solid var(--gold); display: flex; flex-direction: column;
}
.branch-info h3{margin:0;color:var(--gold);font-size:22px}
.branch-btns{ display:grid; grid-template-columns:repeat(3,1fr); gap:12px; margin-top:15px }
.btn{
padding:12px 5px; border-radius:10px; font-size:13px; font-weight:800;
display:flex; flex-direction:column; align-items:center; gap:5px; text-decoration:none; color:#fff; transition: 0.3s;
}
.btn:hover { opacity: 0.8; transform: scale(1.02); }
.bg-wa{background:#25D366}
.bg-waze{background:#33CCFF;color:#000}
.bg-store{background:#333}

.status-dot{ width:12px; height:12px; border-radius:50%; display:inline-block; margin-left:6px }
.distance-tag{ font-size:12px; color:var(--gold); margin-top:4px; font-weight: bold; }
</style>
</head>

<body>

<header>
  <div class="logo">
    <img src="https://abomkdad.github.io/Digital-Business-Card/logo.png">
  </div>

  <h1 class="brand-name">MAD PARFUMEUR ISRAEL</h1>

  <div class="cs-wrapper">
    <a href="tel:*9935" class="cs-section" onclick="trackLead('Call_CS')">
      <div id="cs-text">خدمة الزبائن</div>
      <div style="font-size:11px;opacity:.85">שירות לקוחות</div>
      <div class="cs-num">*9935</div>
    </a>

    <a id="online-btn" href="#" class="cs-section" onclick="trackLead('Online_Order')">
      <div>
        <span id="order-text" style="display:block">الطلب عبر الأونلاين</span>
        <span style="display:block;font-size:11px;opacity:.85">הזמנה אונליין</span>
      </div>
      <div class="cs-num"><i class="fa-solid fa-cart-shopping"></i></div>
    </a>
  </div>
</header>

<div class="container">
  <div id="branchesList" style="text-align:center;color:var(--muted)">
    جاري تحميل الفروع...
  </div>
</div>

<script>
/* ================== CONFIG & DATA ================== */
const deviceLang = navigator.language.startsWith("he") ? "he" : "ar";
document.body.dir = deviceLang === "ar" ? "rtl" : "ltr";

const onlineStoreUrl = deviceLang === "he" ? "https://madperfume.co.il" : "https://madperfume.ps";
document.getElementById('online-btn').href = onlineStoreUrl;

const t = {
    ar: { open: "مفتوح الآن", closed: "مغلق", wa: "واتساب", waze: "Waze", page: "عرض", loading: "جاري تحميل الفروع...", km: "كم بعيد" },
    he: { open: "פתוח עכשיו", closed: "סגור", wa: "וואטסאפ", waze: "ניווט", page: "דף סניף", loading: "טוען סניפים...", km: 'ק"מ ממך' }
}[deviceLang];

let allBranches = [];

function trackLead(action) {
    if(window.fbq) fbq('track', 'Lead', { action: action });
}

/* ================== GEO LOGIC ================== */
function calcDist(lat1, lon1, lat2, lon2) {
    const R = 6371;
    const dLat = (lat2 - lat1) * Math.PI / 180;
    const dLon = (lon2 - lon1) * Math.PI / 180;
    const a = Math.sin(dLat/2) * Math.sin(dLat/2) +
              Math.cos(lat1 * Math.PI / 180) * Math.cos(lat2 * Math.PI / 180) * Math.sin(dLon/2) * Math.sin(dLon/2);
    return R * 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1-a));
}

/* ================== CORE START ================== */
async function loadBranches() {
    try {
        const res = await fetch('test.json');
        const data = await res.json();
        allBranches = data.branches;

        // فلترة النسخة العبرية (إخفاء الضفة)
        let list = (deviceLang === "he") ? allBranches.filter(b => b.is_west_bank !== true) : allBranches;

        // العرض الأولي
        render(list);

        // محاولة ترتيب الموقع
        navigator.geolocation.getCurrentPosition(pos => {
            const uLat = pos.coords.latitude;
            const uLng = pos.coords.longitude;
            list.forEach(b => {
                if(b.lat && b.lng) b.dist = calcDist(uLat, uLng, b.lat, b.lng);
                else b.dist = Infinity;
            });
            list.sort((a, b) => a.dist - b.dist);
            render(list);
        });
    } catch (e) { console.error(e); }
}

function checkOpen(b) {
    const now = new Date();
    const days = ['sun','mon','tue','wed','thu','fri','sat'];
    const today = days[now.getDay()];
    const mins = now.getHours() * 60 + now.getMinutes();
    return b.schedule[today]?.some(r => {
        const s = r[0].split(':'), e = r[1].split(':');
        return mins >= (+s[0]*60 + +s[1]) && mins < (+e[0]*60 + +e[1]);
    });
}

function render(list) {
    const container = document.getElementById('branchesList');
    container.innerHTML = '';

    list.forEach(b => {
        const isOpen = checkOpen(b);
        const card = document.createElement('div');
        card.className = 'branch-card';
        
        card.innerHTML = `
            <div class="branch-info">
                <h3>${b[`name_${deviceLang}`]}</h3>
                <div style="font-size:14px; margin-top:5px;">
                    <span class="status-dot" style="background:${isOpen?'#25D366':'#ff4d4d'}"></span>
                    ${isOpen ? t.open : t.closed}
                    ${b.dist && b.dist !== Infinity ? `<span class="distance-tag"> | ${b.dist.toFixed(1)} ${t.km}</span>` : ''}
                </div>
            </div>
            <div class="branch-btns">
                <a href="https://wa.me/${b.phone}" class="btn bg-wa" onclick="trackLead('WA_Click')">
                    <i class="fa-brands fa-whatsapp"></i> ${t.wa}
                </a>
                <a href="https://waze.com/ul?ll=${b.lat},${b.lng}&navigate=yes" class="btn bg-waze" onclick="trackLead('Waze_Click')">
                    <i class="fa-brands fa-waze"></i> ${t.waze}
                </a>
                <a href="branch.html?branch=${b.id}" class="btn bg-store" onclick="trackLead('Page_Click')">
                    <i class="fa-solid fa-store"></i> ${t.page}
                </a>
            </div>
        `;
        container.appendChild(card);
    });
}

loadBranches();
</script>
</body>
</html>
