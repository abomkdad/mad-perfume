<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
  <meta charset="UTF-8">
  <title>MAD Parfumeur | Ø§Ù„ÙØ±ÙˆØ¹</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0">

  <!-- Leaflet -->
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css">
  <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>

  <!-- Font Awesome -->
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css">

  <style>
    body {
      margin: 0;
      font-family: system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI", sans-serif;
      background: #f4f6fb;
      color: #111;
    }

    header {
      background: #fff;
      padding: 12px 20px;
      display: flex;
      justify-content: space-between;
      align-items: center;
      box-shadow: 0 2px 10px rgba(0,0,0,0.1);
      position: sticky;
      top: 0;
      z-index: 10;
    }

    header img {
      height: 42px;
    }

    #map {
      height: 320px;
      margin: 16px;
      border-radius: 20px;
      overflow: hidden;
    }

    .container {
      max-width: 600px;
      margin: auto;
      padding: 16px;
    }

    .branch {
      background: #fff;
      border-radius: 20px;
      padding: 20px;
      margin-bottom: 16px;
      box-shadow: 0 6px 20px rgba(0,0,0,0.05);
      text-align: center;
    }

    .status.open {
      color: #22c55e;
      font-weight: bold;
      margin-bottom: 6px;
    }

    .status.closed {
      color: #ef4444;
      font-weight: bold;
      margin-bottom: 6px;
    }

    .nearest {
      color: #22c55e;
      font-weight: bold;
      margin-bottom: 6px;
    }

    .distance {
      color: #666;
      font-weight: 600;
      margin-top: 4px;
    }

    .actions {
      display: flex;
      justify-content: center;
      gap: 14px;
      margin-top: 14px;
      font-size: 20px;
    }

    .actions a {
      transition: 0.2s ease;
    }

    .actions a:hover {
      transform: scale(1.25);
    }

    .phone { color: #1d3a8a; }
    .waze { color: #1d3a8a; }
    .whatsapp { color: #25D366; }
    .instagram { color: #E1306C; }
    .tiktok { color: #000; }
    .facebook { color: #1877F2; }
  </style>
</head>

<body>

<header>
  <img src="logo.png" alt="MAD">
  <select id="lang" onchange="renderBranches()">
    <option value="ar">Ø§Ù„Ø¹Ø±Ø¨ÙŠØ©</option>
    <option value="he">×¢×‘×¨×™×ª</option>
  </select>
</header>

<div id="map"></div>
<div class="container" id="branches"></div>

<script>
/* ===================== DATA ===================== */
let branches = [];
let user = null;
let map;

/* ===================== UTILS ===================== */
function distance(lat1, lng1, lat2, lng2) {
  const R = 6371;
  const dLat = (lat2 - lat1) * Math.PI / 180;
  const dLng = (lng2 - lng1) * Math.PI / 180;
  const a =
    Math.sin(dLat / 2) ** 2 +
    Math.cos(lat1 * Math.PI / 180) *
    Math.cos(lat2 * Math.PI / 180) *
    Math.sin(dLng / 2) ** 2;
  return R * (2 * Math.atan2(Math.sqrt(a), Math.sqrt(1 - a)));
}

function isOpenNow() {
  const h = new Date().getHours();
  return h >= 10 && h < 22;
}

/* ===================== LOAD ===================== */
async function load() {
  branches = await fetch('branches.json').then(r => r.json());
  initMap();
  renderBranches();
}

/* ===================== MAP ===================== */
function initMap() {
  map = L.map('map').setView([32.1, 34.8], 9);

  L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
    attribution: 'Â© OpenStreetMap'
  }).addTo(map);

  navigator.geolocation.getCurrentPosition(
    p => {
      user = { lat: p.coords.latitude, lng: p.coords.longitude };
      L.marker([user.lat, user.lng]).addTo(map).bindPopup('ğŸ“ Ù…ÙˆÙ‚Ø¹Ùƒ');
      drawMarkers();
      renderBranches();
    },
    () => {
      drawMarkers();
      renderBranches();
    },
    { enableHighAccuracy: true }
  );
}

function drawMarkers() {
  const lang = document.getElementById('lang').value;

  let nearest = null;
  let min = Infinity;

  if (user) {
    branches.forEach(b => {
      if (!isOpenNow()) return;
      const d = distance(user.lat, user.lng, b.lat, b.lng);
      if (d < min) {
        min = d;
        nearest = b;
      }
    });
  }

  branches.forEach(b => {
    const open = isOpenNow();
    const marker = L.marker([b.lat, b.lng]).addTo(map)
      .bindPopup(`
        <strong>${lang === 'ar' ? b.name_ar : b.name_he}</strong><br>
        ${open ? 'ğŸŸ¢ Ù…ÙØªÙˆØ­ Ø§Ù„Ø¢Ù†' : 'ğŸ”´ Ù…ØºÙ„Ù‚'}<br>
        ${user ? `ğŸ“ ÙŠØ¨Ø¹Ø¯ ${distance(user.lat, user.lng, b.lat, b.lng).toFixed(1)} ÙƒÙ…<br>` : ''}
        <br>
        ${b.waze_maps ? `<a href="${b.waze_maps}" target="_blank">ğŸ§­ Waze</a><br>` : ''}
        ${b.phone ? `<a href="tel:${b.phone}">ğŸ“ Ø§ØªØµØ§Ù„</a>` : ''}
      `);

    if (nearest && b.id === nearest.id) {
      marker.openPopup();
      map.setView([b.lat, b.lng], 13);
    }
  });
}

/* ===================== RENDER LIST ===================== */
function renderBranches() {
  const box = document.getElementById('branches');
  const lang = document.getElementById('lang').value;
  box.innerHTML = '';

  let sorted = [...branches];

  if (user) {
    sorted.forEach(b => {
      b._distance = distance(user.lat, user.lng, b.lat, b.lng);
    });

    sorted.sort((a, b) => a._distance - b._distance);
  }

  let nearestId = null;
  if (user) {
    for (let b of sorted) {
      if (isOpenNow()) {
        nearestId = b.id;
        break;
      }
    }
  }

  sorted.forEach(b => {
    const open = isOpenNow();

    box.innerHTML += `
      <div class="branch">
        ${b.id === nearestId ? `<div class="nearest">ğŸ“ Ø£Ù‚Ø±Ø¨ ÙØ±Ø¹ Ù„Ùƒ</div>` : ``}

        <div class="status ${open ? 'open' : 'closed'}">
          ${open ? 'ğŸŸ¢ Ù…ÙØªÙˆØ­ Ø§Ù„Ø¢Ù†' : 'ğŸ”´ Ù…ØºÙ„Ù‚ Ø§Ù„Ø¢Ù†'}
        </div>

        <h2>${lang === 'ar' ? b.name_ar : b.name_he}</h2>

        ${user ? `<div class="distance">ğŸ“ ÙŠØ¨Ø¹Ø¯ ${b._distance.toFixed(1)} ÙƒÙ…</div>` : ``}

        <div class="actions">
          ${b.phone ? `<a class="phone" href="tel:${b.phone}"><i class="fas fa-phone"></i></a>` : ``}
          ${b.waze_maps ? `<a class="waze" target="_blank" href="${b.waze_maps}"><i class="fas fa-location-arrow"></i></a>` : ``}
          ${b.whatsapp ? `<a class="whatsapp" target="_blank" href="https://wa.me/${b.whatsapp}"><i class="fab fa-whatsapp"></i></a>` : ``}
          ${b.social?.instagram ? `<a class="instagram" target="_blank" href="${b.social.instagram}"><i class="fab fa-instagram"></i></a>` : ``}
          ${b.social?.tiktok ? `<a class="tiktok" target="_blank" href="${b.social.tiktok}"><i class="fab fa-tiktok"></i></a>` : ``}
          ${b.social?.facebook ? `<a class="facebook" target="_blank" href="${b.social.facebook}"><i class="fab fa-facebook-f"></i></a>` : ``}
        </div>
      </div>
    `;
  });
}

load();
</script>

</body>
</html>
