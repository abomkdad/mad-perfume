<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
<meta charset="UTF-8">
<title>MAD Parfumeur | Ø§Ù„ÙØ±ÙˆØ¹</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0">

<link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css">
<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>

<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css">

<style>
body{margin:0;font-family:system-ui;background:#f4f6fb}
header{background:#fff;padding:12px 20px;display:flex;justify-content:space-between;align-items:center;box-shadow:0 2px 10px rgba(0,0,0,.1)}
header img{height:40px}

#map{height:300px;margin:16px;border-radius:20px}

.filters{
display:flex;gap:12px;justify-content:center;margin:10px 0
}
.filters label{
background:#fff;padding:8px 14px;border-radius:999px;
box-shadow:0 4px 12px rgba(0,0,0,.06);
font-size:14px;cursor:pointer
}

.container{max-width:600px;margin:auto;padding:16px}

.branch{
background:#fff;border-radius:22px;padding:22px;
margin-bottom:18px;text-align:center;
box-shadow:0 10px 30px rgba(0,0,0,.06)
}

.nearest{background:#ecfdf5;color:#16a34a;
display:inline-block;padding:6px 12px;
border-radius:999px;font-weight:600;margin-bottom:6px}

.open{color:#16a34a;font-weight:600}
.closed{color:#dc2626;font-weight:600}

.distance{color:#6b7280;font-size:14px}

.actions{display:flex;justify-content:center;gap:18px;margin-top:14px}
.actions a{color:#64748b;font-size:20px;transition:.25s}
.actions a:hover{transform:scale(1.25)}
.actions a.whatsapp:hover{color:#25D366}
.actions a.phone:hover{color:#1d3a8a}

.branch-store-btn{
display:inline-block;margin-top:16px;
padding:12px 28px;border-radius:999px;
background:#1d3a8a;color:#fff;
text-decoration:none;font-weight:600
}
</style>
</head>

<body>

<header>
<img src="logo.png">
</header>

<div id="map"></div>

<div class="filters">
<label><input type="checkbox" id="onlyOpen"> Ù…ÙØªÙˆØ­ Ø§Ù„Ø¢Ù†</label>
<label><input type="checkbox" id="onlyNear"> Ø§Ù„Ø£Ù‚Ø±Ø¨ ÙÙ‚Ø·</label>
</div>

<div class="container" id="branches"></div>

<script>
let branches=[],user=null,map;

const greenIcon=L.icon({
iconUrl:"https://maps.gstatic.com/mapfiles/ms2/micons/green-dot.png",
iconSize:[40,40],iconAnchor:[20,40]
});
const grayIcon=L.icon({
iconUrl:"https://maps.gstatic.com/mapfiles/ms2/micons/blue-dot.png",
iconSize:[28,28],iconAnchor:[14,28]
});

function dist(a,b,c,d){
const R=6371;
const dLat=(c-a)*Math.PI/180;
const dLng=(d-b)*Math.PI/180;
const x=Math.sin(dLat/2)**2+
Math.cos(a*Math.PI/180)*Math.cos(c*Math.PI/180)*
Math.sin(dLng/2)**2;
return R*(2*Math.atan2(Math.sqrt(x),Math.sqrt(1-x)));
}

function isOpen(){const h=new Date().getHours();return h>=10&&h<22}

async function load(){
branches=await fetch("branches.json").then(r=>r.json());
initMap();render();
}

function initMap(){
map=L.map("map").setView([32.1,34.8],9);
L.tileLayer("https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png").addTo(map);

navigator.geolocation.getCurrentPosition(p=>{
user={lat:p.coords.latitude,lng:p.coords.longitude};
L.marker([user.lat,user.lng]).addTo(map).bindPopup("Ù…ÙˆÙ‚Ø¹Ùƒ");
drawMarkers();
render();
},()=>{drawMarkers();render()});
}

function drawMarkers(){
let nearest=null,min=Infinity;
if(user){
branches.forEach(b=>{
const d=dist(user.lat,user.lng,b.lat,b.lng);
if(d<min&&isOpen()){min=d;nearest=b}
});
}
branches.forEach(b=>{
const d=user?dist(user.lat,user.lng,b.lat,b.lng):0;
L.marker([b.lat,b.lng],{
icon:(nearest&&b.id===nearest.id)?greenIcon:grayIcon
}).addTo(map);
});
}

function render(){
const box=document.getElementById("branches");
box.innerHTML="";
let arr=[...branches];

if(user){
arr.forEach(b=>b._d=dist(user.lat,user.lng,b.lat,b.lng));
arr.sort((a,b)=>a._d-b._d);
}

if(document.getElementById("onlyOpen").checked)
arr=arr.filter(()=>isOpen());

if(document.getElementById("onlyNear").checked&&arr[0])
arr=[arr[0]];

arr.forEach((b,i)=>{
box.innerHTML+=`
<div class="branch">
${i===0&&user?'<div class="nearest">ğŸ“ Ø£Ù‚Ø±Ø¨ ÙØ±Ø¹ Ù„Ùƒ</div>':''}
<div class="${isOpen()?'open':'closed'}">
${isOpen()?'Ù…ÙØªÙˆØ­ Ø§Ù„Ø¢Ù†':'Ù…ØºÙ„Ù‚'}
</div>
<h2>${b.name_ar}</h2>
${user?`<div class="distance">ÙŠØ¨Ø¹Ø¯ ${b._d.toFixed(1)} ÙƒÙ…</div>`:''}

<div class="actions">
<a class="phone" href="tel:${b.phone}"><i class="fas fa-phone"></i></a>
<a class="whatsapp" href="https://wa.me/${b.whatsapp}?text=${encodeURIComponent('Ù…Ø±Ø­Ø¨Ø§ØŒ Ø£ÙˆØ¯ Ø§Ù„Ø·Ù„Ø¨ Ù…Ù† ÙØ±Ø¹ '+b.name_ar)}"><i class="fab fa-whatsapp"></i></a>
</div>

<a class="branch-store-btn" href="store.html?id=${b.id}">
Ø¯Ø®ÙˆÙ„ Ù…ØªØ¬Ø± Ø§Ù„ÙØ±Ø¹
</a>
</div>`;
});
}

document.getElementById("onlyOpen").onchange=render;
document.getElementById("onlyNear").onchange=render;

load();
</script>

</body>
</html>
